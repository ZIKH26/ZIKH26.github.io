<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-bounce.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"zikh26.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.17.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"default"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":"ture","trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="å‰è¨€å‰å‡ å¤©åœ¨çœ‹é›ªä¸Šè¯»äº†ä¸€ç¯‡å…³äº C++å¼‚å¸¸å¤„ç† çš„æ–‡ç« ï¼Œå†™çš„é€šä¿—æ˜“æ‡‚ï¼Œæ–‡ç« å¼€å§‹é€šè¿‡ demo ä»‹ç»äº† try-catch å¼‚å¸¸å¤„ç†æœºåˆ¶ç»•è¿‡ canary æ£€æŸ¥ã€‚é—²æ¥æ— äº‹ä¹Ÿè·Ÿç€ demo åšäº†ä¸€ä¸‹ï¼Œå‘ç°ä½œè€…åœ¨åŸæ–‡ä¸­å†™åˆ°ï¼š  è¿™é‡Œå°†è¿”å›åœ°å€å¡«å……æˆäº† backdoor() å‡½æ•°é‡Œ try ä»£ç å—é‡Œçš„åœ°å€ï¼Œå®ƒæ˜¯ä¸€ä¸ªèŒƒå›´ï¼Œç»æµ‹è¯•èƒ½å¤ŸæˆåŠŸåˆ©ç”¨çš„æ˜¯ä¸€ä¸ªå·¦å¼€å³ä¸ç¡®å®šçš„åŒºé—´ï¼ˆxï¼‰  çœ‹åˆ°è¿™é‡Œæˆ‘ä¸ç¦ç–‘æƒ‘ï¼Œè¿™ç§ç®€å•çš„åˆ©">
<meta property="og:type" content="article">
<meta property="og:title" content="C++å¼‚å¸¸å¤„ç†éƒ¨åˆ†æºç åˆ†æ&amp;&amp;é—®é¢˜æ¢ç©¶">
<meta property="og:url" content="https://zikh26.github.io/posts/f9d998fc.html">
<meta property="og:site_name" content="ZIKH26&#39;s Blog">
<meta property="og:description" content="å‰è¨€å‰å‡ å¤©åœ¨çœ‹é›ªä¸Šè¯»äº†ä¸€ç¯‡å…³äº C++å¼‚å¸¸å¤„ç† çš„æ–‡ç« ï¼Œå†™çš„é€šä¿—æ˜“æ‡‚ï¼Œæ–‡ç« å¼€å§‹é€šè¿‡ demo ä»‹ç»äº† try-catch å¼‚å¸¸å¤„ç†æœºåˆ¶ç»•è¿‡ canary æ£€æŸ¥ã€‚é—²æ¥æ— äº‹ä¹Ÿè·Ÿç€ demo åšäº†ä¸€ä¸‹ï¼Œå‘ç°ä½œè€…åœ¨åŸæ–‡ä¸­å†™åˆ°ï¼š  è¿™é‡Œå°†è¿”å›åœ°å€å¡«å……æˆäº† backdoor() å‡½æ•°é‡Œ try ä»£ç å—é‡Œçš„åœ°å€ï¼Œå®ƒæ˜¯ä¸€ä¸ªèŒƒå›´ï¼Œç»æµ‹è¯•èƒ½å¤ŸæˆåŠŸåˆ©ç”¨çš„æ˜¯ä¸€ä¸ªå·¦å¼€å³ä¸ç¡®å®šçš„åŒºé—´ï¼ˆxï¼‰  çœ‹åˆ°è¿™é‡Œæˆ‘ä¸ç¦ç–‘æƒ‘ï¼Œè¿™ç§ç®€å•çš„åˆ©">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20241221212224504.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20241221212329979.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20241221211125729.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/f444319343cd4d76.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/9de1d147182077b9.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/c2261b0c4fab4c5a.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/c596a07d5726dea4.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/9de1d147182077b9.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20250111230517427.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20250111231122844.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20250111231200125.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20250111222742873.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20250116235734353.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20250117005351063.png">
<meta property="og:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20250117010809051.png">
<meta property="article:published_time" content="2025-01-20T07:04:09.579Z">
<meta property="article:modified_time" content="2025-01-20T08:42:15.608Z">
<meta property="article:author" content="ZIKH26">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="æºç è°ƒè¯•&amp;&amp;åˆ†æ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20241221212224504.png">


<link rel="canonical" href="https://zikh26.github.io/posts/f9d998fc.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://zikh26.github.io/posts/f9d998fc.html","path":"posts/f9d998fc.html","title":"C++å¼‚å¸¸å¤„ç†éƒ¨åˆ†æºç åˆ†æ&&é—®é¢˜æ¢ç©¶"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>C++å¼‚å¸¸å¤„ç†éƒ¨åˆ†æºç åˆ†æ&&é—®é¢˜æ¢ç©¶ | ZIKH26's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">ZIKH26's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a></li><li class="menu-item menu-item-å‹é“¾"><a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>å‹é“¾</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8C%BA%E9%97%B4%E9%97%AE%E9%A2%98%E6%8E%A2%E7%A9%B6"><span class="nav-number">2.</span> <span class="nav-text">åŒºé—´é—®é¢˜æ¢ç©¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A2%E7%B4%A2%E5%8C%BA%E9%97%B4"><span class="nav-number">2.1.</span> <span class="nav-text">æ¢ç´¢åŒºé—´</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%84%8F%E5%A4%96%E4%BA%A7%E7%94%9F%E6%96%B0%E7%9A%84%E5%8C%BA%E9%97%B4"><span class="nav-number">2.2.</span> <span class="nav-text">æ„å¤–äº§ç”Ÿæ–°çš„åŒºé—´</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E6%AD%A5%E5%88%86%E6%9E%90%E7%9A%84%E6%80%BB%E7%BB%93"><span class="nav-number">2.3.</span> <span class="nav-text">åˆæ­¥åˆ†æçš„æ€»ç»“</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%A0%88%E5%B1%95%E5%BC%80%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">3.</span> <span class="nav-text">C++å¼‚å¸¸å¤„ç†æ ˆå±•å¼€æºç åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Phase-1"><span class="nav-number">3.1.</span> <span class="nav-text">Phase 1</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#uw-update-context%E5%87%BD%E6%95%B0"><span class="nav-number">3.1.1.</span> <span class="nav-text">uw_update_contextå‡½æ•°</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#uw-frame-state-for%E5%87%BD%E6%95%B0"><span class="nav-number">3.1.2.</span> <span class="nav-text">uw_frame_state_forå‡½æ•°</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E6%9E%90-gcc-except-table%E4%B8%AD%E6%95%B0%E6%8D%AE"><span class="nav-number">3.1.3.</span> <span class="nav-text">è§£æ.gcc_except_tableä¸­æ•°æ®</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Phase-2"><span class="nav-number">3.2.</span> <span class="nav-text">Phase 2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%B6%E9%9B%B6%E6%95%A3%E6%95%A3%E7%9A%84%E8%A1%A5%E5%85%85"><span class="nav-number">3.3.</span> <span class="nav-text">é›¶é›¶æ•£æ•£çš„è¡¥å……</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#LSDA-CIE-FDE%E5%82%BB%E5%82%BB%E5%88%86%E4%B8%8D%E6%B8%85"><span class="nav-number">3.3.1.</span> <span class="nav-text">LSDA CIE FDEå‚»å‚»åˆ†ä¸æ¸…</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#current%E5%92%8Cfs%E7%BB%93%E6%9E%84%E4%BD%93%E5%88%86%E6%9E%90%E5%8F%8A%E5%81%8F%E7%A7%BB%E9%87%8F%E8%A1%A8%E6%A0%BC"><span class="nav-number">3.3.2.</span> <span class="nav-text">currentå’Œfsç»“æ„ä½“åˆ†æåŠåç§»é‡è¡¨æ ¼</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%BE%E5%A3%B0"><span class="nav-number">4.</span> <span class="nav-text">å°¾å£°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="nav-number">5.</span> <span class="nav-text">å‚è€ƒæ–‡ç« </span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ZIKH26"
      src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202307011626843.jpg">
  <p class="site-author-name" itemprop="name">ZIKH26</p>
  <div class="site-description" itemprop="description">äººç”Ÿå¦‚æˆ</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">118</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">117</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="è¿”å›é¡¶éƒ¨">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zikh26.github.io/posts/f9d998fc.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202307011626843.jpg">
      <meta itemprop="name" content="ZIKH26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZIKH26's Blog">
      <meta itemprop="description" content="äººç”Ÿå¦‚æˆ">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="C++å¼‚å¸¸å¤„ç†éƒ¨åˆ†æºç åˆ†æ&&é—®é¢˜æ¢ç©¶ | ZIKH26's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          C++å¼‚å¸¸å¤„ç†éƒ¨åˆ†æºç åˆ†æ&&é—®é¢˜æ¢ç©¶
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>
      

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-01-20 15:04:09 / ä¿®æ”¹æ—¶é—´ï¼š16:42:15" itemprop="dateCreated datePublished" datetime="2025-01-20T15:04:09+08:00">2025-01-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" itemprop="url" rel="index"><span itemprop="name">å­¦ä¹ æ€»ç»“</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/%E6%8E%A2%E7%A9%B6/" itemprop="url" rel="index"><span itemprop="name">æ¢ç©¶</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/%E6%8E%A2%E7%A9%B6/%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95-%E5%88%86%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">æºç è°ƒè¯•&&åˆ†æ</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å‰å‡ å¤©åœ¨çœ‹é›ªä¸Šè¯»äº†ä¸€ç¯‡å…³äº <strong>C++å¼‚å¸¸å¤„ç†</strong> çš„<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-284745.htm#msg_header_h3_7">æ–‡ç« </a>ï¼Œå†™çš„é€šä¿—æ˜“æ‡‚ï¼Œæ–‡ç« å¼€å§‹é€šè¿‡ demo ä»‹ç»äº† try-catch å¼‚å¸¸å¤„ç†æœºåˆ¶ç»•è¿‡ canary æ£€æŸ¥ã€‚é—²æ¥æ— äº‹ä¹Ÿè·Ÿç€ demo åšäº†ä¸€ä¸‹ï¼Œå‘ç°ä½œè€…åœ¨åŸæ–‡ä¸­å†™åˆ°ï¼š</p>
<blockquote>
<p>è¿™é‡Œå°†è¿”å›åœ°å€å¡«å……æˆäº† <code>backdoor()</code> å‡½æ•°é‡Œ <strong>try ä»£ç å—</strong>é‡Œçš„åœ°å€ï¼Œå®ƒæ˜¯ä¸€ä¸ªèŒƒå›´ï¼Œç»æµ‹è¯•èƒ½å¤ŸæˆåŠŸåˆ©ç”¨çš„æ˜¯ä¸€ä¸ª<strong>å·¦å¼€</strong>å³ä¸ç¡®å®šçš„åŒºé—´ï¼ˆxï¼‰</p>
</blockquote>
<p>çœ‹åˆ°è¿™é‡Œæˆ‘ä¸ç¦ç–‘æƒ‘ï¼Œè¿™ç§ç®€å•çš„åˆ©ç”¨ä¸­ä¹Ÿä¼šå­˜åœ¨ <del>ç„å­¦</del> æ— æ³•ç¡®å®šçš„ä¸œè¥¿å—ï¼Ÿæˆ‘å¯¹è¿™ä¸ªå·¦å¼€å³ä¸ç¡®å®šåŒºé—´æ„Ÿåˆ°å¥½å¥‡ï¼Œæ‰“ç®—å»ç ”ç©¶ä¸€ä¸‹ï¼Œè¿™ä¸ªæˆåŠŸåˆ©ç”¨çš„åŒºé—´åˆ°åº•æ˜¯å¦‚ä½•æ¥çš„ã€‚</p>
<p>æœ¬æ–‡ä» <code>gcc</code> æºç å…¥æ‰‹ï¼Œå»æ¢ç©¶åŒºé—´é—®é¢˜ã€‚éšåè¿˜åˆ†æäº† <code>try-catch</code> å¼‚å¸¸å¤„ç†æœºåˆ¶ä¸­æºä»£ç æ˜¯å¦‚ä½•å®Œæˆ <strong>æ ˆå±•å¼€(Stack Unwinding)</strong> çš„<strong>ï¼ˆæœ¬æ–‡ä¸ºäº†é¿å…å‡ºç°è¿‡å¤šéå…³é”®ä»£ç ğŸ˜¶â€ğŸŒ«ï¸ï¼Œå› æ­¤åˆ å‡äº†ä¸€äº›ä»£ç ã€‚ä½†é˜…è¯»ä¸­æœ€å¥½åŒæ—¶å‚è€ƒ gcc æºç ï¼Œå¦åˆ™ç†è§£ä¸Šå¯èƒ½æœ‰ä¸€äº›éšœç¢ï¼‰</strong>ã€‚</p>
<span id="more"></span>

<h2 id="åŒºé—´é—®é¢˜æ¢ç©¶"><a href="#åŒºé—´é—®é¢˜æ¢ç©¶" class="headerlink" title="åŒºé—´é—®é¢˜æ¢ç©¶"></a>åŒºé—´é—®é¢˜æ¢ç©¶</h2><p>æœ¬æ–‡åˆ†æçš„ <code>gcc</code> æºç ç‰ˆæœ¬ä¸º <strong>11.4.0</strong> ï¼Œä¸‹è½½å‘½ä»¤ <code>wget https://ftp.gnu.org/gnu/gcc/gcc-11.4.0/gcc-11.4.0.tar.xz</code></p>
<p>æœ¬æ–‡ä»…ä»…æ˜¯åœ¨ <strong>ve1kcon</strong> å¸ˆå‚…å†™çš„ <a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-284745.htm#msg_header_h3_3">åˆ†äº«ä¸€æ¬¡ C++ PWN å‡ºé¢˜ç»å†â€”â€”æ·±å…¥ç ”ç©¶å¼‚å¸¸å¤„ç†æœºåˆ¶</a> æ–‡ç« ä¸­è¿›è¡Œäº†ç ”ç©¶ï¼Œæ‰€ä»¥ demo ä¹Ÿä¾ç„¶ä½¿ç”¨çš„æ˜¯æ–‡ç« é‡Œå¼€å§‹çš„ demoã€‚ï¼ˆé¿å…è°ƒè¯•çš„æ—¶å€™è¿›å‡½æ•°çš„å»¶è¿Ÿç»‘å®šï¼Œå¯ä»¥å†åŠ ç¼–è¯‘å‘½ä»¤ <code>-z now</code>ï¼‰ï¼Œç¼–è¯‘çš„ç¯å¢ƒæ˜¯ <code>Ubuntu22.04</code>  <strong>GCC</strong> ç‰ˆæœ¬<code>11.4.0</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// exception.cpp</span></span><br><span class="line"><span class="comment">// g++ exception.cpp -o exc -no-pie -fPIC</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">backdoor</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    try</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;We have never called this backdoor!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (<span class="type">const</span> <span class="type">char</span> *s)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[!] Backdoor has catched the exception: %s\n&quot;</span>, s);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">x</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">public:</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x10</span>];</span><br><span class="line">    x(<span class="type">void</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// printf(&quot;x:x() called!\n&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line">    ~x(<span class="type">void</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// printf(&quot;x:~x() called!\n&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">input</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    x tmp;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[!] enter your input:&quot;</span>);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    <span class="type">int</span> count = <span class="number">0x100</span>;</span><br><span class="line">    <span class="type">size_t</span> len = read(<span class="number">0</span>, tmp.buf, count);</span><br><span class="line">    <span class="keyword">if</span> (len &gt; <span class="number">0x10</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        throw <span class="string">&quot;Buffer overflow.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] input() return.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    try</span><br><span class="line">    &#123;</span><br><span class="line">        input();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;--------------------------------------\n&quot;</span>);</span><br><span class="line">        throw <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (<span class="type">int</span> x)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] Int: %d\n&quot;</span>, x);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (<span class="type">const</span> <span class="type">char</span> *s)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] String: %s\n&quot;</span>, s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] main() return.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>å¯¹äºve1kconå¸ˆå‚…æåˆ°çš„ <strong>ç¬¬äºŒç§åˆ©ç”¨æ–¹å¼</strong> ï¼Œæˆ‘ç¼–å†™äº† EXPå¦‚ä¸‹ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./demo&quot;</span>)</span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span>*<span class="number">0x30</span>+p64(<span class="number">0x404070</span>)+p64(<span class="number">0x401297</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>æ˜¾ç„¶ <code>0x401297</code> æ˜¯åŠ«æŒçš„è¿”å›åœ°å€ï¼Œè€Œ <code>0x404070</code> å¡«å……çš„æ˜¯ <code>rbp</code>ï¼ˆä»»æ„èƒ½å¤Ÿè§£å¼•ç”¨çš„æŒ‡é’ˆéƒ½å¯ä»¥ï¼‰ã€‚é€šè¿‡ä¸æ–­ä¿®æ”¹åŠ«æŒçš„è¿”å›åœ°å€ï¼Œèƒ½å¤Ÿå‘ç°èƒ½å¤Ÿæ­£å¸¸æ‰§è¡Œåé—¨å‡½æ•°çš„åœ°å€åŒºé—´ä¸º  [0x401293-0x401297]ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå¡«å……å…¶å®ƒåœ°å€éƒ½ä¼šæŠ¥é”™ <code>terminate called after throwing an instance of &#39;char const*&#39;</code>ã€‚å³ä½¿åœ¨è¿™ä¸ªè¿”å›åœ°å€çš„ä½ç½®å†™å…¥ä¸€ä¸ªéæ³•å†…å­˜åœ°å€ï¼Œç¨‹åºä¹Ÿå¹¶ä¸ä¼šå› æ­¤å‘ç”Ÿæ®µé”™è¯¯ã€‚å°½ç®¡ç°åœ¨é€šè¿‡æµ‹è¯•å¾—åˆ°äº†åŒºé—´ï¼Œä½†ä¸ºäº†ææ˜ç™½è¿™ä¸ªåŒºé—´å…·ä½“æ˜¯æ€ä¹ˆå¾—åˆ°çš„ï¼Œä¸‹é¢æ¥åˆ†ææºç ã€‚</p>
<h3 id="æ¢ç´¢åŒºé—´"><a href="#æ¢ç´¢åŒºé—´" class="headerlink" title="æ¢ç´¢åŒºé—´"></a>æ¢ç´¢åŒºé—´</h3><p>å…·ä½“é’ˆå¯¹åŒºé—´åšæ£€æŸ¥çš„å‡½æ•°æ˜¯ <code>__gxx_personality_v0</code> ï¼Œå®ƒä½äº <code>libstdc++-v3/libsupc++/eh_personality.cc</code> æ–‡ä»¶ã€‚ä¸‹é¢åˆ å‡äº†å¤§é‡ä»£ç ï¼Œåé¢è®¨è®ºæ ˆå±•å¼€è¿‡ç¨‹æ—¶ä¼šå†å…·ä½“åˆ†æã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PERSONALITY_FUNCTION	__gxx_personality_v0</span></span><br><span class="line">PERSONALITY_FUNCTION (<span class="type">int</span> version,</span><br><span class="line">		      _Unwind_Action actions,</span><br><span class="line">		      _Unwind_Exception_Class exception_class,</span><br><span class="line">		      <span class="keyword">struct</span> _Unwind_Exception *ue_header,</span><br><span class="line">		      <span class="keyword">struct</span> _Unwind_Context *context)</span><br><span class="line"></span><br><span class="line">  lsda_header_info info;</span><br><span class="line">  <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *language_specific_data;</span><br><span class="line">  <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *action_record;</span><br><span class="line">  <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *p;</span><br><span class="line">  _Unwind_Ptr landing_pad, ip;</span><br><span class="line">  <span class="type">int</span> handler_switch_value;</span><br><span class="line">  <span class="type">void</span>* thrown_ptr = <span class="number">0</span>;</span><br><span class="line">  <span class="type">bool</span> foreign_exception;</span><br><span class="line">  <span class="type">int</span> ip_before_insn = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">  p = parse_lsda_header (context, language_specific_data, &amp;info);</span><br><span class="line">  info.ttype_base = base_of_encoded_value (info.ttype_encoding, context);</span><br><span class="line"></span><br><span class="line">  ip = _Unwind_GetIPInfo (context, &amp;ip_before_insn);</span><br><span class="line">  <span class="keyword">if</span> (! ip_before_insn)</span><br><span class="line">    --ip;</span><br><span class="line">  landing_pad = <span class="number">0</span>;</span><br><span class="line">  action_record = <span class="number">0</span>;</span><br><span class="line">  handler_switch_value = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (p &lt; info.action_table)</span><br><span class="line">    &#123;</span><br><span class="line">      _Unwind_Ptr cs_start, cs_len, cs_lp;</span><br><span class="line">      <span class="type">_uleb128_t</span> cs_action;</span><br><span class="line"></span><br><span class="line">      p = read_encoded_value (<span class="number">0</span>, info.call_site_encoding, p, &amp;cs_start);</span><br><span class="line">      p = read_encoded_value (<span class="number">0</span>, info.call_site_encoding, p, &amp;cs_len);</span><br><span class="line">      p = read_encoded_value (<span class="number">0</span>, info.call_site_encoding, p, &amp;cs_lp);</span><br><span class="line">      p = read_uleb128 (p, &amp;cs_action);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (ip &lt; info.Start + cs_start)</span><br><span class="line">	p = info.action_table;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (ip &lt; info.Start + cs_start + cs_len)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">if</span> (cs_lp)</span><br><span class="line">	    landing_pad = info.LPStart + cs_lp;</span><br><span class="line">	  <span class="keyword">if</span> (cs_action)</span><br><span class="line">	    action_record = info.action_table + cs_action - <span class="number">1</span>;</span><br><span class="line">	  <span class="keyword">goto</span> found_something;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>_Unwind_GetIPInfo</code> å‡½æ•°æ ¹æ® <code>context</code>ï¼ˆcontextå’Œfsç»“æ„ä½“ä»‹ç»åœ¨<a href="####current%E5%92%8Cfs%E7%BB%93%E6%9E%84%E4%BD%93%E5%88%86%E6%9E%90%E5%8F%8A%E5%81%8F%E7%A7%BB%E9%87%8F%E8%A1%A8%E6%A0%BC">æ–‡æœ«</a>ï¼‰è·å– <code>ip</code> å’Œ <code>ip_before_insn</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">inline</span> _Unwind_Ptr</span><br><span class="line">_Unwind_GetIPInfo (<span class="keyword">struct</span> _Unwind_Context *context, <span class="type">int</span> *ip_before_insn)</span><br><span class="line">&#123;</span><br><span class="line">  *ip_before_insn = _Unwind_IsSignalFrame (context);</span><br><span class="line">  <span class="keyword">return</span> (_Unwind_Ptr) context-&gt;ra;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>_Unwind_GetIPInfo</code> å‡½æ•°é€šè¿‡ <code>context-&gt;ra</code> è¿”å› <code>ip</code>ï¼ˆä¹Ÿå°±æ˜¯å½“å‰å‡½æ•°çš„è¿”å›åœ°å€ï¼‰ï¼Œä»¥ä¸Šé¢ <code>demo</code> å’Œ <code>exp</code> ä¸ºä¾‹ï¼Œæ­¤å¤„çš„ <code>ip</code> åº”è¯¥æ˜¯ <code>0x401297</code>ã€‚è€Œ <code>ip_before_insn</code> è¡¨ç¤ºå½“å‰å¸§ï¼ˆcontextï¼‰æ˜¯å¦ä¸ºä¿¡å·å¸§ï¼Œå¦‚æœä¸ä¸ºä¿¡å·å¸§ï¼Œ <code>ip_before_insn</code> çš„å€¼å°±ä¸º <code>0</code>ã€‚è¿™é‡Œå¹¶ä¸æ˜¯ä¿¡å·å¸§ï¼Œé€šè¿‡è°ƒè¯•ä¹Ÿèƒ½çœ‹å‡ºã€‚ï¼ˆæ­£å¸¸æƒ…å†µä¸‹è¿™é‡Œè°ƒè¯•æ—¶æ²¡æœ‰å‡½æ•°ç¬¦å·çš„ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘ä¸€ä»½æœ‰ç¬¦å·ä¿¡æ¯çš„ <code>libgcc_s.so.1</code> åº“ã€‚å½“ç„¶äº†ï¼Œæ²¡æœ‰ç¬¦å·ä¹Ÿå¯ä»¥å‚è€ƒ so åº“çš„äºŒè¿›åˆ¶æ–‡ä»¶å’Œæºç æ¥å®šä½å‡½æ•°ï¼‰</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20241221212224504.png" alt="image-20241221212224504" style="zoom:50%;" />



<p>å¤§éƒ¨åˆ†æƒ…å†µä¸‹ <code>ip_before_insn</code> éƒ½ä¸º <code>0</code> ï¼Œè¿™æ · <code>ip</code> å°±ä¼šå‡ä¸€ã€‚ä½†ä¸ºä»€ä¹ˆè¦ <code>--ip</code>ï¼Ÿå¦‚æœä¸€ä¸ªæŒ‡ä»¤çš„é•¿åº¦ä¸ä¸ºä¸€å­—èŠ‚ï¼Œå³ä½¿å›é€€ä¸€å­—èŠ‚ä¹Ÿå›ä¸åˆ°ä¸Šä¸€æ¡æŒ‡ä»¤çš„èµ·å§‹åœ°å€ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (! ip_before_insn)</span><br><span class="line">  --ip;</span><br></pre></td></tr></table></figure>



<p>ä¸ºäº†æ›´å¥½ç†è§£ä¸ºä»€ä¹ˆè¦ <code>--ip</code>ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹é¢çš„ä¾‹å­ï¼Œè¿™é‡Œçš„ <code>try</code> èŒƒå›´æ˜¯ <strong>[0x401305,0x401314] <strong>ï¼Œå…¶ä¸­åœ¨ <code>0x401305</code> å¤„è°ƒç”¨äº† <code>func1</code>ï¼ˆå…¶ä¸­çš„è°ƒç”¨é“¾ä¸º <code>main-&gt;func1-&gt;func2-&gt;func3</code>ï¼Œåœ¨ <code>func3</code> ä¸­æœ‰ <code>throw</code>ï¼Œå…¶æºç åœ¨ <a href="##C++%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%A0%88%E5%B1%95%E5%BC%80%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">ä¸‹æ–‡</a>ï¼Œè¿™é‡Œä¸éœ€è¦çœ‹æºç ï¼‰ã€‚å½“æ ˆå±•å¼€æ‰§è¡Œåˆ° <code>func1</code> çš„è¿”å›åœ°å€ <code>0x40130A</code> å¤„ï¼Œå¦‚æœæ²¡æœ‰ <code>--ip</code> åˆ™ä¼šæ£€æµ‹ <code>0x40130A</code> æ˜¯å¦ä½äºåˆæ³•åŒºé—´ã€‚ä½†æ­¤æ—¶åœ°å€ <code>0x40130A</code> å·²ç»æ˜¯æŠ›å‡ºå¼‚å¸¸æŒ‡ä»¤ä»£ç ï¼ˆå¼‚å¸¸æ˜¯åœ¨ <code>func1</code> å‡½æ•°ä¸­æŠ›å‡ºçš„ï¼‰çš„ä¸‹ä¸€æ¡æŒ‡ä»¤äº†ï¼Œå®ƒå¹¶ä¸æ˜¯å®é™…æŠ›å‡ºå¼‚å¸¸çš„æŒ‡ä»¤ï¼Œ</strong>å°½ç®¡è¿™é‡ŒæŠ›å‡ºå¼‚å¸¸çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ä¹Ÿä½äº <code>try</code> çš„èŒƒå›´ä¸­</strong>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000000401305 ;   try &#123;</span><br><span class="line">.text:0000000000401305                 call    _Z5func1v       ; func1(void)</span><br><span class="line">.text:000000000040130A ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000000000040130A                 lea     rax, aItIsFunc1After ; &quot;it is func1 after&quot;</span><br><span class="line">.text:0000000000401311                 mov     rdi, rax        ; s</span><br><span class="line">.text:0000000000401314                 call    _puts</span><br><span class="line">.text:0000000000401314 ;   &#125; // starts at 401305</span><br></pre></td></tr></table></figure>



<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæ›´æç«¯çš„æƒ…å†µï¼Œåœ¨ä¸‹é¢çš„ç¬¬ä¸€ä¸ªå‡½æ•° <code>func3</code> ä¸­ <code>call ___cxa_throw</code> æŒ‡ä»¤ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå®ƒçš„åœ°å€æ˜¯ <code>0x4012D3</code>ã€‚å¯è¿™ä¸ªåœ°å€æ°å¥½æ˜¯ <code>func3</code> å‡½æ•°çš„æœ€åä¸€æ¡æŒ‡ä»¤ï¼Œåœ¨æ‰§è¡Œ <code>call ___cxa_throw</code> æ—¶å‹æ ˆä¼šå°†ä¸‹ä¸€æ¡æŒ‡ä»¤ <code>endbr64</code>ï¼ˆè¯¥æŒ‡ä»¤æ˜¯ <code>func2</code> å‡½æ•°çš„ï¼‰ï¼Œä¹Ÿå°±æ˜¯ <code>___cxa_throw</code> å‡½æ•°çš„è¿”å›åœ°å€ä¸º <code>0x4012D8</code>ã€‚è‹¥ <code>func3</code> å‡½æ•°ä¸­æœ‰ <code>try</code>ï¼Œæ— è®ºå¦‚ä½•ä½äº <code>func2</code> é‡Œçš„ <code>0x4012D8</code> åœ°å€ä¹Ÿä¸ä¼šå‡ºç°åœ¨ <code>try</code> çš„åŒºåŸŸ ã€‚å¯è°èƒ½ä¿è¯æŠ›å‡ºå¼‚å¸¸çš„æŒ‡ä»¤ä¸ä¼šæ˜¯å½“å‰å‡½æ•°çš„æœ€åä¸€æ¡æŒ‡ä»¤å‘¢ï¼Œ<strong>å› æ­¤å°†è¿”å›åœ°å€(IP)å‡ä¸€å°±æ˜¯æœ€å¥½çš„è§£å†³æ–¹æ¡ˆ</strong> ã€‚æŠ›å‡ºå¼‚å¸¸æŒ‡ä»¤çš„è¿”å›åœ°å€å‡ä¸€ï¼Œä¸€å®šæ˜¯è½åœ¨äº†æŠ›å‡ºå¼‚å¸¸æŒ‡ä»¤çš„èŒƒå›´å†…ã€‚å¼‚å¸¸å±•å¼€è¡¨ï¼ˆLSDAã€call-siteè¡¨ï¼‰æ˜¯åŸºäºæŒ‡ä»¤åœ°å€èŒƒå›´åŒ¹é…çš„ï¼Œåªéœ€ç¡®ä¿IPé‡æ–°è½å›é‚£ä¸ªæŒ‡ä»¤çš„åŒºé—´å†…ï¼Œå°±èƒ½æ­£ç¡®åŒ¹é…åˆ°ç›¸åº”çš„call-site entryã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:00000000004012A5 ; __unwind &#123;</span><br><span class="line">......</span><br><span class="line">.text:00000000004012D0                 mov     rdi, rax        ; void *</span><br><span class="line">.text:00000000004012D3                 call    ___cxa_throw</span><br><span class="line">.text:00000000004012D3 ; &#125; // starts at 4012A5</span><br><span class="line">.text:00000000004012D3 _Z5func3v       endp</span><br><span class="line">.text:00000000004012D3</span><br><span class="line">.text:00000000004012D8 ; void __noreturn func2(void)</span><br><span class="line">.text:00000000004012D8                 endbr64</span><br><span class="line">.text:00000000004012DC                 push    rbp</span><br><span class="line">.text:00000000004012DD                 mov     rbp, rsp</span><br><span class="line">.text:00000000004012E0                 call    _Z5func3v       ; func3(void)</span><br><span class="line">.text:00000000004012E0 _Z5func2v       endp</span><br></pre></td></tr></table></figure>



<p>ç®€å•æ€»ç»“ä¸€ä¸‹ <code>--ip</code> çš„é—®é¢˜ï¼Œæˆ‘è§‰å¾—å¼‚å¸¸å¤„ç†éœ€è¦æ£€æŸ¥çš„æ˜¯æŠ›å‡ºå¼‚å¸¸çš„æŒ‡ä»¤ï¼Œè€Œ <code>ip = _Unwind_GetIPInfo (context, &amp;ip_before_insn);</code> è·å–çš„æ˜¯æŠ›å‡ºå¼‚å¸¸çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼ˆå…¶è¿”å›åœ°å€ï¼‰ï¼Œä¸ºäº†æ£€æµ‹åŒºé—´ä¸€å®šæ­£ç¡®ï¼Œå¿…é¡»å‡å»ä¸€ä¸ªå­—èŠ‚ä½¿å¾— <code>IP</code> ä»ç„¶å±äºæŠ›å‡ºå¼‚å¸¸çš„é‚£æ¡æŒ‡ä»¤èŒƒå›´ã€‚</p>
<p>ä¸‹é¢æ¥åˆ°äº†åŒºé—´æ£€æŸ¥çš„ä»£ç å¤„ï¼Œè¿™ä¸ª <code>p</code> æŒ‡é’ˆæ˜¯ <code>parse_lsda_header</code> å‡½æ•°çš„è¿”å›å€¼ï¼Œå…¶æŒ‡å‘äº†è§£æ <code>LSDA</code> å¤´éƒ¨ä¿¡æ¯åçš„å‰©ä½™æ•°æ®æŒ‡é’ˆï¼ˆä¹Ÿå°±æ˜¯<code>Call Site Table</code>ï¼‰ã€‚å› æ­¤ <code>read_encoded_value (0, info.call_site_encoding, p, &amp;cs_start)</code> å°±æ˜¯ä» <code>Call Site Table</code> é‡Œé¢è¯»å– <code>cs_start</code>ï¼Œå¦å¤–çš„ <code>cs_len</code>ã€<code>cs_lp</code> åŒç†ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">while</span> (p &lt; info.action_table)</span><br><span class="line">    &#123;</span><br><span class="line">      _Unwind_Ptr cs_start, cs_len, cs_lp;</span><br><span class="line">      p = read_encoded_value (<span class="number">0</span>, info.call_site_encoding, p, &amp;cs_start);</span><br><span class="line">      p = read_encoded_value (<span class="number">0</span>, info.call_site_encoding, p, &amp;cs_len);</span><br><span class="line">      p = read_encoded_value (<span class="number">0</span>, info.call_site_encoding, p, &amp;cs_lp);</span><br><span class="line">      <span class="keyword">if</span> (ip &lt; info.Start + cs_start)</span><br><span class="line">	p = info.action_table;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (ip &lt; info.Start + cs_start + cs_len)</span><br><span class="line">	&#123;</span><br><span class="line">......</span><br><span class="line">	  <span class="keyword">goto</span> found_something;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨è°ƒè¯•çš„æ—¶çœ‹ä¸åˆ° <code>read_encoded_value</code> å‡½æ•°ã€‚å› ä¸ºä½¿ç”¨äº† <code>inline</code> å…³é”®è¯ä¿®é¥°ï¼Œåªèƒ½çœ‹åˆ°å±•å¼€çš„ <code>read_encoded_value_with_base</code> å’Œ <code>base_of_encoded_value</code> å‡½æ•°ï¼ˆæ— ç¬¦å·ï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *</span><br><span class="line"><span class="title function_">read_encoded_value</span> <span class="params">(<span class="keyword">struct</span> _Unwind_Context *context, <span class="type">unsigned</span> <span class="type">char</span> encoding,</span></span><br><span class="line"><span class="params">		    <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *p, _Unwind_Ptr *val)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> read_encoded_value_with_base (encoding,</span><br><span class="line">		base_of_encoded_value (encoding, context),</span><br><span class="line">		p, val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“åˆåº“æ–‡ä»¶ <code>libstdc++</code> é…åˆå‚æ•°ç‰¹å¾èƒ½åˆ†è¾¨å‡ºæ¥ä¸‹å›¾ä¸­çš„ <code>0x7ffff7cad780</code> æ˜¯ <code>base_of_encoded_value</code> ï¼Œè€Œ <code>0x7ffff7cad4e0</code> åˆ™æ˜¯ <code>read_encoded_value_with_base</code> ã€‚</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20241221212329979.png" alt="image-20241221212329979" style="zoom:50%;" />



<p>ä¸ºäº†é¿å…å›¾ç‰‡å¤ªå¤šï¼Œè¿™é‡Œç›´æ¥ç»™å‡ºä¸‰æ¬¡ <code>read_encoded_value</code> å‡½æ•°æ‰§è¡Œåçš„è°ƒè¯•ç»“æœã€‚</p>
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>å«ä¹‰</th>
<th>å€¼</th>
</tr>
</thead>
<tbody><tr>
<td><strong>cs_start</strong></td>
<td>tryçš„èµ·å§‹åœ°å€è·ç¦»å½“å‰å‡½æ•°çš„åç§»</td>
<td>0x1c</td>
</tr>
<tr>
<td><strong>cs_len</strong></td>
<td>tryçš„èŒƒå›´</td>
<td>0x05</td>
</tr>
<tr>
<td><strong>cs_lp</strong></td>
<td>catchçš„èµ·å§‹åœ°å€è·ç¦»å½“å‰å‡½æ•°çš„åç§»</td>
<td>0x23</td>
</tr>
</tbody></table>
<p>é‚£ä¹ˆç¡®å®š <code>IP</code> çš„å…·ä½“èŒƒå›´ï¼Œåªéœ€è¦å†è·å¾— <code>info.Start</code> å³å¯ã€‚é˜…è¯»æºç å¾—çŸ¥ <code>info.Start</code> å°±æ˜¯ <code>context-&gt;bases.func</code>ï¼ˆå«ä¹‰æ˜¯å½“å‰å¸§çš„å‡½æ•°èµ·å§‹åœ°å€ï¼‰ã€‚æ­¤æ—¶å› ä¸ºæ›¿æ¢äº†åŸæœ¬çš„è¿”å›åœ°å€ä¸º <code>backdoor</code> åœ°å€ï¼Œå¯¼è‡´æ ˆå±•å¼€ä¿å­˜ä¸Šä¸‹æ–‡ä¿¡æ¯æ—¶çš„è¿”å›åœ°å€ä¹Ÿæ›´æ–°ä¸ºäº† <code>backdoor</code> ï¼Œæ‰€ä»¥å½“å‰å¸§çš„å‡½æ•°èµ·å§‹åœ°å€å°±æˆäº† <code>0x401276(backdoor)</code>ã€‚</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20241221211125729.png" alt="image-20241221211125729"></p>
<p>å†æ¥çœ‹ä¸‹é¢çš„æ£€æŸ¥ï¼Œå¸¦å…¥ä¸Šé¢å¾—åˆ°çš„æ•°æ®ï¼Œå®é™…ä¸Šå°±æ˜¯ <code> info.Start + cs_start&lt;= IP &lt; info.Start + cs_start + cs_len</code>ã€‚ <code>info.Start + cs_start</code> æ±‚è§£çš„æ˜¯å½“å‰å‡½æ•° <code>try</code> çš„èµ·å§‹åœ°å€ï¼Œ <code>cs_len</code> åˆ™æ˜¯ <code>try</code> åŒºé—´çš„å®é™…é•¿åº¦ã€‚æ‰€ä»¥æ­£å¸¸æ¥è¯´æ£€æŸ¥çš„æŠ›å‡ºå¼‚å¸¸ä»£ç çš„è¿”å›åœ°å€èŒƒå›´å°±æ˜¯ <code>try</code> çš„åŒºé—´ï¼Œå³ <code>[0x401292,0x401297)</code>ï¼Œ ä½†å› ä¸ºå­˜åœ¨ <code>--ip</code> æ‰€ä»¥å˜æˆäº†(0x401292,0x401297] ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">      <span class="keyword">if</span> (ip &lt; info.Start + cs_start)</span><br><span class="line">	p = info.action_table;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (ip &lt; info.Start + cs_start + cs_len)</span><br><span class="line">	&#123;</span><br><span class="line">......</span><br><span class="line">	  <span class="keyword">goto</span> found_something;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<h3 id="æ„å¤–äº§ç”Ÿæ–°çš„åŒºé—´"><a href="#æ„å¤–äº§ç”Ÿæ–°çš„åŒºé—´" class="headerlink" title="æ„å¤–äº§ç”Ÿæ–°çš„åŒºé—´"></a>æ„å¤–äº§ç”Ÿæ–°çš„åŒºé—´</h3><p>ä¸Šè¿°è·å– <code>Call Site Table</code> ä¸­æ•°æ®æ—¶ï¼Œé™¤äº†è°ƒè¯•å¯ä»¥çœ‹åˆ°ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å‘½ä»¤ <code>readelf -x .gcc_except_table  ./demo</code>ï¼Œèƒ½å¤Ÿè·å– <code>.gcc_except_table</code> èŠ‚é‡Œé¢çš„æ•°æ®ï¼Œ<code>LSDA</code> å°±ä½äºè¿™ä¸ªèŠ‚ä¸­ã€‚<code>LSDA Header</code> æˆªæ­¢äº <code>0x4022b0</code>ã€‚å› æ­¤ <code>read_encoded_value</code> è¯»å–çš„ <code>cs_start</code> ã€<code>cs_len</code> ã€<code>cs_lp</code> ä¹Ÿå°±æ˜¯ä¸‹é¢çš„ <code>1c</code> <code>05</code> <code>23</code>ï¼Œè¿™ä¸€ç‚¹åœ¨è¿è¡Œæ—¶å°±å·²ç»ç¡®å®šã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">zikh@Pwner-machine:~/Desktop/tmp$ readelf -x .gcc_except_table  ./demo</span><br><span class="line">Hex dump of section &#x27;.gcc_except_table&#x27;:</span><br><span class="line">  0x004022ac ff9b1901 111c0523 01300500 00571472 .......#.0...W.r</span><br><span class="line">  0x004022bc 00840105 00000100 4c1d0000 ffff010a ........L.......</span><br><span class="line">  0x004022cc 377ace01 00e70105 00000000 ff9b2901 7z............).</span><br><span class="line">  0x004022dc 190d3b61 03522700 009a0105 d70100c8 ..;a.R&#x27;.........</span><br><span class="line">  0x004022ec 0105ee01 00e9011c 00000200 017d0000 .............&#125;..</span><br><span class="line">  0x004022fc 141d0000 181d0000                   ........</span><br></pre></td></tr></table></figure>

<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œå¦‚æœç¬¬ä¸€æ¬¡é’ˆå¯¹ <code>IP</code> çš„åŒºé—´æ£€æŸ¥æ²¡æœ‰é€šè¿‡ï¼Œ<code>while</code> å¾ªç¯ä¼šå†æ¥ä¸€è½®ã€‚é‚£ä¹ˆé™¤å»ä¸€ä¸ªå­—èŠ‚çš„ <code>cs_action</code>ï¼Œä¸‹ä¸€è½®çš„ <code>cs_start</code> ã€<code>cs_len</code> ã€<code>cs_lp</code> åˆ†åˆ«ä¸º <code>30</code> <code>05</code> <code>00</code>ã€‚å¯ä»¥å‘ç°åœ¨ <code> info.Start</code> æ²¡æœ‰æ”¹å˜çš„æƒ…å†µä¸‹ï¼Œæ­¤æ—¶äº§ç”Ÿäº†ä¸€ä¸ªæ–°çš„åŒºé—´ï¼Œé‚£å¦‚æœåŠ«æŒè¿”å›åœ°å€æ»¡è¶³è¿™ä¸ªåŒºé—´èƒ½å¦è·³è½¬ï¼Ÿ</p>
<p>é€šè¿‡åˆ†ææºä»£ç æ˜¯ä¸è¡Œçš„ï¼Œå› ä¸º <code>cs_lp</code> å–åˆ°çš„æ˜¯ <code>0x0</code>ï¼Œå¯¼è‡´ <code>landing_pad</code> æ˜¯ <code>0</code>ï¼Œè§¦å‘äº†ä»£ç  <code> if (found_type == found_nothing) CONTINUE_UNWINDING;</code> è·³è¿‡äº†æœ¬æ¬¡ <code>__gxx_personality_v0</code> è¡¨ç¤ºä»€ä¹ˆéƒ½æ²¡æœ‰æœç´¢åˆ°ã€‚ä¹‹ååœ¨ <code>_Unwind_RaiseException</code> å‡½æ•°ä¸­ç»§ç»­æ›´æ–° <code>context</code> å‘ç°å·²ç»åˆ°äº†æ ˆçš„æœ€å¤–å±‚äº†ä¾ç„¶æ²¡æœ‰æ‰¾åˆ° <code>handler</code> ï¼Œè¯¥å‡½æ•°è¿”å›å¹¶è§¦å‘æœ€åçš„ <code>std::terminate ();</code>ã€‚</p>
<h3 id="åˆæ­¥åˆ†æçš„æ€»ç»“"><a href="#åˆæ­¥åˆ†æçš„æ€»ç»“" class="headerlink" title="åˆæ­¥åˆ†æçš„æ€»ç»“"></a>åˆæ­¥åˆ†æçš„æ€»ç»“</h3><p>æœ€ç»ˆå†è¯´å› C++å¼‚å¸¸å¤„ç†ç»•è¿‡ <code>canary</code>ï¼Œé€šè¿‡æº¢å‡ºçš„æ‰‹æ®µç¯¡æ”¹äº†æ­£å¸¸çš„å‡½æ•°è¿”å›åœ°å€ã€‚ä½†å› ä¸º <code>throw</code> æŠ›å‡ºå¼‚å¸¸åï¼Œå‰©ä¸‹çš„æŒ‡ä»¤éƒ½ä¸ä¼šå†æ‰§è¡Œäº†ï¼ŒåŒ…æ‹¬æ£€æŸ¥ <code>canary</code> çš„ä»£ç ï¼ŒåŒæ ·ä¹Ÿä¸ä¼šé€šè¿‡ <code>ret</code> çš„æ–¹å¼åŠ«æŒåˆ° <code>backdoor</code> ä¸­ã€‚ä½†æ˜¯å› ä¸ºæŠ›å‡ºå¼‚å¸¸åï¼Œä¼šæ ¹æ® <strong>CFI</strong> å’Œ <strong>FDE</strong> è¿›è¡Œæ ˆå±•å¼€ã€‚åœ¨è¿™æœŸé—´ç¨‹åºè¯¯æŠŠå¡«å……çš„ <code>backdoor</code> åœ°å€å½“æˆæ ˆå±•å¼€çš„ä¸€ä¸ªå‡½æ•°ç»“ç‚¹ï¼Œå¹¶ä¸” <code>__gxx_personality_v0</code> è¿˜åœ¨è¿™ä¸ªå‡½æ•°ç»“ç‚¹ä¸­å‘ç°äº†ååˆ†åˆé€‚çš„ <code>handler</code>ï¼Œç»è¿‡è¿”å›åœ°å€åŒºé—´æ£€æŸ¥æ— è¯¯åï¼Œå°†æ‰§è¡Œæµä»¥åŠæŠ›å‡ºå¼‚å¸¸æ—¶çš„ä¸Šä¸‹æ–‡çŠ¶æ€ä¸€èµ·ä¼ é€è‡³äº† <code>backdoor</code> çš„ <code>catch</code> éƒ¨åˆ†ã€‚å½“ç„¶ï¼Œä¸Šé¢ä¸¾ä¾‹çš„ <code>demo</code> è¶³å¤Ÿç‰¹æ®Šï¼Œ<code>catch</code> å‡ºæ¥æ­£å¥½å°±æ˜¯ä¸ª <code>system(&quot;/bin/sh&quot;)</code>ï¼Œå¦åˆ™è¿™æ‰æ˜¯ä¸€ä¸ªæ¼æ´åˆ©ç”¨çš„å¼€å§‹ğŸ˜­ã€‚</p>
<p>æ€»ç»“ <strong>ve1kcon</strong> å¸ˆå‚…æåˆ°çš„ç¬¬äºŒç§åˆ©ç”¨æ–¹å¼ã€‚é¦–å…ˆå¯ä»¥æ§åˆ¶æ ˆé‡Œå­˜æ”¾æ­£å¸¸çš„å‡½æ•°è¿”å›åœ°å€ï¼Œå…¶æ¬¡è¦è·³è½¬åˆ°çš„ä»£ç ä½ç½®è¦ä½äº <code>try</code> åŒºé—´ï¼ˆè®¾ <code>try</code> èµ·å§‹åœ°å€ä¸º <code>X</code>ï¼Œé‚£ä¹ˆä»£ç åœ°å€å¿…é¡»ä½äº <code>(x,end(x)]</code>ï¼‰ï¼Œæœ€å…³é”®çš„æ˜¯åªèƒ½è·³è½¬åˆ° <code>catch</code> çš„ä»£ç ä¸” <code>catch</code> çš„ç±»å‹è¿˜éœ€è¦ä¸€è‡´ã€‚è€Œè¿™ä»…ä»…æ˜¯èƒ½åŠ«æŒç¨‹åºçš„æ‰§è¡Œæµï¼Œå¹¶ä¸æ„å‘³ç€å¯ä»¥ç¨³å®šåç»­æ§åˆ¶ã€‚</p>
<h2 id="C-å¼‚å¸¸å¤„ç†æ ˆå±•å¼€æºç åˆ†æ"><a href="#C-å¼‚å¸¸å¤„ç†æ ˆå±•å¼€æºç åˆ†æ" class="headerlink" title="C++å¼‚å¸¸å¤„ç†æ ˆå±•å¼€æºç åˆ†æ"></a>C++å¼‚å¸¸å¤„ç†æ ˆå±•å¼€æºç åˆ†æ</h2><p>å½“ä¸Šé¢çš„åŒºé—´é—®é¢˜åˆ†æè¿‡ä¹‹åï¼Œå¯¹äºä¸ºä»€ä¹ˆæº¢å‡ºåŠ«æŒæ‰è¿”å›åœ°å€å°±èƒ½å®ŒæˆæŒ‡å®šä»£ç è·³è½¬è¿™ä¸ªé—®é¢˜å¹¶æ²¡æœ‰æ¢ç©¶ã€‚æ­£å¸¸æº¢å‡ºåˆ©ç”¨æ˜¯é€šè¿‡è¡”æ¥ <code>ret</code> æŒ‡ä»¤ï¼ˆ <code>pop rip</code> å¼¹å‡ºæ ˆé¡¶çš„æŒ‡é’ˆä½œä¸ºä¸‹ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œï¼‰æ§åˆ¶æ‰§è¡Œæµï¼Œè€Œåœ¨ä¸Šé¢æ€»ç»“ä¸­ä¹Ÿç®€å•æåˆ°äº†å¼‚å¸¸å¤„ç†ä¸­ç¯¡æ”¹è¿”å›åœ°å€æ”¹å˜æ‰§è¡Œæµæ˜¯å› ä¸ºæ ˆå±•å¼€æ—¶åˆ° <code>backdoor</code> é‡Œä¹ŸåŒ¹é…åˆ°äº†ä¸€ä¸ª <code>catch</code>ã€‚</p>
<p>ä½†æˆ‘è§‰å¾—è¿™äº›è¿˜ä¸å¤Ÿï¼Œç¨‹åºåˆ°åº•æ˜¯æ ¹æ®ä»€ä¹ˆä¿¡æ¯è¿›è¡Œçš„æ ˆå±•å¼€ï¼Ÿ ä¸ºä»€ä¹ˆå°†è¿”å›åœ°å€æ”¹æˆ <code>backdoor+33</code> ï¼Œ<code>info.Start</code> å°±å˜æˆäº† <code>backdoor</code>ï¼Ÿ<code>__gxx_personality_v0</code> å‡½æ•°åœ¨å¼‚å¸¸å¤„ç†ä¸­èµ·åˆ°äº†ä»€ä¹ˆä½œç”¨ï¼Ÿåœ¨æŠ›å‡ºå¼‚å¸¸åï¼Œæ ˆå±•å¼€å…·ä½“æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ</p>
<p>ä¸ºäº†ææ¸…æ¥šè¿™äº›ï¼Œæˆ‘å¯¹ <code>__cxa_throw</code> å‡½æ•°æºç è¿›è¡Œäº†åˆ†æï¼ˆå¯¹ä¸€äº›æºç è¿›è¡Œäº†åˆ å‡ï¼Œå¦‚æœ‰éœ€è¦è¯·è‡ªè¡ŒæŸ¥çœ‹å®Œæ•´æºç ï¼‰ã€‚ä¸ºäº†è§‚å¯Ÿå¤šæ¬¡çš„æ ˆå±•å¼€ï¼Œä¸‹é¢çš„æ¼”ç¤ºå°†ä½¿ç”¨æ–°çš„ç¨‹åº <code>unwind</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//g++ unwind.cpp  -o unwind -no-pie -fPIC -z now -g</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">backdoor</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    try</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;We have never called this backdoor!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (<span class="type">const</span> <span class="type">char</span> *s)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[!] Backdoor has catched the exception: %s\n&quot;</span>, s);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">func3</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	throw <span class="string">&quot;emmmmm&quot;</span>;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;it is throw after&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">func2</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	func3();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">func1</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	func2();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	try</span><br><span class="line">	&#123;</span><br><span class="line">		func1();</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;it is func1 after&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	catch(<span class="type">const</span> <span class="type">char</span> * str)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;it is catch&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>åœ¨ <code>__cxa_throw</code> å‡½æ•°ï¼ˆå®šä¹‰åœ¨ <code>libstdc++-v3/libsupc++/eh_throw.cc</code>ï¼‰å¼€å§‹è¿›è¡Œäº†åˆå§‹åŒ–å¼‚å¸¸å¤„ç†çš„å…ƒæ•°æ®ï¼Œå¹¶å‡†å¤‡å¥½å¼‚å¸¸å¯¹è±¡ç”¨äºæ ˆå±•å¼€å’Œå¼‚å¸¸æ•è·è¿‡ç¨‹ã€‚<code>_Unwind_RaiseException</code> å‡½æ•°<strong>è¿›è¡Œäº†å…·ä½“æ ˆå±•å¼€æ“ä½œ</strong>ï¼Œå¦‚æœåœ¨æ­¤æœŸé—´é‡åˆ°äº†æŸäº›é”™è¯¯ï¼Œåˆ™ä¼šè°ƒç”¨ <code>std::terminate</code> å‡½æ•°ç»ˆæ­¢ç¨‹åºã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">void</span></span><br><span class="line">__cxxabiv1::__cxa_throw (<span class="type">void</span> *obj, <span class="built_in">std</span>::type_info *tinfo,</span><br><span class="line">			 <span class="type">void</span> (_GLIBCXX_CDTOR_CALLABI *dest) (<span class="type">void</span> *))</span><br><span class="line">&#123;</span><br><span class="line">  PROBE2 (throw, obj, tinfo);</span><br><span class="line"></span><br><span class="line">  __cxa_eh_globals *globals = __cxa_get_globals ();</span><br><span class="line">  globals-&gt;uncaughtExceptions += <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// Definitely a primary.</span></span><br><span class="line">  __cxa_refcounted_exception *header =</span><br><span class="line">    __cxa_init_primary_exception(obj, tinfo, dest);</span><br><span class="line">  header-&gt;referenceCount = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">  _Unwind_RaiseException (&amp;header-&gt;exc.unwindHeader);</span><br><span class="line">  <span class="comment">// Some sort of unwinding error.  Note that terminate is a handler.</span></span><br><span class="line">  __cxa_begin_catch (&amp;header-&gt;exc.unwindHeader);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">terminate</span> ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>_Unwind_RaiseException</code> å‡½æ•°è¿›è¡Œæ ˆå±•å¼€çš„ç­–ç•¥åˆ†ä¸ºäº†<strong>æœç´¢é˜¶æ®µ (Phase 1: Search</strong>) å’Œ <strong>æ¸…ç†é˜¶æ®µ(Phase 2: Clean)</strong> ã€‚</p>
<p>æœç´¢é˜¶æ®µï¼šä»æŠ›å‡ºå¼‚å¸¸çš„å‡½æ•°å¼€å§‹æ£€æµ‹å½“å‰å‡½æ•°ï¼ˆæœ¬æ–‡æåˆ°çš„å½“å‰å‡½æ•°è¡¨ç¤ºcur_contextæ‰€æè¿°çš„å‡½æ•°ï¼‰æ˜¯å¦å­˜åœ¨ <code>catch</code> æˆ–è€… <code>cleanup</code>ï¼ˆå½“å‰å‡½æ•°çš„æ”¶å°¾å·¥ä½œï¼Œæ¯”å¦‚å½“å‰å‡½æ•°ä¸­æŸå®ä¾‹çš„ææ„å‡½æ•°éœ€è¦æ‰§è¡Œï¼‰ã€‚å¦‚æœ <code>catch</code> å’Œ <code>cleanup</code> éƒ½æ²¡æœ‰ï¼Œå°±ä¼šé€šè¿‡ <code>uw_frame_state_for</code> å’Œ <code>uw_update_context</code> å‡½æ•°å›é€€åˆ°ä¸Šä¸€çº§å‡½æ•°ï¼ˆcur_contextæ‰€æè¿°çš„å‡½æ•°çš„çˆ¶å‡½æ•°ï¼‰ï¼Œå°†ä¸Šä¸€çº§å‡½æ•°ä¸Šä¸‹æ–‡ä¿¡æ¯æ›´æ–°åˆ° <code>cur_context</code> ä¸­ç»§ç»­åˆ¤æ–­ï¼Œç›´è‡³é‡åˆ°äº† <code>catch</code> æˆ–è€… <code>cleanup</code> ï¼Œè°ƒç”¨ <code> personality routine</code>ï¼ˆåœ¨æœ¬æ–‡ä¸­æŒ‡çš„æ˜¯ <code>__gxx_personality_v0</code> å‡½æ•°ï¼‰åˆ¤æ–­å…·ä½“é‡åˆ°çš„æ˜¯å“ªç§æƒ…å†µã€‚å¦‚æœé‡åˆ°äº† <code>cleanup</code> ä¸ä¼šå¤„ç†ï¼Œå¦‚æœé‡åˆ°çš„æ˜¯ <code>catch</code> å¹¶é€šè¿‡æ£€æŸ¥åï¼Œ<code>__gxx_personality_v0</code> è¿”å› <code>_URC_HANDLER_FOUND</code> è¡¨ç¤ºå·²ç»åœ¨è¿™ä¸€å±‚æ‰¾åˆ°äº† <code>handler</code>ã€‚å€˜è‹¥ç»è¿‡å¤šæ¬¡æ ˆå›é€€ï¼Œå·²ç»åˆ°äº†æœ€é«˜å±‚å‡½æ•°ä¾ç„¶æ²¡æœ‰æ‰¾åˆ° <code>catch</code> é‚£ä¹ˆ <code>_Unwind_RaiseException</code> åˆ™ <code>_Unwind_RaiseException</code> å‡½æ•°è¿”å› <code>_URC_END_OF_STACK</code>ã€‚</p>
<p>æ¸…ç†é˜¶æ®µï¼š<code>_Unwind_RaiseException_Phase2</code> åŸºäº <code>Phase 1</code> æ‰¾åˆ°çš„ <code>handler</code> ä¿¡æ¯ï¼Œä» <code>this_context</code>ï¼ˆåˆå§‹ä½ç½®ï¼‰å¼€å§‹çœŸæ­£å±•å¼€æ ˆï¼ŒæŠŠå„å±‚æ¬¡å¯¹è±¡ææ„æ‰ï¼ˆå¦‚æœæœ‰<code>cleanup</code> ï¼‰ï¼Œå¹¶åœ¨ç›®æ ‡ <code>handler</code> å¤„åœæ­¢ã€‚å¦‚æœåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œå®ƒä¼šè¿”å›ç›¸åº”çš„é”™è¯¯ç ã€‚æ­£å¸¸æƒ…å†µä¸‹å¦‚æœä¸€åˆ‡é¡ºåˆ©è¿”å›<code>_URC_INSTALL_CONTEXT</code>ï¼Œè¡¨ç¤ºå·²æ‰¾åˆ° <code>handler</code> ï¼Œéœ€è¦ <code>uw_install_context</code> æ¥åˆ‡æ¢ç¨‹åºä¸Šä¸‹æ–‡å’Œå®é™…æ‰§è¡Œæµåˆ° <code>handler</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_Unwind_Reason_Code LIBGCC2_UNWIND_ATTRIBUTE</span><br><span class="line">_Unwind_RaiseException(<span class="keyword">struct</span> _Unwind_Exception *exc)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">Unwind_Context</span> <span class="title">this_context</span>, <span class="title">cur_context</span>;</span></span><br><span class="line">  _Unwind_Reason_Code code;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> frames;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Set up this_context to describe the current stack frame.  */</span></span><br><span class="line">  uw_init_context (&amp;this_context);</span><br><span class="line">  cur_context = this_context;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Phase 1: Search.  Unwind the stack, calling the personality routine</span></span><br><span class="line"><span class="comment">     with the _UA_SEARCH_PHASE flag set.  Do not modify the stack yet.  */</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      _Unwind_FrameState fs;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Set up fs to describe the FDE for the caller of cur_context.  The</span></span><br><span class="line"><span class="comment">	 first time through the loop, that means __cxa_throw.  */</span></span><br><span class="line">      code = uw_frame_state_for (&amp;cur_context, &amp;fs);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (code == _URC_END_OF_STACK)</span><br><span class="line">	<span class="comment">/* Hit end of stack with no handler found.  */</span></span><br><span class="line">	<span class="keyword">return</span> _URC_END_OF_STACK;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (code != _URC_NO_REASON)</span><br><span class="line">	<span class="comment">/* Some error encountered.  Usually the unwinder doesn&#x27;t</span></span><br><span class="line"><span class="comment">	   diagnose these and merely crashes.  */</span></span><br><span class="line">	<span class="keyword">return</span> _URC_FATAL_PHASE1_ERROR;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Unwind successful.  Run the personality routine, if any.  */</span></span><br><span class="line">      <span class="keyword">if</span> (fs.personality)</span><br><span class="line">	&#123;</span><br><span class="line">	  code = (*fs.personality) (<span class="number">1</span>, _UA_SEARCH_PHASE, exc-&gt;exception_class,</span><br><span class="line">				    exc, &amp;cur_context);</span><br><span class="line">	  <span class="keyword">if</span> (code == _URC_HANDLER_FOUND)</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	  <span class="keyword">else</span> <span class="keyword">if</span> (code != _URC_CONTINUE_UNWIND)</span><br><span class="line">	    <span class="keyword">return</span> _URC_FATAL_PHASE1_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Update cur_context to describe the same frame as fs.  */</span></span><br><span class="line">      uw_update_context (&amp;cur_context, &amp;fs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Indicate to _Unwind_Resume and associated subroutines that this</span></span><br><span class="line"><span class="comment">     is not a forced unwind.  Further, note where we found a handler.  */</span></span><br><span class="line">  exc-&gt;private_1 = <span class="number">0</span>;</span><br><span class="line">  exc-&gt;private_2 = uw_identify_context (&amp;cur_context);</span><br><span class="line"></span><br><span class="line">  cur_context = this_context;</span><br><span class="line">  code = _Unwind_RaiseException_Phase2 (exc, &amp;cur_context, &amp;frames);</span><br><span class="line">  <span class="keyword">if</span> (code != _URC_INSTALL_CONTEXT)</span><br><span class="line">    <span class="keyword">return</span> code;</span><br><span class="line"></span><br><span class="line">  uw_install_context (&amp;this_context, &amp;cur_context, frames);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ä¸Šé¢ <code>_Unwind_RaiseException</code> åšäº†å¾ˆå¤šäº‹æƒ…ï¼Œä¸ºäº†æ–¹ä¾¿å…·ä½“æ˜¯å¦‚ä½•å®Œæˆæœç´¢å’Œæ¸…ç†è¿‡ç¨‹çš„ï¼Œæˆ‘ä»¬å°†ä»£ç æ‹†å¼€æ¥çœ‹ã€‚</p>
<h3 id="Phase-1"><a href="#Phase-1" class="headerlink" title="Phase 1"></a>Phase 1</h3><p>å¯¹äºç¨‹åºè€Œè¨€ï¼Œè¿è¡Œåˆ°ä»»ä¸€æ—¶åˆ»ä¹Ÿåªæœ‰ä¸€å¥—å¯„å­˜å™¨ï¼ˆè¿™é‡Œç§°ä¹‹ä¸ºç¡¬ä»¶å¯„å­˜å™¨ï¼‰ã€‚ä¹‹æ‰€ä»¥æ ˆå›æº¯èƒ½å®Œæˆæ˜¯å› ä¸ºæ¨¡æ‹Ÿå‡ºäº†ä¸€å¥—å­˜å‚¨ä¸Šä¸‹æ–‡ä¿¡æ¯çš„ç»“æ„ <code>cur_context</code>ã€‚ç°åœ¨çš„è°ƒç”¨é“¾æ˜¯ <code>main-&gt;func1-&gt;func2-&gt;func3</code> ï¼Œåœ¨æˆ‘ä»¬æåˆ°æ ˆå±•å¼€å›æº¯å‡½æ•°è°ƒç”¨ <code>func3-&gt;func2-&gt;func1-&gt;main</code> çš„æ—¶å€™ï¼Œè‡ªå§‹è‡³ç»ˆæ”¹å˜çš„éƒ½æ˜¯ <code>cur_context</code> è¿™æ ·ä¸€å¥—ç»“æ„ä½“ã€‚</p>
<p>æ ˆå›é€€çš„æœ¬è´¨ï¼Œæ‰¾åˆ°å½“å‰å‡½æ•°ï¼ˆ<code>cur_context</code> åœ¨æè¿°å“ªä¸ªå¸§ï¼Œå“ªä¸ªå°±æ˜¯å½“å‰å‡½æ•°ï¼‰çš„è¿”å›åœ°å€ã€‚æ ˆå›é€€ä»¥ <code>uw_update_context</code> å’Œ <code>uw_frame_state_for</code> å‡½æ•°å…±åŒå®Œæˆã€‚é¦–å…ˆç”¨ <code>uw_frame_state_for</code> è§£æ <code>FDE</code> å’Œ <code>CIE</code> ç”Ÿæˆ <code>fs</code> ç»“æ„ä½“ï¼Œæ¥ç€è°ƒç”¨ <code>uw_update_context</code> å‡½æ•°ï¼Œå€ŸåŠ© <code>fs</code> ç»“æ„ä½“å’ŒåŸ <code>current</code> ä¸­çš„å¯„å­˜å™¨å€¼æ›´æ–°å‡ºæ–°çš„ <code>CFA</code>ï¼Œå†ç”¨ <code>CFA</code> å’Œ <code>fs</code> æ›´æ–°å‡ºæ–°çš„ <code>current</code> ä¸­çš„å¯„å­˜å™¨å€¼ï¼ŒåŒ…æ‹¬å‡½æ•°è¿”å›åœ°å€ã€‚å½“é‡åˆ°ä¸€ä¸ªå‡½æ•°ä¸­å­˜åœ¨ <code>cleanup</code> æˆ–è€… <code>handler</code> æ—¶ï¼Œå°±è¿›å…¥ <code>personality</code> å‡½æ•°è¿›è¡Œå…·ä½“åˆ¤æ–­ï¼Œç›´åˆ°æ‰¾åˆ° <code>handler</code>ï¼Œè‡³æ­¤ç¬¬ä¸€é˜¶æ®µç»“æŸã€‚</p>
<h4 id="uw-update-contextå‡½æ•°"><a href="#uw-update-contextå‡½æ•°" class="headerlink" title="uw_update_contextå‡½æ•°"></a>uw_update_contextå‡½æ•°</h4><p><code>uw_update_context</code> å‡½æ•°ï¼ˆå®šä¹‰åœ¨ <code>libgcc/unwind-dw2.c</code>ï¼‰å°±æ˜¯å¯¹ <code>uw_update_context_1</code> çš„å°è£…ï¼Œæœ€ååˆæ›´æ–°äº† <code>context-&gt;ra</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">uw_update_context</span> <span class="params">(<span class="keyword">struct</span> _Unwind_Context *context, _Unwind_FrameState *fs)</span></span><br><span class="line">&#123;</span><br><span class="line">  uw_update_context_1 (context, fs);</span><br><span class="line">  <span class="keyword">if</span> (fs-&gt;regs.reg[DWARF_REG_TO_UNWIND_COLUMN (fs-&gt;retaddr_column)].how</span><br><span class="line">      == REG_UNDEFINED)</span><br><span class="line">    context-&gt;ra = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">void</span> *ret_addr;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> MD_DEMANGLE_RETURN_ADDR</span></span><br><span class="line">      _Unwind_Word ra = _Unwind_GetGR (context, fs-&gt;retaddr_column);</span><br><span class="line">      ret_addr = MD_DEMANGLE_RETURN_ADDR (context, fs, ra);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">      ret_addr = _Unwind_GetPtr (context, fs-&gt;retaddr_column);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      context-&gt;ra = __builtin_extract_return_addr (ret_addr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>uw_update_context_1</code> å‡½æ•°ç”¨æ¥æ¢å¤å½“å‰å‡½æ•°ä¸Šä¸‹æ–‡ã€‚æ­¤å¤„æ˜ç¡®ä¸€ä¸ªæ¦‚å¿µï¼Œå‡è®¾å½“å‰çš„å‡½æ•°æ˜¯ <code>callee</code> ï¼Œé‚£ä¹ˆå…¶è°ƒç”¨è€…ä¸º <code>caller</code>ã€‚æ­¤å¤„è¯´çš„æ¢å¤æŒ‡çš„æ˜¯å°† <code>callee</code> çš„ä¸Šä¸‹æ–‡æ›´æ–°ä¸º <code>caller</code> çš„ä¸Šä¸‹æ–‡ã€‚æ¢å¤ä¸Šä¸‹æ–‡çš„åŸç†å…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯æ ¹æ®ä¸€ä¸ªåŸºå€å¯„å­˜å™¨åŠ ä¸Šä¸€ä¸ªåç§»å¯»æ‰¾åˆ°è¦æ¢å¤çš„å€¼ã€‚è¿™ä¸ªåŸºå€å¯„å­˜å™¨è¢«ç§°ä¸º CFAï¼ˆCanonical Frame Address.æ ‡å‡†æ ˆå¸§åœ°å€ï¼‰ã€‚</p>
<p><code>uw_update_context_1</code>å‡½æ•°ç¬¬ä¸€è¡Œä»£ç æ˜¯ <code>struct _Unwind_Context orig_context = *context</code> å°† <code>context</code> åšä¸€ä¸ªåŸå§‹å¤‡ä»½ï¼Œå­˜å‚¨åœ¨æ ˆä¸­å±€éƒ¨å˜é‡ <code>orig_context</code>ã€‚çœ‹åæ±‡ç¼–åçš„ä»£ç å¯ä»¥å¾ˆç›´è§‚çš„å‘ç°æœ‰å¤‡ä»½æ“ä½œã€‚</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/f444319343cd4d76.png" alt="image-20250111160302818"></p>
<p><code>CFA</code> çš„ç”Ÿæˆä»£ç å¦‚ä¸‹ï¼Œå…ˆæ ¹æ® <code>fs-&gt;regs.cfa_how</code> è·å– <code>CFA</code> çš„ç”Ÿæˆæ–¹å¼ï¼Œä»¥ <code>CFA_REG_OFFSET</code> ä¸ºä¾‹ã€‚ åœ¨ <code>fs</code> ç»“æ„ä½“ä¸­è·å– <code>regs.cfa_reg</code> å¯„å­˜å™¨ç¼–å·ï¼Œé€šè¿‡ <code>_Unwind_GetPtr</code> å‡½æ•°ä» <code>orig_context</code> ç»“æ„ä½“æ ¹æ®å¯„å­˜å™¨ç¼–å·æ‹¿åˆ°å¯„å­˜å™¨çš„å®é™…å€¼ï¼Œå†åŠ ä¸Š <code>fs</code> ç»“æ„ä½“ä¸­ <code>cfa_offset</code> å­—æ®µå¾—åˆ°æœ€ç»ˆ <code>cfa</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">switch</span> (fs-&gt;regs.cfa_how)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> CFA_REG_OFFSET:</span><br><span class="line">      cfa = _Unwind_GetPtr (&amp;orig_context, fs-&gt;regs.cfa_reg);</span><br><span class="line">      cfa += fs-&gt;regs.cfa_offset;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">......</span><br><span class="line">    &#125;</span><br><span class="line">context-&gt;cfa = cfa;</span><br></pre></td></tr></table></figure>



<p>è°ƒè¯•éªŒè¯ï¼Œä¸‹é¢æ˜¯ <code>fs</code> ç»“æ„ä½“å„å­—æ®µã€‚</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/9de1d147182077b9.png" alt="b704d90d0a9ef310b089d17b4edc8bf5"></p>
<p>ä¸‹é¢æ˜¯ <code>orig_context</code> ç»“æ„ä½“å„å­—æ®µï¼ˆæŸ¥çœ‹ <code>context</code> ç»“æ„ä½“ä¼šè®¡ç®—å‡ºé”™ï¼‰ã€‚å› ä¸º <code>fs</code> ç»“æ„ä½“ä¸­ <code>regs.cfa_reg</code> ä¸º <code>7</code>ï¼Œæ‰€ä»¥ <code>_Unwind_GetPtr (&amp;orig_context, fs-&gt;regs.cfa_reg)</code> çš„è¿”å›å€¼åº”è¯¥æ˜¯ä¸‹å›¾åç§» <code>7</code> å¤„ç»è¿‡è§£å¼•ç”¨åçš„æŒ‡é’ˆ <code>0x7fffffffdca0</code>ã€‚æ ¹æ®ä¸Šå›¾å¾—çŸ¥ <code>fs</code> ç»“æ„ä½“ä¸­ <code>regs.cfa_offset</code> ä¸º <code>0x20</code>ï¼Œå› æ­¤æœ€ç»ˆçš„ <code>cfa</code> åº”è¯¥æ˜¯ <code>0x7fffffffdca0+0x20=0x7fffffffdcc0</code>ã€‚</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/c2261b0c4fab4c5a.png" alt="image-20250111160629246"></p>
<p>ç”Ÿæˆ <code>CFA</code> çš„ä¸‰æ¡å…³é”®æ±‡ç¼–ä»£ç å’Œ<code>context-&gt;cfa = cfa</code> æ‰§è¡Œå <code>context</code> ç»“æ„ä½“å¦‚ä¸‹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;uw_update_context_1+382&gt;    mov    rax, qword ptr [rsp + 0x20]</span><br><span class="line">&lt;uw_update_context_1+387&gt;    add    r11, qword ptr [rax + 0x128]</span><br><span class="line">&lt;uw_update_context_1+505&gt;    mov    qword ptr [r14 + 0x90], r11</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/c596a07d5726dea4.png" alt="image-20250111161407818"></p>
<p>ç”Ÿæˆ <code>CFA</code> ä¹‹åï¼Œå¼€å§‹æ¢å¤ <code>cur_context</code> ä¸­å¯„å­˜å™¨ã€‚<code>fs-&gt;regs.reg[i].how</code> æè¿°äº†æ¯ä¸ªå¯„å­˜å™¨ï¼ˆ<code>reg</code> æ•°ç»„å…ƒç´ ï¼‰åœ¨å½“å‰å¸§çŠ¶æ€ä¸‹çš„ <strong>ä¿å­˜æ–¹å¼</strong>ã€‚ä¸‹é¢ä»¥ <code>REG_SAVED_OFFSET</code> ä¸ºä¾‹ï¼Œå…¶å¯„å­˜å™¨çš„å€¼ä»¥åç§»é‡çš„å½¢å¼ä¿å­˜åœ¨æ ˆå¸§ä¸­ï¼Œå…·ä½“çš„åç§»é‡å­˜å‚¨åœ¨ <code>loc.offset</code> å­—æ®µä¸­ï¼Œæ‰€ä»¥è¯¥å¯„å­˜å™¨å€¼æ¢å¤å°±æ˜¯ç”¨ <code>CFA+loc.offset</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; __LIBGCC_DWARF_FRAME_REGISTERS__ + <span class="number">1</span>; ++i)</span><br><span class="line">    <span class="keyword">switch</span> (fs-&gt;regs.reg[i].how)</span><br><span class="line">      &#123;</span><br><span class="line">      <span class="keyword">case</span> REG_UNSAVED:</span><br><span class="line">      <span class="keyword">case</span> REG_UNDEFINED:</span><br><span class="line">	<span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> REG_SAVED_OFFSET:</span><br><span class="line">	_Unwind_SetGRPtr (context, i,</span><br><span class="line">			  (<span class="type">void</span> *) (cfa + fs-&gt;regs.reg[i].loc.offset));</span><br><span class="line">	<span class="keyword">break</span>;</span><br><span class="line">......</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ä¸Šé¢çš„ä»£ç ï¼Œè™½ç„¶éå†äº†æ‰€æœ‰å¯„å­˜å™¨ï¼Œä½†æ˜¯å¦æ¢å¤å€¼å–å†³äº <code>fs-&gt;regs.reg[i].how</code>ï¼Œå¦‚æœä¸º <code>REG_UNSAVED</code> åˆ™æ„å‘³ç€ä¸ä¼šæ¢å¤è¯¥å¯„å­˜å™¨çš„å€¼ã€‚ä»¥ä¸‹é¢å›¾ç‰‡å±•ç¤ºçš„ <code>fs</code> ç»“æ„ä½“ä¸ºä¾‹ï¼Œæ¥åˆ†æä¸€ä¸‹ <code>RIP</code> å¯„å­˜å™¨æœ€ç»ˆçš„å€¼ã€‚é¦–å…ˆåœ¨åç§» <code>0x20</code> çš„ä½ç½®è¡¨ç¤ºçš„æ˜¯ <code>RIP</code> çš„ <code>reg</code>ç»“æ„ä¸­ <code>loc</code> å’Œ <code>how</code>å­—æ®µã€‚<code>how</code> ä¸º <code>REG_SAVED_OFFSET</code>ï¼Œå› æ­¤æ ¹æ®ä¸Šé¢çš„è®¡ç®—æ–¹æ³• <code>RIP= CFA + offset</code>ï¼Œè¿™é‡Œçš„ <code>offset</code> æ˜¯ <code>-8(0xfffffffffffffff8)</code>ã€‚</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/9de1d147182077b9.png" alt="b704d90d0a9ef310b089d17b4edc8bf5"></p>
<p>ä¸Šæ–‡æåˆ° <code>CFA</code> ä¸º <code>0x7fffffffdcc0</code>ï¼Œå› æ­¤ <code>RIP</code> å®é™…åº”è¯¥è¿˜åŸæˆ <code>0x7fffffffdcb8</code> æŒ‡å‘çš„æ•°æ®ã€‚ä¸‹å›¾ä¸º <code>uw_update_context_1</code> å‡½æ•°æ‰§è¡Œç»“æŸåï¼Œå¯„å­˜å™¨æ¢å¤åçš„å€¼ã€‚åœ¨åç§»ä¸º <code>0x10</code> çš„ä½ç½®æ˜¯ <code>reg[RIP]</code>ã€‚</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20250111230517427.png" alt="image-20250111230517427"></p>
<p>åœ¨ <code>uw_update_context_1</code> æ‰§è¡Œåï¼Œé€šè¿‡ <code>fs-&gt;retaddr_column</code> è¾…åŠ©ç¡®å®šå½“å‰å¸§çš„è¿”å›åœ°å€ã€‚<code>retaddr_column</code> æè¿°äº†è¿”å›åœ°å€æ‰€åœ¨çš„åˆ—ï¼Œè¡¨ç¤ºåœ¨å¯„å­˜å™¨ä¿å­˜çŠ¶æ€ä¸­ï¼Œå“ªä¸ªä½ç½®ä¿å­˜äº†è¿”å›åœ°å€ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ret_addr = _Unwind_GetPtr (context, fs-&gt;retaddr_column);</span><br><span class="line">context-&gt;ra = __builtin_extract_return_addr (ret_addr);</span><br></pre></td></tr></table></figure>



<p>åœ¨ <code>_Unwind_GetPtr</code> ä¸­çš„è°ƒç”¨æ˜¯å°† <code>fs-&gt;retaddr_column</code> ä½œä¸º <code>index</code> ä» <code>context-&gt;reg[]</code> æ•°ç»„ä¸­å–å€¼ã€‚é€šè¿‡è°ƒè¯•å‘ç° <code>fs-&gt;retaddr_column</code> ä¸€ç›´æ˜¯ <code>0x10</code>ï¼ˆ<code>reg[0x10]</code> æ˜¯ <code>RIP</code>ï¼‰ã€‚æ‰€ä»¥æ¯ä¸€è½® <code>uw_update_context</code> æ›´æ–°çš„ <code>context-&gt;ra</code> éƒ½æºäºè¢«åˆ·æ–°åçš„ <code>context-&gt;reg[RIP]</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> *</span><br><span class="line">_Unwind_GetPtr (<span class="keyword">struct</span> _Unwind_Context *context, <span class="type">int</span> index)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">void</span> *)(_Unwind_Ptr) _Unwind_GetGR (context, index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">_Unwind_GetGR (<span class="keyword">struct</span> _Unwind_Context *context, <span class="type">int</span> regno)</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">    index = DWARF_REG_TO_UNWIND_COLUMN (regno);</span><br><span class="line">    val = context-&gt;reg[index];</span><br><span class="line">    <span class="keyword">return</span> _Unwind_Get_Unwind_Word (val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è°ƒè¯•å¦‚ä¸‹ï¼Œæ­¤æ—¶çš„ <code>context-&gt;reg[0x10]</code> å·²ç»åˆ·æ–°ï¼Œä½†è¿˜æ²¡æœ‰èµ‹å€¼ç»™ <code>context-&gt;ra</code>ã€‚</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20250111231122844.png" alt="image-20250111231122844"></p>
<p>åœ¨è¿™é‡Œå·²ç»èƒ½çœ‹åˆ° <code>context-&gt;reg[0x10]</code> ç»è¿‡ä¸€æ¬¡è§£å¼•ç”¨åæ›´æ–°ç»™äº† <code>context-&gt;ra</code>ã€‚</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20250111231200125.png" alt="image-20250111231200125"></p>
<h4 id="uw-frame-state-forå‡½æ•°"><a href="#uw-frame-state-forå‡½æ•°" class="headerlink" title="uw_frame_state_forå‡½æ•°"></a>uw_frame_state_forå‡½æ•°</h4><p><code>uw_frame_state_for</code> å‡½æ•°ï¼ˆå®šä¹‰åœ¨ <code>libgcc/unwind-dw2.c</code>ï¼‰çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯æ ¹æ® <code>DWARF</code> è°ƒè¯•ä¿¡æ¯ï¼ˆCIE å’Œ FDEï¼‰ï¼Œè§£ææ ˆå¸§çš„çŠ¶æ€ä¿¡æ¯ï¼ˆåœ¨ç¼–è¯‘åå°±å·²ç»å›ºå®šï¼‰ï¼Œå¯¹ <code>fs</code> ç»“æ„ä½“è¿›è¡Œèµ‹å€¼ã€‚ <code>cur_context</code> çš„æ›´æ–°å¹¶ä¸åœ¨è¯¥å‡½æ•°ã€‚è¯¥å‡½æ•°å…ˆé€šè¿‡ <code>_Unwind_Find_FDE</code> æŸ¥æ‰¾ <code>FDE</code> ï¼Œå†æ ¹æ® <code>FDE</code> æ‰¾åˆ° <code>CIE</code> ã€‚å¯¹äºè¿™ä¸ªå‡½æ•°æˆ‘ä»¬åªéœ€è¦ææ¸…æ¥šç¨‹åºæ˜¯æ€ä¹ˆåˆ¤æ–­å‡ºå½“å‰å¸§éœ€è¦è¿›å…¥ <code>persionaly</code> å‡½æ•°çš„å³å¯ï¼Œè‡³äº <code>FDE</code> å’Œ <code>CIE</code> æ˜¯æ€ä¹ˆè¢«æ‰¾åˆ°çš„ä»¥åŠ <code>fs</code> ç»“æ„ä½“å¦‚ä½•å€ŸåŠ©å®ƒä»¬è¿˜åŸå„å­—æ®µä¿¡æ¯ï¼Œè¿™äº›å¹¶ä¸é‡è¦ã€‚å› ä¸º <code>fs</code> ç»“æ„ä½“æœ¬èº«å°±æ˜¯ä¸ºäº†æ¢å¤ <code>cur_context</code> æœåŠ¡çš„ï¼Œå…³æ³¨å¦‚ä½•æ¢å¤ <code>cur_context</code> å¹¶å‘ä¸Šçº§å‡½æ•°å›æº¯æ‰æ˜¯æœ¬æ–‡è¦è®°å½•çš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> _Unwind_Reason_Code</span><br><span class="line"><span class="title function_">uw_frame_state_for</span> <span class="params">(<span class="keyword">struct</span> _Unwind_Context *context, _Unwind_FrameState *fs)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dwarf_fde</span> *<span class="title">fde</span>;</span></span><br><span class="line">  <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dwarf_cie</span> *<span class="title">cie</span>;</span></span><br><span class="line">  <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *aug, *insn, *end;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span> (fs, <span class="number">0</span>, <span class="keyword">sizeof</span> (*fs));</span><br><span class="line">  context-&gt;args_size = <span class="number">0</span>;</span><br><span class="line">  context-&gt;lsda = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (context-&gt;ra == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> _URC_END_OF_STACK;</span><br><span class="line"></span><br><span class="line">  fde = _Unwind_Find_FDE (context-&gt;ra + _Unwind_IsSignalFrame (context) - <span class="number">1</span>,</span><br><span class="line">			  &amp;context-&gt;bases);</span><br><span class="line">......</span><br><span class="line">  fs-&gt;pc = context-&gt;bases.func;</span><br><span class="line">  cie = get_cie (fde);</span><br><span class="line">  insn = extract_cie_info (cie, context, fs);</span><br><span class="line">......</span><br><span class="line">  <span class="keyword">return</span> _URC_NO_REASON;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>åœ¨ <code>extract_cie_info</code> å‡½æ•°ä¸­è·å–äº† <code>CIE</code> çš„ <code>Augmentation</code> å­—æ®µï¼Œä»¥éå† <code>Augmentation</code> çš„æ–¹å¼åˆ¤æ–­é‡Œé¢æ˜¯å¦å«æœ‰å­—ç¬¦ <code>P</code>ï¼Œå¦‚æœå­˜åœ¨ <code>P</code> åˆ™è¡¨ç¤ºå½“å‰å‡½æ•°ä¸­å­˜åœ¨ <code>cleanup</code> æˆ–è€… <code>catch</code>ï¼Œå°† <code>personality</code> å‡½æ•°æŒ‡é’ˆèµ‹å€¼ç»™ <code>fs</code> ç»“æ„ä½“é‡Œé¢çš„ <code>personality</code> å­—æ®µã€‚ </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *</span><br><span class="line"><span class="title function_">extract_cie_info</span> <span class="params">(<span class="type">const</span> <span class="keyword">struct</span> dwarf_cie *cie, <span class="keyword">struct</span> _Unwind_Context *context,</span></span><br><span class="line"><span class="params">		  _Unwind_FrameState *fs)</span>&#123;</span><br><span class="line">     <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *aug = cie-&gt;augmentation;</span><br><span class="line">     ......</span><br><span class="line">       <span class="keyword">while</span> (*aug != <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    ......</span><br><span class="line">     <span class="keyword">else</span> <span class="keyword">if</span> (aug[<span class="number">0</span>] == <span class="string">&#x27;P&#x27;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  _Unwind_Ptr personality;</span><br><span class="line"></span><br><span class="line">	  p = read_encoded_value (context, *p, p + <span class="number">1</span>, &amp;personality);</span><br><span class="line">	  fs-&gt;personality = (_Unwind_Personality_Fn) personality;</span><br><span class="line">	  aug += <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">           ......</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ä½¿ç”¨å‘½ä»¤ <code>readelf --debug-dump=frames ./unwind</code> å¯ä»¥è¾“å‡ºç¨‹åºçš„ <code>CIE</code> å’Œ <code>FDE</code>ã€‚ä»¥ <code>unwind</code> ç¨‹åºä¸ºä¾‹ï¼Œä¸‹å›¾å±•ç¤ºäº†éƒ¨åˆ† <code>CIE</code> <code>FDE</code>ã€‚å…¶ä¸­åœ°å€åŒºé—´ <code>0x401216-0x4012a5</code> ä¸ <code>0x4012f8-0x401371</code>ä¸¤ä¸ª <code>FDE</code> å¯¹åº”éƒ½æ˜¯åç§»ä¸º <code>0x80</code> çš„ <code>CIE</code> ã€‚è¯¥ <code>CIE</code> çš„ <code>Augmentation</code> å­—æ®µå«æœ‰ <code>P</code>ï¼Œå†é€šè¿‡ <code>IDA</code> è§‚å¯Ÿä¸Šé¢æåˆ°çš„ä¸¤ä¸ªåŒºé—´ï¼Œå‘ç°éƒ½åŒ…å« <code>catch</code>ã€‚</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20250111222742873.png" alt="image-20250111222742873"></p>
<p>å‘ç° <code>CIE</code> ä¸­è®°å½•äº† <code>P</code> åï¼Œå°† <code>personality</code> å‡½æ•°æŒ‡é’ˆèµ‹å€¼ã€‚å›åˆ° <code>_Unwind_RaiseException</code> å‡½æ•°ï¼Œåœ¨æ‰§è¡Œ <code>uw_update_context</code> ä¹‹å‰åˆ¤æ–­äº† <code>fs.personality</code> æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨çš„è¯ï¼Œå°±è°ƒç”¨ <code>fs.personality</code> å‡½æ•°æŒ‡é’ˆã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">   &#123;</span><br><span class="line">     _Unwind_FrameState fs;</span><br><span class="line">     code = uw_frame_state_for (&amp;cur_context, &amp;fs);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (code == _URC_END_OF_STACK)</span><br><span class="line"><span class="keyword">return</span> _URC_END_OF_STACK;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (code != _URC_NO_REASON)</span><br><span class="line"><span class="keyword">return</span> _URC_FATAL_PHASE1_ERROR;</span><br><span class="line">     <span class="keyword">if</span> (fs.personality)</span><br><span class="line">&#123;</span><br><span class="line">  code = (*fs.personality) (<span class="number">1</span>, _UA_SEARCH_PHASE, exc-&gt;exception_class,</span><br><span class="line">			    exc, &amp;cur_context);</span><br><span class="line">  <span class="keyword">if</span> (code == _URC_HANDLER_FOUND)</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (code != _URC_CONTINUE_UNWIND)</span><br><span class="line">    <span class="keyword">return</span> _URC_FATAL_PHASE1_ERROR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* Update cur_context to describe the same frame as fs.  */</span></span><br><span class="line">     uw_update_context (&amp;cur_context, &amp;fs);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<p>å½“è¦æ›´æ–°ï¼ˆä½†è¿˜æœªæ›´æ–°ï¼‰çš„å‡½æ•°ä¸­å­˜åœ¨ <code>cleanup</code> å’Œ <code>handler</code>ï¼ˆé€šè¿‡ <code>FDE</code> æ‰¾åˆ° <code>CIE</code> ï¼Œåˆ¤æ–­ <code>CIE</code> ä¸­çš„ <code>Augmentation</code> å­—æ®µæ¥å®ç°çš„ï¼‰æ—¶ï¼Œä¼šåœ¨æ‰§è¡Œ <code>uw_update_context</code> ä¹‹å‰å…ˆè¿›å…¥ <code>personality</code> å‡½æ•°ã€‚è‡³æ­¤åˆåˆ°äº†æ–‡ç« å¼€å¤´è®¨è®ºåŒºé—´æ—¶åˆ†æçš„ <code>__gxx_personality_v0</code> å‡½æ•°ï¼Œç®€å•æ¥è¯´ï¼Œ<code>__gxx_personality_v0</code> é€šè¿‡è§£æ <code>LSDA</code> ä¸­çš„æ•°æ®æ‰§è¡Œä¸åŒçš„åˆ†æ”¯è¿›è¡Œåˆ¤æ–­å­˜åœ¨çš„æ˜¯ <code>cleanup</code> è¿˜æ˜¯ <code>handler</code>ã€‚</p>
<h4 id="è§£æ-gcc-except-tableä¸­æ•°æ®"><a href="#è§£æ-gcc-except-tableä¸­æ•°æ®" class="headerlink" title="è§£æ.gcc_except_tableä¸­æ•°æ®"></a>è§£æ.gcc_except_tableä¸­æ•°æ®</h4><p><code>.gcc_except_table</code> ä¸­å­˜æ”¾çš„æ˜¯ <code>LSDA</code> ã€‚<code>LSDA</code> ç”±å››éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯ <code>LSDA Header</code> <code>Call-Site Table</code> <code>Action Table</code> <code>Type Table</code>ï¼Œç»“æ„å¦‚ä¸‹ï¼ˆå›¾ç‰‡æ¥æºäºç½‘ç»œï¼‰ã€‚</p>
<img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20250116235734353.png" alt="image-20250116235734353" style="zoom: 50%;" />

<p>æˆ‘æ²¡æœ‰ä»ç½‘ä¸Šæ‰¾åˆ°æœ‰å¾ˆè¯¦ç»†çš„èµ„æ–™å¯¹ä¸€ç»„å®é™…çš„ <code>LSDA</code> åŸæ•°æ®è¿›è¡Œè§£æï¼Œå°½ç®¡åœ¨è¿™ä¸ª <a target="_blank" rel="noopener" href="http://www.hexblog.com/wp-content/uploads/2012/06/Recon-2012-Skochinsky-Compiler-Internals.pdf">PDF</a> ä¸­44é¡µå¼€å§‹æœ‰ä»‹ç» <code>LSDA</code> ä¸­å„å­—æ®µï¼Œä½†ä¸å®é™…åˆ†æä¸€ä¸ª <code>LSDA</code> æ•°æ®ä¾ç„¶äº‘é‡Œé›¾é‡Œã€‚å› æ­¤æˆ‘åˆ†æäº† <code>parse_lsda_header</code> å’Œ <code>__gxx_personality_v0</code> é‡Œé¢çš„ä»£ç ã€‚ä¸‹é¢æ¥ç»“åˆæºç ï¼Œè®©æˆ‘ä»¬ææ¸…æ¥šè¿™äº›åŸæ•°æ®æ˜¯æ€ä¹ˆå¸®åŠ© <code>personality</code> å‡½æ•°å·¥ä½œçš„ã€‚</p>
<p>ä»¥ä¸Šæ–‡ç¼–è¯‘çš„ <code>unwind</code> ç¨‹åºä¸ºä¾‹ï¼Œ<code>LSDA</code> åŸæ•°æ®å¦‚ä¸‹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">readelf -x .gcc_except_table ./unwind</span><br><span class="line">Hex dump of section &#x27;.gcc_except_table&#x27;:</span><br><span class="line">  0x00402230 ff9b1901 111c0523 01300500 00571472 .......#.0...W.r</span><br><span class="line">  0x00402240 00840105 00000100 c81d0000 ff9b1901 ................</span><br><span class="line">  0x00402250 100d1428 01350500 0050055c 006e0500 ...(.5...P.\.n..</span><br><span class="line">  0x00402260 00010000 ac1d0000                   ........</span><br></pre></td></tr></table></figure>

<p>ä» <code>__gxx_personality_v0</code> å‡½æ•°å¼€å§‹çœ‹ï¼Œå…¶ä¸­æœ‰ä¸€è¡Œä»£ç  <code> p = parse_lsda_header (context, language_specific_data, &amp;info);</code>ï¼Œåœ¨ <code>parse_lsda_header</code> å‡½æ•°ä¸­å¯¹ä¸€äº›å­—æ®µè¿›è¡Œäº†è§£æï¼Œ<code>language_specific_data</code> å°±æ˜¯ <code>LSDA</code> çš„èµ·å§‹åœ°å€ï¼ˆ0x402230ï¼‰ã€‚</p>
<p>ä¸‹é¢æ˜¯ <code>parse_lsda_header</code> æºä»£ç ï¼Œç¬¬å…«è¡Œ <code> lpstart_encoding = *p++;</code> ä» <code>LSDA</code> ä¸­å–äº†ä¸€ä¸ªå­—èŠ‚èµ‹å€¼ç»™å˜é‡ <code>lpstart_encoding</code>ï¼Œå®ƒçš„å«ä¹‰æ˜¯ <code>Landing Pad</code> èµ·å§‹åœ°å€çš„ç¼–ç æ–¹å¼ã€‚å¦‚æœè¯¥å€¼ä¸æ˜¯ <code>0xff</code> é‚£ä¹ˆä¼šå†è¯»å–æ•°æ®ï¼Œä½œä¸º <code>info-&gt;LPStart</code>ï¼ˆ<code>Landing Pad</code> èµ·å§‹åœ°å€ï¼‰ã€‚ä½†ä»ä¾‹å­çš„åŸå§‹æ•°æ®æ¥çœ‹ï¼Œè¯»å–çš„æ˜¯ <code>0xff</code>ï¼Œæ‰€ä»¥ <code>info-&gt;LPStart</code> æ˜¯è°ƒç”¨ <code>_Unwind_GetRegionStar</code> å‡½æ•°è·å¾—çš„ã€‚æ¥ç€è¯»å–ä¸€ä¸ªå­—èŠ‚ä½œä¸º <code>info-&gt;ttype_encoding</code>ï¼Œå®ƒæ˜¯ <code>Type table</code> çš„ç¼–ç æ–¹å¼ã€‚å¦‚æœè¯¥å€¼ä¸æ˜¯ <code>0xff</code> é‚£ä¹ˆ <code>info-&gt;TType</code> å†ä»åŸå§‹æ•°æ®è¯»å–ä¸€ä¸ª <code>uleb128</code> å€¼ï¼ˆ0x19ï¼‰  å†åŠ ä¸Šå½“å‰æŒ‡é’ˆï¼ˆ0x402233ï¼‰ï¼Œä¹Ÿå°±æ˜¯ <code>0x40224C</code> ï¼Œ<code>info-&gt;TType</code> ä»£è¡¨ <code>Type table</code> çš„èµ·å§‹åœ°å€ã€‚å†è¯»å–ä¸€ä¸ªå­—èŠ‚ï¼ˆ0x01ï¼‰ä½œä¸º <code>info-&gt;call_site_encoding</code>ï¼Œå®ƒè¡¨ç¤º <code>call_site Table</code> çš„ç¼–ç æ–¹å¼ï¼Œæœ€åå†è¯»å–ä¸€ä¸ª <code>uleb128</code> æ•°æ®ï¼ˆ0x11ï¼‰åŠ ä¸Šå½“å‰æŒ‡é’ˆï¼ˆ0x402235ï¼‰ï¼Œä¹Ÿå°±æ˜¯ <code>0x402246</code>ï¼Œ<code>info-&gt;action_table</code> ä»£è¡¨ <code>action_table</code> çš„èµ·å§‹åœ°å€ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *</span><br><span class="line"><span class="title function_">parse_lsda_header</span> <span class="params">(_Unwind_Context *context, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *p,</span></span><br><span class="line"><span class="params">		   lsda_header_info *info)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">_uleb128_t</span> tmp;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> lpstart_encoding;</span><br><span class="line">  info-&gt;Start = (context ? _Unwind_GetRegionStart (context) : <span class="number">0</span>);</span><br><span class="line">  lpstart_encoding = *p++;</span><br><span class="line">  <span class="keyword">if</span> (lpstart_encoding != DW_EH_PE_omit)</span><br><span class="line">    p = read_encoded_value (context, lpstart_encoding, p, &amp;info-&gt;LPStart);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    info-&gt;LPStart = info-&gt;Start;</span><br><span class="line">  info-&gt;ttype_encoding = *p++;</span><br><span class="line">  <span class="keyword">if</span> (info-&gt;ttype_encoding != DW_EH_PE_omit)</span><br><span class="line">    &#123;</span><br><span class="line">      p = read_uleb128 (p, &amp;tmp);</span><br><span class="line">      info-&gt;TType = p + tmp;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    info-&gt;TType = <span class="number">0</span>;</span><br><span class="line">  info-&gt;call_site_encoding = *p++;</span><br><span class="line">  p = read_uleb128 (p, &amp;tmp);</span><br><span class="line">  info-&gt;action_table = p + tmp;</span><br><span class="line">  <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ€»ç»“ä¸€ä¸‹ä¸Šé¢çš„ä»£ç ï¼Œä¾æ¬¡è§£æäº† <code>LSDA Header</code> ä¸­çš„ Landing Padèµ·å§‹åœ°å€ç¼–ç æ–¹å¼ã€Landing Padèµ·å§‹åœ°å€ã€Type Tableç¼–ç æ–¹å¼ã€Type Tableèµ·å§‹åç§»ã€Call-Site Tableç¼–ç æ–¹å¼ã€Call-Site Tableé•¿åº¦ã€‚<strong>æ³¨æ„ï¼šèµ·å§‹åç§»æŒ‡çš„æ˜¯ <code>LSDA</code> ä¸­åŸå§‹æ•°æ®è¯¥å­—æ®µè§£æçš„å€¼ï¼Œè€Œèµ·å§‹åœ°å€è¡¨ç¤ºæºç ä¸­å·²ç»å°†åŸºåœ°å€æŒ‡é’ˆ <code>p</code> å’Œåç§»ç›¸åŠ åçš„å€¼ã€‚</strong></p>
<p>æ ¹æ®ä¸Šé¢åˆ†æå¾—å‡ºï¼Œ <code>LSDA</code> åŸå§‹æ•°æ®ä¸­ <code>LSDA Header</code> æ˜¯ <code>FF 9B 19 01 11</code>ã€‚</p>
<table>
<thead>
<tr>
<th>å­—èŠ‚</th>
<th>å­—æ®µåç§°</th>
<th>å€¼</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td><code>0xFF</code></td>
<td>Landing Padèµ·å§‹åœ°å€ç¼–ç æ–¹å¼</td>
<td><code>DW_EH_PE_omit</code></td>
<td>Landing Pad èµ·å§‹åœ°å€çœç•¥ï¼Œéœ€é€šè¿‡ <code>_Unwind_GetRegionStart()</code> è·å–</td>
</tr>
<tr>
<td><code>0x9B</code></td>
<td>Type Table ç¼–ç æ–¹å¼</td>
<td><code>DW_EH_PE_sdata4</code></td>
<td>Type Table çš„åç§»é‡ä¸º 4 å­—èŠ‚çš„æœ‰ç¬¦å·æ•´æ•°</td>
</tr>
<tr>
<td><code>0x19</code></td>
<td>Type Tableèµ·å§‹åç§»</td>
<td><code>0x19</code></td>
<td>Type Tableèµ·å§‹åç§»åŠ ä¸ŠpæŒ‡é’ˆä¸ºType Tableåœ¨LSDAä¸­åœ°å€</td>
</tr>
<tr>
<td><code>0x01</code></td>
<td>Call-Site Tableç¼–ç æ–¹å¼</td>
<td><code>DW_EH_PE_uleb128</code></td>
<td>Call-Site Table ä½¿ç”¨ ULEB128 ç¼–ç ã€‚</td>
</tr>
<tr>
<td><code>0x11</code></td>
<td>Call-Site Tableé•¿åº¦</td>
<td><code>0x11</code></td>
<td>Call-Site Tableé•¿åº¦åŠ ä¸ŠpæŒ‡é’ˆï¼Œå°±å¯ä»¥å®šä½åˆ°action table</td>
</tr>
</tbody></table>
<p>åœ¨ <code>LSDA Header</code> ä¹‹åçš„æ˜¯ <code>Call-Site Table</code>ï¼Œ<code>Call-Site Table</code> ç”±å¤šä¸ª <code>Call-Site Entry</code> ç»„æˆï¼Œæ¯ä¸ª <code>Call-Site Entry</code> åˆç”± <code>cs_start</code> <code>cs_len</code> <code>cs_lp</code> <code>cs_action</code> å››ä¸ªå­—æ®µç»„æˆã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">p = read_encoded_value (<span class="number">0</span>, info.call_site_encoding, p, &amp;cs_start);</span><br><span class="line">p = read_encoded_value (<span class="number">0</span>, info.call_site_encoding, p, &amp;cs_len);</span><br><span class="line">p = read_encoded_value (<span class="number">0</span>, info.call_site_encoding, p, &amp;cs_lp);</span><br><span class="line">p = read_uleb128 (p, &amp;cs_action);</span><br></pre></td></tr></table></figure>



<p>åœ¨ <code>call_site_encoding</code> ä¸­è¡¨ç¤º <code>Call-Site Table</code> é‡Œé¢çš„æ•°æ®ä½¿ç”¨ <code>ULEB128</code> ç¼–ç ï¼Œå·²çŸ¥ <code>Call-Site Table</code> çš„æ€»é•¿åº¦ä¸º <code>0x11</code> å­—èŠ‚ï¼Œæ•°æ®ä¸º <code>1c 05 23 01 30 05 00 00 57 14 72 00 84 01 05 00 00</code>ã€‚ä¸‹é¢åˆ†ç»„ä¸­çš„ <code>Entry 4</code> çš„ <code>cs_start</code> ä¸º <code>84 01</code> çš„åŸå› æ˜¯ <code>0x84</code> çš„æ§åˆ¶ä½æ˜¯ <code>1</code>ï¼Œè¡¨ç¤º <code>ULEB128</code> ç¼–ç è¿˜æ²¡æœ‰ç»“æŸï¼Œéœ€è¦ç»§ç»­è¯»å–ä¸‹ä¸€ä¸ªå­—èŠ‚ï¼Œå°½ç®¡ <code>84 01</code> è¡¨ç¤ºçš„è¿˜æ˜¯ <code>0x84</code>ğŸ˜…ã€‚</p>
<table>
<thead>
<tr>
<th>Call-Site Entry</th>
<th>cs_start</th>
<th>cs_len</th>
<th>cs_lp</th>
<th>cs_action</th>
</tr>
</thead>
<tbody><tr>
<td>Entry 1</td>
<td>1c</td>
<td>05</td>
<td>23</td>
<td>01</td>
</tr>
<tr>
<td>Entry 2</td>
<td>30</td>
<td>05</td>
<td>00</td>
<td>00</td>
</tr>
<tr>
<td>Entry 3</td>
<td>57</td>
<td>14</td>
<td>72</td>
<td>00</td>
</tr>
<tr>
<td>Entry 4</td>
<td>84 01</td>
<td>05</td>
<td>00</td>
<td>00</td>
</tr>
</tbody></table>
<p>ä½†éœ€è¦æ³¨æ„çš„æ˜¯ <code>ip</code> æŒ‡é’ˆå¦‚æœè½åœ¨äº†ä¸€ç»„ <code>Entry</code> ä¸­ï¼Œé‚£ä¹ˆå°±ä¸ä¼šå†è§£æåé¢å‡ ç»„ <code>Entry</code>äº†ã€‚æŒ‡é’ˆå¦‚æœä¸ä¾æ¬¡ç§»åŠ¨ï¼Œå¦‚ä½•æ‰¾åˆ° <code>LSDA</code> ä¸­çš„ <code>action table</code> å‘¢ï¼Ÿå› ä¸ºçŸ¥é“ <code>Call-Site Table</code> çš„é•¿åº¦ï¼Œè€Œ <code>action table</code> å°±åœ¨ <code>Call-Site Table</code> ä¹‹åã€‚ å…·ä½“ä»£ç ä¸º <code>action_record = info.action_table + cs_action - 1</code> è®°å½•äº† <code>action_table</code> çš„ä½ç½®ï¼Œä»ä¸Šé¢åŸå§‹æ•°æ®æ¥çœ‹ï¼Œç¬¬ä¸€ç»„è§£æçš„ <code>cs_action</code> ä¸º <code>1</code>ï¼Œå› æ­¤ <code>LSDA Header</code> ä¸­çš„ <code>action_table(0x402246)</code> å°±ä½œä¸º <code>action_table</code> çš„èµ·å§‹åœ°å€ã€‚</p>
<p>ä¸‹é¢ç”¨ <code>p = action_record</code> ç›´æ¥è·³è¿‡äº†å‰©ä½™çš„ <code>Call-Stie Entry</code>ï¼Œä¾æ¬¡è§£æäº†ä¸¤ä¸ª <code>sleb128</code> ç¼–ç æ•°æ®ä½œä¸º <code>action table</code> ä¸­çš„å­—æ®µ <code>ar_filter</code> <code>ar_disp</code>ã€‚å½“ <code>ar_filter</code> ä¸º <code>0</code> ä»£è¡¨å½“å‰å‡½æ•°å­˜åœ¨çš„æ˜¯ <code>cleanup</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">p = action_record;</span><br><span class="line">p = read_sleb128 (p, &amp;ar_filter);</span><br><span class="line">read_sleb128 (p, &amp;ar_disp);</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>ar_filter</th>
<th>ar_disp</th>
</tr>
</thead>
<tbody><tr>
<td>01</td>
<td>c8</td>
</tr>
</tbody></table>
<p>åœ¨æœ¬ä¾‹ä¸­ <code>ar_filter</code> ä¸º <code>1</code>ï¼Œé‚£ä¹ˆä¼šæ‰§è¡Œ <code>catch_type = get_ttype_entry (&amp;info, ar_filter)</code> å‡½æ•°ã€‚<code>size_of_encoded_value (info-&gt;ttype_encoding)</code> çš„è¿”å›å€¼ä¸º <code>4</code>ï¼Œå› æ­¤è¿™é‡Œæœ€åçš„ <code>i</code> ä¸º <code>4</code>ã€‚ä½†ä½œä¸º <code>read_encoded_value_with_base</code> å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå®ƒå°† <code>info-&gt;TType(0x40224C)</code> å‡å»äº† <code>4</code> å­—èŠ‚ã€‚è¿™é‡Œéå¸¸æœ‰æ„æ€ï¼Œå‚è€ƒä¸‹å›¾ï¼ˆæ¥è‡ª <a target="_blank" rel="noopener" href="http://www.hexblog.com/wp-content/uploads/2012/06/Recon-2012-Skochinsky-Compiler-Internals.pdf">PDF</a> 46é¡µï¼‰å‘ç° <code>TTBase</code> æŒ‡å‘çš„å¹¶ä¸æ˜¯ <code>type table</code> çš„èµ·å§‹åœ°å€ï¼Œå¿…é¡»è¦å†å‡å»ä¸€ä¸ª <code>i</code>ã€‚ </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="built_in">std</span>::type_info *</span><br><span class="line"><span class="title function_">get_ttype_entry</span> <span class="params">(lsda_header_info *info, <span class="type">_uleb128_t</span> i)</span></span><br><span class="line">&#123;</span><br><span class="line">  _Unwind_Ptr ptr;</span><br><span class="line">  i *= size_of_encoded_value (info-&gt;ttype_encoding);</span><br><span class="line">  read_encoded_value_with_base (</span><br><span class="line">				info-&gt;ttype_encoding,</span><br><span class="line">				info-&gt;ttype_base,</span><br><span class="line">				info-&gt;TType - i, &amp;ptr);</span><br><span class="line">  <span class="keyword">return</span> reinterpret_cast&lt;<span class="type">const</span> <span class="built_in">std</span>::type_info *&gt;(ptr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20250117005351063.png" alt="image-20250117005351063"></p>
<p>å†çœ‹ä¸€ä¸‹ç®€æ˜“ç‰ˆçš„ <code>read_encoded_value_with_base</code> å‡½æ•°ï¼Œé€šè¿‡åˆ¤æ–­ <code>info-&gt;ttype_encoding(0x9b)</code> çš„å€¼ï¼Œè¿›å…¥åˆ†æ”¯æ‰§è¡Œ <code> result = u-&gt;s4</code>ï¼Œ<code>u-&gt;s4</code> è¡¨ç¤ºä» <code>u</code> æŒ‡å‘çš„å†…å­˜åœ°å€è¯»å–å››å­—èŠ‚æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ä¸Šæ–‡æåˆ°çš„ <code>info-&gt;TType - i =&gt; 0x40224C - 4 =&gt; type tableçœŸæ­£çš„èµ·å§‹åœ°å€ 0x402248</code> ã€‚ä» <code>LSDA</code> çš„åŸå§‹æ•°æ®æ¥çœ‹ <code>0x402248</code> æŒ‡å‘çš„æ˜¯ <code>c81d0000</code> ï¼Œä»¥å°ç«¯åºæ¥è¯»å–ï¼Œå› æ­¤å®é™…å€¼ä¸º <code>0x1dc8</code>ã€‚æœ€åè¿˜æœ‰ä»£ç  <code>result += ((encoding &amp; 0x70) == DW_EH_PE_pcrel ? (_Unwind_Internal_Ptr) u : base);</code> ä¹Ÿå°±æ˜¯ <code>val</code> ä¸º <code>0x1dc8+0x402248 = 0x404010</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *</span><br><span class="line"><span class="title function_">read_encoded_value_with_base</span> <span class="params">(<span class="type">unsigned</span> <span class="type">char</span> encoding, _Unwind_Ptr base,</span></span><br><span class="line"><span class="params">			      <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *p, _Unwind_Ptr *val)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">union</span> <span class="title">unaligned</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">      <span class="type">void</span> *ptr;</span><br><span class="line">      <span class="type">unsigned</span> u2 __attribute__ ((mode (HI)));</span><br><span class="line">      <span class="type">unsigned</span> u4 __attribute__ ((mode (SI)));</span><br><span class="line">      <span class="type">unsigned</span> u8 __attribute__ ((mode (DI)));</span><br><span class="line">      <span class="type">signed</span> s2 __attribute__ ((mode (HI)));</span><br><span class="line">      <span class="type">signed</span> s4 __attribute__ ((mode (SI)));</span><br><span class="line">      <span class="type">signed</span> s8 __attribute__ ((mode (DI)));</span><br><span class="line">    &#125; __attribute__((__packed__));</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="class"><span class="keyword">union</span> <span class="title">unaligned</span> *<span class="title">u</span> =</span> (<span class="type">const</span> <span class="keyword">union</span> unaligned *) p;</span><br><span class="line">  _Unwind_Internal_Ptr result;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (encoding == DW_EH_PE_aligned)</span><br><span class="line">......</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">switch</span> (encoding &amp; <span class="number">0x0f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">......</span><br><span class="line">	<span class="keyword">case</span> DW_EH_PE_sdata4:</span><br><span class="line">	  result = u-&gt;s4;</span><br><span class="line">	  p += <span class="number">4</span>;</span><br><span class="line">	  <span class="keyword">break</span>;</span><br><span class="line">......</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="keyword">if</span> (result != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  result += ((encoding &amp; <span class="number">0x70</span>) == DW_EH_PE_pcrel</span><br><span class="line">		     ? (_Unwind_Internal_Ptr) u : base);</span><br><span class="line">	  <span class="keyword">if</span> (encoding &amp; DW_EH_PE_indirect)</span><br><span class="line">	    result = *(_Unwind_Internal_Ptr *) result;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  *val = result;</span><br><span class="line">  <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>ç”¨ <code>IDA</code> æŸ¥çœ‹åœ°å€ <code>0x404010</code>ï¼Œå‘ç°æ˜¯æŒ‡å‘å®é™…çš„ <code>typeinfo</code> å¯¹è±¡åœ°å€ï¼ˆ<code>_ZTIPKc</code>ï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ª <code>std::type_info</code> å®ä¾‹ï¼Œç”¨äºæè¿° <code>const char*</code> ç±»å‹ã€‚</p>
<p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/image-20250117010809051.png" alt="image-20250117010809051"></p>
<p>æœ‰ä»£ç  <code>get_adjusted_ptr(catch_type, throw_type,&amp;thrown_ptr)</code> ï¼Œå†æ¥çœ‹ <code>get_adjusted_ptr</code> çš„æºç ã€‚<code>throw_type</code> æŒ‡å‘æŠ›å‡ºå¼‚å¸¸ç±»å‹çš„ <code>std::type_info</code> å¯¹è±¡ï¼Œè€Œ<code>catch_type</code> æŒ‡å‘ <code>catch</code> å—æ•è·ç±»å‹çš„ <code>std::type_info</code> å¯¹è±¡ã€‚<code>__do_catch</code> æ˜¯ä¸€ä¸ªæˆå‘˜å‡½æ•°ï¼Œç”¨äºæ¯”è¾ƒ <code>throw_type</code>ï¼ˆå®é™…æŠ›å‡ºçš„å¼‚å¸¸ç±»å‹ï¼‰å’Œ <code>catch_type</code> æ˜¯å¦å…¼å®¹ã€‚å› ä¸ºåœ¨ <code>unwind</code> è¿™ä¸ªä¾‹å­ä¸­ <code>throw</code> å’Œ <code>catch</code>çš„ç±»å‹éƒ½æ˜¯ <code>const char *</code>ï¼Œæ‰€ä»¥è¿™é‡Œ <code>get_adjusted_ptr</code> ä¼šè¿”å› <code>true</code>ã€‚è¯¥å‡½æ•°ä½œç”¨æ˜¯åˆ¤æ–­æŠ›å‡ºçš„å¼‚å¸¸ç±»å‹æ˜¯å¦èƒ½åœ¨ <code>type_table</code> è®°å½•çš„å¼‚å¸¸ç±»å‹ä¿¡æ¯ä¸­åŒ¹é…ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">bool</span></span><br><span class="line"><span class="title function_">get_adjusted_ptr</span> <span class="params">(<span class="type">const</span> <span class="built_in">std</span>::type_info *catch_type,</span></span><br><span class="line"><span class="params">		  <span class="type">const</span> <span class="built_in">std</span>::type_info *throw_type,</span></span><br><span class="line"><span class="params">		  <span class="type">void</span> **thrown_ptr_p)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *thrown_ptr = *thrown_ptr_p;</span><br><span class="line">  <span class="keyword">if</span> (throw_type-&gt;__is_pointer_p ())</span><br><span class="line">    thrown_ptr = *(<span class="type">void</span> **) thrown_ptr;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (catch_type-&gt;__do_catch (throw_type, &amp;thrown_ptr, <span class="number">1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      *thrown_ptr_p = thrown_ptr;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>å› æ­¤ä¸‹é¢åˆ†æ”¯å°±ä¼šè¿›å…¥ï¼Œå°† <code>saw_handler</code> èµ‹å€¼ä¸º <code>true</code>ï¼Œå¹¶å°† <code>found_type</code> èµ‹å€¼ä¸º <code>found_handler</code>ï¼Œè¡¨ç¤ºåœ¨å½“å‰å‡½æ•°ä¸­æ‰¾åˆ°äº† <code>handler</code>ã€‚å› ä¸ºæ˜¯æœç´¢é˜¶æ®µï¼Œæ‰€ä»¥ä¼šè¿›å…¥åˆ†æ”¯ <code>if (actions &amp; _UA_SEARCH_PHASE)</code> ï¼Œ <code>foreign_exception</code> ä¸º <code>0</code>ï¼ˆåœ¨ <code>libstdc++-v3\libsupc++\unwind-cxx.h</code> æ–‡ä»¶ï¼Œå®šä¹‰äº† <code> __GXX_INIT_PRIMARY_EXCEPTION_CLASS(c) c</code> å®ï¼‰ ï¼Œå› æ­¤ <code>save_caught_exception</code> ä¼šä¿å­˜çŠ¶æ€ä¿¡æ¯ï¼Œé¿å… <code>Phase 2</code> ä¸­å†æ¬¡è§£æ <code>LSDA</code> ,æœ€åè¿”å› <code>_URC_HANDLER_FOUND</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">if</span> (! catch_type</span><br><span class="line">  || (throw_type</span><br><span class="line">      &amp;&amp; get_adjusted_ptr (catch_type, throw_type,</span><br><span class="line">               &amp;thrown_ptr)))</span><br><span class="line">&#123;</span><br><span class="line">  saw_handler = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">if</span> (saw_handler)</span><br><span class="line">	&#123;</span><br><span class="line">	  handler_switch_value = ar_filter;</span><br><span class="line">	  found_type = found_handler;</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">	found_type = (saw_cleanup ? found_cleanup : found_nothing);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> do_something:</span><br><span class="line">   <span class="keyword">if</span> (found_type == found_nothing)</span><br><span class="line">     CONTINUE_UNWINDING;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (actions &amp; _UA_SEARCH_PHASE)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (found_type == found_cleanup)</span><br><span class="line">	CONTINUE_UNWINDING;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// For domestic exceptions, we cache data from phase 1 for phase 2.</span></span><br><span class="line">      <span class="keyword">if</span> (!foreign_exception)</span><br><span class="line">        &#123;</span><br><span class="line">	  save_caught_exception(ue_header, context, thrown_ptr,</span><br><span class="line">				handler_switch_value, language_specific_data,</span><br><span class="line">				landing_pad, action_record);</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="keyword">return</span> _URC_HANDLER_FOUND;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h3 id="Phase-2"><a href="#Phase-2" class="headerlink" title="Phase 2"></a>Phase 2</h3><p>ä¸Šæ–‡æåˆ° <code>personality</code> å‡½æ•°ä¼šè¿”å› <code>_URC_HANDLER_FOUND</code>, å› æ­¤è§¦å‘ <code>break</code> è·³å‡º <code>uw_frame_state_for</code> å’Œ <code>uw_update_context</code> çš„å¾ªç¯ï¼Œæ‰§è¡Œä¸‹é¢çš„ä»£ç ã€‚å°†æ‰¾åˆ° <code>handler</code> æ—¶çš„ <code>context-&gt;CFA</code> è®°å½•åˆ° <code>exc-&gt;praivate_2</code> ä¸­, <code>phase2</code> æ ˆå›æº¯æ—¶å†æ¬¡éå†åˆ°æ­¤æ ˆå¸§æ—¶åˆ™å¯ä»¥ç›´æ¥æ‰§è¡Œçš„ <code>handler</code> å¹¶ç»“æŸå¤„ç†ã€‚é€šè¿‡ <code>_Unwind_RaiseException_Phase2</code> å’Œ <code>uw_install_context</code> ï¼ˆ_Unwind_Resumeå’Œ__cxa_begin_catchå‡½æ•°å‡æœªåˆ†æï¼‰å®Œæˆæ ˆå›é€€å¹¶æ‰§è¡Œå­˜åœ¨çš„ <code>cleanup</code>ï¼Œæœ€ç»ˆæ‰§è¡Œ <code>catch</code> ä¸­çš„ä»£ç ã€‚ </p>
 <figure class="highlight c"><table><tr><td class="code"><pre><span class="line">exc-&gt;private_1 = <span class="number">0</span>;</span><br><span class="line"> exc-&gt;private_2 = uw_identify_context (&amp;cur_context);</span><br><span class="line"> </span><br><span class="line"> cur_context = this_context;</span><br><span class="line"> code = _Unwind_RaiseException_Phase2 (exc, &amp;cur_context, &amp;frames);</span><br><span class="line"> <span class="keyword">if</span> (code != _URC_INSTALL_CONTEXT)</span><br><span class="line">   <span class="keyword">return</span> code;</span><br><span class="line"> </span><br><span class="line"> uw_install_context (&amp;this_context, &amp;cur_context, frames);</span><br></pre></td></tr></table></figure>



<p>åˆ†æ <code>_Unwind_RaiseException_Phase2</code> å‡½æ•°ï¼Œæ•´ä½“é€»è¾‘ä»ç„¶æ˜¯ä¸€ä¸ª <code>while</code> å¾ªç¯ï¼Œé‡Œé¢ç”¨ <code>uw_frame_state_for</code> å’Œ <code>uw_update_context</code> æ¥æ ˆå›é€€ã€‚ä¸Šæ–‡æåˆ°ï¼Œåœ¨ <code>Phase 1</code> ç»“æŸåè®°å½•äº†å­˜åœ¨ <code>handler</code> å‡½æ•°çš„ <code>CFA</code>ï¼Œé€šè¿‡ä»£ç  <code>match_handler = (uw_identify_context (context) == exc-&gt;private_2 ? _UA_HANDLER_FRAME : 0);</code> åˆ¤æ–­ <code>Phase 2</code> æ˜¯å¦å›æº¯åˆ°äº†æœ‰ <code>handler</code> çš„é‚£ä¸ªå‡½æ•°ã€‚ <code>match_handler</code> è¢«èµ‹å€¼ä¸åŒï¼Œä¼šå¯¼è‡´åœ¨è°ƒç”¨ <code>personality</code> å‡½æ•°æ—¶èµ°çš„åˆ†æ”¯ä¸åŒã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> _Unwind_Reason_Code</span><br><span class="line">_Unwind_RaiseException_Phase2(<span class="keyword">struct</span> _Unwind_Exception *exc,</span><br><span class="line">			      <span class="keyword">struct</span> _Unwind_Context *context,</span><br><span class="line">			      <span class="type">unsigned</span> <span class="type">long</span> *frames_p)</span><br><span class="line">&#123;</span><br><span class="line">  _Unwind_Reason_Code code;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> frames = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      _Unwind_FrameState fs;</span><br><span class="line">      <span class="type">int</span> match_handler;</span><br><span class="line"></span><br><span class="line">      code = uw_frame_state_for (context, &amp;fs);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Identify when we&#x27;ve reached the designated handler context.  */</span></span><br><span class="line">      match_handler = (uw_identify_context (context) == exc-&gt;private_2</span><br><span class="line">		       ? _UA_HANDLER_FRAME : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (code != _URC_NO_REASON)</span><br><span class="line">	<span class="comment">/* Some error encountered.  Usually the unwinder doesn&#x27;t</span></span><br><span class="line"><span class="comment">	   diagnose these and merely crashes.  */</span></span><br><span class="line">	<span class="keyword">return</span> _URC_FATAL_PHASE2_ERROR;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Unwind successful.  Run the personality routine, if any.  */</span></span><br><span class="line">      <span class="keyword">if</span> (fs.personality)</span><br><span class="line">	&#123;</span><br><span class="line">	  code = (*fs.personality) (<span class="number">1</span>, _UA_CLEANUP_PHASE | match_handler,</span><br><span class="line">				    exc-&gt;exception_class, exc, context);</span><br><span class="line">	  <span class="keyword">if</span> (code == _URC_INSTALL_CONTEXT)</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	  <span class="keyword">if</span> (code != _URC_CONTINUE_UNWIND) </span><br><span class="line">	    <span class="keyword">return</span> _URC_FATAL_PHASE2_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Don&#x27;t let us unwind past the handler context.  */</span></span><br><span class="line">      gcc_assert (!match_handler);</span><br><span class="line"></span><br><span class="line">      uw_update_context (context, &amp;fs);</span><br><span class="line">      _Unwind_Frames_Increment (context, frames);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  *frames_p = frames;</span><br><span class="line">  <span class="keyword">return</span> code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>å½“ <code>match_handler</code> æ˜¯ <code>_UA_HANDLER_FRAME</code> åˆ™ä¼šåœ¨ <code>personality</code> å‡½æ•°è·³è½¬è‡³ <code>install_context</code>ã€‚é¦–å…ˆè¿›å…¥ <code>else</code> åˆ†æ”¯ï¼Œå› ä¸º <code>handler_switch_value</code> åœ¨è·³è½¬è‡³ <code>install_context</code> ä¹‹å‰æ‰§è¡Œäº† <code>restore_caught_exception</code> æ¢å¤äº† <code>Phase 1</code> æ‰¾åˆ° <code>handler</code> æ—¶çš„ä¸€äº›æ•°æ®ï¼Œä¾ç„¶æ˜¯ <code>unwind</code> çš„ä¾‹å­ï¼Œè¿™é‡Œ <code>handler_switch_value</code> å€¼ä¸º <code>1</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"> install_context:</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> ((actions &amp; _UA_FORCE_UNWIND)</span><br><span class="line">      || foreign_exception)</span><br><span class="line">    &#123;......&#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (found_type == found_terminate)</span><br><span class="line">	__cxa_call_terminate(ue_header);</span><br><span class="line">      <span class="keyword">if</span> (handler_switch_value &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  parse_lsda_header (context, language_specific_data, &amp;info);</span><br><span class="line">	  info.ttype_base = base_of_encoded_value (info.ttype_encoding,</span><br><span class="line">						   context);</span><br><span class="line">......</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  _Unwind_SetGR (context, __builtin_eh_return_data_regno (<span class="number">0</span>),</span><br><span class="line">		 __builtin_extend_pointer (ue_header));</span><br><span class="line">  _Unwind_SetGR (context, __builtin_eh_return_data_regno (<span class="number">1</span>),</span><br><span class="line">		 handler_switch_value);</span><br><span class="line">  _Unwind_SetIP (context, landing_pad);</span><br><span class="line">  <span class="keyword">return</span> _URC_INSTALL_CONTEXT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>_Unwind_SetGR</code> å‡½æ•°é€šè¿‡ä¸‹é¢ä»£ç ï¼Œæ›´æ–°äº† <code>context-&gt;reg[0]</code> å’Œ <code>context-&gt;reg[1]</code> å¯„å­˜å™¨çš„å€¼ã€‚<code>_Unwind_SetIP</code> åˆ™å°† <code>landing_pad</code> (landing_padçš„ç”Ÿæˆæ–¹å¼æ˜¯info.LPStart + cs_lpï¼ŒæŒ‡å‘catchçš„ä»£ç )æ›´æ–°æˆ <code>context-&gt;ra</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ptr = (<span class="type">void</span> *) (_Unwind_Internal_Ptr) context-&gt;reg[index];</span><br><span class="line">* (_Unwind_Ptr *) ptr = val;</span><br></pre></td></tr></table></figure>

<p><code>personality</code> å‡½æ•°æ‰§è¡Œç»“æŸåï¼Œé€šè¿‡ <code>break</code> è·³å‡ºäº†æ ˆå›é€€çš„ä»£ç ã€‚è‡³æ­¤ <code>_Unwind_RaiseException_Phase2</code> å‡½æ•°ä¹Ÿè¿”å› <code>_URC_INSTALL_CONTEXT</code>ã€‚</p>
<p><code>uw_install_context</code> ä½œä¸ºå®å®šä¹‰åœ¨ <code>unwind-dw2.c</code> æ–‡ä»¶ï¼Œæœ€ç»ˆæ”¹å˜æ‰§è¡Œæµçš„æ˜¯ <code> __builtin_eh_return (offset, handler)</code>ï¼Œé€šè¿‡ <code>handler+offset</code> æ”¹å˜  <code>PC</code> ä»è€Œä½¿æ‰§è¡Œæµè½¬åˆ°å¼‚å¸¸å¤„ç†ä»£ç ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> uw_install_context(CURRENT, TARGET, FRAMES)			\</span></span><br><span class="line"><span class="meta">  do									\</span></span><br><span class="line"><span class="meta">    &#123;									\</span></span><br><span class="line"><span class="meta">      long offset = uw_install_context_1 ((CURRENT), (TARGET));		\</span></span><br><span class="line"><span class="meta">      void *handler = __builtin_frob_return_addr ((TARGET)-&gt;ra);	\</span></span><br><span class="line"><span class="meta">      _Unwind_DebugHook ((TARGET)-&gt;cfa, handler);			\</span></span><br><span class="line"><span class="meta">      _Unwind_Frames_Extra (FRAMES);					\</span></span><br><span class="line"><span class="meta">      __builtin_eh_return (offset, handler);				\</span></span><br><span class="line"><span class="meta">    &#125;									\</span></span><br><span class="line"><span class="meta">  while (0)</span></span><br></pre></td></tr></table></figure>





<h3 id="é›¶é›¶æ•£æ•£çš„è¡¥å……"><a href="#é›¶é›¶æ•£æ•£çš„è¡¥å……" class="headerlink" title="é›¶é›¶æ•£æ•£çš„è¡¥å……"></a>é›¶é›¶æ•£æ•£çš„è¡¥å……</h3><h4 id="LSDA-CIE-FDEå‚»å‚»åˆ†ä¸æ¸…"><a href="#LSDA-CIE-FDEå‚»å‚»åˆ†ä¸æ¸…" class="headerlink" title="LSDA CIE FDEå‚»å‚»åˆ†ä¸æ¸…"></a>LSDA CIE FDEå‚»å‚»åˆ†ä¸æ¸…</h4><p>æœ€å¼€å§‹çœ‹ç½‘ä¸Šæ–‡ç« æ—¶ï¼Œè¿™ä¸‰ä¸ªåˆ†ä¸æ¸…ã€‚</p>
<p><strong>ä½ç½®ï¼š</strong></p>
<p><code>LSDA</code> ä½äº <code>.gcc_except_table</code>ï¼Œè€Œ <code>CIE</code> å’Œ <code>FDE</code> éƒ½ä½äº <code>.eh_frame</code>ã€‚</p>
<p><strong>ä½œç”¨ï¼š</strong></p>
<p><code>LSDA</code> çš„æ•°æ®è¾…åŠ©å¼‚å¸¸å¤„ç†çš„æ•è·å’Œç±»å‹åŒ¹é…ï¼Œè€Œ <code>CIE</code> å’Œ <code>FDE</code> ä¸»è¦ç”¨æ¥è¾…åŠ©æ ˆå±•å¼€å¹¶è¾…åŠ©æ¢å¤ <code>current_context</code> çš„ä¸Šä¸‹æ–‡æ•°æ®ã€‚</p>
<h4 id="currentå’Œfsç»“æ„ä½“åˆ†æåŠåç§»é‡è¡¨æ ¼"><a href="#currentå’Œfsç»“æ„ä½“åˆ†æåŠåç§»é‡è¡¨æ ¼" class="headerlink" title="currentå’Œfsç»“æ„ä½“åˆ†æåŠåç§»é‡è¡¨æ ¼"></a>currentå’Œfsç»“æ„ä½“åˆ†æåŠåç§»é‡è¡¨æ ¼</h4><p><code>current</code> çš„ç»“æ„ä½“ç±»å‹å®šä¹‰åœ¨ <code>libgcc/unwind-dw2.c</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">Unwind_Context</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  _Unwind_Context_Reg_Val reg[__LIBGCC_DWARF_FRAME_REGISTERS__+<span class="number">1</span>];</span><br><span class="line">  <span class="type">void</span> *cfa;</span><br><span class="line">  <span class="type">void</span> *ra;</span><br><span class="line">  <span class="type">void</span> *lsda;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">dwarf_eh_bases</span> <span class="title">bases</span>;</span></span><br><span class="line">  <span class="comment">/* Signal frame context.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGNAL_FRAME_BIT ((~(_Unwind_Word) 0 &gt;&gt; 1) + 1)</span></span><br><span class="line">  <span class="comment">/* Context which has version/args_size/by_value fields.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXTENDED_CONTEXT_BIT ((~(_Unwind_Word) 0 &gt;&gt; 2) + 1)</span></span><br><span class="line">  <span class="comment">/* Bit reserved on AArch64, return address has been signed with A or B</span></span><br><span class="line"><span class="comment">     key.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RA_SIGNED_BIT ((~(_Unwind_Word) 0 &gt;&gt; 3) + 1)</span></span><br><span class="line">  _Unwind_Word flags;</span><br><span class="line">  <span class="comment">/* 0 for now, can be increased when further fields are added to</span></span><br><span class="line"><span class="comment">     struct _Unwind_Context.  */</span></span><br><span class="line">  _Unwind_Word version;</span><br><span class="line">  _Unwind_Word args_size;</span><br><span class="line">  <span class="type">char</span> by_value[__LIBGCC_DWARF_FRAME_REGISTERS__+<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™äº›å­—æ®µéƒ½æ˜¯è°ƒè¯•ç¨‹åºæ—¶åˆ†æå‡ºæ¥çš„ï¼Œä¸ä¿è¯ä¸€å®šæ­£ç¡®ï¼Œå¹¶ä¸”ä¸€äº›å­—æ®µåœ¨åˆ†ææ—¶æ²¡æœ‰æ³¨æ„ï¼Œæš‚æ— è®°å½•ã€‚è°ƒè¯•çš„ç¨‹åºæ˜¯ <code>x64</code> æ¶æ„ã€‚ </p>
<table>
<thead>
<tr>
<th align="left">å­—æ®µ</th>
<th>å«ä¹‰</th>
<th>åç§»</th>
</tr>
</thead>
<tbody><tr>
<td align="left">reg.rax\reg.rbx\reg.rcx\reg.rdx<br />\reg.rsi\reg.rdi\reg.rbp\reg.rsp<br />\reg.r8\reg.r9\reg.r10\reg.r11<br />reg.r12\reg.r13\reg.r14\reg.r15\reg.rip</td>
<td>regæ•°ç»„é‡Œé¢çš„æˆå‘˜ä¾æ¬¡æ˜¯è¿™17ä¸ªå¯„å­˜å™¨</td>
<td>reg.raxåç§»æ˜¯0<br />reg.rbxåç§»æ˜¯0x8<br />reg.rcxåç§»æ˜¯0x10<br />ä»¥æ­¤ç±»æ¨ï¼Œæœ€åçš„reg.ripåç§»æ˜¯0x80</td>
</tr>
<tr>
<td align="left">reg.?</td>
<td>regæ•°ç»„æœ‰18ä¸ªå•å…ƒï¼Œæœ€åä¸€ä¸ªä½œç”¨æœªçŸ¥</td>
<td>reg.?åç§»æ˜¯0x88</td>
</tr>
<tr>
<td align="left">cfa</td>
<td>Canonical Frame Addressï¼Œæ ‡å‡†å¸§åœ°å€</td>
<td>0x90</td>
</tr>
<tr>
<td align="left">ra</td>
<td>å½“å‰å¸§çš„è¿”å›åœ°å€</td>
<td>0x98</td>
</tr>
<tr>
<td align="left">lsda</td>
<td>Language-Specific Data Areaï¼Œè¯­è¨€ç‰¹å®šæ•°æ®åŒº</td>
<td>0xa0</td>
</tr>
<tr>
<td align="left">bases</td>
<td></td>
<td>0xa8</td>
</tr>
<tr>
<td align="left">â€¦</td>
<td>â€¦</td>
<td>â€¦</td>
</tr>
</tbody></table>
<p><code>fs</code> çš„ç»“æ„ä½“ç±»å‹å®šä¹‰åœ¨ <code>libgcc/unwind-dw2.h</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/* Each register save state can be described in terms of a CFA slot,</span></span><br><span class="line"><span class="comment">     another register, or a location expression.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">frame_state_reg_info</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">      <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">	_Unwind_Word reg;</span><br><span class="line">	_Unwind_Sword offset;</span><br><span class="line">	<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *<span class="built_in">exp</span>;</span><br><span class="line">      &#125; loc;</span><br><span class="line">      <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">	REG_UNSAVED,</span><br><span class="line">	REG_SAVED_OFFSET,</span><br><span class="line">	REG_SAVED_REG,</span><br><span class="line">	REG_SAVED_EXP,</span><br><span class="line">	REG_SAVED_VAL_OFFSET,</span><br><span class="line">	REG_SAVED_VAL_EXP,</span><br><span class="line">	REG_UNDEFINED</span><br><span class="line">      &#125; how;</span><br><span class="line">    &#125; reg[__LIBGCC_DWARF_FRAME_REGISTERS__+<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Used to implement DW_CFA_remember_state.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">frame_state_reg_info</span> *<span class="title">prev</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The CFA can be described in terms of a reg+offset or a</span></span><br><span class="line"><span class="comment">       location expression.  */</span></span><br><span class="line">    _Unwind_Sword cfa_offset;</span><br><span class="line">    _Unwind_Word cfa_reg;</span><br><span class="line">    <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *cfa_exp;</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">      CFA_UNSET,</span><br><span class="line">      CFA_REG_OFFSET,</span><br><span class="line">      CFA_EXP</span><br><span class="line">    &#125; cfa_how;</span><br><span class="line">  &#125; regs;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The PC described by the current frame state.  */</span></span><br><span class="line">  <span class="type">void</span> *pc;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The information we care about from the CIE/FDE.  */</span></span><br><span class="line">  _Unwind_Personality_Fn personality;</span><br><span class="line">  _Unwind_Sword data_align;</span><br><span class="line">  _Unwind_Word code_align;</span><br><span class="line">  _Unwind_Word retaddr_column;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> fde_encoding;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> lsda_encoding;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> saw_z;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> signal_frame;</span><br><span class="line">  <span class="type">void</span> *eh_ptr;</span><br><span class="line">&#125; _Unwind_FrameState;</span><br></pre></td></tr></table></figure>



<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>å«ä¹‰</th>
<th>åç§»</th>
</tr>
</thead>
<tbody><tr>
<td>regs.reg[rax].loc</td>
<td>regçš„ç¬¬1ä¸ªå¯„å­˜å™¨æ˜¯raxï¼Œlocè¡¨ç¤ºæ¢å¤å¯„å­˜å™¨å€¼çš„å¿…è¦æ•°æ®</td>
<td>0</td>
</tr>
<tr>
<td>regs.reg[rax].how</td>
<td>regçš„ç¬¬1ä¸ªå¯„å­˜å™¨æ˜¯raxï¼Œhowè¡¨ç¤ºå¯„å­˜å™¨ä¿å­˜æ–¹å¼</td>
<td>0x8</td>
</tr>
<tr>
<td>regs.reg[rbx].loc</td>
<td>regçš„ç¬¬2ä¸ªå¯„å­˜å™¨æ˜¯rbxï¼Œlocè¡¨ç¤ºæ¢å¤å¯„å­˜å™¨å€¼çš„å¿…è¦æ•°æ®</td>
<td>0x10</td>
</tr>
<tr>
<td>regs.reg[rbx].how</td>
<td>regçš„ç¬¬2ä¸ªå¯„å­˜å™¨æ˜¯rbxï¼Œhowè¡¨ç¤ºå¯„å­˜å™¨ä¿å­˜æ–¹å¼</td>
<td>0x18</td>
</tr>
<tr>
<td>â€¦</td>
<td>å¯„å­˜å™¨é¡ºåºå’Œ_Unwind_Contextç»“æ„ä½“ä¸­çš„regæˆå‘˜ä¸€æ ·ï¼Œåç§»ä¹Ÿä»¥æ­¤ç±»æ¨</td>
<td>â€¦</td>
</tr>
<tr>
<td>â€¦</td>
<td>â€¦</td>
<td>â€¦</td>
</tr>
<tr>
<td>regs.reg[rip].loc</td>
<td>regçš„ç¬¬17ä¸ªå¯„å­˜å™¨æ˜¯raxï¼Œlocè¡¨ç¤ºæ¢å¤å¯„å­˜å™¨å€¼çš„å¿…è¦æ•°æ®</td>
<td>0x100</td>
</tr>
<tr>
<td>regs.reg[rip].how</td>
<td>regçš„ç¬¬17ä¸ªå¯„å­˜å™¨æ˜¯raxï¼Œhowè¡¨ç¤ºå¯„å­˜å™¨ä¿å­˜æ–¹å¼</td>
<td>0x108</td>
</tr>
<tr>
<td>regs.reg[?].loc</td>
<td>è¿™é‡Œregæ•°ç»„ä¸­çš„å•å…ƒä¹Ÿæ¯”å¯„å­˜å™¨æ•°é‡å¤š1ï¼Œå› æ­¤ä¸ç¡®å®šå¤šå‡ºæ¥çš„è¿™ä¸ªå†…å­˜å•å…ƒä½œç”¨</td>
<td>0x110</td>
</tr>
<tr>
<td>regs.reg[?].how</td>
<td>â€¦</td>
<td>0x118</td>
</tr>
<tr>
<td>regs.prev</td>
<td>æŒ‡å‘å‰ä¸€ä¸ª frame_state_reg_info ç»“æ„ä½“çš„æŒ‡é’ˆ</td>
<td>0x120</td>
</tr>
<tr>
<td>regs.cfa_offset</td>
<td>CFAæ ¹æ®cfa_regæŒ‡å®šçš„å¯„å­˜å™¨åŠ ä¸Šcfa+offsetå¾—åˆ°ï¼ˆcfa_howä¸ºCFA_REG_OFFSETæ—¶ä½¿ç”¨ï¼‰</td>
<td>0x128</td>
</tr>
<tr>
<td>regs.cfa_reg</td>
<td>CFAæ ¹æ®cfa_regæŒ‡å®šçš„å¯„å­˜å™¨åŠ ä¸Šcfa+offsetå¾—åˆ°ï¼ˆcfa_howä¸ºCFA_REG_OFFSETæ—¶ä½¿ç”¨ï¼‰</td>
<td>0x130</td>
</tr>
<tr>
<td>regs.cfa_exp</td>
<td>CFAåœ°å€è¡¨è¾¾å¼ï¼Œæè¿°äº†å¦‚ä½•è®¡ç®—å‡ºæ ˆå¸§çš„åŸºå‡†åœ°å€ï¼ˆcfa_howä¸ºCFA_EXPæ—¶ä½¿ç”¨ï¼‰</td>
<td>0x138</td>
</tr>
<tr>
<td>regs.cfa_how</td>
<td>CFAçš„ç”Ÿæˆæ–¹å¼</td>
<td>0x140</td>
</tr>
<tr>
<td>pc</td>
<td>è®°å½•ä¸‹ä¸€æ¡å³å°†æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€</td>
<td>0x148</td>
</tr>
<tr>
<td>personality</td>
<td>æŒ‡å‘å¼‚å¸¸å¤„ç†çš„ä¸ªæ€§åŒ–å‡½æ•°</td>
<td>0x150</td>
</tr>
<tr>
<td>data_align</td>
<td>æ•°æ®å¯¹é½</td>
<td>0x158</td>
</tr>
<tr>
<td>code_align</td>
<td>ä»£ç å¯¹é½</td>
<td>0x160</td>
</tr>
<tr>
<td>retaddr_column</td>
<td>è¡¨ç¤ºè¿”å›åœ°å€çš„åˆ—å·ï¼Œéœ€è¦æ ¹æ®è¯¥å­—æ®µæ¢å¤è¿”å›åœ°å€</td>
<td>0x168</td>
</tr>
<tr>
<td>fde_encoding</td>
<td>FDEçš„ç¼–ç æ–¹å¼</td>
<td>0x170</td>
</tr>
<tr>
<td>lsda_encoding</td>
<td>LSDAçš„ç¼–ç æ–¹å¼</td>
<td>0x171</td>
</tr>
<tr>
<td>saw_z</td>
<td>æœªçŸ¥</td>
<td>0x172</td>
</tr>
<tr>
<td>signal_frame</td>
<td>ä¿¡å·å¸§æ ‡å¿—ä½</td>
<td>0x173</td>
</tr>
<tr>
<td>eh_ptr</td>
<td>æŒ‡å‘å¼‚å¸¸å¤„ç†æŒ‡é’ˆ</td>
<td>0x178</td>
</tr>
</tbody></table>
<h2 id="å°¾å£°"><a href="#å°¾å£°" class="headerlink" title="å°¾å£°"></a>å°¾å£°</h2><p>è¿™ç¯‡æ–‡ç« çš„ç¼–å†™é›¶é›¶æ•£æ•£æŒç»­äº†å°ä¸€ä¸ªæœˆï¼Œç”¨çš„å¾ˆé›¶ç¢çš„æ—¶é—´å°±å¯¼è‡´äº†å…³è”æ€§æ¯”è¾ƒå·®ï¼Œå„ä½å¦‚æœä»”ç»†é˜…è¯»ä¹Ÿèƒ½å‘ç°æ–‡ç« çš„é€»è¾‘æœ‰ç‚¹æ€ªæ€ªçš„ã€‚C++å¼‚å¸¸å¤„ç†æ˜¯ä¸€ä¸ªæœ‰è¶£çš„è¿‡ç¨‹ï¼Œå®ƒåœ¨è¿è¡Œæ—¶å¯ä»¥è·¨è¶Šå †æ ˆï¼Œæœ€ç»ˆç›´æ¥è·³è½¬è‡³å¼‚å¸¸å¤„ç†çš„ä»£ç ã€‚è¿™ä¸ªåŸç†å¼•èµ·äº†æˆ‘çš„å…´è¶£ï¼Œå› æ­¤æˆ‘èŠ±è´¹äº†ä¸å°‘æ—¶é—´æ¥æ¢ç©¶ã€‚ä½†æ˜¯å¦çœŸçš„æœ‰å®é™…åœºæ™¯èƒ½ç”¨ä¸Šè¿™ç¯‡æ–‡ç« ä½œä¸ºå‚è€ƒï¼Œæˆ‘æ— æ³•ç¡®å®šã€‚å› æ­¤è¿™ç¯‡æ–‡ç« è¯»èµ·æ¥å¯èƒ½æ²¡æœ‰ä»€ä¹ˆå¸®åŠ©ï¼Œç¼–å†™çš„åˆè¡·ä¹Ÿä»…ä»…æ˜¯æˆ‘æ¢ç©¶å®ŒåŸç†çš„è®°å½•è€Œå·²ã€‚è‡³äºæ–‡ç« çš„æ®µè½é€»è¾‘æ¯”è¾ƒæ€ªï¼Œæ˜¯å› ä¸ºç¼–å†™è·¨åº¦æ‹‰çš„å¤ªé•¿ï¼Œç¼–å†™è¿™ç¯‡æ–‡ç« çš„å…´è¶£å·²ç»æ¶ˆé€€äº†ä¸å°‘ï¼Œåé¢å°±ä¸æ‰“ç®—å†å†™äº†ã€‚</p>
<p>å®é™…ä¸Š <code>uw_install_context_1</code> <code>_Unwind_Resume</code> å‡½æ•°åˆ†æã€ <code>FDE</code> <code>CIE</code> è§£æä»¥åŠæ•´ä¸ª <code>throw</code> çš„è°ƒç”¨æµç¨‹å›¾æˆ‘åŸæœ¬éƒ½æ˜¯æ‰“ç®—å†™çš„ï¼Œä¸è¿‡æœ€åè¿˜æ˜¯å†³å®šé¸½äº†ğŸ˜¥ã€‚åé¢æ‰“ç®—çœ‹çœ‹  <code>CHOP(Catch Handler Oriented Programming)</code>ï¼Œä¹Ÿå°±æ˜¯å…³äºC++å¼‚å¸¸å¤„ç†æ¥åˆ©ç”¨æº¢å‡ºæ¼æ´ï¼Œä½†ä¸ä¸€å®šä¼šå†æ›´æ–°åˆ°è¿™ç¯‡åšå®¢ä¸Šäº†ğŸ¤¤ã€‚</p>
<h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/tsecer/p/10487516.html">gccçš„å¼‚å¸¸å¤„ç†æœºåˆ¶ - tsecer - åšå®¢å›­</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11525?time__1311=Cq0xRDcGD=q4lxGgx+ODIx7uYXikwLh3x#toc-0">CPP å¼‚å¸¸å¤„ç†æœºåˆ¶åˆæ¢ - å…ˆçŸ¥ç¤¾åŒº</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/lidan113lidan/article/details/121865210">C++å¼‚å¸¸å¤„ç†æºç ä¸å®‰å…¨æ€§åˆ†æ_å¼‚å¸¸personal routine-CSDNåšå®¢</a></p>
<p><a target="_blank" rel="noopener" href="https://brionas.github.io/2014/05/13/C++-Exception-Handle-2/">c++ å¼‚å¸¸å¤„ç†ï¼ˆä¸‹ï¼‰-ç¿åˆç§‘æŠ€è½¯ä»¶å¼€å‘æŠ€æœ¯åšå®¢</a></p>
<p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-284745.htm#msg_header_h1_0">åˆ†äº«ä¸€æ¬¡ C++ PWN å‡ºé¢˜ç»å†â€”â€”æ·±å…¥ç ”ç©¶å¼‚å¸¸å¤„ç†æœºåˆ¶-Pwn-çœ‹é›ª-å®‰å…¨ç¤¾åŒº</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12967?time__1311=GqGxuD9Qdiq052x+xCwhhmDOQP3qAIox">æº¢å‡ºæ¼æ´åœ¨å¼‚å¸¸å¤„ç†ä¸­çš„æ”»å‡»åˆ©ç”¨æ‰‹æ³•-ä¸Š - å…ˆçŸ¥ç¤¾åŒº</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/C/" rel="tag"># C++</a>
              <a href="/tags/%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95-%E5%88%86%E6%9E%90/" rel="tag"># æºç è°ƒè¯•&&åˆ†æ</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/posts/a0e007e1.html" rel="prev" title="è®°ä¸€æ¬¡AWD-PWNå‡ºé¢˜ç»å†">
                  <i class="fa fa-chevron-left"></i> è®°ä¸€æ¬¡AWD-PWNå‡ºé¢˜ç»å†
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">ZIKH26</span>
  </div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  <script src="/js/third-party/pace.js"></script>


  





</body>
</html>
